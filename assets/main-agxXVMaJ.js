const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/browserAll-BSjmHLfO.js","assets/webworkerAll-BUoPQq7x.js","assets/Filter-YlqdUDKR.js","assets/WebGPURenderer-DF1R20vx.js","assets/BufferResource-Df3QlGmT.js","assets/RenderTargetSystem-D5nkPJVl.js","assets/WebGLRenderer-BdPeXdD0.js","assets/CanvasRenderer-Bw1-_NC3.js"])))=>i.map(i=>d[i]);
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const fd="modulepreload",md=function(o){return"/"+o},zo={},hs=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){let l=function(h){return Promise.all(h.map(c=>Promise.resolve(c).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),n=r?.nonce||r?.getAttribute("nonce");s=l(t.map(h=>{if(h=md(h),h in zo)return;zo[h]=!0;const c=h.endsWith(".css"),d=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${d}`))return;const u=document.createElement("link");if(u.rel=c?"stylesheet":fd,c||(u.as="script"),u.crossOrigin="",u.href=h,n&&u.setAttribute("nonce",n),document.head.appendChild(u),c)return new Promise((f,m)=>{u.addEventListener("load",f),u.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${h}`)))})}))}function a(r){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=r,window.dispatchEvent(n),!n.defaultPrevented)throw r}return s.then(r=>{for(const n of r||[])n.status==="rejected"&&a(n.reason);return e().catch(a)})};var ge=(o=>(o.Application="application",o.WebGLPipes="webgl-pipes",o.WebGLPipesAdaptor="webgl-pipes-adaptor",o.WebGLSystem="webgl-system",o.WebGPUPipes="webgpu-pipes",o.WebGPUPipesAdaptor="webgpu-pipes-adaptor",o.WebGPUSystem="webgpu-system",o.CanvasSystem="canvas-system",o.CanvasPipesAdaptor="canvas-pipes-adaptor",o.CanvasPipes="canvas-pipes",o.Asset="asset",o.LoadParser="load-parser",o.ResolveParser="resolve-parser",o.CacheParser="cache-parser",o.DetectionParser="detection-parser",o.MaskEffect="mask-effect",o.BlendMode="blend-mode",o.TextureSource="texture-source",o.Environment="environment",o.ShapeBuilder="shape-builder",o.Batcher="batcher",o))(ge||{});const Br=o=>{if(typeof o=="function"||typeof o=="object"&&o.extension){if(!o.extension)throw new Error("Extension class must have an extension object");o={...typeof o.extension!="object"?{type:o.extension}:o.extension,ref:o}}if(typeof o=="object")o={...o};else throw new Error("Invalid extension type");return typeof o.type=="string"&&(o.type=[o.type]),o},As=(o,e)=>Br(o).priority??e,Ze={_addHandlers:{},_removeHandlers:{},_queue:{},remove(...o){return o.map(Br).forEach(e=>{e.type.forEach(t=>this._removeHandlers[t]?.(e))}),this},add(...o){return o.map(Br).forEach(e=>{e.type.forEach(t=>{const i=this._addHandlers,s=this._queue;i[t]?i[t]?.(e):(s[t]=s[t]||[],s[t]?.push(e))})}),this},handle(o,e,t){const i=this._addHandlers,s=this._removeHandlers;if(i[o]||s[o])throw new Error(`Extension type ${o} already has a handler`);i[o]=e,s[o]=t;const a=this._queue;return a[o]&&(a[o]?.forEach(r=>e(r)),delete a[o]),this},handleByMap(o,e){return this.handle(o,t=>{t.name&&(e[t.name]=t.ref)},t=>{t.name&&delete e[t.name]})},handleByNamedList(o,e,t=-1){return this.handle(o,i=>{e.findIndex(a=>a.name===i.name)>=0||(e.push({name:i.name,value:i.ref}),e.sort((a,r)=>As(r.value,t)-As(a.value,t)))},i=>{const s=e.findIndex(a=>a.name===i.name);s!==-1&&e.splice(s,1)})},handleByList(o,e,t=-1){return this.handle(o,i=>{e.includes(i.ref)||(e.push(i.ref),e.sort((s,a)=>As(a,t)-As(s,t)))},i=>{const s=e.indexOf(i.ref);s!==-1&&e.splice(s,1)})},mixin(o,...e){for(const t of e)Object.defineProperties(o.prototype,Object.getOwnPropertyDescriptors(t))}},pd={extension:{type:ge.Environment,name:"browser",priority:-1},test:()=>!0,load:async()=>{await hs(()=>import("./browserAll-BSjmHLfO.js"),__vite__mapDeps([0,1,2]))}},_d={extension:{type:ge.Environment,name:"webworker",priority:0},test:()=>typeof self<"u"&&self.WorkerGlobalScope!==void 0,load:async()=>{await hs(()=>import("./webworkerAll-BUoPQq7x.js"),__vite__mapDeps([1,2]))}};class it{constructor(e,t,i){this._x=t||0,this._y=i||0,this._observer=e}clone(e){return new it(e??this._observer,this._x,this._y)}set(e=0,t=e){return(this._x!==e||this._y!==t)&&(this._x=e,this._y=t,this._observer._onUpdate(this)),this}copyFrom(e){return(this._x!==e.x||this._y!==e.y)&&(this._x=e.x,this._y=e.y,this._observer._onUpdate(this)),this}copyTo(e){return e.set(this._x,this._y),e}equals(e){return e.x===this._x&&e.y===this._y}toString(){return`[pixi.js/math:ObservablePoint x=${this._x} y=${this._y} scope=${this._observer}]`}get x(){return this._x}set x(e){this._x!==e&&(this._x=e,this._observer._onUpdate(this))}get y(){return this._y}set y(e){this._y!==e&&(this._y=e,this._observer._onUpdate(this))}}function ch(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var Ha={exports:{}},Xo;function gd(){return Xo||(Xo=1,(function(o){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function s(l,h,c){this.fn=l,this.context=h,this.once=c||!1}function a(l,h,c,d,u){if(typeof c!="function")throw new TypeError("The listener must be a function");var f=new s(c,d||l,u),m=t?t+h:h;return l._events[m]?l._events[m].fn?l._events[m]=[l._events[m],f]:l._events[m].push(f):(l._events[m]=f,l._eventsCount++),l}function r(l,h){--l._eventsCount===0?l._events=new i:delete l._events[h]}function n(){this._events=new i,this._eventsCount=0}n.prototype.eventNames=function(){var h=[],c,d;if(this._eventsCount===0)return h;for(d in c=this._events)e.call(c,d)&&h.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?h.concat(Object.getOwnPropertySymbols(c)):h},n.prototype.listeners=function(h){var c=t?t+h:h,d=this._events[c];if(!d)return[];if(d.fn)return[d.fn];for(var u=0,f=d.length,m=new Array(f);u<f;u++)m[u]=d[u].fn;return m},n.prototype.listenerCount=function(h){var c=t?t+h:h,d=this._events[c];return d?d.fn?1:d.length:0},n.prototype.emit=function(h,c,d,u,f,m){var _=t?t+h:h;if(!this._events[_])return!1;var p=this._events[_],g=arguments.length,y,S;if(p.fn){switch(p.once&&this.removeListener(h,p.fn,void 0,!0),g){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,c),!0;case 3:return p.fn.call(p.context,c,d),!0;case 4:return p.fn.call(p.context,c,d,u),!0;case 5:return p.fn.call(p.context,c,d,u,f),!0;case 6:return p.fn.call(p.context,c,d,u,f,m),!0}for(S=1,y=new Array(g-1);S<g;S++)y[S-1]=arguments[S];p.fn.apply(p.context,y)}else{var b=p.length,w;for(S=0;S<b;S++)switch(p[S].once&&this.removeListener(h,p[S].fn,void 0,!0),g){case 1:p[S].fn.call(p[S].context);break;case 2:p[S].fn.call(p[S].context,c);break;case 3:p[S].fn.call(p[S].context,c,d);break;case 4:p[S].fn.call(p[S].context,c,d,u);break;default:if(!y)for(w=1,y=new Array(g-1);w<g;w++)y[w-1]=arguments[w];p[S].fn.apply(p[S].context,y)}}return!0},n.prototype.on=function(h,c,d){return a(this,h,c,d,!1)},n.prototype.once=function(h,c,d){return a(this,h,c,d,!0)},n.prototype.removeListener=function(h,c,d,u){var f=t?t+h:h;if(!this._events[f])return this;if(!c)return r(this,f),this;var m=this._events[f];if(m.fn)m.fn===c&&(!u||m.once)&&(!d||m.context===d)&&r(this,f);else{for(var _=0,p=[],g=m.length;_<g;_++)(m[_].fn!==c||u&&!m[_].once||d&&m[_].context!==d)&&p.push(m[_]);p.length?this._events[f]=p.length===1?p[0]:p:r(this,f)}return this},n.prototype.removeAllListeners=function(h){var c;return h?(c=t?t+h:h,this._events[c]&&r(this,c)):(this._events=new i,this._eventsCount=0),this},n.prototype.off=n.prototype.removeListener,n.prototype.addListener=n.prototype.on,n.prefixed=t,n.EventEmitter=n,o.exports=n})(Ha)),Ha.exports}var yd=gd();const Xt=ch(yd),bd=Math.PI*2,wd=180/Math.PI,vd=Math.PI/180;class st{constructor(e=0,t=0){this.x=0,this.y=0,this.x=e,this.y=t}clone(){return new st(this.x,this.y)}copyFrom(e){return this.set(e.x,e.y),this}copyTo(e){return e.set(this.x,this.y),e}equals(e){return e.x===this.x&&e.y===this.y}set(e=0,t=e){return this.x=e,this.y=t,this}toString(){return`[pixi.js/math:Point x=${this.x} y=${this.y}]`}static get shared(){return za.x=0,za.y=0,za}}const za=new st;class _e{constructor(e=1,t=0,i=0,s=1,a=0,r=0){this.array=null,this.a=e,this.b=t,this.c=i,this.d=s,this.tx=a,this.ty=r}fromArray(e){this.a=e[0],this.b=e[1],this.c=e[3],this.d=e[4],this.tx=e[2],this.ty=e[5]}set(e,t,i,s,a,r){return this.a=e,this.b=t,this.c=i,this.d=s,this.tx=a,this.ty=r,this}toArray(e,t){this.array||(this.array=new Float32Array(9));const i=t||this.array;return e?(i[0]=this.a,i[1]=this.b,i[2]=0,i[3]=this.c,i[4]=this.d,i[5]=0,i[6]=this.tx,i[7]=this.ty,i[8]=1):(i[0]=this.a,i[1]=this.c,i[2]=this.tx,i[3]=this.b,i[4]=this.d,i[5]=this.ty,i[6]=0,i[7]=0,i[8]=1),i}apply(e,t){t=t||new st;const i=e.x,s=e.y;return t.x=this.a*i+this.c*s+this.tx,t.y=this.b*i+this.d*s+this.ty,t}applyInverse(e,t){t=t||new st;const i=this.a,s=this.b,a=this.c,r=this.d,n=this.tx,l=this.ty,h=1/(i*r+a*-s),c=e.x,d=e.y;return t.x=r*h*c+-a*h*d+(l*a-n*r)*h,t.y=i*h*d+-s*h*c+(-l*i+n*s)*h,t}translate(e,t){return this.tx+=e,this.ty+=t,this}scale(e,t){return this.a*=e,this.d*=t,this.c*=e,this.b*=t,this.tx*=e,this.ty*=t,this}rotate(e){const t=Math.cos(e),i=Math.sin(e),s=this.a,a=this.c,r=this.tx;return this.a=s*t-this.b*i,this.b=s*i+this.b*t,this.c=a*t-this.d*i,this.d=a*i+this.d*t,this.tx=r*t-this.ty*i,this.ty=r*i+this.ty*t,this}append(e){const t=this.a,i=this.b,s=this.c,a=this.d;return this.a=e.a*t+e.b*s,this.b=e.a*i+e.b*a,this.c=e.c*t+e.d*s,this.d=e.c*i+e.d*a,this.tx=e.tx*t+e.ty*s+this.tx,this.ty=e.tx*i+e.ty*a+this.ty,this}appendFrom(e,t){const i=e.a,s=e.b,a=e.c,r=e.d,n=e.tx,l=e.ty,h=t.a,c=t.b,d=t.c,u=t.d;return this.a=i*h+s*d,this.b=i*c+s*u,this.c=a*h+r*d,this.d=a*c+r*u,this.tx=n*h+l*d+t.tx,this.ty=n*c+l*u+t.ty,this}setTransform(e,t,i,s,a,r,n,l,h){return this.a=Math.cos(n+h)*a,this.b=Math.sin(n+h)*a,this.c=-Math.sin(n-l)*r,this.d=Math.cos(n-l)*r,this.tx=e-(i*this.a+s*this.c),this.ty=t-(i*this.b+s*this.d),this}prepend(e){const t=this.tx;if(e.a!==1||e.b!==0||e.c!==0||e.d!==1){const i=this.a,s=this.c;this.a=i*e.a+this.b*e.c,this.b=i*e.b+this.b*e.d,this.c=s*e.a+this.d*e.c,this.d=s*e.b+this.d*e.d}return this.tx=t*e.a+this.ty*e.c+e.tx,this.ty=t*e.b+this.ty*e.d+e.ty,this}decompose(e){const t=this.a,i=this.b,s=this.c,a=this.d,r=e.pivot,n=-Math.atan2(-s,a),l=Math.atan2(i,t),h=Math.abs(n+l);return h<1e-5||Math.abs(bd-h)<1e-5?(e.rotation=l,e.skew.x=e.skew.y=0):(e.rotation=0,e.skew.x=n,e.skew.y=l),e.scale.x=Math.sqrt(t*t+i*i),e.scale.y=Math.sqrt(s*s+a*a),e.position.x=this.tx+(r.x*t+r.y*s),e.position.y=this.ty+(r.x*i+r.y*a),e}invert(){const e=this.a,t=this.b,i=this.c,s=this.d,a=this.tx,r=e*s-t*i;return this.a=s/r,this.b=-t/r,this.c=-i/r,this.d=e/r,this.tx=(i*this.ty-s*a)/r,this.ty=-(e*this.ty-t*a)/r,this}isIdentity(){return this.a===1&&this.b===0&&this.c===0&&this.d===1&&this.tx===0&&this.ty===0}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this}clone(){const e=new _e;return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e}copyTo(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e}copyFrom(e){return this.a=e.a,this.b=e.b,this.c=e.c,this.d=e.d,this.tx=e.tx,this.ty=e.ty,this}equals(e){return e.a===this.a&&e.b===this.b&&e.c===this.c&&e.d===this.d&&e.tx===this.tx&&e.ty===this.ty}toString(){return`[pixi.js:Matrix a=${this.a} b=${this.b} c=${this.c} d=${this.d} tx=${this.tx} ty=${this.ty}]`}static get IDENTITY(){return kd.identity()}static get shared(){return Sd.identity()}}const Sd=new _e,kd=new _e,oi=[1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1,0,1],ni=[0,1,1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1],li=[0,-1,-1,-1,0,1,1,1,0,1,1,1,0,-1,-1,-1],hi=[1,1,0,-1,-1,-1,0,1,-1,-1,0,1,1,1,0,-1],Wr=[],dh=[],Rs=Math.sign;function Td(){for(let o=0;o<16;o++){const e=[];Wr.push(e);for(let t=0;t<16;t++){const i=Rs(oi[o]*oi[t]+li[o]*ni[t]),s=Rs(ni[o]*oi[t]+hi[o]*ni[t]),a=Rs(oi[o]*li[t]+li[o]*hi[t]),r=Rs(ni[o]*li[t]+hi[o]*hi[t]);for(let n=0;n<16;n++)if(oi[n]===i&&ni[n]===s&&li[n]===a&&hi[n]===r){e.push(n);break}}}for(let o=0;o<16;o++){const e=new _e;e.set(oi[o],ni[o],li[o],hi[o],0,0),dh.push(e)}}Td();const Ae={E:0,SE:1,S:2,SW:3,W:4,NW:5,N:6,NE:7,MIRROR_VERTICAL:8,MAIN_DIAGONAL:10,MIRROR_HORIZONTAL:12,REVERSE_DIAGONAL:14,uX:o=>oi[o],uY:o=>ni[o],vX:o=>li[o],vY:o=>hi[o],inv:o=>o&8?o&15:-o&7,add:(o,e)=>Wr[o][e],sub:(o,e)=>Wr[o][Ae.inv(e)],rotate180:o=>o^4,isVertical:o=>(o&3)===2,byDirection:(o,e)=>Math.abs(o)*2<=Math.abs(e)?e>=0?Ae.S:Ae.N:Math.abs(e)*2<=Math.abs(o)?o>0?Ae.E:Ae.W:e>0?o>0?Ae.SE:Ae.SW:o>0?Ae.NE:Ae.NW,matrixAppendRotationInv:(o,e,t=0,i=0,s=0,a=0)=>{const r=dh[Ae.inv(e)],n=r.a,l=r.b,h=r.c,c=r.d,d=t-Math.min(0,n*s,h*a,n*s+h*a),u=i-Math.min(0,l*s,c*a,l*s+c*a),f=o.a,m=o.b,_=o.c,p=o.d;o.a=n*f+l*_,o.b=n*m+l*p,o.c=h*f+c*_,o.d=h*m+c*p,o.tx=d*f+u*_+o.tx,o.ty=d*m+u*p+o.ty},transformRectCoords:(o,e,t,i)=>{const{x:s,y:a,width:r,height:n}=o,{x:l,y:h,width:c,height:d}=e;return t===Ae.E?(i.set(s+l,a+h,r,n),i):t===Ae.S?i.set(c-a-n+l,s+h,n,r):t===Ae.W?i.set(c-s-r+l,d-a-n+h,r,n):t===Ae.N?i.set(a+l,d-s-r+h,n,r):i.set(s+l,a+h,r,n)}},xs=[new st,new st,new st,new st];class $e{constructor(e=0,t=0,i=0,s=0){this.type="rectangle",this.x=Number(e),this.y=Number(t),this.width=Number(i),this.height=Number(s)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}isEmpty(){return this.left===this.right||this.top===this.bottom}static get EMPTY(){return new $e(0,0,0,0)}clone(){return new $e(this.x,this.y,this.width,this.height)}copyFromBounds(e){return this.x=e.minX,this.y=e.minY,this.width=e.maxX-e.minX,this.height=e.maxY-e.minY,this}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}copyTo(e){return e.copyFrom(this),e}contains(e,t){return this.width<=0||this.height<=0?!1:e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height}strokeContains(e,t,i,s=.5){const{width:a,height:r}=this;if(a<=0||r<=0)return!1;const n=this.x,l=this.y,h=i*(1-s),c=i-h,d=n-h,u=n+a+h,f=l-h,m=l+r+h,_=n+c,p=n+a-c,g=l+c,y=l+r-c;return e>=d&&e<=u&&t>=f&&t<=m&&!(e>_&&e<p&&t>g&&t<y)}intersects(e,t){if(!t){const M=this.x<e.x?e.x:this.x;if((this.right>e.right?e.right:this.right)<=M)return!1;const P=this.y<e.y?e.y:this.y;return(this.bottom>e.bottom?e.bottom:this.bottom)>P}const i=this.left,s=this.right,a=this.top,r=this.bottom;if(s<=i||r<=a)return!1;const n=xs[0].set(e.left,e.top),l=xs[1].set(e.left,e.bottom),h=xs[2].set(e.right,e.top),c=xs[3].set(e.right,e.bottom);if(h.x<=n.x||l.y<=n.y)return!1;const d=Math.sign(t.a*t.d-t.b*t.c);if(d===0||(t.apply(n,n),t.apply(l,l),t.apply(h,h),t.apply(c,c),Math.max(n.x,l.x,h.x,c.x)<=i||Math.min(n.x,l.x,h.x,c.x)>=s||Math.max(n.y,l.y,h.y,c.y)<=a||Math.min(n.y,l.y,h.y,c.y)>=r))return!1;const u=d*(l.y-n.y),f=d*(n.x-l.x),m=u*i+f*a,_=u*s+f*a,p=u*i+f*r,g=u*s+f*r;if(Math.max(m,_,p,g)<=u*n.x+f*n.y||Math.min(m,_,p,g)>=u*c.x+f*c.y)return!1;const y=d*(n.y-h.y),S=d*(h.x-n.x),b=y*i+S*a,w=y*s+S*a,k=y*i+S*r,T=y*s+S*r;return!(Math.max(b,w,k,T)<=y*n.x+S*n.y||Math.min(b,w,k,T)>=y*c.x+S*c.y)}pad(e=0,t=e){return this.x-=e,this.y-=t,this.width+=e*2,this.height+=t*2,this}fit(e){const t=Math.max(this.x,e.x),i=Math.min(this.x+this.width,e.x+e.width),s=Math.max(this.y,e.y),a=Math.min(this.y+this.height,e.y+e.height);return this.x=t,this.width=Math.max(i-t,0),this.y=s,this.height=Math.max(a-s,0),this}ceil(e=1,t=.001){const i=Math.ceil((this.x+this.width-t)*e)/e,s=Math.ceil((this.y+this.height-t)*e)/e;return this.x=Math.floor((this.x+t)*e)/e,this.y=Math.floor((this.y+t)*e)/e,this.width=i-this.x,this.height=s-this.y,this}scale(e,t=e){return this.x*=e,this.y*=t,this.width*=e,this.height*=t,this}enlarge(e){const t=Math.min(this.x,e.x),i=Math.max(this.x+this.width,e.x+e.width),s=Math.min(this.y,e.y),a=Math.max(this.y+this.height,e.y+e.height);return this.x=t,this.width=i-t,this.y=s,this.height=a-s,this}getBounds(e){return e||(e=new $e),e.copyFrom(this),e}containsRect(e){if(this.width<=0||this.height<=0)return!1;const t=e.x,i=e.y,s=e.x+e.width,a=e.y+e.height;return t>=this.x&&t<this.x+this.width&&i>=this.y&&i<this.y+this.height&&s>=this.x&&s<this.x+this.width&&a>=this.y&&a<this.y+this.height}set(e,t,i,s){return this.x=e,this.y=t,this.width=i,this.height=s,this}toString(){return`[pixi.js/math:Rectangle x=${this.x} y=${this.y} width=${this.width} height=${this.height}]`}}const Xa={default:-1};function He(o="default"){return Xa[o]===void 0&&(Xa[o]=-1),++Xa[o]}const Vo=new Set,je="8.0.0",Md="8.3.4",Ri={quiet:!1,noColor:!1},Ie=((o,e,t=3)=>{if(Ri.quiet||Vo.has(e))return;let i=new Error().stack;const s=`${e}
Deprecated since v${o}`,a=typeof console.groupCollapsed=="function"&&!Ri.noColor;typeof i>"u"?console.warn("PixiJS Deprecation Warning: ",s):(i=i.split(`
`).splice(t).join(`
`),a?(console.groupCollapsed("%cPixiJS Deprecation Warning: %c%s","color:#614108;background:#fffbe6","font-weight:normal;color:#614108;background:#fffbe6",s),console.warn(i),console.groupEnd()):(console.warn("PixiJS Deprecation Warning: ",s),console.warn(i))),Vo.add(e)});Object.defineProperties(Ie,{quiet:{get:()=>Ri.quiet,set:o=>{Ri.quiet=o},enumerable:!0,configurable:!1},noColor:{get:()=>Ri.noColor,set:o=>{Ri.noColor=o},enumerable:!0,configurable:!1}});const uh=()=>{};function qo(o){return o+=o===0?1:0,--o,o|=o>>>1,o|=o>>>2,o|=o>>>4,o|=o>>>8,o|=o>>>16,o+1}function Yo(o){return!(o&o-1)&&!!o}function fh(o){const e={};for(const t in o)o[t]!==void 0&&(e[t]=o[t]);return e}const Uo=Object.create(null);function Cd(o){const e=Uo[o];return e===void 0&&(Uo[o]=He("resource")),e}const mh=class ph extends Xt{constructor(e={}){super(),this._resourceType="textureSampler",this._touched=0,this._maxAnisotropy=1,this.destroyed=!1,e={...ph.defaultOptions,...e},this.addressMode=e.addressMode,this.addressModeU=e.addressModeU??this.addressModeU,this.addressModeV=e.addressModeV??this.addressModeV,this.addressModeW=e.addressModeW??this.addressModeW,this.scaleMode=e.scaleMode,this.magFilter=e.magFilter??this.magFilter,this.minFilter=e.minFilter??this.minFilter,this.mipmapFilter=e.mipmapFilter??this.mipmapFilter,this.lodMinClamp=e.lodMinClamp,this.lodMaxClamp=e.lodMaxClamp,this.compare=e.compare,this.maxAnisotropy=e.maxAnisotropy??1}set addressMode(e){this.addressModeU=e,this.addressModeV=e,this.addressModeW=e}get addressMode(){return this.addressModeU}set wrapMode(e){Ie(je,"TextureStyle.wrapMode is now TextureStyle.addressMode"),this.addressMode=e}get wrapMode(){return this.addressMode}set scaleMode(e){this.magFilter=e,this.minFilter=e,this.mipmapFilter=e}get scaleMode(){return this.magFilter}set maxAnisotropy(e){this._maxAnisotropy=Math.min(e,16),this._maxAnisotropy>1&&(this.scaleMode="linear")}get maxAnisotropy(){return this._maxAnisotropy}get _resourceId(){return this._sharedResourceId||this._generateResourceId()}update(){this._sharedResourceId=null,this.emit("change",this)}_generateResourceId(){const e=`${this.addressModeU}-${this.addressModeV}-${this.addressModeW}-${this.magFilter}-${this.minFilter}-${this.mipmapFilter}-${this.lodMinClamp}-${this.lodMaxClamp}-${this.compare}-${this._maxAnisotropy}`;return this._sharedResourceId=Cd(e),this._resourceId}destroy(){this.destroyed=!0,this.emit("destroy",this),this.emit("change",this),this.removeAllListeners()}};mh.defaultOptions={addressMode:"clamp-to-edge",scaleMode:"linear"};let _h=mh;const gh=class yh extends Xt{constructor(e={}){super(),this.options=e,this._gpuData=Object.create(null),this._gcLastUsed=-1,this.uid=He("textureSource"),this._resourceType="textureSource",this._resourceId=He("resource"),this.uploadMethodId="unknown",this._resolution=1,this.pixelWidth=1,this.pixelHeight=1,this.width=1,this.height=1,this.sampleCount=1,this.mipLevelCount=1,this.autoGenerateMipmaps=!1,this.format="rgba8unorm",this.dimension="2d",this.viewDimension="2d",this.arrayLayerCount=1,this.antialias=!1,this._touched=0,this._batchTick=-1,this._textureBindLocation=-1,e={...yh.defaultOptions,...e},this.label=e.label??"",this.resource=e.resource,this.autoGarbageCollect=e.autoGarbageCollect,this._resolution=e.resolution,e.width?this.pixelWidth=e.width*this._resolution:this.pixelWidth=this.resource?this.resourceWidth??1:1,e.height?this.pixelHeight=e.height*this._resolution:this.pixelHeight=this.resource?this.resourceHeight??1:1,this.width=this.pixelWidth/this._resolution,this.height=this.pixelHeight/this._resolution,this.format=e.format,this.dimension=e.dimensions,this.viewDimension=e.viewDimension??e.dimensions,this.arrayLayerCount=e.arrayLayerCount,this.mipLevelCount=e.mipLevelCount,this.autoGenerateMipmaps=e.autoGenerateMipmaps,this.sampleCount=e.sampleCount,this.antialias=e.antialias,this.alphaMode=e.alphaMode,this.style=new _h(fh(e)),this.destroyed=!1,this._refreshPOT()}get source(){return this}get style(){return this._style}set style(e){this.style!==e&&(this._style?.off("change",this._onStyleChange,this),this._style=e,this._style?.on("change",this._onStyleChange,this),this._onStyleChange())}set maxAnisotropy(e){this._style.maxAnisotropy=e}get maxAnisotropy(){return this._style.maxAnisotropy}get addressMode(){return this._style.addressMode}set addressMode(e){this._style.addressMode=e}get repeatMode(){return this._style.addressMode}set repeatMode(e){this._style.addressMode=e}get magFilter(){return this._style.magFilter}set magFilter(e){this._style.magFilter=e}get minFilter(){return this._style.minFilter}set minFilter(e){this._style.minFilter=e}get mipmapFilter(){return this._style.mipmapFilter}set mipmapFilter(e){this._style.mipmapFilter=e}get lodMinClamp(){return this._style.lodMinClamp}set lodMinClamp(e){this._style.lodMinClamp=e}get lodMaxClamp(){return this._style.lodMaxClamp}set lodMaxClamp(e){this._style.lodMaxClamp=e}_onStyleChange(){this.emit("styleChange",this)}update(){if(this.resource){const e=this._resolution;if(this.resize(this.resourceWidth/e,this.resourceHeight/e))return}this.emit("update",this)}destroy(){this.destroyed=!0,this.unload(),this.emit("destroy",this),this._style&&(this._style.destroy(),this._style=null),this.uploadMethodId=null,this.resource=null,this.removeAllListeners()}unload(){this._resourceId=He("resource"),this.emit("change",this),this.emit("unload",this);for(const e in this._gpuData)this._gpuData[e]?.destroy?.();this._gpuData=Object.create(null)}get resourceWidth(){const{resource:e}=this;return e.naturalWidth||e.videoWidth||e.displayWidth||e.width}get resourceHeight(){const{resource:e}=this;return e.naturalHeight||e.videoHeight||e.displayHeight||e.height}get resolution(){return this._resolution}set resolution(e){this._resolution!==e&&(this._resolution=e,this.width=this.pixelWidth/e,this.height=this.pixelHeight/e)}resize(e,t,i){i||(i=this._resolution),e||(e=this.width),t||(t=this.height);const s=Math.round(e*i),a=Math.round(t*i);return this.width=s/i,this.height=a/i,this._resolution=i,this.pixelWidth===s&&this.pixelHeight===a?!1:(this._refreshPOT(),this.pixelWidth=s,this.pixelHeight=a,this.emit("resize",this),this._resourceId=He("resource"),this.emit("change",this),!0)}updateMipmaps(){this.autoGenerateMipmaps&&this.mipLevelCount>1&&this.emit("updateMipmaps",this)}set wrapMode(e){this._style.wrapMode=e}get wrapMode(){return this._style.wrapMode}set scaleMode(e){this._style.scaleMode=e}get scaleMode(){return this._style.scaleMode}_refreshPOT(){this.isPowerOfTwo=Yo(this.pixelWidth)&&Yo(this.pixelHeight)}static test(e){throw new Error("Unimplemented")}};gh.defaultOptions={resolution:1,format:"bgra8unorm",alphaMode:"premultiply-alpha-on-upload",dimensions:"2d",viewDimension:"2d",arrayLayerCount:1,mipLevelCount:1,autoGenerateMipmaps:!1,sampleCount:1,antialias:!1,autoGarbageCollect:!1};let Rt=gh;class _o extends Rt{constructor(e){const t=e.resource||new Float32Array(e.width*e.height*4);let i=e.format;i||(t instanceof Float32Array?i="rgba32float":t instanceof Int32Array||t instanceof Uint32Array?i="rgba32uint":t instanceof Int16Array||t instanceof Uint16Array?i="rgba16uint":(t instanceof Int8Array,i="bgra8unorm")),super({...e,resource:t,format:i}),this.uploadMethodId="buffer"}static test(e){return e instanceof Int8Array||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array}}_o.extension=ge.TextureSource;const jo=new _e;class Pd{constructor(e,t){this.mapCoord=new _e,this.uClampFrame=new Float32Array(4),this.uClampOffset=new Float32Array(2),this._textureID=-1,this._updateID=0,this.clampOffset=0,typeof t>"u"?this.clampMargin=e.width<10?0:.5:this.clampMargin=t,this.isSimple=!1,this.texture=e}get texture(){return this._texture}set texture(e){this.texture!==e&&(this._texture?.removeListener("update",this.update,this),this._texture=e,this._texture.addListener("update",this.update,this),this.update())}multiplyUvs(e,t){t===void 0&&(t=e);const i=this.mapCoord;for(let s=0;s<e.length;s+=2){const a=e[s],r=e[s+1];t[s]=a*i.a+r*i.c+i.tx,t[s+1]=a*i.b+r*i.d+i.ty}return t}update(){const e=this._texture;this._updateID++;const t=e.uvs;this.mapCoord.set(t.x1-t.x0,t.y1-t.y0,t.x3-t.x0,t.y3-t.y0,t.x0,t.y0);const i=e.orig,s=e.trim;s&&(jo.set(i.width/s.width,0,0,i.height/s.height,-s.x/s.width,-s.y/s.height),this.mapCoord.append(jo));const a=e.source,r=this.uClampFrame,n=this.clampMargin/a._resolution,l=this.clampOffset/a._resolution;return r[0]=(e.frame.x+n+l)/a.width,r[1]=(e.frame.y+n+l)/a.height,r[2]=(e.frame.x+e.frame.width-n+l)/a.width,r[3]=(e.frame.y+e.frame.height-n+l)/a.height,this.uClampOffset[0]=this.clampOffset/a.pixelWidth,this.uClampOffset[1]=this.clampOffset/a.pixelHeight,this.isSimple=e.frame.width===a.width&&e.frame.height===a.height&&e.rotate===0,!0}}class Z extends Xt{constructor({source:e,label:t,frame:i,orig:s,trim:a,defaultAnchor:r,defaultBorders:n,rotate:l,dynamic:h}={}){if(super(),this.uid=He("texture"),this.uvs={x0:0,y0:0,x1:0,y1:0,x2:0,y2:0,x3:0,y3:0},this.frame=new $e,this.noFrame=!1,this.dynamic=!1,this.isTexture=!0,this.label=t,this.source=e?.source??new Rt,this.noFrame=!i,i)this.frame.copyFrom(i);else{const{width:c,height:d}=this._source;this.frame.width=c,this.frame.height=d}this.orig=s||this.frame,this.trim=a,this.rotate=l??0,this.defaultAnchor=r,this.defaultBorders=n,this.destroyed=!1,this.dynamic=h||!1,this.updateUvs()}set source(e){this._source&&this._source.off("resize",this.update,this),this._source=e,e.on("resize",this.update,this),this.emit("update",this)}get source(){return this._source}get textureMatrix(){return this._textureMatrix||(this._textureMatrix=new Pd(this)),this._textureMatrix}get width(){return this.orig.width}get height(){return this.orig.height}updateUvs(){const{uvs:e,frame:t}=this,{width:i,height:s}=this._source,a=t.x/i,r=t.y/s,n=t.width/i,l=t.height/s;let h=this.rotate;if(h){const c=n/2,d=l/2,u=a+c,f=r+d;h=Ae.add(h,Ae.NW),e.x0=u+c*Ae.uX(h),e.y0=f+d*Ae.uY(h),h=Ae.add(h,2),e.x1=u+c*Ae.uX(h),e.y1=f+d*Ae.uY(h),h=Ae.add(h,2),e.x2=u+c*Ae.uX(h),e.y2=f+d*Ae.uY(h),h=Ae.add(h,2),e.x3=u+c*Ae.uX(h),e.y3=f+d*Ae.uY(h)}else e.x0=a,e.y0=r,e.x1=a+n,e.y1=r,e.x2=a+n,e.y2=r+l,e.x3=a,e.y3=r+l}destroy(e=!1){this._source&&(this._source.off("resize",this.update,this),e&&(this._source.destroy(),this._source=null)),this._textureMatrix=null,this.destroyed=!0,this.emit("destroy",this),this.removeAllListeners()}update(){this.noFrame&&(this.frame.width=this._source.width,this.frame.height=this._source.height),this.updateUvs(),this.emit("update",this)}get baseTexture(){return Ie(je,"Texture.baseTexture is now Texture.source"),this._source}}Z.EMPTY=new Z({label:"EMPTY",source:new Rt({label:"EMPTY"})});Z.EMPTY.destroy=uh;Z.WHITE=new Z({source:new _o({resource:new Uint8Array([255,255,255,255]),width:1,height:1,alphaMode:"premultiply-alpha-on-upload",label:"WHITE"}),label:"WHITE"});Z.WHITE.destroy=uh;function Id(o,e,t){const{width:i,height:s}=t.orig,a=t.trim;if(a){const r=a.width,n=a.height;o.minX=a.x-e._x*i,o.maxX=o.minX+r,o.minY=a.y-e._y*s,o.maxY=o.minY+n}else o.minX=-e._x*i,o.maxX=o.minX+i,o.minY=-e._y*s,o.maxY=o.minY+s}const Ko=new _e;class At{constructor(e=1/0,t=1/0,i=-1/0,s=-1/0){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,this.matrix=Ko,this.minX=e,this.minY=t,this.maxX=i,this.maxY=s}isEmpty(){return this.minX>this.maxX||this.minY>this.maxY}get rectangle(){this._rectangle||(this._rectangle=new $e);const e=this._rectangle;return this.minX>this.maxX||this.minY>this.maxY?(e.x=0,e.y=0,e.width=0,e.height=0):e.copyFromBounds(this),e}clear(){return this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,this.matrix=Ko,this}set(e,t,i,s){this.minX=e,this.minY=t,this.maxX=i,this.maxY=s}addFrame(e,t,i,s,a){a||(a=this.matrix);const r=a.a,n=a.b,l=a.c,h=a.d,c=a.tx,d=a.ty;let u=this.minX,f=this.minY,m=this.maxX,_=this.maxY,p=r*e+l*t+c,g=n*e+h*t+d;p<u&&(u=p),g<f&&(f=g),p>m&&(m=p),g>_&&(_=g),p=r*i+l*t+c,g=n*i+h*t+d,p<u&&(u=p),g<f&&(f=g),p>m&&(m=p),g>_&&(_=g),p=r*e+l*s+c,g=n*e+h*s+d,p<u&&(u=p),g<f&&(f=g),p>m&&(m=p),g>_&&(_=g),p=r*i+l*s+c,g=n*i+h*s+d,p<u&&(u=p),g<f&&(f=g),p>m&&(m=p),g>_&&(_=g),this.minX=u,this.minY=f,this.maxX=m,this.maxY=_}addRect(e,t){this.addFrame(e.x,e.y,e.x+e.width,e.y+e.height,t)}addBounds(e,t){this.addFrame(e.minX,e.minY,e.maxX,e.maxY,t)}addBoundsMask(e){this.minX=this.minX>e.minX?this.minX:e.minX,this.minY=this.minY>e.minY?this.minY:e.minY,this.maxX=this.maxX<e.maxX?this.maxX:e.maxX,this.maxY=this.maxY<e.maxY?this.maxY:e.maxY}applyMatrix(e){const t=this.minX,i=this.minY,s=this.maxX,a=this.maxY,{a:r,b:n,c:l,d:h,tx:c,ty:d}=e;let u=r*t+l*i+c,f=n*t+h*i+d;this.minX=u,this.minY=f,this.maxX=u,this.maxY=f,u=r*s+l*i+c,f=n*s+h*i+d,this.minX=u<this.minX?u:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=u>this.maxX?u:this.maxX,this.maxY=f>this.maxY?f:this.maxY,u=r*t+l*a+c,f=n*t+h*a+d,this.minX=u<this.minX?u:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=u>this.maxX?u:this.maxX,this.maxY=f>this.maxY?f:this.maxY,u=r*s+l*a+c,f=n*s+h*a+d,this.minX=u<this.minX?u:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=u>this.maxX?u:this.maxX,this.maxY=f>this.maxY?f:this.maxY}fit(e){return this.minX<e.left&&(this.minX=e.left),this.maxX>e.right&&(this.maxX=e.right),this.minY<e.top&&(this.minY=e.top),this.maxY>e.bottom&&(this.maxY=e.bottom),this}fitBounds(e,t,i,s){return this.minX<e&&(this.minX=e),this.maxX>t&&(this.maxX=t),this.minY<i&&(this.minY=i),this.maxY>s&&(this.maxY=s),this}pad(e,t=e){return this.minX-=e,this.maxX+=e,this.minY-=t,this.maxY+=t,this}ceil(){return this.minX=Math.floor(this.minX),this.minY=Math.floor(this.minY),this.maxX=Math.ceil(this.maxX),this.maxY=Math.ceil(this.maxY),this}clone(){return new At(this.minX,this.minY,this.maxX,this.maxY)}scale(e,t=e){return this.minX*=e,this.minY*=t,this.maxX*=e,this.maxY*=t,this}get x(){return this.minX}set x(e){const t=this.maxX-this.minX;this.minX=e,this.maxX=e+t}get y(){return this.minY}set y(e){const t=this.maxY-this.minY;this.minY=e,this.maxY=e+t}get width(){return this.maxX-this.minX}set width(e){this.maxX=this.minX+e}get height(){return this.maxY-this.minY}set height(e){this.maxY=this.minY+e}get left(){return this.minX}get right(){return this.maxX}get top(){return this.minY}get bottom(){return this.maxY}get isPositive(){return this.maxX-this.minX>0&&this.maxY-this.minY>0}get isValid(){return this.minX+this.minY!==1/0}addVertexData(e,t,i,s){let a=this.minX,r=this.minY,n=this.maxX,l=this.maxY;s||(s=this.matrix);const h=s.a,c=s.b,d=s.c,u=s.d,f=s.tx,m=s.ty;for(let _=t;_<i;_+=2){const p=e[_],g=e[_+1],y=h*p+d*g+f,S=c*p+u*g+m;a=y<a?y:a,r=S<r?S:r,n=y>n?y:n,l=S>l?S:l}this.minX=a,this.minY=r,this.maxX=n,this.maxY=l}containsPoint(e,t){return this.minX<=e&&this.minY<=t&&this.maxX>=e&&this.maxY>=t}toString(){return`[pixi.js:Bounds minX=${this.minX} minY=${this.minY} maxX=${this.maxX} maxY=${this.maxY} width=${this.width} height=${this.height}]`}copyFrom(e){return this.minX=e.minX,this.minY=e.minY,this.maxX=e.maxX,this.maxY=e.maxY,this}}var Ad={grad:.9,turn:360,rad:360/(2*Math.PI)},$t=function(o){return typeof o=="string"?o.length>0:typeof o=="number"},Ke=function(o,e,t){return e===void 0&&(e=0),t===void 0&&(t=Math.pow(10,e)),Math.round(t*o)/t+0},bt=function(o,e,t){return e===void 0&&(e=0),t===void 0&&(t=1),o>t?t:o>e?o:e},bh=function(o){return(o=isFinite(o)?o%360:0)>0?o:o+360},Qo=function(o){return{r:bt(o.r,0,255),g:bt(o.g,0,255),b:bt(o.b,0,255),a:bt(o.a)}},Va=function(o){return{r:Ke(o.r),g:Ke(o.g),b:Ke(o.b),a:Ke(o.a,3)}},Rd=/^#([0-9a-f]{3,8})$/i,Es=function(o){var e=o.toString(16);return e.length<2?"0"+e:e},wh=function(o){var e=o.r,t=o.g,i=o.b,s=o.a,a=Math.max(e,t,i),r=a-Math.min(e,t,i),n=r?a===e?(t-i)/r:a===t?2+(i-e)/r:4+(e-t)/r:0;return{h:60*(n<0?n+6:n),s:a?r/a*100:0,v:a/255*100,a:s}},vh=function(o){var e=o.h,t=o.s,i=o.v,s=o.a;e=e/360*6,t/=100,i/=100;var a=Math.floor(e),r=i*(1-t),n=i*(1-(e-a)*t),l=i*(1-(1-e+a)*t),h=a%6;return{r:255*[i,n,r,r,l,i][h],g:255*[l,i,i,n,r,r][h],b:255*[r,r,l,i,i,n][h],a:s}},Zo=function(o){return{h:bh(o.h),s:bt(o.s,0,100),l:bt(o.l,0,100),a:bt(o.a)}},Jo=function(o){return{h:Ke(o.h),s:Ke(o.s),l:Ke(o.l),a:Ke(o.a,3)}},en=function(o){return vh((t=(e=o).s,{h:e.h,s:(t*=((i=e.l)<50?i:100-i)/100)>0?2*t/(i+t)*100:0,v:i+t,a:e.a}));var e,t,i},cs=function(o){return{h:(e=wh(o)).h,s:(s=(200-(t=e.s))*(i=e.v)/100)>0&&s<200?t*i/100/(s<=100?s:200-s)*100:0,l:s/2,a:e.a};var e,t,i,s},xd=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Ed=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Dd=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Fd=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Nr={string:[[function(o){var e=Rd.exec(o);return e?(o=e[1]).length<=4?{r:parseInt(o[0]+o[0],16),g:parseInt(o[1]+o[1],16),b:parseInt(o[2]+o[2],16),a:o.length===4?Ke(parseInt(o[3]+o[3],16)/255,2):1}:o.length===6||o.length===8?{r:parseInt(o.substr(0,2),16),g:parseInt(o.substr(2,2),16),b:parseInt(o.substr(4,2),16),a:o.length===8?Ke(parseInt(o.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(o){var e=Dd.exec(o)||Fd.exec(o);return e?e[2]!==e[4]||e[4]!==e[6]?null:Qo({r:Number(e[1])/(e[2]?100/255:1),g:Number(e[3])/(e[4]?100/255:1),b:Number(e[5])/(e[6]?100/255:1),a:e[7]===void 0?1:Number(e[7])/(e[8]?100:1)}):null},"rgb"],[function(o){var e=xd.exec(o)||Ed.exec(o);if(!e)return null;var t,i,s=Zo({h:(t=e[1],i=e[2],i===void 0&&(i="deg"),Number(t)*(Ad[i]||1)),s:Number(e[3]),l:Number(e[4]),a:e[5]===void 0?1:Number(e[5])/(e[6]?100:1)});return en(s)},"hsl"]],object:[[function(o){var e=o.r,t=o.g,i=o.b,s=o.a,a=s===void 0?1:s;return $t(e)&&$t(t)&&$t(i)?Qo({r:Number(e),g:Number(t),b:Number(i),a:Number(a)}):null},"rgb"],[function(o){var e=o.h,t=o.s,i=o.l,s=o.a,a=s===void 0?1:s;if(!$t(e)||!$t(t)||!$t(i))return null;var r=Zo({h:Number(e),s:Number(t),l:Number(i),a:Number(a)});return en(r)},"hsl"],[function(o){var e=o.h,t=o.s,i=o.v,s=o.a,a=s===void 0?1:s;if(!$t(e)||!$t(t)||!$t(i))return null;var r=(function(n){return{h:bh(n.h),s:bt(n.s,0,100),v:bt(n.v,0,100),a:bt(n.a)}})({h:Number(e),s:Number(t),v:Number(i),a:Number(a)});return vh(r)},"hsv"]]},tn=function(o,e){for(var t=0;t<e.length;t++){var i=e[t][0](o);if(i)return[i,e[t][1]]}return[null,void 0]},$d=function(o){return typeof o=="string"?tn(o.trim(),Nr.string):typeof o=="object"&&o!==null?tn(o,Nr.object):[null,void 0]},qa=function(o,e){var t=cs(o);return{h:t.h,s:bt(t.s+100*e,0,100),l:t.l,a:t.a}},Ya=function(o){return(299*o.r+587*o.g+114*o.b)/1e3/255},sn=function(o,e){var t=cs(o);return{h:t.h,s:t.s,l:bt(t.l+100*e,0,100),a:t.a}},Or=(function(){function o(e){this.parsed=$d(e)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return o.prototype.isValid=function(){return this.parsed!==null},o.prototype.brightness=function(){return Ke(Ya(this.rgba),2)},o.prototype.isDark=function(){return Ya(this.rgba)<.5},o.prototype.isLight=function(){return Ya(this.rgba)>=.5},o.prototype.toHex=function(){return e=Va(this.rgba),t=e.r,i=e.g,s=e.b,r=(a=e.a)<1?Es(Ke(255*a)):"","#"+Es(t)+Es(i)+Es(s)+r;var e,t,i,s,a,r},o.prototype.toRgb=function(){return Va(this.rgba)},o.prototype.toRgbString=function(){return e=Va(this.rgba),t=e.r,i=e.g,s=e.b,(a=e.a)<1?"rgba("+t+", "+i+", "+s+", "+a+")":"rgb("+t+", "+i+", "+s+")";var e,t,i,s,a},o.prototype.toHsl=function(){return Jo(cs(this.rgba))},o.prototype.toHslString=function(){return e=Jo(cs(this.rgba)),t=e.h,i=e.s,s=e.l,(a=e.a)<1?"hsla("+t+", "+i+"%, "+s+"%, "+a+")":"hsl("+t+", "+i+"%, "+s+"%)";var e,t,i,s,a},o.prototype.toHsv=function(){return e=wh(this.rgba),{h:Ke(e.h),s:Ke(e.s),v:Ke(e.v),a:Ke(e.a,3)};var e},o.prototype.invert=function(){return Dt({r:255-(e=this.rgba).r,g:255-e.g,b:255-e.b,a:e.a});var e},o.prototype.saturate=function(e){return e===void 0&&(e=.1),Dt(qa(this.rgba,e))},o.prototype.desaturate=function(e){return e===void 0&&(e=.1),Dt(qa(this.rgba,-e))},o.prototype.grayscale=function(){return Dt(qa(this.rgba,-1))},o.prototype.lighten=function(e){return e===void 0&&(e=.1),Dt(sn(this.rgba,e))},o.prototype.darken=function(e){return e===void 0&&(e=.1),Dt(sn(this.rgba,-e))},o.prototype.rotate=function(e){return e===void 0&&(e=15),this.hue(this.hue()+e)},o.prototype.alpha=function(e){return typeof e=="number"?Dt({r:(t=this.rgba).r,g:t.g,b:t.b,a:e}):Ke(this.rgba.a,3);var t},o.prototype.hue=function(e){var t=cs(this.rgba);return typeof e=="number"?Dt({h:e,s:t.s,l:t.l,a:t.a}):Ke(t.h)},o.prototype.isEqual=function(e){return this.toHex()===Dt(e).toHex()},o})(),Dt=function(o){return o instanceof Or?o:new Or(o)},an=[],Ld=function(o){o.forEach(function(e){an.indexOf(e)<0&&(e(Or,Nr),an.push(e))})};function Bd(o,e){var t={white:"#ffffff",bisque:"#ffe4c4",blue:"#0000ff",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",antiquewhite:"#faebd7",aqua:"#00ffff",azure:"#f0ffff",whitesmoke:"#f5f5f5",papayawhip:"#ffefd5",plum:"#dda0dd",blanchedalmond:"#ffebcd",black:"#000000",gold:"#ffd700",goldenrod:"#daa520",gainsboro:"#dcdcdc",cornsilk:"#fff8dc",cornflowerblue:"#6495ed",burlywood:"#deb887",aquamarine:"#7fffd4",beige:"#f5f5dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkkhaki:"#bdb76b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",peachpuff:"#ffdab9",darkmagenta:"#8b008b",darkred:"#8b0000",darkorchid:"#9932cc",darkorange:"#ff8c00",darkslateblue:"#483d8b",gray:"#808080",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",deeppink:"#ff1493",deepskyblue:"#00bfff",wheat:"#f5deb3",firebrick:"#b22222",floralwhite:"#fffaf0",ghostwhite:"#f8f8ff",darkviolet:"#9400d3",magenta:"#ff00ff",green:"#008000",dodgerblue:"#1e90ff",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",blueviolet:"#8a2be2",forestgreen:"#228b22",lawngreen:"#7cfc00",indianred:"#cd5c5c",indigo:"#4b0082",fuchsia:"#ff00ff",brown:"#a52a2a",maroon:"#800000",mediumblue:"#0000cd",lightcoral:"#f08080",darkturquoise:"#00ced1",lightcyan:"#e0ffff",ivory:"#fffff0",lightyellow:"#ffffe0",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",linen:"#faf0e6",mediumaquamarine:"#66cdaa",lemonchiffon:"#fffacd",lime:"#00ff00",khaki:"#f0e68c",mediumseagreen:"#3cb371",limegreen:"#32cd32",mediumspringgreen:"#00fa9a",lightskyblue:"#87cefa",lightblue:"#add8e6",midnightblue:"#191970",lightpink:"#ffb6c1",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",mintcream:"#f5fffa",lightslategray:"#778899",lightslategrey:"#778899",navajowhite:"#ffdead",navy:"#000080",mediumvioletred:"#c71585",powderblue:"#b0e0e6",palegoldenrod:"#eee8aa",oldlace:"#fdf5e6",paleturquoise:"#afeeee",mediumturquoise:"#48d1cc",mediumorchid:"#ba55d3",rebeccapurple:"#663399",lightsteelblue:"#b0c4de",mediumslateblue:"#7b68ee",thistle:"#d8bfd8",tan:"#d2b48c",orchid:"#da70d6",mediumpurple:"#9370db",purple:"#800080",pink:"#ffc0cb",skyblue:"#87ceeb",springgreen:"#00ff7f",palegreen:"#98fb98",red:"#ff0000",yellow:"#ffff00",slateblue:"#6a5acd",lavenderblush:"#fff0f5",peru:"#cd853f",palevioletred:"#db7093",violet:"#ee82ee",teal:"#008080",slategray:"#708090",slategrey:"#708090",aliceblue:"#f0f8ff",darkseagreen:"#8fbc8f",darkolivegreen:"#556b2f",greenyellow:"#adff2f",seagreen:"#2e8b57",seashell:"#fff5ee",tomato:"#ff6347",silver:"#c0c0c0",sienna:"#a0522d",lavender:"#e6e6fa",lightgreen:"#90ee90",orange:"#ffa500",orangered:"#ff4500",steelblue:"#4682b4",royalblue:"#4169e1",turquoise:"#40e0d0",yellowgreen:"#9acd32",salmon:"#fa8072",saddlebrown:"#8b4513",sandybrown:"#f4a460",rosybrown:"#bc8f8f",darksalmon:"#e9967a",lightgoldenrodyellow:"#fafad2",snow:"#fffafa",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",dimgray:"#696969",dimgrey:"#696969",olivedrab:"#6b8e23",olive:"#808000"},i={};for(var s in t)i[t[s]]=s;var a={};o.prototype.toName=function(r){if(!(this.rgba.a||this.rgba.r||this.rgba.g||this.rgba.b))return"transparent";var n,l,h=i[this.toHex()];if(h)return h;if(r?.closest){var c=this.toRgb(),d=1/0,u="black";if(!a.length)for(var f in t)a[f]=new o(t[f]).toRgb();for(var m in t){var _=(n=c,l=a[m],Math.pow(n.r-l.r,2)+Math.pow(n.g-l.g,2)+Math.pow(n.b-l.b,2));_<d&&(d=_,u=m)}return u}},e.string.push([function(r){var n=r.toLowerCase(),l=n==="transparent"?"#0000":t[n];return l?new o(l).toRgb():null},"name"])}Ld([Bd]);const Li=class ts{constructor(e=16777215){this._value=null,this._components=new Float32Array(4),this._components.fill(1),this._int=16777215,this.value=e}get red(){return this._components[0]}get green(){return this._components[1]}get blue(){return this._components[2]}get alpha(){return this._components[3]}setValue(e){return this.value=e,this}set value(e){if(e instanceof ts)this._value=this._cloneSource(e._value),this._int=e._int,this._components.set(e._components);else{if(e===null)throw new Error("Cannot set Color#value to null");(this._value===null||!this._isSourceEqual(this._value,e))&&(this._value=this._cloneSource(e),this._normalize(this._value))}}get value(){return this._value}_cloneSource(e){return typeof e=="string"||typeof e=="number"||e instanceof Number||e===null?e:Array.isArray(e)||ArrayBuffer.isView(e)?e.slice(0):typeof e=="object"&&e!==null?{...e}:e}_isSourceEqual(e,t){const i=typeof e;if(i!==typeof t)return!1;if(i==="number"||i==="string"||e instanceof Number)return e===t;if(Array.isArray(e)&&Array.isArray(t)||ArrayBuffer.isView(e)&&ArrayBuffer.isView(t))return e.length!==t.length?!1:e.every((a,r)=>a===t[r]);if(e!==null&&t!==null){const a=Object.keys(e),r=Object.keys(t);return a.length!==r.length?!1:a.every(n=>e[n]===t[n])}return e===t}toRgba(){const[e,t,i,s]=this._components;return{r:e,g:t,b:i,a:s}}toRgb(){const[e,t,i]=this._components;return{r:e,g:t,b:i}}toRgbaString(){const[e,t,i]=this.toUint8RgbArray();return`rgba(${e},${t},${i},${this.alpha})`}toUint8RgbArray(e){const[t,i,s]=this._components;return this._arrayRgb||(this._arrayRgb=[]),e||(e=this._arrayRgb),e[0]=Math.round(t*255),e[1]=Math.round(i*255),e[2]=Math.round(s*255),e}toArray(e){this._arrayRgba||(this._arrayRgba=[]),e||(e=this._arrayRgba);const[t,i,s,a]=this._components;return e[0]=t,e[1]=i,e[2]=s,e[3]=a,e}toRgbArray(e){this._arrayRgb||(this._arrayRgb=[]),e||(e=this._arrayRgb);const[t,i,s]=this._components;return e[0]=t,e[1]=i,e[2]=s,e}toNumber(){return this._int}toBgrNumber(){const[e,t,i]=this.toUint8RgbArray();return(i<<16)+(t<<8)+e}toLittleEndianNumber(){const e=this._int;return(e>>16)+(e&65280)+((e&255)<<16)}multiply(e){const[t,i,s,a]=ts._temp.setValue(e)._components;return this._components[0]*=t,this._components[1]*=i,this._components[2]*=s,this._components[3]*=a,this._refreshInt(),this._value=null,this}premultiply(e,t=!0){return t&&(this._components[0]*=e,this._components[1]*=e,this._components[2]*=e),this._components[3]=e,this._refreshInt(),this._value=null,this}toPremultiplied(e,t=!0){if(e===1)return(255<<24)+this._int;if(e===0)return t?0:this._int;let i=this._int>>16&255,s=this._int>>8&255,a=this._int&255;return t&&(i=i*e+.5|0,s=s*e+.5|0,a=a*e+.5|0),(e*255<<24)+(i<<16)+(s<<8)+a}toHex(){const e=this._int.toString(16);return`#${"000000".substring(0,6-e.length)+e}`}toHexa(){const t=Math.round(this._components[3]*255).toString(16);return this.toHex()+"00".substring(0,2-t.length)+t}setAlpha(e){return this._components[3]=this._clamp(e),this}_normalize(e){let t,i,s,a;if((typeof e=="number"||e instanceof Number)&&e>=0&&e<=16777215){const r=e;t=(r>>16&255)/255,i=(r>>8&255)/255,s=(r&255)/255,a=1}else if((Array.isArray(e)||e instanceof Float32Array)&&e.length>=3&&e.length<=4)e=this._clamp(e),[t,i,s,a=1]=e;else if((e instanceof Uint8Array||e instanceof Uint8ClampedArray)&&e.length>=3&&e.length<=4)e=this._clamp(e,0,255),[t,i,s,a=255]=e,t/=255,i/=255,s/=255,a/=255;else if(typeof e=="string"||typeof e=="object"){if(typeof e=="string"){const n=ts.HEX_PATTERN.exec(e);n&&(e=`#${n[2]}`)}const r=Dt(e);r.isValid()&&({r:t,g:i,b:s,a}=r.rgba,t/=255,i/=255,s/=255)}if(t!==void 0)this._components[0]=t,this._components[1]=i,this._components[2]=s,this._components[3]=a,this._refreshInt();else throw new Error(`Unable to convert color ${e}`)}_refreshInt(){this._clamp(this._components);const[e,t,i]=this._components;this._int=(e*255<<16)+(t*255<<8)+(i*255|0)}_clamp(e,t=0,i=1){return typeof e=="number"?Math.min(Math.max(e,t),i):(e.forEach((s,a)=>{e[a]=Math.min(Math.max(s,t),i)}),e)}static isColorLike(e){return typeof e=="number"||typeof e=="string"||e instanceof Number||e instanceof ts||Array.isArray(e)||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Float32Array||e.r!==void 0&&e.g!==void 0&&e.b!==void 0||e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0||e.h!==void 0&&e.s!==void 0&&e.l!==void 0||e.h!==void 0&&e.s!==void 0&&e.l!==void 0&&e.a!==void 0||e.h!==void 0&&e.s!==void 0&&e.v!==void 0||e.h!==void 0&&e.s!==void 0&&e.v!==void 0&&e.a!==void 0}};Li.shared=new Li;Li._temp=new Li;Li.HEX_PATTERN=/^(#|0x)?(([a-f0-9]{3}){1,2}([a-f0-9]{2})?)$/i;let wt=Li;const Wd={cullArea:null,cullable:!1,cullableChildren:!0};let Ua=0;const rn=500;function pt(...o){Ua!==rn&&(Ua++,Ua===rn?console.warn("PixiJS Warning: too many warnings, no more warnings will be reported to the console by PixiJS."):console.warn("PixiJS Warning: ",...o))}const Da={_registeredResources:new Set,register(o){this._registeredResources.add(o)},unregister(o){this._registeredResources.delete(o)},release(){this._registeredResources.forEach(o=>o.clear())},get registeredCount(){return this._registeredResources.size},isRegistered(o){return this._registeredResources.has(o)},reset(){this._registeredResources.clear()}};class Nd{constructor(e,t){this._pool=[],this._count=0,this._index=0,this._classType=e,t&&this.prepopulate(t)}prepopulate(e){for(let t=0;t<e;t++)this._pool[this._index++]=new this._classType;this._count+=e}get(e){let t;return this._index>0?t=this._pool[--this._index]:(t=new this._classType,this._count++),t.init?.(e),t}return(e){e.reset?.(),this._pool[this._index++]=e}get totalSize(){return this._count}get totalFree(){return this._index}get totalUsed(){return this._count-this._index}clear(){if(this._pool.length>0&&this._pool[0].destroy)for(let e=0;e<this._index;e++)this._pool[e].destroy();this._pool.length=0,this._count=0,this._index=0}}class Od{constructor(){this._poolsByClass=new Map}prepopulate(e,t){this.getPool(e).prepopulate(t)}get(e,t){return this.getPool(e).get(t)}return(e){this.getPool(e.constructor).return(e)}getPool(e){return this._poolsByClass.has(e)||this._poolsByClass.set(e,new Nd(e)),this._poolsByClass.get(e)}stats(){const e={};return this._poolsByClass.forEach(t=>{const i=e[t._classType.name]?t._classType.name+t._classType.ID:t._classType.name;e[i]={free:t.totalFree,used:t.totalUsed,size:t.totalSize}}),e}clear(){this._poolsByClass.forEach(e=>e.clear()),this._poolsByClass.clear()}}const ct=new Od;Da.register(ct);const Gd={get isCachedAsTexture(){return!!this.renderGroup?.isCachedAsTexture},cacheAsTexture(o){typeof o=="boolean"&&o===!1?this.disableRenderGroup():(this.enableRenderGroup(),this.renderGroup.enableCacheAsTexture(o===!0?{}:o))},updateCacheTexture(){this.renderGroup?.updateCacheTexture()},get cacheAsBitmap(){return this.isCachedAsTexture},set cacheAsBitmap(o){Ie("v8.6.0","cacheAsBitmap is deprecated, use cacheAsTexture instead."),this.cacheAsTexture(o)}};function Hd(o,e,t){const i=o.length;let s;if(e>=i||t===0)return;t=e+t>i?i-e:t;const a=i-t;for(s=e;s<a;++s)o[s]=o[s+t];o.length=a}const zd={allowChildren:!0,removeChildren(o=0,e){const t=e??this.children.length,i=t-o,s=[];if(i>0&&i<=t){for(let r=t-1;r>=o;r--){const n=this.children[r];n&&(s.push(n),n.parent=null)}Hd(this.children,o,t);const a=this.renderGroup||this.parentRenderGroup;a&&a.removeChildren(s);for(let r=0;r<s.length;++r){const n=s[r];n.parentRenderLayer?.detach(n),this.emit("childRemoved",n,this,r),s[r].emit("removed",this)}return s.length>0&&this._didViewChangeTick++,s}else if(i===0&&this.children.length===0)return s;throw new RangeError("removeChildren: numeric values are outside the acceptable range.")},removeChildAt(o){const e=this.getChildAt(o);return this.removeChild(e)},getChildAt(o){if(o<0||o>=this.children.length)throw new Error(`getChildAt: Index (${o}) does not exist.`);return this.children[o]},setChildIndex(o,e){if(e<0||e>=this.children.length)throw new Error(`The index ${e} supplied is out of bounds ${this.children.length}`);this.getChildIndex(o),this.addChildAt(o,e)},getChildIndex(o){const e=this.children.indexOf(o);if(e===-1)throw new Error("The supplied Container must be a child of the caller");return e},addChildAt(o,e){this.allowChildren||Ie(je,"addChildAt: Only Containers will be allowed to add children in v8.0.0");const{children:t}=this;if(e<0||e>t.length)throw new Error(`${o}addChildAt: The index ${e} supplied is out of bounds ${t.length}`);if(o.parent){const s=o.parent.children.indexOf(o);if(o.parent===this&&s===e)return o;s!==-1&&o.parent.children.splice(s,1)}e===t.length?t.push(o):t.splice(e,0,o),o.parent=this,o.didChange=!0,o._updateFlags=15;const i=this.renderGroup||this.parentRenderGroup;return i&&i.addChild(o),this.sortableChildren&&(this.sortDirty=!0),this.emit("childAdded",o,this,e),o.emit("added",this),o},swapChildren(o,e){if(o===e)return;const t=this.getChildIndex(o),i=this.getChildIndex(e);this.children[t]=e,this.children[i]=o;const s=this.renderGroup||this.parentRenderGroup;s&&(s.structureDidChange=!0),this._didContainerChangeTick++},removeFromParent(){this.parent?.removeChild(this)},reparentChild(...o){return o.length===1?this.reparentChildAt(o[0],this.children.length):(o.forEach(e=>this.reparentChildAt(e,this.children.length)),o[0])},reparentChildAt(o,e){if(o.parent===this)return this.setChildIndex(o,e),o;const t=o.worldTransform.clone();o.removeFromParent(),this.addChildAt(o,e);const i=this.worldTransform.clone();return i.invert(),t.prepend(i),o.setFromMatrix(t),o},replaceChild(o,e){o.updateLocalTransform(),this.addChildAt(e,this.getChildIndex(o)),e.setFromMatrix(o.localTransform),e.updateLocalTransform(),this.removeChild(o)}},Xd={collectRenderables(o,e,t){this.parentRenderLayer&&this.parentRenderLayer!==t||this.globalDisplayStatus<7||!this.includeInBuild||(this.sortableChildren&&this.sortChildren(),this.isSimple?this.collectRenderablesSimple(o,e,t):this.renderGroup?e.renderPipes.renderGroup.addRenderGroup(this.renderGroup,o):this.collectRenderablesWithEffects(o,e,t))},collectRenderablesSimple(o,e,t){const i=this.children,s=i.length;for(let a=0;a<s;a++)i[a].collectRenderables(o,e,t)},collectRenderablesWithEffects(o,e,t){const{renderPipes:i}=e;for(let s=0;s<this.effects.length;s++){const a=this.effects[s];i[a.pipe].push(a,this,o)}this.collectRenderablesSimple(o,e,t);for(let s=this.effects.length-1;s>=0;s--){const a=this.effects[s];i[a.pipe].pop(a,this,o)}}};class on{constructor(){this.pipe="filter",this.priority=1}destroy(){for(let e=0;e<this.filters.length;e++)this.filters[e].destroy();this.filters=null,this.filterArea=null}}class Vd{constructor(){this._effectClasses=[],this._tests=[],this._initialized=!1}init(){this._initialized||(this._initialized=!0,this._effectClasses.forEach(e=>{this.add({test:e.test,maskClass:e})}))}add(e){this._tests.push(e)}getMaskEffect(e){this._initialized||this.init();for(let t=0;t<this._tests.length;t++){const i=this._tests[t];if(i.test(e))return ct.get(i.maskClass,e)}return e}returnMaskEffect(e){ct.return(e)}}const Gr=new Vd;Ze.handleByList(ge.MaskEffect,Gr._effectClasses);const qd={_maskEffect:null,_maskOptions:{inverse:!1},_filterEffect:null,effects:[],_markStructureAsChanged(){const o=this.renderGroup||this.parentRenderGroup;o&&(o.structureDidChange=!0)},addEffect(o){this.effects.indexOf(o)===-1&&(this.effects.push(o),this.effects.sort((t,i)=>t.priority-i.priority),this._markStructureAsChanged(),this._updateIsSimple())},removeEffect(o){const e=this.effects.indexOf(o);e!==-1&&(this.effects.splice(e,1),this._markStructureAsChanged(),this._updateIsSimple())},set mask(o){const e=this._maskEffect;e?.mask!==o&&(e&&(this.removeEffect(e),Gr.returnMaskEffect(e),this._maskEffect=null),o!=null&&(this._maskEffect=Gr.getMaskEffect(o),this.addEffect(this._maskEffect)))},get mask(){return this._maskEffect?.mask},setMask(o){this._maskOptions={...this._maskOptions,...o},o.mask&&(this.mask=o.mask),this._markStructureAsChanged()},set filters(o){!Array.isArray(o)&&o&&(o=[o]);const e=this._filterEffect||(this._filterEffect=new on);o=o;const t=o?.length>0,i=e.filters?.length>0,s=t!==i;o=Array.isArray(o)?o.slice(0):o,e.filters=Object.freeze(o),s&&(t?this.addEffect(e):(this.removeEffect(e),e.filters=o??null))},get filters(){return this._filterEffect?.filters},set filterArea(o){this._filterEffect||(this._filterEffect=new on),this._filterEffect.filterArea=o},get filterArea(){return this._filterEffect?.filterArea}},Yd={label:null,get name(){return Ie(je,"Container.name property has been removed, use Container.label instead"),this.label},set name(o){Ie(je,"Container.name property has been removed, use Container.label instead"),this.label=o},getChildByName(o,e=!1){return this.getChildByLabel(o,e)},getChildByLabel(o,e=!1){const t=this.children;for(let i=0;i<t.length;i++){const s=t[i];if(s.label===o||o instanceof RegExp&&o.test(s.label))return s}if(e)for(let i=0;i<t.length;i++){const a=t[i].getChildByLabel(o,!0);if(a)return a}return null},getChildrenByLabel(o,e=!1,t=[]){const i=this.children;for(let s=0;s<i.length;s++){const a=i[s];(a.label===o||o instanceof RegExp&&o.test(a.label))&&t.push(a)}if(e)for(let s=0;s<i.length;s++)i[s].getChildrenByLabel(o,!0,t);return t}},ot=ct.getPool(_e),Gt=ct.getPool(At),Ud=new _e,jd={getFastGlobalBounds(o,e){e||(e=new At),e.clear(),this._getGlobalBoundsRecursive(!!o,e,this.parentRenderLayer),e.isValid||e.set(0,0,0,0);const t=this.renderGroup||this.parentRenderGroup;return e.applyMatrix(t.worldTransform),e},_getGlobalBoundsRecursive(o,e,t){let i=e;if(o&&this.parentRenderLayer&&this.parentRenderLayer!==t||this.localDisplayStatus!==7||!this.measurable)return;const s=!!this.effects.length;if((this.renderGroup||s)&&(i=Gt.get().clear()),this.boundsArea)e.addRect(this.boundsArea,this.worldTransform);else{if(this.renderPipeId){const r=this.bounds;i.addFrame(r.minX,r.minY,r.maxX,r.maxY,this.groupTransform)}const a=this.children;for(let r=0;r<a.length;r++)a[r]._getGlobalBoundsRecursive(o,i,t)}if(s){let a=!1;const r=this.renderGroup||this.parentRenderGroup;for(let n=0;n<this.effects.length;n++)this.effects[n].addBounds&&(a||(a=!0,i.applyMatrix(r.worldTransform)),this.effects[n].addBounds(i,!0));a&&i.applyMatrix(r.worldTransform.copyTo(Ud).invert()),e.addBounds(i),Gt.return(i)}else this.renderGroup&&(e.addBounds(i,this.relativeGroupTransform),Gt.return(i))}};function Sh(o,e,t){t.clear();let i,s;return o.parent?e?i=o.parent.worldTransform:(s=ot.get().identity(),i=go(o,s)):i=_e.IDENTITY,kh(o,t,i,e),s&&ot.return(s),t.isValid||t.set(0,0,0,0),t}function kh(o,e,t,i){if(!o.visible||!o.measurable)return;let s;i?s=o.worldTransform:(o.updateLocalTransform(),s=ot.get(),s.appendFrom(o.localTransform,t));const a=e,r=!!o.effects.length;if(r&&(e=Gt.get().clear()),o.boundsArea)e.addRect(o.boundsArea,s);else{const n=o.bounds;n&&!n.isEmpty()&&(e.matrix=s,e.addBounds(n));for(let l=0;l<o.children.length;l++)kh(o.children[l],e,s,i)}if(r){for(let n=0;n<o.effects.length;n++)o.effects[n].addBounds?.(e);a.addBounds(e,_e.IDENTITY),Gt.return(e)}i||ot.return(s)}function go(o,e){const t=o.parent;return t&&(go(t,e),t.updateLocalTransform(),e.append(t.localTransform)),e}function Th(o,e){if(o===16777215||!e)return e;if(e===16777215||!o)return o;const t=o>>16&255,i=o>>8&255,s=o&255,a=e>>16&255,r=e>>8&255,n=e&255,l=t*a/255|0,h=i*r/255|0,c=s*n/255|0;return(l<<16)+(h<<8)+c}const nn=16777215;function ln(o,e){return o===nn?e:e===nn?o:Th(o,e)}function ma(o){return((o&255)<<16)+(o&65280)+(o>>16&255)}const Kd={getGlobalAlpha(o){if(o)return this.renderGroup?this.renderGroup.worldAlpha:this.parentRenderGroup?this.parentRenderGroup.worldAlpha*this.alpha:this.alpha;let e=this.alpha,t=this.parent;for(;t;)e*=t.alpha,t=t.parent;return e},getGlobalTransform(o=new _e,e){if(e)return o.copyFrom(this.worldTransform);this.updateLocalTransform();const t=go(this,ot.get().identity());return o.appendFrom(this.localTransform,t),ot.return(t),o},getGlobalTint(o){if(o)return this.renderGroup?ma(this.renderGroup.worldColor):this.parentRenderGroup?ma(ln(this.localColor,this.parentRenderGroup.worldColor)):this.tint;let e=this.localColor,t=this.parent;for(;t;)e=ln(e,t.localColor),t=t.parent;return ma(e)}};function Mh(o,e,t){return e.clear(),t||(t=_e.IDENTITY),Ch(o,e,t,o,!0),e.isValid||e.set(0,0,0,0),e}function Ch(o,e,t,i,s){let a;if(s)a=ot.get(),a=t.copyTo(a);else{if(!o.visible||!o.measurable)return;o.updateLocalTransform();const l=o.localTransform;a=ot.get(),a.appendFrom(l,t)}const r=e,n=!!o.effects.length;if(n&&(e=Gt.get().clear()),o.boundsArea)e.addRect(o.boundsArea,a);else{o.renderPipeId&&(e.matrix=a,e.addBounds(o.bounds));const l=o.children;for(let h=0;h<l.length;h++)Ch(l[h],e,a,i,!1)}if(n){for(let l=0;l<o.effects.length;l++)o.effects[l].addLocalBounds?.(e,i);r.addBounds(e,_e.IDENTITY),Gt.return(e)}ot.return(a)}function Ph(o,e){const t=o.children;for(let i=0;i<t.length;i++){const s=t[i],a=s.uid,r=(s._didViewChangeTick&65535)<<16|s._didContainerChangeTick&65535,n=e.index;(e.data[n]!==a||e.data[n+1]!==r)&&(e.data[e.index]=a,e.data[e.index+1]=r,e.didChange=!0),e.index=n+2,s.children.length&&Ph(s,e)}return e.didChange}const Qd=new _e,Zd={_localBoundsCacheId:-1,_localBoundsCacheData:null,_setWidth(o,e){const t=Math.sign(this.scale.x)||1;e!==0?this.scale.x=o/e*t:this.scale.x=t},_setHeight(o,e){const t=Math.sign(this.scale.y)||1;e!==0?this.scale.y=o/e*t:this.scale.y=t},getLocalBounds(){this._localBoundsCacheData||(this._localBoundsCacheData={data:[],index:1,didChange:!1,localBounds:new At});const o=this._localBoundsCacheData;return o.index=1,o.didChange=!1,o.data[0]!==this._didViewChangeTick&&(o.didChange=!0,o.data[0]=this._didViewChangeTick),Ph(this,o),o.didChange&&Mh(this,o.localBounds,Qd),o.localBounds},getBounds(o,e){return Sh(this,o,e||new At)}},Jd={_onRender:null,set onRender(o){const e=this.renderGroup||this.parentRenderGroup;if(!o){this._onRender&&e?.removeOnRender(this),this._onRender=null;return}this._onRender||e?.addOnRender(this),this._onRender=o},get onRender(){return this._onRender}},eu={_zIndex:0,sortDirty:!1,sortableChildren:!1,get zIndex(){return this._zIndex},set zIndex(o){this._zIndex!==o&&(this._zIndex=o,this.depthOfChildModified())},depthOfChildModified(){this.parent&&(this.parent.sortableChildren=!0,this.parent.sortDirty=!0),this.parentRenderGroup&&(this.parentRenderGroup.structureDidChange=!0)},sortChildren(){this.sortDirty&&(this.sortDirty=!1,this.children.sort(tu))}};function tu(o,e){return o._zIndex-e._zIndex}const iu={getGlobalPosition(o=new st,e=!1){return this.parent?this.parent.toGlobal(this._position,o,e):(o.x=this._position.x,o.y=this._position.y),o},toGlobal(o,e,t=!1){const i=this.getGlobalTransform(ot.get(),t);return e=i.apply(o,e),ot.return(i),e},toLocal(o,e,t,i){e&&(o=e.toGlobal(o,t,i));const s=this.getGlobalTransform(ot.get(),i);return t=s.applyInverse(o,t),ot.return(s),t}};class yo{constructor(){this.uid=He("instructionSet"),this.instructions=[],this.instructionSize=0,this.renderables=[],this.gcTick=0}reset(){this.instructionSize=0}destroy(){this.instructions.length=0,this.renderables.length=0,this.renderPipes=null,this.gcTick=0}add(e){this.instructions[this.instructionSize++]=e}log(){this.instructions.length=this.instructionSize,console.table(this.instructions,["type","action"])}}let su=0;class au{constructor(e){this._poolKeyHash=Object.create(null),this._texturePool={},this.textureOptions=e||{},this.enableFullScreen=!1,this.textureStyle=new _h(this.textureOptions)}createTexture(e,t,i){const s=new Rt({...this.textureOptions,width:e,height:t,resolution:1,antialias:i,autoGarbageCollect:!1});return new Z({source:s,label:`texturePool_${su++}`})}getOptimalTexture(e,t,i=1,s){let a=Math.ceil(e*i-1e-6),r=Math.ceil(t*i-1e-6);a=qo(a),r=qo(r);const n=(a<<17)+(r<<1)+(s?1:0);this._texturePool[n]||(this._texturePool[n]=[]);let l=this._texturePool[n].pop();return l||(l=this.createTexture(a,r,s)),l.source._resolution=i,l.source.width=a/i,l.source.height=r/i,l.source.pixelWidth=a,l.source.pixelHeight=r,l.frame.x=0,l.frame.y=0,l.frame.width=e,l.frame.height=t,l.updateUvs(),this._poolKeyHash[l.uid]=n,l}getSameSizeTexture(e,t=!1){const i=e.source;return this.getOptimalTexture(e.width,e.height,i._resolution,t)}returnTexture(e,t=!1){const i=this._poolKeyHash[e.uid];t&&(e.source.style=this.textureStyle),this._texturePool[i].push(e)}clear(e){if(e=e!==!1,e)for(const t in this._texturePool){const i=this._texturePool[t];if(i)for(let s=0;s<i.length;s++)i[s].destroy(!0)}this._texturePool={}}}const Ih=new au;Da.register(Ih);class ru{constructor(){this.renderPipeId="renderGroup",this.root=null,this.canBundle=!1,this.renderGroupParent=null,this.renderGroupChildren=[],this.worldTransform=new _e,this.worldColorAlpha=4294967295,this.worldColor=16777215,this.worldAlpha=1,this.childrenToUpdate=Object.create(null),this.updateTick=0,this.gcTick=0,this.childrenRenderablesToUpdate={list:[],index:0},this.structureDidChange=!0,this.instructionSet=new yo,this._onRenderContainers=[],this.textureNeedsUpdate=!0,this.isCachedAsTexture=!1,this._matrixDirty=7}init(e){this.root=e,e._onRender&&this.addOnRender(e),e.didChange=!0;const t=e.children;for(let i=0;i<t.length;i++){const s=t[i];s._updateFlags=15,this.addChild(s)}}enableCacheAsTexture(e={}){this.textureOptions=e,this.isCachedAsTexture=!0,this.textureNeedsUpdate=!0}disableCacheAsTexture(){this.isCachedAsTexture=!1,this.texture&&(Ih.returnTexture(this.texture,!0),this.texture=null)}updateCacheTexture(){this.textureNeedsUpdate=!0;const e=this._parentCacheAsTextureRenderGroup;e&&!e.textureNeedsUpdate&&e.updateCacheTexture()}reset(){this.renderGroupChildren.length=0;for(const e in this.childrenToUpdate){const t=this.childrenToUpdate[e];t.list.fill(null),t.index=0}this.childrenRenderablesToUpdate.index=0,this.childrenRenderablesToUpdate.list.fill(null),this.root=null,this.updateTick=0,this.structureDidChange=!0,this._onRenderContainers.length=0,this.renderGroupParent=null,this.disableCacheAsTexture()}get localTransform(){return this.root.localTransform}addRenderGroupChild(e){e.renderGroupParent&&e.renderGroupParent._removeRenderGroupChild(e),e.renderGroupParent=this,this.renderGroupChildren.push(e)}_removeRenderGroupChild(e){const t=this.renderGroupChildren.indexOf(e);t>-1&&this.renderGroupChildren.splice(t,1),e.renderGroupParent=null}addChild(e){if(this.structureDidChange=!0,e.parentRenderGroup=this,e.updateTick=-1,e.parent===this.root?e.relativeRenderGroupDepth=1:e.relativeRenderGroupDepth=e.parent.relativeRenderGroupDepth+1,e.didChange=!0,this.onChildUpdate(e),e.renderGroup){this.addRenderGroupChild(e.renderGroup);return}e._onRender&&this.addOnRender(e);const t=e.children;for(let i=0;i<t.length;i++)this.addChild(t[i])}removeChild(e){if(this.structureDidChange=!0,e._onRender&&(e.renderGroup||this.removeOnRender(e)),e.parentRenderGroup=null,e.renderGroup){this._removeRenderGroupChild(e.renderGroup);return}const t=e.children;for(let i=0;i<t.length;i++)this.removeChild(t[i])}removeChildren(e){for(let t=0;t<e.length;t++)this.removeChild(e[t])}onChildUpdate(e){let t=this.childrenToUpdate[e.relativeRenderGroupDepth];t||(t=this.childrenToUpdate[e.relativeRenderGroupDepth]={index:0,list:[]}),t.list[t.index++]=e}updateRenderable(e){e.globalDisplayStatus<7||(this.instructionSet.renderPipes[e.renderPipeId].updateRenderable(e),e.didViewUpdate=!1)}onChildViewUpdate(e){this.childrenRenderablesToUpdate.list[this.childrenRenderablesToUpdate.index++]=e}get isRenderable(){return this.root.localDisplayStatus===7&&this.worldAlpha>0}addOnRender(e){this._onRenderContainers.push(e)}removeOnRender(e){this._onRenderContainers.splice(this._onRenderContainers.indexOf(e),1)}runOnRender(e){for(let t=0;t<this._onRenderContainers.length;t++)this._onRenderContainers[t]._onRender(e)}destroy(){this.disableCacheAsTexture(),this.renderGroupParent=null,this.root=null,this.childrenRenderablesToUpdate=null,this.childrenToUpdate=null,this.renderGroupChildren=null,this._onRenderContainers=null,this.instructionSet=null}getChildren(e=[]){const t=this.root.children;for(let i=0;i<t.length;i++)this._getChildren(t[i],e);return e}_getChildren(e,t=[]){if(t.push(e),e.renderGroup)return t;const i=e.children;for(let s=0;s<i.length;s++)this._getChildren(i[s],t);return t}invalidateMatrices(){this._matrixDirty=7}get inverseWorldTransform(){return(this._matrixDirty&1)===0?this._inverseWorldTransform:(this._matrixDirty&=-2,this._inverseWorldTransform||(this._inverseWorldTransform=new _e),this._inverseWorldTransform.copyFrom(this.worldTransform).invert())}get textureOffsetInverseTransform(){return(this._matrixDirty&2)===0?this._textureOffsetInverseTransform:(this._matrixDirty&=-3,this._textureOffsetInverseTransform||(this._textureOffsetInverseTransform=new _e),this._textureOffsetInverseTransform.copyFrom(this.inverseWorldTransform).translate(-this._textureBounds.x,-this._textureBounds.y))}get inverseParentTextureTransform(){if((this._matrixDirty&4)===0)return this._inverseParentTextureTransform;this._matrixDirty&=-5;const e=this._parentCacheAsTextureRenderGroup;return e?(this._inverseParentTextureTransform||(this._inverseParentTextureTransform=new _e),this._inverseParentTextureTransform.copyFrom(this.worldTransform).prepend(e.inverseWorldTransform).translate(-e._textureBounds.x,-e._textureBounds.y)):this.worldTransform}get cacheToLocalTransform(){return this.isCachedAsTexture?this.textureOffsetInverseTransform:this._parentCacheAsTextureRenderGroup?this._parentCacheAsTextureRenderGroup.textureOffsetInverseTransform:null}}function ou(o,e,t={}){for(const i in e)!t[i]&&e[i]!==void 0&&(o[i]=e[i])}const ja=new it(null),Ds=new it(null),Ka=new it(null,1,1),Fs=new it(null),hn=1,nu=2,Qa=4;class we extends Xt{constructor(e={}){super(),this.uid=He("renderable"),this._updateFlags=15,this.renderGroup=null,this.parentRenderGroup=null,this.parentRenderGroupIndex=0,this.didChange=!1,this.didViewUpdate=!1,this.relativeRenderGroupDepth=0,this.children=[],this.parent=null,this.includeInBuild=!0,this.measurable=!0,this.isSimple=!0,this.parentRenderLayer=null,this.updateTick=-1,this.localTransform=new _e,this.relativeGroupTransform=new _e,this.groupTransform=this.relativeGroupTransform,this.destroyed=!1,this._position=new it(this,0,0),this._scale=Ka,this._pivot=Ds,this._origin=Fs,this._skew=ja,this._cx=1,this._sx=0,this._cy=0,this._sy=1,this._rotation=0,this.localColor=16777215,this.localAlpha=1,this.groupAlpha=1,this.groupColor=16777215,this.groupColorAlpha=4294967295,this.localBlendMode="inherit",this.groupBlendMode="normal",this.localDisplayStatus=7,this.globalDisplayStatus=7,this._didContainerChangeTick=0,this._didViewChangeTick=0,this._didLocalTransformChangeId=-1,this.effects=[],ou(this,e,{children:!0,parent:!0,effects:!0}),e.children?.forEach(t=>this.addChild(t)),e.parent?.addChild(this)}static mixin(e){Ie("8.8.0","Container.mixin is deprecated, please use extensions.mixin instead."),Ze.mixin(we,e)}set _didChangeId(e){this._didViewChangeTick=e>>12&4095,this._didContainerChangeTick=e&4095}get _didChangeId(){return this._didContainerChangeTick&4095|(this._didViewChangeTick&4095)<<12}addChild(...e){if(this.allowChildren||Ie(je,"addChild: Only Containers will be allowed to add children in v8.0.0"),e.length>1){for(let s=0;s<e.length;s++)this.addChild(e[s]);return e[0]}const t=e[0],i=this.renderGroup||this.parentRenderGroup;return t.parent===this?(this.children.splice(this.children.indexOf(t),1),this.children.push(t),i&&(i.structureDidChange=!0),t):(t.parent&&t.parent.removeChild(t),this.children.push(t),this.sortableChildren&&(this.sortDirty=!0),t.parent=this,t.didChange=!0,t._updateFlags=15,i&&i.addChild(t),this.emit("childAdded",t,this,this.children.length-1),t.emit("added",this),this._didViewChangeTick++,t._zIndex!==0&&t.depthOfChildModified(),t)}removeChild(...e){if(e.length>1){for(let s=0;s<e.length;s++)this.removeChild(e[s]);return e[0]}const t=e[0],i=this.children.indexOf(t);return i>-1&&(this._didViewChangeTick++,this.children.splice(i,1),this.renderGroup?this.renderGroup.removeChild(t):this.parentRenderGroup&&this.parentRenderGroup.removeChild(t),t.parentRenderLayer&&t.parentRenderLayer.detach(t),t.parent=null,this.emit("childRemoved",t,this,i),t.emit("removed",this)),t}_onUpdate(e){e&&e===this._skew&&this._updateSkew(),this._didContainerChangeTick++,!this.didChange&&(this.didChange=!0,this.parentRenderGroup&&this.parentRenderGroup.onChildUpdate(this))}set isRenderGroup(e){!!this.renderGroup!==e&&(e?this.enableRenderGroup():this.disableRenderGroup())}get isRenderGroup(){return!!this.renderGroup}enableRenderGroup(){if(this.renderGroup)return;const e=this.parentRenderGroup;e?.removeChild(this),this.renderGroup=ct.get(ru,this),this.groupTransform=_e.IDENTITY,e?.addChild(this),this._updateIsSimple()}disableRenderGroup(){if(!this.renderGroup)return;const e=this.parentRenderGroup;e?.removeChild(this),ct.return(this.renderGroup),this.renderGroup=null,this.groupTransform=this.relativeGroupTransform,e?.addChild(this),this._updateIsSimple()}_updateIsSimple(){this.isSimple=!this.renderGroup&&this.effects.length===0}get worldTransform(){return this._worldTransform||(this._worldTransform=new _e),this.renderGroup?this._worldTransform.copyFrom(this.renderGroup.worldTransform):this.parentRenderGroup&&this._worldTransform.appendFrom(this.relativeGroupTransform,this.parentRenderGroup.worldTransform),this._worldTransform}get x(){return this._position.x}set x(e){this._position.x=e}get y(){return this._position.y}set y(e){this._position.y=e}get position(){return this._position}set position(e){this._position.copyFrom(e)}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._onUpdate(this._skew))}get angle(){return this.rotation*wd}set angle(e){this.rotation=e*vd}get pivot(){return this._pivot===Ds&&(this._pivot=new it(this,0,0)),this._pivot}set pivot(e){this._pivot===Ds&&(this._pivot=new it(this,0,0),this._origin!==Fs&&pt("Setting both a pivot and origin on a Container is not recommended. This can lead to unexpected behavior if not handled carefully.")),typeof e=="number"?this._pivot.set(e):this._pivot.copyFrom(e)}get skew(){return this._skew===ja&&(this._skew=new it(this,0,0)),this._skew}set skew(e){this._skew===ja&&(this._skew=new it(this,0,0)),this._skew.copyFrom(e)}get scale(){return this._scale===Ka&&(this._scale=new it(this,1,1)),this._scale}set scale(e){this._scale===Ka&&(this._scale=new it(this,0,0)),typeof e=="string"&&(e=parseFloat(e)),typeof e=="number"?this._scale.set(e):this._scale.copyFrom(e)}get origin(){return this._origin===Fs&&(this._origin=new it(this,0,0)),this._origin}set origin(e){this._origin===Fs&&(this._origin=new it(this,0,0),this._pivot!==Ds&&pt("Setting both a pivot and origin on a Container is not recommended. This can lead to unexpected behavior if not handled carefully.")),typeof e=="number"?this._origin.set(e):this._origin.copyFrom(e)}get width(){return Math.abs(this.scale.x*this.getLocalBounds().width)}set width(e){const t=this.getLocalBounds().width;this._setWidth(e,t)}get height(){return Math.abs(this.scale.y*this.getLocalBounds().height)}set height(e){const t=this.getLocalBounds().height;this._setHeight(e,t)}getSize(e){e||(e={});const t=this.getLocalBounds();return e.width=Math.abs(this.scale.x*t.width),e.height=Math.abs(this.scale.y*t.height),e}setSize(e,t){const i=this.getLocalBounds();typeof e=="object"?(t=e.height??e.width,e=e.width):t??(t=e),e!==void 0&&this._setWidth(e,i.width),t!==void 0&&this._setHeight(t,i.height)}_updateSkew(){const e=this._rotation,t=this._skew;this._cx=Math.cos(e+t._y),this._sx=Math.sin(e+t._y),this._cy=-Math.sin(e-t._x),this._sy=Math.cos(e-t._x)}updateTransform(e){return this.position.set(typeof e.x=="number"?e.x:this.position.x,typeof e.y=="number"?e.y:this.position.y),this.scale.set(typeof e.scaleX=="number"?e.scaleX||1:this.scale.x,typeof e.scaleY=="number"?e.scaleY||1:this.scale.y),this.rotation=typeof e.rotation=="number"?e.rotation:this.rotation,this.skew.set(typeof e.skewX=="number"?e.skewX:this.skew.x,typeof e.skewY=="number"?e.skewY:this.skew.y),this.pivot.set(typeof e.pivotX=="number"?e.pivotX:this.pivot.x,typeof e.pivotY=="number"?e.pivotY:this.pivot.y),this.origin.set(typeof e.originX=="number"?e.originX:this.origin.x,typeof e.originY=="number"?e.originY:this.origin.y),this}setFromMatrix(e){e.decompose(this)}updateLocalTransform(){const e=this._didContainerChangeTick;if(this._didLocalTransformChangeId===e)return;this._didLocalTransformChangeId=e;const t=this.localTransform,i=this._scale,s=this._pivot,a=this._origin,r=this._position,n=i._x,l=i._y,h=s._x,c=s._y,d=-a._x,u=-a._y;t.a=this._cx*n,t.b=this._sx*n,t.c=this._cy*l,t.d=this._sy*l,t.tx=r._x-(h*t.a+c*t.c)+(d*t.a+u*t.c)-d,t.ty=r._y-(h*t.b+c*t.d)+(d*t.b+u*t.d)-u}set alpha(e){e!==this.localAlpha&&(this.localAlpha=e,this._updateFlags|=hn,this._onUpdate())}get alpha(){return this.localAlpha}set tint(e){const i=wt.shared.setValue(e??16777215).toBgrNumber();i!==this.localColor&&(this.localColor=i,this._updateFlags|=hn,this._onUpdate())}get tint(){return ma(this.localColor)}set blendMode(e){this.localBlendMode!==e&&(this.parentRenderGroup&&(this.parentRenderGroup.structureDidChange=!0),this._updateFlags|=nu,this.localBlendMode=e,this._onUpdate())}get blendMode(){return this.localBlendMode}get visible(){return!!(this.localDisplayStatus&2)}set visible(e){const t=e?2:0;(this.localDisplayStatus&2)!==t&&(this.parentRenderGroup&&(this.parentRenderGroup.structureDidChange=!0),this._updateFlags|=Qa,this.localDisplayStatus^=2,this._onUpdate())}get culled(){return!(this.localDisplayStatus&4)}set culled(e){const t=e?0:4;(this.localDisplayStatus&4)!==t&&(this.parentRenderGroup&&(this.parentRenderGroup.structureDidChange=!0),this._updateFlags|=Qa,this.localDisplayStatus^=4,this._onUpdate())}get renderable(){return!!(this.localDisplayStatus&1)}set renderable(e){const t=e?1:0;(this.localDisplayStatus&1)!==t&&(this._updateFlags|=Qa,this.localDisplayStatus^=1,this.parentRenderGroup&&(this.parentRenderGroup.structureDidChange=!0),this._onUpdate())}get isRenderable(){return this.localDisplayStatus===7&&this.groupAlpha>0}destroy(e=!1){if(this.destroyed)return;this.destroyed=!0;let t;if(this.children.length&&(t=this.removeChildren(0,this.children.length)),this.removeFromParent(),this.parent=null,this._maskEffect=null,this._filterEffect=null,this.effects=null,this._position=null,this._scale=null,this._pivot=null,this._origin=null,this._skew=null,this.emit("destroyed",this),this.removeAllListeners(),(typeof e=="boolean"?e:e?.children)&&t)for(let s=0;s<t.length;++s)t[s].destroy(e);this.renderGroup?.destroy(),this.renderGroup=null}}Ze.mixin(we,zd,jd,iu,Jd,Zd,qd,Yd,eu,Wd,Gd,Kd,Xd);class Ah extends we{constructor(e){super(e),this.canBundle=!0,this.allowChildren=!1,this._roundPixels=0,this._lastUsed=-1,this._gpuData=Object.create(null),this.autoGarbageCollect=!0,this._gcLastUsed=-1,this._bounds=new At(0,1,0,0),this._boundsDirty=!0,this.autoGarbageCollect=e.autoGarbageCollect??!0}get bounds(){return this._boundsDirty?(this.updateBounds(),this._boundsDirty=!1,this._bounds):this._bounds}get roundPixels(){return!!this._roundPixels}set roundPixels(e){this._roundPixels=e?1:0}containsPoint(e){const t=this.bounds,{x:i,y:s}=e;return i>=t.minX&&i<=t.maxX&&s>=t.minY&&s<=t.maxY}onViewUpdate(){if(this._didViewChangeTick++,this._boundsDirty=!0,this.didViewUpdate)return;this.didViewUpdate=!0;const e=this.renderGroup||this.parentRenderGroup;e&&e.onChildViewUpdate(this)}unload(){this.emit("unload",this);for(const e in this._gpuData)this._gpuData[e]?.destroy();this._gpuData=Object.create(null),this.onViewUpdate()}destroy(e){this.unload(),super.destroy(e),this._bounds=null}collectRenderablesSimple(e,t,i){const{renderPipes:s}=t;s.blendMode.pushBlendMode(this,this.groupBlendMode,e);const r=s[this.renderPipeId];r?.addRenderable&&r.addRenderable(this,e),this.didViewUpdate=!1;const n=this.children,l=n.length;for(let h=0;h<l;h++)n[h].collectRenderables(e,t,i);s.blendMode.popBlendMode(e)}}let _t=class Hr extends Ah{constructor(e=Z.EMPTY){e instanceof Z&&(e={texture:e});const{texture:t=Z.EMPTY,anchor:i,roundPixels:s,width:a,height:r,...n}=e;super({label:"Sprite",...n}),this.renderPipeId="sprite",this.batched=!0,this._visualBounds={minX:0,maxX:1,minY:0,maxY:0},this._anchor=new it({_onUpdate:()=>{this.onViewUpdate()}}),i?this.anchor=i:t.defaultAnchor&&(this.anchor=t.defaultAnchor),this.texture=t,this.allowChildren=!1,this.roundPixels=s??!1,a!==void 0&&(this.width=a),r!==void 0&&(this.height=r)}static from(e,t=!1){return e instanceof Z?new Hr(e):new Hr(Z.from(e,t))}set texture(e){e||(e=Z.EMPTY);const t=this._texture;t!==e&&(t&&t.dynamic&&t.off("update",this.onViewUpdate,this),e.dynamic&&e.on("update",this.onViewUpdate,this),this._texture=e,this._width&&this._setWidth(this._width,this._texture.orig.width),this._height&&this._setHeight(this._height,this._texture.orig.height),this.onViewUpdate())}get texture(){return this._texture}get visualBounds(){return Id(this._visualBounds,this._anchor,this._texture),this._visualBounds}get sourceBounds(){return Ie("8.6.1","Sprite.sourceBounds is deprecated, use visualBounds instead."),this.visualBounds}updateBounds(){const e=this._anchor,t=this._texture,i=this._bounds,{width:s,height:a}=t.orig;i.minX=-e._x*s,i.maxX=i.minX+s,i.minY=-e._y*a,i.maxY=i.minY+a}destroy(e=!1){if(super.destroy(e),typeof e=="boolean"?e:e?.texture){const i=typeof e=="boolean"?e:e?.textureSource;this._texture.destroy(i)}this._texture=null,this._visualBounds=null,this._bounds=null,this._anchor=null}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}get width(){return Math.abs(this.scale.x)*this._texture.orig.width}set width(e){this._setWidth(e,this._texture.orig.width),this._width=e}get height(){return Math.abs(this.scale.y)*this._texture.orig.height}set height(e){this._setHeight(e,this._texture.orig.height),this._height=e}getSize(e){return e||(e={}),e.width=Math.abs(this.scale.x)*this._texture.orig.width,e.height=Math.abs(this.scale.y)*this._texture.orig.height,e}setSize(e,t){typeof e=="object"?(t=e.height??e.width,e=e.width):t??(t=e),e!==void 0&&this._setWidth(e,this._texture.orig.width),t!==void 0&&this._setHeight(t,this._texture.orig.height)}};const lu=new At;function Rh(o,e,t){const i=lu;o.measurable=!0,Sh(o,t,i),e.addBoundsMask(i),o.measurable=!1}function xh(o,e,t){const i=Gt.get();o.measurable=!0;const s=ot.get().identity(),a=Eh(o,t,s);Mh(o,i,a),o.measurable=!1,e.addBoundsMask(i),ot.return(s),Gt.return(i)}function Eh(o,e,t){return o?(o!==e&&(Eh(o.parent,e,t),o.updateLocalTransform(),t.append(o.localTransform)),t):(pt("Mask bounds, renderable is not inside the root container"),t)}class Dh{constructor(e){this.priority=0,this.inverse=!1,this.pipe="alphaMask",e?.mask&&this.init(e.mask)}init(e){this.mask=e,this.renderMaskToTexture=!(e instanceof _t),this.mask.renderable=this.renderMaskToTexture,this.mask.includeInBuild=!this.renderMaskToTexture,this.mask.measurable=!1}reset(){this.mask!==null&&(this.mask.measurable=!0,this.mask=null)}addBounds(e,t){this.inverse||Rh(this.mask,e,t)}addLocalBounds(e,t){xh(this.mask,e,t)}containsPoint(e,t){const i=this.mask;return t(i,e)}destroy(){this.reset()}static test(e){return e instanceof _t}}Dh.extension=ge.MaskEffect;class Fh{constructor(e){this.priority=0,this.pipe="colorMask",e?.mask&&this.init(e.mask)}init(e){this.mask=e}destroy(){}static test(e){return typeof e=="number"}}Fh.extension=ge.MaskEffect;class $h{constructor(e){this.priority=0,this.pipe="stencilMask",e?.mask&&this.init(e.mask)}init(e){this.mask=e,this.mask.includeInBuild=!1,this.mask.measurable=!1}reset(){this.mask!==null&&(this.mask.measurable=!0,this.mask.includeInBuild=!0,this.mask=null)}addBounds(e,t){Rh(this.mask,e,t)}addLocalBounds(e,t){xh(this.mask,e,t)}containsPoint(e,t){const i=this.mask;return t(i,e)}destroy(){this.reset()}static test(e){return e instanceof we}}$h.extension=ge.MaskEffect;const hu={createCanvas:(o,e)=>{const t=document.createElement("canvas");return t.width=o,t.height=e,t},createImage:()=>new Image,getCanvasRenderingContext2D:()=>CanvasRenderingContext2D,getWebGLRenderingContext:()=>WebGLRenderingContext,getNavigator:()=>navigator,getBaseUrl:()=>document.baseURI??window.location.href,getFontFaceSet:()=>document.fonts,fetch:(o,e)=>fetch(o,e),parseXML:o=>new DOMParser().parseFromString(o,"text/xml")};let cn=hu;const Kt={get(){return cn},set(o){cn=o}};class Lh extends Rt{constructor(e){e.resource||(e.resource=Kt.get().createCanvas()),e.width||(e.width=e.resource.width,e.autoDensity||(e.width/=e.resolution)),e.height||(e.height=e.resource.height,e.autoDensity||(e.height/=e.resolution)),super(e),this.uploadMethodId="image",this.autoDensity=e.autoDensity,this.resizeCanvas(),this.transparent=!!e.transparent}resizeCanvas(){this.autoDensity&&"style"in this.resource&&(this.resource.style.width=`${this.width}px`,this.resource.style.height=`${this.height}px`),(this.resource.width!==this.pixelWidth||this.resource.height!==this.pixelHeight)&&(this.resource.width=this.pixelWidth,this.resource.height=this.pixelHeight)}resize(e=this.width,t=this.height,i=this._resolution){const s=super.resize(e,t,i);return s&&this.resizeCanvas(),s}static test(e){return globalThis.HTMLCanvasElement&&e instanceof HTMLCanvasElement||globalThis.OffscreenCanvas&&e instanceof OffscreenCanvas}get context2D(){return this._context2D||(this._context2D=this.resource.getContext("2d"))}}Lh.extension=ge.TextureSource;class nt extends Rt{constructor(e){super(e),this.uploadMethodId="image",this.autoGarbageCollect=!0}static test(e){return globalThis.HTMLImageElement&&e instanceof HTMLImageElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||globalThis.VideoFrame&&e instanceof VideoFrame}}nt.extension=ge.TextureSource;var wa=(o=>(o[o.INTERACTION=50]="INTERACTION",o[o.HIGH=25]="HIGH",o[o.NORMAL=0]="NORMAL",o[o.LOW=-25]="LOW",o[o.UTILITY=-50]="UTILITY",o))(wa||{});class Za{constructor(e,t=null,i=0,s=!1){this.next=null,this.previous=null,this._destroyed=!1,this._fn=e,this._context=t,this.priority=i,this._once=s}match(e,t=null){return this._fn===e&&this._context===t}emit(e){this._fn&&(this._context?this._fn.call(this._context,e):this._fn(e));const t=this.next;return this._once&&this.destroy(!0),this._destroyed&&(this.next=null),t}connect(e){this.previous=e,e.next&&(e.next.previous=this),this.next=e.next,e.next=this}destroy(e=!1){this._destroyed=!0,this._fn=null,this._context=null,this.previous&&(this.previous.next=this.next),this.next&&(this.next.previous=this.previous);const t=this.next;return this.next=e?null:t,this.previous=null,t}}const Bh=class ft{constructor(){this.autoStart=!1,this.deltaTime=1,this.lastTime=-1,this.speed=1,this.started=!1,this._requestId=null,this._maxElapsedMS=100,this._minElapsedMS=0,this._protected=!1,this._lastFrame=-1,this._head=new Za(null,null,1/0),this.deltaMS=1/ft.targetFPMS,this.elapsedMS=1/ft.targetFPMS,this._tick=e=>{this._requestId=null,this.started&&(this.update(e),this.started&&this._requestId===null&&this._head.next&&(this._requestId=requestAnimationFrame(this._tick)))}}_requestIfNeeded(){this._requestId===null&&this._head.next&&(this.lastTime=performance.now(),this._lastFrame=this.lastTime,this._requestId=requestAnimationFrame(this._tick))}_cancelIfNeeded(){this._requestId!==null&&(cancelAnimationFrame(this._requestId),this._requestId=null)}_startIfPossible(){this.started?this._requestIfNeeded():this.autoStart&&this.start()}add(e,t,i=wa.NORMAL){return this._addListener(new Za(e,t,i))}addOnce(e,t,i=wa.NORMAL){return this._addListener(new Za(e,t,i,!0))}_addListener(e){let t=this._head.next,i=this._head;if(!t)e.connect(i);else{for(;t;){if(e.priority>t.priority){e.connect(i);break}i=t,t=t.next}e.previous||e.connect(i)}return this._startIfPossible(),this}remove(e,t){let i=this._head.next;for(;i;)i.match(e,t)?i=i.destroy():i=i.next;return this._head.next||this._cancelIfNeeded(),this}get count(){if(!this._head)return 0;let e=0,t=this._head;for(;t=t.next;)e++;return e}start(){this.started||(this.started=!0,this._requestIfNeeded())}stop(){this.started&&(this.started=!1,this._cancelIfNeeded())}destroy(){if(!this._protected){this.stop();let e=this._head.next;for(;e;)e=e.destroy(!0);this._head.destroy(),this._head=null}}update(e=performance.now()){let t;if(e>this.lastTime){if(t=this.elapsedMS=e-this.lastTime,t>this._maxElapsedMS&&(t=this._maxElapsedMS),t*=this.speed,this._minElapsedMS){const a=e-this._lastFrame|0;if(a<this._minElapsedMS)return;this._lastFrame=e-a%this._minElapsedMS}this.deltaMS=t,this.deltaTime=this.deltaMS*ft.targetFPMS;const i=this._head;let s=i.next;for(;s;)s=s.emit(this);i.next||this._cancelIfNeeded()}else this.deltaTime=this.deltaMS=this.elapsedMS=0;this.lastTime=e}get FPS(){return 1e3/this.elapsedMS}get minFPS(){return 1e3/this._maxElapsedMS}set minFPS(e){const t=Math.min(this.maxFPS,e),i=Math.min(Math.max(0,t)/1e3,ft.targetFPMS);this._maxElapsedMS=1/i}get maxFPS(){return this._minElapsedMS?Math.round(1e3/this._minElapsedMS):0}set maxFPS(e){if(e===0)this._minElapsedMS=0;else{const t=Math.max(this.minFPS,e);this._minElapsedMS=1/(t/1e3)}}static get shared(){if(!ft._shared){const e=ft._shared=new ft;e.autoStart=!0,e._protected=!0}return ft._shared}static get system(){if(!ft._system){const e=ft._system=new ft;e.autoStart=!0,e._protected=!0}return ft._system}};Bh.targetFPMS=.06;let xi=Bh,Ja;async function cu(){return Ja??(Ja=(async()=>{const e=Kt.get().createCanvas(1,1).getContext("webgl");if(!e)return"premultiply-alpha-on-upload";const t=await new Promise(r=>{const n=document.createElement("video");n.onloadeddata=()=>r(n),n.onerror=()=>r(null),n.autoplay=!1,n.crossOrigin="anonymous",n.preload="auto",n.src="data:video/webm;base64,GkXfo59ChoEBQveBAULygQRC84EIQoKEd2VibUKHgQJChYECGFOAZwEAAAAAAAHTEU2bdLpNu4tTq4QVSalmU6yBoU27i1OrhBZUrmtTrIHGTbuMU6uEElTDZ1OsggEXTbuMU6uEHFO7a1OsggG97AEAAAAAAABZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVSalmoCrXsYMPQkBNgIRMYXZmV0GETGF2ZkSJiEBEAAAAAAAAFlSua8yuAQAAAAAAAEPXgQFzxYgAAAAAAAAAAZyBACK1nIN1bmSIgQCGhVZfVlA5g4EBI+ODhAJiWgDglLCBArqBApqBAlPAgQFVsIRVuYEBElTDZ9Vzc9JjwItjxYgAAAAAAAAAAWfInEWjh0VOQ09ERVJEh49MYXZjIGxpYnZweC12cDlnyKJFo4hEVVJBVElPTkSHlDAwOjAwOjAwLjA0MDAwMDAwMAAAH0O2dcfngQCgwqGggQAAAIJJg0IAABAAFgA4JBwYSgAAICAAEb///4r+AAB1oZ2mm+6BAaWWgkmDQgAAEAAWADgkHBhKAAAgIABIQBxTu2uRu4+zgQC3iveBAfGCAXHwgQM=",n.load()});if(!t)return"premultiply-alpha-on-upload";const i=e.createTexture();e.bindTexture(e.TEXTURE_2D,i);const s=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,s),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t);const a=new Uint8Array(4);return e.readPixels(0,0,1,1,e.RGBA,e.UNSIGNED_BYTE,a),e.deleteFramebuffer(s),e.deleteTexture(i),e.getExtension("WEBGL_lose_context")?.loseContext(),a[0]<=a[3]?"premultiplied-alpha":"premultiply-alpha-on-upload"})()),Ja}const Fa=class Wh extends Rt{constructor(e){super(e),this.isReady=!1,this.uploadMethodId="video",e={...Wh.defaultOptions,...e},this._autoUpdate=!0,this._isConnectedToTicker=!1,this._updateFPS=e.updateFPS||0,this._msToNextUpdate=0,this.autoPlay=e.autoPlay!==!1,this.alphaMode=e.alphaMode??"premultiply-alpha-on-upload",this._videoFrameRequestCallback=this._videoFrameRequestCallback.bind(this),this._videoFrameRequestCallbackHandle=null,this._load=null,this._resolve=null,this._reject=null,this._onCanPlay=this._onCanPlay.bind(this),this._onCanPlayThrough=this._onCanPlayThrough.bind(this),this._onError=this._onError.bind(this),this._onPlayStart=this._onPlayStart.bind(this),this._onPlayStop=this._onPlayStop.bind(this),this._onSeeked=this._onSeeked.bind(this),e.autoLoad!==!1&&this.load()}updateFrame(){if(!this.destroyed){if(this._updateFPS){const e=xi.shared.elapsedMS*this.resource.playbackRate;this._msToNextUpdate=Math.floor(this._msToNextUpdate-e)}(!this._updateFPS||this._msToNextUpdate<=0)&&(this._msToNextUpdate=this._updateFPS?Math.floor(1e3/this._updateFPS):0),this.isValid&&this.update()}}_videoFrameRequestCallback(){this.updateFrame(),this.destroyed?this._videoFrameRequestCallbackHandle=null:this._videoFrameRequestCallbackHandle=this.resource.requestVideoFrameCallback(this._videoFrameRequestCallback)}get isValid(){return!!this.resource.videoWidth&&!!this.resource.videoHeight}async load(){if(this._load)return this._load;const e=this.resource,t=this.options;return(e.readyState===e.HAVE_ENOUGH_DATA||e.readyState===e.HAVE_FUTURE_DATA)&&e.width&&e.height&&(e.complete=!0),e.addEventListener("play",this._onPlayStart),e.addEventListener("pause",this._onPlayStop),e.addEventListener("seeked",this._onSeeked),this._isSourceReady()?this._mediaReady():(t.preload||e.addEventListener("canplay",this._onCanPlay),e.addEventListener("canplaythrough",this._onCanPlayThrough),e.addEventListener("error",this._onError,!0)),this.alphaMode=await cu(),this._load=new Promise((i,s)=>{this.isValid?i(this):(this._resolve=i,this._reject=s,t.preloadTimeoutMs!==void 0&&(this._preloadTimeout=setTimeout(()=>{this._onError(new ErrorEvent(`Preload exceeded timeout of ${t.preloadTimeoutMs}ms`))})),e.load())}),this._load}_onError(e){this.resource.removeEventListener("error",this._onError,!0),this.emit("error",e),this._reject&&(this._reject(e),this._reject=null,this._resolve=null)}_isSourcePlaying(){const e=this.resource;return!e.paused&&!e.ended}_isSourceReady(){return this.resource.readyState>2}_onPlayStart(){this.isValid||this._mediaReady(),this._configureAutoUpdate()}_onPlayStop(){this._configureAutoUpdate()}_onSeeked(){this._autoUpdate&&!this._isSourcePlaying()&&(this._msToNextUpdate=0,this.updateFrame(),this._msToNextUpdate=0)}_onCanPlay(){this.resource.removeEventListener("canplay",this._onCanPlay),this._mediaReady()}_onCanPlayThrough(){this.resource.removeEventListener("canplaythrough",this._onCanPlay),this._preloadTimeout&&(clearTimeout(this._preloadTimeout),this._preloadTimeout=void 0),this._mediaReady()}_mediaReady(){const e=this.resource;this.isValid&&(this.isReady=!0,this.resize(e.videoWidth,e.videoHeight)),this._msToNextUpdate=0,this.updateFrame(),this._msToNextUpdate=0,this._resolve&&(this._resolve(this),this._resolve=null,this._reject=null),this._isSourcePlaying()?this._onPlayStart():this.autoPlay&&this.resource.play()}destroy(){this._configureAutoUpdate();const e=this.resource;e&&(e.removeEventListener("play",this._onPlayStart),e.removeEventListener("pause",this._onPlayStop),e.removeEventListener("seeked",this._onSeeked),e.removeEventListener("canplay",this._onCanPlay),e.removeEventListener("canplaythrough",this._onCanPlayThrough),e.removeEventListener("error",this._onError,!0),e.pause(),e.src="",e.load()),super.destroy()}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,this._configureAutoUpdate())}get updateFPS(){return this._updateFPS}set updateFPS(e){e!==this._updateFPS&&(this._updateFPS=e,this._configureAutoUpdate())}_configureAutoUpdate(){this._autoUpdate&&this._isSourcePlaying()?!this._updateFPS&&this.resource.requestVideoFrameCallback?(this._isConnectedToTicker&&(xi.shared.remove(this.updateFrame,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0),this._videoFrameRequestCallbackHandle===null&&(this._videoFrameRequestCallbackHandle=this.resource.requestVideoFrameCallback(this._videoFrameRequestCallback))):(this._videoFrameRequestCallbackHandle!==null&&(this.resource.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker||(xi.shared.add(this.updateFrame,this),this._isConnectedToTicker=!0,this._msToNextUpdate=0)):(this._videoFrameRequestCallbackHandle!==null&&(this.resource.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker&&(xi.shared.remove(this.updateFrame,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0))}static test(e){return globalThis.HTMLVideoElement&&e instanceof HTMLVideoElement}};Fa.extension=ge.TextureSource;Fa.defaultOptions={...Rt.defaultOptions,autoLoad:!0,autoPlay:!0,updateFPS:0,crossorigin:!0,loop:!1,muted:!0,playsinline:!0,preload:!1};Fa.MIME_TYPES={ogv:"video/ogg",mov:"video/quicktime",m4v:"video/mp4"};let du=Fa;const Ii=(o,e,t=!1)=>(Array.isArray(o)||(o=[o]),e?o.map(i=>typeof i=="string"||t?e(i):i):o);class uu{constructor(){this._parsers=[],this._cache=new Map,this._cacheMap=new Map}reset(){this._cacheMap.clear(),this._cache.clear()}has(e){return this._cache.has(e)}get(e){const t=this._cache.get(e);return t||pt(`[Assets] Asset id ${e} was not found in the Cache`),t}set(e,t){const i=Ii(e);let s;for(let l=0;l<this.parsers.length;l++){const h=this.parsers[l];if(h.test(t)){s=h.getCacheableAssets(i,t);break}}const a=new Map(Object.entries(s||{}));s||i.forEach(l=>{a.set(l,t)});const r=[...a.keys()],n={cacheKeys:r,keys:i};i.forEach(l=>{this._cacheMap.set(l,n)}),r.forEach(l=>{const h=s?s[l]:t;this._cache.has(l)&&this._cache.get(l)!==h&&pt("[Cache] already has key:",l),this._cache.set(l,a.get(l))})}remove(e){if(!this._cacheMap.has(e)){pt(`[Assets] Asset id ${e} was not found in the Cache`);return}const t=this._cacheMap.get(e);t.cacheKeys.forEach(s=>{this._cache.delete(s)}),t.keys.forEach(s=>{this._cacheMap.delete(s)})}get parsers(){return this._parsers}}const Ai=new uu,zr=[];Ze.handleByList(ge.TextureSource,zr);function Nh(o={}){const e=o&&o.resource,t=e?o.resource:o,i=e?o:{resource:o};for(let s=0;s<zr.length;s++){const a=zr[s];if(a.test(t))return new a(i)}throw new Error(`Could not find a source type for resource: ${i.resource}`)}function fu(o={},e=!1){const t=o&&o.resource,i=t?o.resource:o,s=t?o:{resource:o};if(!e&&Ai.has(i))return Ai.get(i);const a=new Z({source:Nh(s)});return a.on("destroy",()=>{Ai.has(i)&&Ai.remove(i)}),e||Ai.set(i,a),a}function mu(o,e=!1){return typeof o=="string"?Ai.get(o):o instanceof Rt?new Z({source:o}):fu(o,e)}Z.from=mu;Rt.from=Nh;Ze.add(Dh,Fh,$h,du,nt,Lh,_o);var Oh=(o=>(o[o.Low=0]="Low",o[o.Normal=1]="Normal",o[o.High=2]="High",o))(Oh||{});function kt(o){if(typeof o!="string")throw new TypeError(`Path must be a string. Received ${JSON.stringify(o)}`)}function Ni(o){return o.split("?")[0].split("#")[0]}function pu(o){return o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function _u(o,e,t){return o.replace(new RegExp(pu(e),"g"),t)}function gu(o,e){let t="",i=0,s=-1,a=0,r=-1;for(let n=0;n<=o.length;++n){if(n<o.length)r=o.charCodeAt(n);else{if(r===47)break;r=47}if(r===47){if(!(s===n-1||a===1))if(s!==n-1&&a===2){if(t.length<2||i!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){const l=t.lastIndexOf("/");if(l!==t.length-1){l===-1?(t="",i=0):(t=t.slice(0,l),i=t.length-1-t.lastIndexOf("/")),s=n,a=0;continue}}else if(t.length===2||t.length===1){t="",i=0,s=n,a=0;continue}}}else t.length>0?t+=`/${o.slice(s+1,n)}`:t=o.slice(s+1,n),i=n-s-1;s=n,a=0}else r===46&&a!==-1?++a:a=-1}return t}const ws={toPosix(o){return _u(o,"\\","/")},isUrl(o){return/^https?:/.test(this.toPosix(o))},isDataUrl(o){return/^data:([a-z]+\/[a-z0-9-+.]+(;[a-z0-9-.!#$%*+.{}|~`]+=[a-z0-9-.!#$%*+.{}()_|~`]+)*)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s<>]*?)$/i.test(o)},isBlobUrl(o){return o.startsWith("blob:")},hasProtocol(o){return/^[^/:]+:/.test(this.toPosix(o))},getProtocol(o){kt(o),o=this.toPosix(o);const e=/^file:\/\/\//.exec(o);if(e)return e[0];const t=/^[^/:]+:\/{0,2}/.exec(o);return t?t[0]:""},toAbsolute(o,e,t){if(kt(o),this.isDataUrl(o)||this.isBlobUrl(o))return o;const i=Ni(this.toPosix(e??Kt.get().getBaseUrl())),s=Ni(this.toPosix(t??this.rootname(i)));return o=this.toPosix(o),o.startsWith("/")?ws.join(s,o.slice(1)):this.isAbsolute(o)?o:this.join(i,o)},normalize(o){if(kt(o),o.length===0)return".";if(this.isDataUrl(o)||this.isBlobUrl(o))return o;o=this.toPosix(o);let e="";const t=o.startsWith("/");this.hasProtocol(o)&&(e=this.rootname(o),o=o.slice(e.length));const i=o.endsWith("/");return o=gu(o),o.length>0&&i&&(o+="/"),t?`/${o}`:e+o},isAbsolute(o){return kt(o),o=this.toPosix(o),this.hasProtocol(o)?!0:o.startsWith("/")},join(...o){if(o.length===0)return".";let e;for(let t=0;t<o.length;++t){const i=o[t];if(kt(i),i.length>0)if(e===void 0)e=i;else{const s=o[t-1]??"";this.joinExtensions.includes(this.extname(s).toLowerCase())?e+=`/../${i}`:e+=`/${i}`}}return e===void 0?".":this.normalize(e)},dirname(o){if(kt(o),o.length===0)return".";o=this.toPosix(o);let e=o.charCodeAt(0);const t=e===47;let i=-1,s=!0;const a=this.getProtocol(o),r=o;o=o.slice(a.length);for(let n=o.length-1;n>=1;--n)if(e=o.charCodeAt(n),e===47){if(!s){i=n;break}}else s=!1;return i===-1?t?"/":this.isUrl(r)?a+o:a:t&&i===1?"//":a+o.slice(0,i)},rootname(o){kt(o),o=this.toPosix(o);let e="";if(o.startsWith("/")?e="/":e=this.getProtocol(o),this.isUrl(o)){const t=o.indexOf("/",e.length);t!==-1?e=o.slice(0,t):e=o,e.endsWith("/")||(e+="/")}return e},basename(o,e){kt(o),e&&kt(e),o=Ni(this.toPosix(o));let t=0,i=-1,s=!0,a;if(e!==void 0&&e.length>0&&e.length<=o.length){if(e.length===o.length&&e===o)return"";let r=e.length-1,n=-1;for(a=o.length-1;a>=0;--a){const l=o.charCodeAt(a);if(l===47){if(!s){t=a+1;break}}else n===-1&&(s=!1,n=a+1),r>=0&&(l===e.charCodeAt(r)?--r===-1&&(i=a):(r=-1,i=n))}return t===i?i=n:i===-1&&(i=o.length),o.slice(t,i)}for(a=o.length-1;a>=0;--a)if(o.charCodeAt(a)===47){if(!s){t=a+1;break}}else i===-1&&(s=!1,i=a+1);return i===-1?"":o.slice(t,i)},extname(o){kt(o),o=Ni(this.toPosix(o));let e=-1,t=0,i=-1,s=!0,a=0;for(let r=o.length-1;r>=0;--r){const n=o.charCodeAt(r);if(n===47){if(!s){t=r+1;break}continue}i===-1&&(s=!1,i=r+1),n===46?e===-1?e=r:a!==1&&(a=1):e!==-1&&(a=-1)}return e===-1||i===-1||a===0||a===1&&e===i-1&&e===t+1?"":o.slice(e,i)},parse(o){kt(o);const e={root:"",dir:"",base:"",ext:"",name:""};if(o.length===0)return e;o=Ni(this.toPosix(o));let t=o.charCodeAt(0);const i=this.isAbsolute(o);let s;e.root=this.rootname(o),i||this.hasProtocol(o)?s=1:s=0;let a=-1,r=0,n=-1,l=!0,h=o.length-1,c=0;for(;h>=s;--h){if(t=o.charCodeAt(h),t===47){if(!l){r=h+1;break}continue}n===-1&&(l=!1,n=h+1),t===46?a===-1?a=h:c!==1&&(c=1):a!==-1&&(c=-1)}return a===-1||n===-1||c===0||c===1&&a===n-1&&a===r+1?n!==-1&&(r===0&&i?e.base=e.name=o.slice(1,n):e.base=e.name=o.slice(r,n)):(r===0&&i?(e.name=o.slice(1,a),e.base=o.slice(1,n)):(e.name=o.slice(r,a),e.base=o.slice(r,n)),e.ext=o.slice(a,n)),e.dir=this.dirname(o),e},sep:"/",delimiter:":",joinExtensions:[".html"]};function Gh(o,e,t,i,s){const a=e[t];for(let r=0;r<a.length;r++){const n=a[r];t<e.length-1?Gh(o.replace(i[t],n),e,t+1,i,s):s.push(o.replace(i[t],n))}}function yu(o){const e=/\{(.*?)\}/g,t=o.match(e),i=[];if(t){const s=[];t.forEach(a=>{const r=a.substring(1,a.length-1).split(",");s.push(r)}),Gh(o,s,0,t,i)}else i.push(o);return i}const dn=o=>!Array.isArray(o);class Hh{constructor(){this._defaultBundleIdentifierOptions={connector:"-",createBundleAssetId:(e,t)=>`${e}${this._bundleIdConnector}${t}`,extractAssetIdFromBundle:(e,t)=>t.replace(`${e}${this._bundleIdConnector}`,"")},this._bundleIdConnector=this._defaultBundleIdentifierOptions.connector,this._createBundleAssetId=this._defaultBundleIdentifierOptions.createBundleAssetId,this._extractAssetIdFromBundle=this._defaultBundleIdentifierOptions.extractAssetIdFromBundle,this._assetMap={},this._preferredOrder=[],this._parsers=[],this._resolverHash={},this._bundles={}}setBundleIdentifier(e){if(this._bundleIdConnector=e.connector??this._bundleIdConnector,this._createBundleAssetId=e.createBundleAssetId??this._createBundleAssetId,this._extractAssetIdFromBundle=e.extractAssetIdFromBundle??this._extractAssetIdFromBundle,this._extractAssetIdFromBundle("foo",this._createBundleAssetId("foo","bar"))!=="bar")throw new Error("[Resolver] GenerateBundleAssetId are not working correctly")}prefer(...e){e.forEach(t=>{this._preferredOrder.push(t),t.priority||(t.priority=Object.keys(t.params))}),this._resolverHash={}}set basePath(e){this._basePath=e}get basePath(){return this._basePath}set rootPath(e){this._rootPath=e}get rootPath(){return this._rootPath}get parsers(){return this._parsers}reset(){this.setBundleIdentifier(this._defaultBundleIdentifierOptions),this._assetMap={},this._preferredOrder=[],this._resolverHash={},this._rootPath=null,this._basePath=null,this._manifest=null,this._bundles={},this._defaultSearchParams=null}setDefaultSearchParams(e){if(typeof e=="string")this._defaultSearchParams=e;else{const t=e;this._defaultSearchParams=Object.keys(t).map(i=>`${encodeURIComponent(i)}=${encodeURIComponent(t[i])}`).join("&")}}getAlias(e){const{alias:t,src:i}=e;return Ii(t||i,a=>typeof a=="string"?a:Array.isArray(a)?a.map(r=>r?.src??r):a?.src?a.src:a,!0)}addManifest(e){this._manifest&&pt("[Resolver] Manifest already exists, this will be overwritten"),this._manifest=e,e.bundles.forEach(t=>{this.addBundle(t.name,t.assets)})}addBundle(e,t){const i=[];let s=t;Array.isArray(t)||(s=Object.entries(t).map(([a,r])=>typeof r=="string"||Array.isArray(r)?{alias:a,src:r}:{alias:a,...r})),s.forEach(a=>{const r=a.src,n=a.alias;let l;if(typeof n=="string"){const h=this._createBundleAssetId(e,n);i.push(h),l=[n,h]}else{const h=n.map(c=>this._createBundleAssetId(e,c));i.push(...h),l=[...n,...h]}this.add({...a,alias:l,src:r})}),this._bundles[e]=i}add(e){const t=[];Array.isArray(e)?t.push(...e):t.push(e);let i;i=a=>{this.hasKey(a)&&pt(`[Resolver] already has key: ${a} overwriting`)},Ii(t).forEach(a=>{const{src:r}=a;let{data:n,format:l,loadParser:h,parser:c}=a;const d=Ii(r).map(_=>typeof _=="string"?yu(_):Array.isArray(_)?_:[_]),u=this.getAlias(a);Array.isArray(u)?u.forEach(i):i(u);const f=[],m=_=>{const p=this._parsers.find(g=>g.test(_));return{src:_,...p?.parse(_)}};d.forEach(_=>{_.forEach(p=>{let g={};if(typeof p!="object"?g=m(p):(n=p.data??n,l=p.format??l,(p.loadParser||p.parser)&&(h=p.loadParser??h,c=p.parser??c),g={...m(p.src),...p}),!u)throw new Error(`[Resolver] alias is undefined for this asset: ${g.src}`);g=this._buildResolvedAsset(g,{aliases:u,data:n,format:l,loadParser:h,parser:c,progressSize:a.progressSize}),f.push(g)})}),u.forEach(_=>{this._assetMap[_]=f})})}resolveBundle(e){const t=dn(e);e=Ii(e);const i={};return e.forEach(s=>{const a=this._bundles[s];if(a){const r=this.resolve(a),n={};for(const l in r){const h=r[l];n[this._extractAssetIdFromBundle(s,l)]=h}i[s]=n}}),t?i[e[0]]:i}resolveUrl(e){const t=this.resolve(e);if(typeof e!="string"){const i={};for(const s in t)i[s]=t[s].src;return i}return t.src}resolve(e){const t=dn(e);e=Ii(e);const i={};return e.forEach(s=>{if(!this._resolverHash[s])if(this._assetMap[s]){let a=this._assetMap[s];const r=this._getPreferredOrder(a);r?.priority.forEach(n=>{r.params[n].forEach(l=>{const h=a.filter(c=>c[n]?c[n]===l:!1);h.length&&(a=h)})}),this._resolverHash[s]=a[0]}else this._resolverHash[s]=this._buildResolvedAsset({alias:[s],src:s},{});i[s]=this._resolverHash[s]}),t?i[e[0]]:i}hasKey(e){return!!this._assetMap[e]}hasBundle(e){return!!this._bundles[e]}_getPreferredOrder(e){for(let t=0;t<e.length;t++){const i=e[t],s=this._preferredOrder.find(a=>a.params.format.includes(i.format));if(s)return s}return this._preferredOrder[0]}_appendDefaultSearchParams(e){if(!this._defaultSearchParams)return e;const t=/\?/.test(e)?"&":"?";return`${e}${t}${this._defaultSearchParams}`}_buildResolvedAsset(e,t){const{aliases:i,data:s,loadParser:a,parser:r,format:n,progressSize:l}=t;return(this._basePath||this._rootPath)&&(e.src=ws.toAbsolute(e.src,this._basePath,this._rootPath)),e.alias=i??e.alias??[e.src],e.src=this._appendDefaultSearchParams(e.src),e.data={...s||{},...e.data},e.loadParser=a??e.loadParser,e.parser=r??e.parser,e.format=n??e.format??bu(e.src),l!==void 0&&(e.progressSize=l),e}}Hh.RETINA_PREFIX=/@([0-9\.]+)x/;function bu(o){return o.split(".").pop().split("?").shift().split("#").shift()}const un=(o,e)=>{const t=e.split("?")[1];return t&&(o+=`?${t}`),o},zh=class is{constructor(e,t){this.linkedSheets=[];let i=e;e?.source instanceof Rt&&(i={texture:e,data:t});const{texture:s,data:a,cachePrefix:r=""}=i;this.cachePrefix=r,this._texture=s instanceof Z?s:null,this.textureSource=s.source,this.textures={},this.animations={},this.data=a;const n=parseFloat(a.meta.scale);n?(this.resolution=n,s.source.resolution=this.resolution):this.resolution=s.source._resolution,this._frames=this.data.frames,this._frameKeys=Object.keys(this._frames),this._batchIndex=0,this._callback=null}parse(){return new Promise(e=>{this._callback=e,this._batchIndex=0,this._frameKeys.length<=is.BATCH_SIZE?(this._processFrames(0),this._processAnimations(),this._parseComplete()):this._nextBatch()})}parseSync(){return this._processFrames(0,!0),this._processAnimations(),this.textures}_processFrames(e,t=!1){let i=e;const s=t?1/0:is.BATCH_SIZE;for(;i-e<s&&i<this._frameKeys.length;){const a=this._frameKeys[i],r=this._frames[a],n=r.frame;if(n){let l=null,h=null;const c=r.trimmed!==!1&&r.sourceSize?r.sourceSize:r.frame,d=new $e(0,0,Math.floor(c.w)/this.resolution,Math.floor(c.h)/this.resolution);r.rotated?l=new $e(Math.floor(n.x)/this.resolution,Math.floor(n.y)/this.resolution,Math.floor(n.h)/this.resolution,Math.floor(n.w)/this.resolution):l=new $e(Math.floor(n.x)/this.resolution,Math.floor(n.y)/this.resolution,Math.floor(n.w)/this.resolution,Math.floor(n.h)/this.resolution),r.trimmed!==!1&&r.spriteSourceSize&&(h=new $e(Math.floor(r.spriteSourceSize.x)/this.resolution,Math.floor(r.spriteSourceSize.y)/this.resolution,Math.floor(n.w)/this.resolution,Math.floor(n.h)/this.resolution)),this.textures[a]=new Z({source:this.textureSource,frame:l,orig:d,trim:h,rotate:r.rotated?2:0,defaultAnchor:r.anchor,defaultBorders:r.borders,label:a.toString()})}i++}}_processAnimations(){const e=this.data.animations||{};for(const t in e){this.animations[t]=[];for(let i=0;i<e[t].length;i++){const s=e[t][i];this.animations[t].push(this.textures[s])}}}_parseComplete(){const e=this._callback;this._callback=null,this._batchIndex=0,e.call(this,this.textures)}_nextBatch(){this._processFrames(this._batchIndex*is.BATCH_SIZE),this._batchIndex++,setTimeout(()=>{this._batchIndex*is.BATCH_SIZE<this._frameKeys.length?this._nextBatch():(this._processAnimations(),this._parseComplete())},0)}destroy(e=!1){for(const t in this.textures)this.textures[t].destroy();this._frames=null,this._frameKeys=null,this.data=null,this.textures=null,e&&(this._texture?.destroy(),this.textureSource.destroy()),this._texture=null,this.textureSource=null,this.linkedSheets=[]}};zh.BATCH_SIZE=1e3;let fn=zh;const wu=["jpg","png","jpeg","avif","webp","basis","etc2","bc7","bc6h","bc5","bc4","bc3","bc2","bc1","eac","astc"];function Xh(o,e,t){const i={};if(o.forEach(s=>{i[s]=e}),Object.keys(e.textures).forEach(s=>{i[`${e.cachePrefix}${s}`]=e.textures[s]}),!t){const s=ws.dirname(o[0]);e.linkedSheets.forEach((a,r)=>{const n=Xh([`${s}/${e.data.meta.related_multi_packs[r]}`],a,!0);Object.assign(i,n)})}return i}const vu={extension:ge.Asset,cache:{test:o=>o instanceof fn,getCacheableAssets:(o,e)=>Xh(o,e,!1)},resolver:{extension:{type:ge.ResolveParser,name:"resolveSpritesheet"},test:o=>{const t=o.split("?")[0].split("."),i=t.pop(),s=t.pop();return i==="json"&&wu.includes(s)},parse:o=>{const e=o.split(".");return{resolution:parseFloat(Hh.RETINA_PREFIX.exec(o)?.[1]??"1"),format:e[e.length-2],src:o}}},loader:{name:"spritesheetLoader",id:"spritesheet",extension:{type:ge.LoadParser,priority:Oh.Normal,name:"spritesheetLoader"},async testParse(o,e){return ws.extname(e.src).toLowerCase()===".json"&&!!o.frames},async parse(o,e,t){const{texture:i,imageFilename:s,textureOptions:a,cachePrefix:r}=e?.data??{};let n=ws.dirname(e.src);n&&n.lastIndexOf("/")!==n.length-1&&(n+="/");let l;if(i instanceof Z)l=i;else{const d=un(n+(s??o.meta.image),e.src);l=(await t.load([{src:d,data:a}]))[d]}const h=new fn({texture:l.source,data:o,cachePrefix:r});await h.parse();const c=o?.meta?.related_multi_packs;if(Array.isArray(c)){const d=[];for(const f of c){if(typeof f!="string")continue;let m=n+f;e.data?.ignoreMultiPack||(m=un(m,e.src),d.push(t.load({src:m,data:{textureOptions:a,ignoreMultiPack:!0}})))}const u=await Promise.all(d);h.linkedSheets=u,u.forEach(f=>{f.linkedSheets=[h].concat(h.linkedSheets.filter(m=>m!==f))})}return h},async unload(o,e,t){await t.unload(o.textureSource._sourceOrigin),o.destroy(!1)}}};Ze.add(vu);const er=Object.create(null),mn=Object.create(null);function bo(o,e){let t=mn[o];return t===void 0&&(er[e]===void 0&&(er[e]=1),mn[o]=t=er[e]++),t}let $s;function Vh(){return(!$s||$s?.isContextLost())&&($s=Kt.get().createCanvas().getContext("webgl",{})),$s}let Ls;function Su(){if(!Ls){Ls="mediump";const o=Vh();o&&o.getShaderPrecisionFormat&&(Ls=o.getShaderPrecisionFormat(o.FRAGMENT_SHADER,o.HIGH_FLOAT).precision?"highp":"mediump")}return Ls}function ku(o,e,t){return e?o:t?(o=o.replace("out vec4 finalColor;",""),`

        #ifdef GL_ES // This checks if it is WebGL1
        #define in varying
        #define finalColor gl_FragColor
        #define texture texture2D
        #endif
        ${o}
        `):`

        #ifdef GL_ES // This checks if it is WebGL1
        #define in attribute
        #define out varying
        #endif
        ${o}
        `}function Tu(o,e,t){const i=t?e.maxSupportedFragmentPrecision:e.maxSupportedVertexPrecision;if(o.substring(0,9)!=="precision"){let s=t?e.requestedFragmentPrecision:e.requestedVertexPrecision;return s==="highp"&&i!=="highp"&&(s="mediump"),`precision ${s} float;
${o}`}else if(i!=="highp"&&o.substring(0,15)==="precision highp")return o.replace("precision highp","precision mediump");return o}function Mu(o,e){return e?`#version 300 es
${o}`:o}const Cu={},Pu={};function Iu(o,{name:e="pixi-program"},t=!0){e=e.replace(/\s+/g,"-"),e+=t?"-fragment":"-vertex";const i=t?Cu:Pu;return i[e]?(i[e]++,e+=`-${i[e]}`):i[e]=1,o.indexOf("#define SHADER_NAME")!==-1?o:`${`#define SHADER_NAME ${e}`}
${o}`}function Au(o,e){return e?o.replace("#version 300 es",""):o}const tr={stripVersion:Au,ensurePrecision:Tu,addProgramDefines:ku,setProgramName:Iu,insertVersion:Mu},Oi=Object.create(null),qh=class Xr{constructor(e){e={...Xr.defaultOptions,...e};const t=e.fragment.indexOf("#version 300 es")!==-1,i={stripVersion:t,ensurePrecision:{requestedFragmentPrecision:e.preferredFragmentPrecision,requestedVertexPrecision:e.preferredVertexPrecision,maxSupportedVertexPrecision:"highp",maxSupportedFragmentPrecision:Su()},setProgramName:{name:e.name},addProgramDefines:t,insertVersion:t};let s=e.fragment,a=e.vertex;Object.keys(tr).forEach(r=>{const n=i[r];s=tr[r](s,n,!0),a=tr[r](a,n,!1)}),this.fragment=s,this.vertex=a,this.transformFeedbackVaryings=e.transformFeedbackVaryings,this._key=bo(`${this.vertex}:${this.fragment}`,"gl-program")}destroy(){this.fragment=null,this.vertex=null,this._attributeData=null,this._uniformData=null,this._uniformBlockData=null,this.transformFeedbackVaryings=null,Oi[this._cacheKey]=null}static from(e){const t=`${e.vertex}:${e.fragment}`;return Oi[t]||(Oi[t]=new Xr(e),Oi[t]._cacheKey=t),Oi[t]}};qh.defaultOptions={preferredVertexPrecision:"highp",preferredFragmentPrecision:"mediump"};let Yh=qh;const pn={uint8x2:{size:2,stride:2,normalised:!1},uint8x4:{size:4,stride:4,normalised:!1},sint8x2:{size:2,stride:2,normalised:!1},sint8x4:{size:4,stride:4,normalised:!1},unorm8x2:{size:2,stride:2,normalised:!0},unorm8x4:{size:4,stride:4,normalised:!0},snorm8x2:{size:2,stride:2,normalised:!0},snorm8x4:{size:4,stride:4,normalised:!0},uint16x2:{size:2,stride:4,normalised:!1},uint16x4:{size:4,stride:8,normalised:!1},sint16x2:{size:2,stride:4,normalised:!1},sint16x4:{size:4,stride:8,normalised:!1},unorm16x2:{size:2,stride:4,normalised:!0},unorm16x4:{size:4,stride:8,normalised:!0},snorm16x2:{size:2,stride:4,normalised:!0},snorm16x4:{size:4,stride:8,normalised:!0},float16x2:{size:2,stride:4,normalised:!1},float16x4:{size:4,stride:8,normalised:!1},float32:{size:1,stride:4,normalised:!1},float32x2:{size:2,stride:8,normalised:!1},float32x3:{size:3,stride:12,normalised:!1},float32x4:{size:4,stride:16,normalised:!1},uint32:{size:1,stride:4,normalised:!1},uint32x2:{size:2,stride:8,normalised:!1},uint32x3:{size:3,stride:12,normalised:!1},uint32x4:{size:4,stride:16,normalised:!1},sint32:{size:1,stride:4,normalised:!1},sint32x2:{size:2,stride:8,normalised:!1},sint32x3:{size:3,stride:12,normalised:!1},sint32x4:{size:4,stride:16,normalised:!1}};function Ru(o){return pn[o]??pn.float32}const xu={f32:"float32","vec2<f32>":"float32x2","vec3<f32>":"float32x3","vec4<f32>":"float32x4",vec2f:"float32x2",vec3f:"float32x3",vec4f:"float32x4",i32:"sint32","vec2<i32>":"sint32x2","vec3<i32>":"sint32x3","vec4<i32>":"sint32x4",vec2i:"sint32x2",vec3i:"sint32x3",vec4i:"sint32x4",u32:"uint32","vec2<u32>":"uint32x2","vec3<u32>":"uint32x3","vec4<u32>":"uint32x4",vec2u:"uint32x2",vec3u:"uint32x3",vec4u:"uint32x4",bool:"uint32","vec2<bool>":"uint32x2","vec3<bool>":"uint32x3","vec4<bool>":"uint32x4"},_n=/@location\((\d+)\)\s+([a-zA-Z0-9_]+)\s*:\s*([a-zA-Z0-9_<>]+)(?:,|\s|\)|$)/g;function gn(o,e){let t;for(;(t=_n.exec(o))!==null;){const i=xu[t[3]]??"float32";e[t[2]]={location:parseInt(t[1],10),format:i,stride:Ru(i).stride,offset:0,instance:!1,start:0}}_n.lastIndex=0}function Eu(o){return o.replace(/\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\//g,"")}function Du({source:o,entryPoint:e}){const t={},i=Eu(o),s=i.indexOf(`fn ${e}(`);if(s===-1)return t;const a=i.indexOf("->",s);if(a===-1)return t;const r=i.substring(s,a);if(gn(r,t),Object.keys(t).length===0){const n=r.match(/\(\s*\w+\s*:\s*(\w+)/);if(n){const l=n[1],h=new RegExp(`struct\\s+${l}\\s*\\{([^}]+)\\}`,"s"),c=i.match(h);c&&gn(c[1],t)}}return t}function ir(o){const e=/(^|[^/])@(group|binding)\(\d+\)[^;]+;/g,t=/@group\((\d+)\)/,i=/@binding\((\d+)\)/,s=/var(<[^>]+>)? (\w+)/,a=/:\s*([\w<>]+)/,r=/struct\s+(\w+)\s*{([^}]+)}/g,n=/(\w+)\s*:\s*([\w\<\>]+)/g,l=/struct\s+(\w+)/,h=o.match(e)?.map(d=>({group:parseInt(d.match(t)[1],10),binding:parseInt(d.match(i)[1],10),name:d.match(s)[2],isUniform:d.match(s)[1]==="<uniform>",type:d.match(a)[1]}));if(!h)return{groups:[],structs:[]};const c=o.match(r)?.map(d=>{const u=d.match(l)[1],f=d.match(n).reduce((m,_)=>{const[p,g]=_.split(":");return m[p.trim()]=g.trim(),m},{});return f?{name:u,members:f}:null}).filter(({name:d})=>h.some(u=>u.type===d||u.type.includes(`<${d}>`)))??[];return{groups:h,structs:c}}var ci=(o=>(o[o.VERTEX=1]="VERTEX",o[o.FRAGMENT=2]="FRAGMENT",o[o.COMPUTE=4]="COMPUTE",o))(ci||{});function Fu({groups:o}){const e=[];for(let t=0;t<o.length;t++){const i=o[t];e[i.group]||(e[i.group]=[]),i.isUniform?e[i.group].push({binding:i.binding,visibility:ci.VERTEX|ci.FRAGMENT,buffer:{type:"uniform"}}):i.type==="sampler"?e[i.group].push({binding:i.binding,visibility:ci.FRAGMENT,sampler:{type:"filtering"}}):i.type==="texture_2d"||i.type.startsWith("texture_2d<")?e[i.group].push({binding:i.binding,visibility:ci.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}}):i.type==="texture_2d_array"||i.type.startsWith("texture_2d_array<")?e[i.group].push({binding:i.binding,visibility:ci.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d-array",multisampled:!1}}):(i.type==="texture_cube"||i.type.startsWith("texture_cube<"))&&e[i.group].push({binding:i.binding,visibility:ci.FRAGMENT,texture:{sampleType:"float",viewDimension:"cube",multisampled:!1}})}for(let t=0;t<e.length;t++)e[t]||(e[t]=[]);return e}function $u({groups:o}){const e=[];for(let t=0;t<o.length;t++){const i=o[t];e[i.group]||(e[i.group]={}),e[i.group][i.name]=i.binding}return e}function Lu(o,e){const t=new Set,i=new Set,s=[...o.structs,...e.structs].filter(r=>t.has(r.name)?!1:(t.add(r.name),!0)),a=[...o.groups,...e.groups].filter(r=>{const n=`${r.name}-${r.binding}`;return i.has(n)?!1:(i.add(n),!0)});return{structs:s,groups:a}}const Gi=Object.create(null);class $a{constructor(e){this._layoutKey=0,this._attributeLocationsKey=0;const{fragment:t,vertex:i,layout:s,gpuLayout:a,name:r}=e;if(this.name=r,this.fragment=t,this.vertex=i,t.source===i.source){const n=ir(t.source);this.structsAndGroups=n}else{const n=ir(i.source),l=ir(t.source);this.structsAndGroups=Lu(n,l)}this.layout=s??$u(this.structsAndGroups),this.gpuLayout=a??Fu(this.structsAndGroups),this.autoAssignGlobalUniforms=this.layout[0]?.globalUniforms!==void 0,this.autoAssignLocalUniforms=this.layout[1]?.localUniforms!==void 0,this._generateProgramKey()}_generateProgramKey(){const{vertex:e,fragment:t}=this,i=e.source+t.source+e.entryPoint+t.entryPoint;this._layoutKey=bo(i,"program")}get attributeData(){return this._attributeData??(this._attributeData=Du(this.vertex)),this._attributeData}destroy(){this.gpuLayout=null,this.layout=null,this.structsAndGroups=null,this.fragment=null,this.vertex=null,Gi[this._cacheKey]=null}static from(e){const t=`${e.vertex.source}:${e.fragment.source}:${e.fragment.entryPoint}:${e.vertex.entryPoint}`;return Gi[t]||(Gi[t]=new $a(e),Gi[t]._cacheKey=t),Gi[t]}}const Uh=["f32","i32","vec2<f32>","vec3<f32>","vec4<f32>","mat2x2<f32>","mat3x3<f32>","mat4x4<f32>","mat3x2<f32>","mat4x2<f32>","mat2x3<f32>","mat4x3<f32>","mat2x4<f32>","mat3x4<f32>","vec2<i32>","vec3<i32>","vec4<i32>"],Bu=Uh.reduce((o,e)=>(o[e]=!0,o),{});function Wu(o,e){switch(o){case"f32":return 0;case"vec2<f32>":return new Float32Array(2*e);case"vec3<f32>":return new Float32Array(3*e);case"vec4<f32>":return new Float32Array(4*e);case"mat2x2<f32>":return new Float32Array([1,0,0,1]);case"mat3x3<f32>":return new Float32Array([1,0,0,0,1,0,0,0,1]);case"mat4x4<f32>":return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return null}const jh=class Kh{constructor(e,t){this._touched=0,this.uid=He("uniform"),this._resourceType="uniformGroup",this._resourceId=He("resource"),this.isUniformGroup=!0,this._dirtyId=0,this.destroyed=!1,t={...Kh.defaultOptions,...t},this.uniformStructures=e;const i={};for(const s in e){const a=e[s];if(a.name=s,a.size=a.size??1,!Bu[a.type]){const r=a.type.match(/^array<(\w+(?:<\w+>)?),\s*(\d+)>$/);if(r){const[,n,l]=r;throw new Error(`Uniform type ${a.type} is not supported. Use type: '${n}', size: ${l} instead.`)}throw new Error(`Uniform type ${a.type} is not supported. Supported uniform types are: ${Uh.join(", ")}`)}a.value??(a.value=Wu(a.type,a.size)),i[s]=a.value}this.uniforms=i,this._dirtyId=1,this.ubo=t.ubo,this.isStatic=t.isStatic,this._signature=bo(Object.keys(i).map(s=>`${s}-${e[s].type}`).join("-"),"uniform-group")}update(){this._dirtyId++}};jh.defaultOptions={ubo:!1,isStatic:!1};let Qh=jh;class pa{constructor(e){this.resources=Object.create(null),this._dirty=!0;let t=0;for(const i in e){const s=e[i];this.setResource(s,t++)}this._updateKey()}_updateKey(){if(!this._dirty)return;this._dirty=!1;const e=[];let t=0;for(const i in this.resources)e[t++]=this.resources[i]._resourceId;this._key=e.join("|")}setResource(e,t){const i=this.resources[t];e!==i&&(i&&e.off?.("change",this.onResourceChange,this),e.on?.("change",this.onResourceChange,this),this.resources[t]=e,this._dirty=!0)}getResource(e){return this.resources[e]}_touch(e,t){const i=this.resources;for(const s in i)i[s]._gcLastUsed=e,i[s]._touched=t}destroy(){const e=this.resources;for(const t in e)e[t]?.off?.("change",this.onResourceChange,this);this.resources=null}onResourceChange(e){if(this._dirty=!0,e.destroyed){const t=this.resources;for(const i in t)t[i]===e&&(t[i]=null)}else this._updateKey()}}var Vr=(o=>(o[o.WEBGL=1]="WEBGL",o[o.WEBGPU=2]="WEBGPU",o[o.CANVAS=4]="CANVAS",o[o.BOTH=3]="BOTH",o))(Vr||{});class wo extends Xt{constructor(e){super(),this.uid=He("shader"),this._uniformBindMap=Object.create(null),this._ownedBindGroups=[],this._destroyed=!1;let{gpuProgram:t,glProgram:i,groups:s,resources:a,compatibleRenderers:r,groupMap:n}=e;this.gpuProgram=t,this.glProgram=i,r===void 0&&(r=0,t&&(r|=Vr.WEBGPU),i&&(r|=Vr.WEBGL)),this.compatibleRenderers=r;const l={};if(!a&&!s&&(a={}),a&&s)throw new Error("[Shader] Cannot have both resources and groups");if(!t&&s&&!n)throw new Error("[Shader] No group map or WebGPU shader provided - consider using resources instead.");if(!t&&s&&n)for(const h in n)for(const c in n[h]){const d=n[h][c];l[d]={group:h,binding:c,name:d}}else if(t&&s&&!n){const h=t.structsAndGroups.groups;n={},h.forEach(c=>{n[c.group]=n[c.group]||{},n[c.group][c.binding]=c.name,l[c.name]=c})}else if(a){s={},n={},t&&t.structsAndGroups.groups.forEach(d=>{n[d.group]=n[d.group]||{},n[d.group][d.binding]=d.name,l[d.name]=d});let h=0;for(const c in a)l[c]||(s[99]||(s[99]=new pa,this._ownedBindGroups.push(s[99])),l[c]={group:99,binding:h,name:c},n[99]=n[99]||{},n[99][h]=c,h++);for(const c in a){const d=c;let u=a[c];!u.source&&!u._resourceType&&(u=new Qh(u));const f=l[d];f&&(s[f.group]||(s[f.group]=new pa,this._ownedBindGroups.push(s[f.group])),s[f.group].setResource(u,f.binding))}}this.groups=s,this._uniformBindMap=n,this.resources=this._buildResourceAccessor(s,l)}addResource(e,t,i){var s,a;(s=this._uniformBindMap)[t]||(s[t]={}),(a=this._uniformBindMap[t])[i]||(a[i]=e),this.groups[t]||(this.groups[t]=new pa,this._ownedBindGroups.push(this.groups[t]))}_buildResourceAccessor(e,t){const i={};for(const s in t){const a=t[s];Object.defineProperty(i,a.name,{get(){return e[a.group].getResource(a.binding)},set(r){e[a.group].setResource(r,a.binding)}})}return i}destroy(e=!1){this._destroyed||(this._destroyed=!0,this.emit("destroy",this),e&&(this.gpuProgram?.destroy(),this.glProgram?.destroy()),this.gpuProgram=null,this.glProgram=null,this.removeAllListeners(),this._uniformBindMap=null,this._ownedBindGroups.forEach(t=>{t.destroy()}),this._ownedBindGroups=null,this.resources=null,this.groups=null)}static from(e){const{gpu:t,gl:i,...s}=e;let a,r;return t&&(a=$a.from(t)),i&&(r=Yh.from(i)),new wo({gpuProgram:a,glProgram:r,...s})}}const Nu={normal:0,add:1,multiply:2,screen:3,overlay:4,erase:5,"normal-npm":6,"add-npm":7,"screen-npm":8,min:9,max:10},sr=0,ar=1,rr=2,or=3,nr=4,lr=5,qr=class Zh{constructor(){this.data=0,this.blendMode="normal",this.polygonOffset=0,this.blend=!0,this.depthMask=!0}get blend(){return!!(this.data&1<<sr)}set blend(e){!!(this.data&1<<sr)!==e&&(this.data^=1<<sr)}get offsets(){return!!(this.data&1<<ar)}set offsets(e){!!(this.data&1<<ar)!==e&&(this.data^=1<<ar)}set cullMode(e){if(e==="none"){this.culling=!1;return}this.culling=!0,this.clockwiseFrontFace=e==="front"}get cullMode(){return this.culling?this.clockwiseFrontFace?"front":"back":"none"}get culling(){return!!(this.data&1<<rr)}set culling(e){!!(this.data&1<<rr)!==e&&(this.data^=1<<rr)}get depthTest(){return!!(this.data&1<<or)}set depthTest(e){!!(this.data&1<<or)!==e&&(this.data^=1<<or)}get depthMask(){return!!(this.data&1<<lr)}set depthMask(e){!!(this.data&1<<lr)!==e&&(this.data^=1<<lr)}get clockwiseFrontFace(){return!!(this.data&1<<nr)}set clockwiseFrontFace(e){!!(this.data&1<<nr)!==e&&(this.data^=1<<nr)}get blendMode(){return this._blendMode}set blendMode(e){this.blend=e!=="none",this._blendMode=e,this._blendModeId=Nu[e]||0}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){this.offsets=!!e,this._polygonOffset=e}toString(){return`[pixi.js/core:State blendMode=${this.blendMode} clockwiseFrontFace=${this.clockwiseFrontFace} culling=${this.culling} depthMask=${this.depthMask} polygonOffset=${this.polygonOffset}]`}static for2d(){const e=new Zh;return e.depthTest=!1,e.blend=!0,e}};qr.default2d=qr.for2d();let Jh=qr;const Yr=[];Ze.handleByNamedList(ge.Environment,Yr);async function Ou(o){if(!o)for(let e=0;e<Yr.length;e++){const t=Yr[e];if(t.value.test()){await t.value.load();return}}}let Hi;function Gu(){if(typeof Hi=="boolean")return Hi;try{Hi=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{Hi=!1}return Hi}function yn(o,e,t=2){const i=e&&e.length,s=i?e[0]*t:o.length;let a=ec(o,0,s,t,!0);const r=[];if(!a||a.next===a.prev)return r;let n,l,h;if(i&&(a=qu(o,e,a,t)),o.length>80*t){n=o[0],l=o[1];let c=n,d=l;for(let u=t;u<s;u+=t){const f=o[u],m=o[u+1];f<n&&(n=f),m<l&&(l=m),f>c&&(c=f),m>d&&(d=m)}h=Math.max(c-n,d-l),h=h!==0?32767/h:0}return vs(a,r,t,n,l,h,0),r}function ec(o,e,t,i,s){let a;if(s===af(o,e,t,i)>0)for(let r=e;r<t;r+=i)a=bn(r/i|0,o[r],o[r+1],a);else for(let r=t-i;r>=e;r-=i)a=bn(r/i|0,o[r],o[r+1],a);return a&&Bi(a,a.next)&&(ks(a),a=a.next),a}function gi(o,e){if(!o)return o;e||(e=o);let t=o,i;do if(i=!1,!t.steiner&&(Bi(t,t.next)||Fe(t.prev,t,t.next)===0)){if(ks(t),t=e=t.prev,t===t.next)break;i=!0}else t=t.next;while(i||t!==e);return e}function vs(o,e,t,i,s,a,r){if(!o)return;!r&&a&&Qu(o,i,s,a);let n=o;for(;o.prev!==o.next;){const l=o.prev,h=o.next;if(a?zu(o,i,s,a):Hu(o)){e.push(l.i,o.i,h.i),ks(o),o=h.next,n=h.next;continue}if(o=h,o===n){r?r===1?(o=Xu(gi(o),e),vs(o,e,t,i,s,a,2)):r===2&&Vu(o,e,t,i,s,a):vs(gi(o),e,t,i,s,a,1);break}}}function Hu(o){const e=o.prev,t=o,i=o.next;if(Fe(e,t,i)>=0)return!1;const s=e.x,a=t.x,r=i.x,n=e.y,l=t.y,h=i.y,c=Math.min(s,a,r),d=Math.min(n,l,h),u=Math.max(s,a,r),f=Math.max(n,l,h);let m=i.next;for(;m!==e;){if(m.x>=c&&m.x<=u&&m.y>=d&&m.y<=f&&ss(s,n,a,l,r,h,m.x,m.y)&&Fe(m.prev,m,m.next)>=0)return!1;m=m.next}return!0}function zu(o,e,t,i){const s=o.prev,a=o,r=o.next;if(Fe(s,a,r)>=0)return!1;const n=s.x,l=a.x,h=r.x,c=s.y,d=a.y,u=r.y,f=Math.min(n,l,h),m=Math.min(c,d,u),_=Math.max(n,l,h),p=Math.max(c,d,u),g=Ur(f,m,e,t,i),y=Ur(_,p,e,t,i);let S=o.prevZ,b=o.nextZ;for(;S&&S.z>=g&&b&&b.z<=y;){if(S.x>=f&&S.x<=_&&S.y>=m&&S.y<=p&&S!==s&&S!==r&&ss(n,c,l,d,h,u,S.x,S.y)&&Fe(S.prev,S,S.next)>=0||(S=S.prevZ,b.x>=f&&b.x<=_&&b.y>=m&&b.y<=p&&b!==s&&b!==r&&ss(n,c,l,d,h,u,b.x,b.y)&&Fe(b.prev,b,b.next)>=0))return!1;b=b.nextZ}for(;S&&S.z>=g;){if(S.x>=f&&S.x<=_&&S.y>=m&&S.y<=p&&S!==s&&S!==r&&ss(n,c,l,d,h,u,S.x,S.y)&&Fe(S.prev,S,S.next)>=0)return!1;S=S.prevZ}for(;b&&b.z<=y;){if(b.x>=f&&b.x<=_&&b.y>=m&&b.y<=p&&b!==s&&b!==r&&ss(n,c,l,d,h,u,b.x,b.y)&&Fe(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function Xu(o,e){let t=o;do{const i=t.prev,s=t.next.next;!Bi(i,s)&&ic(i,t,t.next,s)&&Ss(i,s)&&Ss(s,i)&&(e.push(i.i,t.i,s.i),ks(t),ks(t.next),t=o=s),t=t.next}while(t!==o);return gi(t)}function Vu(o,e,t,i,s,a){let r=o;do{let n=r.next.next;for(;n!==r.prev;){if(r.i!==n.i&&ef(r,n)){let l=sc(r,n);r=gi(r,r.next),l=gi(l,l.next),vs(r,e,t,i,s,a,0),vs(l,e,t,i,s,a,0);return}n=n.next}r=r.next}while(r!==o)}function qu(o,e,t,i){const s=[];for(let a=0,r=e.length;a<r;a++){const n=e[a]*i,l=a<r-1?e[a+1]*i:o.length,h=ec(o,n,l,i,!1);h===h.next&&(h.steiner=!0),s.push(Ju(h))}s.sort(Yu);for(let a=0;a<s.length;a++)t=Uu(s[a],t);return t}function Yu(o,e){let t=o.x-e.x;if(t===0&&(t=o.y-e.y,t===0)){const i=(o.next.y-o.y)/(o.next.x-o.x),s=(e.next.y-e.y)/(e.next.x-e.x);t=i-s}return t}function Uu(o,e){const t=ju(o,e);if(!t)return e;const i=sc(t,o);return gi(i,i.next),gi(t,t.next)}function ju(o,e){let t=e;const i=o.x,s=o.y;let a=-1/0,r;if(Bi(o,t))return t;do{if(Bi(o,t.next))return t.next;if(s<=t.y&&s>=t.next.y&&t.next.y!==t.y){const d=t.x+(s-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(d<=i&&d>a&&(a=d,r=t.x<t.next.x?t:t.next,d===i))return r}t=t.next}while(t!==e);if(!r)return null;const n=r,l=r.x,h=r.y;let c=1/0;t=r;do{if(i>=t.x&&t.x>=l&&i!==t.x&&tc(s<h?i:a,s,l,h,s<h?a:i,s,t.x,t.y)){const d=Math.abs(s-t.y)/(i-t.x);Ss(t,o)&&(d<c||d===c&&(t.x>r.x||t.x===r.x&&Ku(r,t)))&&(r=t,c=d)}t=t.next}while(t!==n);return r}function Ku(o,e){return Fe(o.prev,o,e.prev)<0&&Fe(e.next,o,o.next)<0}function Qu(o,e,t,i){let s=o;do s.z===0&&(s.z=Ur(s.x,s.y,e,t,i)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next;while(s!==o);s.prevZ.nextZ=null,s.prevZ=null,Zu(s)}function Zu(o){let e,t=1;do{let i=o,s;o=null;let a=null;for(e=0;i;){e++;let r=i,n=0;for(let h=0;h<t&&(n++,r=r.nextZ,!!r);h++);let l=t;for(;n>0||l>0&&r;)n!==0&&(l===0||!r||i.z<=r.z)?(s=i,i=i.nextZ,n--):(s=r,r=r.nextZ,l--),a?a.nextZ=s:o=s,s.prevZ=a,a=s;i=r}a.nextZ=null,t*=2}while(e>1);return o}function Ur(o,e,t,i,s){return o=(o-t)*s|0,e=(e-i)*s|0,o=(o|o<<8)&16711935,o=(o|o<<4)&252645135,o=(o|o<<2)&858993459,o=(o|o<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,o|e<<1}function Ju(o){let e=o,t=o;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==o);return t}function tc(o,e,t,i,s,a,r,n){return(s-r)*(e-n)>=(o-r)*(a-n)&&(o-r)*(i-n)>=(t-r)*(e-n)&&(t-r)*(a-n)>=(s-r)*(i-n)}function ss(o,e,t,i,s,a,r,n){return!(o===r&&e===n)&&tc(o,e,t,i,s,a,r,n)}function ef(o,e){return o.next.i!==e.i&&o.prev.i!==e.i&&!tf(o,e)&&(Ss(o,e)&&Ss(e,o)&&sf(o,e)&&(Fe(o.prev,o,e.prev)||Fe(o,e.prev,e))||Bi(o,e)&&Fe(o.prev,o,o.next)>0&&Fe(e.prev,e,e.next)>0)}function Fe(o,e,t){return(e.y-o.y)*(t.x-e.x)-(e.x-o.x)*(t.y-e.y)}function Bi(o,e){return o.x===e.x&&o.y===e.y}function ic(o,e,t,i){const s=Ws(Fe(o,e,t)),a=Ws(Fe(o,e,i)),r=Ws(Fe(t,i,o)),n=Ws(Fe(t,i,e));return!!(s!==a&&r!==n||s===0&&Bs(o,t,e)||a===0&&Bs(o,i,e)||r===0&&Bs(t,o,i)||n===0&&Bs(t,e,i))}function Bs(o,e,t){return e.x<=Math.max(o.x,t.x)&&e.x>=Math.min(o.x,t.x)&&e.y<=Math.max(o.y,t.y)&&e.y>=Math.min(o.y,t.y)}function Ws(o){return o>0?1:o<0?-1:0}function tf(o,e){let t=o;do{if(t.i!==o.i&&t.next.i!==o.i&&t.i!==e.i&&t.next.i!==e.i&&ic(t,t.next,o,e))return!0;t=t.next}while(t!==o);return!1}function Ss(o,e){return Fe(o.prev,o,o.next)<0?Fe(o,e,o.next)>=0&&Fe(o,o.prev,e)>=0:Fe(o,e,o.prev)<0||Fe(o,o.next,e)<0}function sf(o,e){let t=o,i=!1;const s=(o.x+e.x)/2,a=(o.y+e.y)/2;do t.y>a!=t.next.y>a&&t.next.y!==t.y&&s<(t.next.x-t.x)*(a-t.y)/(t.next.y-t.y)+t.x&&(i=!i),t=t.next;while(t!==o);return i}function sc(o,e){const t=jr(o.i,o.x,o.y),i=jr(e.i,e.x,e.y),s=o.next,a=e.prev;return o.next=e,e.prev=o,t.next=s,s.prev=t,i.next=t,t.prev=i,a.next=i,i.prev=a,i}function bn(o,e,t,i){const s=jr(o,e,t);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function ks(o){o.next.prev=o.prev,o.prev.next=o.next,o.prevZ&&(o.prevZ.nextZ=o.nextZ),o.nextZ&&(o.nextZ.prevZ=o.prevZ)}function jr(o,e,t){return{i:o,x:e,y:t,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function af(o,e,t,i){let s=0;for(let a=e,r=t-i;a<t;a+=i)s+=(o[r]-o[a])*(o[a+1]+o[r+1]),r=a;return s}const rf=yn.default||yn;var ac=(o=>(o[o.NONE=0]="NONE",o[o.COLOR=16384]="COLOR",o[o.STENCIL=1024]="STENCIL",o[o.DEPTH=256]="DEPTH",o[o.COLOR_DEPTH=16640]="COLOR_DEPTH",o[o.COLOR_STENCIL=17408]="COLOR_STENCIL",o[o.DEPTH_STENCIL=1280]="DEPTH_STENCIL",o[o.ALL=17664]="ALL",o))(ac||{});class of{constructor(e){this.items=[],this._name=e}emit(e,t,i,s,a,r,n,l){const{name:h,items:c}=this;for(let d=0,u=c.length;d<u;d++)c[d][h](e,t,i,s,a,r,n,l);return this}add(e){return e[this._name]&&(this.remove(e),this.items.push(e)),this}remove(e){const t=this.items.indexOf(e);return t!==-1&&this.items.splice(t,1),this}contains(e){return this.items.indexOf(e)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const nf=["init","destroy","contextChange","resolutionChange","resetState","renderEnd","renderStart","render","update","postrender","prerender"],rc=class oc extends Xt{constructor(e){super(),this.tick=0,this.uid=He("renderer"),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=e.type,this.name=e.name,this.config=e;const t=[...nf,...this.config.runners??[]];this._addRunners(...t),this._unsafeEvalCheck()}async init(e={}){const t=e.skipExtensionImports===!0?!0:e.manageImports===!1;await Ou(t),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const i in this._systemsHash)e={...this._systemsHash[i].constructor.defaultOptions,...e};e={...oc.defaultOptions,...e},this._roundPixels=e.roundPixels?1:0;for(let i=0;i<this.runners.init.items.length;i++)await this.runners.init.items[i].init(e);this._initOptions=e}render(e,t){this.tick++;let i=e;if(i instanceof we&&(i={container:i},t&&(Ie(je,"passing a second argument is deprecated, please use render options instead"),i.target=t.renderTexture)),i.target||(i.target=this.view.renderTarget),i.target===this.view.renderTarget&&(this._lastObjectRendered=i.container,i.clearColor??(i.clearColor=this.background.colorRgba),i.clear??(i.clear=this.background.clearBeforeRender)),i.clearColor){const s=Array.isArray(i.clearColor)&&i.clearColor.length===4;i.clearColor=s?i.clearColor:wt.shared.setValue(i.clearColor).toArray()}i.transform||(i.container.updateLocalTransform(),i.transform=i.container.localTransform),i.container.visible&&(i.container.enableRenderGroup(),this.runners.prerender.emit(i),this.runners.renderStart.emit(i),this.runners.render.emit(i),this.runners.renderEnd.emit(i),this.runners.postrender.emit(i))}resize(e,t,i){const s=this.view.resolution;this.view.resize(e,t,i),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),i!==void 0&&i!==s&&this.runners.resolutionChange.emit(i)}clear(e={}){const t=this;e.target||(e.target=t.renderTarget.renderTarget),e.clearColor||(e.clearColor=this.background.colorRgba),e.clear??(e.clear=ac.ALL);const{clear:i,clearColor:s,target:a,mipLevel:r,layer:n}=e;wt.shared.setValue(s??this.background.colorRgba),t.renderTarget.clear(a,i,wt.shared.toArray(),r??0,n??0)}get resolution(){return this.view.resolution}set resolution(e){this.view.resolution=e,this.runners.resolutionChange.emit(e)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...e){e.forEach(t=>{this.runners[t]=new of(t)})}_addSystems(e){let t;for(t in e){const i=e[t];this._addSystem(i.value,i.name)}}_addSystem(e,t){const i=new e(this);if(this[t])throw new Error(`Whoops! The name "${t}" is already in use`);this[t]=i,this._systemsHash[t]=i;for(const s in this.runners)this.runners[s].add(i);return this}_addPipes(e,t){const i=t.reduce((s,a)=>(s[a.name]=a.value,s),{});e.forEach(s=>{const a=s.value,r=s.name,n=i[r];this.renderPipes[r]=new a(this,n?new n:null),this.runners.destroy.add(this.renderPipes[r])})}destroy(e=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(e),(e===!0||typeof e=="object"&&e.releaseGlobalResources)&&Da.release(),Object.values(this.runners).forEach(t=>{t.destroy()}),this._systemsHash=null,this.renderPipes=null}generateTexture(e){return this.textureGenerator.generateTexture(e)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!Gu())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}resetState(){this.runners.resetState.emit()}};rc.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let nc=rc,Ns;function lf(o){return Ns!==void 0||(Ns=(()=>{const e={stencil:!0,failIfMajorPerformanceCaveat:o??nc.defaultOptions.failIfMajorPerformanceCaveat};try{if(!Kt.get().getWebGLRenderingContext())return!1;let i=Kt.get().createCanvas().getContext("webgl",e);const s=!!i?.getContextAttributes()?.stencil;if(i){const a=i.getExtension("WEBGL_lose_context");a&&a.loseContext()}return i=null,s}catch{return!1}})()),Ns}let Os;async function hf(o={}){return Os!==void 0||(Os=await(async()=>{const e=Kt.get().getNavigator().gpu;if(!e)return!1;try{return await(await e.requestAdapter(o)).requestDevice(),!0}catch{return!1}})()),Os}const wn=["webgl","webgpu","canvas"];async function cf(o){let e=[];o.preference?(e.push(o.preference),wn.forEach(a=>{a!==o.preference&&e.push(a)})):e=wn.slice();let t,i={};for(let a=0;a<e.length;a++){const r=e[a];if(r==="webgpu"&&await hf()){const{WebGPURenderer:n}=await hs(async()=>{const{WebGPURenderer:l}=await import("./WebGPURenderer-DF1R20vx.js");return{WebGPURenderer:l}},__vite__mapDeps([3,4,5,2]));t=n,i={...o,...o.webgpu};break}else if(r==="webgl"&&lf(o.failIfMajorPerformanceCaveat??nc.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:n}=await hs(async()=>{const{WebGLRenderer:l}=await import("./WebGLRenderer-BdPeXdD0.js");return{WebGLRenderer:l}},__vite__mapDeps([6,4,5,2]));t=n,i={...o,...o.webgl};break}else if(r==="canvas"){const{CanvasRenderer:n}=await hs(async()=>{const{CanvasRenderer:l}=await import("./CanvasRenderer-Bw1-_NC3.js");return{CanvasRenderer:l}},__vite__mapDeps([7,5,2]));t=n,i={...o,...o.canvasOptions};break}}if(delete i.webgpu,delete i.webgl,delete i.canvasOptions,!t)throw new Error("No available renderer for the current environment");const s=new t;return await s.init(i),s}const lc="8.16.0";class hc{static init(){globalThis.__PIXI_APP_INIT__?.(this,lc)}static destroy(){}}hc.extension=ge.Application;class df{constructor(e){this._renderer=e}init(){globalThis.__PIXI_RENDERER_INIT__?.(this._renderer,lc)}destroy(){this._renderer=null}}df.extension={type:[ge.WebGLSystem,ge.WebGPUSystem],name:"initHook",priority:-10};class cc{static init(e){Object.defineProperty(this,"resizeTo",{configurable:!0,set(t){globalThis.removeEventListener("resize",this.queueResize),this._resizeTo=t,t&&(globalThis.addEventListener("resize",this.queueResize),this.resize())},get(){return this._resizeTo}}),this.queueResize=()=>{this._resizeTo&&(this._cancelResize(),this._resizeId=requestAnimationFrame(()=>this.resize()))},this._cancelResize=()=>{this._resizeId&&(cancelAnimationFrame(this._resizeId),this._resizeId=null)},this.resize=()=>{if(!this._resizeTo)return;this._cancelResize();let t,i;if(this._resizeTo===globalThis.window)t=globalThis.innerWidth,i=globalThis.innerHeight;else{const{clientWidth:s,clientHeight:a}=this._resizeTo;t=s,i=a}this.renderer.resize(t,i),this.render()},this._resizeId=null,this._resizeTo=null,this.resizeTo=e.resizeTo||null}static destroy(){globalThis.removeEventListener("resize",this.queueResize),this._cancelResize(),this._cancelResize=null,this.queueResize=null,this.resizeTo=null,this.resize=null}}cc.extension=ge.Application;class dc{static init(e){e=Object.assign({autoStart:!0,sharedTicker:!1},e),Object.defineProperty(this,"ticker",{configurable:!0,set(t){this._ticker&&this._ticker.remove(this.render,this),this._ticker=t,t&&t.add(this.render,this,wa.LOW)},get(){return this._ticker}}),this.stop=()=>{this._ticker.stop()},this.start=()=>{this._ticker.start()},this._ticker=null,this.ticker=e.sharedTicker?xi.shared:new xi,e.autoStart&&this.start()}static destroy(){if(this._ticker){const e=this._ticker;this.ticker=null,e.destroy()}}}dc.extension=ge.Application;Ze.add(cc);Ze.add(dc);const uc=class Kr{constructor(...e){this.stage=new we,e[0]!==void 0&&Ie(je,"Application constructor options are deprecated, please use Application.init() instead.")}async init(e){e={...e},this.stage||(this.stage=new we),this.renderer=await cf(e),Kr._plugins.forEach(t=>{t.init.call(this,e)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return Ie(je,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(e=!1,t=!1){const i=Kr._plugins.slice(0);i.reverse(),i.forEach(s=>{s.destroy.call(this)}),this.stage.destroy(t),this.stage=null,this.renderer.destroy(e),this.renderer=null}};uc._plugins=[];let vo=uc;Ze.handleByList(ge.Application,vo._plugins);Ze.add(hc);var hr,vn;function uf(){if(vn)return hr;vn=1,hr=t;var o={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},e=/([astvzqmhlc])([^astvzqmhlc]*)/ig;function t(a){var r=[];return a.replace(e,function(n,l,h){var c=l.toLowerCase();for(h=s(h),c=="m"&&h.length>2&&(r.push([l].concat(h.splice(0,2))),c="l",l=l=="m"?"l":"L");;){if(h.length==o[c])return h.unshift(l),r.push(h);if(h.length<o[c])throw new Error("malformed path data");r.push([l].concat(h.splice(0,o[c])))}}),r}var i=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function s(a){var r=a.match(i);return r?r.map(Number):[]}return hr}var ff=uf();const mf=ch(ff);function pf(o,e){const t=mf(o),i=[];let s=null,a=0,r=0;for(let n=0;n<t.length;n++){const l=t[n],h=l[0],c=l;switch(h){case"M":a=c[1],r=c[2],e.moveTo(a,r);break;case"m":a+=c[1],r+=c[2],e.moveTo(a,r);break;case"H":a=c[1],e.lineTo(a,r);break;case"h":a+=c[1],e.lineTo(a,r);break;case"V":r=c[1],e.lineTo(a,r);break;case"v":r+=c[1],e.lineTo(a,r);break;case"L":a=c[1],r=c[2],e.lineTo(a,r);break;case"l":a+=c[1],r+=c[2],e.lineTo(a,r);break;case"C":a=c[5],r=c[6],e.bezierCurveTo(c[1],c[2],c[3],c[4],a,r);break;case"c":e.bezierCurveTo(a+c[1],r+c[2],a+c[3],r+c[4],a+c[5],r+c[6]),a+=c[5],r+=c[6];break;case"S":a=c[3],r=c[4],e.bezierCurveToShort(c[1],c[2],a,r);break;case"s":e.bezierCurveToShort(a+c[1],r+c[2],a+c[3],r+c[4]),a+=c[3],r+=c[4];break;case"Q":a=c[3],r=c[4],e.quadraticCurveTo(c[1],c[2],a,r);break;case"q":e.quadraticCurveTo(a+c[1],r+c[2],a+c[3],r+c[4]),a+=c[3],r+=c[4];break;case"T":a=c[1],r=c[2],e.quadraticCurveToShort(a,r);break;case"t":a+=c[1],r+=c[2],e.quadraticCurveToShort(a,r);break;case"A":a=c[6],r=c[7],e.arcToSvg(c[1],c[2],c[3],c[4],c[5],a,r);break;case"a":a+=c[6],r+=c[7],e.arcToSvg(c[1],c[2],c[3],c[4],c[5],a,r);break;case"Z":case"z":e.closePath(),i.length>0&&(s=i.pop(),s?(a=s.startX,r=s.startY):(a=0,r=0)),s=null;break;default:pt(`Unknown SVG path command: ${h}`)}h!=="Z"&&h!=="z"&&s===null&&(s={startX:a,startY:r},i.push(s))}return e}class So{constructor(e=0,t=0,i=0){this.type="circle",this.x=e,this.y=t,this.radius=i}clone(){return new So(this.x,this.y,this.radius)}contains(e,t){if(this.radius<=0)return!1;const i=this.radius*this.radius;let s=this.x-e,a=this.y-t;return s*=s,a*=a,s+a<=i}strokeContains(e,t,i,s=.5){if(this.radius===0)return!1;const a=this.x-e,r=this.y-t,n=this.radius,l=(1-s)*i,h=Math.sqrt(a*a+r*r);return h<=n+l&&h>n-(i-l)}getBounds(e){return e||(e=new $e),e.x=this.x-this.radius,e.y=this.y-this.radius,e.width=this.radius*2,e.height=this.radius*2,e}copyFrom(e){return this.x=e.x,this.y=e.y,this.radius=e.radius,this}copyTo(e){return e.copyFrom(this),e}toString(){return`[pixi.js/math:Circle x=${this.x} y=${this.y} radius=${this.radius}]`}}class ko{constructor(e=0,t=0,i=0,s=0){this.type="ellipse",this.x=e,this.y=t,this.halfWidth=i,this.halfHeight=s}clone(){return new ko(this.x,this.y,this.halfWidth,this.halfHeight)}contains(e,t){if(this.halfWidth<=0||this.halfHeight<=0)return!1;let i=(e-this.x)/this.halfWidth,s=(t-this.y)/this.halfHeight;return i*=i,s*=s,i+s<=1}strokeContains(e,t,i,s=.5){const{halfWidth:a,halfHeight:r}=this;if(a<=0||r<=0)return!1;const n=i*(1-s),l=i-n,h=a-l,c=r-l,d=a+n,u=r+n,f=e-this.x,m=t-this.y,_=f*f/(h*h)+m*m/(c*c),p=f*f/(d*d)+m*m/(u*u);return _>1&&p<=1}getBounds(e){return e||(e=new $e),e.x=this.x-this.halfWidth,e.y=this.y-this.halfHeight,e.width=this.halfWidth*2,e.height=this.halfHeight*2,e}copyFrom(e){return this.x=e.x,this.y=e.y,this.halfWidth=e.halfWidth,this.halfHeight=e.halfHeight,this}copyTo(e){return e.copyFrom(this),e}toString(){return`[pixi.js/math:Ellipse x=${this.x} y=${this.y} halfWidth=${this.halfWidth} halfHeight=${this.halfHeight}]`}}function _f(o,e,t,i,s,a){const r=o-t,n=e-i,l=s-t,h=a-i,c=r*l+n*h,d=l*l+h*h;let u=-1;d!==0&&(u=c/d);let f,m;u<0?(f=t,m=i):u>1?(f=s,m=a):(f=t+u*l,m=i+u*h);const _=o-f,p=e-m;return _*_+p*p}let gf,yf;class ds{constructor(...e){this.type="polygon";let t=Array.isArray(e[0])?e[0]:e;if(typeof t[0]!="number"){const i=[];for(let s=0,a=t.length;s<a;s++)i.push(t[s].x,t[s].y);t=i}this.points=t,this.closePath=!0}isClockwise(){let e=0;const t=this.points,i=t.length;for(let s=0;s<i;s+=2){const a=t[s],r=t[s+1],n=t[(s+2)%i],l=t[(s+3)%i];e+=(n-a)*(l+r)}return e<0}containsPolygon(e){const t=this.getBounds(gf),i=e.getBounds(yf);if(!t.containsRect(i))return!1;const s=e.points;for(let a=0;a<s.length;a+=2){const r=s[a],n=s[a+1];if(!this.contains(r,n))return!1}return!0}clone(){const e=this.points.slice(),t=new ds(e);return t.closePath=this.closePath,t}contains(e,t){let i=!1;const s=this.points.length/2;for(let a=0,r=s-1;a<s;r=a++){const n=this.points[a*2],l=this.points[a*2+1],h=this.points[r*2],c=this.points[r*2+1];l>t!=c>t&&e<(h-n)*((t-l)/(c-l))+n&&(i=!i)}return i}strokeContains(e,t,i,s=.5){const a=i*i,r=a*(1-s),n=a-r,{points:l}=this,h=l.length-(this.closePath?0:2);for(let c=0;c<h;c+=2){const d=l[c],u=l[c+1],f=l[(c+2)%l.length],m=l[(c+3)%l.length],_=_f(e,t,d,u,f,m),p=Math.sign((f-d)*(t-u)-(m-u)*(e-d));if(_<=(p<0?n:r))return!0}return!1}getBounds(e){e||(e=new $e);const t=this.points;let i=1/0,s=-1/0,a=1/0,r=-1/0;for(let n=0,l=t.length;n<l;n+=2){const h=t[n],c=t[n+1];i=h<i?h:i,s=h>s?h:s,a=c<a?c:a,r=c>r?c:r}return e.x=i,e.width=s-i,e.y=a,e.height=r-a,e}copyFrom(e){return this.points=e.points.slice(),this.closePath=e.closePath,this}copyTo(e){return e.copyFrom(this),e}toString(){return`[pixi.js/math:PolygoncloseStroke=${this.closePath}points=${this.points.reduce((e,t)=>`${e}, ${t}`,"")}]`}get lastX(){return this.points[this.points.length-2]}get lastY(){return this.points[this.points.length-1]}get x(){return Ie("8.11.0","Polygon.lastX is deprecated, please use Polygon.lastX instead."),this.points[this.points.length-2]}get y(){return Ie("8.11.0","Polygon.y is deprecated, please use Polygon.lastY instead."),this.points[this.points.length-1]}get startX(){return this.points[0]}get startY(){return this.points[1]}}const Gs=(o,e,t,i,s,a,r)=>{const n=o-t,l=e-i,h=Math.sqrt(n*n+l*l);return h>=s-a&&h<=s+r};class To{constructor(e=0,t=0,i=0,s=0,a=20){this.type="roundedRectangle",this.x=e,this.y=t,this.width=i,this.height=s,this.radius=a}getBounds(e){return e||(e=new $e),e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e}clone(){return new To(this.x,this.y,this.width,this.height,this.radius)}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}copyTo(e){return e.copyFrom(this),e}contains(e,t){if(this.width<=0||this.height<=0)return!1;if(e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height){const i=Math.max(0,Math.min(this.radius,Math.min(this.width,this.height)/2));if(t>=this.y+i&&t<=this.y+this.height-i||e>=this.x+i&&e<=this.x+this.width-i)return!0;let s=e-(this.x+i),a=t-(this.y+i);const r=i*i;if(s*s+a*a<=r||(s=e-(this.x+this.width-i),s*s+a*a<=r)||(a=t-(this.y+this.height-i),s*s+a*a<=r)||(s=e-(this.x+i),s*s+a*a<=r))return!0}return!1}strokeContains(e,t,i,s=.5){const{x:a,y:r,width:n,height:l,radius:h}=this,c=i*(1-s),d=i-c,u=a+h,f=r+h,m=n-h*2,_=l-h*2,p=a+n,g=r+l;return(e>=a-c&&e<=a+d||e>=p-d&&e<=p+c)&&t>=f&&t<=f+_||(t>=r-c&&t<=r+d||t>=g-d&&t<=g+c)&&e>=u&&e<=u+m?!0:e<u&&t<f&&Gs(e,t,u,f,h,d,c)||e>p-h&&t<f&&Gs(e,t,p-h,f,h,d,c)||e>p-h&&t>g-h&&Gs(e,t,p-h,g-h,h,d,c)||e<u&&t>g-h&&Gs(e,t,u,g-h,h,d,c)}toString(){return`[pixi.js/math:RoundedRectangle x=${this.x} y=${this.y}width=${this.width} height=${this.height} radius=${this.radius}]`}}const fc={};function bf(o,e,t){let i=2166136261;for(let s=0;s<e;s++)i^=o[s].uid,i=Math.imul(i,16777619),i>>>=0;return fc[i]||wf(o,e,i,t)}function wf(o,e,t,i){const s={};let a=0;for(let n=0;n<i;n++){const l=n<e?o[n]:Z.EMPTY.source;s[a++]=l.source,s[a++]=l.style}const r=new pa(s);return fc[t]=r,r}class Sn{constructor(e){typeof e=="number"?this.rawBinaryData=new ArrayBuffer(e):e instanceof Uint8Array?this.rawBinaryData=e.buffer:this.rawBinaryData=e,this.uint32View=new Uint32Array(this.rawBinaryData),this.float32View=new Float32Array(this.rawBinaryData),this.size=this.rawBinaryData.byteLength}get int8View(){return this._int8View||(this._int8View=new Int8Array(this.rawBinaryData)),this._int8View}get uint8View(){return this._uint8View||(this._uint8View=new Uint8Array(this.rawBinaryData)),this._uint8View}get int16View(){return this._int16View||(this._int16View=new Int16Array(this.rawBinaryData)),this._int16View}get int32View(){return this._int32View||(this._int32View=new Int32Array(this.rawBinaryData)),this._int32View}get float64View(){return this._float64Array||(this._float64Array=new Float64Array(this.rawBinaryData)),this._float64Array}get bigUint64View(){return this._bigUint64Array||(this._bigUint64Array=new BigUint64Array(this.rawBinaryData)),this._bigUint64Array}view(e){return this[`${e}View`]}destroy(){this.rawBinaryData=null,this.uint32View=null,this.float32View=null,this.uint16View=null,this._int8View=null,this._uint8View=null,this._int16View=null,this._int32View=null,this._float64Array=null,this._bigUint64Array=null}static sizeOf(e){switch(e){case"int8":case"uint8":return 1;case"int16":case"uint16":return 2;case"int32":case"uint32":case"float32":return 4;default:throw new Error(`${e} isn't a valid view type`)}}}function kn(o,e,t,i){if(t??(t=0),i??(i=Math.min(o.byteLength-t,e.byteLength)),!(t&7)&&!(i&7)){const s=i/8;new Float64Array(e,0,s).set(new Float64Array(o,t,s))}else if(!(t&3)&&!(i&3)){const s=i/4;new Float32Array(e,0,s).set(new Float32Array(o,t,s))}else new Uint8Array(e).set(new Uint8Array(o,t,i))}const vf={normal:"normal-npm",add:"add-npm",screen:"screen-npm"};var Sf=(o=>(o[o.DISABLED=0]="DISABLED",o[o.RENDERING_MASK_ADD=1]="RENDERING_MASK_ADD",o[o.MASK_ACTIVE=2]="MASK_ACTIVE",o[o.INVERSE_MASK_ACTIVE=3]="INVERSE_MASK_ACTIVE",o[o.RENDERING_MASK_REMOVE=4]="RENDERING_MASK_REMOVE",o[o.NONE=5]="NONE",o))(Sf||{});function Tn(o,e){return e.alphaMode==="no-premultiply-alpha"&&vf[o]||o}const kf=["precision mediump float;","void main(void){","float test = 0.1;","%forloop%","gl_FragColor = vec4(0.0);","}"].join(`
`);function Tf(o){let e="";for(let t=0;t<o;++t)t>0&&(e+=`
else `),t<o-1&&(e+=`if(test == ${t}.0){}`);return e}function Mf(o,e){if(o===0)throw new Error("Invalid value of `0` passed to `checkMaxIfStatementsInShader`");const t=e.createShader(e.FRAGMENT_SHADER);try{for(;;){const i=kf.replace(/%forloop%/gi,Tf(o));if(e.shaderSource(t,i),e.compileShader(t),!e.getShaderParameter(t,e.COMPILE_STATUS))o=o/2|0;else break}}finally{e.deleteShader(t)}return o}let bi=null;function Cf(){if(bi)return bi;const o=Vh();return bi=o.getParameter(o.MAX_TEXTURE_IMAGE_UNITS),bi=Mf(bi,o),o.getExtension("WEBGL_lose_context")?.loseContext(),bi}class Pf{constructor(){this.ids=Object.create(null),this.textures=[],this.count=0}clear(){for(let e=0;e<this.count;e++){const t=this.textures[e];this.textures[e]=null,this.ids[t.uid]=null}this.count=0}}class If{constructor(){this.renderPipeId="batch",this.action="startBatch",this.start=0,this.size=0,this.textures=new Pf,this.blendMode="normal",this.topology="triangle-strip",this.canBundle=!0}destroy(){this.textures=null,this.gpuBindGroup=null,this.bindGroup=null,this.batcher=null,this.elements=null}}const us=[];let va=0;Da.register({clear:()=>{if(us.length>0)for(const o of us)o&&o.destroy();us.length=0,va=0}});function Mn(){return va>0?us[--va]:new If}function Cn(o){o.elements=null,us[va++]=o}let zi=0;const mc=class pc{constructor(e){this.uid=He("batcher"),this.dirty=!0,this.batchIndex=0,this.batches=[],this._elements=[],e={...pc.defaultOptions,...e},e.maxTextures||(Ie("v8.8.0","maxTextures is a required option for Batcher now, please pass it in the options"),e.maxTextures=Cf());const{maxTextures:t,attributesInitialSize:i,indicesInitialSize:s}=e;this.attributeBuffer=new Sn(i*4),this.indexBuffer=new Uint16Array(s),this.maxTextures=t}begin(){this.elementSize=0,this.elementStart=0,this.indexSize=0,this.attributeSize=0;for(let e=0;e<this.batchIndex;e++)Cn(this.batches[e]);this.batchIndex=0,this._batchIndexStart=0,this._batchIndexSize=0,this.dirty=!0}add(e){this._elements[this.elementSize++]=e,e._indexStart=this.indexSize,e._attributeStart=this.attributeSize,e._batcher=this,this.indexSize+=e.indexSize,this.attributeSize+=e.attributeSize*this.vertexSize}checkAndUpdateTexture(e,t){const i=e._batch.textures.ids[t._source.uid];return!i&&i!==0?!1:(e._textureId=i,e.texture=t,!0)}updateElement(e){this.dirty=!0;const t=this.attributeBuffer;e.packAsQuad?this.packQuadAttributes(e,t.float32View,t.uint32View,e._attributeStart,e._textureId):this.packAttributes(e,t.float32View,t.uint32View,e._attributeStart,e._textureId)}break(e){const t=this._elements;if(!t[this.elementStart])return;let i=Mn(),s=i.textures;s.clear();const a=t[this.elementStart];let r=Tn(a.blendMode,a.texture._source),n=a.topology;this.attributeSize*4>this.attributeBuffer.size&&this._resizeAttributeBuffer(this.attributeSize*4),this.indexSize>this.indexBuffer.length&&this._resizeIndexBuffer(this.indexSize);const l=this.attributeBuffer.float32View,h=this.attributeBuffer.uint32View,c=this.indexBuffer;let d=this._batchIndexSize,u=this._batchIndexStart,f="startBatch",m=[];const _=this.maxTextures;for(let p=this.elementStart;p<this.elementSize;++p){const g=t[p];t[p]=null;const S=g.texture._source,b=Tn(g.blendMode,S),w=r!==b||n!==g.topology;if(S._batchTick===zi&&!w){g._textureId=S._textureBindLocation,d+=g.indexSize,g.packAsQuad?(this.packQuadAttributes(g,l,h,g._attributeStart,g._textureId),this.packQuadIndex(c,g._indexStart,g._attributeStart/this.vertexSize)):(this.packAttributes(g,l,h,g._attributeStart,g._textureId),this.packIndex(g,c,g._indexStart,g._attributeStart/this.vertexSize)),g._batch=i,m.push(g);continue}S._batchTick=zi,(s.count>=_||w)&&(this._finishBatch(i,u,d-u,s,r,n,e,f,m),f="renderBatch",u=d,r=b,n=g.topology,i=Mn(),s=i.textures,s.clear(),m=[],++zi),g._textureId=S._textureBindLocation=s.count,s.ids[S.uid]=s.count,s.textures[s.count++]=S,g._batch=i,m.push(g),d+=g.indexSize,g.packAsQuad?(this.packQuadAttributes(g,l,h,g._attributeStart,g._textureId),this.packQuadIndex(c,g._indexStart,g._attributeStart/this.vertexSize)):(this.packAttributes(g,l,h,g._attributeStart,g._textureId),this.packIndex(g,c,g._indexStart,g._attributeStart/this.vertexSize))}s.count>0&&(this._finishBatch(i,u,d-u,s,r,n,e,f,m),u=d,++zi),this.elementStart=this.elementSize,this._batchIndexStart=u,this._batchIndexSize=d}_finishBatch(e,t,i,s,a,r,n,l,h){e.gpuBindGroup=null,e.bindGroup=null,e.action=l,e.batcher=this,e.textures=s,e.blendMode=a,e.topology=r,e.start=t,e.size=i,e.elements=h,++zi,this.batches[this.batchIndex++]=e,n.add(e)}finish(e){this.break(e)}ensureAttributeBuffer(e){e*4<=this.attributeBuffer.size||this._resizeAttributeBuffer(e*4)}ensureIndexBuffer(e){e<=this.indexBuffer.length||this._resizeIndexBuffer(e)}_resizeAttributeBuffer(e){const t=Math.max(e,this.attributeBuffer.size*2),i=new Sn(t);kn(this.attributeBuffer.rawBinaryData,i.rawBinaryData),this.attributeBuffer=i}_resizeIndexBuffer(e){const t=this.indexBuffer;let i=Math.max(e,t.length*1.5);i+=i%2;const s=i>65535?new Uint32Array(i):new Uint16Array(i);if(s.BYTES_PER_ELEMENT!==t.BYTES_PER_ELEMENT)for(let a=0;a<t.length;a++)s[a]=t[a];else kn(t.buffer,s.buffer);this.indexBuffer=s}packQuadIndex(e,t,i){e[t]=i+0,e[t+1]=i+1,e[t+2]=i+2,e[t+3]=i+0,e[t+4]=i+2,e[t+5]=i+3}packIndex(e,t,i,s){const a=e.indices,r=e.indexSize,n=e.indexOffset,l=e.attributeOffset;for(let h=0;h<r;h++)t[i++]=s+a[h+n]-l}destroy(e={}){if(this.batches!==null){for(let t=0;t<this.batchIndex;t++)Cn(this.batches[t]);this.batches=null,this.geometry.destroy(!0),this.geometry=null,e.shader&&(this.shader?.destroy(),this.shader=null);for(let t=0;t<this._elements.length;t++)this._elements[t]&&(this._elements[t]._batch=null);this._elements=null,this.indexBuffer=null,this.attributeBuffer.destroy(),this.attributeBuffer=null}}};mc.defaultOptions={maxTextures:null,attributesInitialSize:4,indicesInitialSize:6};let Af=mc;var ht=(o=>(o[o.MAP_READ=1]="MAP_READ",o[o.MAP_WRITE=2]="MAP_WRITE",o[o.COPY_SRC=4]="COPY_SRC",o[o.COPY_DST=8]="COPY_DST",o[o.INDEX=16]="INDEX",o[o.VERTEX=32]="VERTEX",o[o.UNIFORM=64]="UNIFORM",o[o.STORAGE=128]="STORAGE",o[o.INDIRECT=256]="INDIRECT",o[o.QUERY_RESOLVE=512]="QUERY_RESOLVE",o[o.STATIC=1024]="STATIC",o))(ht||{});class Ts extends Xt{constructor(e){let{data:t,size:i}=e;const{usage:s,label:a,shrinkToFit:r}=e;super(),this._gpuData=Object.create(null),this._gcLastUsed=-1,this.autoGarbageCollect=!0,this.uid=He("buffer"),this._resourceType="buffer",this._resourceId=He("resource"),this._touched=0,this._updateID=1,this._dataInt32=null,this.shrinkToFit=!0,this.destroyed=!1,t instanceof Array&&(t=new Float32Array(t)),this._data=t,i??(i=t?.byteLength);const n=!!t;this.descriptor={size:i,usage:s,mappedAtCreation:n,label:a},this.shrinkToFit=r??!0}get data(){return this._data}set data(e){this.setDataWithSize(e,e.length,!0)}get dataInt32(){return this._dataInt32||(this._dataInt32=new Int32Array(this.data.buffer)),this._dataInt32}get static(){return!!(this.descriptor.usage&ht.STATIC)}set static(e){e?this.descriptor.usage|=ht.STATIC:this.descriptor.usage&=~ht.STATIC}setDataWithSize(e,t,i){if(this._updateID++,this._updateSize=t*e.BYTES_PER_ELEMENT,this._data===e){i&&this.emit("update",this);return}const s=this._data;if(this._data=e,this._dataInt32=null,!s||s.length!==e.length){!this.shrinkToFit&&s&&e.byteLength<s.byteLength?i&&this.emit("update",this):(this.descriptor.size=e.byteLength,this._resourceId=He("resource"),this.emit("change",this));return}i&&this.emit("update",this)}update(e){this._updateSize=e??this._updateSize,this._updateID++,this.emit("update",this)}unload(){this.emit("unload",this);for(const e in this._gpuData)this._gpuData[e]?.destroy();this._gpuData=Object.create(null)}destroy(){this.destroyed=!0,this.unload(),this.emit("destroy",this),this.emit("change",this),this._data=null,this.descriptor=null,this.removeAllListeners()}}function _c(o,e){if(!(o instanceof Ts)){let t=e?ht.INDEX:ht.VERTEX;o instanceof Array&&(e?(o=new Uint32Array(o),t=ht.INDEX|ht.COPY_DST):(o=new Float32Array(o),t=ht.VERTEX|ht.COPY_DST)),o=new Ts({data:o,label:e?"index-mesh-buffer":"vertex-mesh-buffer",usage:t})}return o}function Rf(o,e,t){const i=o.getAttribute(e);if(!i)return t.minX=0,t.minY=0,t.maxX=0,t.maxY=0,t;const s=i.buffer.data;let a=1/0,r=1/0,n=-1/0,l=-1/0;const h=s.BYTES_PER_ELEMENT,c=(i.offset||0)/h,d=(i.stride||8)/h;for(let u=c;u<s.length;u+=d){const f=s[u],m=s[u+1];f>n&&(n=f),m>l&&(l=m),f<a&&(a=f),m<r&&(r=m)}return t.minX=a,t.minY=r,t.maxX=n,t.maxY=l,t}function xf(o){return(o instanceof Ts||Array.isArray(o)||o.BYTES_PER_ELEMENT)&&(o={buffer:o}),o.buffer=_c(o.buffer,!1),o}class Ef extends Xt{constructor(e={}){super(),this._gpuData=Object.create(null),this.autoGarbageCollect=!0,this._gcLastUsed=-1,this.uid=He("geometry"),this._layoutKey=0,this.instanceCount=1,this._bounds=new At,this._boundsDirty=!0;const{attributes:t,indexBuffer:i,topology:s}=e;if(this.buffers=[],this.attributes={},t)for(const a in t)this.addAttribute(a,t[a]);this.instanceCount=e.instanceCount??1,i&&this.addIndex(i),this.topology=s||"triangle-list"}onBufferUpdate(){this._boundsDirty=!0,this.emit("update",this)}getAttribute(e){return this.attributes[e]}getIndex(){return this.indexBuffer}getBuffer(e){return this.getAttribute(e).buffer}getSize(){for(const e in this.attributes){const t=this.attributes[e];return t.buffer.data.length/(t.stride/4||t.size)}return 0}addAttribute(e,t){const i=xf(t);this.buffers.indexOf(i.buffer)===-1&&(this.buffers.push(i.buffer),i.buffer.on("update",this.onBufferUpdate,this),i.buffer.on("change",this.onBufferUpdate,this)),this.attributes[e]=i}addIndex(e){this.indexBuffer=_c(e,!0),this.buffers.push(this.indexBuffer)}get bounds(){return this._boundsDirty?(this._boundsDirty=!1,Rf(this,"aPosition",this._bounds)):this._bounds}unload(){this.emit("unload",this);for(const e in this._gpuData)this._gpuData[e]?.destroy();this._gpuData=Object.create(null)}destroy(e=!1){this.emit("destroy",this),this.removeAllListeners(),e&&this.buffers.forEach(t=>t.destroy()),this.unload(),this.indexBuffer?.destroy(),this.attributes=null,this.buffers=null,this.indexBuffer=null,this._bounds=null}}const Df=new Float32Array(1),Ff=new Uint32Array(1);class $f extends Ef{constructor(){const t=new Ts({data:Df,label:"attribute-batch-buffer",usage:ht.VERTEX|ht.COPY_DST,shrinkToFit:!1}),i=new Ts({data:Ff,label:"index-batch-buffer",usage:ht.INDEX|ht.COPY_DST,shrinkToFit:!1}),s=24;super({attributes:{aPosition:{buffer:t,format:"float32x2",stride:s,offset:0},aUV:{buffer:t,format:"float32x2",stride:s,offset:8},aColor:{buffer:t,format:"unorm8x4",stride:s,offset:16},aTextureIdAndRound:{buffer:t,format:"uint16x2",stride:s,offset:20}},indexBuffer:i})}}function Pn(o,e,t){if(o)for(const i in o){const s=i.toLocaleLowerCase(),a=e[s];if(a){let r=o[i];i==="header"&&(r=r.replace(/@in\s+[^;]+;\s*/g,"").replace(/@out\s+[^;]+;\s*/g,"")),t&&a.push(`//----${t}----//`),a.push(r)}else pt(`${i} placement hook does not exist in shader`)}}const Lf=/\{\{(.*?)\}\}/g;function In(o){const e={};return(o.match(Lf)?.map(i=>i.replace(/[{()}]/g,""))??[]).forEach(i=>{e[i]=[]}),e}function An(o,e){let t;const i=/@in\s+([^;]+);/g;for(;(t=i.exec(o))!==null;)e.push(t[1])}function Rn(o,e,t=!1){const i=[];An(e,i),o.forEach(n=>{n.header&&An(n.header,i)});const s=i;t&&s.sort();const a=s.map((n,l)=>`       @location(${l}) ${n},`).join(`
`);let r=e.replace(/@in\s+[^;]+;\s*/g,"");return r=r.replace("{{in}}",`
${a}
`),r}function xn(o,e){let t;const i=/@out\s+([^;]+);/g;for(;(t=i.exec(o))!==null;)e.push(t[1])}function Bf(o){const t=/\b(\w+)\s*:/g.exec(o);return t?t[1]:""}function Wf(o){const e=/@.*?\s+/g;return o.replace(e,"")}function Nf(o,e){const t=[];xn(e,t),o.forEach(l=>{l.header&&xn(l.header,t)});let i=0;const s=t.sort().map(l=>l.indexOf("builtin")>-1?l:`@location(${i++}) ${l}`).join(`,
`),a=t.sort().map(l=>`       var ${Wf(l)};`).join(`
`),r=`return VSOutput(
            ${t.sort().map(l=>` ${Bf(l)}`).join(`,
`)});`;let n=e.replace(/@out\s+[^;]+;\s*/g,"");return n=n.replace("{{struct}}",`
${s}
`),n=n.replace("{{start}}",`
${a}
`),n=n.replace("{{return}}",`
${r}
`),n}function En(o,e){let t=o;for(const i in e){const s=e[i];s.join(`
`).length?t=t.replace(`{{${i}}}`,`//-----${i} START-----//
${s.join(`
`)}
//----${i} FINISH----//`):t=t.replace(`{{${i}}}`,"")}return t}const jt=Object.create(null),cr=new Map;let Of=0;function Gf({template:o,bits:e}){const t=gc(o,e);if(jt[t])return jt[t];const{vertex:i,fragment:s}=zf(o,e);return jt[t]=yc(i,s,e),jt[t]}function Hf({template:o,bits:e}){const t=gc(o,e);return jt[t]||(jt[t]=yc(o.vertex,o.fragment,e)),jt[t]}function zf(o,e){const t=e.map(r=>r.vertex).filter(r=>!!r),i=e.map(r=>r.fragment).filter(r=>!!r);let s=Rn(t,o.vertex,!0);s=Nf(t,s);const a=Rn(i,o.fragment,!0);return{vertex:s,fragment:a}}function gc(o,e){return e.map(t=>(cr.has(t)||cr.set(t,Of++),cr.get(t))).sort((t,i)=>t-i).join("-")+o.vertex+o.fragment}function yc(o,e,t){const i=In(o),s=In(e);return t.forEach(a=>{Pn(a.vertex,i,a.name),Pn(a.fragment,s,a.name)}),{vertex:En(o,i),fragment:En(e,s)}}const Xf=`
    @in aPosition: vec2<f32>;
    @in aUV: vec2<f32>;

    @out @builtin(position) vPosition: vec4<f32>;
    @out vUV : vec2<f32>;
    @out vColor : vec4<f32>;

    {{header}}

    struct VSOutput {
        {{struct}}
    };

    @vertex
    fn main( {{in}} ) -> VSOutput {

        var worldTransformMatrix = globalUniforms.uWorldTransformMatrix;
        var modelMatrix = mat3x3<f32>(
            1.0, 0.0, 0.0,
            0.0, 1.0, 0.0,
            0.0, 0.0, 1.0
          );
        var position = aPosition;
        var uv = aUV;

        {{start}}

        vColor = vec4<f32>(1., 1., 1., 1.);

        {{main}}

        vUV = uv;

        var modelViewProjectionMatrix = globalUniforms.uProjectionMatrix * worldTransformMatrix * modelMatrix;

        vPosition =  vec4<f32>((modelViewProjectionMatrix *  vec3<f32>(position, 1.0)).xy, 0.0, 1.0);

        vColor *= globalUniforms.uWorldColorAlpha;

        {{end}}

        {{return}}
    };
`,Vf=`
    @in vUV : vec2<f32>;
    @in vColor : vec4<f32>;

    {{header}}

    @fragment
    fn main(
        {{in}}
      ) -> @location(0) vec4<f32> {

        {{start}}

        var outColor:vec4<f32>;

        {{main}}

        var finalColor:vec4<f32> = outColor * vColor;

        {{end}}

        return finalColor;
      };
`,qf=`
    in vec2 aPosition;
    in vec2 aUV;

    out vec4 vColor;
    out vec2 vUV;

    {{header}}

    void main(void){

        mat3 worldTransformMatrix = uWorldTransformMatrix;
        mat3 modelMatrix = mat3(
            1.0, 0.0, 0.0,
            0.0, 1.0, 0.0,
            0.0, 0.0, 1.0
          );
        vec2 position = aPosition;
        vec2 uv = aUV;

        {{start}}

        vColor = vec4(1.);

        {{main}}

        vUV = uv;

        mat3 modelViewProjectionMatrix = uProjectionMatrix * worldTransformMatrix * modelMatrix;

        gl_Position = vec4((modelViewProjectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);

        vColor *= uWorldColorAlpha;

        {{end}}
    }
`,Yf=`

    in vec4 vColor;
    in vec2 vUV;

    out vec4 finalColor;

    {{header}}

    void main(void) {

        {{start}}

        vec4 outColor;

        {{main}}

        finalColor = outColor * vColor;

        {{end}}
    }
`,Uf={name:"global-uniforms-bit",vertex:{header:`
        struct GlobalUniforms {
            uProjectionMatrix:mat3x3<f32>,
            uWorldTransformMatrix:mat3x3<f32>,
            uWorldColorAlpha: vec4<f32>,
            uResolution: vec2<f32>,
        }

        @group(0) @binding(0) var<uniform> globalUniforms : GlobalUniforms;
        `}},jf={name:"global-uniforms-bit",vertex:{header:`
          uniform mat3 uProjectionMatrix;
          uniform mat3 uWorldTransformMatrix;
          uniform vec4 uWorldColorAlpha;
          uniform vec2 uResolution;
        `}};function Kf({bits:o,name:e}){const t=Gf({template:{fragment:Vf,vertex:Xf},bits:[Uf,...o]});return $a.from({name:e,vertex:{source:t.vertex,entryPoint:"main"},fragment:{source:t.fragment,entryPoint:"main"}})}function Qf({bits:o,name:e}){return new Yh({name:e,...Hf({template:{vertex:qf,fragment:Yf},bits:[jf,...o]})})}const Zf={name:"color-bit",vertex:{header:`
            @in aColor: vec4<f32>;
        `,main:`
            vColor *= vec4<f32>(aColor.rgb * aColor.a, aColor.a);
        `}},Jf={name:"color-bit",vertex:{header:`
            in vec4 aColor;
        `,main:`
            vColor *= vec4(aColor.rgb * aColor.a, aColor.a);
        `}},dr={};function em(o){const e=[];if(o===1)e.push("@group(1) @binding(0) var textureSource1: texture_2d<f32>;"),e.push("@group(1) @binding(1) var textureSampler1: sampler;");else{let t=0;for(let i=0;i<o;i++)e.push(`@group(1) @binding(${t++}) var textureSource${i+1}: texture_2d<f32>;`),e.push(`@group(1) @binding(${t++}) var textureSampler${i+1}: sampler;`)}return e.join(`
`)}function tm(o){const e=[];if(o===1)e.push("outColor = textureSampleGrad(textureSource1, textureSampler1, vUV, uvDx, uvDy);");else{e.push("switch vTextureId {");for(let t=0;t<o;t++)t===o-1?e.push("  default:{"):e.push(`  case ${t}:{`),e.push(`      outColor = textureSampleGrad(textureSource${t+1}, textureSampler${t+1}, vUV, uvDx, uvDy);`),e.push("      break;}");e.push("}")}return e.join(`
`)}function im(o){return dr[o]||(dr[o]={name:"texture-batch-bit",vertex:{header:`
                @in aTextureIdAndRound: vec2<u32>;
                @out @interpolate(flat) vTextureId : u32;
            `,main:`
                vTextureId = aTextureIdAndRound.y;
            `,end:`
                if(aTextureIdAndRound.x == 1)
                {
                    vPosition = vec4<f32>(roundPixels(vPosition.xy, globalUniforms.uResolution), vPosition.zw);
                }
            `},fragment:{header:`
                @in @interpolate(flat) vTextureId: u32;

                ${em(o)}
            `,main:`
                var uvDx = dpdx(vUV);
                var uvDy = dpdy(vUV);

                ${tm(o)}
            `}}),dr[o]}const ur={};function sm(o){const e=[];for(let t=0;t<o;t++)t>0&&e.push("else"),t<o-1&&e.push(`if(vTextureId < ${t}.5)`),e.push("{"),e.push(`	outColor = texture(uTextures[${t}], vUV);`),e.push("}");return e.join(`
`)}function am(o){return ur[o]||(ur[o]={name:"texture-batch-bit",vertex:{header:`
                in vec2 aTextureIdAndRound;
                out float vTextureId;

            `,main:`
                vTextureId = aTextureIdAndRound.y;
            `,end:`
                if(aTextureIdAndRound.x == 1.)
                {
                    gl_Position.xy = roundPixels(gl_Position.xy, uResolution);
                }
            `},fragment:{header:`
                in float vTextureId;

                uniform sampler2D uTextures[${o}];

            `,main:`

                ${sm(o)}
            `}}),ur[o]}const rm={name:"round-pixels-bit",vertex:{header:`
            fn roundPixels(position: vec2<f32>, targetSize: vec2<f32>) -> vec2<f32>
            {
                return (floor(((position * 0.5 + 0.5) * targetSize) + 0.5) / targetSize) * 2.0 - 1.0;
            }
        `}},om={name:"round-pixels-bit",vertex:{header:`
            vec2 roundPixels(vec2 position, vec2 targetSize)
            {
                return (floor(((position * 0.5 + 0.5) * targetSize) + 0.5) / targetSize) * 2.0 - 1.0;
            }
        `}},Dn={};function nm(o){let e=Dn[o];if(e)return e;const t=new Int32Array(o);for(let i=0;i<o;i++)t[i]=i;return e=Dn[o]=new Qh({uTextures:{value:t,type:"i32",size:o}},{isStatic:!0}),e}class Fn extends wo{constructor(e){const t=Qf({name:"batch",bits:[Jf,am(e),om]}),i=Kf({name:"batch",bits:[Zf,im(e),rm]});super({glProgram:t,gpuProgram:i,resources:{batchSamplers:nm(e)}}),this.maxTextures=e}}let Xi=null;const bc=class wc extends Af{constructor(e){super(e),this.geometry=new $f,this.name=wc.extension.name,this.vertexSize=6,Xi??(Xi=new Fn(e.maxTextures)),this.shader=Xi}packAttributes(e,t,i,s,a){const r=a<<16|e.roundPixels&65535,n=e.transform,l=n.a,h=n.b,c=n.c,d=n.d,u=n.tx,f=n.ty,{positions:m,uvs:_}=e,p=e.color,g=e.attributeOffset,y=g+e.attributeSize;for(let S=g;S<y;S++){const b=S*2,w=m[b],k=m[b+1];t[s++]=l*w+c*k+u,t[s++]=d*k+h*w+f,t[s++]=_[b],t[s++]=_[b+1],i[s++]=p,i[s++]=r}}packQuadAttributes(e,t,i,s,a){const r=e.texture,n=e.transform,l=n.a,h=n.b,c=n.c,d=n.d,u=n.tx,f=n.ty,m=e.bounds,_=m.maxX,p=m.minX,g=m.maxY,y=m.minY,S=r.uvs,b=e.color,w=a<<16|e.roundPixels&65535;t[s+0]=l*p+c*y+u,t[s+1]=d*y+h*p+f,t[s+2]=S.x0,t[s+3]=S.y0,i[s+4]=b,i[s+5]=w,t[s+6]=l*_+c*y+u,t[s+7]=d*y+h*_+f,t[s+8]=S.x1,t[s+9]=S.y1,i[s+10]=b,i[s+11]=w,t[s+12]=l*_+c*g+u,t[s+13]=d*g+h*_+f,t[s+14]=S.x2,t[s+15]=S.y2,i[s+16]=b,i[s+17]=w,t[s+18]=l*p+c*g+u,t[s+19]=d*g+h*p+f,t[s+20]=S.x3,t[s+21]=S.y3,i[s+22]=b,i[s+23]=w}_updateMaxTextures(e){this.shader.maxTextures!==e&&(Xi=new Fn(e),this.shader=Xi)}destroy(){this.shader=null,super.destroy()}};bc.extension={type:[ge.Batcher],name:"default"};let lm=bc;class La{constructor(e){this.items=Object.create(null);const{renderer:t,type:i,onUnload:s,priority:a,name:r}=e;this._renderer=t,t.gc.addResourceHash(this,"items",i,a??0),this._onUnload=s,this.name=r}add(e){return this.items[e.uid]?!1:(this.items[e.uid]=e,e.once("unload",this.remove,this),e._gcLastUsed=this._renderer.gc.now,!0)}remove(e,...t){if(!this.items[e.uid])return;const i=e._gpuData[this._renderer.uid];i&&(this._onUnload?.(e,...t),i.destroy(),e._gpuData[this._renderer.uid]=null,this.items[e.uid]=null)}removeAll(...e){Object.values(this.items).forEach(t=>t&&this.remove(t,...e))}destroy(...e){this.removeAll(...e),this.items=Object.create(null),this._renderer=null,this._onUnload=null}}function hm(o,e,t,i,s,a,r,n=null){let l=0;t*=e,s*=a;const h=n.a,c=n.b,d=n.c,u=n.d,f=n.tx,m=n.ty;for(;l<r;){const _=o[t],p=o[t+1];i[s]=h*_+d*p+f,i[s+1]=c*_+u*p+m,s+=a,t+=e,l++}}function cm(o,e,t,i){let s=0;for(e*=t;s<i;)o[e]=0,o[e+1]=0,e+=t,s++}function vc(o,e,t,i,s){const a=e.a,r=e.b,n=e.c,l=e.d,h=e.tx,c=e.ty;t||(t=0),i||(i=2),s||(s=o.length/i-t);let d=t*i;for(let u=0;u<s;u++){const f=o[d],m=o[d+1];o[d]=a*f+n*m+h,o[d+1]=r*f+l*m+c,d+=i}}const dm=new _e;class Mo{constructor(){this.packAsQuad=!1,this.batcherName="default",this.topology="triangle-list",this.applyTransform=!0,this.roundPixels=0,this._batcher=null,this._batch=null}get uvs(){return this.geometryData.uvs}get positions(){return this.geometryData.vertices}get indices(){return this.geometryData.indices}get blendMode(){return this.renderable&&this.applyTransform?this.renderable.groupBlendMode:"normal"}get color(){const e=this.baseColor,t=e>>16|e&65280|(e&255)<<16,i=this.renderable;return i?Th(t,i.groupColor)+(this.alpha*i.groupAlpha*255<<24):t+(this.alpha*255<<24)}get transform(){return this.renderable?.groupTransform||dm}copyTo(e){e.indexOffset=this.indexOffset,e.indexSize=this.indexSize,e.attributeOffset=this.attributeOffset,e.attributeSize=this.attributeSize,e.baseColor=this.baseColor,e.alpha=this.alpha,e.texture=this.texture,e.geometryData=this.geometryData,e.topology=this.topology}reset(){this.applyTransform=!0,this.renderable=null,this.topology="triangle-list"}destroy(){this.renderable=null,this.texture=null,this.geometryData=null,this._batcher=null,this._batch=null}}const Ms={extension:{type:ge.ShapeBuilder,name:"circle"},build(o,e){let t,i,s,a,r,n;if(o.type==="circle"){const b=o;if(r=n=b.radius,r<=0)return!1;t=b.x,i=b.y,s=a=0}else if(o.type==="ellipse"){const b=o;if(r=b.halfWidth,n=b.halfHeight,r<=0||n<=0)return!1;t=b.x,i=b.y,s=a=0}else{const b=o,w=b.width/2,k=b.height/2;t=b.x+w,i=b.y+k,r=n=Math.max(0,Math.min(b.radius,Math.min(w,k))),s=w-r,a=k-n}if(s<0||a<0)return!1;const l=Math.ceil(2.3*Math.sqrt(r+n)),h=l*8+(s?4:0)+(a?4:0);if(h===0)return!1;if(l===0)return e[0]=e[6]=t+s,e[1]=e[3]=i+a,e[2]=e[4]=t-s,e[5]=e[7]=i-a,!0;let c=0,d=l*4+(s?2:0)+2,u=d,f=h,m=s+r,_=a,p=t+m,g=t-m,y=i+_;if(e[c++]=p,e[c++]=y,e[--d]=y,e[--d]=g,a){const b=i-_;e[u++]=g,e[u++]=b,e[--f]=b,e[--f]=p}for(let b=1;b<l;b++){const w=Math.PI/2*(b/l),k=s+Math.cos(w)*r,T=a+Math.sin(w)*n,M=t+k,C=t-k,P=i+T,R=i-T;e[c++]=M,e[c++]=P,e[--d]=P,e[--d]=C,e[u++]=C,e[u++]=R,e[--f]=R,e[--f]=M}m=s,_=a+n,p=t+m,g=t-m,y=i+_;const S=i-_;return e[c++]=p,e[c++]=y,e[--f]=S,e[--f]=p,s&&(e[c++]=g,e[c++]=y,e[--f]=S,e[--f]=g),!0},triangulate(o,e,t,i,s,a){if(o.length===0)return;let r=0,n=0;for(let c=0;c<o.length;c+=2)r+=o[c],n+=o[c+1];r/=o.length/2,n/=o.length/2;let l=i;e[l*t]=r,e[l*t+1]=n;const h=l++;for(let c=0;c<o.length;c+=2)e[l*t]=o[c],e[l*t+1]=o[c+1],c>0&&(s[a++]=l,s[a++]=h,s[a++]=l-1),l++;s[a++]=h+1,s[a++]=h,s[a++]=l-1}},um={...Ms,extension:{...Ms.extension,name:"ellipse"}},fm={...Ms,extension:{...Ms.extension,name:"roundedRectangle"}},Sc=1e-4,$n=1e-4;function mm(o){const e=o.length;if(e<6)return 1;let t=0;for(let i=0,s=o[e-2],a=o[e-1];i<e;i+=2){const r=o[i],n=o[i+1];t+=(r-s)*(n+a),s=r,a=n}return t<0?-1:1}function Ln(o,e,t,i,s,a,r,n){const l=o-t*s,h=e-i*s,c=o+t*a,d=e+i*a;let u,f;r?(u=i,f=-t):(u=-i,f=t);const m=l+u,_=h+f,p=c+u,g=d+f;return n.push(m,_),n.push(p,g),2}function Jt(o,e,t,i,s,a,r,n){const l=t-o,h=i-e;let c=Math.atan2(l,h),d=Math.atan2(s-o,a-e);n&&c<d?c+=Math.PI*2:!n&&c>d&&(d+=Math.PI*2);let u=c;const f=d-c,m=Math.abs(f),_=Math.sqrt(l*l+h*h),p=(15*m*Math.sqrt(_)/Math.PI>>0)+1,g=f/p;if(u+=g,n){r.push(o,e),r.push(t,i);for(let y=1,S=u;y<p;y++,S+=g)r.push(o,e),r.push(o+Math.sin(S)*_,e+Math.cos(S)*_);r.push(o,e),r.push(s,a)}else{r.push(t,i),r.push(o,e);for(let y=1,S=u;y<p;y++,S+=g)r.push(o+Math.sin(S)*_,e+Math.cos(S)*_),r.push(o,e);r.push(s,a),r.push(o,e)}return p*2}function pm(o,e,t,i,s,a){const r=Sc;if(o.length===0)return;const n=e;let l=n.alignment;if(e.alignment!==.5){let K=mm(o);l=(l-.5)*K+.5}const h=new st(o[0],o[1]),c=new st(o[o.length-2],o[o.length-1]),d=i,u=Math.abs(h.x-c.x)<r&&Math.abs(h.y-c.y)<r;if(d){o=o.slice(),u&&(o.pop(),o.pop(),c.set(o[o.length-2],o[o.length-1]));const K=(h.x+c.x)*.5,ee=(c.y+h.y)*.5;o.unshift(K,ee),o.push(K,ee)}const f=s,m=o.length/2;let _=o.length;const p=f.length/2,g=n.width/2,y=g*g,S=n.miterLimit*n.miterLimit;let b=o[0],w=o[1],k=o[2],T=o[3],M=0,C=0,P=-(w-T),R=b-k,B=0,F=0,W=Math.sqrt(P*P+R*R);P/=W,R/=W,P*=g,R*=g;const X=l,$=(1-X)*2,H=X*2;d||(n.cap==="round"?_+=Jt(b-P*($-H)*.5,w-R*($-H)*.5,b-P*$,w-R*$,b+P*H,w+R*H,f,!0)+2:n.cap==="square"&&(_+=Ln(b,w,P,R,$,H,!0,f))),f.push(b-P*$,w-R*$),f.push(b+P*H,w+R*H);for(let K=1;K<m-1;++K){b=o[(K-1)*2],w=o[(K-1)*2+1],k=o[K*2],T=o[K*2+1],M=o[(K+1)*2],C=o[(K+1)*2+1],P=-(w-T),R=b-k,W=Math.sqrt(P*P+R*R),P/=W,R/=W,P*=g,R*=g,B=-(T-C),F=k-M,W=Math.sqrt(B*B+F*F),B/=W,F/=W,B*=g,F*=g;const ee=k-b,ue=w-T,be=k-M,Ee=C-T,fe=ee*be+ue*Ee,ve=ue*be-Ee*ee,ae=ve<0;if(Math.abs(ve)<.001*Math.abs(fe)){f.push(k-P*$,T-R*$),f.push(k+P*H,T+R*H),fe>=0&&(n.join==="round"?_+=Jt(k,T,k-P*$,T-R*$,k-B*$,T-F*$,f,!1)+4:_+=2,f.push(k-B*H,T-F*H),f.push(k+B*$,T+F*$));continue}const Me=(-P+b)*(-R+T)-(-P+k)*(-R+w),Le=(-B+M)*(-F+T)-(-B+k)*(-F+C),I=(ee*Le-be*Me)/ve,E=(Ee*Me-ue*Le)/ve,A=(I-k)*(I-k)+(E-T)*(E-T),q=k+(I-k)*$,Ce=T+(E-T)*$,Ve=k-(I-k)*H,Pe=T-(E-T)*H,D=Math.min(ee*ee+ue*ue,be*be+Ee*Ee),N=ae?$:H,O=D+N*N*y;A<=O?n.join==="bevel"||A/y>S?(ae?(f.push(q,Ce),f.push(k+P*H,T+R*H),f.push(q,Ce),f.push(k+B*H,T+F*H)):(f.push(k-P*$,T-R*$),f.push(Ve,Pe),f.push(k-B*$,T-F*$),f.push(Ve,Pe)),_+=2):n.join==="round"?ae?(f.push(q,Ce),f.push(k+P*H,T+R*H),_+=Jt(k,T,k+P*H,T+R*H,k+B*H,T+F*H,f,!0)+4,f.push(q,Ce),f.push(k+B*H,T+F*H)):(f.push(k-P*$,T-R*$),f.push(Ve,Pe),_+=Jt(k,T,k-P*$,T-R*$,k-B*$,T-F*$,f,!1)+4,f.push(k-B*$,T-F*$),f.push(Ve,Pe)):(f.push(q,Ce),f.push(Ve,Pe)):(f.push(k-P*$,T-R*$),f.push(k+P*H,T+R*H),n.join==="round"?ae?_+=Jt(k,T,k+P*H,T+R*H,k+B*H,T+F*H,f,!0)+2:_+=Jt(k,T,k-P*$,T-R*$,k-B*$,T-F*$,f,!1)+2:n.join==="miter"&&A/y<=S&&(ae?(f.push(Ve,Pe),f.push(Ve,Pe)):(f.push(q,Ce),f.push(q,Ce)),_+=2),f.push(k-B*$,T-F*$),f.push(k+B*H,T+F*H),_+=2)}b=o[(m-2)*2],w=o[(m-2)*2+1],k=o[(m-1)*2],T=o[(m-1)*2+1],P=-(w-T),R=b-k,W=Math.sqrt(P*P+R*R),P/=W,R/=W,P*=g,R*=g,f.push(k-P*$,T-R*$),f.push(k+P*H,T+R*H),d||(n.cap==="round"?_+=Jt(k-P*($-H)*.5,T-R*($-H)*.5,k-P*$,T-R*$,k+P*H,T+R*H,f,!1)+2:n.cap==="square"&&(_+=Ln(k,T,P,R,$,H,!1,f)));const te=$n*$n;for(let K=p;K<_+p-2;++K)b=f[K*2],w=f[K*2+1],k=f[(K+1)*2],T=f[(K+1)*2+1],M=f[(K+2)*2],C=f[(K+2)*2+1],!(Math.abs(b*(T-C)+k*(C-w)+M*(w-T))<te)&&a.push(K,K+1,K+2)}function _m(o,e,t,i){const s=Sc;if(o.length===0)return;const a=o[0],r=o[1],n=o[o.length-2],l=o[o.length-1],h=e||Math.abs(a-n)<s&&Math.abs(r-l)<s,c=t,d=o.length/2,u=c.length/2;for(let f=0;f<d;f++)c.push(o[f*2]),c.push(o[f*2+1]);for(let f=0;f<d-1;f++)i.push(u+f,u+f+1);h&&i.push(u+d-1,u)}function kc(o,e,t,i,s,a,r){const n=rf(o,e,2);if(!n)return;for(let h=0;h<n.length;h+=3)a[r++]=n[h]+s,a[r++]=n[h+1]+s,a[r++]=n[h+2]+s;let l=s*i;for(let h=0;h<o.length;h+=2)t[l]=o[h],t[l+1]=o[h+1],l+=i}const gm=[],ym={extension:{type:ge.ShapeBuilder,name:"polygon"},build(o,e){for(let t=0;t<o.points.length;t++)e[t]=o.points[t];return!0},triangulate(o,e,t,i,s,a){kc(o,gm,e,t,i,s,a)}},bm={extension:{type:ge.ShapeBuilder,name:"rectangle"},build(o,e){const t=o,i=t.x,s=t.y,a=t.width,r=t.height;return a>0&&r>0?(e[0]=i,e[1]=s,e[2]=i+a,e[3]=s,e[4]=i+a,e[5]=s+r,e[6]=i,e[7]=s+r,!0):!1},triangulate(o,e,t,i,s,a){let r=0;i*=t,e[i+r]=o[0],e[i+r+1]=o[1],r+=t,e[i+r]=o[2],e[i+r+1]=o[3],r+=t,e[i+r]=o[6],e[i+r+1]=o[7],r+=t,e[i+r]=o[4],e[i+r+1]=o[5],r+=t;const n=i/t;s[a++]=n,s[a++]=n+1,s[a++]=n+2,s[a++]=n+1,s[a++]=n+3,s[a++]=n+2}},wm={extension:{type:ge.ShapeBuilder,name:"triangle"},build(o,e){return e[0]=o.x,e[1]=o.y,e[2]=o.x2,e[3]=o.y2,e[4]=o.x3,e[5]=o.y3,!0},triangulate(o,e,t,i,s,a){let r=0;i*=t,e[i+r]=o[0],e[i+r+1]=o[1],r+=t,e[i+r]=o[2],e[i+r+1]=o[3],r+=t,e[i+r]=o[4],e[i+r+1]=o[5];const n=i/t;s[a++]=n,s[a++]=n+1,s[a++]=n+2}},Bn=[{offset:0,color:"white"},{offset:1,color:"black"}],Co=class Qr{constructor(...e){this.uid=He("fillGradient"),this._tick=0,this.type="linear",this.colorStops=[];let t=vm(e);t={...t.type==="radial"?Qr.defaultRadialOptions:Qr.defaultLinearOptions,...fh(t)},this._textureSize=t.textureSize,this._wrapMode=t.wrapMode,t.type==="radial"?(this.center=t.center,this.outerCenter=t.outerCenter??this.center,this.innerRadius=t.innerRadius,this.outerRadius=t.outerRadius,this.scale=t.scale,this.rotation=t.rotation):(this.start=t.start,this.end=t.end),this.textureSpace=t.textureSpace,this.type=t.type,t.colorStops.forEach(s=>{this.addColorStop(s.offset,s.color)})}addColorStop(e,t){return this.colorStops.push({offset:e,color:wt.shared.setValue(t).toHexa()}),this}buildLinearGradient(){if(this.texture)return;let{x:e,y:t}=this.start,{x:i,y:s}=this.end,a=i-e,r=s-t;const n=a<0||r<0;if(this._wrapMode==="clamp-to-edge"){if(a<0){const p=e;e=i,i=p,a*=-1}if(r<0){const p=t;t=s,s=p,r*=-1}}const l=this.colorStops.length?this.colorStops:Bn,h=this._textureSize,{canvas:c,context:d}=Nn(h,1),u=n?d.createLinearGradient(this._textureSize,0,0,0):d.createLinearGradient(0,0,this._textureSize,0);Wn(u,l),d.fillStyle=u,d.fillRect(0,0,h,1),this.texture=new Z({source:new nt({resource:c,addressMode:this._wrapMode})});const f=Math.sqrt(a*a+r*r),m=Math.atan2(r,a),_=new _e;_.scale(f/h,1),_.rotate(m),_.translate(e,t),this.textureSpace==="local"&&_.scale(h,h),this.transform=_}buildGradient(){this.texture||this._tick++,this.type==="linear"?this.buildLinearGradient():this.buildRadialGradient()}buildRadialGradient(){if(this.texture)return;const e=this.colorStops.length?this.colorStops:Bn,t=this._textureSize,{canvas:i,context:s}=Nn(t,t),{x:a,y:r}=this.center,{x:n,y:l}=this.outerCenter,h=this.innerRadius,c=this.outerRadius,d=n-c,u=l-c,f=t/(c*2),m=(a-d)*f,_=(r-u)*f,p=s.createRadialGradient(m,_,h*f,(n-d)*f,(l-u)*f,c*f);Wn(p,e),s.fillStyle=e[e.length-1].color,s.fillRect(0,0,t,t),s.fillStyle=p,s.translate(m,_),s.rotate(this.rotation),s.scale(1,this.scale),s.translate(-m,-_),s.fillRect(0,0,t,t),this.texture=new Z({source:new nt({resource:i,addressMode:this._wrapMode})});const g=new _e;g.scale(1/f,1/f),g.translate(d,u),this.textureSpace==="local"&&g.scale(t,t),this.transform=g}destroy(){this.texture?.destroy(!0),this.texture=null,this.transform=null,this.colorStops=[],this.start=null,this.end=null,this.center=null,this.outerCenter=null}get styleKey(){return`fill-gradient-${this.uid}-${this._tick}`}};Co.defaultLinearOptions={start:{x:0,y:0},end:{x:0,y:1},colorStops:[],textureSpace:"local",type:"linear",textureSize:256,wrapMode:"clamp-to-edge"};Co.defaultRadialOptions={center:{x:.5,y:.5},innerRadius:0,outerRadius:.5,colorStops:[],scale:1,textureSpace:"local",type:"radial",textureSize:256,wrapMode:"clamp-to-edge"};let Ps=Co;function Wn(o,e){for(let t=0;t<e.length;t++){const i=e[t];o.addColorStop(i.offset,i.color)}}function Nn(o,e){const t=Kt.get().createCanvas(o,e),i=t.getContext("2d");return{canvas:t,context:i}}function vm(o){let e=o[0]??{};return(typeof e=="number"||o[1])&&(Ie("8.5.2","use options object instead"),e={type:"linear",start:{x:o[0],y:o[1]},end:{x:o[2],y:o[3]},textureSpace:o[4],textureSize:o[5]??Ps.defaultLinearOptions.textureSize}),e}const Sm=new _e,km=new $e;function Tm(o,e,t,i){const s=e.matrix?o.copyFrom(e.matrix).invert():o.identity();if(e.textureSpace==="local"){const r=t.getBounds(km);e.width&&r.pad(e.width);const{x:n,y:l}=r,h=1/r.width,c=1/r.height,d=-n*h,u=-l*c,f=s.a,m=s.b,_=s.c,p=s.d;s.a*=h,s.b*=h,s.c*=c,s.d*=c,s.tx=d*f+u*_+s.tx,s.ty=d*m+u*p+s.ty}else s.translate(e.texture.frame.x,e.texture.frame.y),s.scale(1/e.texture.source.width,1/e.texture.source.height);const a=e.texture.source.style;return!(e.fill instanceof Ps)&&a.addressMode==="clamp-to-edge"&&(a.addressMode="repeat",a.update()),i&&s.append(Sm.copyFrom(i).invert()),s}const Ba={};Ze.handleByMap(ge.ShapeBuilder,Ba);Ze.add(bm,ym,wm,Ms,um,fm);const Mm=new $e,Cm=new _e;function Pm(o,e){const{geometryData:t,batches:i}=e;i.length=0,t.indices.length=0,t.vertices.length=0,t.uvs.length=0;for(let s=0;s<o.instructions.length;s++){const a=o.instructions[s];if(a.action==="texture")Im(a.data,i,t);else if(a.action==="fill"||a.action==="stroke"){const r=a.action==="stroke",n=a.data.path.shapePath,l=a.data.style,h=a.data.hole;r&&h&&On(h.shapePath,l,!0,i,t),h&&(n.shapePrimitives[n.shapePrimitives.length-1].holes=h.shapePath.shapePrimitives),On(n,l,r,i,t)}}}function Im(o,e,t){const i=[],s=Ba.rectangle,a=Mm;a.x=o.dx,a.y=o.dy,a.width=o.dw,a.height=o.dh;const r=o.transform;if(!s.build(a,i))return;const{vertices:n,uvs:l,indices:h}=t,c=h.length,d=n.length/2;r&&vc(i,r),s.triangulate(i,n,2,d,h,c);const u=o.image,f=u.uvs;l.push(f.x0,f.y0,f.x1,f.y1,f.x3,f.y3,f.x2,f.y2);const m=ct.get(Mo);m.indexOffset=c,m.indexSize=h.length-c,m.attributeOffset=d,m.attributeSize=n.length/2-d,m.baseColor=o.style,m.alpha=o.alpha,m.texture=u,m.geometryData=t,e.push(m)}function On(o,e,t,i,s){const{vertices:a,uvs:r,indices:n}=s;o.shapePrimitives.forEach(({shape:l,transform:h,holes:c})=>{const d=[],u=Ba[l.type];if(!u.build(l,d))return;const f=n.length,m=a.length/2;let _="triangle-list";if(h&&vc(d,h),t){const S=l.closePath??!0,b=e;b.pixelLine?(_m(d,S,a,n),_="line-list"):pm(d,b,!1,S,a,n)}else if(c){const S=[],b=d.slice();Am(c).forEach(k=>{S.push(b.length/2),b.push(...k)}),kc(b,S,a,2,m,n,f)}else u.triangulate(d,a,2,m,n,f);const p=r.length/2,g=e.texture;if(g!==Z.WHITE){const S=Tm(Cm,e,l,h);hm(a,2,m,r,p,2,a.length/2-m,S)}else cm(r,p,2,a.length/2-m);const y=ct.get(Mo);y.indexOffset=f,y.indexSize=n.length-f,y.attributeOffset=m,y.attributeSize=a.length/2-m,y.baseColor=e.color,y.alpha=e.alpha,y.texture=g,y.geometryData=s,y.topology=_,i.push(y)})}function Am(o){const e=[];for(let t=0;t<o.length;t++){const i=o[t].shape,s=[];Ba[i.type].build(i,s)&&e.push(s)}return e}class Rm{constructor(){this.batches=[],this.geometryData={vertices:[],uvs:[],indices:[]}}reset(){this.batches&&this.batches.forEach(e=>{ct.return(e)}),this.graphicsData&&ct.return(this.graphicsData),this.isBatchable=!1,this.context=null,this.batches.length=0,this.geometryData.indices.length=0,this.geometryData.vertices.length=0,this.geometryData.uvs.length=0,this.graphicsData=null}destroy(){this.reset(),this.batches=null,this.geometryData=null}}class xm{constructor(){this.instructions=new yo}init(e){const t=e.maxTextures;this.batcher?this.batcher._updateMaxTextures(t):this.batcher=new lm({maxTextures:t}),this.instructions.reset()}get geometry(){return Ie(Md,"GraphicsContextRenderData#geometry is deprecated, please use batcher.geometry instead."),this.batcher.geometry}destroy(){this.batcher.destroy(),this.instructions.destroy(),this.batcher=null,this.instructions=null}}const Po=class Zr{constructor(e){this._renderer=e,this._managedContexts=new La({renderer:e,type:"resource",name:"graphicsContext"})}init(e){Zr.defaultOptions.bezierSmoothness=e?.bezierSmoothness??Zr.defaultOptions.bezierSmoothness}getContextRenderData(e){return e._gpuData[this._renderer.uid].graphicsData||this._initContextRenderData(e)}updateGpuContext(e){const t=!!e._gpuData[this._renderer.uid],i=e._gpuData[this._renderer.uid]||this._initContext(e);if(e.dirty||!t){t&&i.reset(),Pm(e,i);const s=e.batchMode;e.customShader||s==="no-batch"?i.isBatchable=!1:s==="auto"?i.isBatchable=i.geometryData.vertices.length<400:i.isBatchable=!0,e.dirty=!1}return i}getGpuContext(e){return e._gpuData[this._renderer.uid]||this._initContext(e)}_initContextRenderData(e){const t=ct.get(xm,{maxTextures:this._renderer.limits.maxBatchableTextures}),i=e._gpuData[this._renderer.uid],{batches:s,geometryData:a}=i;i.graphicsData=t;const r=a.vertices.length,n=a.indices.length;for(let d=0;d<s.length;d++)s[d].applyTransform=!1;const l=t.batcher;l.ensureAttributeBuffer(r),l.ensureIndexBuffer(n),l.begin();for(let d=0;d<s.length;d++){const u=s[d];l.add(u)}l.finish(t.instructions);const h=l.geometry;h.indexBuffer.setDataWithSize(l.indexBuffer,l.indexSize,!0),h.buffers[0].setDataWithSize(l.attributeBuffer.float32View,l.attributeSize,!0);const c=l.batches;for(let d=0;d<c.length;d++){const u=c[d];u.bindGroup=bf(u.textures.textures,u.textures.count,this._renderer.limits.maxBatchableTextures)}return t}_initContext(e){const t=new Rm;return t.context=e,e._gpuData[this._renderer.uid]=t,this._managedContexts.add(e),t}destroy(){this._managedContexts.destroy(),this._renderer=null}};Po.extension={type:[ge.WebGLSystem,ge.WebGPUSystem],name:"graphicsContext"};Po.defaultOptions={bezierSmoothness:.5};let Io=Po;const Em=8,Hs=11920929e-14,Dm=1;function Tc(o,e,t,i,s,a,r,n,l,h){const d=Math.min(.99,Math.max(0,h??Io.defaultOptions.bezierSmoothness));let u=(Dm-d)/1;return u*=u,Fm(e,t,i,s,a,r,n,l,o,u),o}function Fm(o,e,t,i,s,a,r,n,l,h){Jr(o,e,t,i,s,a,r,n,l,h,0),l.push(r,n)}function Jr(o,e,t,i,s,a,r,n,l,h,c){if(c>Em)return;const d=(o+t)/2,u=(e+i)/2,f=(t+s)/2,m=(i+a)/2,_=(s+r)/2,p=(a+n)/2,g=(d+f)/2,y=(u+m)/2,S=(f+_)/2,b=(m+p)/2,w=(g+S)/2,k=(y+b)/2;if(c>0){let T=r-o,M=n-e;const C=Math.abs((t-r)*M-(i-n)*T),P=Math.abs((s-r)*M-(a-n)*T);if(C>Hs&&P>Hs){if((C+P)*(C+P)<=h*(T*T+M*M)){l.push(w,k);return}}else if(C>Hs){if(C*C<=h*(T*T+M*M)){l.push(w,k);return}}else if(P>Hs){if(P*P<=h*(T*T+M*M)){l.push(w,k);return}}else if(T=w-(o+r)/2,M=k-(e+n)/2,T*T+M*M<=h){l.push(w,k);return}}Jr(o,e,d,u,g,y,w,k,l,h,c+1),Jr(w,k,S,b,_,p,r,n,l,h,c+1)}const $m=8,Lm=11920929e-14,Bm=1;function Wm(o,e,t,i,s,a,r,n){const h=Math.min(.99,Math.max(0,n??Io.defaultOptions.bezierSmoothness));let c=(Bm-h)/1;return c*=c,Nm(e,t,i,s,a,r,o,c),o}function Nm(o,e,t,i,s,a,r,n){eo(r,o,e,t,i,s,a,n,0),r.push(s,a)}function eo(o,e,t,i,s,a,r,n,l){if(l>$m)return;const h=(e+i)/2,c=(t+s)/2,d=(i+a)/2,u=(s+r)/2,f=(h+d)/2,m=(c+u)/2;let _=a-e,p=r-t;const g=Math.abs((i-a)*p-(s-r)*_);if(g>Lm){if(g*g<=n*(_*_+p*p)){o.push(f,m);return}}else if(_=f-(e+a)/2,p=m-(t+r)/2,_*_+p*p<=n){o.push(f,m);return}eo(o,e,t,h,c,f,m,n,l+1),eo(o,f,m,d,u,a,r,n,l+1)}function Mc(o,e,t,i,s,a,r,n){let l=Math.abs(s-a);(!r&&s>a||r&&a>s)&&(l=2*Math.PI-l),n||(n=Math.max(6,Math.floor(6*Math.pow(i,1/3)*(l/Math.PI)))),n=Math.max(n,3);let h=l/n,c=s;h*=r?-1:1;for(let d=0;d<n+1;d++){const u=Math.cos(c),f=Math.sin(c),m=e+u*i,_=t+f*i;o.push(m,_),c+=h}}function Om(o,e,t,i,s,a){const r=o[o.length-2],l=o[o.length-1]-t,h=r-e,c=s-t,d=i-e,u=Math.abs(l*d-h*c);if(u<1e-8||a===0){(o[o.length-2]!==e||o[o.length-1]!==t)&&o.push(e,t);return}const f=l*l+h*h,m=c*c+d*d,_=l*c+h*d,p=a*Math.sqrt(f)/u,g=a*Math.sqrt(m)/u,y=p*_/f,S=g*_/m,b=p*d+g*h,w=p*c+g*l,k=h*(g+y),T=l*(g+y),M=d*(p+S),C=c*(p+S),P=Math.atan2(T-w,k-b),R=Math.atan2(C-w,M-b);Mc(o,b+e,w+t,a,P,R,h*c>d*l)}const fs=Math.PI*2,fr={centerX:0,centerY:0,ang1:0,ang2:0},mr=({x:o,y:e},t,i,s,a,r,n,l)=>{o*=t,e*=i;const h=s*o-a*e,c=a*o+s*e;return l.x=h+r,l.y=c+n,l};function Gm(o,e){const t=e===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(e/4),i=e===1.5707963267948966?.551915024494:t,s=Math.cos(o),a=Math.sin(o),r=Math.cos(o+e),n=Math.sin(o+e);return[{x:s-a*i,y:a+s*i},{x:r+n*i,y:n-r*i},{x:r,y:n}]}const Gn=(o,e,t,i)=>{const s=o*i-e*t<0?-1:1;let a=o*t+e*i;return a>1&&(a=1),a<-1&&(a=-1),s*Math.acos(a)},Hm=(o,e,t,i,s,a,r,n,l,h,c,d,u)=>{const f=Math.pow(s,2),m=Math.pow(a,2),_=Math.pow(c,2),p=Math.pow(d,2);let g=f*m-f*p-m*_;g<0&&(g=0),g/=f*p+m*_,g=Math.sqrt(g)*(r===n?-1:1);const y=g*s/a*d,S=g*-a/s*c,b=h*y-l*S+(o+t)/2,w=l*y+h*S+(e+i)/2,k=(c-y)/s,T=(d-S)/a,M=(-c-y)/s,C=(-d-S)/a,P=Gn(1,0,k,T);let R=Gn(k,T,M,C);n===0&&R>0&&(R-=fs),n===1&&R<0&&(R+=fs),u.centerX=b,u.centerY=w,u.ang1=P,u.ang2=R};function zm(o,e,t,i,s,a,r,n=0,l=0,h=0){if(a===0||r===0)return;const c=Math.sin(n*fs/360),d=Math.cos(n*fs/360),u=d*(e-i)/2+c*(t-s)/2,f=-c*(e-i)/2+d*(t-s)/2;if(u===0&&f===0)return;a=Math.abs(a),r=Math.abs(r);const m=Math.pow(u,2)/Math.pow(a,2)+Math.pow(f,2)/Math.pow(r,2);m>1&&(a*=Math.sqrt(m),r*=Math.sqrt(m)),Hm(e,t,i,s,a,r,l,h,c,d,u,f,fr);let{ang1:_,ang2:p}=fr;const{centerX:g,centerY:y}=fr;let S=Math.abs(p)/(fs/4);Math.abs(1-S)<1e-7&&(S=1);const b=Math.max(Math.ceil(S),1);p/=b;let w=o[o.length-2],k=o[o.length-1];const T={x:0,y:0};for(let M=0;M<b;M++){const C=Gm(_,p),{x:P,y:R}=mr(C[0],a,r,d,c,g,y,T),{x:B,y:F}=mr(C[1],a,r,d,c,g,y,T),{x:W,y:X}=mr(C[2],a,r,d,c,g,y,T);Tc(o,w,k,P,R,B,F,W,X),w=W,k=X,_+=p}}function Xm(o,e,t){const i=(r,n)=>{const l=n.x-r.x,h=n.y-r.y,c=Math.sqrt(l*l+h*h),d=l/c,u=h/c;return{len:c,nx:d,ny:u}},s=(r,n)=>{r===0?o.moveTo(n.x,n.y):o.lineTo(n.x,n.y)};let a=e[e.length-1];for(let r=0;r<e.length;r++){const n=e[r%e.length],l=n.radius??t;if(l<=0){s(r,n),a=n;continue}const h=e[(r+1)%e.length],c=i(n,a),d=i(n,h);if(c.len<1e-4||d.len<1e-4){s(r,n),a=n;continue}let u=Math.asin(c.nx*d.ny-c.ny*d.nx),f=1,m=!1;c.nx*d.nx-c.ny*-d.ny<0?u<0?u=Math.PI+u:(u=Math.PI-u,f=-1,m=!0):u>0&&(f=-1,m=!0);const _=u/2;let p,g=Math.abs(Math.cos(_)*l/Math.sin(_));g>Math.min(c.len/2,d.len/2)?(g=Math.min(c.len/2,d.len/2),p=Math.abs(g*Math.sin(_)/Math.cos(_))):p=l;const y=n.x+d.nx*g+-d.ny*p*f,S=n.y+d.ny*g+d.nx*p*f,b=Math.atan2(c.ny,c.nx)+Math.PI/2*f,w=Math.atan2(d.ny,d.nx)-Math.PI/2*f;r===0&&o.moveTo(y+Math.cos(b)*p,S+Math.sin(b)*p),o.arc(y,S,p,b,w,m),a=n}}function Vm(o,e,t,i){const s=(n,l)=>Math.sqrt((n.x-l.x)**2+(n.y-l.y)**2),a=(n,l,h)=>({x:n.x+(l.x-n.x)*h,y:n.y+(l.y-n.y)*h}),r=e.length;for(let n=0;n<r;n++){const l=e[(n+1)%r],h=l.radius??t;if(h<=0){n===0?o.moveTo(l.x,l.y):o.lineTo(l.x,l.y);continue}const c=e[n],d=e[(n+2)%r],u=s(c,l);let f;if(u<1e-4)f=l;else{const p=Math.min(u/2,h);f=a(l,c,p/u)}const m=s(d,l);let _;if(m<1e-4)_=l;else{const p=Math.min(m/2,h);_=a(l,d,p/m)}n===0?o.moveTo(f.x,f.y):o.lineTo(f.x,f.y),o.quadraticCurveTo(l.x,l.y,_.x,_.y,i)}}const qm=new $e;class Ym{constructor(e){this.shapePrimitives=[],this._currentPoly=null,this._bounds=new At,this._graphicsPath2D=e,this.signed=e.checkForHoles}moveTo(e,t){return this.startPoly(e,t),this}lineTo(e,t){this._ensurePoly();const i=this._currentPoly.points,s=i[i.length-2],a=i[i.length-1];return(s!==e||a!==t)&&i.push(e,t),this}arc(e,t,i,s,a,r){this._ensurePoly(!1);const n=this._currentPoly.points;return Mc(n,e,t,i,s,a,r),this}arcTo(e,t,i,s,a){this._ensurePoly();const r=this._currentPoly.points;return Om(r,e,t,i,s,a),this}arcToSvg(e,t,i,s,a,r,n){const l=this._currentPoly.points;return zm(l,this._currentPoly.lastX,this._currentPoly.lastY,r,n,e,t,i,s,a),this}bezierCurveTo(e,t,i,s,a,r,n){this._ensurePoly();const l=this._currentPoly;return Tc(this._currentPoly.points,l.lastX,l.lastY,e,t,i,s,a,r,n),this}quadraticCurveTo(e,t,i,s,a){this._ensurePoly();const r=this._currentPoly;return Wm(this._currentPoly.points,r.lastX,r.lastY,e,t,i,s,a),this}closePath(){return this.endPoly(!0),this}addPath(e,t){this.endPoly(),t&&!t.isIdentity()&&(e=e.clone(!0),e.transform(t));const i=this.shapePrimitives,s=i.length;for(let a=0;a<e.instructions.length;a++){const r=e.instructions[a];this[r.action](...r.data)}if(e.checkForHoles&&i.length-s>1){let a=null;for(let r=s;r<i.length;r++){const n=i[r];if(n.shape.type==="polygon"){const l=n.shape,h=a?.shape;h&&h.containsPolygon(l)?(a.holes||(a.holes=[]),a.holes.push(n),i.copyWithin(r,r+1),i.length--,r--):a=n}}}return this}finish(e=!1){this.endPoly(e)}rect(e,t,i,s,a){return this.drawShape(new $e(e,t,i,s),a),this}circle(e,t,i,s){return this.drawShape(new So(e,t,i),s),this}poly(e,t,i){const s=new ds(e);return s.closePath=t,this.drawShape(s,i),this}regularPoly(e,t,i,s,a=0,r){s=Math.max(s|0,3);const n=-1*Math.PI/2+a,l=Math.PI*2/s,h=[];for(let c=0;c<s;c++){const d=n-c*l;h.push(e+i*Math.cos(d),t+i*Math.sin(d))}return this.poly(h,!0,r),this}roundPoly(e,t,i,s,a,r=0,n){if(s=Math.max(s|0,3),a<=0)return this.regularPoly(e,t,i,s,r);const l=i*Math.sin(Math.PI/s)-.001;a=Math.min(a,l);const h=-1*Math.PI/2+r,c=Math.PI*2/s,d=(s-2)*Math.PI/s/2;for(let u=0;u<s;u++){const f=u*c+h,m=e+i*Math.cos(f),_=t+i*Math.sin(f),p=f+Math.PI+d,g=f-Math.PI-d,y=m+a*Math.cos(p),S=_+a*Math.sin(p),b=m+a*Math.cos(g),w=_+a*Math.sin(g);u===0?this.moveTo(y,S):this.lineTo(y,S),this.quadraticCurveTo(m,_,b,w,n)}return this.closePath()}roundShape(e,t,i=!1,s){return e.length<3?this:(i?Vm(this,e,t,s):Xm(this,e,t),this.closePath())}filletRect(e,t,i,s,a){if(a===0)return this.rect(e,t,i,s);const r=Math.min(i,s)/2,n=Math.min(r,Math.max(-r,a)),l=e+i,h=t+s,c=n<0?-n:0,d=Math.abs(n);return this.moveTo(e,t+d).arcTo(e+c,t+c,e+d,t,d).lineTo(l-d,t).arcTo(l-c,t+c,l,t+d,d).lineTo(l,h-d).arcTo(l-c,h-c,e+i-d,h,d).lineTo(e+d,h).arcTo(e+c,h-c,e,h-d,d).closePath()}chamferRect(e,t,i,s,a,r){if(a<=0)return this.rect(e,t,i,s);const n=Math.min(a,Math.min(i,s)/2),l=e+i,h=t+s,c=[e+n,t,l-n,t,l,t+n,l,h-n,l-n,h,e+n,h,e,h-n,e,t+n];for(let d=c.length-1;d>=2;d-=2)c[d]===c[d-2]&&c[d-1]===c[d-3]&&c.splice(d-1,2);return this.poly(c,!0,r)}ellipse(e,t,i,s,a){return this.drawShape(new ko(e,t,i,s),a),this}roundRect(e,t,i,s,a,r){return this.drawShape(new To(e,t,i,s,a),r),this}drawShape(e,t){return this.endPoly(),this.shapePrimitives.push({shape:e,transform:t}),this}startPoly(e,t){let i=this._currentPoly;return i&&this.endPoly(),i=new ds,i.points.push(e,t),this._currentPoly=i,this}endPoly(e=!1){const t=this._currentPoly;return t&&t.points.length>2&&(t.closePath=e,this.shapePrimitives.push({shape:t})),this._currentPoly=null,this}_ensurePoly(e=!0){if(!this._currentPoly&&(this._currentPoly=new ds,e)){const t=this.shapePrimitives[this.shapePrimitives.length-1];if(t){let i=t.shape.x,s=t.shape.y;if(t.transform&&!t.transform.isIdentity()){const a=t.transform,r=i;i=a.a*i+a.c*s+a.tx,s=a.b*r+a.d*s+a.ty}this._currentPoly.points.push(i,s)}else this._currentPoly.points.push(0,0)}}buildPath(){const e=this._graphicsPath2D;this.shapePrimitives.length=0,this._currentPoly=null;for(let t=0;t<e.instructions.length;t++){const i=e.instructions[t];this[i.action](...i.data)}this.finish()}get bounds(){const e=this._bounds;e.clear();const t=this.shapePrimitives;for(let i=0;i<t.length;i++){const s=t[i],a=s.shape.getBounds(qm);s.transform?e.addRect(a,s.transform):e.addRect(a)}return e}}class Ht{constructor(e,t=!1){this.instructions=[],this.uid=He("graphicsPath"),this._dirty=!0,this.checkForHoles=t,typeof e=="string"?pf(e,this):this.instructions=e?.slice()??[]}get shapePath(){return this._shapePath||(this._shapePath=new Ym(this)),this._dirty&&(this._dirty=!1,this._shapePath.buildPath()),this._shapePath}addPath(e,t){return e=e.clone(),this.instructions.push({action:"addPath",data:[e,t]}),this._dirty=!0,this}arc(...e){return this.instructions.push({action:"arc",data:e}),this._dirty=!0,this}arcTo(...e){return this.instructions.push({action:"arcTo",data:e}),this._dirty=!0,this}arcToSvg(...e){return this.instructions.push({action:"arcToSvg",data:e}),this._dirty=!0,this}bezierCurveTo(...e){return this.instructions.push({action:"bezierCurveTo",data:e}),this._dirty=!0,this}bezierCurveToShort(e,t,i,s,a){const r=this.instructions[this.instructions.length-1],n=this.getLastPoint(st.shared);let l=0,h=0;if(!r||r.action!=="bezierCurveTo")l=n.x,h=n.y;else{l=r.data[2],h=r.data[3];const c=n.x,d=n.y;l=c+(c-l),h=d+(d-h)}return this.instructions.push({action:"bezierCurveTo",data:[l,h,e,t,i,s,a]}),this._dirty=!0,this}closePath(){return this.instructions.push({action:"closePath",data:[]}),this._dirty=!0,this}ellipse(...e){return this.instructions.push({action:"ellipse",data:e}),this._dirty=!0,this}lineTo(...e){return this.instructions.push({action:"lineTo",data:e}),this._dirty=!0,this}moveTo(...e){return this.instructions.push({action:"moveTo",data:e}),this}quadraticCurveTo(...e){return this.instructions.push({action:"quadraticCurveTo",data:e}),this._dirty=!0,this}quadraticCurveToShort(e,t,i){const s=this.instructions[this.instructions.length-1],a=this.getLastPoint(st.shared);let r=0,n=0;if(!s||s.action!=="quadraticCurveTo")r=a.x,n=a.y;else{r=s.data[0],n=s.data[1];const l=a.x,h=a.y;r=l+(l-r),n=h+(h-n)}return this.instructions.push({action:"quadraticCurveTo",data:[r,n,e,t,i]}),this._dirty=!0,this}rect(e,t,i,s,a){return this.instructions.push({action:"rect",data:[e,t,i,s,a]}),this._dirty=!0,this}circle(e,t,i,s){return this.instructions.push({action:"circle",data:[e,t,i,s]}),this._dirty=!0,this}roundRect(...e){return this.instructions.push({action:"roundRect",data:e}),this._dirty=!0,this}poly(...e){return this.instructions.push({action:"poly",data:e}),this._dirty=!0,this}regularPoly(...e){return this.instructions.push({action:"regularPoly",data:e}),this._dirty=!0,this}roundPoly(...e){return this.instructions.push({action:"roundPoly",data:e}),this._dirty=!0,this}roundShape(...e){return this.instructions.push({action:"roundShape",data:e}),this._dirty=!0,this}filletRect(...e){return this.instructions.push({action:"filletRect",data:e}),this._dirty=!0,this}chamferRect(...e){return this.instructions.push({action:"chamferRect",data:e}),this._dirty=!0,this}star(e,t,i,s,a,r,n){a||(a=s/2);const l=-1*Math.PI/2+r,h=i*2,c=Math.PI*2/h,d=[];for(let u=0;u<h;u++){const f=u%2?a:s,m=u*c+l;d.push(e+f*Math.cos(m),t+f*Math.sin(m))}return this.poly(d,!0,n),this}clone(e=!1){const t=new Ht;if(t.checkForHoles=this.checkForHoles,!e)t.instructions=this.instructions.slice();else for(let i=0;i<this.instructions.length;i++){const s=this.instructions[i];t.instructions.push({action:s.action,data:s.data.slice()})}return t}clear(){return this.instructions.length=0,this._dirty=!0,this}transform(e){if(e.isIdentity())return this;const t=e.a,i=e.b,s=e.c,a=e.d,r=e.tx,n=e.ty;let l=0,h=0,c=0,d=0,u=0,f=0,m=0,_=0;for(let p=0;p<this.instructions.length;p++){const g=this.instructions[p],y=g.data;switch(g.action){case"moveTo":case"lineTo":l=y[0],h=y[1],y[0]=t*l+s*h+r,y[1]=i*l+a*h+n;break;case"bezierCurveTo":c=y[0],d=y[1],u=y[2],f=y[3],l=y[4],h=y[5],y[0]=t*c+s*d+r,y[1]=i*c+a*d+n,y[2]=t*u+s*f+r,y[3]=i*u+a*f+n,y[4]=t*l+s*h+r,y[5]=i*l+a*h+n;break;case"quadraticCurveTo":c=y[0],d=y[1],l=y[2],h=y[3],y[0]=t*c+s*d+r,y[1]=i*c+a*d+n,y[2]=t*l+s*h+r,y[3]=i*l+a*h+n;break;case"arcToSvg":l=y[5],h=y[6],m=y[0],_=y[1],y[0]=t*m+s*_,y[1]=i*m+a*_,y[5]=t*l+s*h+r,y[6]=i*l+a*h+n;break;case"circle":y[4]=Vi(y[3],e);break;case"rect":y[4]=Vi(y[4],e);break;case"ellipse":y[8]=Vi(y[8],e);break;case"roundRect":y[5]=Vi(y[5],e);break;case"addPath":y[0].transform(e);break;case"poly":y[2]=Vi(y[2],e);break;default:pt("unknown transform action",g.action);break}}return this._dirty=!0,this}get bounds(){return this.shapePath.bounds}getLastPoint(e){let t=this.instructions.length-1,i=this.instructions[t];if(!i)return e.x=0,e.y=0,e;for(;i.action==="closePath";){if(t--,t<0)return e.x=0,e.y=0,e;i=this.instructions[t]}switch(i.action){case"moveTo":case"lineTo":e.x=i.data[0],e.y=i.data[1];break;case"quadraticCurveTo":e.x=i.data[2],e.y=i.data[3];break;case"bezierCurveTo":e.x=i.data[4],e.y=i.data[5];break;case"arc":case"arcToSvg":e.x=i.data[5],e.y=i.data[6];break;case"addPath":i.data[0].getLastPoint(e);break}return e}}function Vi(o,e){return o?o.prepend(e):e.clone()}function We(o,e,t){const i=o.getAttribute(e);return i?Number(i):t}function Um(o,e){const t=o.querySelectorAll("defs");for(let i=0;i<t.length;i++){const s=t[i];for(let a=0;a<s.children.length;a++){const r=s.children[a];switch(r.nodeName.toLowerCase()){case"lineargradient":e.defs[r.id]=jm(r);break;case"radialgradient":e.defs[r.id]=Km();break}}}}function jm(o){const e=We(o,"x1",0),t=We(o,"y1",0),i=We(o,"x2",1),s=We(o,"y2",0),a=o.getAttribute("gradientUnits")||"objectBoundingBox",r=new Ps(e,t,i,s,a==="objectBoundingBox"?"local":"global");for(let n=0;n<o.children.length;n++){const l=o.children[n],h=We(l,"offset",0),c=wt.shared.setValue(l.getAttribute("stop-color")).toNumber();r.addColorStop(h,c)}return r}function Km(o){return pt("[SVG Parser] Radial gradients are not yet supported"),new Ps(0,0,1,0)}function Hn(o){const e=o.match(/url\s*\(\s*['"]?\s*#([^'"\s)]+)\s*['"]?\s*\)/i);return e?e[1]:""}const zn={fill:{type:"paint",default:0},"fill-opacity":{type:"number",default:1},stroke:{type:"paint",default:0},"stroke-width":{type:"number",default:1},"stroke-opacity":{type:"number",default:1},"stroke-linecap":{type:"string",default:"butt"},"stroke-linejoin":{type:"string",default:"miter"},"stroke-miterlimit":{type:"number",default:10},"stroke-dasharray":{type:"string",default:"none"},"stroke-dashoffset":{type:"number",default:0},opacity:{type:"number",default:1}};function Cc(o,e){const t=o.getAttribute("style"),i={},s={},a={strokeStyle:i,fillStyle:s,useFill:!1,useStroke:!1};for(const r in zn){const n=o.getAttribute(r);n&&Xn(e,a,r,n.trim())}if(t){const r=t.split(";");for(let n=0;n<r.length;n++){const l=r[n].trim(),[h,c]=l.split(":");zn[h]&&Xn(e,a,h,c.trim())}}return{strokeStyle:a.useStroke?i:null,fillStyle:a.useFill?s:null,useFill:a.useFill,useStroke:a.useStroke}}function Xn(o,e,t,i){switch(t){case"stroke":if(i!=="none"){if(i.startsWith("url(")){const s=Hn(i);e.strokeStyle.fill=o.defs[s]}else e.strokeStyle.color=wt.shared.setValue(i).toNumber();e.useStroke=!0}break;case"stroke-width":e.strokeStyle.width=Number(i);break;case"fill":if(i!=="none"){if(i.startsWith("url(")){const s=Hn(i);e.fillStyle.fill=o.defs[s]}else e.fillStyle.color=wt.shared.setValue(i).toNumber();e.useFill=!0}break;case"fill-opacity":e.fillStyle.alpha=Number(i);break;case"stroke-opacity":e.strokeStyle.alpha=Number(i);break;case"opacity":e.fillStyle.alpha=Number(i),e.strokeStyle.alpha=Number(i);break}}function Qm(o){if(o.length<=2)return!0;const e=o.map(n=>n.area).sort((n,l)=>l-n),[t,i]=e,s=e[e.length-1],a=t/i,r=i/s;return!(a>3&&r<2)}function Zm(o){return o.split(/(?=[Mm])/).filter(i=>i.trim().length>0)}function Jm(o){const e=o.match(/[-+]?[0-9]*\.?[0-9]+/g);if(!e||e.length<4)return 0;const t=e.map(Number),i=[],s=[];for(let c=0;c<t.length;c+=2)c+1<t.length&&(i.push(t[c]),s.push(t[c+1]));if(i.length===0||s.length===0)return 0;const a=Math.min(...i),r=Math.max(...i),n=Math.min(...s),l=Math.max(...s);return(r-a)*(l-n)}function Vn(o,e){const t=new Ht(o,!1);for(const i of t.instructions)e.instructions.push(i)}function ep(o,e){if(typeof o=="string"){const r=document.createElement("div");r.innerHTML=o.trim(),o=r.querySelector("svg")}const t={context:e,defs:{},path:new Ht};Um(o,t);const i=o.children,{fillStyle:s,strokeStyle:a}=Cc(o,t);for(let r=0;r<i.length;r++){const n=i[r];n.nodeName.toLowerCase()!=="defs"&&Pc(n,t,s,a)}return e}function Pc(o,e,t,i){const s=o.children,{fillStyle:a,strokeStyle:r}=Cc(o,e);a&&t?t={...t,...a}:a&&(t=a),r&&i?i={...i,...r}:r&&(i=r);const n=!t&&!i;n&&(t={color:0});let l,h,c,d,u,f,m,_,p,g,y,S,b,w,k,T,M;switch(o.nodeName.toLowerCase()){case"path":{w=o.getAttribute("d");const C=o.getAttribute("fill-rule"),P=Zm(w),R=C==="evenodd",B=P.length>1;if(R&&B){const W=P.map($=>({path:$,area:Jm($)}));if(W.sort(($,H)=>H.area-$.area),P.length>3||!Qm(W))for(let $=0;$<W.length;$++){const H=W[$],te=$===0;e.context.beginPath();const K=new Ht(void 0,!0);Vn(H.path,K),e.context.path(K),te?(t&&e.context.fill(t),i&&e.context.stroke(i)):e.context.cut()}else for(let $=0;$<W.length;$++){const H=W[$],te=$%2===1;e.context.beginPath();const K=new Ht(void 0,!0);Vn(H.path,K),e.context.path(K),te?e.context.cut():(t&&e.context.fill(t),i&&e.context.stroke(i))}}else{const W=C?C==="evenodd":!0;k=new Ht(w,W),e.context.path(k),t&&e.context.fill(t),i&&e.context.stroke(i)}break}case"circle":m=We(o,"cx",0),_=We(o,"cy",0),p=We(o,"r",0),e.context.ellipse(m,_,p,p),t&&e.context.fill(t),i&&e.context.stroke(i);break;case"rect":l=We(o,"x",0),h=We(o,"y",0),T=We(o,"width",0),M=We(o,"height",0),g=We(o,"rx",0),y=We(o,"ry",0),g||y?e.context.roundRect(l,h,T,M,g||y):e.context.rect(l,h,T,M),t&&e.context.fill(t),i&&e.context.stroke(i);break;case"ellipse":m=We(o,"cx",0),_=We(o,"cy",0),g=We(o,"rx",0),y=We(o,"ry",0),e.context.beginPath(),e.context.ellipse(m,_,g,y),t&&e.context.fill(t),i&&e.context.stroke(i);break;case"line":c=We(o,"x1",0),d=We(o,"y1",0),u=We(o,"x2",0),f=We(o,"y2",0),e.context.beginPath(),e.context.moveTo(c,d),e.context.lineTo(u,f),i&&e.context.stroke(i);break;case"polygon":b=o.getAttribute("points"),S=b.match(/-?\d+/g).map(C=>parseInt(C,10)),e.context.poly(S,!0),t&&e.context.fill(t),i&&e.context.stroke(i);break;case"polyline":b=o.getAttribute("points"),S=b.match(/-?\d+/g).map(C=>parseInt(C,10)),e.context.poly(S,!1),i&&e.context.stroke(i);break;case"g":case"svg":break;default:{pt(`[SVG parser] <${o.nodeName}> elements unsupported`);break}}n&&(t=null);for(let C=0;C<s.length;C++)Pc(s[C],e,t,i)}const qn={repeat:{addressModeU:"repeat",addressModeV:"repeat"},"repeat-x":{addressModeU:"repeat",addressModeV:"clamp-to-edge"},"repeat-y":{addressModeU:"clamp-to-edge",addressModeV:"repeat"},"no-repeat":{addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}};class tp{constructor(e,t){this.uid=He("fillPattern"),this._tick=0,this.transform=new _e,this.texture=e,this.transform.scale(1/e.frame.width,1/e.frame.height),t&&(e.source.style.addressModeU=qn[t].addressModeU,e.source.style.addressModeV=qn[t].addressModeV)}setTransform(e){const t=this.texture;this.transform.copyFrom(e),this.transform.invert(),this.transform.scale(1/t.frame.width,1/t.frame.height),this._tick++}get texture(){return this._texture}set texture(e){this._texture!==e&&(this._texture=e,this._tick++)}get styleKey(){return`fill-pattern-${this.uid}-${this._tick}`}destroy(){this.texture.destroy(!0),this.texture=null}}function ip(o){return wt.isColorLike(o)}function Yn(o){return o instanceof tp}function Un(o){return o instanceof Ps}function sp(o){return o instanceof Z}function ap(o,e,t){const i=wt.shared.setValue(e??0);return o.color=i.toNumber(),o.alpha=i.alpha===1?t.alpha:i.alpha,o.texture=Z.WHITE,{...t,...o}}function rp(o,e,t){return o.texture=e,{...t,...o}}function jn(o,e,t){return o.fill=e,o.color=16777215,o.texture=e.texture,o.matrix=e.transform,{...t,...o}}function Kn(o,e,t){return e.buildGradient(),o.fill=e,o.color=16777215,o.texture=e.texture,o.matrix=e.transform,o.textureSpace=e.textureSpace,{...t,...o}}function op(o,e){const t={...e,...o},i=wt.shared.setValue(t.color);return t.alpha*=i.alpha,t.color=i.toNumber(),t}function as(o,e){if(o==null)return null;const t={},i=o;return ip(o)?ap(t,o,e):sp(o)?rp(t,o,e):Yn(o)?jn(t,o,e):Un(o)?Kn(t,o,e):i.fill&&Yn(i.fill)?jn(i,i.fill,e):i.fill&&Un(i.fill)?Kn(i,i.fill,e):op(i,e)}function Qn(o,e){const{width:t,alignment:i,miterLimit:s,cap:a,join:r,pixelLine:n,...l}=e,h=as(o,l);return h?{width:t,alignment:i,miterLimit:s,cap:a,join:r,pixelLine:n,...h}:null}const np=new st,Zn=new _e,Ao=class Ft extends Xt{constructor(){super(...arguments),this._gpuData=Object.create(null),this.autoGarbageCollect=!0,this._gcLastUsed=-1,this.uid=He("graphicsContext"),this.dirty=!0,this.batchMode="auto",this.instructions=[],this.destroyed=!1,this._activePath=new Ht,this._transform=new _e,this._fillStyle={...Ft.defaultFillStyle},this._strokeStyle={...Ft.defaultStrokeStyle},this._stateStack=[],this._tick=0,this._bounds=new At,this._boundsDirty=!0}clone(){const e=new Ft;return e.batchMode=this.batchMode,e.instructions=this.instructions.slice(),e._activePath=this._activePath.clone(),e._transform=this._transform.clone(),e._fillStyle={...this._fillStyle},e._strokeStyle={...this._strokeStyle},e._stateStack=this._stateStack.slice(),e._bounds=this._bounds.clone(),e._boundsDirty=!0,e}get fillStyle(){return this._fillStyle}set fillStyle(e){this._fillStyle=as(e,Ft.defaultFillStyle)}get strokeStyle(){return this._strokeStyle}set strokeStyle(e){this._strokeStyle=Qn(e,Ft.defaultStrokeStyle)}setFillStyle(e){return this._fillStyle=as(e,Ft.defaultFillStyle),this}setStrokeStyle(e){return this._strokeStyle=as(e,Ft.defaultStrokeStyle),this}texture(e,t,i,s,a,r){return this.instructions.push({action:"texture",data:{image:e,dx:i||0,dy:s||0,dw:a||e.frame.width,dh:r||e.frame.height,transform:this._transform.clone(),alpha:this._fillStyle.alpha,style:t||t===0?wt.shared.setValue(t).toNumber():16777215}}),this.onUpdate(),this}beginPath(){return this._activePath=new Ht,this}fill(e,t){let i;const s=this.instructions[this.instructions.length-1];return this._tick===0&&s?.action==="stroke"?i=s.data.path:i=this._activePath.clone(),i?(e!=null&&(t!==void 0&&typeof e=="number"&&(Ie(je,"GraphicsContext.fill(color, alpha) is deprecated, use GraphicsContext.fill({ color, alpha }) instead"),e={color:e,alpha:t}),this._fillStyle=as(e,Ft.defaultFillStyle)),this.instructions.push({action:"fill",data:{style:this.fillStyle,path:i}}),this.onUpdate(),this._initNextPathLocation(),this._tick=0,this):this}_initNextPathLocation(){const{x:e,y:t}=this._activePath.getLastPoint(st.shared);this._activePath.clear(),this._activePath.moveTo(e,t)}stroke(e){let t;const i=this.instructions[this.instructions.length-1];return this._tick===0&&i?.action==="fill"?t=i.data.path:t=this._activePath.clone(),t?(e!=null&&(this._strokeStyle=Qn(e,Ft.defaultStrokeStyle)),this.instructions.push({action:"stroke",data:{style:this.strokeStyle,path:t}}),this.onUpdate(),this._initNextPathLocation(),this._tick=0,this):this}cut(){for(let e=0;e<2;e++){const t=this.instructions[this.instructions.length-1-e],i=this._activePath.clone();if(t&&(t.action==="stroke"||t.action==="fill"))if(t.data.hole)t.data.hole.addPath(i);else{t.data.hole=i;break}}return this._initNextPathLocation(),this}arc(e,t,i,s,a,r){this._tick++;const n=this._transform;return this._activePath.arc(n.a*e+n.c*t+n.tx,n.b*e+n.d*t+n.ty,i,s,a,r),this}arcTo(e,t,i,s,a){this._tick++;const r=this._transform;return this._activePath.arcTo(r.a*e+r.c*t+r.tx,r.b*e+r.d*t+r.ty,r.a*i+r.c*s+r.tx,r.b*i+r.d*s+r.ty,a),this}arcToSvg(e,t,i,s,a,r,n){this._tick++;const l=this._transform;return this._activePath.arcToSvg(e,t,i,s,a,l.a*r+l.c*n+l.tx,l.b*r+l.d*n+l.ty),this}bezierCurveTo(e,t,i,s,a,r,n){this._tick++;const l=this._transform;return this._activePath.bezierCurveTo(l.a*e+l.c*t+l.tx,l.b*e+l.d*t+l.ty,l.a*i+l.c*s+l.tx,l.b*i+l.d*s+l.ty,l.a*a+l.c*r+l.tx,l.b*a+l.d*r+l.ty,n),this}closePath(){return this._tick++,this._activePath?.closePath(),this}ellipse(e,t,i,s){return this._tick++,this._activePath.ellipse(e,t,i,s,this._transform.clone()),this}circle(e,t,i){return this._tick++,this._activePath.circle(e,t,i,this._transform.clone()),this}path(e){return this._tick++,this._activePath.addPath(e,this._transform.clone()),this}lineTo(e,t){this._tick++;const i=this._transform;return this._activePath.lineTo(i.a*e+i.c*t+i.tx,i.b*e+i.d*t+i.ty),this}moveTo(e,t){this._tick++;const i=this._transform,s=this._activePath.instructions,a=i.a*e+i.c*t+i.tx,r=i.b*e+i.d*t+i.ty;return s.length===1&&s[0].action==="moveTo"?(s[0].data[0]=a,s[0].data[1]=r,this):(this._activePath.moveTo(a,r),this)}quadraticCurveTo(e,t,i,s,a){this._tick++;const r=this._transform;return this._activePath.quadraticCurveTo(r.a*e+r.c*t+r.tx,r.b*e+r.d*t+r.ty,r.a*i+r.c*s+r.tx,r.b*i+r.d*s+r.ty,a),this}rect(e,t,i,s){return this._tick++,this._activePath.rect(e,t,i,s,this._transform.clone()),this}roundRect(e,t,i,s,a){return this._tick++,this._activePath.roundRect(e,t,i,s,a,this._transform.clone()),this}poly(e,t){return this._tick++,this._activePath.poly(e,t,this._transform.clone()),this}regularPoly(e,t,i,s,a=0,r){return this._tick++,this._activePath.regularPoly(e,t,i,s,a,r),this}roundPoly(e,t,i,s,a,r){return this._tick++,this._activePath.roundPoly(e,t,i,s,a,r),this}roundShape(e,t,i,s){return this._tick++,this._activePath.roundShape(e,t,i,s),this}filletRect(e,t,i,s,a){return this._tick++,this._activePath.filletRect(e,t,i,s,a),this}chamferRect(e,t,i,s,a,r){return this._tick++,this._activePath.chamferRect(e,t,i,s,a,r),this}star(e,t,i,s,a=0,r=0){return this._tick++,this._activePath.star(e,t,i,s,a,r,this._transform.clone()),this}svg(e){return this._tick++,ep(e,this),this}restore(){const e=this._stateStack.pop();return e&&(this._transform=e.transform,this._fillStyle=e.fillStyle,this._strokeStyle=e.strokeStyle),this}save(){return this._stateStack.push({transform:this._transform.clone(),fillStyle:{...this._fillStyle},strokeStyle:{...this._strokeStyle}}),this}getTransform(){return this._transform}resetTransform(){return this._transform.identity(),this}rotate(e){return this._transform.rotate(e),this}scale(e,t=e){return this._transform.scale(e,t),this}setTransform(e,t,i,s,a,r){return e instanceof _e?(this._transform.set(e.a,e.b,e.c,e.d,e.tx,e.ty),this):(this._transform.set(e,t,i,s,a,r),this)}transform(e,t,i,s,a,r){return e instanceof _e?(this._transform.append(e),this):(Zn.set(e,t,i,s,a,r),this._transform.append(Zn),this)}translate(e,t=e){return this._transform.translate(e,t),this}clear(){return this._activePath.clear(),this.instructions.length=0,this.resetTransform(),this.onUpdate(),this}onUpdate(){this._boundsDirty=!0,!this.dirty&&(this.emit("update",this,16),this.dirty=!0)}get bounds(){if(!this._boundsDirty)return this._bounds;this._boundsDirty=!1;const e=this._bounds;e.clear();for(let t=0;t<this.instructions.length;t++){const i=this.instructions[t],s=i.action;if(s==="fill"){const a=i.data;e.addBounds(a.path.bounds)}else if(s==="texture"){const a=i.data;e.addFrame(a.dx,a.dy,a.dx+a.dw,a.dy+a.dh,a.transform)}if(s==="stroke"){const a=i.data,r=a.style.alignment,n=a.style.width*(1-r),l=a.path.bounds;e.addFrame(l.minX-n,l.minY-n,l.maxX+n,l.maxY+n)}}return e}containsPoint(e){if(!this.bounds.containsPoint(e.x,e.y))return!1;const t=this.instructions;let i=!1;for(let s=0;s<t.length;s++){const a=t[s],r=a.data,n=r.path;if(!a.action||!n)continue;const l=r.style,h=n.shapePath.shapePrimitives;for(let c=0;c<h.length;c++){const d=h[c].shape;if(!l||!d)continue;const u=h[c].transform,f=u?u.applyInverse(e,np):e;if(a.action==="fill")i=d.contains(f.x,f.y);else{const _=l;i=d.strokeContains(f.x,f.y,_.width,_.alignment)}const m=r.hole;if(m){const _=m.shapePath?.shapePrimitives;if(_)for(let p=0;p<_.length;p++)_[p].shape.contains(f.x,f.y)&&(i=!1)}if(i)return!0}}return i}unload(){this.emit("unload",this);for(const e in this._gpuData)this._gpuData[e]?.destroy();this._gpuData=Object.create(null)}destroy(e=!1){if(this.destroyed)return;if(this.destroyed=!0,this._stateStack.length=0,this._transform=null,this.unload(),this.emit("destroy",this),this.removeAllListeners(),typeof e=="boolean"?e:e?.texture){const i=typeof e=="boolean"?e:e?.textureSource;this._fillStyle.texture&&(this._fillStyle.fill&&"uid"in this._fillStyle.fill?this._fillStyle.fill.destroy():this._fillStyle.texture.destroy(i)),this._strokeStyle.texture&&(this._strokeStyle.fill&&"uid"in this._strokeStyle.fill?this._strokeStyle.fill.destroy():this._strokeStyle.texture.destroy(i))}this._fillStyle=null,this._strokeStyle=null,this.instructions=null,this._activePath=null,this._bounds=null,this._stateStack=null,this.customShader=null,this._transform=null}};Ao.defaultFillStyle={color:16777215,alpha:1,texture:Z.WHITE,matrix:null,fill:null,textureSpace:"local"};Ao.defaultStrokeStyle={width:1,color:16777215,alpha:1,alignment:.5,miterLimit:10,cap:"butt",join:"miter",texture:Z.WHITE,matrix:null,fill:null,textureSpace:"local",pixelLine:!1};let qi=Ao;class lp{constructor(){this.isBatchable=!1}reset(){this.isBatchable=!1,this.context=null,this.graphicsData&&(this.graphicsData.destroy(),this.graphicsData=null)}destroy(){this.reset()}}class hp{constructor(){this.instructions=new yo}init(){this.instructions.reset()}destroy(){this.instructions.destroy(),this.instructions=null}}const Ro=class to{constructor(e){this._renderer=e,this._managedContexts=new La({renderer:e,type:"resource",name:"graphicsContext"})}init(e){to.defaultOptions.bezierSmoothness=e?.bezierSmoothness??to.defaultOptions.bezierSmoothness}getContextRenderData(e){return this.getGpuContext(e).graphicsData||this._initContextRenderData(e)}updateGpuContext(e){const t=e._gpuData,i=!!t[this._renderer.uid],s=t[this._renderer.uid]||this._initContext(e);return(e.dirty||!i)&&(i&&s.reset(),s.isBatchable=!1,e.dirty=!1),s}getGpuContext(e){return e._gpuData[this._renderer.uid]||this._initContext(e)}_initContextRenderData(e){const t=new hp,i=this.getGpuContext(e);return i.graphicsData=t,t.init(),t}_initContext(e){const t=new lp;return t.context=e,e._gpuData[this._renderer.uid]=t,this._managedContexts.add(e),t}destroy(){this._managedContexts.destroy(),this._renderer=null}};Ro.extension={type:[ge.CanvasSystem],name:"graphicsContext"};Ro.defaultOptions={bezierSmoothness:.5};let cp=Ro;class Ic{constructor(e,t){this.state=Jh.for2d(),this.renderer=e,this._adaptor=t,this.renderer.runners.contextChange.add(this),this._managedGraphics=new La({renderer:e,type:"renderable",priority:-1,name:"graphics"})}contextChange(){this._adaptor.contextChange(this.renderer)}validateRenderable(e){return!1}addRenderable(e,t){this._managedGraphics.add(e),this.renderer.renderPipes.batch.break(t),t.add(e)}updateRenderable(e){}execute(e){e.isRenderable&&this._adaptor.execute(this,e)}destroy(){this._managedGraphics.destroy(),this.renderer=null,this._adaptor.destroy(),this._adaptor=null}}Ic.extension={type:[ge.CanvasPipes],name:"graphics"};function dp(o,e,t){const i=(o>>24&255)/255;e[t++]=(o&255)/255*i,e[t++]=(o>>8&255)/255*i,e[t++]=(o>>16&255)/255*i,e[t++]=i}class up{constructor(){this.batches=[],this.batched=!1}destroy(){this.batches.forEach(e=>{ct.return(e)}),this.batches.length=0}}class Ac{constructor(e,t){this.state=Jh.for2d(),this.renderer=e,this._adaptor=t,this.renderer.runners.contextChange.add(this),this._managedGraphics=new La({renderer:e,type:"renderable",priority:-1,name:"graphics"})}contextChange(){this._adaptor.contextChange(this.renderer)}validateRenderable(e){const t=e.context,i=!!e._gpuData,a=this.renderer.graphicsContext.updateGpuContext(t);return!!(a.isBatchable||i!==a.isBatchable)}addRenderable(e,t){const s=this.renderer.graphicsContext.updateGpuContext(e.context);e.didViewUpdate&&this._rebuild(e),s.isBatchable?this._addToBatcher(e,t):(this.renderer.renderPipes.batch.break(t),t.add(e))}updateRenderable(e){const i=this._getGpuDataForRenderable(e).batches;for(let s=0;s<i.length;s++){const a=i[s];a._batcher.updateElement(a)}}execute(e){if(!e.isRenderable)return;const t=this.renderer,i=e.context;if(!t.graphicsContext.getGpuContext(i).batches.length)return;const a=i.customShader||this._adaptor.shader;this.state.blendMode=e.groupBlendMode;const r=a.resources.localUniforms.uniforms;r.uTransformMatrix=e.groupTransform,r.uRound=t._roundPixels|e._roundPixels,dp(e.groupColorAlpha,r.uColor,0),this._adaptor.execute(this,e)}_rebuild(e){const t=this._getGpuDataForRenderable(e),s=this.renderer.graphicsContext.updateGpuContext(e.context);t.destroy(),s.isBatchable&&this._updateBatchesForRenderable(e,t)}_addToBatcher(e,t){const i=this.renderer.renderPipes.batch,s=this._getGpuDataForRenderable(e).batches;for(let a=0;a<s.length;a++){const r=s[a];i.addToBatch(r,t)}}_getGpuDataForRenderable(e){return e._gpuData[this.renderer.uid]||this._initGpuDataForRenderable(e)}_initGpuDataForRenderable(e){const t=new up;return e._gpuData[this.renderer.uid]=t,this._managedGraphics.add(e),t}_updateBatchesForRenderable(e,t){const i=e.context,a=this.renderer.graphicsContext.getGpuContext(i),r=this.renderer._roundPixels|e._roundPixels;t.batches=a.batches.map(n=>{const l=ct.get(Mo);return n.copyTo(l),l.renderable=e,l.roundPixels=r,l})}destroy(){this._managedGraphics.destroy(),this.renderer=null,this._adaptor.destroy(),this._adaptor=null,this.state=null}}Ac.extension={type:[ge.WebGLPipes,ge.WebGPUPipes],name:"graphics"};Ze.add(Ic);Ze.add(Ac);Ze.add(cp);Ze.add(Io);class Ne extends Ah{constructor(e){e instanceof qi&&(e={context:e});const{context:t,roundPixels:i,...s}=e||{};super({label:"Graphics",...s}),this.renderPipeId="graphics",t?this.context=t:(this.context=this._ownedContext=new qi,this.context.autoGarbageCollect=this.autoGarbageCollect),this.didViewUpdate=!0,this.allowChildren=!1,this.roundPixels=i??!1}set context(e){e!==this._context&&(this._context&&(this._context.off("update",this.onViewUpdate,this),this._context.off("unload",this.unload,this)),this._context=e,this._context.on("update",this.onViewUpdate,this),this._context.on("unload",this.unload,this),this.onViewUpdate())}get context(){return this._context}get bounds(){return this._context.bounds}updateBounds(){}containsPoint(e){return this._context.containsPoint(e)}destroy(e){this._ownedContext&&!e?this._ownedContext.destroy(e):(e===!0||e?.context===!0)&&this._context.destroy(e),this._ownedContext=null,this._context=null,super.destroy(e)}_onTouch(e){this._gcLastUsed=e,this._context._gcLastUsed=e}_callContextMethod(e,t){return this.context[e](...t),this}setFillStyle(...e){return this._callContextMethod("setFillStyle",e)}setStrokeStyle(...e){return this._callContextMethod("setStrokeStyle",e)}fill(...e){return this._callContextMethod("fill",e)}stroke(...e){return this._callContextMethod("stroke",e)}texture(...e){return this._callContextMethod("texture",e)}beginPath(){return this._callContextMethod("beginPath",[])}cut(){return this._callContextMethod("cut",[])}arc(...e){return this._callContextMethod("arc",e)}arcTo(...e){return this._callContextMethod("arcTo",e)}arcToSvg(...e){return this._callContextMethod("arcToSvg",e)}bezierCurveTo(...e){return this._callContextMethod("bezierCurveTo",e)}closePath(){return this._callContextMethod("closePath",[])}ellipse(...e){return this._callContextMethod("ellipse",e)}circle(...e){return this._callContextMethod("circle",e)}path(...e){return this._callContextMethod("path",e)}lineTo(...e){return this._callContextMethod("lineTo",e)}moveTo(...e){return this._callContextMethod("moveTo",e)}quadraticCurveTo(...e){return this._callContextMethod("quadraticCurveTo",e)}rect(...e){return this._callContextMethod("rect",e)}roundRect(...e){return this._callContextMethod("roundRect",e)}poly(...e){return this._callContextMethod("poly",e)}regularPoly(...e){return this._callContextMethod("regularPoly",e)}roundPoly(...e){return this._callContextMethod("roundPoly",e)}roundShape(...e){return this._callContextMethod("roundShape",e)}filletRect(...e){return this._callContextMethod("filletRect",e)}chamferRect(...e){return this._callContextMethod("chamferRect",e)}star(...e){return this._callContextMethod("star",e)}svg(...e){return this._callContextMethod("svg",e)}restore(...e){return this._callContextMethod("restore",e)}save(){return this._callContextMethod("save",[])}getTransform(){return this.context.getTransform()}resetTransform(){return this._callContextMethod("resetTransform",[])}rotateTransform(...e){return this._callContextMethod("rotate",e)}scaleTransform(...e){return this._callContextMethod("scale",e)}setTransform(...e){return this._callContextMethod("setTransform",e)}transform(...e){return this._callContextMethod("transform",e)}translateTransform(...e){return this._callContextMethod("translate",e)}clear(){return this._callContextMethod("clear",[])}get fillStyle(){return this._context.fillStyle}set fillStyle(e){this._context.fillStyle=e}get strokeStyle(){return this._context.strokeStyle}set strokeStyle(e){this._context.strokeStyle=e}clone(e=!1){return e?new Ne(this._context.clone()):(this._ownedContext=null,new Ne(this._context))}lineStyle(e,t,i){Ie(je,"Graphics#lineStyle is no longer needed. Use Graphics#setStrokeStyle to set the stroke style.");const s={};return e&&(s.width=e),t&&(s.color=t),i&&(s.alpha=i),this.context.strokeStyle=s,this}beginFill(e,t){Ie(je,"Graphics#beginFill is no longer needed. Use Graphics#fill to fill the shape with the desired style.");const i={};return e!==void 0&&(i.color=e),t!==void 0&&(i.alpha=t),this.context.fillStyle=i,this}endFill(){Ie(je,"Graphics#endFill is no longer needed. Use Graphics#fill to fill the shape with the desired style."),this.context.fill();const e=this.context.strokeStyle;return(e.width!==qi.defaultStrokeStyle.width||e.color!==qi.defaultStrokeStyle.color||e.alpha!==qi.defaultStrokeStyle.alpha)&&this.context.stroke(),this}drawCircle(...e){return Ie(je,"Graphics#drawCircle has been renamed to Graphics#circle"),this._callContextMethod("circle",e)}drawEllipse(...e){return Ie(je,"Graphics#drawEllipse has been renamed to Graphics#ellipse"),this._callContextMethod("ellipse",e)}drawPolygon(...e){return Ie(je,"Graphics#drawPolygon has been renamed to Graphics#poly"),this._callContextMethod("poly",e)}drawRect(...e){return Ie(je,"Graphics#drawRect has been renamed to Graphics#rect"),this._callContextMethod("rect",e)}drawRoundedRect(...e){return Ie(je,"Graphics#drawRoundedRect has been renamed to Graphics#roundRect"),this._callContextMethod("roundRect",e)}drawStar(...e){return Ie(je,"Graphics#drawStar has been renamed to Graphics#star"),this._callContextMethod("star",e)}}Ze.add(pd,_d);const v={width:1280,height:720},L=32,Re=32,Te=16,Ei=64,ms=64,fp=8,rs={startX:512,startY:512,speed:120,sprintMultiplier:1.6,maxHealth:100,maxStamina:100,maxHunger:100,skinTone:"v01",hairstyle:"bob1",hairColor:"v01",outfit:"farmer"},mp=15,pp=2,Rc={stand:{row:0,col:0,frames:1,speed:200},push:{row:0,col:1,frames:2,speed:180},pull:{row:0,col:3,frames:2,speed:180},jump:{row:0,col:5,frames:4,speed:120},walk:{row:4,col:0,frames:6,speed:100},run:{row:4,col:6,frames:6,speed:80}},_p={0:0,1:1,2:2,3:3},gp={farmer:{pack:"20.01c - Peasant Farmer Pants & Hat 2.1 (comp. v01)",layer:"1out",code:"pfpn",variant:"v01"},angler:{pack:"20.04a - Angler Pants and Rain Hat 2.1 (comp. v01)",layer:"1out",code:"angl",variant:"v01"},blacksmith:{pack:"20.04b - Blacksmith Apron and Bandana 2.1 (comp. v01)",layer:"1out",code:"bksm",variant:"v01"},alchemist:{pack:"20.11a - Alchemist's Coat 2.1 (comp. v01)",layer:"1out",code:"alch",variant:"v01"}},yp={invulnerabilityTime:1.5},Nt={baseXPToLevel:100,xpLevelScaling:1.5,healthPerLevel:12,baseDamage:6,baseDefense:5,strDamageMultiplier:.7,defensePerLevel:2},Vt=42069,Sa={haven:{grass:["#5a9c4a","#4e8c3e","#6aac5a","#7bbc6b"],dirt:["#8b7355","#7a6245","#9c8465"],stone:["#888888","#777777","#999999"],water:["#4ab4e8","#3aa4d8","#5ac4f8"]},rotwood:{grass:["#4a6e3a","#3a5e2a","#5a7e4a"],dirt:["#5a4a3a","#4a3a2a","#6a5a4a"],stone:["#6a6a6a","#5a5a5a","#7a7a7a"],water:["#3a8a5a","#2a7a4a","#4a9a6a"]},ashlands:{grass:["#6a4a3a","#5a3a2a","#7a5a4a"],dirt:["#3a2a1a","#2a1a0a","#4a3a2a"],stone:["#4a4a4a","#3a3a3a","#5a5a5a"],water:["#8a3a2a","#7a2a1a","#9a4a3a"]},drowned_depths:{grass:["#2a5a5a","#1a4a4a","#3a6a6a"],dirt:["#3a4a5a","#2a3a4a","#4a5a6a"],stone:["#4a5a5a","#3a4a4a","#5a6a6a"],water:["#1a4a7a","#0a3a6a","#2a5a8a"]},bone_wastes:{grass:["#4a4a3a","#3a3a2a","#5a5a4a"],dirt:["#6a6a5a","#5a5a4a","#7a7a6a"],stone:["#8a8a7a","#7a7a6a","#9a9a8a"],water:["#3a3a4a","#2a2a3a","#4a4a5a"]},the_void:{grass:["#1a0a2a","#0a0020","#2a1a3a"],dirt:["#2a1a3a","#1a0a2a","#3a2a4a"],stone:["#3a2a4a","#2a1a3a","#4a3a5a"],water:["#1a0a4a","#0a0030","#2a1a5a"]},edilas:{grass:["#7acc6a","#6abc5a","#8adc7a"],dirt:["#cca87a","#bc986a","#dcb88a"],stone:["#aaaaaa","#999999","#bbbbbb"],water:["#55aadd","#4499cc","#66bbee"]}};class bp{_held=new Set;_pressed=new Set;_released=new Set;_snapshot={held:new Set,justPressed:new Set,justReleased:new Set,mouseX:0,mouseY:0,mouseDown:!1,mouseClicked:!1,wheelDelta:0};_mouseX=0;_mouseY=0;_mouseDown=!1;_mouseClicked=!1;_wheelDelta=0;_element;_onKeyDown;_onKeyUp;_onMouseMove;_onMouseDown;_onMouseUp;_onWheel;_onContextMenu;_onBlur;constructor(e){this._element=e,this._onKeyDown=t=>{t.repeat||(this._held.add(t.code),this._pressed.add(t.code))},this._onKeyUp=t=>{this._held.delete(t.code),this._released.add(t.code)},this._onMouseMove=t=>{const i=e.getBoundingClientRect();this._mouseX=t.clientX-i.left,this._mouseY=t.clientY-i.top},this._onMouseDown=()=>{this._mouseDown=!0,this._mouseClicked=!0},this._onMouseUp=()=>{this._mouseDown=!1},this._onWheel=t=>{t.preventDefault(),this._wheelDelta+=t.deltaY},this._onContextMenu=t=>t.preventDefault(),this._onBlur=()=>{this._held.clear(),this._mouseDown=!1},window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),e.addEventListener("mousemove",this._onMouseMove),e.addEventListener("mousedown",this._onMouseDown),e.addEventListener("mouseup",this._onMouseUp),e.addEventListener("wheel",this._onWheel,{passive:!1}),e.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("blur",this._onBlur)}destroy(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this._element.removeEventListener("mousemove",this._onMouseMove),this._element.removeEventListener("mousedown",this._onMouseDown),this._element.removeEventListener("mouseup",this._onMouseUp),this._element.removeEventListener("wheel",this._onWheel),this._element.removeEventListener("contextmenu",this._onContextMenu),window.removeEventListener("blur",this._onBlur)}update(){const e=this._snapshot.held,t=this._snapshot.justPressed,i=this._snapshot.justReleased;e.clear();for(const s of this._held)e.add(s);t.clear();for(const s of this._pressed)t.add(s);i.clear();for(const s of this._released)i.add(s);this._snapshot.mouseX=this._mouseX,this._snapshot.mouseY=this._mouseY,this._snapshot.mouseDown=this._mouseDown,this._snapshot.mouseClicked=this._mouseClicked,this._snapshot.wheelDelta=this._wheelDelta,this._pressed.clear(),this._released.clear(),this._mouseClicked=!1,this._wheelDelta=0}get state(){return this._snapshot}isHeld(e){return this._snapshot.held.has(e)}wasPressed(e){return this._snapshot.justPressed.has(e)}wasReleased(e){return this._snapshot.justReleased.has(e)}anyHeld(...e){return e.some(t=>this._snapshot.held.has(t))}get wheelDelta(){return this._snapshot.wheelDelta}}class wp{x=0;y=0;shakeX=0;shakeY=0;zoom=1;_shakeIntensity=0;_shakeDuration=0;_shakeTimer=0;_smoothing=.1;_zoomRange=[.5,2];_baseZoom=1;_zoomPulseAmount=0;_zoomPulseTimer=0;_zoomPulseDuration=0;applyConfig(e){this._smoothing=e.smoothing,this._zoomRange=e.zoomRange,this.zoom=Math.max(this._zoomRange[0],Math.min(this._zoomRange[1],this.zoom))}follow(e,t,i){const s=i??this._smoothing,a=e-v.width/2,r=t-v.height/2;this.x+=(a-this.x)*s,this.y+=(r-this.y)*s}snapTo(e,t){this.x=e-v.width/2,this.y=t-v.height/2}shake(e,t){t<=0||e<=0||(this._shakeIntensity=e,this._shakeDuration=t,this._shakeTimer=t)}adjustZoom(e){return this.zoom=Math.max(this._zoomRange[0],Math.min(this._zoomRange[1],this.zoom+e)),this._baseZoom=this.zoom,this.zoom}zoomPulse(e=.08,t=.2){this._baseZoom=this.zoom,this._zoomPulseAmount=e,this._zoomPulseDuration=t,this._zoomPulseTimer=t}update(e){if(this._shakeTimer>0){this._shakeTimer-=e;const t=this._shakeTimer/this._shakeDuration,i=this._shakeIntensity*t;this.shakeX=(Math.random()*2-1)*i,this.shakeY=(Math.random()*2-1)*i}else this.shakeX=0,this.shakeY=0;if(this._zoomPulseTimer>0){this._zoomPulseTimer-=e;const t=Math.max(0,this._zoomPulseTimer/this._zoomPulseDuration),i=t*t;this.zoom=this._baseZoom+this._zoomPulseAmount*i,this.zoom=Math.max(this._zoomRange[0],Math.min(this._zoomRange[1],this.zoom)),this._zoomPulseTimer<=0&&(this.zoom=this._baseZoom)}}get offsetX(){return-Math.round(this.x)+this.shakeX}get offsetY(){return-Math.round(this.y)+this.shakeY}}class vp{_cache=new Map;_pending=new Map;_basePath;constructor(e=""){this._basePath=e}load(e){const t=this._basePath+e,i=this._cache.get(t);if(i)return Promise.resolve(i);const s=this._pending.get(t);if(s)return s;const a=new Promise((r,n)=>{const l=new Image;l.onload=()=>{this._cache.set(t,l),this._pending.delete(t),r(l)},l.onerror=()=>{this._pending.delete(t),n(new Error(`Failed to load image: ${t}`))},l.src=t});return this._pending.set(t,a),a}async loadMany(e){const t=new Map,i=await Promise.allSettled(e.map(s=>this.load(s)));for(let s=0;s<e.length;s++){const a=i[s];a&&a.status==="fulfilled"&&t.set(e[s],a.value)}return t}async tryLoad(e){try{return await this.load(e)}catch{return null}}get(e){return this._cache.get(this._basePath+e)}has(e){return this._cache.has(this._basePath+e)}get size(){return this._cache.size}}class Sp{container;bgLayer;gameLayer;uiLayer;input;camera;loader;_pixiApp=null;_scene=null;_running=!1;_lastTime=0;_fps=0;_frameCount=0;_fpsTimer=0;_boundLoop;_slowFrameCount=0;constructor(e){this.container=e,e.style.position="relative",e.style.width=`${v.width}px`,e.style.height=`${v.height}px`,e.style.overflow="hidden",e.style.imageRendering="pixelated",e.style.backgroundColor="#000",this.bgLayer=this._createLayer("edilas-bg",1),this.gameLayer=this._createLayer("edilas-game",3),this.uiLayer=this._createLayer("edilas-ui",4),this.bgLayer.style.pointerEvents="none",this.gameLayer.style.pointerEvents="none",this.uiLayer.style.pointerEvents="none",this.input=new bp(e),this.camera=new wp,this.loader=new vp(""),this._boundLoop=this._loop.bind(this)}_createLayer(e,t){const i=document.createElement("div");return i.id=e,i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.width="100%",i.style.height="100%",i.style.zIndex=String(t),i.style.overflow="hidden",this.container.appendChild(i),i}async initPixi(){if(this._pixiApp){console.warn("[Game] PixiJS already initialized");return}const e=new vo;await e.init({width:v.width,height:v.height,backgroundColor:0,backgroundAlpha:1,antialias:!1,resolution:1,autoDensity:!1,preference:"webgl",clearBeforeRender:!0}),e.ticker.stop(),e.ticker.autoStart=!1;const t=e.canvas;t.id="edilas-pixi-canvas",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.imageRendering="pixelated",this.gameLayer.appendChild(t),this._pixiApp=e,console.log(`[Game] PixiJS Application initialized (${v.width}x${v.height})`)}get pixiApp(){return this._pixiApp}async setScene(e){this._scene&&this._scene.exit(),this._clearLayersPreservePixi(),this._scene=e,await e.enter(this.container)}setSceneDirect(e){this._scene&&this._scene!==e&&this._scene.exit(),this._clearLayersPreservePixi(),this._scene=e}_clearLayersPreservePixi(){this.bgLayer.innerHTML="",this.uiLayer.innerHTML="";const e=this._pixiApp?.canvas,t=Array.from(this.gameLayer.childNodes);for(const i of t)i!==e&&this.gameLayer.removeChild(i)}start(){this._running||(this._running=!0,this._lastTime=performance.now(),requestAnimationFrame(this._boundLoop),console.log("[Game] Loop started (DOM + PixiJS renderer)"))}stop(){this._running=!1}get fps(){return this._fps}_loop(e){if(!this._running)return;const t=Math.min((e-this._lastTime)/1e3,.1);if(this._lastTime=e,this._frameCount++,this._fpsTimer+=t,this._fpsTimer>=1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTimer=0),this.input.update(),this._scene)try{const i=performance.now();this._scene.update(t);const s=performance.now();this._scene.render(),this._pixiApp&&this._pixiApp.render();const a=performance.now(),r=s-i,n=a-s,l=a-i;l>50&&(this._slowFrameCount++,(this._slowFrameCount<=5||this._slowFrameCount%120===0)&&console.warn(`[Game] Slow frame #${this._slowFrameCount}: update=${r.toFixed(1)}ms render=${n.toFixed(1)}ms total=${l.toFixed(1)}ms`))}catch(i){console.error("[Game] Frame error:",i)}requestAnimationFrame(this._boundLoop)}}const Tt=["New Game","Continue","Settings","Credits"];class kp{_input;_time=0;_selected=0;_onStart;_onContinue;_hasSaveData;_transitioning=!1;_transitionAlpha=0;_isContinuing=!1;_root=null;_menuItems=[];_transitionOverlay=null;_nebulaGlow=null;_particles=[];constructor(e,t,i){this._input=e,this._onStart=t,this._onContinue=i??null;try{const s=localStorage.getItem("edilas_save_slots"),a=s?JSON.parse(s):[];this._hasSaveData=Array.isArray(a)&&a.length>0}catch{this._hasSaveData=!1}}enter(e){this._transitioning=!1,this._transitionAlpha=0,this._time=0,this._selected=0;const t=document.createElement("div");t.id="title-scene",t.style.cssText=`
            position: absolute; inset: 0;
            background: linear-gradient(180deg, #0a0c15 0%, #141828 30%, #1a1e35 60%, #0f1320 100%);
            font-family: 'Space Grotesk', 'Inter', monospace;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; color: #fff;
        `,this._root=t;for(let _=0;_<80;_++){const p=document.createElement("div"),g=_*137.5%v.width,y=_*97.3%(v.height*.6),S=_%10===0?3:1.5;p.style.cssText=`
                position: absolute; left: ${g}px; top: ${y}px;
                width: ${S}px; height: ${S}px;
                background: #fff; border-radius: 50%;
                opacity: 0.4;
                animation: twinkle ${1.5+_%5*.5}s ease-in-out ${_*.1%2}s infinite alternate;
            `,t.appendChild(p)}this._createForestLayer(t,"55%","#0a0d18",.8),this._createForestLayer(t,"62%","#0d1020",.6),this._createForestLayer(t,"70%","#111528",.4);const i=document.createElement("div");i.style.cssText=`
            position: absolute; bottom: 0; left: 0; right: 0; height: 25%;
            background: linear-gradient(transparent, rgba(20,24,40,0.6) 50%, rgba(10,12,21,0.95));
            pointer-events: none;
        `,t.appendChild(i);const s=document.createElement("div");s.style.cssText=`
            position: absolute; width: 600px; height: 600px;
            left: 50%; top: 20%; transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(125,211,252,0.06), rgba(212,160,48,0.03) 50%, transparent);
            border-radius: 50%; pointer-events: none;
            animation: nebulaFloat 8s ease-in-out infinite alternate;
        `,this._nebulaGlow=s,t.appendChild(s),this._particles=[];for(let _=0;_<40;_++){const p=document.createElement("div"),y=["ember","ash","orb"][_%3],b={ember:["#ff6b35","#ff4500","#ff8c00"],ash:["#888","#999","#aaa"],orb:["#7dd3fc","#93c5fd","#bae6fd"]}[y][_%3],w=y==="orb"?4+Math.random()*4:2+Math.random()*2,k=Math.random()*v.width,T=Math.random()*v.height;p.style.cssText=`
                position: absolute; left: ${k}px; top: ${T}px;
                width: ${w}px; height: ${w}px;
                background: ${b}; border-radius: 50%;
                opacity: ${.1+Math.random()*.4};
                ${y==="orb"?`box-shadow: 0 0 ${w*3}px ${b};`:""}
                pointer-events: none;
            `,t.appendChild(p),this._particles.push({el:p,vx:(Math.random()-.5)*15,vy:-Math.random()*30-10,alphaDir:(Math.random()-.5)*.6})}const a=document.createElement("div");a.style.cssText=`
            position: absolute; top: 140px; width: 100%;
            text-align: center; z-index: 5;
            animation: fadeInDown 1.2s ease-out forwards;
            opacity: 0;
        `;const r=document.createElement("div");r.style.cssText=`
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
            width: 400px; height: 120px;
            background: radial-gradient(circle, rgba(212,160,48,0.12), transparent);
            pointer-events: none;
        `,a.appendChild(r);const n=document.createElement("h1");n.textContent="EDILAS",n.style.cssText=`
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(32px, 4vw, 48px); margin: 0;
            letter-spacing: 8px;
            background: linear-gradient(90deg, #d4a030, #f5d680, #d4a030);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: none;
            filter: drop-shadow(3px 3px 0 rgba(0,0,0,0.5));
        `,a.appendChild(n);const l=document.createElement("div");l.textContent="THE  LIVING  PILGRIMAGE",l.style.cssText=`
            font-size: 12px; letter-spacing: 4px; margin-top: 8px;
            color: rgba(212,160,48,0.6);
            animation: fadeIn 1.5s ease-out 0.5s forwards, subtitleGlow 4s ease-in-out 2s infinite alternate;
            opacity: 0;
        `,a.appendChild(l);const h=document.createElement("div");h.style.cssText=`
            width: 200px; height: 1px; margin: 16px auto 0;
            background: linear-gradient(90deg, transparent, rgba(212,160,48,0.7), transparent);
            animation: lineExpand 1.5s ease-out 0.8s forwards;
            transform: scaleX(0);
        `,a.appendChild(h);const c=document.createElement("div");c.textContent="Cleanse the corruption. Reach the paradise.",c.style.cssText=`
            font-size: 9px; letter-spacing: 2px; margin-top: 12px;
            color: rgba(180,200,220,0.35);
            font-style: italic;
            animation: fadeIn 2s ease-out 1.5s forwards;
            opacity: 0;
        `,a.appendChild(c),t.appendChild(a);const d=document.createElement("div");d.id="title-menu",d.style.cssText=`
            position: absolute; top: 320px; width: 100%;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            z-index: 5;
            animation: fadeInUp 1s ease-out 0.6s forwards;
            opacity: 0;
        `,this._menuItems=[];for(let _=0;_<Tt.length;_++){const p=document.createElement("div");p.id=`menu-${Tt[_].toLowerCase().replace(" ","-")}`,p.dataset.index=String(_),p.textContent=Tt[_],p.style.cssText=`
                font-size: 14px; padding: 10px 40px;
                cursor: pointer; transition: all 0.2s ease;
                color: rgba(255,255,255,0.4);
                position: relative; user-select: none;
            `,p.addEventListener("mouseenter",()=>{this._selected=_,this._updateMenu()}),p.addEventListener("click",()=>{this._selected=_,this._selectOption()}),d.appendChild(p),this._menuItems.push(p)}t.appendChild(d),this._updateMenu();const u=document.createElement("div");u.style.cssText=`
            position: absolute; bottom: 12px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 20px;
            font-size: 9px; color: rgba(255,255,255,0.2);
            z-index: 5; box-sizing: border-box;
            animation: fadeIn 1s ease-out 1s forwards; opacity: 0;
        `,u.innerHTML=`
            <span> Navigate    Enter Select</span>
            <span>TS strict + DOM renderer + bitecs  |  v2.0.0</span>
        `,t.appendChild(u);const f=document.createElement("div");f.id="title-transition",f.style.cssText=`
            position: absolute; inset: 0; background: #000;
            opacity: 0; pointer-events: none; z-index: 10;
            transition: opacity 0.5s ease;
        `,this._transitionOverlay=f,t.appendChild(f);const m=document.createElement("style");m.textContent=`
            @keyframes twinkle {
                0% { opacity: 0.15; }
                100% { opacity: 0.7; }
            }
            @keyframes nebulaFloat {
                0% { transform: translate(-50%, -50%) translate(0, 0); }
                100% { transform: translate(-50%, -50%) translate(50px, 30px); }
            }
            @keyframes fadeInDown {
                0% { opacity: 0; transform: translateY(-20px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeInUp {
                0% { opacity: 0; transform: translateY(20px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            @keyframes fadeIn {
                0% { opacity: 0; }
                100% { opacity: 1; }
            }
            @keyframes menuPulse {
                0% { text-shadow: 0 0 8px rgba(212,160,48,0.3); }
                50% { text-shadow: 0 0 16px rgba(212,160,48,0.5); }
                100% { text-shadow: 0 0 8px rgba(212,160,48,0.3); }
            }
            @keyframes subtitleGlow {
                0% { color: rgba(212,160,48,0.5); letter-spacing: 4px; }
                100% { color: rgba(212,160,48,0.75); letter-spacing: 5px; }
            }
            @keyframes lineExpand {
                0% { transform: scaleX(0); opacity: 0; }
                100% { transform: scaleX(1); opacity: 1; }
            }
            @keyframes selectFlash {
                0% { background: transparent; }
                50% { background: rgba(212,160,48,0.15); }
                100% { background: transparent; }
            }
        `,t.appendChild(m),e.appendChild(t)}exit(){this._root?.remove(),this._root=null,this._menuItems=[],this._particles=[]}_updateMenu(){for(let e=0;e<this._menuItems.length;e++){const t=this._menuItems[e];Tt[e]==="Continue"&&!this._hasSaveData?(t.style.color="rgba(255,255,255,0.15)",t.style.fontSize="14px",t.style.animation="none",t.style.cursor="default",t.textContent=Tt[e]):e===this._selected?(t.style.color="#f5d680",t.style.fontSize="16px",t.style.animation="menuPulse 2s ease-in-out infinite",t.style.cursor="pointer",t.innerHTML=` ${Tt[e]} `):(t.style.color="rgba(255,255,255,0.4)",t.style.fontSize="14px",t.style.animation="none",t.style.cursor="pointer",t.textContent=Tt[e])}}_selectOption(){const e=Tt[this._selected];if(e==="New Game"){this._isContinuing=!1,this._transitioning=!0;const t=this._menuItems[this._selected];t&&(t.style.animation="selectFlash 0.3s ease-out")}else if(e==="Continue"&&this._hasSaveData&&this._onContinue){this._isContinuing=!0,this._transitioning=!0;const t=this._menuItems[this._selected];t&&(t.style.animation="selectFlash 0.3s ease-out")}}update(e){if(this._time+=e,this._transitioning&&(this._transitionAlpha=Math.min(1,this._transitionAlpha+e*2),this._transitionOverlay&&(this._transitionOverlay.style.opacity=String(this._transitionAlpha)),this._transitionAlpha>=1)){this._isContinuing&&this._onContinue?this._onContinue():this._onStart();return}for(const t of this._particles){const i=t.el;let s=parseFloat(i.style.left)+t.vx*e,a=parseFloat(i.style.top)+t.vy*e;a<-10&&(a=v.height+10,s=Math.random()*v.width),s<-10&&(s=v.width+10),s>v.width+10&&(s=-10),i.style.left=`${s}px`,i.style.top=`${a}px`}this._transitioning||((this._input.wasPressed("ArrowUp")||this._input.wasPressed("KeyW"))&&(this._selected=(this._selected-1+Tt.length)%Tt.length,this._updateMenu()),(this._input.wasPressed("ArrowDown")||this._input.wasPressed("KeyS"))&&(this._selected=(this._selected+1)%Tt.length,this._updateMenu()),(this._input.wasPressed("Enter")||this._input.wasPressed("Space"))&&this._selectOption())}render(){}_createForestLayer(e,t,i,s){const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("viewBox",`0 0 ${v.width} 200`),a.style.cssText=`
            position: absolute; left: 0; top: ${t}; width: 100%;
            height: auto; opacity: ${s}; pointer-events: none;
        `;let r="M 0 200 ";for(let l=0;l<=v.width;l+=25){const h=80+Math.sin(l*.05)*20+Math.sin(l*.02)*15;r+=`L ${l-8} 200 L ${l} ${200-h} L ${l+8} 200 `}r+=`L ${v.width} 200 Z`;const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d",r),n.setAttribute("fill",i),a.appendChild(n),e.appendChild(a)}}const zs=["Corruption spreads at night  plan your travels wisely.","Each class has unique skills. Experiment to find your playstyle.","NPCs remember your gifts. Build relationships for better trades.","Hold SHIFT to dodge-roll through enemy attacks.","Press Q to check your quest log at any time.","Colony buildings purify nearby corruption automatically.","Fishing is most rewarding during rainy weather.","Perfect parries reflect damage back at enemies.","Some crops only grow in certain seasons.","Explore dungeons for rare loot and crafting materials."];class Tp{_progress=0;_targetProgress=0;_text="Preparing the world...";_time=0;_dots=0;_dotTimer=0;_tipIndex=Math.floor(Math.random()*zs.length);_tipTimer=0;_tipFadeTimer=null;_root=null;_barFill=null;_barShine=null;_textEl=null;_percentEl=null;_tipEl=null;enter(e){this._progress=0,this._targetProgress=0,this._time=0;const t=document.createElement("div");t.id="loading-scene",t.style.cssText=`
            position: absolute; inset: 0;
            background: linear-gradient(180deg, #0a0c15 0%, #111528 50%, #0c0f1a 100%);
            font-family: 'Space Grotesk', monospace;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden; color: #fff;
        `,this._root=t;for(let u=0;u<20;u++){const f=document.createElement("div"),m=Math.random()*v.width,_=Math.random()*v.height,p=1+Math.random()*2,y=["#d4a030","#7dd3fc","#888"][u%3];f.style.cssText=`
                position: absolute; left: ${m}px; top: ${_}px;
                width: ${p}px; height: ${p}px;
                background: ${y}; border-radius: 50%;
                opacity: ${.1+Math.random()*.3};
                pointer-events: none;
                animation: loadFloat ${4+Math.random()*4}s ease-in-out ${Math.random()*2}s infinite alternate;
            `,t.appendChild(f)}const i=document.createElement("div");i.style.cssText=`
            position: absolute; width: 600px; height: 600px;
            left: 50%; top: 50%; transform: translate(-50%, -50%);
            background: radial-gradient(circle, rgba(212,160,48,0.06), transparent);
            border-radius: 50%; pointer-events: none;
            animation: loadGlowPulse 3s ease-in-out infinite alternate;
        `,t.appendChild(i);const s=document.createElement("div");s.style.cssText=`
            font-family: 'Press Start 2P', monospace;
            font-size: 28px; font-weight: bold;
            background: linear-gradient(90deg, #d4a030, #f5d680, #d4a030);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.5));
            animation: loadTitlePulse 2s ease-in-out infinite alternate;
        `,s.textContent="EDILAS",t.appendChild(s);const a=document.createElement("div");a.style.cssText=`
            width: 300px; height: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 5px;
            border: 1px solid rgba(212,160,48,0.3);
            overflow: hidden; position: relative;
        `;const r=document.createElement("div");r.style.cssText=`
            width: 0%; height: 100%;
            background: linear-gradient(180deg, #d4a030, #8b6914);
            border-radius: 5px;
            transition: width 0.3s ease;
        `,this._barFill=r,a.appendChild(r);const n=document.createElement("div");n.style.cssText=`
            position: absolute; top: 0; left: 0;
            width: 0%; height: 50%;
            background: rgba(255,255,255,0.15);
            border-radius: 5px 5px 0 0;
            transition: width 0.3s ease;
        `,this._barShine=n,a.appendChild(n),t.appendChild(a);const l=document.createElement("div");l.style.cssText=`
            font-size: 11px; color: rgba(255,255,255,0.6);
            margin-top: 14px;
        `,this._textEl=l,t.appendChild(l);const h=document.createElement("div");h.style.cssText=`
            font-size: 10px; color: rgba(212,160,48,0.5);
            margin-top: 8px;
        `,this._percentEl=h,t.appendChild(h);const c=document.createElement("div");c.style.cssText=`
            position: absolute; bottom: 40px;
            width: 80%; text-align: center;
            font-size: 10px; color: rgba(255,255,255,0.35);
            font-style: italic;
            transition: opacity 0.5s ease;
        `,c.textContent=`TIP: ${zs[this._tipIndex]}`,this._tipEl=c,t.appendChild(c);const d=document.createElement("style");d.textContent=`
            @keyframes loadFloat {
                0% { transform: translateY(0) translateX(0); }
                100% { transform: translateY(-20px) translateX(10px); }
            }
            @keyframes loadGlowPulse {
                0% { opacity: 0.6; transform: translate(-50%, -50%) scale(0.95); }
                100% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
            }
            @keyframes loadTitlePulse {
                0% { filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.5)); }
                100% { filter: drop-shadow(2px 2px 4px rgba(212,160,48,0.3)); }
            }
        `,t.appendChild(d),e.appendChild(t)}exit(){this._tipFadeTimer&&(clearTimeout(this._tipFadeTimer),this._tipFadeTimer=null),this._root?.remove(),this._root=null}setProgress(e,t){this._targetProgress=Math.min(100,e),this._text=t}update(e){this._time+=e,this._progress+=(this._targetProgress-this._progress)*e*4,this._dotTimer+=e,this._dotTimer>.4&&(this._dotTimer=0,this._dots=(this._dots+1)%4),this._tipTimer+=e,this._tipTimer>5&&(this._tipTimer=0,this._tipIndex=(this._tipIndex+1)%zs.length,this._tipEl&&(this._tipEl.style.opacity="0",this._tipFadeTimer&&clearTimeout(this._tipFadeTimer),this._tipFadeTimer=setTimeout(()=>{this._tipFadeTimer=null,this._tipEl&&(this._tipEl.textContent=`TIP: ${zs[this._tipIndex]}`,this._tipEl.style.opacity="1")},300)))}render(){const e=Math.max(3,this._progress);this._barFill&&(this._barFill.style.width=`${e}%`),this._barShine&&(this._barShine.style.width=`${e}%`),this._textEl&&(this._textEl.textContent=`${this._text}${".".repeat(this._dots)}`),this._percentEl&&(this._percentEl.textContent=`${Math.floor(this._progress)}%`)}}var Di={ui8:"ui8",i16:"i16",ui16:"ui16",ui32:"ui32",f32:"f32",eid:"eid"},Jn={i8:"Int8",ui8:"Uint8",ui8c:"Uint8Clamped",i16:"Int16",ui16:"Uint16",i32:"Int32",ui32:"Uint32",eid:"Uint32",f32:"Float32",f64:"Float64"},fi={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},el={uint8:2**8,uint16:2**16},Mp=o=>e=>Math.ceil(e/o)*o,Cp=Mp(4),Pp=Symbol("storeRef"),io=Symbol("storeSize"),Ip=Symbol("storeMaps"),pi=Symbol("storeFlattened"),Xs=Symbol("storeBase"),Ap=Symbol("storeType"),xc=Symbol("storeArrayElementCounts"),_a=Symbol("storeSubarrays"),Ec=Symbol("subarrayCursors"),Rp=Symbol("subarray"),so=Symbol("parentArray"),Dc=Symbol("tagStore"),tl=Symbol("indexType"),il=Symbol("indexBytes"),Fc=Symbol("isEidType"),Lt={},xp=(o,e)=>{if(ArrayBuffer.isView(o))o[e]=o.slice(0);else{const t=o[so].slice(0);o[e]=o.map((i,s)=>{const{length:a}=o[s],r=a*s,n=r+a;return t.subarray(r,n)})}},Ep=(o,e)=>{o[pi]&&o[pi].forEach(t=>{ArrayBuffer.isView(t)?t[e]=0:t[e].fill(0)})},Dp=(o,e)=>{const t=e*fi[o].BYTES_PER_ELEMENT,i=new ArrayBuffer(t),s=new fi[o](i);return s[Fc]=o===Di.eid,s},Fp=(o,e,t)=>{const i=o[io],s=Array(i).fill(0);s[Ap]=e,s[Fc]=e===Di.eid;const a=o[Ec],r=t<=el.uint8?Di.ui8:t<=el.uint16?Di.ui16:Di.ui32;if(!t)throw new Error("bitECS - Must define component array length");if(!fi[e])throw new Error(`bitECS - Invalid component array property type ${e}`);if(!o[_a][e]){const h=o[xc][e],c=new fi[e](Cp(h*i));c[tl]=Jn[r],c[il]=fi[r].BYTES_PER_ELEMENT,o[_a][e]=c}const n=a[e],l=n+i*t;a[e]=l,s[so]=o[_a][e].subarray(n,l);for(let h=0;h<i;h++){const c=t*h,d=c+t;s[h]=s[so].subarray(c,d),s[h][tl]=Jn[r],s[h][il]=fi[r].BYTES_PER_ELEMENT,s[h][Rp]=!0}return s},sl=o=>Array.isArray(o)&&typeof o[0]=="string"&&typeof o[1]=="number",$p=(o,e)=>{const t=Symbol("store");if(!o||!Object.keys(o).length)return Lt[t]={[io]:e,[Dc]:!0,[Xs]:()=>Lt[t]},Lt[t];o=JSON.parse(JSON.stringify(o));const i={},s=r=>{const n=Object.keys(r);for(const l of n)sl(r[l])?(i[r[l][0]]||(i[r[l][0]]=0),i[r[l][0]]+=r[l][1]):r[l]instanceof Object&&s(r[l])};s(o);const a={[io]:e,[Ip]:{},[_a]:{},[Pp]:t,[Ec]:Object.keys(fi).reduce((r,n)=>({...r,[n]:0}),{}),[pi]:[],[xc]:i};if(o instanceof Object&&Object.keys(o).length){const r=(n,l)=>{if(typeof n[l]=="string")n[l]=Dp(n[l],e),n[l][Xs]=()=>Lt[t],a[pi].push(n[l]);else if(sl(n[l])){const[h,c]=n[l];n[l]=Fp(a,h,c),n[l][Xs]=()=>Lt[t],a[pi].push(n[l])}else n[l]instanceof Object&&(n[l]=Object.keys(n[l]).reduce(r,n[l]));return n};return Lt[t]=Object.assign(Object.keys(o).reduce(r,o),a),Lt[t][Xs]=()=>Lt[t],Lt[t]}},os=()=>{const o=[],e=[];o.sort=function(r){const n=Array.prototype.sort.call(this,r);for(let l=0;l<o.length;l++)e[o[l]]=l;return n};const t=r=>o[e[r]]===r;return{add:r=>{t(r)||(e[r]=o.push(r)-1)},remove:r=>{if(!t(r))return;const n=e[r],l=o.pop();l!==r&&(o[n]=l,e[l]=n)},has:t,sparse:e,dense:o,reset:()=>{o.length=0,e.length=0}}},Qt=Symbol("entityMasks"),Wa=Symbol("entityComponents"),yi=Symbol("entitySparseSet"),ps=Symbol("entityArray"),Lp=1e5,ao=0,$c=Lp,xo=()=>$c,ns=[],Bp=.01,Wp=Bp,Np=()=>ao,Op=new Map,Is=o=>{const e=o[Bo]?ns.length?ns.shift():ao++:ns.length>Math.round($c*Wp)?ns.shift():ao++;if(e>o[Lo])throw new Error("bitECS - max entities reached");return o[yi].add(e),Op.set(e,o),o[Eo].forEach(t=>{Fo(o,t,e)&&$o(t,e)}),o[Wa].set(e,new Set),e},Lc=(o,e)=>{if(o[yi].has(e)){o[Na].forEach(t=>{Nc(o,t,e)}),o[Bo]||ns.push(e),o[yi].remove(e),o[Wa].delete(e),o[Oc].delete(o[no].get(e)),o[no].delete(e);for(let t=0;t<o[Qt].length;t++)o[Qt][t][e]=0}},Gp=Symbol("$modifier"),Na=Symbol("queries"),Eo=Symbol("notQueries"),Hp=Symbol("queryAny"),zp=Symbol("queryAll"),Xp=Symbol("queryNone"),Zt=Symbol("queryMap"),_s=Symbol("$dirtyQueries"),Bc=Symbol("queryComponents"),Wc=Object.freeze([]),Vp=o=>e=>{e[Zt].has(o)||Do(e,o);const t=e[Zt].get(o);if(t.entered.dense.length===0)return Wc;{const i=t.entered.dense.slice();return t.entered.reset(),i}},qp=o=>e=>{e[Zt].has(o)||Do(e,o);const t=e[Zt].get(o);if(t.exited.dense.length===0)return Wc;{const i=t.exited.dense.slice();return t.exited.reset(),i}},Do=(o,e)=>{const t=[],i=[],s=[];e[Bc].forEach(w=>{if(typeof w=="function"&&w[Gp]){const[k,T]=w();o[zt].has(k)||ro(o,k),T==="not"&&i.push(k),T==="changed"&&(s.push(k),t.push(k))}else o[zt].has(w)||ro(o,w),t.push(w)});const a=w=>o[zt].get(w),r=t.concat(i).map(a),n=os(),l=[],h=[],c=os(),d=os(),u=os(),f=r.map(w=>w.generationId).reduce((w,k)=>(w.includes(k)||w.push(k),w),[]),m=(w,k)=>(w[k.generationId]||(w[k.generationId]=0),w[k.generationId]|=k.bitflag,w),_=t.map(a).reduce(m,{}),p=i.map(a).reduce(m,{}),g=r.reduce(m,{}),y=t.filter(w=>!w[Dc]).map(w=>Object.getOwnPropertySymbols(w).includes(pi)?w[pi]:[w]).reduce((w,k)=>w.concat(k),[]),b=Object.assign(n,{archetypes:l,changed:h,components:t,notComponents:i,changedComponents:s,allComponents:r,masks:_,notMasks:p,hasMasks:g,generations:f,flatProps:y,toRemove:c,entered:d,exited:u,shadows:[]});o[Zt].set(e,b),o[Na].add(b),r.forEach(w=>{w.queries.add(b)}),i.length&&o[Eo].add(b);for(let w=0;w<Np();w++){if(!o[yi].has(w))continue;Fo(o,b,w)&&$o(b,w)}},Yp=(o,e)=>{const t=Symbol(),i=o.flatProps[e];return xp(i,t),o.shadows[e]=i[t],i[t]},Up=(o,e)=>{e&&(o.changed=[]);const{flatProps:t,shadows:i}=o;for(let s=0;s<o.dense.length;s++){const a=o.dense[s];let r=!1;for(let n=0;n<t.length;n++){const l=t[n],h=i[n]||Yp(o,n);if(ArrayBuffer.isView(l[a])){for(let c=0;c<l[a].length;c++)if(l[a][c]!==h[a][c]){r=!0;break}h[a].set(l[a])}else l[a]!==h[a]&&(r=!0,h[a]=l[a])}r&&o.changed.push(a)}return o.changed},St=(...o)=>{let e,t,i,s;if(Array.isArray(o[0])&&(e=o[0]),e===void 0||e[zt]!==void 0)return r=>r?r[ps]:e[ps];const a=function(r,n=!0){r[Zt].has(a)||Do(r,a);const l=r[Zt].get(a);return Kp(r),l.changedComponents.length?Up(l,n):l.dense};return a[Bc]=e,a[Hp]=t,a[zp]=i,a[Xp]=s,a},Fo=(o,e,t)=>{const{masks:i,notMasks:s,generations:a}=e;for(let r=0;r<a.length;r++){const n=a[r],l=i[n],h=s[n],c=o[Qt][n][t];if(h&&(c&h)!==0||l&&(c&l)!==l)return!1}return!0},$o=(o,e)=>{o.toRemove.remove(e),o.entered.add(e),o.add(e)},jp=o=>{for(let e=o.toRemove.dense.length-1;e>=0;e--){const t=o.toRemove.dense[e];o.toRemove.remove(t),o.remove(t)}},Kp=o=>{o[_s].size&&(o[_s].forEach(jp),o[_s].clear())},Nc=(o,e,t)=>{!e.has(t)||e.toRemove.has(t)||(e.toRemove.add(t),o[_s].add(e),e.exited.add(t))},zt=Symbol("componentMap"),ze=(o,e)=>{const t=$p(o,xo());return o&&Object.keys(o).length,t},Qp=o=>{o[gs]*=2,o[gs]>=2**31&&(o[gs]=1,o[Qt].push(new Uint32Array(o[Lo])))},ro=(o,e)=>{if(!e)throw new Error("bitECS - Cannot register null or undefined component");const t=new Set,i=new Set,s=new Set;o[Na].forEach(a=>{a.allComponents.includes(e)&&t.add(a)}),o[zt].set(e,{generationId:o[Qt].length-1,bitflag:o[gs],store:e,queries:t,notQueries:i,changedQueries:s}),Qp(o)},oo=(o,e,t)=>{const i=o[zt].get(e);if(!i)return!1;const{generationId:s,bitflag:a}=i;return(o[Qt][s][t]&a)===a},ce=(o,e,t,i=!1)=>{if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!o[yi].has(t))throw new Error("bitECS - entity does not exist in the world.");if(o[zt].has(e)||ro(o,e),oo(o,e,t))return;const s=o[zt].get(e),{generationId:a,bitflag:r,queries:n,notQueries:l}=s;o[Qt][a][t]|=r,n.forEach(h=>{h.toRemove.remove(t);const c=Fo(o,h,t);c&&(h.exited.remove(t),$o(h,t)),c||(h.entered.remove(t),Nc(o,h,t))}),o[Wa].get(t).add(e),i&&Ep(e,t)},Lo=Symbol("size"),gs=Symbol("bitflag"),Zp=Symbol("archetypes"),Oc=Symbol("localEntities"),no=Symbol("localEntityLookup"),Bo=Symbol("manualEntityRecycling"),Jp=(...o)=>{const e=typeof o[0]=="object"?o[0]:{},t=typeof o[0]=="number"?o[0]:typeof o[1]=="number"?o[1]:xo();return e_(e,t),e},e_=(o,e=xo())=>(o[Lo]=e,o[ps]&&o[ps].forEach(t=>Lc(o,t)),o[Qt]=[new Uint32Array(e)],o[Wa]=new Map,o[Zp]=[],o[yi]=os(),o[ps]=o[yi].dense,o[gs]=1,o[zt]=new Map,o[Zt]=new Map,o[Na]=new Set,o[Eo]=new Set,o[_s]=new Set,o[Oc]=new Map,o[no]=new Map,o[Bo]=!1,o),re=Di;function t_(){return Jp()}const j=ze({x:re.f32,y:re.f32}),U=ze({vx:re.f32,vy:re.f32}),ye=ze({textureId:re.ui16,width:re.ui16,height:re.ui16,frame:re.ui16,totalFrames:re.ui8,flipX:re.ui8}),Vs=ze({screenX:re.f32,screenY:re.f32,depth:re.f32}),Mt=ze({animId:re.ui8,frame:re.ui8,timer:re.f32,speed:re.f32,totalFrames:re.ui8,loop:re.ui8}),Ge=ze({dir:re.ui8}),x=ze({current:re.f32,max:re.f32}),ke=ze({current:re.f32,max:re.f32}),Qe=ze({current:re.f32,max:re.f32}),Cs=ze({amount:re.f32,attackRange:re.f32,cooldown:re.f32,timer:re.f32}),lo=ze({range:re.f32}),vt=ze({timer:re.f32,baseCooldown:re.f32}),xe=ze({value:re.ui8}),Bt=ze({vx:re.f32,vy:re.f32,damage:re.f32,life:re.f32,size:re.f32,sourceEid:re.ui32,piercing:re.ui8}),Wi=ze({count:re.ui8}),ui=ze({tileX:re.i16,tileY:re.i16,widthTiles:re.ui8,heightTiles:re.ui8}),Oa=ze(),Ga=ze(),Gc=ze(),Wo=ze(),i_=ze(),s_=St([j,U]);function pr(o,e){const t=s_(o);for(let i=0;i<t.length;i++){const s=t[i];j.x[s]+=U.vx[s]*e,j.y[s]+=U.vy[s]*e,U.vx[s]=0,U.vy[s]=0}}const al=St([Ga,j,x,xe]),a_=St([Gc,j,xe]);St([Oa,j]);class r_{_enemies=new Map;_npcs=new Map;registerEnemy(e){this._enemies.set(e.eid,e)}registerNPC(e){this._npcs.set(e.eid,e)}unregisterEnemy(e){this._enemies.delete(e)}unregisterNPC(e){this._npcs.delete(e)}getEnemy(e){return this._enemies.get(e)}getNPC(e){return this._npcs.get(e)}get enemyCount(){return this._enemies.size}get npcCount(){return this._npcs.size}updateEnemyAI(e,t,i,s,a=64e4,r=14400){const n=al(e);let l=0;for(let h=0;h<n.length;h++){const c=n[h];if((xe.value[c]??0)===0)continue;const d=this._enemies.get(c);if(!d||!d.alive||d.updateKnockback(t))continue;const f=j.x[c]??0,m=j.y[c]??0,_=f-i,p=m-s;if(_*_+p*p<a){const y=d.def.behavior;let S;if(y==="pack"||y==="support"){S=[];for(let b=0;b<n.length;b++){if(h===b)continue;const w=n[b];if((xe.value[w]??0)===0)continue;const k=this._enemies.get(w);if(!k||!k.alive)continue;const T=(j.x[w]??0)-f,M=(j.y[w]??0)-m;if(T*T+M*M<r&&(S.push(k),S.length>=5))break}}d.updateAI(t,i,s,S),l++}}return l}updateNPCAI(e,t,i,s,a,r,n=25e4){const l=a_(e);let h=0;for(let c=0;c<l.length;c++){const d=l[c],u=this._npcs.get(d);if(!u)continue;const f=(j.x[d]??0)-i,m=(j.y[d]??0)-s;f*f+m*m<n&&(u.updateAI(t,a,r),h++)}return h}pruneDeadEnemies(e){const t=[],i=al(e),s=new Set;for(let a=0;a<i.length;a++){const r=i[a];(xe.value[r]??0)===1&&s.add(r)}for(const[a]of this._enemies)if(!s.has(a)){const r=this._enemies.get(a);r&&!r.alive&&t.push(a)}for(const a of t)this._enemies.delete(a);return t}clear(){this._enemies.clear(),this._npcs.clear()}}const o_=St([Wo,ui,x,xe]);St([Wo,ui]);function n_(o,e,t,i){const s=o_(o),a=i*i,r=[];for(let n=0;n<s.length;n++){const l=s[n];if((xe.value[l]??0)===0)continue;const h=j.x[l]??0,c=j.y[l]??0,d=h-e,u=c-t;d*d+u*u<=a&&r.push(l)}return r}const Hc=St([Oa,x,ke,Qe,xe]),l_=.5,h_=8,c_=3,d_=.5,u_=.6,f_=1;function m_(o,e,t,i,s=15){const a=Hc(o);if(a.length===0)return{hungerChanged:!1,staminaChanged:!1,healthChanged:!1,isStarving:!1};const r=a[0];if((xe.value[r]??0)===0)return{hungerChanged:!1,staminaChanged:!1,healthChanged:!1,isStarving:!1};let n=!1,l=!1,h=!1;const c=Qe.current[r]??50,d=Qe.max[r]??100,u=ke.current[r]??100,f=ke.max[r]??100,m=x.current[r]??100,_=x.max[r]??100;if(t>0){const y=l_*t,S=Math.max(0,c-y);S!==c&&(Qe.current[r]=S,n=!0)}const p=(Qe.current[r]??0)/d,g=p<=0;if(i){const y=s*e,S=Math.max(0,u-y);S!==u&&(ke.current[r]=S,l=!0)}else{const S=Math.min(f,u+(g?c_:h_)*e);S!==u&&(ke.current[r]=S,l=!0)}if(g){const y=Math.max(1,m-f_*e);y!==m&&(x.current[r]=y,h=!0)}else if(p>=u_&&m<_){const y=Math.min(_,m+d_*e);y!==m&&(x.current[r]=y,h=!0)}return{hungerChanged:n,staminaChanged:l,healthChanged:h,isStarving:g}}function rl(o,e){const t=Hc(o);if(t.length===0)return;const i=t[0],s=Qe.max[i]??100;Qe.current[i]=Math.min(s,(Qe.current[i]??0)+e)}const zc=St([Ga,j,x,Cs,xe]);St([Oa,j,x]);St([Ga,j,lo,xe]);const p_=40;function __(o,e,t=p_){const i=j.x[e]??0,s=j.y[e]??0,a=t*t,r=[],n=zc(o);for(let l=0;l<n.length;l++){const h=n[l];if((xe.value[h]??0)===0)continue;const c=(j.x[h]??0)-i,d=(j.y[h]??0)-s;c*c+d*d<=a&&r.push(h)}return r}function g_(o,e){const i=St([vt])(o);for(let s=0;s<i.length;s++){const a=i[s],r=vt.timer[a]??0;r>0&&(vt.timer[a]=Math.max(0,r-e))}}function y_(o){const e=zc(o);let t=0;for(let i=0;i<e.length;i++)(xe.value[e[i]]??0)===1&&t++;return t}var se=(o=>(o[o.ISOMETRIC=0]="ISOMETRIC",o[o.TOP_DOWN=1]="TOP_DOWN",o[o.SIDE_SCROLL=2]="SIDE_SCROLL",o))(se||{});class b_{_mode=0;_transition=null;_transitionSpeed=2;_onChangeCallbacks=[];get mode(){return this._mode}get isTransitioning(){return this._transition!==null}get transition(){return this._transition}get isIsometric(){return this._mode===0}get isTopDown(){return this._mode===1}get isSideScroll(){return this._mode===2}startTransition(e,t,i=0,s=0){this._mode!==e&&(this._transition||(this._transition={from:this._mode,to:e,progress:0,reason:t,returnX:i,returnY:s}))}setImmediate(e){const t=this._mode;if(this._mode=e,this._transition=null,t!==e)for(const i of this._onChangeCallbacks)i(t,e)}onChange(e){this._onChangeCallbacks.push(e)}update(e){if(this._transition){if(this._transition.progress+=e/this._transitionSpeed,this._transition.progress>=.5&&this._mode===this._transition.from){const t=this._mode;this._mode=this._transition.to;for(const i of this._onChangeCallbacks)i(t,this._mode);console.log(`[ViewMode] Switched: ${se[t]}  ${se[this._mode]} (${this._transition.reason})`)}this._transition.progress>=1&&(this._transition=null)}}renderTransition(e,t,i){if(!this._transition)return;const s=this._transition.progress,a=s<.5?s*2:(1-s)*2,r=this._transition.reason;if(e.fillStyle=`rgba(0, 0, 0, ${Math.min(a,1)})`,e.fillRect(0,0,t,i),r==="enter_dungeon"||r==="enter_mine"){const n=r==="enter_dungeon"?[80,20,120]:[60,40,20],l=a*.4,h=t/2,c=i/2,d=Math.sqrt(h*h+c*c),u=e.createRadialGradient(h,c,0,h,c,d);u.addColorStop(0,`rgba(${n[0]},${n[1]},${n[2]},0)`),u.addColorStop(.6,`rgba(${n[0]},${n[1]},${n[2]},${l*.3})`),u.addColorStop(1,`rgba(${n[0]},${n[1]},${n[2]},${l})`),e.fillStyle=u,e.fillRect(0,0,t,i)}else if(r==="enter_boss_arena"){const n=a*.3,l=t/2,h=i/2,c=Math.sqrt(l*l+h*h),d=e.createRadialGradient(l,h,c*.3,l,h,c);d.addColorStop(0,"rgba(0,0,0,0)"),d.addColorStop(1,`rgba(180,20,20,${n})`),e.fillStyle=d,e.fillRect(0,0,t,i)}else r==="enter_interior"&&(e.fillStyle=`rgba(40,30,10,${a*.2})`,e.fillRect(0,0,t,i));if(a>.85){const l={enter_dungeon:"Descending...",exit_dungeon:"Ascending...",enter_boss_arena:"PREPARE YOURSELF",enter_interior:"Entering...",enter_mine:"Descending..."}[r];l&&(e.save(),e.globalAlpha=Math.min(1,(a-.85)*6.67),e.font=r==="enter_boss_arena"?"bold 18px monospace":"13px monospace",e.textAlign="center",e.fillStyle=r==="enter_boss_arena"?"#ff4444":"#888888",e.fillText(l,t/2,i/2),e.restore())}}getCameraConfig(){switch(this._mode){case 0:return{smoothing:.1,zoomRange:[.5,2]};case 1:return{smoothing:.15,zoomRange:[.8,1.5]};case 2:return{smoothing:.2,zoomRange:[1,1]}}}getMovementConfig(){switch(this._mode){case 0:return{diagonalAllowed:!0,gravityEnabled:!1};case 1:return{diagonalAllowed:!0,gravityEnabled:!1};case 2:return{diagonalAllowed:!1,gravityEnabled:!0}}}}var de=(o=>(o[o.INPUT=0]="INPUT",o[o.GAME_TIME=1]="GAME_TIME",o[o.WORLD=2]="WORLD",o[o.AI=3]="AI",o[o.PHYSICS=4]="PHYSICS",o[o.COMBAT=5]="COMBAT",o[o.ECONOMY=6]="ECONOMY",o[o.META=7]="META",o))(de||{});class w_{_systems=[];_byPhase=new Map;_byName=new Map;_viewManager;_updateTimes=new Map;_slowThresholdMs=2;constructor(e){this._viewManager=e;for(let t=0;t<=7;t++)this._byPhase.set(t,[]);e.onChange((t,i)=>{for(const s of this._systems)s.system.onViewModeChange?.(t,i,this._getState())})}_stateRef=null;setStateRef(e){this._stateRef=e}_getState(){if(!this._stateRef)throw new Error("[SystemManager] State not set!");return this._stateRef}register(e){if(this._byName.has(e.name)){console.warn(`[SystemManager] Duplicate system: ${e.name}`);return}const t={system:e,enabled:!0};this._systems.push(t),this._byName.set(e.name,t),this._byPhase.get(e.phase).push(t),console.log(`[SystemManager] Registered: ${e.name} (phase ${de[e.phase]})`)}registerAll(...e){for(const t of e)this.register(t)}setEnabled(e,t){const i=this._byName.get(e);i&&(i.enabled=t)}get(e){return this._byName.get(e)?.system}_tickCount=0;update(e,t){this._stateRef=t,this._tickCount++;const i=this._viewManager.mode,s=(this._tickCount&1)===0;for(let a=0;a<=7;a++){if(s&&(a===7||a===6))continue;const r=this._byPhase.get(a);for(const n of r)if(n.enabled&&!(n.system.activeModes!==null&&!n.system.activeModes.includes(i)))try{n.system.update(s?e*2:e,t)}catch(l){console.error(`[SystemManager] Error in ${n.system.name}:`,l)}}}serializeAll(){const e={};for(const t of this._systems)t.system.serialize&&(e[t.system.name]=t.system.serialize());return e}deserializeAll(e){for(const t of this._systems)t.system.deserialize&&e[t.system.name]!==void 0&&t.system.deserialize(e[t.system.name])}getPerformanceStats(){return new Map(this._updateTimes)}getActiveCount(){const e=this._viewManager.mode;let t=0;for(const i of this._systems)i.enabled&&(i.system.activeModes===null||i.system.activeModes.includes(e))&&t++;return t}get totalRegistered(){return this._systems.length}}function v_(o,e){return{version:1,player:{x:0,y:0,classId:e,level:1,xp:0,xpToNext:100,health:100,maxHealth:100,mana:50,maxMana:50,stamina:80,maxStamina:80,hunger:100,thirst:100,temperature:20,str:10,dex:10,int:10,vit:10,lck:5,facing:0,speed:120,isMoving:!1,gold:50,corruptionShards:0,ngPlusLevel:0},world:{seed:o,gameTime:0,day:1,hour:8,minute:0,season:0,weatherType:"clear",weatherIntensity:0,weatherTimer:0,globalCorruption:.15,corruptionTrend:.001},progression:{biomesUnlocked:{haven:!0},bossesDefeated:{},titansDefeated:{},questsCompleted:[],questsActive:[],storyChapter:0,achievements:[],dungeonsClearedCount:0,riftMaxDepth:0},view:{mode:se.ISOMETRIC,dungeonId:null,dungeonFloor:0,interiorId:null,bossArenaId:null,returnX:0,returnY:0},settlements:{settlements:[{id:"haven_camp",name:"Haven Camp",x:0,y:0,buildingIds:[],npcIds:["elder_miriam","garrett","martha","lily"],defenseLevel:1,population:4}]},systemData:{}}}const le="Sprites/Lucifer",ol={warrior:`${le}/Characters/warrior/Foozle_2DC0009_Lucifer_Warrior_Pixel_Art`,necromancer:`${le}/Characters/necromancer/Foozle_2DC0010_Lucifer_Necromancer_Pixel_Art`,sorceress:`${le}/Characters/sorceress/Foozle_2DC0011_Lucifer_Sorceress_Pixel_Art`},nl={skeleton_grunt:`${le}/Enemies/skeleton-grunt/Foozle_2DC0018_Lucifer_Skeleton_Grunt_Pixel_Art`,skeleton_hunter:`${le}/Enemies/skeleton-hunter/Foozle_2DC0019_Lucifer_Skeleton_Hunter_Pixel_Art`,goblin_berserker:`${le}/Enemies/goblin-berserker/Foozle_2DC0015_Lucifer_Goblin_Berserker_Pixel_Art`,goblin_slinger:`${le}/Enemies/goblin-slinger/Foozle_2DC0014_Lucifer_Goblin_Slinger_Pixel_Art`,cultist:`${le}/Enemies/cultist/Foozle_2DC0013_Lucifer_Cultist_Pixel_Art`,possessed:`${le}/Enemies/possessed/Foozle_2DC0012_Lucifer_Possessed_Pixel_Art`},S_={skeleton_king:`${le}/Bosses/skeleton-king-boss/Foozle_2DC0021_Lucifer_Skeleton_King_Pixel_Art`,ancient_boss:`${le}/Bosses/ancient-boss/Foozle_2DC0020_Lucifer_Skeleton_Ancient_Pixel_Art`,goblin_beast:`${le}/Bosses/goblin-beast-boss/Foozle_2DC0016_Lucifer_Goblin_Beast_Pixel_Art`,goblin_rider:`${le}/Bosses/goblin-rider-boss/Foozle_2DC0017_Lucifer_Goblin_Rider_Pixel_Art`},ll={exterior:`${le}/Tilesets/exterior-tileset/Foozle_2DT0002_Lucifer_Exterior_Tileset_Pixel_Art/Png/OuterTileset.png`,dungeon:`${le}/Tilesets/dungeon-tileset/Foozle_2DT0003_Lucifer_Dungeon_Tileset_Pixel_Art/Png/DungeonTileset.png`,desert:`${le}/Tilesets/desert-tileset/Foozle_2DT0010_Lucifer_Desert_Tileset_Pixel_Art/Desert Tileset.png`,lava:`${le}/Tilesets/lava-dungeon-tileset/Foozle_2DT0011_Lucifer_Lava_Tileset_Pixel_Art/LavaDungeonTileset.png`},ie="Sprites/Supplementary/0x72-dungeon-tileset-ii/0x72_DungeonTilesetII_v1.7/frames",_r="Sprites/Supplementary/0x72-dungeon-tileset-ii/0x72_DungeonTilesetII_v1.7",ka={floor_1:`${ie}/floor_1.png`,floor_2:`${ie}/floor_2.png`,floor_3:`${ie}/floor_3.png`,floor_4:`${ie}/floor_4.png`,floor_5:`${ie}/floor_5.png`,floor_6:`${ie}/floor_6.png`,floor_7:`${ie}/floor_7.png`,floor_8:`${ie}/floor_8.png`,wall_mid:`${ie}/wall_mid.png`,wall_left:`${ie}/wall_left.png`,wall_right:`${ie}/wall_right.png`,wall_top_mid:`${ie}/wall_top_mid.png`,wall_top_left:`${ie}/wall_top_left.png`,wall_top_right:`${ie}/wall_top_right.png`,wall_banner_blue:`${ie}/wall_banner_blue.png`,wall_banner_red:`${ie}/wall_banner_red.png`,wall_hole_1:`${ie}/wall_hole_1.png`,wall_hole_2:`${ie}/wall_hole_2.png`,wall_goo:`${ie}/wall_goo.png`,wall_fountain_top_1:`${ie}/wall_fountain_top_1.png`,door_closed:`${ie}/doors_leaf_closed.png`,door_open:`${ie}/doors_leaf_open.png`,door_frame_left:`${ie}/doors_frame_left.png`,door_frame_right:`${ie}/doors_frame_right.png`,door_frame_top:`${ie}/doors_frame_top.png`,chest_full_f0:`${ie}/chest_full_open_anim_f0.png`,chest_full_f1:`${ie}/chest_full_open_anim_f1.png`,chest_full_f2:`${ie}/chest_full_open_anim_f2.png`,chest_empty_f0:`${ie}/chest_empty_open_anim_f0.png`,spikes_f0:`${ie}/floor_spikes_anim_f0.png`,spikes_f1:`${ie}/floor_spikes_anim_f1.png`,spikes_f2:`${ie}/floor_spikes_anim_f2.png`,spikes_f3:`${ie}/floor_spikes_anim_f3.png`,stairs:`${ie}/floor_stairs.png`,ladder:`${ie}/floor_ladder.png`,column:`${ie}/column.png`,skull:`${ie}/skull.png`,crate:`${ie}/crate.png`,edge_down:`${ie}/edge_down.png`,atlas_floor:`${_r}/atlas_floor-16x16.png`,atlas_walls_low:`${_r}/atlas_walls_low-16x16.png`,atlas_walls_high:`${_r}/atlas_walls_high-16x32.png`},yt="Sprites/Buildings",Ct={guild_hall:`${yt}/barracks.png`,general_store:`${yt}/house1.png`,blacksmith:`${yt}/stable.png`,tavern:`${yt}/house1b.png`,herb_shop:`${yt}/house1c.png`,chapel:`${yt}/castle.png`,watchtower:`${yt}/archery_range.png`,farmhouse:`${yt}/18.09a - Iconic Homestead 2.0/mockups/house 01.png`,inn:`${yt}/18.09a - Iconic Homestead 2.0/mockups/house 02.png`,cottage:`${yt}/18.09a - Iconic Homestead 2.0/mockups/house 03.png`,castle_wall:`${yt}/19.12a - Iconic Castle 2.0/iconic castle.png`,tavern_large:`${yt}/Medieval-Tavern/medieval-tavern_00000.png`},hl={elder_miriam:{collection:"necromancer",label:"Elder Miriam"},martha:{collection:"sorceress",label:"Martha"},garrett:{collection:"warrior",label:"Garrett"},lily:{collection:"sorceress",label:"Lily"},harold:{collection:"warrior",label:"Harold"},eldric:{collection:"necromancer",label:"Eldric"},marcus:{collection:"warrior",label:"Marcus"},elena:{collection:"sorceress",label:"Dr. Elena"},penny:{collection:"sorceress",label:"Penny"}},Wt="Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Characters",No={elder_miriam:`${Wt}/OldMan3/SpriteSheet.png`,martha:`${Wt}/Villager/SpriteSheet.png`,garrett:`${Wt}/Knight/SpriteSheet.png`,lily:`${Wt}/Villager3/SpriteSheet.png`,harold:`${Wt}/Villager2/SpriteSheet.png`,eldric:`${Wt}/SorcererOrange/SpriteSheet.png`,marcus:`${Wt}/Hunter/SpriteSheet.png`,elena:`${Wt}/Shaman/SpriteSheet.png`,penny:`${Wt}/Cavegirl/SpriteSheet.png`},oe="Sprites/Magical Effects",cl={fire1:"Sprites/Effects/Fire/fire1_64.png",fire2:"Sprites/Effects/Fire/fire2_64_0.png",fire3:"Sprites/Effects/Fire/fire3_64_0.png",fire4:"Sprites/Effects/Fire/fire4_64_0.png",fire5:"Sprites/Effects/Fire/fire5_64_0.png",fog:"Sprites/Effects/Dark_Fantasy/fog01.png",dark_scenery:"Sprites/Effects/Dark_Fantasy/misc_scenery.png",slash_cross:`${oe}/Part 1/slash_cross_hit_impact.png`,wind_slash:`${oe}/Part 1/wind_slash_quick_attack.png`,fire_swoosh:`${oe}/Part 1/fire_swoosh_attack_trail.png`,arc_swing:`${oe}/Part 3/arc_swing_melee_attack.png`,claw_slash:`${oe}/Part 3/claw_slash_critical_hit.png`,crescent_slash:`${oe}/Part 3/crescent_slash_sword_attack.png`,slash_line:`${oe}/Part 5/slash_line_sword_swing.png`,diagonal_slash:`${oe}/Part 5/diagonal_slash_quick_cut.png`,dust_puff:`${oe}/Part 1/dust_puff_small_impact.png`,spike_burst:`${oe}/Part 3/spike_burst_damage_effect.png`,spiky_burst:`${oe}/Part 3/spiky_burst_explosion_hit.png`,ground_slam:`${oe}/Part 5/ground_slam_earth_impact.png`,smoke_explosion:`${oe}/Part 2/smoke_explosion_bomb_effect.png`,flower_bloom:`${oe}/Part 2/flower_bloom_heal_effect.png`,flower_heal:`${oe}/Part 4/flower_bloom_nature_heal.png`,flower_ring:`${oe}/Part 4/flower_ring_heal_aura.png`,sparkle_burst:`${oe}/Part 2/sparkle_burst_level_up.png`,star_explosion:`${oe}/Part 2/star_explosion_power_up.png`,sparkle_spawn:`${oe}/Part 1/sparkle_appear_spawn_effect.png`,sparkle_collect:`${oe}/Part 1/sparkle_burst_collect_item.png`,magic_circle:`${oe}/Part 1/magic_circle_spinning_cast_effect.png`,magic_rune:`${oe}/Part 1/magic_rune_rotating_buff.png`,energy_swirl:`${oe}/Part 1/energy_swirl_charging_effect.png`,energy_projectile:`${oe}/Part 2/energy_projectile_flying.png`,nova_burst:`${oe}/Part 5/nova_burst_ultimate_skill.png`,sun_ray:`${oe}/Part 4/sun_ray_holy_light.png`,leaf_scatter:`${oe}/Part 2/leaf_scatter_nature_magic.png`,snowflake_spin:`${oe}/Part 4/snowflake_spin_ice_magic.png`,snake_swirl:`${oe}/Part 3/snake_swirl_poison_magic.png`,tentacle_burst:`${oe}/Part 4/tentacle_burst_dark_magic.png`,flame_rise:`${oe}/Part 3/flame_rise_fire_pillar.png`,water_splash:`${oe}/Part 2/water_splash_liquid_impact.png`,shard_burst:`${oe}/Part 5/shard_burst_crystal_break.png`,ribbon_trail:`${oe}/Part 3/ribbon_trail_dash_effect.png`,wind_trail:`${oe}/Part 3/wind_trail_speed_effect.png`,smoke_poof:`${oe}/Part 1/smoke_poof_disappear_effect.png`,footstep_dust:`${oe}/Part 4/footstep_dust_walk_effect.png`,portal_ring:`${oe}/Part 1/portal_ring_teleport_effect.png`,blob_splash:`${oe}/Part 4/blob_splash_slime_death.png`,blob_morph:`${oe}/Part 3/blob_morph_slime_effect.png`,pickup_health:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Pickup effects/Png/Health Potion Pickup effect.png`,pickup_mana:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Pickup effects/Png/Mana Potion Pickup effect.png`,pickup_stamina:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Pickup effects/Png/Stamina Potion Pickup effect.png`,pickup_gold:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Pickup effects/Png/Gold Pickup effect.png`,pickup_gem:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Pickup effects/Png/Gem Pickup effect.png`,wave_big_right:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Wave/Big/Right/WaveBigRight.png`,wave_big_left:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Wave/Big/Left/WaveBigLeft.png`,wave_big_up:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Wave/Big/Up/WaveBigUp.png`,wave_big_down:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Wave/Big/Down/WaveBigDown.png`,wave_small_right:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Wave/Small/Right/WaveSmallRIght.png`,wave_small_left:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Wave/Small/Left/WaveSmallLeft.png`,wave_small_up:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Wave/Small/Up/WaveSmallUp.png`,wave_small_down:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Wave/Small/Down/WaveSmallDown.png`,rarity_common:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Rarity Effects/Png/Common effect.png`,rarity_magic:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Rarity Effects/Png/Magic effect.png`,rarity_rare:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Rarity Effects/Png/Rare effect.png`,rarity_legendary:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Rarity Effects/Png/Legendary effect.png`,rarity_mythic:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/Rarity Effects/Png/Mythic effect.png`,destroy_effect:`${le}/Effects/Foozle_2DE0002_Lucifer_Effects_Pixel_Art/Effects/VFX/Destroy Effect.png`},ut="Sprites/Items/Tileset/isometric tileset/separated images",Xe="Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Items/Resource",Xc="Sprites/Items/Tree",k_=`${Xc}/Green/256x256`,T_=`${Xc}/Autumn/256x256`,Ta=Array.from({length:20},(o,e)=>`${k_}/Tree01_${String(e+1).padStart(4,"0")}.png`),M_=Array.from({length:24},(o,e)=>`${T_}/Tree01_${String(e+1).padStart(4,"0")}.png`),dl={haven:Ta,rotwood:M_,ashlands:["Sprites/Biomes/Undead/graveyard_tileset/png/Objects/Tree.png"],drowned_depths:["Sprites/Biomes/Swamp/3 Objects/Trees/1.png","Sprites/Biomes/Swamp/3 Objects/Trees/2.png","Sprites/Biomes/Swamp/3 Objects/Trees/3.png"],bone_wastes:["Sprites/Biomes/Undead/graveyard_tileset/png/Objects/Tree.png"],the_void:["Sprites/Biomes/Undead/graveyard_tileset/png/Objects/Tree.png"]},et={tree:Ta[0],bush:`${ut}/isometric_bush_medium_green.png`,rock:`${Xe}/Rock.png`,stone:`${ut}/isometric_rock_large_gray.png`,rock_cluster:`${ut}/isometric_rock_cluster_large.png`,iron_ore:`${Xe}/BarIron.png`,gold_ore:`${Xe}/BarGold.png`,copper_ore:`${Xe}/BarCopper.png`,herb:`${Xe}/Grass.png`,grass:`${Xe}/Grass.png`,branch:`${Xe}/Branch.png`,crystal:`${Xe}/GemPurple.png`,gem_green:`${Xe}/GemGreen.png`,gem_red:`${Xe}/GemRed.png`,gem_yellow:`${Xe}/GemYellow.png`,mushroom:`${ut}/isometric_mushroom_red_spotted_single.png`,spore_cap:`${ut}/isometric_mushroom_brown_single.png`,mushroom_cluster:`${ut}/isometric_mushroom_brown_cluster.png`,glowing_mushroom:`${ut}/isometric_mushroom_white_glowing.png`,berries:`${ut}/isometric_wildflower_red_petals.png`,blueberry:`${ut}/isometric_wildflower_blue_petals.png`,frostberry:`${ut}/isometric_wildflower_blue_petals.png`,wildflower_yellow:`${ut}/isometric_wildflower_yellow_petals.png`,wildflower_purple:`${ut}/isometric_wildflower_purple_petals.png`,firebloom:`${ut}/isometric_wildflower_yellow_petals.png`,wood:Ta[2],fiber:`${Xe}/Grass.png`,silver_ore:`${Xe}/BarSilver.png`,mithril_ore:`${Xe}/BarMithril.png`,corruption_essence:`${Xe}/BarPurple.png`,sapphire:`${Xe}/GemPurple.png`,void_essence:`${Xe}/GemPurple.png`,cursed_bone:`${Xe}/Branch.png`,shell:`${Xe}/Water.png`,ancient_relic:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Items/Treasure/GoldCup.png",feather:`${Xe}/feather.png`},Ue="Sprites/Food/Farming n Foraging",ul={wheat:`${Ue}/crops/wheat.png`,carrot:`${Ue}/crops/carrot.png`,potato:`${Ue}/crops/potato.png`,tomato:`${Ue}/crops/tomato.png`,corn:`${Ue}/crops/corn.png`,pumpkin:`${Ue}/crops/pumpkin.png`,herb_crop:`${Ue}/herbs/basil.png`,moonpetal:`${Ue}/flowers/lily.png`,firebloom:`${Ue}/flowers/marigold.png`,frostberry:`${Ue}/berries/blueberry.png`,strawberry:`${Ue}/crops/strawberry.png`,turnip:`${Ue}/crops/turnip.png`,cabbage:`${Ue}/crops/cabbage.png`,eggplant:`${Ue}/crops/eggplant.png`,onion:`${Ue}/crops/onion.png`,garlic:`${Ue}/crops/garlic.png`,cucumber:`${Ue}/crops/cucumber.png`,watermelon:`${Ue}/crops/watermelon.png`,radish:`${Ue}/crops/radish.png`},fl={floor:`${ie}/floor_1.png`,floor_alt:`${ie}/floor_2.png`,wall:`${ie}/wall_mid.png`,wall_top:`${ie}/wall_top_mid.png`,door:`${ie}/doors_leaf_closed.png`,door_open:`${ie}/doors_leaf_open.png`,stairs:`${ie}/floor_stairs.png`,counter:`${ie}/crate.png`,rug:`${ie}/floor_3.png`,fireplace:`${ie}/wall_fountain_basin_red_anim_f0.png`,window:`${ie}/wall_hole_1.png`,column:`${ie}/column.png`,chest:`${ie}/chest_full_open_anim_f0.png`},z=`${le}/Items/equipment/Foozle_2DS0005_Lucifer_Equipment_Pixel_Art/Equipment`,Be=`${le}/Items/pickups/Foozle_2DS0006_Lucifer_Pickups_Pixel_Art/Pickups`,V="Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Items",C_=`${le}/UI/Foozle_UI_0002_Lucifer_RPG_UI_Pixel_Art`,qs={health_potion:`${Be}/Potions/Health/Png/SmallHealthPotion.png`,greater_health_potion:`${Be}/Potions/Health/Png/BigHealthPotion.png`,mana_potion:`${Be}/Potions/Mana/Png/SmallManaPotion.png`,greater_mana_potion:`${Be}/Potions/Mana/Png/BigManaPotion.png`,stamina_potion:`${Be}/Potions/Stamina/Png/SmallStaminaPotion.png`,stamina_tonic:`${Be}/Potions/Stamina/Png/SmallStaminaPotion.png`,endurance_elixir:`${Be}/Potions/Stamina/Png/BigStaminaPotion.png`,antidote:`${Be}/Potions/Health/Png/SmallHealthPotion.png`,speed_potion:`${Be}/Potions/Mana/Png/SmallManaPotion.png`,fire_resistance_potion:`${Be}/Potions/Stamina/Png/BigStaminaPotion.png`,ice_resistance_potion:`${Be}/Potions/Mana/Png/BigManaPotion.png`,elixir_of_purification:`${Be}/Potions/Health/Png/BigHealthPotion.png`,gold_coins:`${Be}/Gold/Png/PileOfCoins.png`,gold_coin:`${Be}/Gold/Png/PileOfCoins.png`,gold_pile:`${Be}/Gold/Png/PileOfGold.png`,gold_bar:`${Be}/Gold/Png/PileOfGold.png`,blue_gem:`${Be}/Gems/Png/BlueGem.png`,orange_gem:`${Be}/Gems/Png/OrangeGem.png`,pink_gem:`${Be}/Gems/Png/PinkGem.png`,sapphire:`${Be}/Gems/Png/BlueGem.png`,ruby:`${Be}/Gems/Png/PinkGem.png`,topaz:`${Be}/Gems/Png/OrangeGem.png`,emerald:`${V}/Resource/GemGreen.png`,diamond:`${V}/Resource/GemPurple.png`,void_gem:`${V}/Resource/GemPurple.png`,frost_crystal:`${V}/Resource/GemGreen.png`,purification_crystal:`${V}/Resource/GemYellow.png`,rift_crystal:`${V}/Resource/GemRed.png`,wooden_sword:`${z}/Weapons/Png/Common Arming Sword.png`,iron_sword:`${z}/Weapons/Png/Common Arming Sword.png`,steel_sword:`${z}/Weapons/Png/Common Shamshir.png`,rusty_dagger:`${z}/Weapons/Png/Common Arming Sword.png`,shadow_dagger:`${z}/Weapons/Png/Legendary Shamshir.png`,cursed_blade:`${z}/Weapons/Png/Rare Greatsword.png`,edilas_edge:`${z}/Weapons/Png/Mythic Battleaxe.png`,void_cleaver:`${z}/Weapons/Png/Legendary Dane Axe.png`,death_scythe:`${z}/Weapons/Png/Legendary Dane Axe.png`,trident:`${z}/Weapons/Png/Common Spear.png`,purifier_blade:`${z}/Weapons/Png/Rare Greatsword.png`,void_edge:`${z}/Weapons/Png/Legendary Shamshir.png`,iron_axe:`${z}/Weapons/Png/Common Bearded Axe.png`,battle_axe:`${z}/Weapons/Png/Common Bearded Axe.png`,hatchet:`${z}/Weapons/Png/Common Bearded Axe.png`,iron_spear:`${z}/Weapons/Png/Common Spear.png`,wooden_spear:`${z}/Weapons/Png/Common Spear.png`,wooden_staff:`${z}/Weapons/Png/Wizards Pole.png`,apprentice_staff:`${z}/Weapons/Png/Wizards Pole.png`,storm_staff:`${z}/Weapons/Png/Mages Spire.png`,crystal_staff:`${z}/Weapons/Png/Mages Spire.png`,titan_slayer:`${z}/Weapons/Png/Legendary Dane Axe.png`,titan_maul:`${z}/Weapons/Png/Mythic Godhammer.png`,legendary_hammer:`${z}/Weapons/Png/Mythic Godhammer.png`,stone_hammer:`${V}/Weapons/Hammer/Sprite.png`,greatsword:`${z}/Weapons/Png/Common Greatsword.png`,mythic_hammer:`${z}/Weapons/Png/Mythic Godhammer.png`,mythic_axe:`${z}/Weapons/Png/Mythic Battleaxe.png`,rapier:`${z}/Weapons/Png/Legendary Rapier .png`,hook_blade:`${z}/Weapons/Png/Rare Explorers Hook.png`,harvest_scythe:`${V}/Tool/Sickle.png`,shortbow:`${V}/Weapons/Bow/Sprite.png`,hunters_bow:`${V}/Weapons/Bow2/Sprite.png`,fishing_rod:`${V}/Weapons/Stick/Sprite.png`,iron_helmet:`${z}/Head/Png/Common Chainmail Helmet.png`,iron_helm:`${z}/Head/Png/Common Chainmail Helmet.png`,steel_helm:`${z}/Head/Png/Rare Plate Helmet.png`,leather_cap:`${z}/Head/Png/Common Chainmail Helmet.png`,plate_helmet:`${z}/Head/Png/Rare Plate Helmet.png`,royal_crown:`${z}/Head/Png/Legendary Royal Helmet.png`,crown:`${z}/Head/Png/Legendary Royal Helmet.png`,wizard_hat:`${z}/Head/Png/Wizards Hat.png`,explorer_hat:`${z}/Head/Png/Rare Explorers Ushanka.png`,leather_armor:`${z}/Chest/Png/Common Ragged shirt.png`,leather_vest:`${z}/Chest/Png/Common Ragged shirt.png`,chainmail:`${z}/Chest/Png/Common ChainMail Chestpiece.png`,iron_armor:`${z}/Chest/Png/Common Gambeson.png`,iron_chestplate:`${z}/Chest/Png/Common Gambeson.png`,steel_chestplate:`${z}/Chest/Png/Rare Plate Chestpiece.png`,plate_armor:`${z}/Chest/Png/Rare Plate Chestpiece.png`,royal_armor:`${z}/Chest/Png/Legendary Royal Chestpiece.png`,purifiers_mantle:`${z}/Chest/Png/Legendary Royal Chestpiece.png`,pilgrim_cloak:`${z}/Chest/Png/Rare Explorers Top.png`,wizard_robe:`${z}/Chest/Png/Magic Wizards Tunic Chestpiece.png`,explorer_vest:`${z}/Chest/Png/Rare Explorers Top.png`,sorceress_garb:`${z}/Chest/Png/Magic Sorceress Gambeson.png`,leather_pants:`${z}/Bottom/Png/Common Leggings.png`,leather_leggings:`${z}/Bottom/Png/Common Leggings.png`,chainmail_legs:`${z}/Bottom/Png/Common Chainmail Leggings.png`,plate_legs:`${z}/Bottom/Png/Rare Plate Leggings.png`,explorer_pants:`${z}/Bottom/Png/Rare Explorers Leggings.png`,wizard_pants:`${z}/Bottom/Png/Wizards Leggings.png`,iron_gauntlets:`${z}/Misc/Png/Rare Explorers Gloves.png`,leather_boots:`${z}/Feet/Png/Common Chainmail Boots.png`,plate_boots:`${z}/Feet/Png/Rare Plate Boots.png`,explorer_boots:`${z}/Feet/Png/Rare Explorers Boots.png`,wizard_shoes:`${z}/Feet/Png/Wizards Shoes.png`,silver_amulet:`${z}/Misc/Png/Common SIlver Amulet.png`,golden_amulet:`${z}/Misc/Png/Rare Golden Gem Amulet.png`,purifier_amulet:`${z}/Misc/Png/Rare Golden Gem Amulet.png`,wolf_fang_necklace:`${z}/Misc/Png/Common SIlver Amulet.png`,copper_ring:`${z}/Misc/Png/Silver Enchanted Ring.png`,wizard_amulet:`${z}/Misc/Png/Wizards Amulet.png`,silver_ring:`${z}/Misc/Png/Silver Enchanted Ring.png`,golden_ring:`${z}/Misc/Png/Golden Enchanted Ring.png`,wizard_ring:`${z}/Misc/Png/Wizards Sparkle Ring.png`,explorer_gloves:`${z}/Misc/Png/Rare Explorers Gloves.png`,rarity_bg_common:`${z}/Rarity Backgrounds/16x16/Png/Common .png`,rarity_bg_rare:`${z}/Rarity Backgrounds/16x16/Png/Rare.png`,rarity_bg_magic:`${z}/Rarity Backgrounds/16x16/Png/Magic.png`,rarity_bg_legendary:`${z}/Rarity Backgrounds/16x16/Png/Legendary.png`,rarity_bg_mythic:`${z}/Rarity Backgrounds/16x16/Png/Mythic.png`,rarity_bg_set:`${z}/Rarity Backgrounds/16x16/Png/Set.png`,pickaxe:`${V}/Tool/Pickaxe.png`,lantern:`${V}/Potion/Heart.png`,wood:`${V}/Resource/Branch.png`,stone:`${V}/Resource/Rock.png`,iron_ore:`${V}/Resource/BarIron.png`,gold_ore:`${V}/Resource/BarGold.png`,iron_bar:`${V}/Resource/BarIron.png`,cloth:`${V}/Resource/feather.png`,fiber:`${V}/Resource/Grass.png`,herb:`${V}/Resource/Grass.png`,bone_fragment:`${V}/Weapons/Bone/Sprite.png`,slime_gel:`${V}/Resource/Water.png`,wolf_pelt:`${V}/Resource/feather.png`,monster_hide:`${V}/Resource/feather.png`,ash_powder:`${V}/Resource/Rock.png`,dragon_scale:`${V}/Resource/GemRed.png`,magma_core:`${V}/Resource/GemRed.png`,shadow_essence:`${V}/Resource/GemPurple.png`,corruption_essence:`${V}/Resource/GemPurple.png`,corruption_core:`${V}/Resource/GemPurple.png`,titan_bone:`${V}/Weapons/Bone/Sprite.png`,spore_cap:"Sprites/Food/Farming n Foraging/herbs/basil.png",kraken_eye:`${V}/Resource/GemGreen.png`,dungeon_key:`${V}/Treasure/GoldKey.png`,heart_key:`${V}/Treasure/SilverKey.png`,edilas_fragment:`${V}/Treasure/GoldCup.png`,pilgrim_relic:`${V}/Treasure/SilverCup.png`,void_shard:`${V}/Resource/GemPurple.png`,titan_set_blueprint:`${V}/Scroll/Scroll.png`,purifier:`${V}/Treasure/GoldCup.png`,carrot_seed:`${V}/Food/SeedLargeWhite.png`,potato_seed:`${V}/Food/SeedLargeWhite.png`,pumpkin_seed:`${V}/Food/SeedLargeWhite.png`,wheat_seed:`${V}/Food/SeedLargeWhite.png`,moonpetal_seed:`${V}/Food/SeedLargeWhite.png`,void_bloom_seed:`${V}/Food/SeedLargeWhite.png`,bread:"Sprites/Food/sprites/golden-croissant-pastry.png",apple:"Sprites/Food/sprites/orange-peach-fruit.png",cooked_meat:"Sprites/Food/sprites/raw-red-meat-steak.png",raw_meat:`${V}/Food/Meat.png`,meat:`${V}/Food/Meat.png`,fish:`${V}/Food/Fish.png`,raw_fish:`${V}/Food/Fish.png`,grilled_fish:"Sprites/Food/sprites/grilled-shrimp-seafood.png",mushroom_stew:"Sprites/Food/sprites/red-coffee-cup-with-spoon.png",golden_feast:"Sprites/Food/sprites/pink-layered-cake-slice-with-cherry.png",berry_pie:"Sprites/Food/sprites/pink-frosted-donut-with-sprinkles.png",travelers_ration:"Sprites/Food/sprites/yellow-swiss-cheese-slice.png",honey:`${V}/Food/Honey.png`,noodles:`${V}/Food/Noodle.png`,sushi:`${V}/Food/Sushi.png`,water_flask:"Sprites/Food/sprites/blue-water-bottle.png",beer:"Sprites/Food/sprites/golden-beer-mug-with-foam.png",berry_juice:"Sprites/Food/sprites/strawberry-juice-box-carton.png",wheat:"Sprites/Food/Farming n Foraging/crops/wheat.png",carrot:"Sprites/Food/Farming n Foraging/crops/carrot.png",potato:"Sprites/Food/Farming n Foraging/crops/potato.png",tomato:"Sprites/Food/Farming n Foraging/crops/tomato.png",corn:"Sprites/Food/Farming n Foraging/crops/corn.png",pumpkin:"Sprites/Food/Farming n Foraging/crops/pumpkin.png",cabbage:"Sprites/Food/Farming n Foraging/crops/cabbage.png",onion:"Sprites/Food/Farming n Foraging/crops/onion.png",strawberry:"Sprites/Food/Farming n Foraging/crops/strawberry.png",watermelon:"Sprites/Food/Farming n Foraging/crops/watermelon.png",blueberry:"Sprites/Food/Farming n Foraging/berries/blueberry.png",raspberry:"Sprites/Food/Farming n Foraging/berries/raspberry.png",blackberry:"Sprites/Food/Farming n Foraging/berries/blackberry.png",sunflower:"Sprites/Food/Farming n Foraging/flowers/sunflower.png",rose:"Sprites/Food/Farming n Foraging/flowers/rose.png",lavender:"Sprites/Food/Farming n Foraging/flowers/lavender.png",bat_wing:`${V}/Resource/feather.png`,bear_claw:`${V}/Weapons/Bone/Sprite.png`,snake_scale:`${V}/Resource/GemGreen.png`,ink_sac:`${V}/Resource/Water.png`,tentacle:`${V}/Resource/Branch.png`,mud_clod:`${V}/Resource/Rock.png`,ghost_feather:`${V}/Resource/feather.png`,ancient_relic:`${V}/Treasure/GoldCup.png`,void_essence:`${V}/Resource/GemPurple.png`,ectoplasm:`${V}/Resource/Water.png`,spider_silk:`${V}/Resource/Grass.png`,venom_gland:`${V}/Potion/Heart.png`,cursed_bark:`${V}/Resource/Branch.png`,soul_fragment:`${V}/Resource/GemPurple.png`,spirit_essence:`${V}/Resource/GemYellow.png`,cursed_bone:`${V}/Weapons/Bone/Sprite.png`,fur:`${V}/Resource/feather.png`,fang:`${V}/Weapons/Bone/Sprite.png`,coal:`${V}/Resource/Rock.png`,copper_bar:`${V}/Resource/BarCopper.png`,crystal:`${V}/Resource/GemPurple.png`,mushroom:`${V}/Food/Nut.png`},ml={Idle:6,Run:6,Attack01:8,Death:8,Hurt:3,Jump:6,Land:3},P_={Idle:6,Run:6,Attack01:8,Death:8,Hurt:4,Jump:6,Land:3},Je=48,I_={skeleton_grunt:{Run:"Walk"},skeleton_hunter:{Run:"Walk"},cultist:{Run:"Walk"},possessed:{Run:"Walk"}},A_={skeleton_king:{Run:"Walk"},ancient_boss:{Run:"Walk"},goblin_beast:{Run:"Walk"},goblin_rider:{Run:"Move"}},R_={"skeleton_grunt:Left:Attack01":"SkeletonWithSwordLeftAttack01","skeleton_grunt:Left:Death":"SkeletonWithSwordLefttDeath","skeleton_grunt:Left:Hurt":"SkeletonWithSwordLefttHurt","skeleton_grunt:Left:Idle":"SkeletonWithSwordLefttIdle","skeleton_grunt:Left:Jump":"SkeletonWithSwordLefttJump","skeleton_grunt:Left:Land":"SkeletonWithSwordLefttLand","skeleton_grunt:Left:Run":"SkeletonWithSwordLefttRun","skeleton_grunt:Right:Run":"SkeletonWithSwordRightRun","skeleton_hunter:Left:Attack01":"SkeletonWithBowLeftAttack01","skeleton_hunter:Left:Death":"SkeletonWithBowLefttDeath","skeleton_hunter:Left:Hurt":"SkeletonWithBowLefttHurt","skeleton_hunter:Left:Idle":"SkeletonWithBowLefttIdle","skeleton_hunter:Left:Jump":"SkeletonWithBowLefttJump","skeleton_hunter:Left:Land":"SkeletonWithBowLefttLand","skeleton_hunter:Left:Run":"SkeletonWithBowLefttRun","skeleton_hunter:Right:Run":"SkeletonWithBowRightRun","skeleton_hunter:Up:Run":"SkeletonWithSBowUpWalk","cultist:Left:Hurt":"CultistLefttHurt","cultist:Up:Run":"CultistUpRun","possessed:Left:Hurt":"PossesedLefttHurt","possessed:Left:Idle":"PossesedLefttIdle"},x_={"ancient_boss:Left:Idle":"AncientSkeletonLefttIdle","goblin_rider:Down:Idle":"GoblinRiderIdle","goblin_rider:Down:Run":"GoblinRiderMove","goblin_rider:Down:Attack01":"GoblinRiderAttack01","goblin_rider:Down:Death":"GoblinRiderDeath","goblin_rider:Down:Hurt":"GoblinRiderHurt"},E_={skeleton_grunt:"SkeletonWithSword",skeleton_hunter:"SkeletonWithBow",goblin_berserker:"Goblin",goblin_slinger:"GoblinSlinger",cultist:"Cultist",possessed:"Possesed"},D_={skeleton_king:"SkeletonKing",ancient_boss:"AncientSkeleton",goblin_beast:"GoblinBeast",goblin_rider:"GoblinRider"};function F_(o,e,t){const i=`${o}:${e}:${t}`,s=R_[i];if(s)return s;const a=E_[o]??"Skeleton",r=I_[o]?.[t]??t;return`${a}${e}${r}`}function $_(o,e,t){const i=`${o}:${e}:${t}`,s=x_[i];if(s)return s;const a=D_[o]??"Boss",r=A_[o]?.[t]??t;return`${a}${e}${r}`}function Yi(o){return o.toLowerCase().replace(/[^a-z0-9]/g,"")}function L_(o){let e=0;for(let t=0;t<o.length;t++)e=(e<<5)-e+o.charCodeAt(t),e|=0;return Math.abs(e)}class B_{_loader;_loadedPaths=new Set;_spriteCache=new Map;constructor(e){this._loader=e}getCharacterSpritePath(e,t,i){const a={warrior:"warrior",berserker:"warrior",ranger:"sorceress",mage:"necromancer",necromancer:"necromancer",rogue:"sorceress"}[e]??"warrior",r=ol[a];if(!r)return"";const n=t==="Left"||t==="Up"?"Left":"Right",l=a.charAt(0).toUpperCase()+a.slice(1),h={"sorceress:Left:Run":`${r}/Left/Png/SorceressLeftRun.png`,"sorceress:Left:Walk":`${r}/Left/Png/SorceressLeftRun.png`,"sorceress:Left:Death":`${r}/Left/Png/SorceressLefttDeath.png`,"sorceress:Left:Hurt":`${r}/Left/Png/SorceressLefttHurt.png`,"sorceress:Right:Run":`${r}/Right/Png/SorceressRightRun.png`,"sorceress:Right:Walk":`${r}/Right/Png/SorceressRightRun.png`,"sorceress:Right:Attack01":`${r}/Right/Png/SorceressRighAttack01.png`,"sorceress:Right:Death":`${r}/Right/Png/SorceressRightDeath.png`,"sorceress:Right:Hurt":`${r}/Right/Png/SorceressRightHurt.png`},c=`${a}:${n}:${i}`;return h[c]?h[c]:`${r}/${n}/Png/${l}${n}${i==="Run"?"Walk":i}.png`}async preloadCharacter(e){const t=["Left","Right"],i=["Idle","Run","Attack01","Death","Hurt"],s=[];for(const a of t)for(const r of i){const n=this.getCharacterSpritePath(e,a,r);n&&!this._loadedPaths.has(n)&&(this._loadedPaths.add(n),s.push(this._loader.load(n).then(l=>(this._spriteCache.set(n,l),l)).catch(()=>(console.warn(`[SpriteRegistry] Missing: ${n}`),new Image))))}await Promise.allSettled(s),console.log(`[SpriteRegistry] Loaded character sprites for ${e}`)}getEnemySpritePath(e,t,i){const s={skeleton:"skeleton_grunt",skeletongrunt:"skeleton_grunt",skeletonhunter:"skeleton_hunter",goblin:"goblin_berserker",goblinslinger:"goblin_slinger",goblinarcher:"goblin_slinger",cult:"cultist",cultistpriest:"cultist",possessedspirit:"possessed",wraith:"possessed",shadowwraith:"possessed"},a=Yi(e);let r=e;nl[r]||(s[a]?r=s[a]:a.includes("skeleton")?r=a.includes("bow")||a.includes("archer")||a.includes("hunter")?"skeleton_hunter":"skeleton_grunt":a.includes("goblin")?r=a.includes("sling")||a.includes("archer")||a.includes("ranged")?"goblin_slinger":"goblin_berserker":a.includes("cult")||a.includes("acolyte")||a.includes("priest")?r="cultist":(a.includes("possess")||a.includes("wraith")||a.includes("void")||a.includes("shadow")||a.includes("spirit"))&&(r="possessed"));const n=nl[r];if(!n)return"";const l=F_(r,t,i);return`${n}/${t}/Png/${l}.png`}async preloadEnemies(e){const t=["Down","Left","Right","Up"],i=["Idle","Run","Attack01","Death","Hurt","Jump","Land"],s=[];for(const a of e)for(const r of t)for(const n of i){const l=this.getEnemySpritePath(a,r,n);l&&!this._loadedPaths.has(l)&&(this._loadedPaths.add(l),s.push(this._loader.load(l).then(h=>this._spriteCache.set(l,h)).catch(()=>{})))}await Promise.allSettled(s)}getBossSpritePath(e,t,i){const s=S_[e];if(!s)return"";const a=$_(e,t,i);return`${s}/${t}/Png/${a}.png`}async preloadBosses(e){const t=["Down","Left","Right","Up"],i=["Idle","Run","Attack01","Death","Hurt","Jump","Land"],s=[];for(const a of e)for(const r of t)for(const n of i){const l=this.getBossSpritePath(a,r,n);l&&!this._loadedPaths.has(l)&&(this._loadedPaths.add(l),s.push(this._loader.load(l).then(h=>this._spriteCache.set(l,h)).catch(()=>{})))}await Promise.allSettled(s)}getTilesetPath(e){return ll[e]??ll.exterior}async preloadTileset(e){const t=this.getTilesetPath(e),i=await this._loader.load(t);return this._spriteCache.set(t,i),i}getDungeonTilePath(e){return ka[e]??""}async preloadDungeonTiles(){const e=[];for(const[,t]of Object.entries(ka))this._loadedPaths.has(t)||(this._loadedPaths.add(t),e.push(this._loader.load(t).then(i=>this._spriteCache.set(t,i)).catch(()=>{})));await Promise.allSettled(e),console.log(`[SpriteRegistry] Loaded ${e.length} dungeon tile sprites`)}getBuildingSpritePath(e){const t=Ct[e];if(t)return t;const i=Yi(e),a={corruptiondungeon:"castle_wall",mineentrance:"blacksmith",ancientruins:"castle_wall",barracks:"guild_hall",guardtower:"watchtower",tradingpost:"general_store",shrine:"chapel"}[i];return a&&Ct[a]?Ct[a]:i.includes("tower")||i.includes("watch")?Ct.watchtower??"":i.includes("shop")||i.includes("store")||i.includes("trade")?Ct.general_store??"":i.includes("forge")||i.includes("smith")?Ct.blacksmith??"":i.includes("tavern")||i.includes("inn")?Ct.tavern??"":i.includes("chapel")||i.includes("church")||i.includes("shrine")?Ct.chapel??"":i.includes("farm")||i.includes("house")||i.includes("cottage")?Ct.farmhouse??"":i.includes("ruin")||i.includes("dungeon")||i.includes("fort")||i.includes("castle")?Ct.castle_wall??"":""}async preloadBuildings(){const e=[];for(const[,t]of Object.entries(Ct))this._loadedPaths.has(t)||(this._loadedPaths.add(t),e.push(this._loader.load(t).then(i=>this._spriteCache.set(t,i)).catch(()=>{})));await Promise.allSettled(e),console.log(`[SpriteRegistry] Loaded ${e.length} building sprites`)}getNPCSpritePath(e,t,i){let s=hl[e];if(!s){const d=Yi(e),u={blacksmith:"warrior",guard:"warrior",scout:"warrior",hunter:"warrior",elder:"necromancer",occultist:"necromancer",necromancer:"necromancer",healer:"sorceress",doctor:"sorceress",dr:"sorceress",herbalist:"sorceress",mage:"sorceress"};let f;for(const[m,_]of Object.entries(u))if(d.includes(m)){f=_;break}if(!f){const m=["warrior","necromancer","sorceress"];f=m[L_(d||e)%m.length]}s={collection:f,label:e}}const a=ol[s.collection];if(!a)return"";const r=t==="Left"||t==="Up"?"Left":"Right",n=s.collection.charAt(0).toUpperCase()+s.collection.slice(1),l={"sorceress:Left:Run":`${a}/Left/Png/SorceressLeftRun.png`,"sorceress:Left:Walk":`${a}/Left/Png/SorceressLeftRun.png`,"sorceress:Left:Death":`${a}/Left/Png/SorceressLefttDeath.png`,"sorceress:Left:Hurt":`${a}/Left/Png/SorceressLefttHurt.png`,"sorceress:Right:Run":`${a}/Right/Png/SorceressRightRun.png`,"sorceress:Right:Walk":`${a}/Right/Png/SorceressRightRun.png`,"sorceress:Right:Attack01":`${a}/Right/Png/SorceressRighAttack01.png`,"sorceress:Right:Death":`${a}/Right/Png/SorceressRightDeath.png`,"sorceress:Right:Hurt":`${a}/Right/Png/SorceressRightHurt.png`},h=`${s.collection}:${r}:${i}`;return l[h]?l[h]:`${a}/${r}/Png/${n}${r}${i==="Run"?"Walk":i}.png`}async preloadNPCs(){const e=["Left","Right"],t=["Idle","Run"],i=[];for(const s of Object.keys(hl))for(const a of e)for(const r of t){const n=this.getNPCSpritePath(s,a,r);n&&!this._loadedPaths.has(n)&&(this._loadedPaths.add(n),i.push(this._loader.load(n).then(l=>this._spriteCache.set(n,l)).catch(()=>{})))}for(const[,s]of Object.entries(No))this._loadedPaths.has(s)||(this._loadedPaths.add(s),i.push(this._loader.load(s).then(a=>this._spriteCache.set(s,a)).catch(()=>{})));await Promise.allSettled(i),console.log("[SpriteRegistry] Loaded NPC sprites")}async preloadEffects(){const e=[];for(const[,t]of Object.entries(cl))this._loadedPaths.has(t)||(this._loadedPaths.add(t),e.push(this._loader.load(t).then(i=>this._spriteCache.set(t,i)).catch(()=>{})));await Promise.allSettled(e),console.log(`[SpriteRegistry] Loaded ${e.length} effect sprites`)}getVFXSprite(e){const t=cl[e];if(t)return this._spriteCache.get(t)}getResourceSpritePath(e){const t=et[e];if(t)return t;const i=Yi(e),a={woodlog:"wood",woodlogs:"wood",log:"wood",branch:"branch",ore:"iron_ore",gemstone:"crystal",bones:"cursed_bone",relic:"ancient_relic"}[i];return a&&et[a]?et[a]:i.includes("ore")?i.includes("gold")?et.gold_ore??"":i.includes("copper")?et.copper_ore??"":i.includes("silver")?et.silver_ore??"":et.iron_ore??"":i.includes("gem")||i.includes("crystal")||i.includes("shard")?et.crystal??"":i.includes("mushroom")||i.includes("spore")?et.spore_cap??"":i.includes("berry")?et.berries??"":i.includes("bone")?et.cursed_bone??"":i.includes("shell")?et.shell??"":i.includes("herb")||i.includes("flower")||i.includes("bloom")?et.herb??"":i.includes("stone")||i.includes("rock")?et.stone??"":i.includes("wood")||i.includes("tree")||i.includes("bark")?et.wood??"":""}async preloadResources(){const e=[];for(const[,t]of Object.entries(et))this._loadedPaths.has(t)||(this._loadedPaths.add(t),e.push(this._loader.load(t).then(i=>this._spriteCache.set(t,i)).catch(()=>{})));await Promise.allSettled(e),console.log(`[SpriteRegistry] Loaded ${e.length} resource sprites`)}getCropSpritePath(e){return ul[e]??""}async preloadCrops(){const e=[];for(const[,t]of Object.entries(ul))this._loadedPaths.has(t)||(this._loadedPaths.add(t),e.push(this._loader.load(t).then(i=>this._spriteCache.set(t,i)).catch(()=>{})));await Promise.allSettled(e),console.log(`[SpriteRegistry] Loaded ${e.length} crop sprites`)}getInteriorTilePath(e){return fl[e]??""}async preloadInteriorTiles(){const e=[];for(const[,t]of Object.entries(fl))this._loadedPaths.has(t)||(this._loadedPaths.add(t),e.push(this._loader.load(t).then(i=>this._spriteCache.set(t,i)).catch(()=>{})));await Promise.allSettled(e),console.log(`[SpriteRegistry] Loaded ${e.length} interior tile sprites`)}getItemSpritePath(e){const t=qs[e];if(t)return t;const i=Yi(e),s=[["potion","health_potion"],["elixir","greater_mana_potion"],["tonic","stamina_potion"],["sword","iron_sword"],["dagger","shadow_dagger"],["axe","battle_axe"],["bow","shortbow"],["staff","apprentice_staff"],["spear","wooden_spear"],["scythe","harvest_scythe"],["hammer","stone_hammer"],["helm","iron_helm"],["helmet","iron_helmet"],["chestplate","iron_chestplate"],["armor","leather_armor"],["boots","leather_boots"],["leggings","leather_leggings"],["gauntlet","iron_gauntlets"],["ring","copper_ring"],["amulet","silver_amulet"],["gem","blue_gem"],["crystal","purification_crystal"],["coin","gold_coin"],["ore","iron_ore"],["bar","iron_bar"],["bone","bone_fragment"],["key","dungeon_key"],["seed","wheat_seed"],["food","bread"],["meat","raw_meat"],["fish","grilled_fish"],["herb","herb"]];for(const[a,r]of s)if(i.includes(a)&&qs[r])return qs[r];return""}getItemSprite(e){const t=this.getItemSpritePath(e);return t?this._spriteCache.get(t):void 0}async preloadItemSprites(){const e=[];for(const[,t]of Object.entries(qs))this._loadedPaths.has(t)||(this._loadedPaths.add(t),e.push(this._loader.load(t).then(i=>this._spriteCache.set(t,i)).catch(()=>{})));await Promise.allSettled(e),console.log(`[SpriteRegistry] Loaded ${e.length} item sprites`)}static getEquipmentPath(e,t){const s={weapon:"Weapons",head:"Head",body:"Body",feet:"Feet",misc:"Misc"}[e]??"Misc";return`${z}/${s}/Png/${t}.png`}static getSkillIconPath(e,t,i){const s=String(i).padStart(2,"0");return`${C_}/Skill Icons/${e} Icons/${e} ${t} Skills/Png/${e} ${t} Skill ${s}.png`}getSprite(e){return this._spriteCache.get(e)}async loadSprite(e){const t=this._spriteCache.get(e);if(t)return t;const i=await this._loader.load(e);return this._spriteCache.set(e,i),i}drawFrame(e,t,i,s,a,r,n,l,h,c,d=!1){const u=i%s*a,f=Math.floor(i/s)*r;e.save(),d?(e.translate(n+h,l),e.scale(-1,1),e.drawImage(t,u,f,a,r,0,0,h,c)):e.drawImage(t,u,f,a,r,n,l,h,c),e.restore()}get loadedCount(){return this._spriteCache.size}async preloadTreeSprites(){const e=new Set;for(const t of Object.values(dl))for(const i of t)e.add(i);await Promise.all([...e].map(t=>this.loadSprite(t)))}getTreeSprite(e,t){const i=dl[e]??Ta,s=Math.abs(t)%i.length,a=i[s];return this._spriteCache.get(a)}}const Ui="Sprites/Items/Tileset/isometric tileset/separated images/",pl={0:["isometric_grass_tile_dense.png","isometric_grass_tile_sparse.png","isometric_grass_tile_with_clover.png","isometric_grass_tile_with_dandelions.png","isometric_grass_tile_mixed_flowers.png","isometric_grass_tile_pink_flowers.png","isometric_grass_tile_white_flowers.png","isometric_grass_tile_with_mushrooms.png"],1:["isometric_dirt_soil_floor_base_tile.png","isometric_dirt_floor_with_pebbles.png","isometric_dirt_floor_with_grass_patches.png"],2:["isometric_stone_block_gray_solid.png","isometric_stone_block_gray_mossy.png","isometric_stone_block_gray_cracked.png"],3:["isometric_dirt_soil_floor_base_tile.png","isometric_dirt_floor_with_pebbles.png"],5:["isometric_cobblestone_floor_regular.png","isometric_cobblestone_floor_weathered.png"],6:["isometric_shallow_water_tile_full.png"],7:["isometric_deep_water_tile_full.png"],8:["isometric_wooden_plank_floor_base.png","isometric_wooden_plank_floor_weathered.png","isometric_wooden_plank_floor_mossy.png"],9:["isometric_stone_block_gray_solid.png","isometric_stone_block_gray_cracked.png"]},ho=["isometric_bush_small_green.png","isometric_bush_medium_green.png","isometric_bush_large_green.png","isometric_tall_grass_tuft_small.png","isometric_tall_grass_tuft_medium.png","isometric_tall_grass_tuft_large.png","isometric_wildflower_yellow_petals.png","isometric_wildflower_blue_petals.png","isometric_wildflower_purple_petals.png","isometric_wildflower_red_petals.png","isometric_rock_small_gray.png","isometric_rock_medium_gray.png","isometric_mushroom_brown_single.png"],Vc=["isometric_mushroom_brown_single.png","isometric_mushroom_brown_cluster.png","isometric_mushroom_red_spotted_single.png","isometric_mushroom_red_spotted_cluster.png","isometric_tall_grass_tuft_large.png","isometric_tall_grass_tuft_medium.png","isometric_tree_stump_small.png","isometric_tree_stump_medium.png","isometric_tree_stump_large_mossy.png","isometric_fallen_log_horizontal.png","isometric_fallen_log_diagonal.png","isometric_rock_small_gray.png","isometric_rock_cluster_small.png","isometric_bush_medium_green.png"],qc=["isometric_rock_small_gray.png","isometric_rock_medium_gray.png","isometric_rock_large_gray.png","isometric_rock_cluster_large.png","isometric_rock_cluster_small.png","isometric_tree_stump_small.png","isometric_tree_stump_large_mossy.png","isometric_dead_grass_tile_brown.png","isometric_dead_grass_tile_withered.png"],Yc=["isometric_mushroom_white_glowing.png","isometric_mushroom_brown_cluster.png","isometric_mushroom_red_spotted_cluster.png","isometric_tall_grass_tuft_small.png","isometric_tall_grass_tuft_medium.png","isometric_rock_small_gray.png","isometric_rock_cluster_small.png","isometric_bush_small_green.png"],Uc=["isometric_rock_small_gray.png","isometric_rock_medium_gray.png","isometric_rock_cluster_small.png","isometric_tree_stump_small.png","isometric_dead_grass_tile_brown.png","isometric_dead_grass_tile_withered.png"],jc=["isometric_mushroom_white_glowing.png","isometric_rock_small_gray.png","isometric_rock_medium_gray.png","isometric_rock_cluster_large.png"],W_=[...new Set([...ho,...Vc,...qc,...Yc,...Uc,...jc])],gr={rotwood:["isometric_grass_tile_with_mushrooms.png","isometric_grass_tile_autumn_orange.png","isometric_grass_tile_autumn_yellow.png","isometric_grass_tile_autumn_red.png","isometric_grass_tile_sparse.png"],ashlands:["isometric_dead_grass_tile_brown.png","isometric_dead_grass_tile_withered.png","isometric_dirt_soil_floor_base_tile.png"],bone_wastes:["isometric_dead_grass_tile_withered.png","isometric_dead_grass_tile_brown.png","isometric_grass_tile_sparse.png"],the_void:["isometric_dead_grass_tile_withered.png","isometric_stone_block_gray_cracked.png"],drowned_depths:["isometric_grass_tile_dense.png","isometric_grass_tile_with_mushrooms.png","isometric_grass_tile_sparse.png"],edilas:["isometric_grass_tile_dense.png","isometric_grass_tile_mixed_flowers.png","isometric_grass_tile_pink_flowers.png","isometric_grass_tile_white_flowers.png","isometric_grass_tile_with_clover.png"]},N_={haven:"rgba(40, 120, 30, 0.08)",rotwood:"rgba(30, 80, 20, 0.14)",ashlands:"rgba(140, 50, 0, 0.22)",drowned_depths:"rgba(0, 50, 120, 0.18)",bone_wastes:"rgba(70, 60, 35, 0.18)",the_void:"rgba(70, 0, 100, 0.28)",edilas:"rgba(50, 130, 50, 0.1)"},yr={tx:0,ty:0},wi={sx:0,sy:0},br={wx:0,wy:0};class O_{_loader;_tileImages=new Map;_getTile;_loaded=!1;_getCorruption=null;_frameCount=0;constructor(e,t){this._loader=e,this._getTile=t}setCorruptionQuery(e){this._getCorruption=e}async preload(){const e=new Set;for(const s of Object.values(pl))for(const a of s)e.add(Ui+a);for(const s of Object.values(gr))for(const a of s)e.add(Ui+a);for(const s of W_)e.add(Ui+s);const t=[...e],i=await this._loader.loadMany(t);for(const[s,a]of i)this._tileImages.set(s,a);this._loaded=!0,console.log(`[IsometricRenderer] Loaded ${i.size} tile images`)}worldToTile(e,t){return yr.tx=Math.floor(e/L),yr.ty=Math.floor(t/L),yr}tileToScreen(e,t){return wi.sx=(e-t)*Re,wi.sy=(e+t)*Te,wi}worldToScreen(e,t){const i=e/L,s=t/L;return wi.sx=(i-s)*Re,wi.sy=(i+s)*Te,wi}screenToWorld(e,t){const i=(e/Re+t/Te)/2,s=(t/Te-e/Re)/2;return br.wx=i*L,br.wy=s*L,br}render(e,t,i,s,a){const n=s/2,l=a/2,h=t+n,c=i+l,d=this.screenToWorld(h,c),u=Math.floor(d.wx/L),f=Math.floor(d.wy/L),m=Math.min(Math.ceil(s/Re/2)+3,20),_=Math.min(Math.ceil(a/Te/2)+3,18);this._frameCount++;const p=this._frameCount%4===0&&this._getCorruption!==null;for(let g=f-_;g<=f+_;g++)for(let y=u-m;y<=u+m;y++){const S=(y-g)*Re,b=(y+g)*Te,w=S-t|0,k=b-i|0;w<-Re*2||w>s+Re*2||k<-Te*2||k>a+Te*2||this._drawTile(e,w,k,y,g,p)}}_drawTile(e,t,i,s,a,r){const n=this._getTile(s,a);let l;if(n.type===0&&gr[n.biome]?l=gr[n.biome]:l=pl[n.type],l&&l.length>0){const h=l[Math.abs((s*7+a*13)%l.length)],c=this._tileImages.get(Ui+h);if(c){const d=t-Re,u=i,f=Re*2,m=Te*2;e.drawImage(c,d,u,f,m),n.type===9&&(e.fillStyle="rgba(80, 0, 120, 0.22)",e.fillRect(d,u,f,m));const _=N_[n.biome];_&&(e.fillStyle=_,e.fillRect(d,u,f,m)),(n.type===0||n.type===1)&&this._drawDecoration(e,t,i,s,a);return}}this._drawProceduralDiamond(e,t,i,n)}_drawProceduralDiamond(e,t,i,s){const a=Sa[s.biome]??Sa.haven;let r;s.type===9?r=["#3a1a4a","#2a0a3a","#4a2a5a"]:s.type===6?r=a.water:s.type===1?r=a.dirt:s.type===2?r=a.stone:r=a.grass;const n=r[s.variant%r.length]??"#5a9c4a";if(e.beginPath(),e.moveTo(t,i),e.lineTo(t+Re,i+Te),e.lineTo(t,i+Te*2),e.lineTo(t-Re,i+Te),e.closePath(),e.fillStyle=n,e.fill(),s.type===6){const h=.08+(this._frameCount+s.variant*17)%120/120*.06;e.fillStyle=`rgba(180, 220, 255, ${h})`,e.fill();const c=t+s.variant*7%12-6,d=i+Te+s.variant*11%8-4;e.fillStyle="rgba(200, 240, 255, 0.15)",e.beginPath(),e.ellipse(c,d,4,2,0,0,Math.PI*2),e.fill()}e.strokeStyle="rgba(0,0,0,0.06)",e.lineWidth=.5,e.stroke(),s.type===9&&(e.fillStyle="rgba(100, 0, 150, 0.15)",e.beginPath(),e.moveTo(t,i),e.lineTo(t+Re,i+Te),e.lineTo(t,i+Te*2),e.lineTo(t-Re,i+Te),e.closePath(),e.fill())}_drawDecoration(e,t,i,s,a){const r=(s*73856093^a*19349663)>>>0,n=(s*83492791^a*47165837)>>>0,l=this._getTile(s,a).biome;let h,c;switch(l){case"rotwood":h=16,c=Vc;break;case"ashlands":h=8,c=qc;break;case"drowned_depths":h=12,c=Yc;break;case"bone_wastes":h=6,c=Uc;break;case"the_void":h=5,c=jc;break;case"edilas":h=18,c=ho;break;default:h=14,c=ho;break}if(r%100>=h)return;const d=n%c.length,u=c[d],f=this._tileImages.get(Ui+u);if(!f||!f.naturalWidth)return;const m=(r>>8)%11-5,_=(r>>16)%7-3,g=12+(n>>8)%9,y=g*(f.naturalHeight/f.naturalWidth);e.drawImage(f,t+m-g/2,i+Te+_-y+2,g,y)}invalidateAll(){}}const Oo="Sprites/Character/",Kc="20.01a - Character Base 2.5c/",G_="21.01a - Hairstyle Pack v0.5.3/",H_=new Set(["bob1","dap1"]);function Qc(o,e){return`${Oo}${Kc}char_a_${o}/char_a_${o}_0bas_humn_${e}.png`}function Zc(o,e,t){const i=H_.has(e)?Kc:G_;return`${Oo}${i}char_a_${o}/4har/char_a_${o}_4har_${e}_${t}.png`}function Jc(o,e,t,i,s){return`${Oo}${e}/char_a_${o}/${t}/char_a_${o}_${t}_${i}_${s}.png`}function wr(o,e,t,i){const s=Rc[e];if(!s)return null;const a=_p[t]??0,r=s.row+a,n=s.col+i%s.frames;return n>=fp?null:{image:o,sx:n*Ei,sy:r*ms,sw:Ei,sh:ms}}async function z_(o,e,t=["p1"],i=[e.skinTone]){const s=[];for(const a of t){for(const r of i)s.push(o.tryLoad(Qc(a,r)));e.hairstyle&&s.push(o.tryLoad(Zc(a,e.hairstyle,e.hairColor))),e.outfitPack&&e.outfitLayer&&e.outfitCode&&e.outfitVariant&&s.push(o.tryLoad(Jc(a,e.outfitPack,e.outfitLayer,e.outfitCode,e.outfitVariant)))}await Promise.all(s)}function ed(o,e,t,i){const s=i.page??"p1",a=e.get(Qc(s,t.skinTone));if(!a)return!1;const r=wr(a,i.animation,i.direction,i.frame);if(!r)return!1;if(o.save(),i.flipX?(o.translate(i.x+Ei*i.scale,i.y),o.scale(-i.scale,i.scale)):(o.translate(i.x,i.y),o.scale(i.scale,i.scale)),o.drawImage(r.image,r.sx,r.sy,r.sw,r.sh,0,0,Ei,ms),t.outfitPack&&t.outfitLayer&&t.outfitCode&&t.outfitVariant){const n=e.get(Jc(s,t.outfitPack,t.outfitLayer,t.outfitCode,t.outfitVariant));if(n){const l=wr(n,i.animation,i.direction,i.frame);l&&o.drawImage(l.image,l.sx,l.sy,l.sw,l.sh,0,0,Ei,ms)}}if(t.hairstyle){const n=e.get(Zc(s,t.hairstyle,t.hairColor));if(n){const l=wr(n,i.animation,i.direction,i.frame);l&&o.drawImage(l.image,l.sx,l.sy,l.sw,l.sh,0,0,Ei,ms)}}return o.restore(),!0}const Ma=[{id:"fierce",name:"Fierce",stat:"damage",minValue:2,maxValue:8,tier:"minor",prefix:!0},{id:"deadly",name:"Deadly",stat:"damage",minValue:8,maxValue:18,tier:"major",prefix:!0},{id:"ruinous",name:"Ruinous",stat:"damage",minValue:18,maxValue:35,tier:"grand",prefix:!0},{id:"keen",name:"Keen",stat:"critChance",minValue:.02,maxValue:.05,tier:"minor",prefix:!0},{id:"precise",name:"Precise",stat:"critChance",minValue:.05,maxValue:.1,tier:"major",prefix:!0},{id:"brutal",name:"Brutal",stat:"critDamage",minValue:.1,maxValue:.3,tier:"minor",prefix:!0},{id:"savage",name:"Savage",stat:"critDamage",minValue:.3,maxValue:.6,tier:"major",prefix:!0},{id:"swift",name:"Swift",stat:"speed",minValue:5,maxValue:15,tier:"minor",prefix:!0},{id:"blazing",name:"Blazing",stat:"speed",minValue:15,maxValue:30,tier:"major",prefix:!0},{id:"of_iron",name:"of Iron",stat:"defense",minValue:2,maxValue:6,tier:"minor",prefix:!1},{id:"of_steel",name:"of Steel",stat:"defense",minValue:6,maxValue:14,tier:"major",prefix:!1},{id:"of_mithril",name:"of Mithril",stat:"defense",minValue:14,maxValue:25,tier:"grand",prefix:!1},{id:"of_vigor",name:"of Vigor",stat:"health",minValue:10,maxValue:25,tier:"minor",prefix:!1},{id:"of_vitality",name:"of Vitality",stat:"health",minValue:25,maxValue:60,tier:"major",prefix:!1},{id:"of_stamina",name:"of Stamina",stat:"stamina",minValue:5,maxValue:15,tier:"minor",prefix:!1},{id:"of_endurance",name:"of Endurance",stat:"stamina",minValue:15,maxValue:35,tier:"major",prefix:!1},{id:"of_light",name:"of Light",stat:"purification",minValue:3,maxValue:8,tier:"minor",prefix:!1},{id:"of_radiance",name:"of Radiance",stat:"purification",minValue:8,maxValue:20,tier:"major",prefix:!1}],X_={common:0,uncommon:1,rare:2,epic:3,legendary:4,mythic:4},_l={uncommon:{minor:80,major:20,grand:0},rare:{minor:50,major:40,grand:10},epic:{minor:20,major:50,grand:30},legendary:{minor:5,major:35,grand:60},mythic:{minor:0,major:20,grand:80}};function V_(o){const e=X_[o]??0;if(e===0)return[];const t=_l[o]??_l.uncommon,i=[],s=new Set;for(let a=0;a<e;a++){const r=Math.random()*100;let n;r<t.minor?n="minor":r<t.minor+t.major?n="major":n="grand";const l=Ma.filter(d=>d.tier===n&&!s.has(d.stat));if(l.length===0){const d=Ma.filter(m=>!s.has(m.stat));if(d.length===0)break;const u=d[Math.floor(Math.random()*d.length)],f=+(u.minValue+Math.random()*(u.maxValue-u.minValue)).toFixed(3);i.push({id:u.id,name:u.name,stat:u.stat,value:f}),s.add(u.stat);continue}const h=l[Math.floor(Math.random()*l.length)],c=+(h.minValue+Math.random()*(h.maxValue-h.minValue)).toFixed(3);i.push({id:h.id,name:h.name,stat:h.stat,value:c}),s.add(h.stat)}return i}function q_(o,e){const t=e.filter(r=>Ma.find(n=>n.id===r.id)?.prefix),i=e.filter(r=>!Ma.find(n=>n.id===r.id)?.prefix),s=t.length>0?t[0].name+" ":"",a=i.length>0?" "+i[0].name:"";return`${s}${o}${a}`}const rt={common:"#9ca3af",uncommon:"#4ade80",rare:"#60a5fa",epic:"#a78bfa",legendary:"#f59e0b",mythic:"#ef4444"},ga={wooden_sword:{id:"wooden_sword",name:"Wooden Sword",icon:"",category:"weapon",rarity:"common",stackable:!1,maxStack:1,value:25,description:"A basic training sword. Better than bare hands.",weaponType:"sword",damageType:"physical",stats:{damage:5}},iron_sword:{id:"iron_sword",name:"Iron Sword",icon:"",category:"weapon",rarity:"common",stackable:!1,maxStack:1,value:100,description:"A reliable blade forged from iron.",weaponType:"sword",damageType:"physical",stats:{damage:12,critChance:.05}},steel_sword:{id:"steel_sword",name:"Steel Sword",icon:"",category:"weapon",rarity:"uncommon",stackable:!1,maxStack:1,value:350,description:"Well-forged steel with a keen edge.",weaponType:"sword",damageType:"physical",stats:{damage:22,critChance:.08,speed:5}},silver_sword:{id:"silver_sword",name:"Silver Sword",icon:"",category:"weapon",rarity:"uncommon",stackable:!1,maxStack:1,value:600,description:"Silver-plated blade effective against undead and corruption.",weaponType:"sword",damageType:"physical",stats:{damage:28,critChance:.09,speed:6}},purifier_blade:{id:"purifier_blade",name:"Purifier Blade",icon:"",category:"weapon",rarity:"rare",stackable:!1,maxStack:1,value:1200,description:"A sacred blade that cleanses corruption on each kill.",weaponType:"sword",damageType:"holy",stats:{damage:35,purification:5,critChance:.1}},mithril_blade:{id:"mithril_blade",name:"Mithril Blade",icon:"",category:"weapon",rarity:"rare",stackable:!1,maxStack:1,value:2500,description:"Lightweight and deadly. Forged from ancient mithril ore.",weaponType:"sword",damageType:"physical",stats:{damage:45,critChance:.12,speed:8}},corrupted_greatsword:{id:"corrupted_greatsword",name:"Corrupted Greatsword",icon:"",category:"weapon",rarity:"epic",stackable:!1,maxStack:1,value:2800,description:"A massive blade tainted by corruption. Powerful but dangerous.",weaponType:"sword",damageType:"void",stats:{damage:45,critChance:.12,critDamage:.3,speed:-3}},void_cleaver:{id:"void_cleaver",name:"Void Cleaver",icon:"",category:"weapon",rarity:"epic",stackable:!1,maxStack:1,value:5e3,description:"A weapon forged from void essence. Cuts through reality.",weaponType:"sword",damageType:"void",stats:{damage:55,critChance:.15,critDamage:.5},legendaryEffect:"chain_lightning"},edilas_edge:{id:"edilas_edge",name:"EDILAS' Edge",icon:"",category:"weapon",rarity:"mythic",stackable:!1,maxStack:1,value:5e4,description:"The final weapon. Forged at the gates of EDILAS itself.",weaponType:"sword",damageType:"holy",stats:{damage:100,purification:25,critChance:.2,critDamage:1,speed:10},legendaryEffect:"purification_spread"},hatchet:{id:"hatchet",name:"Hatchet",icon:"",category:"weapon",rarity:"common",stackable:!1,maxStack:1,value:30,description:"Small axe for chopping wood and enemies.",weaponType:"axe",damageType:"physical",stats:{damage:8}},battle_axe:{id:"battle_axe",name:"Battle Axe",icon:"",category:"weapon",rarity:"uncommon",stackable:!1,maxStack:1,value:400,description:"A heavy axe that cleaves through armor.",weaponType:"axe",damageType:"physical",stats:{damage:28,critDamage:.3}},shortbow:{id:"shortbow",name:"Shortbow",icon:"",category:"weapon",rarity:"common",stackable:!1,maxStack:1,value:80,description:"A simple wooden bow. Safe range advantage.",weaponType:"bow",damageType:"physical",stats:{damage:10,critChance:.08}},hunters_bow:{id:"hunters_bow",name:"Hunter's Bow",icon:"",category:"weapon",rarity:"uncommon",stackable:!1,maxStack:1,value:500,description:"A recurve bow crafted from resilient wood.",weaponType:"bow",damageType:"physical",stats:{damage:20,critChance:.12,speed:8}},apprentice_staff:{id:"apprentice_staff",name:"Apprentice Staff",icon:"",category:"weapon",rarity:"common",stackable:!1,maxStack:1,value:60,description:"Channels minor magical energy.",weaponType:"staff",damageType:"fire",stats:{damage:8}},storm_staff:{id:"storm_staff",name:"Storm Staff",icon:"",category:"weapon",rarity:"rare",stackable:!1,maxStack:1,value:2e3,description:"Crackles with lightning. Each strike chains.",weaponType:"staff",damageType:"lightning",stats:{damage:30,critChance:.1}},leather_cap:{id:"leather_cap",name:"Leather Cap",icon:"",category:"armor",rarity:"common",stackable:!1,maxStack:1,value:40,description:"Basic head protection.",armorSlot:"head",stats:{defense:3}},leather_vest:{id:"leather_vest",name:"Leather Vest",icon:"",category:"armor",rarity:"common",stackable:!1,maxStack:1,value:80,description:"Light armor offering minimal protection.",armorSlot:"chest",stats:{defense:5}},iron_helm:{id:"iron_helm",name:"Iron Helm",icon:"",category:"armor",rarity:"uncommon",stackable:!1,maxStack:1,value:200,description:"Solid iron helmet.",armorSlot:"head",stats:{defense:8,health:10}},iron_chestplate:{id:"iron_chestplate",name:"Iron Chestplate",icon:"",category:"armor",rarity:"uncommon",stackable:!1,maxStack:1,value:400,description:"Heavy iron armor. Slows you down but keeps you alive.",armorSlot:"chest",stats:{defense:15,health:20,speed:-5}},chainmail_helm:{id:"chainmail_helm",name:"Chainmail Coif",icon:"",category:"armor",rarity:"uncommon",stackable:!1,maxStack:1,value:350,description:"Interlocking chain rings protect without weighing you down.",armorSlot:"head",stats:{defense:11,health:15}},chainmail_chestplate:{id:"chainmail_chestplate",name:"Chainmail Hauberk",icon:"",category:"armor",rarity:"uncommon",stackable:!1,maxStack:1,value:700,description:"Full-body chainmail. Good balance of protection and mobility.",armorSlot:"chest",stats:{defense:20,health:25,speed:-2}},pilgrim_cloak:{id:"pilgrim_cloak",name:"Pilgrim's Cloak",icon:"",category:"armor",rarity:"rare",stackable:!1,maxStack:1,value:1500,description:"Woven with purification threads. Resists corruption.",armorSlot:"cape",stats:{defense:10,purification:8,speed:5}},venom_blade:{id:"venom_blade",name:"Venom Blade",icon:"",category:"weapon",rarity:"rare",stackable:!1,maxStack:1,value:800,description:"A blade coated in serpent venom. Poisons on hit.",weaponType:"sword",damageType:"poison",stats:{damage:25,critChance:.12}},bone_shield:{id:"bone_shield",name:"Bone Shield",icon:"",category:"armor",rarity:"rare",stackable:!1,maxStack:1,value:900,description:"Fashioned from cursed bones. Absorbs dark energy.",armorSlot:"gloves",stats:{defense:18,health:15}},spider_silk_robe:{id:"spider_silk_robe",name:"Spider Silk Robe",icon:"",category:"armor",rarity:"uncommon",stackable:!1,maxStack:1,value:600,description:"Lightweight and surprisingly durable. Increases speed.",armorSlot:"chest",stats:{defense:8,speed:15,stamina:20}},void_staff:{id:"void_staff",name:"Void Staff",icon:"",category:"weapon",rarity:"epic",stackable:!1,maxStack:1,value:2500,description:"Channels the void itself. Devastating magical damage.",weaponType:"staff",damageType:"void",stats:{damage:40,critChance:.15,critDamage:.5},legendaryEffect:"elemental_burst"},bear_cloak:{id:"bear_cloak",name:"Bear Cloak",icon:"",category:"armor",rarity:"uncommon",stackable:!1,maxStack:1,value:450,description:"A thick cloak of bear fur. Provides warmth and protection.",armorSlot:"cape",stats:{defense:12,health:30}},ghost_ward:{id:"ghost_ward",name:"Ghost Ward",icon:"",category:"accessory",rarity:"rare",stackable:!1,maxStack:1,value:700,description:"An ethereal talisman. Spectral enemies deal less damage.",stats:{defense:5,purification:10}},ink_bomb:{id:"ink_bomb",name:"Ink Bomb",icon:"",category:"consumable",rarity:"common",stackable:!0,maxStack:10,value:35,description:"Blinds nearby enemies temporarily. Useful for escapes."},health_potion:{id:"health_potion",name:"Health Potion",icon:"",category:"potion",rarity:"common",stackable:!0,maxStack:20,value:30,description:"Restores 50 HP.",healAmount:50},superior_health_potion:{id:"superior_health_potion",name:"Superior Health Potion",icon:"",category:"potion",rarity:"uncommon",stackable:!0,maxStack:15,value:60,description:"Restores 100 HP. A step above basic potions.",healAmount:100},greater_health_potion:{id:"greater_health_potion",name:"Greater Health Potion",icon:"",category:"potion",rarity:"uncommon",stackable:!0,maxStack:10,value:100,description:"Restores 150 HP.",healAmount:150},stamina_tonic:{id:"stamina_tonic",name:"Stamina Tonic",icon:"",category:"potion",rarity:"common",stackable:!0,maxStack:20,value:25,description:"Restores 40 stamina."},antidote:{id:"antidote",name:"Antidote",icon:"",category:"potion",rarity:"common",stackable:!0,maxStack:10,value:50,description:"Cures poison and corruption sickness."},bread:{id:"bread",name:"Bread",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:10,description:"Simple bread. Restores hunger.",healAmount:15},raw_fish:{id:"raw_fish",name:"Raw Fish",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:30,value:10,description:"Freshly caught fish. Cook it for a proper meal."},grilled_fish:{id:"grilled_fish",name:"Grilled Fish",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:30,value:25,description:"Fresh-caught and grilled. Restores health and hunger.",healAmount:30},mushroom_stew:{id:"mushroom_stew",name:"Mushroom Stew",icon:"",category:"food",rarity:"uncommon",stackable:!0,maxStack:10,value:50,description:"Hearty stew. Grants stamina regen buff.",healAmount:40,buffDuration:120},golden_feast:{id:"golden_feast",name:"Golden Feast",icon:"",category:"food",rarity:"rare",stackable:!0,maxStack:5,value:500,description:"A legendary meal. Full restoration + all stats boosted.",healAmount:200,buffDuration:300},wood:{id:"wood",name:"Wood",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:2,description:"Basic building material."},stone:{id:"stone",name:"Stone",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:3,description:"Sturdy building material."},iron_ore:{id:"iron_ore",name:"Iron Ore",icon:"",category:"ore",rarity:"common",stackable:!0,maxStack:999,value:10,description:"Raw iron. Smelt at a forge."},iron_bar:{id:"iron_bar",name:"Iron Bar",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:25,description:"Smelted iron. Used in crafting."},gold_ore:{id:"gold_ore",name:"Gold Ore",icon:"",category:"ore",rarity:"uncommon",stackable:!0,maxStack:999,value:50,description:"Precious gold ore."},gold_bar:{id:"gold_bar",name:"Gold Bar",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:999,value:125,description:"Pure gold. Valuable for trade and crafting."},crystal:{id:"crystal",name:"Crystal",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:99,value:80,description:"A translucent crystal found in caves. Crafting component."},corruption_shard:{id:"corruption_shard",name:"Corruption Shard",icon:"",category:"material",rarity:"rare",stackable:!0,maxStack:50,value:150,description:"A shard of solidified corruption. Dangerous to handle."},moonpetal:{id:"moonpetal",name:"Moonpetal",icon:"",category:"material",rarity:"rare",stackable:!0,maxStack:30,value:100,description:"A rare flower that blooms only at night. Alchemical ingredient."},void_shard:{id:"void_shard",name:"Void Shard",icon:"",category:"material",rarity:"epic",stackable:!0,maxStack:99,value:500,description:"Fragment of void energy. Radiates corruption."},purification_crystal:{id:"purification_crystal",name:"Purification Crystal",icon:"",category:"material",rarity:"rare",stackable:!0,maxStack:50,value:300,description:"Crystallized light. Used to cleanse corruption."},titan_bone:{id:"titan_bone",name:"Titan Bone",icon:"",category:"trophy",rarity:"legendary",stackable:!0,maxStack:10,value:5e3,description:"Bone from a fallen titan. Legendary crafting material."},corruption_essence:{id:"corruption_essence",name:"Corruption Essence",icon:"",category:"material",rarity:"rare",stackable:!0,maxStack:99,value:200,description:"Distilled corruption. Dangerous but useful."},monster_hide:{id:"monster_hide",name:"Monster Hide",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:15,description:"Thick hide from beasts."},herb:{id:"herb",name:"Medicinal Herb",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:5,description:"Useful for potions and poultices."},fiber:{id:"fiber",name:"Plant Fiber",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:1,description:"Can be woven into cloth."},cloth:{id:"cloth",name:"Cloth",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:8,description:"Woven fabric for crafting."},slime_gel:{id:"slime_gel",name:"Slime Gel",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:8,description:"Bouncy gel dropped by slimes."},bone_fragment:{id:"bone_fragment",name:"Bone Fragment",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:12,description:"Bone shard from skeletons."},shadow_essence:{id:"shadow_essence",name:"Shadow Essence",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:99,value:80,description:"Wispy dark energy from shadow creatures."},spore_cap:{id:"spore_cap",name:"Spore Cap",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:10,description:"Mushroom cap with alchemical properties."},wolf_pelt:{id:"wolf_pelt",name:"Wolf Pelt",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:20,description:"Warm pelt from a wolf."},raw_meat:{id:"raw_meat",name:"Raw Meat",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:8,description:"Uncooked meat. Cook it at a campfire for better effects.",healAmount:5},coal:{id:"coal",name:"Coal",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:4,description:"Fuel for furnaces and forges."},copper_ore:{id:"copper_ore",name:"Copper Ore",icon:"",category:"ore",rarity:"common",stackable:!0,maxStack:999,value:6,description:"Raw copper ore. Smelt at a forge."},pickaxe:{id:"pickaxe",name:"Pickaxe",icon:"",category:"tool",rarity:"common",stackable:!1,maxStack:1,value:50,description:"Mines ore and breaks rocks."},fishing_rod:{id:"fishing_rod",name:"Fishing Rod",icon:"",category:"tool",rarity:"common",stackable:!1,maxStack:1,value:40,description:"Cast into water to catch fish."},lantern:{id:"lantern",name:"Lantern",icon:"",category:"tool",rarity:"common",stackable:!1,maxStack:1,value:60,description:"Lights the way in dark places. Repels shadow creatures."},purifier:{id:"purifier",name:"Purification Beacon",icon:"",category:"tool",rarity:"rare",stackable:!1,maxStack:1,value:2e3,description:"Place to cleanse corruption in a radius."},dungeon_key:{id:"dungeon_key",name:"Dungeon Key",icon:"",category:"key",rarity:"uncommon",stackable:!0,maxStack:5,value:0,description:"Opens dungeon doors."},corruption_core:{id:"corruption_core",name:"Corruption Core",icon:"",category:"quest",rarity:"legendary",stackable:!1,maxStack:1,value:0,description:"The heart of corruption in this biome. Destroy it to purify the land."},rift_crystal:{id:"rift_crystal",name:"Rift Crystal",icon:"",category:"key",rarity:"rare",stackable:!0,maxStack:10,value:250,description:"Opens passage into a dimensional rift."},wheat:{id:"wheat",name:"Wheat",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:99,value:8,description:"Harvested wheat. Used for baking bread."},carrot:{id:"carrot",name:"Carrot",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:12,description:"Fresh carrot. Restores a small amount of hunger.",healAmount:8},potato:{id:"potato",name:"Potato",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:10,description:"Raw potato. Cook it for better nourishment.",healAmount:5},tomato:{id:"tomato",name:"Tomato",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:15,description:"Ripe tomato. Restores hunger.",healAmount:10},corn:{id:"corn",name:"Corn",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:18,description:"Sweet corn. Good food source.",healAmount:12},pumpkin:{id:"pumpkin",name:"Pumpkin",icon:"",category:"food",rarity:"uncommon",stackable:!0,maxStack:20,value:50,description:"Large pumpkin. Makes hearty stew.",healAmount:20},wheat_seed:{id:"wheat_seed",name:"Wheat Seeds",icon:"",category:"seed",rarity:"common",stackable:!0,maxStack:999,value:5,description:"Plant in tilled soil. Grows in 4 days."},potato_seed:{id:"potato_seed",name:"Potato Seeds",icon:"",category:"seed",rarity:"common",stackable:!0,maxStack:999,value:8,description:"Plant in tilled soil. Grows in 6 days."},moonpetal_seed:{id:"moonpetal_seed",name:"Moonpetal Seeds",icon:"",category:"seed",rarity:"rare",stackable:!0,maxStack:99,value:200,description:"Rare flower that blooms at night. Alchemical ingredient."},tomato_seed:{id:"tomato_seed",name:"Tomato Seeds",icon:"",category:"seed",rarity:"common",stackable:!0,maxStack:999,value:7,description:"Plant in tilled soil. Grows in 5 days. Regrows after harvest."},corn_seed:{id:"corn_seed",name:"Corn Seeds",icon:"",category:"seed",rarity:"common",stackable:!0,maxStack:999,value:10,description:"Plant in tilled soil. Grows in 7 days."},herb_seed:{id:"herb_seed",name:"Herb Seeds",icon:"",category:"seed",rarity:"common",stackable:!0,maxStack:999,value:4,description:"Plant in tilled soil. Grows in 3 days. Regrows after harvest."},firebloom_seed:{id:"firebloom_seed",name:"Firebloom Seeds",icon:"",category:"seed",rarity:"uncommon",stackable:!0,maxStack:99,value:150,description:"A flower that thrives in heat. Does not need water. Alchemical ingredient."},frostberry_seed:{id:"frostberry_seed",name:"Frostberry Seeds",icon:"",category:"seed",rarity:"uncommon",stackable:!0,maxStack:99,value:120,description:"A berry bush that grows in winter. Does not need water. Regrows after harvest."},ruby:{id:"ruby",name:"Ruby",icon:"",category:"gem",rarity:"rare",stackable:!0,maxStack:99,value:400,description:"A fiery gemstone. Enhances fire damage."},sapphire:{id:"sapphire",name:"Sapphire",icon:"",category:"gem",rarity:"rare",stackable:!0,maxStack:99,value:400,description:"A cool gemstone. Enhances ice resistance."},emerald:{id:"emerald",name:"Emerald",icon:"",category:"gem",rarity:"rare",stackable:!0,maxStack:99,value:400,description:"A verdant gemstone. Enhances healing."},void_gem:{id:"void_gem",name:"Void Gem",icon:"",category:"gem",rarity:"legendary",stackable:!0,maxStack:10,value:5e3,description:"Contains compressed void energy. Used in mythic crafting."},rusty_dagger:{id:"rusty_dagger",name:"Rusty Dagger",icon:"",category:"weapon",rarity:"common",stackable:!1,maxStack:1,value:15,description:"A corroded blade. Fast but weak.",weaponType:"dagger",damageType:"physical",stats:{damage:4,speed:15,critChance:.1}},shadow_dagger:{id:"shadow_dagger",name:"Shadow Dagger",icon:"",category:"weapon",rarity:"rare",stackable:!1,maxStack:1,value:1800,description:"A blade that strikes from the shadows. High crit damage.",weaponType:"dagger",damageType:"void",stats:{damage:20,speed:20,critChance:.25,critDamage:.8}},wooden_spear:{id:"wooden_spear",name:"Wooden Spear",icon:"",category:"weapon",rarity:"common",stackable:!1,maxStack:1,value:20,description:"A sharpened wooden pole. Keeps enemies at bay.",weaponType:"spear",damageType:"physical",stats:{damage:7}},trident:{id:"trident",name:"Trident",icon:"",category:"weapon",rarity:"uncommon",stackable:!1,maxStack:1,value:450,description:"Three-pronged spear favored by ocean warriors.",weaponType:"spear",damageType:"physical",stats:{damage:24,critChance:.07}},stone_hammer:{id:"stone_hammer",name:"Stone Hammer",icon:"",category:"weapon",rarity:"common",stackable:!1,maxStack:1,value:35,description:"Heavy and slow, but devastating on impact.",weaponType:"hammer",damageType:"physical",stats:{damage:12,speed:-10,critDamage:.4}},titan_maul:{id:"titan_maul",name:"Titan Maul",icon:"",category:"weapon",rarity:"epic",stackable:!1,maxStack:1,value:6e3,description:"Forged from titan bone. Shakes the earth on impact.",weaponType:"hammer",damageType:"physical",stats:{damage:65,speed:-15,critDamage:.8},craftingMaterials:[{itemId:"titan_bone",count:3},{itemId:"iron_bar",count:10}],legendaryEffect:"titan_slayer"},harvest_scythe:{id:"harvest_scythe",name:"Harvest Scythe",icon:"",category:"weapon",rarity:"common",stackable:!1,maxStack:1,value:45,description:"A farming tool repurposed for combat.",weaponType:"scythe",damageType:"physical",stats:{damage:10,speed:5}},death_scythe:{id:"death_scythe",name:"Death's Scythe",icon:"",category:"weapon",rarity:"legendary",stackable:!1,maxStack:1,value:15e3,description:"The reaper follows where this blade swings.",weaponType:"scythe",damageType:"void",stats:{damage:75,speed:10,critChance:.18,critDamage:.6},legendaryEffect:"lifesteal_aura"},steel_helm:{id:"steel_helm",name:"Steel Helm",icon:"",category:"armor",rarity:"rare",stackable:!1,maxStack:1,value:600,description:"Reinforced steel headgear.",armorSlot:"head",stats:{defense:14,health:20}},steel_chestplate:{id:"steel_chestplate",name:"Steel Chestplate",icon:"",category:"armor",rarity:"rare",stackable:!1,maxStack:1,value:1200,description:"Heavy steel plate. Excellent protection.",armorSlot:"chest",stats:{defense:25,health:30,speed:-8}},leather_boots:{id:"leather_boots",name:"Leather Boots",icon:"",category:"armor",rarity:"common",stackable:!1,maxStack:1,value:50,description:"Basic footwear for the road.",armorSlot:"boots",stats:{defense:2,speed:5}},iron_gauntlets:{id:"iron_gauntlets",name:"Iron Gauntlets",icon:"",category:"armor",rarity:"uncommon",stackable:!1,maxStack:1,value:250,description:"Armored gloves that protect the hands.",armorSlot:"gloves",stats:{defense:6,damage:2}},leather_leggings:{id:"leather_leggings",name:"Leather Leggings",icon:"",category:"armor",rarity:"common",stackable:!1,maxStack:1,value:60,description:"Sturdy leg protection for travelers.",armorSlot:"legs",stats:{defense:4}},copper_ring:{id:"copper_ring",name:"Copper Ring",icon:"",category:"accessory",rarity:"common",stackable:!1,maxStack:1,value:30,description:"A simple copper band. Slight health boost.",armorSlot:"ring",stats:{health:10}},silver_amulet:{id:"silver_amulet",name:"Silver Amulet",icon:"",category:"accessory",rarity:"uncommon",stackable:!1,maxStack:1,value:200,description:"A silver pendant that wards off minor corruption.",armorSlot:"amulet",stats:{defense:3,purification:3}},wolf_fang_necklace:{id:"wolf_fang_necklace",name:"Wolf Fang Necklace",icon:"",category:"accessory",rarity:"epic",stackable:!1,maxStack:1,value:3e3,description:"Trophy from the Alpha. Boosts crit chance.",armorSlot:"amulet",stats:{critChance:.15,damage:8}},fire_resistance_potion:{id:"fire_resistance_potion",name:"Fire Resistance Potion",icon:"",category:"potion",rarity:"uncommon",stackable:!0,maxStack:10,value:75,description:"Grants fire resistance for 60 seconds.",buffDuration:60},ice_resistance_potion:{id:"ice_resistance_potion",name:"Ice Resistance Potion",icon:"",category:"potion",rarity:"uncommon",stackable:!0,maxStack:10,value:75,description:"Grants ice resistance for 60 seconds.",buffDuration:60},speed_potion:{id:"speed_potion",name:"Speed Potion",icon:"",category:"potion",rarity:"uncommon",stackable:!0,maxStack:10,value:60,description:"Increases movement speed for 30 seconds.",buffDuration:30},elixir_of_purification:{id:"elixir_of_purification",name:"Elixir of Purification",icon:"",category:"potion",rarity:"rare",stackable:!0,maxStack:5,value:500,description:"Removes all corruption sickness and grants temporary immunity.",buffDuration:120},apple:{id:"apple",name:"Apple",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:5,description:"A fresh apple. Light snack.",healAmount:10},cooked_meat:{id:"cooked_meat",name:"Cooked Meat",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:30,value:20,description:"Grilled meat. Restores health and fills hunger.",healAmount:25},berry_pie:{id:"berry_pie",name:"Berry Pie",icon:"",category:"food",rarity:"uncommon",stackable:!0,maxStack:10,value:80,description:"Sweet and nourishing. Grants stamina regen.",healAmount:35,buffDuration:90},travelers_ration:{id:"travelers_ration",name:"Traveler's Ration",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:20,value:15,description:"Compact food for long journeys. Slow but reliable.",healAmount:20},water_flask:{id:"water_flask",name:"Water Flask",icon:"",category:"consumable",rarity:"common",stackable:!0,maxStack:10,value:5,description:"Clean water. Restores thirst.",healAmount:0},beer:{id:"beer",name:"Beer",icon:"",category:"consumable",rarity:"common",stackable:!0,maxStack:20,value:15,description:"Tavern brew. Restores thirst and boosts comfort.",healAmount:5,buffDuration:60},berry_juice:{id:"berry_juice",name:"Berry Juice",icon:"",category:"consumable",rarity:"common",stackable:!0,maxStack:20,value:12,description:"Sweet and refreshing. Restores thirst.",healAmount:8},honey:{id:"honey",name:"Honey",icon:"",category:"food",rarity:"uncommon",stackable:!0,maxStack:30,value:25,description:"Golden wildflower honey. Sweet and restorative.",healAmount:15},sushi:{id:"sushi",name:"Sushi",icon:"",category:"food",rarity:"uncommon",stackable:!0,maxStack:10,value:40,description:"Expertly prepared. Grants stamina regen.",healAmount:30,buffDuration:60},noodles:{id:"noodles",name:"Noodles",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:20,value:20,description:"Warm bowl of noodles. Fills hunger and warms you up.",healAmount:18},cabbage:{id:"cabbage",name:"Cabbage",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:8,description:"Leafy green. Good in stews.",healAmount:6},onion:{id:"onion",name:"Onion",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:8,description:"Pungent root vegetable. Essential for cooking.",healAmount:4},strawberry:{id:"strawberry",name:"Strawberry",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:15,description:"Sweet summer berry.",healAmount:8},watermelon:{id:"watermelon",name:"Watermelon",icon:"",category:"food",rarity:"uncommon",stackable:!0,maxStack:10,value:30,description:"Juicy and hydrating. Restores thirst too.",healAmount:15},blueberry:{id:"blueberry",name:"Blueberry",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:99,value:3,description:"Wild blueberries. Tiny but sweet.",healAmount:3},raspberry:{id:"raspberry",name:"Raspberry",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:99,value:3,description:"Tart wild raspberries.",healAmount:3},blackberry:{id:"blackberry",name:"Blackberry",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:99,value:3,description:"Dark wild blackberries.",healAmount:3},sunflower:{id:"sunflower",name:"Sunflower",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:50,value:10,description:"Bright yellow flower. Used in alchemy and gifts."},rose:{id:"rose",name:"Rose",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:50,value:20,description:"Fragrant red rose. Popular gift."},lavender:{id:"lavender",name:"Lavender",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:50,value:12,description:"Calming purple herb. Used in potions and perfumes."},mushroom:{id:"mushroom",name:"Mushroom",icon:"",category:"food",rarity:"common",stackable:!0,maxStack:50,value:5,description:"Forest mushroom. Edible but not very filling.",healAmount:4},ash_powder:{id:"ash_powder",name:"Ash Powder",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:999,value:6,description:"Fine volcanic ash. Used in fire-resistant crafting."},frost_crystal:{id:"frost_crystal",name:"Frost Crystal",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:99,value:60,description:"A crystal of perpetual ice. Crafting component."},dragon_scale:{id:"dragon_scale",name:"Dragon Scale",icon:"",category:"trophy",rarity:"legendary",stackable:!0,maxStack:10,value:8e3,description:"Scale from a void dragon. Legendary crafting material."},magma_core:{id:"magma_core",name:"Magma Core",icon:"",category:"trophy",rarity:"epic",stackable:!0,maxStack:10,value:3e3,description:"The molten heart of a volcanic creature."},kraken_eye:{id:"kraken_eye",name:"Kraken Eye",icon:"",category:"trophy",rarity:"epic",stackable:!0,maxStack:10,value:4e3,description:"A massive eye from the deep one. Radiates ancient power."},cursed_blade:{id:"cursed_blade",name:"Cursed Blade",icon:"",category:"weapon",rarity:"legendary",stackable:!1,maxStack:1,value:1e4,description:"Taken from the Death Knight. Corrupts as it cuts.",weaponType:"sword",damageType:"void",stats:{damage:70,critChance:.12,critDamage:.4},legendaryEffect:"corruption_absorb"},legendary_hammer:{id:"legendary_hammer",name:"Hammer of Creation",icon:"",category:"tool",rarity:"legendary",stackable:!1,maxStack:1,value:2e4,description:"The ultimate crafting hammer. Guarantees perfect quality."},purifier_amulet:{id:"purifier_amulet",name:"Purifier Amulet",icon:"",category:"accessory",rarity:"legendary",stackable:!1,maxStack:1,value:15e3,description:"Radiates purifying light. Cleanses corruption passively.",armorSlot:"amulet",stats:{purification:25,defense:10},legendaryEffect:"purification_spread"},titan_set_blueprint:{id:"titan_set_blueprint",name:"Titan Set Blueprint",icon:"",category:"quest",rarity:"legendary",stackable:!1,maxStack:1,value:0,description:"Blueprint for crafting the legendary Titan armor set."},crown:{id:"crown",name:"Imperial Crown",icon:"",category:"accessory",rarity:"legendary",stackable:!1,maxStack:1,value:25e3,description:"A crown for the builder of empires.",armorSlot:"head",stats:{defense:20,health:50},legendaryEffect:"berserker_rage"},pilgrim_relic:{id:"pilgrim_relic",name:"True Pilgrim's Relic",icon:"",category:"relic",rarity:"mythic",stackable:!1,maxStack:1,value:1e5,description:"The ultimate reward. Proof of a completed pilgrimage.",stats:{damage:20,defense:20,health:50,stamina:50,speed:10,purification:30},legendaryEffect:"spectral_allies"},heart_key:{id:"heart_key",name:"Heart Key",icon:"",category:"key",rarity:"legendary",stackable:!1,maxStack:1,value:0,description:"Opens the gate to the Corruption Heart."},purifiers_mantle:{id:"purifiers_mantle",name:"Purifier's Mantle",icon:"",category:"armor",rarity:"mythic",stackable:!1,maxStack:1,value:5e4,description:"Woven from pure light. The ultimate corruption ward.",armorSlot:"cape",stats:{defense:30,purification:50,speed:10,health:30},legendaryEffect:"void_resistance"},edilas_fragment:{id:"edilas_fragment",name:"Fragment of EDILAS",icon:"",category:"relic",rarity:"mythic",stackable:!1,maxStack:1,value:0,description:"A shard of paradise. Carries the warmth of a world restored."},carrot_seed:{id:"carrot_seed",name:"Carrot Seeds",icon:"",category:"seed",rarity:"common",stackable:!0,maxStack:999,value:6,description:"Plant in tilled soil. Grows in 3 days."},pumpkin_seed:{id:"pumpkin_seed",name:"Pumpkin Seeds",icon:"",category:"seed",rarity:"uncommon",stackable:!0,maxStack:999,value:15,description:"Plant in tilled soil. Grows in 8 days. High value."},void_bloom_seed:{id:"void_bloom_seed",name:"Void Bloom Seeds",icon:"",category:"seed",rarity:"epic",stackable:!0,maxStack:50,value:500,description:"A flower that grows in corruption. Alchemical ingredient."},topaz:{id:"topaz",name:"Topaz",icon:"",category:"gem",rarity:"rare",stackable:!0,maxStack:99,value:400,description:"A warm gemstone. Enhances lightning damage."},diamond:{id:"diamond",name:"Diamond",icon:"",category:"gem",rarity:"epic",stackable:!0,maxStack:50,value:2e3,description:"The hardest gem. Used in legendary crafting."},gold_coin:{id:"gold_coin",name:"Gold",icon:"",category:"misc",rarity:"common",stackable:!0,maxStack:999999,value:1,description:"Standard currency."},bat_wing:{id:"bat_wing",name:"Bat Wing",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:99,value:5,description:"A leathery wing membrane. Used in alchemy."},bear_claw:{id:"bear_claw",name:"Bear Claw",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:50,value:35,description:"A massive claw from a corrupted bear. Crafting material for heavy weapons."},snake_scale:{id:"snake_scale",name:"Snake Scale",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:99,value:8,description:"Iridescent scales from a venomous serpent."},ink_sac:{id:"ink_sac",name:"Ink Sac",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:50,value:25,description:"Dark ink from an abyssal octopus. Used in enchanting."},tentacle:{id:"tentacle",name:"Tentacle",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:50,value:18,description:"A severed tentacle. Tough and flexible. Cooking ingredient."},mud_clod:{id:"mud_clod",name:"Mud Clod",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:99,value:2,description:"A compressed ball of swamp mud. Contains trace minerals."},ghost_feather:{id:"ghost_feather",name:"Ghost Feather",icon:"",category:"material",rarity:"rare",stackable:!0,maxStack:30,value:80,description:"An ethereal feather from a skeletal owl. Floats gently."},ancient_relic:{id:"ancient_relic",name:"Ancient Relic",icon:"",category:"relic",rarity:"epic",stackable:!0,maxStack:10,value:500,description:"A fragment of a long-lost civilization. Radiates faint power."},void_essence:{id:"void_essence",name:"Void Essence",icon:"",category:"material",rarity:"rare",stackable:!0,maxStack:50,value:100,description:"Concentrated void energy. Used in legendary crafting."},ectoplasm:{id:"ectoplasm",name:"Ectoplasm",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:50,value:30,description:"A wispy substance left behind by spectral entities."},spider_silk:{id:"spider_silk",name:"Spider Silk",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:99,value:15,description:"Strong, flexible silk from a giant spider. Crafting material for light armor."},venom_gland:{id:"venom_gland",name:"Venom Gland",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:50,value:40,description:"A potent venom sac. Essential for poison-coated weapons."},cursed_bark:{id:"cursed_bark",name:"Cursed Bark",icon:"",category:"material",rarity:"rare",stackable:!0,maxStack:30,value:60,description:"Bark from a corrupted treant. Pulses with dark energy."},soul_fragment:{id:"soul_fragment",name:"Soul Fragment",icon:"",category:"material",rarity:"rare",stackable:!0,maxStack:30,value:120,description:"A shard of captured soul energy. Used in necromantic crafting."},spirit_essence:{id:"spirit_essence",name:"Spirit Essence",icon:"",category:"material",rarity:"rare",stackable:!0,maxStack:30,value:90,description:"Pure spiritual energy. Enhances holy enchantments."},cursed_bone:{id:"cursed_bone",name:"Cursed Bone",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:50,value:25,description:"A bone radiating dark magic. Used in necromantic crafting."},fur:{id:"fur",name:"Animal Fur",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:99,value:8,description:"Soft animal fur. Used for warm clothing."},fang:{id:"fang",name:"Wolf Fang",icon:"",category:"material",rarity:"common",stackable:!0,maxStack:99,value:12,description:"A sharp fang from a predator. Jewelry component."},torch:{id:"torch",name:"Torch",icon:"",category:"tool",rarity:"common",stackable:!0,maxStack:10,value:10,description:"A simple torch. Provides light in dark areas."},rope:{id:"rope",name:"Rope",icon:"",category:"tool",rarity:"common",stackable:!0,maxStack:5,value:25,description:"Sturdy rope. Useful for climbing, crafting, and binding."},iron_shield:{id:"iron_shield",name:"Iron Shield",icon:"",category:"armor",rarity:"uncommon",stackable:!1,maxStack:1,value:180,armorSlot:"gloves",stats:{defense:12},description:"A solid iron shield. Blocks incoming attacks."},iron_helmet:{id:"iron_helmet",name:"Iron Helmet",icon:"",category:"armor",rarity:"uncommon",stackable:!1,maxStack:1,value:150,armorSlot:"head",stats:{defense:8},description:"A sturdy iron helmet. Protects the head."},stamina_potion:{id:"stamina_potion",name:"Stamina Potion",icon:"",category:"potion",rarity:"common",stackable:!0,maxStack:10,value:55,healAmount:40,buffDuration:0,description:"Restores stamina quickly. Tastes like lightning."},purification_potion:{id:"purification_potion",name:"Purification Potion",icon:"",category:"potion",rarity:"uncommon",stackable:!0,maxStack:5,value:100,stats:{purification:15},buffDuration:30,description:"Cleanses corruption from the body. Essential in blighted zones."},shadow_ore:{id:"shadow_ore",name:"Shadow Ore",icon:"",category:"material",rarity:"uncommon",stackable:!0,maxStack:50,value:45,description:"Dark metal that phases between dimensions. Used in high-tier crafting."},corrupted_crystal:{id:"corrupted_crystal",name:"Corrupted Crystal",icon:"",category:"material",rarity:"rare",stackable:!0,maxStack:30,value:180,description:"A crystal warped by shadow corruption. Pulses with dark energy."},twilight_shard:{id:"twilight_shard",name:"Twilight Shard",icon:"",category:"material",rarity:"epic",stackable:!0,maxStack:20,value:350,description:"Fragment of the boundary between dimensions."},dimensional_tear:{id:"dimensional_tear",name:"Dimensional Tear",icon:"",category:"material",rarity:"legendary",stackable:!0,maxStack:10,value:800,description:"A solidified rip in reality. Extremely rare and valuable."},shadow_silk:{id:"shadow_silk",name:"Shadow Silk",icon:"",category:"material",rarity:"epic",stackable:!0,maxStack:20,value:250,description:"Woven from threads of shadow. Light as air, strong as steel."}};function pe(o){return ga[o]}const Y_="rgba(42, 26, 10, 0.88)",U_="rgba(212, 160, 48, 0.25)",ya="#d4a030",vi="rgba(255,255,255,0.9)",Ys="rgba(255,255,255,0.5)",vr="#e53935",j_="#b71c1c",gl="#66bb6a",yl="#ffa726",bl="#42a5f5",K_="#26c6da",Q_="#00838f",wl="#d4a030",Us="#ff4444",vl="#44aaff",Sl="#ffcc00";function _i(o,e,t,i,s,a){o.beginPath(),o.moveTo(e+a,t),o.lineTo(e+i-a,t),o.quadraticCurveTo(e+i,t,e+i,t+a),o.lineTo(e+i,t+s-a),o.quadraticCurveTo(e+i,t+s,e+i-a,t+s),o.lineTo(e+a,t+s),o.quadraticCurveTo(e,t+s,e,t+s-a),o.lineTo(e,t+a),o.quadraticCurveTo(e,t,e+a,t),o.closePath()}function Ot(o,e,t,i,s,a=8){_i(o,e,t,i,s,a),o.fillStyle=Y_,o.fill(),o.strokeStyle=U_,o.lineWidth=1,o.stroke()}const Z_="rgba(0,0,0,0.4)";function di(o,e,t,i,s,a,r,n,l=3){if(_i(o,e,t,i,s,l),o.fillStyle="rgba(0,0,0,0.6)",o.fill(),o.strokeStyle=Z_,o.lineWidth=1,o.stroke(),a>0){const h=Math.max(l*2,i*Math.min(a,1));_i(o,e,t,h,s,l),o.fillStyle=r,o.fill(),_i(o,e,t,h,s/2,l),o.fillStyle="rgba(255,255,255,0.15)",o.fill()}}function J_(o,e,t,i,s,a,r=0,n=0,l,h,c=0,d=0,u="",f){o.save(),o.textBaseline="middle";const m=90,_=m+42,p=(v.width-_)/2,g=8;Ot(o,p,g,_,26),o.font="8px monospace",o.fillStyle=Ys,o.textAlign="left",o.fillText("HP",p+6,g+10),o.font="12px sans-serif",o.fillStyle=vr,o.fillText("",p+22,g+14);const y=e.health/e.maxHealth;let S=vr;y<.25&&y>0&&(S=Math.sin(performance.now()*.006)*.5+.5>.5?"#ff2222":vr),di(o,p+28,g+7,m,10,y,S,j_,4),o.font="9px monospace",o.fillStyle=y<.25?Us:vi,o.textAlign="center",o.fillText(`${Math.ceil(e.health)}/${Math.ceil(e.maxHealth)}`,p+30+(m-4)/2,g+14);const b=(v.width-280)/2,w=40;Ot(o,b,w,280,22);const k=e.stamina/e.maxStamina;let T=gl;k<.1&&k>0?T=Math.sin(performance.now()*.008)*.5+.5>.5?"#ff4444":"#cc8844":k<=0&&(T="#884444"),o.font="11px sans-serif",o.textAlign="left",o.fillStyle=k<=0?"#ff4444":gl,o.fillText("",b+4,w+12),di(o,b+17,w+6,50,8,k,T),o.font="7px monospace",o.fillStyle=k<.1?Us:vi,o.textAlign="center",o.fillText(`${Math.ceil(e.stamina)}`,b+42,w+12),o.font="11px sans-serif",o.textAlign="left",o.fillStyle=yl,o.fillText("",b+72,w+12),di(o,b+86,w+6,50,8,a.hunger/a.maxHunger,yl),o.font="7px monospace",o.fillStyle=vi,o.textAlign="center",o.fillText(`${Math.ceil(a.hunger)}`,b+111,w+12),o.font="11px sans-serif",o.textAlign="left",o.fillStyle=bl,o.fillText("",b+140,w+12),di(o,b+154,w+6,50,8,a.thirst/a.maxThirst,bl),o.font="7px monospace",o.fillStyle=vi,o.textAlign="center",o.fillText(`${Math.ceil(a.thirst)}`,b+179,w+12);const M=Math.max(0,Math.min(1,(a.temperature-30)/12)),C=a.isFreezing?"#4488ff":a.isOverheating?"#ff4444":K_;a.isFreezing||a.isOverheating,o.fillStyle=C,o.font="11px sans-serif",o.textAlign="left",o.fillText("",b+208,w+12),di(o,b+224,w+6,50,8,M,C),o.font="7px monospace",o.fillStyle=vi,o.textAlign="center",o.fillText(`${Math.round(a.temperature)}`,b+249,w+12);const P=[];if(a.isStarving?P.push({text:" STARVING",color:Us}):a.hunger/a.maxHunger<.25&&P.push({text:" Hungry",color:Sl}),a.isDehydrated?P.push({text:" DEHYDRATED",color:vl}):a.thirst/a.maxThirst<.25&&P.push({text:" Thirsty",color:"#60a5fa"}),a.isFreezing&&P.push({text:" FREEZING",color:vl}),a.isOverheating&&P.push({text:" OVERHEATING",color:Us}),a.isExhausted&&P.push({text:" EXHAUSTED",color:Sl}),P.length>0){const fe=w+26,ve=P.length*90,ae=(v.width-ve)/2,Me=.6+.4*Math.sin(performance.now()*.006);for(let Le=0;Le<P.length;Le++){const I=P[Le];o.globalAlpha=Me,o.font="bold 9px monospace",o.textAlign="center",o.fillStyle=I.color,o.fillText(I.text,ae+Le*90+45,fe+8)}o.globalAlpha=1}const R=60,B=8;Ot(o,R,B,100,26),o.font="9px monospace",o.fillStyle=Ys,o.textAlign="left",o.fillText("LV",R+8,B+14),o.font="12px monospace",o.fillStyle=ya,o.fillText(`${e.level}`,R+24,B+14);const F=e.xp/e.xpToNext;if(F>.8){const fe=.15+.1*Math.sin(performance.now()*.004);o.shadowColor=wl,o.shadowBlur=6,o.globalAlpha=fe}if(di(o,R+44,B+9,48,6,F,wl),F>.8&&(o.shadowBlur=0,o.globalAlpha=1),o.font="7px monospace",o.fillStyle=vi,o.textAlign="center",o.fillText(`${e.xp}/${e.xpToNext}`,R+68,B+14),n>0){const fe=.7+.3*Math.sin(performance.now()*.005);o.globalAlpha=fe;const ve=R+97,ae=B+3;o.fillStyle="#44ff88",o.beginPath(),o.arc(ve,ae,7,0,Math.PI*2),o.fill(),o.font="bold 8px monospace",o.fillStyle="#000",o.textAlign="center",o.textBaseline="middle",o.fillText(`${n}`,ve,ae),o.globalAlpha=1}const W=v.width-120,X=8;Ot(o,W,X,60,22),o.font="11px sans-serif",o.fillStyle=ya,o.textAlign="left",o.fillText("",W+6,X+12),o.font="11px monospace",o.fillStyle=ya,o.fillText(`${e.gold}`,W+22,X+12);const $=v.width-120,H=34;if(Ot(o,$,H,60,18,4),o.font="9px monospace",o.fillStyle=Ys,o.textAlign="center",o.fillText(`D${i} ${s}`,$+30,H+10),c>=2){const fe=["#aaaaaa","#4ade80","#3b82f6","#a855f7","#ef4444","#f59e0b"],ve=v.width-120,ae=56,Me=fe[Math.min(d,fe.length-1)]??"#aaaaaa";Ot(o,ve,ae,60,22,4);const Le=1+.08*Math.sin(performance.now()*.008);o.save(),o.translate(ve+30,ae+12),o.scale(Le,Le),o.font="bold 10px monospace",o.fillStyle=Me,o.textAlign="center",o.textBaseline="middle",o.fillText(` ${c}`,0,0),o.restore()}u&&(o.font="8px monospace",o.fillStyle="rgba(255,255,255,0.35)",o.textAlign="left",o.textBaseline="middle",o.fillText(u,7,70));const te=44,K=3,ee=9,ue=ee*te+(ee-1)*K+20,be=(v.width-ue)/2,Ee=v.height-68;Ot(o,be,Ee,ue,te+16,10);for(let fe=0;fe<ee;fe++){const ve=be+10+fe*(te+K),ae=Ee+8;if(_i(o,ve,ae,te,te,6),o.fillStyle="rgba(40,30,15,0.7)",o.fill(),o.strokeStyle="rgba(255,255,255,0.08)",o.lineWidth=1,o.stroke(),fe===r&&(_i(o,ve-1,ae-1,te+2,te+2,7),o.strokeStyle="rgba(212, 160, 48, 0.9)",o.lineWidth=2,o.stroke(),o.fillStyle="rgba(212, 160, 48, 0.8)",o.beginPath(),o.ellipse(ve+te/2,ae+te+4,8,2,0,0,Math.PI*2),o.fill()),o.font="8px monospace",o.fillStyle=Ys,o.textAlign="left",o.fillText(`${fe+1}`,ve+3,ae+9),l&&fe<l.length){const Me=l[fe];if(Me&&Me.count>0){const Le=pe(Me.itemId);if(Le){const I=h?.getItemSprite(Me.itemId);I?o.drawImage(I,ve+6,ae+6,te-12,te-12):(o.font="18px sans-serif",o.textAlign="center",o.fillStyle="#fff",o.fillText(Le.icon,ve+te/2,ae+te/2+4)),Me.count>1&&(o.font="bold 9px monospace",o.fillStyle="#fff",o.textAlign="right",o.fillText(`${Me.count}`,ve+te-3,ae+te-3)),_i(o,ve,ae,te,te,6),o.strokeStyle=rt[Le.rarity]??"#333",o.lineWidth=1,o.stroke()}}}}o.font="8px monospace",o.textAlign="center",o.fillStyle="rgba(255,255,255,0.35)",o.fillText("SPACE Attack  Z/X Skills  F Use Item  E Interact  I/TAB Inventory  K Craft",v.width/2,v.height-4),o.fillStyle="rgba(0,0,0,0.25)",o.fillRect(4,40,36,12),o.fillStyle="rgba(125,211,252,0.7)",o.font="8px monospace",o.textAlign="left",o.fillText(`${t}`,7,48),o.restore()}const kl="#9333ea",eg="#581c87";function tg(o,e,t){if(e<=.01&&t<=.01)return;o.save(),o.textBaseline="middle";const i=80,s=v.width-i-12,a=82;Ot(o,s,a,i,36,6),o.font="7px monospace",o.fillStyle=kl,o.textAlign="left",o.fillText("CORRUPTION",s+6,a+8);const r=e>.7?.7+.3*Math.sin(performance.now()*.005):1;o.globalAlpha=r,di(o,s+6,a+14,i-12,6,Math.min(1,e),kl,eg,2),o.globalAlpha=1,o.font="7px monospace",o.fillStyle=e>.7?"#ff6666":"rgba(255,255,255,0.6)",o.textAlign="right",o.fillText(`${Math.round(e*100)}%`,s+i-6,a+8),t>0&&(o.font="6px monospace",o.fillStyle="#66ffaa",o.textAlign="center",o.fillText(` ${Math.round(t*100)}% purified`,s+i/2,a+30)),o.restore()}const ig={pilgrim:"",warrior:"",ranger:"",mage:"",shadow:"",paladin:""};function sg(o,e,t){o.save(),o.textBaseline="middle";const i=8,s=8;Ot(o,i,s,48,26,6),o.font="14px sans-serif",o.textAlign="center",o.fillStyle="#fff",o.fillText(ig[e]??"",i+16,s+14),o.font="7px monospace",o.fillStyle=ya,o.textAlign="left",o.fillText(t.toUpperCase(),i+28,s+14),o.restore()}let ji=null,Tl="";function ag(o,e){if(e<=0)return;o.save();const t=Math.min(.4,e)*.8,i=`${v.width}:${v.height}:${t*1e3|0}`;(!ji||Tl!==i)&&(ji=o.createRadialGradient(v.width/2,v.height/2,v.width*.3,v.width/2,v.height/2,v.width*.65),ji.addColorStop(0,"rgba(180,0,0,0)"),ji.addColorStop(1,`rgba(180,0,0,${t})`),Tl=i),o.fillStyle=ji,o.fillRect(0,0,v.width,v.height),o.restore()}function Sr(o,e){const t=o+16384,i=e+16384;return(t+i)*(t+i+1)/2+i}class rg{_size=150;_zoom=.05;_revealed=new Set;_icons=[];_waypoints=[];_gradVig=null;_gradVigKey="";_terrainCanvas=null;_terrainCtx=null;_cacheFrame=0;_cacheInterval=30;_lastCachePlayerX=-1/0;_lastCachePlayerY=-1/0;get size(){return this._size}revealChunk(e,t){this._revealed.add(Sr(e,t))}isRevealed(e,t){return this._revealed.has(Sr(e,t))}setIcons(e){this._icons=e}addWaypoint(e,t,i="",s="#fbbf24"){this._waypoints.length>=5&&this._waypoints.shift(),this._waypoints.push({x:e,y:t,label:i,color:s})}removeNearestWaypoint(e,t,i=100){let s=-1,a=1/0;for(let r=0;r<this._waypoints.length;r++){const n=this._waypoints[r],l=n.x-e,h=n.y-t,c=l*l+h*h;c<a&&(a=c,s=r)}return s>=0&&a<=i*i?(this._waypoints.splice(s,1),!0):!1}clearWaypoints(){this._waypoints=[]}get waypoints(){return this._waypoints}_ensureCache(){if(this._terrainCanvas)return;const e=this._size;if(typeof OffscreenCanvas<"u")this._terrainCanvas=new OffscreenCanvas(e,e),this._terrainCtx=this._terrainCanvas.getContext("2d");else{const t=document.createElement("canvas");t.width=e,t.height=e,this._terrainCanvas=t,this._terrainCtx=t.getContext("2d")}}render(e,t,i,s,a,r,n,l){this._ensureCache();const h=this._size,c=t-h-15,d=55,u=1/(this._zoom*10),f=256,m=h/2,_=Math.abs(s-this._lastCachePlayerX)>80||Math.abs(a-this._lastCachePlayerY)>80;if(this._cacheFrame++,this._terrainCtx&&(this._cacheFrame%this._cacheInterval===0||_)){const k=this._terrainCtx;k.clearRect(0,0,h,h);const T=6;let M="";for(let C=0;C<h;C+=T)for(let P=0;P<h;P+=T){const R=s+(P-m)/u,B=a+(C-m)/u,F=Math.floor(R/f),W=Math.floor(B/f);let X;this._revealed.has(Sr(F,W))?X=r(R,B).tileColors.grass:X="#111",X!==M&&(k.fillStyle=X,M=X),k.fillRect(P,C,T,T)}this._lastCachePlayerX=s,this._lastCachePlayerY=a}e.save();const p=4,g=8;if(e.fillStyle="rgba(30,25,20,0.9)",e.strokeStyle="rgba(212,160,48,0.35)",e.lineWidth=2,e.beginPath(),e.roundRect(c-p,d-p,h+p*2,h+p*2,g),e.fill(),e.stroke(),e.fillStyle="rgba(10,10,15,0.85)",e.beginPath(),e.roundRect(c-3,d-3,h+6,h+6,6),e.fill(),e.beginPath(),e.roundRect(c,d,h,h,4),e.clip(),this._terrainCanvas&&e.drawImage(this._terrainCanvas,c,d),n){e.fillStyle="#ff4444";for(let k=0;k<n.length;k++){const T=n[k];if(!T.alive)continue;const M=(T.x-s)*u,C=(T.y-a)*u;M>-m&&M<m&&C>-m&&C<m&&e.fillRect(c+m+M-1.5,d+m+C-1.5,3,3)}}if(l)for(let k=0;k<l.length;k++){const T=l[k];if(T.depleted)continue;const M=(T.x-s)*u,C=(T.y-a)*u;if(M>-m&&M<m&&C>-m&&C<m){switch(T.type){case"tree":e.fillStyle="#22c55e";break;case"rock":e.fillStyle="#a8a29e";break;case"iron_ore":e.fillStyle="#94a3b8";break;case"herb":e.fillStyle="#a3e635";break;case"mushroom":e.fillStyle="#c084fc";break;case"crystal":e.fillStyle="#38bdf8";break;case"gold_ore":e.fillStyle="#fbbf24";break;default:e.fillStyle="#78716c";break}e.fillRect(c+m+M-1,d+m+C-1,2,2)}}e.font="8px serif",e.textAlign="center";for(let k=0;k<this._icons.length;k++){const T=this._icons[k],M=(T.x-s)*u,C=(T.y-a)*u;M>-m&&M<m&&C>-m&&C<m&&(e.fillStyle=T.color,e.fillText(T.icon,c+m+M,d+m+C+3))}const y=.7+.3*Math.sin(performance.now()*.004);for(let k=0;k<this._waypoints.length;k++){const T=this._waypoints[k],M=(T.x-s)*u,C=(T.y-a)*u;if(M>-m&&M<m&&C>-m&&C<m){const P=c+m+M,R=d+m+C,B=4*y;e.fillStyle=T.color,e.globalAlpha=.9,e.beginPath(),e.moveTo(P,R-B),e.lineTo(P+B*.7,R),e.lineTo(P,R+B),e.lineTo(P-B*.7,R),e.closePath(),e.fill(),e.globalAlpha=1,T.label&&(e.font="7px monospace",e.fillStyle=T.color,e.textAlign="center",e.fillText(T.label,P,R-B-2))}}const b=3.5*(.85+.15*Math.sin(performance.now()*.003));e.beginPath(),e.arc(c+m,d+m,b+2,0,Math.PI*2),e.fillStyle="rgba(74,222,128,0.25)",e.fill(),e.beginPath(),e.arc(c+m,d+m,b,0,Math.PI*2),e.fillStyle="#4ade80",e.fill(),e.strokeStyle="rgba(255,255,255,0.9)",e.lineWidth=1,e.stroke();const w=`${c}:${d}:${m}`;(!this._gradVig||this._gradVigKey!==w)&&(this._gradVig=e.createRadialGradient(c+m,d+m,m*.5,c+m,d+m,m),this._gradVig.addColorStop(0,"rgba(0,0,0,0)"),this._gradVig.addColorStop(.85,"rgba(0,0,0,0)"),this._gradVig.addColorStop(1,"rgba(0,0,0,0.6)"),this._gradVigKey=w),e.fillStyle=this._gradVig,e.fillRect(c,d,h,h),e.restore(),e.strokeStyle="rgba(85,85,85,0.6)",e.lineWidth=1,e.beginPath(),e.roundRect(c-3,d-3,h+6,h+6,6),e.stroke(),e.font="9px monospace",e.fillStyle="rgba(212,160,48,0.9)",e.textAlign="center",e.fillText("N",c+m,d-8)}serialize(){return{revealed:[...this._revealed].map(String),waypoints:this._waypoints}}deserialize(e){Array.isArray(e)?this._revealed=new Set(e.map(Number)):(this._revealed=new Set(e.revealed.map(Number)),this._waypoints=e.waypoints??[])}}class Go{_openPanels=new Set;_notifications=[];_tooltip=null;_dialog=null;_fadeAlpha=0;_fadeTarget=0;_fadeCallback=null;_selectedChoiceIndex=0;_dialogRevealChars=0;_dialogRevealTimer=0;_dialogRevealSpeed=40;_dialogFullyRevealed=!1;get isAnyPanelOpen(){return this._openPanels.size>0}get dialog(){return this._dialog}get fadeAlpha(){return this._fadeAlpha}setSelectedChoiceIndex(e){this._selectedChoiceIndex=e}openPanel(e){this._openPanels.add(e)}closePanel(e){this._openPanels.delete(e)}togglePanel(e){this._openPanels.has(e)?this._openPanels.delete(e):this._openPanels.add(e)}isPanelOpen(e){return this._openPanels.has(e)}closeAll(){this._openPanels.clear(),this._dialog=null,this._tooltip=null}notify(e,t="",i="#ffffff",s=3){let a=t;t.startsWith("#")&&(a="",i=t),this._notifications.length>=50&&this._notifications.shift(),this._notifications.push({text:e,icon:a,color:i,duration:s,timer:s})}notifyItem(e,t){this.notify(`+${t} ${e}`,"","#4ade80")}notifyXP(e){this.notify(`+${e} XP`,"","#f59e0b",2)}notifyGold(e){this.notify(`+${e} gold`,"","#fcd34d",2)}notifyWarning(e){this.notify(e,"","#ef4444",4)}showTooltip(e,t,i,s=200){this._tooltip={text:e,x:t,y:i,width:s}}hideTooltip(){this._tooltip=null}showDialog(e,t,i,s=[],a,r){this._dialog={speakerName:e,speakerIcon:t,speakerId:r,text:i,choices:s,onChoice:a},this._openPanels.add("dialogue"),this._dialogRevealChars=0,this._dialogRevealTimer=0,this._dialogFullyRevealed=!1}skipDialogReveal(){return this._dialog&&!this._dialogFullyRevealed?(this._dialogRevealChars=this._dialog.text.length,this._dialogFullyRevealed=!0,!0):!1}get isDialogFullyRevealed(){return this._dialogFullyRevealed}closeDialog(){this._dialog=null,this._openPanels.delete("dialogue")}selectDialogChoice(e){this._dialog?.onChoice&&this._dialog.onChoice(e),this.closeDialog()}fadeOut(e){this._fadeTarget=1,this._fadeCallback=e??null}fadeIn(){this._fadeTarget=0}update(e){for(let t=this._notifications.length-1;t>=0;t--)this._notifications[t].timer-=e,this._notifications[t].timer<=0&&this._notifications.splice(t,1);if(this._dialog&&!this._dialogFullyRevealed&&(this._dialogRevealTimer+=e,this._dialogRevealChars=Math.floor(this._dialogRevealTimer*this._dialogRevealSpeed),this._dialogRevealChars>=this._dialog.text.length&&(this._dialogRevealChars=this._dialog.text.length,this._dialogFullyRevealed=!0)),this._fadeAlpha!==this._fadeTarget){const t=this._fadeTarget>this._fadeAlpha?1:-1;this._fadeAlpha+=t*e*2,this._fadeAlpha=Math.max(0,Math.min(1,this._fadeAlpha)),t>0&&this._fadeAlpha>=1&&this._fadeCallback&&(this._fadeCallback(),this._fadeCallback=null)}}render(e,t,i,s){this._renderNotifications(e,t),this._tooltip&&this._renderTooltip(e,this._tooltip),this._dialog&&this._renderDialog(e,t,i,s),this._fadeAlpha>0&&(e.fillStyle=`rgba(0,0,0,${this._fadeAlpha})`,e.fillRect(0,0,t,i))}static MAX_VISIBLE_NOTIFICATIONS=5;_renderNotifications(e,t){const n=Math.max(0,this._notifications.length-Go.MAX_VISIBLE_NOTIFICATIONS);for(let l=n;l<this._notifications.length;l++){const h=this._notifications[l],c=Math.min(1,(h.duration-h.timer)/.3),d=Math.min(1,h.timer/.5),u=Math.min(c,d),f=c,_=t-250-15+(1-f)*80,p=60+(l-n)*30;e.save(),e.globalAlpha=u,e.fillStyle="rgba(15,12,20,0.82)",e.beginPath(),e.roundRect(_,p,250,25,5),e.fill(),e.strokeStyle="rgba(255,255,255,0.08)",e.lineWidth=1,e.stroke(),e.font="11px monospace",e.textAlign="left",e.fillStyle=h.color,e.fillText(`${h.icon} ${h.text}`,_+8,p+17),e.restore()}}_renderTooltip(e,t){const i=t.text.split(`
`),s=14,a=8,r=i.length*s+a*2;e.fillStyle="rgba(15,15,25,0.95)",e.beginPath(),e.roundRect(t.x,t.y,t.width,r,4),e.fill(),e.strokeStyle="#555",e.lineWidth=1,e.stroke(),e.font="11px monospace",e.textAlign="left",e.fillStyle="#e5e7eb";for(let n=0;n<i.length;n++)e.fillText(i[n],t.x+a,t.y+a+10+n*s)}_renderDialog(e,t,i,s){if(!this._dialog)return;const a=Math.min(640,t-40),r=160,n=(t-a)/2,l=i-r-20,h=56,c=12;e.fillStyle="rgba(0,0,0,0.35)",e.fillRect(0,0,t,i),e.fillStyle="rgba(0,0,0,0.4)",e.beginPath(),e.roundRect(n+3,l+3,a,r,10),e.fill(),e.fillStyle="rgba(16,16,28,0.96)",e.beginPath(),e.roundRect(n,l,a,r,10),e.fill(),e.strokeStyle="rgba(99,102,241,0.6)",e.lineWidth=2,e.beginPath(),e.roundRect(n,l,a,r,10),e.stroke(),e.strokeStyle="rgba(99,102,241,0.2)",e.lineWidth=1,e.beginPath(),e.roundRect(n+4,l+4,a-8,r-8,7),e.stroke();const d=n+c,u=l+c;e.fillStyle="rgba(30,28,50,0.9)",e.beginPath(),e.roundRect(d,u,h,h,6),e.fill(),e.strokeStyle="rgba(99,102,241,0.5)",e.lineWidth=1,e.beginPath(),e.roundRect(d,u,h,h,6),e.stroke();const f=this._dialog.speakerId,m=s&&f?s.getNPCSpritePath(f,"Right","Idle"):"",_=m?s?.getSprite(m):void 0;if(_&&_.naturalWidth>0&&_.naturalHeight>0){const M=Math.max(1,Math.floor(_.naturalWidth/6)),C=_.naturalHeight,P=h-8;e.drawImage(_,0,0,M,C,d+4,u+4,P,P)}else e.font="28px serif",e.textAlign="center",e.fillStyle="#e5e7eb",e.fillText(this._dialog.speakerIcon,d+h/2,u+h/2+10);const p=d+h+c,g=a-h-c*3;e.font="bold 13px monospace",e.textAlign="left",e.fillStyle="#a5b4fc",e.fillText(this._dialog.speakerName,p,l+28);const y=e.measureText(this._dialog.speakerName).width;e.strokeStyle="rgba(165,180,252,0.3)",e.lineWidth=1,e.beginPath(),e.moveTo(p,l+32),e.lineTo(p+y+10,l+32),e.stroke(),e.font="11px monospace",e.fillStyle="#d1d5db";const b=this._dialog.text.substring(0,this._dialogRevealChars).split(" ");let w="",k=l+50;const T=l+r-32;for(const M of b){const C=w+M+" ";if(e.measureText(C).width>g){if(k>T)break;e.fillText(w.trim(),p,k),w=M+" ",k+=16}else w=C}if(k<=T&&e.fillText(w.trim(),p,k),!this._dialogFullyRevealed&&Math.sin(performance.now()*.008)>0){const C=e.measureText(w.trim()).width;e.fillStyle="#a5b4fc",e.fillRect(p+C+2,k-10,6,12)}if(this._dialogFullyRevealed&&this._dialog.choices.length>0){e.font="11px monospace";for(let M=0;M<this._dialog.choices.length;M++){const C=p,P=l+r-18-(this._dialog.choices.length-1-M)*18,R=M===this._selectedChoiceIndex;R&&(e.fillStyle="rgba(99,102,241,0.12)",e.beginPath(),e.roundRect(C-4,P-12,g+8,16,3),e.fill()),e.fillStyle=R?"#c4b5fd":"#818cf8",e.fillText(`${R?"":" "} [${M+1}] ${this._dialog.choices[M].text}`,C,P)}}else this._dialogFullyRevealed?(e.font="9px monospace",e.fillStyle="rgba(107,114,128,0.6)",e.textAlign="center",Math.sin(performance.now()*.003)>0&&e.fillText(" Press SPACE to continue",n+a/2,l+r-10)):(e.font="8px monospace",e.fillStyle="rgba(107,114,128,0.4)",e.textAlign="center",e.fillText("[SPACE] skip",n+a/2,l+r-10))}}class og{_particles=[];_currentBiome=null;_width=0;_height=0;_t=0;_gradLava=null;_gradLavaKey="";_gradMist=null;_gradMistKey="";_gradVoid=null;_gradVoidKey="";_gradCorruption=null;_gradCorruptionKey="";_gradTopEdge=null;_gradTopEdgeKey="";_gradBotEdge=null;_gradBotEdgeKey="";setBiome(e,t,i){this._width=t,this._height=i,this._currentBiome?.id!==e.id&&(this._currentBiome=e,this._particles=[])}update(e){if(!this._currentBiome)return;this._t+=e;const t=this._currentBiome.ambient;for(let i=this._particles.length-1;i>=0;i--){const s=this._particles[i];switch(s.x+=s.vx*e,s.y+=s.vy*e,s.life-=e,t.particleType){case"spore":s.x+=Math.sin(this._t*2+s.y*.01)*.3;break;case"ember":s.vy-=15*e,s.x+=Math.sin(this._t*3+s.x*.02)*.8;break;case"bubble":s.vy-=12*e,s.x+=Math.sin(this._t*1.5+s.y*.01)*.4;break;case"dust":s.vx+=Math.sin(this._t*.5)*.5;break;case"wisp":s.x+=Math.sin(this._t*4+s.y*.02)*1.5,s.y+=Math.cos(this._t*3+s.x*.02)*1;break;case"sparkle":s.alpha=.3+.7*Math.abs(Math.sin(this._t*5+s.x*.1));break}if(s.life<.5&&(s.alpha*=s.life/.5),s.life<=0||s.x<-20||s.x>this._width+20||s.y<-20||s.y>this._height+20){const a=this._particles.length-1;i!==a&&(this._particles[i]=this._particles[a]),this._particles.length=a}}if(t.particleType!=="none"&&this._particles.length<t.particleCount){const i=Math.min(2,t.particleCount-this._particles.length);for(let s=0;s<i;s++)this._particles.push(this._spawnParticle(t.particleType))}}render(e,t=0){if(!this._currentBiome)return;const i=this._currentBiome.ambient,s=this._currentBiome.id,a=performance.now();if(i.fogAlpha>0&&(e.save(),e.globalAlpha=i.fogAlpha,e.fillStyle=i.fogTint,e.fillRect(0,0,this._width,this._height),e.restore()),s==="ashlands"){e.save();const l=4;for(let c=0;c<l;c++){const d=(a*.02+c*this._height/l)%this._height,u=.015+Math.sin(a*.003+c)*.01;e.globalAlpha=Math.max(0,u),e.fillStyle="#ff8800",e.fillRect(0,d,this._width,2)}const h=`${this._height}`;(!this._gradLava||this._gradLavaKey!==h)&&(this._gradLava=e.createLinearGradient(0,this._height,0,this._height*.7),this._gradLava.addColorStop(0,"rgba(200,80,0,0.08)"),this._gradLava.addColorStop(1,"rgba(200,80,0,0)"),this._gradLavaKey=h),e.globalAlpha=.6+Math.sin(a*.002)*.2,e.fillStyle=this._gradLava,e.fillRect(0,this._height*.7,this._width,this._height*.3),e.restore()}if(s==="drowned_depths"){e.save();for(let l=0;l<3;l++){const h=(a*.015+l*200)%(this._width+200)-100,c=40+Math.sin(a*.001+l)*15,d=e.createLinearGradient(h,0,h+c,this._height);d.addColorStop(0,"rgba(80,140,220,0.06)"),d.addColorStop(.5,"rgba(60,120,200,0.03)"),d.addColorStop(1,"rgba(40,80,160,0)"),e.fillStyle=d,e.fillRect(h,0,c,this._height)}e.restore()}if(s==="bone_wastes"){e.save();const l=this._height*.65,h=(.06+Math.sin(a*.001)*.02).toFixed(3),c=(.08+Math.sin(a*.0015)*.03).toFixed(3),d=`${this._height}:${h}:${c}`;(!this._gradMist||this._gradMistKey!==d)&&(this._gradMist=e.createLinearGradient(0,l,0,this._height),this._gradMist.addColorStop(0,"rgba(180,180,180,0)"),this._gradMist.addColorStop(.4,`rgba(150,150,140,${h})`),this._gradMist.addColorStop(1,`rgba(120,120,110,${c})`),this._gradMistKey=d),e.fillStyle=this._gradMist,e.fillRect(0,l,this._width,this._height-l),e.restore()}if(s==="the_void"){e.save();const l=30+Math.sin(a*.002)*10,h=(.1+Math.sin(a*.0025)*.05).toFixed(3),c=`${this._width}:${this._height}:${h}`;(!this._gradVoid||this._gradVoidKey!==c)&&(this._gradVoid=e.createRadialGradient(this._width/2,this._height/2,Math.min(this._width,this._height)*.3,this._width/2,this._height/2,Math.min(this._width,this._height)*.55),this._gradVoid.addColorStop(0,"rgba(0,0,0,0)"),this._gradVoid.addColorStop(1,`rgba(80,0,160,${h})`),this._gradVoidKey=c),e.fillStyle=this._gradVoid,e.fillRect(0,0,this._width,this._height),e.strokeStyle=`rgba(160,0,255,${(.08+Math.sin(a*.004)*.04).toFixed(3)})`,e.lineWidth=1;for(let d=0;d<3;d++){const u=(a*1e-4+d*1.7)%1,f=u*this._width,m=Math.sin(u*6.28+a*.001)*this._height*.3+this._height*.5;e.beginPath(),e.moveTo(f,m);for(let _=0;_<4;_++)e.lineTo(f+Math.sin(_*2.1+a*.003)*l,m+(_+1)*15*Math.sin(a*.002+_));e.stroke()}e.restore()}if(s==="edilas"){e.save();for(let l=0;l<5;l++){const h=(a*2e-4+l*1.256)%(Math.PI*2),c=this._height*.8,d=this._width/2+Math.cos(h)*20,u=0,f=d+Math.cos(h+Math.PI*.5)*c,m=c,_=e.createLinearGradient(d,u,d,m);_.addColorStop(0,"rgba(255,220,100,0.04)"),_.addColorStop(1,"rgba(255,200,80,0)"),e.fillStyle=_,e.beginPath(),e.moveTo(d-30,u),e.lineTo(d+30,u),e.lineTo(f+50,m),e.lineTo(f-50,m),e.closePath(),e.fill()}e.restore()}if(t>.1){e.save();const l=Math.min(.15,t*.15),h=Math.sin(a*.003)*.03,c=`${this._width}:${this._height}:${(l+h)*1e3|0}`;(!this._gradCorruption||this._gradCorruptionKey!==c)&&(this._gradCorruption=e.createRadialGradient(this._width/2,this._height/2,this._width*.2,this._width/2,this._height/2,this._width*.55),this._gradCorruption.addColorStop(0,"rgba(0,0,0,0)"),this._gradCorruption.addColorStop(1,`rgba(100,0,120,${(l+h).toFixed(3)})`),this._gradCorruptionKey=c),e.fillStyle=this._gradCorruption,e.fillRect(0,0,this._width,this._height),e.restore()}e.save(),e.fillStyle=i.particleColor;const r=Math.PI*2,n=i.particleType;for(let l=0;l<this._particles.length;l++){const h=this._particles[l];switch(e.globalAlpha=Math.max(0,Math.min(1,h.alpha)),n){case"spore":e.beginPath(),e.arc(h.x,h.y,h.size,0,r),e.fill(),e.globalAlpha*=.25,e.beginPath(),e.arc(h.x,h.y,h.size*2.5,0,r),e.fill();break;case"ember":e.fillRect(h.x-h.size/2,h.y-h.size/2,h.size,h.size),e.globalAlpha*=.3,e.beginPath(),e.arc(h.x,h.y,h.size*2,0,r),e.fill();break;case"bubble":e.strokeStyle=i.particleColor,e.lineWidth=.5,e.beginPath(),e.arc(h.x,h.y,h.size,0,r),e.stroke(),e.fillRect(h.x-1,h.y-h.size*.5,1.5,1.5);break;case"dust":e.beginPath(),e.arc(h.x,h.y,h.size,0,r),e.fill();break;case"wisp":e.beginPath(),e.arc(h.x,h.y,h.size,0,r),e.fill(),e.globalAlpha*=.4,e.beginPath(),e.arc(h.x-h.vx*.1,h.y-h.vy*.1,h.size*1.5,0,r),e.fill(),e.globalAlpha*=.3,e.beginPath(),e.arc(h.x-h.vx*.2,h.y-h.vy*.2,h.size*2,0,r),e.fill();break;case"sparkle":{const c=h.size;e.fillRect(h.x-c,h.y-.5,c*2,1),e.fillRect(h.x-.5,h.y-c,1,c*2),e.globalAlpha*=.5;const d=c*.7;e.fillRect(h.x-d,h.y-d,d*2,.8);break}case"shard":e.beginPath(),e.moveTo(h.x,h.y-h.size),e.lineTo(h.x+h.size*.4,h.y),e.lineTo(h.x,h.y+h.size*.3),e.lineTo(h.x-h.size*.4,h.y),e.closePath(),e.fill();break}}if(e.restore(),i.borderGlow){e.save();const l=3;e.globalAlpha=.15+Math.sin(a*.002)*.05;const h=`${l}:${i.borderGlow}`;(!this._gradTopEdge||this._gradTopEdgeKey!==h)&&(this._gradTopEdge=e.createLinearGradient(0,0,0,l),this._gradTopEdge.addColorStop(0,i.borderGlow),this._gradTopEdge.addColorStop(1,"transparent"),this._gradTopEdgeKey=h),e.fillStyle=this._gradTopEdge,e.fillRect(0,0,this._width,l);const c=`${this._height}:${l}:${i.borderGlow}`;(!this._gradBotEdge||this._gradBotEdgeKey!==c)&&(this._gradBotEdge=e.createLinearGradient(0,this._height-l,0,this._height),this._gradBotEdge.addColorStop(0,"transparent"),this._gradBotEdge.addColorStop(1,i.borderGlow),this._gradBotEdgeKey=c),e.fillStyle=this._gradBotEdge,e.fillRect(0,this._height-l,this._width,l),e.restore()}}renderBiomeBanner(e,t,i,s,a=0,r=1){if(s<=0)return;e.save(),e.globalAlpha=s;const n=this._currentBiome?.ambient.borderGlow??"#666",l=220,h=a>0?52:36,c=this._width/2-l/2,d=60;if(e.fillStyle="rgba(0,0,0,0.7)",e.beginPath(),e.roundRect(c,d,l,h,6),e.fill(),e.strokeStyle=n,e.lineWidth=1.5,e.beginPath(),e.roundRect(c,d,l,h,6),e.stroke(),e.font="bold 14px monospace",e.textAlign="center",e.fillStyle="#fff",e.fillText(`${i} ${t}`,this._width/2,d+18),a>0){const u=d+32,f=a*12;this._width/2-f/2;const m=Math.max(1,a*2-1),_=r<m,p=_?"#ff4444":a>=8?"#ff8800":"#88ff88";e.font="9px monospace",e.fillStyle=p,e.textAlign="center";let g="";for(let y=0;y<Math.min(a,10);y++)g+="";if(e.fillText(g,this._width/2,u+4),_){const y=.6+.4*Math.sin(performance.now()*.006);e.globalAlpha=s*y,e.font="bold 8px monospace",e.fillStyle="#ff4444",e.fillText(`LV ${m}+ RECOMMENDED`,this._width/2,u+14)}}e.restore()}_spawnParticle(e){const t=Math.random();let i,s,a,r;return e==="ember"?(i=Math.random()*this._width,s=this._height+10,a=(Math.random()-.5)*10,r=-20-Math.random()*30):e==="bubble"?(i=Math.random()*this._width,s=this._height+5,a=(Math.random()-.5)*5,r=-15-Math.random()*20):t<.25?(i=-5,s=Math.random()*this._height,a=5+Math.random()*10,r=(Math.random()-.5)*5):t<.5?(i=this._width+5,s=Math.random()*this._height,a=-5-Math.random()*10,r=(Math.random()-.5)*5):t<.75?(i=Math.random()*this._width,s=-5,a=(Math.random()-.5)*5,r=5+Math.random()*10):(i=Math.random()*this._width,s=this._height+5,a=(Math.random()-.5)*5,r=-5-Math.random()*10),{x:i,y:s,vx:a,vy:r,size:1+Math.random()*2.5,alpha:.3+Math.random()*.5,life:3+Math.random()*5,maxLife:8}}}class ng{_lights=new Map;_lightsArray=[];_lightsDirty=!1;_nextId=1;_ambientLight=1;_targetAmbient=1;_time=0;_nightVisionActive=!1;_frameCount=0;get ambientLight(){return this._ambientLight}setTimeOfDay(e,t,i=0){t?this._targetAmbient=.15+Math.sin((e-20)/10*Math.PI)*.1:this._targetAmbient=.7+Math.sin((e-6)/12*Math.PI)*.3,this._targetAmbient=Math.max(.1,this._targetAmbient-i),this._nightVisionActive&&(this._targetAmbient=Math.max(.5,this._targetAmbient))}setNightVision(e){this._nightVisionActive=e}addLight(e,t,i=120,s=.8,a="#ffaa44",r=!0){const n=this._nextId++,l=parseInt(a.slice(1,3),16),h=parseInt(a.slice(3,5),16),c=parseInt(a.slice(5,7),16);return this._lights.set(n,{id:n,x:e,y:t,radius:i,intensity:s,color:a,flicker:r,flickerSpeed:3+Math.random()*2,flickerAmount:.15,_r:l,_g:h,_b:c}),this._lightsDirty=!0,n}removeLight(e){this._lights.delete(e),this._lightsDirty=!0}moveLight(e,t,i){const s=this._lights.get(e);s&&(s.x=t,s.y=i)}update(e){this._time+=e,this._ambientLight+=(this._targetAmbient-this._ambientLight)*e*2}render(e,t,i,s,a){if(!(this._ambientLight>=.95&&this._lights.size===0)){if(this._frameCount++,this._lightsDirty){this._lightsArray.length=0;for(const r of this._lights.values())this._lightsArray.push(r);this._lightsDirty=!1}if(e.save(),e.globalCompositeOperation="multiply",e.fillStyle=`rgba(${Math.floor(this._ambientLight*255)},${Math.floor(this._ambientLight*230)},${Math.floor(this._ambientLight*200)},1)`,e.fillRect(0,0,t,i),this._lightsArray.length>0){e.globalCompositeOperation="screen";for(let r=0;r<this._lightsArray.length;r++){const n=this._lightsArray[r],l=n.x-s,h=n.y-a;if(l<-n.radius||l>t+n.radius||h<-n.radius||h>i+n.radius)continue;let c=n.intensity;n.flicker&&(c+=Math.sin(this._time*n.flickerSpeed)*n.flickerAmount,c=Math.max(0,Math.min(1,c)));const d=n._r,u=n._g,f=n._b,m=`${l|0}:${h|0}:${n.radius}:${c*100|0}`;if(!n._cachedGrad||n._cachedGradKey!==m){const _=e.createRadialGradient(l,h,0,l,h,n.radius);_.addColorStop(0,`rgba(${d},${u},${f},${c})`),_.addColorStop(.4,`rgba(${d},${u},${f},${c*.5})`),_.addColorStop(1,"rgba(0,0,0,0)"),n._cachedGrad=_,n._cachedGradKey=m}e.fillStyle=n._cachedGrad,e.fillRect(l-n.radius,h-n.radius,n.radius*2,n.radius*2)}}e.restore()}}getLightsArray(){if(this._lightsDirty){this._lightsArray.length=0;for(const e of this._lights.values())this._lightsArray.push(e);this._lightsDirty=!1}return this._lightsArray}serialize(){return[...this._lights.values()]}deserialize(e){this._lights.clear();for(const t of e)t._r===void 0&&(t._r=parseInt(t.color.slice(1,3),16),t._g=parseInt(t.color.slice(3,5),16),t._b=parseInt(t.color.slice(5,7),16)),this._lights.set(t.id,t),t.id>=this._nextId&&(this._nextId=t.id+1);this._lightsDirty=!0}}const lg={corruption_boss:"skeleton_king",shadow_lord:"ancient_boss",goblin_warlord:"goblin_beast",goblin_chief:"goblin_rider"};class hg{_shakeOffsetX=0;_shakeOffsetY=0;_sprites=null;_classId="warrior";_animFrame=0;_animTimer=0;_gradGlow=null;_gradGlowKey="";_gradHpBar=null;_gradHpBarKey="";_characterAnimFrameHints={Idle:[6,8,4,3],Run:[6,8,4,3],Attack01:[8,6,4,3],Death:[8,6,4,3],Jump:[6,8,4,3],Land:[3,4,6,8],Hurt:[4,3,6,8]};setSpriteRegistry(e){this._sprites=e}setPlayerClass(e){this._classId=e}render(e,t,i,s){const{arenaWidth:a,arenaHeight:r,groundY:n,biomeColors:l,screenShake:h,time:c}=i;if(this._animTimer+=s,this._animTimer>.12&&(this._animTimer=0,this._animFrame=(this._animFrame+1)%6),h>0?(this._shakeOffsetX=(Math.random()-.5)*h*8,this._shakeOffsetY=(Math.random()-.5)*h*8):(this._shakeOffsetX=0,this._shakeOffsetY=0),t){t.fillStyle=this._darken(l.rock,.15),t.fillRect(0,0,a,r);const f=c*1e-4;for(let g=0;g<40;g++){const y=(g*127.3+f*10)%a,S=g*83.7%(r*.6),b=.3+Math.sin(f*5+g)*.3;t.fillStyle=`rgba(255,255,255,${b})`,t.fillRect(y,S,1.5,1.5)}const m=this._darken(l.rock,.3);t.fillStyle=m;for(let g=0;g<a;g+=180)t.beginPath(),t.moveTo(g,n),t.lineTo(g+90,r*.25+Math.sin(g*.01)*30),t.lineTo(g+180,n),t.fill();const _=this._darken(l.dirt,.4);t.fillStyle=_;for(let g=0;g<a;g+=120)t.beginPath(),t.moveTo(g,n),t.lineTo(g+60,n-40+Math.sin(g*.02)*15),t.lineTo(g+120,n),t.fill();t.fillStyle=this._darken(l.dirt,.5),t.fillRect(0,n,a,r-n);const p=this._darken(l.dirt,.35);t.strokeStyle=p,t.lineWidth=1;for(let g=0;g<a;g+=20)t.beginPath(),t.moveTo(g,n+5+Math.sin(g*.1)*2),t.lineTo(g+10,n+5+Math.sin((g+10)*.1)*2),t.stroke()}e.clearRect(0,0,a,r),e.save(),e.translate(this._shakeOffsetX,this._shakeOffsetY);const d=i.bossPhase;if(d>0){const f=Math.min(.12,d*.04+Math.sin(c*.002)*.02),_=["","rgba(255,100,0,","rgba(255,40,40,","rgba(180,0,0,"][Math.min(d,3)]??"rgba(255,100,0,";e.fillStyle=`${_}${f.toFixed(3)})`,e.fillRect(0,0,a,r)}e.strokeStyle=this._darken(l.dirt,.25),e.lineWidth=2,e.beginPath(),e.moveTo(0,n),e.lineTo(a,n),e.stroke();const u=.2+Math.sin(c*.004)*.1;e.fillStyle=`rgba(255,100,0,${u.toFixed(2)})`,e.fillRect(0,n-80,3,80),e.fillRect(a-3,n-80,3,80);for(let f=0;f<8;f++){const m=(c*.01*(1+f*.3)+f*127)%a,_=n-4+Math.sin(c*.002+f)*3,p=.1+Math.sin(c*.003+f*2)*.06;e.fillStyle=`rgba(200,180,150,${p.toFixed(2)})`,e.beginPath(),e.arc(m,_,1.5,0,Math.PI*2),e.fill()}this._renderPlayer(e,i),i.bossHealth>0?this._renderBoss(e,i):this._renderVictoryText(e,i),e.restore(),i.bossHealth>0&&this.renderBossHealthBar(e,i),this.renderPlayerHealthBar(e,i.playerHealth,i.playerMaxHealth),i.isAttacking&&i.comboCount>0&&(e.fillStyle="#ff0",e.font="bold 14px monospace",e.textAlign="left",e.fillText(`COMBO x${i.comboCount}`,i.playerX-20,i.playerY-20)),e.fillStyle="rgba(0,0,0,0.65)",e.beginPath(),e.roundRect(4,r-28,290,22,6),e.fill(),e.fillStyle="rgba(255,255,255,0.8)",e.font="10px monospace",e.textAlign="left",e.fillText("[A/D] Move   [W] Jump   [SPACE] Attack   [ESC] Flee",10,r-13)}_inferFrameCount(e,t){const i=e.naturalWidth,s=e.naturalHeight;for(const a of t){if(a<=0||i%a!==0)continue;const n=i/a/Math.max(1,s);if(n>.2&&n<2.5)return a}return 6}_findFirstCharacterSprite(e,t,i){if(!this._sprites)return null;for(const s of t)for(const a of i){const r=this._sprites.getCharacterSpritePath(e,s,a),n=r?this._sprites.getSprite(r):void 0;if(n&&n.naturalWidth>0&&n.naturalHeight>0){const l=this._inferFrameCount(n,this._characterAnimFrameHints[a]??[6,8,4,3]);return{img:n,frameCount:l}}}return null}_findFirstBossSprite(e,t,i){if(!this._sprites)return null;for(const s of t)for(const a of i){const r=this._sprites.getBossSpritePath(e,s,a),n=r?this._sprites.getSprite(r):void 0;if(n&&n.naturalWidth>0&&n.naturalHeight>0)return{img:n,frameCount:P_[a]??6}}return null}_renderPlayer(e,t){const{playerX:i,groundY:s}=t,a=s-48,r=t.bossX>i?1:-1;if(e.fillStyle="rgba(0,0,0,0.3)",e.beginPath(),e.ellipse(i,s-2,16,4,0,0,Math.PI*2),e.fill(),this._sprites){const n=t.bossX>i?"Right":"Left",l=t.isAttacking?"Attack01":Math.abs(t.playerVelY)>.01?"Jump":"Idle",h={Attack01:["Attack01","Run","Idle"],Jump:["Jump","Run","Idle"],Run:["Run","Idle"],Idle:["Idle","Run"],Death:["Death","Hurt","Idle"],Hurt:["Hurt","Idle"],Land:["Land","Run","Idle"]},c=this._findFirstCharacterSprite(this._classId,[n,n==="Left"?"Right":"Left"],h[l]??["Idle","Run"]);if(c){const d=c.img.naturalWidth/c.frameCount,u=c.img.naturalHeight,f=this._animFrame%c.frameCount,m=52,_=d/u*m;e.drawImage(c.img,f*d,0,d,u,i-_/2,a-4,_,m),t.attackCooldown>.3&&(e.strokeStyle="rgba(255,255,255,0.7)",e.lineWidth=2,e.beginPath(),e.arc(i+(n==="Right"?20:-20),a+20,25,-.8,.8),e.stroke());return}}e.fillStyle="#4488ff",e.fillRect(i-12,a,24,48),e.fillStyle="#5599ff",e.fillRect(i-10,a+2,20,10),e.fillStyle="#3366cc",e.fillRect(i-14,a+14,28,6),t.attackCooldown>.3&&(e.strokeStyle="#fff",e.lineWidth=2,e.beginPath(),e.arc(i+20*r,a+20,25,-.8,.8),e.stroke())}_renderBoss(e,t){const{bossX:i,groundY:s,bossHitFlash:a,bossIcon:r,bossAttackTelegraph:n}=t,l=s-80;if(n>0){const c=1-n/.5,d=.1+c*.2+Math.sin(t.time*.03)*.08;e.fillStyle=`rgba(255,40,40,${d.toFixed(2)})`,e.beginPath(),e.arc(i,l+40,50+c*10,0,Math.PI*2),e.fill(),e.strokeStyle=`rgba(255,90,90,${Math.max(.2,d).toFixed(2)})`,e.lineWidth=2,e.beginPath(),e.ellipse(i,s-2,34+c*12,8+c*2,0,0,Math.PI*2),e.stroke(),c>.6&&(e.font="bold 18px monospace",e.textAlign="center",e.fillStyle=`rgba(255,80,80,${(c*.9).toFixed(2)})`,e.fillText("!",i,l-12))}if(e.fillStyle="rgba(0,0,0,0.4)",e.beginPath(),e.ellipse(i,s-2,28,6,0,0,Math.PI*2),e.fill(),this._sprites){const c=t.bossSpriteType??lg[t.bossId]??t.bossId,d=t.playerX<i?"Left":"Right",u=a>0?"Hurt":Math.abs(t.bossVelX)>.5?"Run":"Idle",f={Hurt:["Hurt","Idle","Run"],Run:["Run","Idle"],Idle:["Idle","Run"],Attack01:["Attack01","Run","Idle"],Jump:["Jump","Run","Idle"],Land:["Land","Idle"],Death:["Death","Hurt","Idle"]},m=this._findFirstBossSprite(c,[d,d==="Left"?"Right":"Left","Down","Up"],f[u]??["Idle","Run"]);if(m){const _=m.img.naturalWidth/m.frameCount,p=m.img.naturalHeight,g=this._animFrame%m.frameCount,y=80,S=_/p*y;if(e.drawImage(m.img,g*_,0,_,p,i-S/2,l,S,y),a>0){const b=Math.min(1,a/.08);e.globalCompositeOperation="source-atop",e.fillStyle=`rgba(255,255,255,${(b*.9).toFixed(2)})`,e.fillRect(i-S/2,l,S,y),e.globalCompositeOperation="source-over"}e.globalAlpha=1,e.font="18px serif",e.textAlign="center",e.fillText(r,i,l-6);return}}const h=a>0?"#fff":"#cc2222";e.fillStyle=h,e.fillRect(i-28,l,56,80),a<=0&&(e.fillStyle="#aa1111",e.fillRect(i-24,l+4,48,16),e.fillStyle="#881111",e.fillRect(i-32,l+24,64,8),e.fillStyle="#991111",e.fillRect(i-20,l+50,40,30)),e.fillStyle="#ff4444",e.beginPath(),e.arc(i-8,l+10,4,0,Math.PI*2),e.arc(i+8,l+10,4,0,Math.PI*2),e.fill(),e.font="24px serif",e.textAlign="center",e.fillText(r,i,l-10)}_renderVictoryText(e,t){const i=t.arenaWidth/2,s=t.arenaHeight*.4,a=t.time;e.save();for(let l=0;l<8;l++){const h=(a*3e-4+l*Math.PI/4)%(Math.PI*2),c=120+Math.sin(a*.002+l)*30,d=.04+Math.sin(a*.003+l)*.02,u=e.createLinearGradient(i,s,i+Math.cos(h)*c,s+Math.sin(h)*c);u.addColorStop(0,`rgba(255,215,0,${d.toFixed(3)})`),u.addColorStop(1,"rgba(255,215,0,0)"),e.fillStyle=u,e.beginPath(),e.moveTo(i+Math.cos(h-.1)*10,s+Math.sin(h-.1)*10),e.lineTo(i+Math.cos(h)*c,s+Math.sin(h)*c),e.lineTo(i+Math.cos(h+.1)*10,s+Math.sin(h+.1)*10),e.closePath(),e.fill()}e.restore();const r=`${i}:${s}`;(!this._gradGlow||this._gradGlowKey!==r)&&(this._gradGlow=e.createRadialGradient(i,s,0,i,s,80),this._gradGlow.addColorStop(0,"rgba(255,215,0,0.12)"),this._gradGlow.addColorStop(1,"rgba(255,215,0,0)"),this._gradGlowKey=r),e.fillStyle=this._gradGlow,e.beginPath(),e.arc(i,s,80,0,Math.PI*2),e.fill(),e.font="bold 28px monospace",e.textAlign="center",e.fillStyle="#ffd700",e.shadowColor="#000",e.shadowBlur=8,e.fillText("VICTORY!",i,s),e.shadowBlur=0,e.font="13px monospace",e.fillStyle="#ccc",e.fillText(`${t.bossName} has been slain`,i,s+28);const n=.4+Math.sin(a*.003)*.2;e.globalAlpha=n,e.font="10px monospace",e.fillStyle="#aaa",e.fillText("Press ESC to return",i,s+50),e.globalAlpha=1}renderBossHealthBar(e,t){const i=t.arenaWidth*.6,s=14,a=(t.arenaWidth-i)/2,r=30,n=Math.max(0,t.bossHealth/t.bossMaxHealth),l=t.bossPhase,h=t.arenaWidth/2,d=["#ef4444","#f97316","#dc2626","#ff0000"][Math.min(l,3)]??"#ef4444";if(e.fillStyle="rgba(0,0,0,0.75)",e.beginPath(),e.roundRect(a-6,r-6,i+12,s+12,6),e.fill(),e.strokeStyle="rgba(255,255,255,0.1)",e.lineWidth=1,e.beginPath(),e.roundRect(a-6,r-6,i+12,s+12,6),e.stroke(),e.fillStyle="#222",e.beginPath(),e.roundRect(a,r,i,s,2),e.fill(),n>0){const f=`${a}:${r}:${s}:${d}`;(!this._gradHpBar||this._gradHpBarKey!==f)&&(this._gradHpBar=e.createLinearGradient(a,r,a,r+s),this._gradHpBar.addColorStop(0,d),this._gradHpBar.addColorStop(1,this._darken(d.replace("#","#"),.7)),this._gradHpBarKey=f),e.fillStyle=this._gradHpBar,e.beginPath(),e.roundRect(a,r,i*n,s,2),e.fill(),e.fillStyle="rgba(255,255,255,0.15)",e.fillRect(a,r,i*n,2)}const u=[.75,.5,.25];for(const f of u)e.fillStyle="rgba(0,0,0,0.5)",e.fillRect(a+i*f-.5,r,1,s);if(e.font="bold 12px monospace",e.fillStyle="#fff",e.textAlign="center",e.shadowColor="#000",e.shadowBlur=3,e.fillText(`${t.bossIcon} ${t.bossName}`,h,r-10),e.shadowBlur=0,e.font="9px monospace",e.fillStyle="rgba(255,255,255,0.7)",e.textAlign="right",e.fillText(`${Math.max(0,Math.floor(t.bossHealth))} / ${t.bossMaxHealth}`,a+i-4,r+s-3),e.textAlign="center",l>0){const f=["","ENRAGED","FRENZY","DESPERATE"],m=["","#f97316","#ef4444","#ff0000"],_=f[Math.min(l,3)]??"",p=m[Math.min(l,3)]??"#f97316";if(_){const g=.7+Math.sin(t.time*.006)*.3;e.font="bold 9px monospace",e.fillStyle=p,e.globalAlpha=g,e.fillText(_,h,r+s+16),e.globalAlpha=1}}}renderPlayerHealthBar(e,t,i){const l=Math.max(0,Math.min(1,t/i));e.fillStyle="rgba(0,0,0,0.6)",e.fillRect(8,8,124,14),e.fillStyle="#333",e.fillRect(10,10,120,10);const h=l>.5?"#4ade80":l>.25?"#f59e0b":"#ef4444";e.fillStyle=h,e.fillRect(10,10,120*l,10),e.font="9px monospace",e.fillStyle="#fff",e.textAlign="left",e.fillText(`HP ${Math.floor(t)}/${i}`,10,32)}_darken(e,t){const i=parseInt(e.slice(1,3),16),s=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return`rgb(${Math.floor(i*t)},${Math.floor(s*t)},${Math.floor(a*t)})`}}const Ki=new Map,kr=new Map;class Ut{_app;_ready=!1;_externalApp=!1;world;lighting;screenFX;terrainLayer;groundLayer;entityLayer;particleLayer;_camX=0;_camY=0;_camZoom=1;_shakeX=0;_shakeY=0;_width;_height;constructor(){this._app=new vo,this._width=0,this._height=0,this.world=new we,this.world.label="world",this.terrainLayer=new we,this.terrainLayer.label="terrain",this.groundLayer=new we,this.groundLayer.label="ground",this.entityLayer=new we,this.entityLayer.label="entities",this.entityLayer.sortableChildren=!0,this.particleLayer=new we,this.particleLayer.label="particles",this.world.addChild(this.terrainLayer),this.world.addChild(this.groundLayer),this.world.addChild(this.entityLayer),this.world.addChild(this.particleLayer),this.lighting=new we,this.lighting.label="lighting",this.screenFX=new we,this.screenFX.label="screenFX"}get app(){return this._app}get ready(){return this._ready}get canvas(){return this._app.canvas}get width(){return this._width}get height(){return this._height}async init(e){console.warn("[WebGLRenderer] init() is deprecated  use initWithApp() with the engine-owned Application instead."),this._width=e.width,this._height=e.height,this._externalApp=!1,await this._app.init({width:e.width,height:e.height,backgroundColor:0,backgroundAlpha:1,antialias:!1,resolution:1,autoDensity:!1,preference:"webgl",clearBeforeRender:!0});const t=this._app.canvas;t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.zIndex=String(e.zIndex??1),t.style.imageRendering="pixelated",e.container.appendChild(t),this._setupSceneGraph(),console.log(`[WebGLRenderer] Initialized via init() (${e.width}x${e.height}, WebGL)`)}initWithApp(e,t){this._app=e,this._width=t.width,this._height=t.height,this._externalApp=!0,this._setupSceneGraph(),console.log(`[WebGLRenderer] Initialized via initWithApp() (${t.width}x${t.height})`)}_setupSceneGraph(){this._app.stage.addChild(this.world),this._app.stage.addChild(this.lighting),this._app.stage.addChild(this.screenFX),this._ready=!0,window.__pixi={app:this._app,stage:this._app.stage,world:this.world,terrain:this.terrainLayer,entities:this.entityLayer,lighting:this.lighting,screenFX:this.screenFX,renderer:this}}destroy(){if(this._ready=!1,this._app.stage.removeChildren(),this.terrainLayer.removeChildren(),this.groundLayer.removeChildren(),this.entityLayer.removeChildren(),this.particleLayer.removeChildren(),this.lighting.removeChildren(),this.screenFX.removeChildren(),!this._externalApp){const e=this._app.canvas;e.parentElement&&e.parentElement.removeChild(e)}}setCamera(e,t,i=1){this._camX=e,this._camY=t,this._camZoom=i}setShake(e,t){this._shakeX=e,this._shakeY=t}applyCamera(){this._ready&&(this.world.x=Math.round(-this._camX*this._camZoom+this._width/2+this._shakeX),this.world.y=Math.round(-this._camY*this._camZoom+this._height/2+this._shakeY),this.world.scale.set(this._camZoom))}render(){this._ready&&this._app.render()}static textureFromImage(e){if(!e||e.naturalWidth===0)return Z.EMPTY;let t=Ki.get(e.src);return t||(t=new nt({resource:e,scaleMode:"nearest"}),Ki.set(e.src,t)),new Z({source:t})}static textureFromFrame(e,t,i,s,a){if(!e||e.naturalWidth===0)return Z.EMPTY;const r=`${e.src}:${t}:${i}:${s}:${a}`;let n=kr.get(r);if(n)return n;let l=Ki.get(e.src);return l||(l=new nt({resource:e,scaleMode:"nearest"}),Ki.set(e.src,l)),n=new Z({source:l,frame:new $e(t,i,s,a)}),kr.set(r,n),n}static spriteFromImage(e){const t=Ut.textureFromImage(e);return new _t(t)}static spriteFromFrame(e,t,i,s){const a=Ut.textureFromFrame(e,t*i,0,i,s);return new _t(a)}static coloredRect(e,t,i,s=1){const a=new Ne;return a.rect(0,0,e,t),a.fill({color:i,alpha:s}),a}static lightCircle(e,t,i=.5){const s=new Ne;return s.circle(0,0,e),s.fill({color:t,alpha:i}),s.blendMode="add",s}static clearContainer(e){e.removeChildren()}static getCacheStats(){return{sources:Ki.size,frames:kr.size}}}const Qi="Sprites/Items/Tileset/isometric tileset/separated images/",Ml={0:["isometric_grass_tile_dense.png","isometric_grass_tile_sparse.png","isometric_grass_tile_with_clover.png","isometric_grass_tile_with_dandelions.png","isometric_grass_tile_mixed_flowers.png","isometric_grass_tile_pink_flowers.png","isometric_grass_tile_white_flowers.png","isometric_grass_tile_with_mushrooms.png"],1:["isometric_dirt_soil_floor_base_tile.png","isometric_dirt_floor_with_pebbles.png","isometric_dirt_floor_with_grass_patches.png"],2:["isometric_stone_block_gray_solid.png","isometric_stone_block_gray_mossy.png","isometric_stone_block_gray_cracked.png"],3:["isometric_dirt_soil_floor_base_tile.png","isometric_dirt_floor_with_pebbles.png"],5:["isometric_cobblestone_floor_regular.png","isometric_cobblestone_floor_weathered.png"],6:["isometric_shallow_water_tile_full.png"],7:["isometric_deep_water_tile_full.png"],8:["isometric_wooden_plank_floor_base.png","isometric_wooden_plank_floor_weathered.png","isometric_wooden_plank_floor_mossy.png"],9:["isometric_stone_block_gray_solid.png","isometric_stone_block_gray_cracked.png"]},Tr={rotwood:["isometric_grass_tile_with_mushrooms.png","isometric_grass_tile_autumn_orange.png","isometric_grass_tile_autumn_yellow.png","isometric_grass_tile_autumn_red.png","isometric_grass_tile_sparse.png"],ashlands:["isometric_dead_grass_tile_brown.png","isometric_dead_grass_tile_withered.png","isometric_dirt_soil_floor_base_tile.png"],bone_wastes:["isometric_dead_grass_tile_withered.png","isometric_dead_grass_tile_brown.png","isometric_grass_tile_sparse.png"],the_void:["isometric_dead_grass_tile_withered.png","isometric_stone_block_gray_cracked.png"],drowned_depths:["isometric_grass_tile_dense.png","isometric_grass_tile_with_mushrooms.png","isometric_grass_tile_sparse.png"],edilas:["isometric_grass_tile_dense.png","isometric_grass_tile_mixed_flowers.png","isometric_grass_tile_pink_flowers.png","isometric_grass_tile_white_flowers.png","isometric_grass_tile_with_clover.png"]},co=["isometric_bush_small_green.png","isometric_bush_medium_green.png","isometric_bush_large_green.png","isometric_tall_grass_tuft_small.png","isometric_tall_grass_tuft_medium.png","isometric_tall_grass_tuft_large.png","isometric_wildflower_yellow_petals.png","isometric_wildflower_blue_petals.png","isometric_wildflower_purple_petals.png","isometric_wildflower_red_petals.png","isometric_rock_small_gray.png","isometric_rock_medium_gray.png","isometric_mushroom_brown_single.png"],td=["isometric_mushroom_brown_single.png","isometric_mushroom_brown_cluster.png","isometric_mushroom_red_spotted_single.png","isometric_mushroom_red_spotted_cluster.png","isometric_tall_grass_tuft_large.png","isometric_tall_grass_tuft_medium.png","isometric_tree_stump_small.png","isometric_tree_stump_medium.png","isometric_tree_stump_large_mossy.png","isometric_fallen_log_horizontal.png","isometric_fallen_log_diagonal.png","isometric_rock_small_gray.png","isometric_rock_cluster_small.png","isometric_bush_medium_green.png"],id=["isometric_rock_small_gray.png","isometric_rock_medium_gray.png","isometric_rock_large_gray.png","isometric_rock_cluster_large.png","isometric_rock_cluster_small.png","isometric_tree_stump_small.png","isometric_tree_stump_large_mossy.png","isometric_dead_grass_tile_brown.png","isometric_dead_grass_tile_withered.png"],sd=["isometric_mushroom_white_glowing.png","isometric_mushroom_brown_cluster.png","isometric_mushroom_red_spotted_cluster.png","isometric_tall_grass_tuft_small.png","isometric_tall_grass_tuft_medium.png","isometric_rock_small_gray.png","isometric_rock_cluster_small.png","isometric_bush_small_green.png"],ad=["isometric_rock_small_gray.png","isometric_rock_medium_gray.png","isometric_rock_cluster_small.png","isometric_tree_stump_small.png","isometric_dead_grass_tile_brown.png","isometric_dead_grass_tile_withered.png"],rd=["isometric_mushroom_white_glowing.png","isometric_rock_small_gray.png","isometric_rock_medium_gray.png","isometric_rock_cluster_large.png"],cg=[...new Set([...co,...td,...id,...sd,...ad,...rd])],dg={haven:14217424,rotwood:13164728,ashlands:1578e4,drowned_depths:10535136,bone_wastes:14209216,the_void:12624088,edilas:13693136},ug=8405152;function fg(o){const e=Sa[o.biome]??Sa.haven;let t;o.type===9?t=["#3a1a4a","#2a0a3a","#4a2a5a"]:o.type===6?t=e.water:o.type===1?t=e.dirt:o.type===2?t=e.stone:t=e.grass;const i=t[o.variant%t.length]??"#5a9c4a";return parseInt(i.replace("#",""),16)}const Cl=new Map,Pl=new Map;function Il(o){if(!o||o.naturalWidth===0)return Z.EMPTY;let e=Pl.get(o.src);if(e)return e;let t=Cl.get(o.src);return t||(t=new nt({resource:o,scaleMode:"nearest"}),Cl.set(o.src,t)),e=new Z({source:t}),Pl.set(o.src,e),e}let js=null;function Al(){if(js)return js;const o=document.createElement("canvas");o.width=1,o.height=1;const e=o.getContext("2d");e.fillStyle="#ffffff",e.fillRect(0,0,1,1);const t=new nt({resource:o,scaleMode:"nearest"});return js=new Z({source:t}),js}const Rl=1600,Mr=300;class mg{_container;_decoContainer;_tilePool=[];_decoPool=[];_activeTiles=0;_activeDecos=0;_loader;_tileImages=new Map;_getTile;_getCorruption=null;_loaded=!1;_frameCount=0;constructor(e,t,i,s){this._container=e,this._decoContainer=t,this._loader=i,this._getTile=s;for(let a=0;a<Rl;a++){const r=new _t(Z.EMPTY);r.visible=!1,r.anchor.set(.5,0),this._container.addChild(r);const n=new _t(Al());n.visible=!1,n.anchor.set(.5,0),n.alpha=0,this._container.addChild(n),this._tilePool.push({sprite:r,tintOverlay:n,active:!1})}for(let a=0;a<Mr;a++){const r=new _t(Z.EMPTY);r.visible=!1,r.anchor.set(.5,1),this._decoContainer.addChild(r),this._decoPool.push({sprite:r,active:!1})}}setCorruptionQuery(e){this._getCorruption=e}async preload(){const e=new Set;for(const i of Object.values(Ml))for(const s of i)e.add(Qi+s);for(const i of Object.values(Tr))for(const s of i)e.add(Qi+s);for(const i of cg)e.add(Qi+i);const t=await this._loader.loadMany([...e]);for(const[i,s]of t)this._tileImages.set(i,s);this._loaded=!0,console.log(`[WebGLIsometricRenderer] Loaded ${t.size} tile images`)}worldToTile(e,t){return{tx:Math.floor(e/L),ty:Math.floor(t/L)}}tileToScreen(e,t){return{sx:(e-t)*Re,sy:(e+t)*Te}}worldToScreen(e,t){const i=e/L,s=t/L;return{sx:(i-s)*Re,sy:(i+s)*Te}}screenToWorld(e,t){const i=(e/Re+t/Te)/2,s=(t/Te-e/Re)/2;return{wx:i*L,wy:s*L}}render(e,t,i,s){this._frameCount++,this._frameCount%4===0&&this._getCorruption;const a=3,r=e+i/2,n=t+s/2,l=this.screenToWorld(r,n),h=Math.floor(l.wx/L),c=Math.floor(l.wy/L),d=Math.min(Math.ceil(i/Re/2)+a,20),u=Math.min(Math.ceil(s/Te/2)+a,18);let f=0,m=0;for(let _=c-u;_<=c+u;_++)for(let p=h-d;p<=h+d;p++){const g=(p-_)*Re,y=(p+_)*Te;if(g<e-Re*2||g>e+i+Re*2||y<t-Te*2||y>t+s+Te*2)continue;if(f>=Rl)break;const S=this._getTile(p,_),b=this._tilePool[f];let w;if(S.type===0&&Tr[S.biome]?w=Tr[S.biome]:w=Ml[S.type],w&&w.length>0){const k=w[Math.abs((p*7+_*13)%w.length)],T=this._tileImages.get(Qi+k);if(T&&T.naturalWidth>0){const M=Il(T);b.sprite.texture=M,b.sprite.x=g,b.sprite.y=y,b.sprite.width=Re*2,b.sprite.height=Te*2,b.sprite.visible=!0;const C=dg[S.biome];S.type===9?b.sprite.tint=ug:C?b.sprite.tint=C:b.sprite.tint=16777215,S.type===9?(b.tintOverlay.visible=!0,b.tintOverlay.x=g,b.tintOverlay.y=y,b.tintOverlay.width=Re*2,b.tintOverlay.height=Te*2,b.tintOverlay.tint=5243e3,b.tintOverlay.alpha=.15+Math.sin(this._frameCount*.05)*.05):b.tintOverlay.visible=!1,b.active=!0,f++,(S.type===0||S.type===1)&&m<Mr&&(m=this._updateDecoration(m,g,y,p,_,S.biome));continue}}b.sprite.texture=Al(),b.sprite.x=g-Re,b.sprite.y=y,b.sprite.width=Re*2,b.sprite.height=Te*2,b.sprite.tint=fg(S),b.sprite.visible=!0,b.tintOverlay.visible=!1,b.active=!0,f++}for(let _=f;_<this._activeTiles;_++){const p=this._tilePool[_];p.sprite.visible=!1,p.tintOverlay.visible=!1,p.active=!1}this._activeTiles=f;for(let _=m;_<this._activeDecos;_++)this._decoPool[_].sprite.visible=!1,this._decoPool[_].active=!1;this._activeDecos=m}_updateDecoration(e,t,i,s,a,r){const n=(s*73856093^a*19349663)>>>0,l=(s*83492791^a*47165837)>>>0;let h,c;switch(r){case"rotwood":h=16,c=td;break;case"ashlands":h=8,c=id;break;case"drowned_depths":h=12,c=sd;break;case"bone_wastes":h=6,c=ad;break;case"the_void":h=5,c=rd;break;case"edilas":h=18,c=co;break;default:h=14,c=co;break}if(n%100>=h)return e;const d=c[l%c.length],u=this._tileImages.get(Qi+d);if(!u||!u.naturalWidth||e>=Mr)return e;const f=(n>>8)%11-5,m=(n>>16)%7-3,p=12+(l>>8)%9,g=p*(u.naturalHeight/u.naturalWidth),y=Il(u),S=this._decoPool[e];return S.sprite.texture=y,S.sprite.x=t+f,S.sprite.y=i+Te+m+2,S.sprite.width=p,S.sprite.height=g,S.sprite.visible=!0,S.active=!0,e+1}invalidateAll(){}}const Ca=new Map,Pa=new Map;function pg(o){if(!o||o.naturalWidth===0)return Z.EMPTY;let e=Pa.get(o.src);if(e)return e;let t=Ca.get(o.src);return t||(t=new nt({resource:o,scaleMode:"nearest"}),Ca.set(o.src,t)),e=new Z({source:t}),Pa.set(o.src,e),e}class _g{container;sprite;shadow;_glow=null;_lastTexSrc="";_lastFrameKey="";constructor(e){this.container=new we,this.container.sortableChildren=!1,this.shadow=new Ne,this.shadow.ellipse(0,3,14,5),this.shadow.fill({color:0,alpha:.2}),this.container.addChild(this.shadow),this.sprite=new _t(Z.EMPTY),this.sprite.anchor.set(.5,.85),this.container.addChild(this.sprite),e.addChild(this.container)}setTexture(e){if(!e||e.naturalWidth===0){this.sprite.texture=Z.EMPTY,this._lastTexSrc="";return}e.src!==this._lastTexSrc&&(this.sprite.texture=pg(e),this._lastTexSrc=e.src)}setFrameTexture(e,t,i,s){if(!e||e.naturalWidth===0){this.sprite.texture=Z.EMPTY,this._lastFrameKey="";return}const a=`${e.src}:${t}:${i}:${s}`;if(a===this._lastFrameKey)return;let r=Ca.get(e.src);r||(r=new nt({resource:e,scaleMode:"nearest"}),Ca.set(e.src,r));const n=t*i,l=`${e.src}:${n}:0:${i}:${s}`;let h=Pa.get(l);h||(h=new Z({source:r,frame:new $e(n,0,Math.min(i,e.naturalWidth-n),Math.min(s,e.naturalHeight))}),Pa.set(l,h)),this.sprite.texture=h,this._lastFrameKey=a}setPosition(e,t){this.container.x=e,this.container.y=t,this.container.zIndex=t}setSize(e,t){this.sprite.width=e,this.sprite.height=t}setShadowSize(e,t){this.shadow.clear(),this.shadow.ellipse(0,3,e,t),this.shadow.fill({color:0,alpha:.2})}setTint(e){this.sprite.tint=e}setAlpha(e){this.container.alpha=e}setVisible(e){this.container.visible=e}showGlow(e,t,i){this._glow||(this._glow=new Ne,this.container.addChildAt(this._glow,0)),this._glow.clear(),this._glow.circle(0,0,e),this._glow.fill({color:t,alpha:i}),this._glow.visible=!0}hideGlow(){this._glow&&(this._glow.visible=!1)}destroy(){this.container.removeFromParent(),this.container.destroy({children:!0})}}class gg{_entityLayer;_groundLayer;_sprites;_playerVisual=null;_enemyVisuals=new Map;_npcVisuals=new Map;_buildingVisuals=new Map;_resourceVisuals=new Map;_dropVisuals=new Map;_treeVisuals=new Map;_visualPool=[];_worldToScreen;constructor(e,t,i,s,a){this._entityLayer=e,this._groundLayer=t,this._sprites=i,this._worldToScreen=a}_getVisual(){const e=this._visualPool.pop();return e?(e.setVisible(!0),e.setTint(16777215),e.setAlpha(1),e.hideGlow(),e):new _g(this._entityLayer)}_recycleVisual(e){e.setVisible(!1),this._visualPool.push(e)}updatePlayer(e,t,i,s,a,r,n){this._playerVisual||(this._playerVisual=this._getVisual(),this._playerVisual.setShadowSize(16,6));const l=this._worldToScreen(e,t);this._playerVisual.setPosition(l.sx,l.sy);const h=this._sprites.getCharacterSpritePath(i,s,a);if(h){const c=this._sprites.getSprite(h);if(c&&c.naturalWidth>0){const d=c.naturalHeight,u=d,f=Math.max(1,Math.floor(c.naturalWidth/u)),m=r%f;this._playerVisual.setFrameTexture(c,m,u,d),this._playerVisual.setSize(u*2,d*2)}else this._playerVisual.setTexture(null)}this._playerVisual.setTint(n?16729156:16777215)}updateEnemies(e,t,i,s,a){const r=new Set;for(const n of e){if(!n.alive)continue;const l=this._worldToScreen(n.x,n.y),h=l.sx-t,c=l.sy-i;if(h<-80||h>s+80||c<-80||c>a+80)continue;r.add(n.id);let d=this._enemyVisuals.get(n.id);d||(d=this._getVisual(),this._enemyVisuals.set(n.id,d)),d.setPosition(l.sx,l.sy);let u=!1;const f=this._sprites.getEnemySpritePath(n.def.id,"Right","Idle");if(f){const m=this._sprites.getSprite(f);if(m&&m.naturalWidth>0){const _=m.naturalHeight,p=_,g=Math.max(1,Math.floor(m.naturalWidth/p)),y=Math.floor(Date.now()/150)%g;d.setFrameTexture(m,y,p,_),d.setSize(p*1.5,_*1.5),u=!0}}if(!u&&n.tileSpriteImg){const m=n.tileSpriteImg;if(m.naturalWidth>0){const _=m.naturalWidth,p=m.naturalHeight;let g=16,y=!1;for(const w of[48,32,16]){const k=Math.floor(_/w),T=Math.floor(p/w);if(k>=2&&T>=1&&_%w===0&&p%w===0){g=w,y=!0;break}}if(y){const w=Math.floor(_/g),k=Math.min(w,8),T=Math.floor(Date.now()/250)%Math.max(1,k);d.setFrameTexture(m,T,g,g)}else g=Math.min(_,p),d.setTexture(m);const S=g<=16?3.5:g<=32?2.4:1.6,b=Math.min(g*S,80);d.setSize(b,b),u=!0}}u||(d.setTexture(null),d.setSize(28,28)),d.setTint(n.hitFlash>0?16737894:n.isElite?16768324:16777215),n.isElite?d.showGlow(18,16755200,.2):d.hideGlow()}for(const[n,l]of this._enemyVisuals)r.has(n)||(this._recycleVisual(l),this._enemyVisuals.delete(n))}updateNPCs(e,t,i,s,a){const r=new Set;for(const n of e){const l=this._worldToScreen(n.x,n.y),h=l.sx-t,c=l.sy-i;if(h<-80||h>s+80||c<-80||c>a+80)continue;r.add(n.id);let d=this._npcVisuals.get(n.id);d||(d=this._getVisual(),this._npcVisuals.set(n.id,d)),d.setPosition(l.sx,l.sy);const u=this._sprites.getNPCSpritePath(n.def.id,"Right","Idle");if(u){const f=this._sprites.getSprite(u);if(f&&f.naturalWidth>0){const m=f.naturalHeight,_=m,p=Math.max(1,Math.floor(f.naturalWidth/_)),g=Math.floor(Date.now()/200)%p;d.setFrameTexture(f,g,_,m),d.setSize(_*1.8,m*1.8)}else d.setTexture(null)}d.showGlow(12,4491519,.15)}for(const[n,l]of this._npcVisuals)r.has(n)||(this._recycleVisual(l),this._npcVisuals.delete(n))}updateBuildings(e,t,i,s,a,r){const n=new Set;for(const l of e){const h=l.tileX*L+l.def.widthTiles*L/2,c=l.tileY*L+l.def.heightTiles*L/2,d=this._worldToScreen(h,c),u=d.sx-i,f=d.sy-s;if(u<-160||u>a+160||f<-240||f>r+160)continue;const m=`${l.id}_${l.tileX}_${l.tileY}`;n.add(m);let _=this._buildingVisuals.get(m);_||(_=this._getVisual(),_.setShadowSize(24,8),this._buildingVisuals.set(m,_)),_.setPosition(d.sx,d.sy-30),_.container.zIndex=d.sy-30;const p=this._sprites.getBuildingSpritePath(l.def.id);if(p){const g=this._sprites.getSprite(p);if(g&&g.naturalWidth>0){_.setTexture(g);const y=Math.max(l.def.widthTiles,l.def.heightTiles)*1.5;_.setSize(g.naturalWidth*y*.6,g.naturalHeight*y*.6)}else _.setTexture(null)}t?_.showGlow(32,16755268,.15):_.hideGlow()}for(const[l,h]of this._buildingVisuals)n.has(l)||(this._recycleVisual(h),this._buildingVisuals.delete(l))}updateResources(e,t,i,s,a){const r=new Set;for(const n of e){if(n.amount<=0)continue;const l=this._worldToScreen(n.x,n.y),h=l.sx-t,c=l.sy-i;if(h<-60||h>s+60||c<-60||c>a+60)continue;const d=`${n.id}_${n.x}_${n.y}`;r.add(d);let u=this._resourceVisuals.get(d);u||(u=this._getVisual(),u.setShadowSize(10,4),this._resourceVisuals.set(d,u)),u.setPosition(l.sx,l.sy);const f=this._sprites.getResourceSpritePath(n.def?.itemId??n.id);if(f){const m=this._sprites.getSprite(f);m&&m.naturalWidth>0?(u.setTexture(m),u.setSize(32,32)):u.setTexture(null)}}for(const[n,l]of this._resourceVisuals)r.has(n)||(this._recycleVisual(l),this._resourceVisuals.delete(n))}updateDrops(e,t,i,s,a,r){const n=new Set;for(const l of e){const h=this._worldToScreen(l.x,l.y),c=h.sx-i,d=h.sy-s;if(c<-40||c>a+40||d<-40||d>r+40)continue;n.add(l.id);let u=this._dropVisuals.get(l.id);u||(u=this._getVisual(),u.setShadowSize(6,3),this._dropVisuals.set(l.id,u));const f=Math.sin(t*.004+l.bobPhase)*3;if(u.setPosition(h.sx,h.sy-8+f),l.gold>0)u.setTexture(null),u.setSize(16,16);else{const m=this._sprites.getItemSprite(l.itemId);m&&m.naturalWidth>0?(u.setTexture(m),u.setSize(16,16)):u.setTexture(null)}l.timer<5?u.setAlpha(Math.sin(l.timer*8)>0?.4:1):u.setAlpha(1),u.showGlow(8,l.gold>0?16762930:4521796,.2)}for(const[l,h]of this._dropVisuals)n.has(l)||(this._recycleVisual(h),this._dropVisuals.delete(l))}updateTrees(e,t,i,s,a,r,n){const l=new Set;for(const h of e){const c=this._worldToScreen(h.x,h.y),d=c.sx-s,u=c.sy-a;if(d<-80||d>r+80||u<-80||u>n+80)continue;l.add(h.idx);let f=this._treeVisuals.get(h.idx);f||(f=this._getVisual(),f.sprite.anchor.set(.5,.9),f.setShadowSize(h.scale*16,h.scale*4),this._treeVisuals.set(h.idx,f));const m=Math.sin(i*8e-4+h.x*.05)*1;f.setPosition(c.sx+m,c.sy);const _=this._sprites.getTreeSprite(t,h.seed);if(_&&_.naturalWidth>0){f.setTexture(_);const p=100*h.scale,g=p*(_.naturalWidth/_.naturalHeight);f.setSize(g,p)}f.setAlpha(.85+h.seed%15/100)}for(const[h,c]of this._treeVisuals)l.has(h)||(this._recycleVisual(c),this._treeVisuals.delete(h))}clear(){this._playerVisual&&(this._playerVisual.destroy(),this._playerVisual=null);for(const e of this._enemyVisuals.values())e.destroy();for(const e of this._npcVisuals.values())e.destroy();for(const e of this._buildingVisuals.values())e.destroy();for(const e of this._resourceVisuals.values())e.destroy();for(const e of this._dropVisuals.values())e.destroy();for(const e of this._treeVisuals.values())e.destroy();for(const e of this._visualPool)e.destroy();this._enemyVisuals.clear(),this._npcVisuals.clear(),this._buildingVisuals.clear(),this._resourceVisuals.clear(),this._dropVisuals.clear(),this._treeVisuals.clear(),this._visualPool.length=0}updateEnemiesRaw(e,t,i,s,a){this._rawEnemyBuf.length=0;for(let r=0;r<e.length;r++){const n=e[r];n.alive&&this._rawEnemyBuf.push(n)}this.updateEnemies(this._rawEnemyBuf,t,i,s,a)}_rawEnemyBuf=[];updateNPCsRaw(e,t,i,s,a){this.updateNPCs(e,t,i,s,a)}updateBuildingsRaw(e,t,i,s,a,r){this.updateBuildings(e,t,i,s,a,r)}updateResourcesRaw(e,t,i,s,a){this._rawResBuf.length=0;for(let r=0;r<e.length;r++){const n=e[r];n.depleted||n.health<=0||this._rawResBuf.push(n)}this.updateResources(this._rawResBuf,t,i,s,a)}_rawResBuf=[];updateDropsRaw(e,t,i,s,a,r){this.updateDrops(e,t,i,s,a,r)}updateTreesRaw(e,t,i,s,a,r,n){this.updateTrees(e,t,i,s,a,r,n)}}let Ks=null;const xl=new Map,El=new Map;function yg(){if(Ks)return Ks;const o=16,e=document.createElement("canvas");e.width=o,e.height=o;const t=e.getContext("2d"),i=t.createRadialGradient(o/2,o/2,0,o/2,o/2,o/2);i.addColorStop(0,"rgba(255,255,255,1)"),i.addColorStop(.5,"rgba(255,255,255,0.6)"),i.addColorStop(1,"rgba(255,255,255,0)"),t.fillStyle=i,t.fillRect(0,0,o,o);const s=new nt({resource:e,scaleMode:"nearest"});return Ks=new Z({source:s}),Ks}function bg(o,e){if(!o||o.naturalWidth===0)return Z.EMPTY;const t=o.naturalWidth,s=o.naturalHeight,a=Math.max(1,Math.floor(t/s)),r=e%a,n=`${o.src}:vfx:${r}`;let l=xl.get(n);if(l)return l;let h=El.get(o.src);return h||(h=new nt({resource:o,scaleMode:"nearest"}),El.set(o.src,h)),l=new Z({source:h,frame:new $e(r*s,0,s,s)}),xl.set(n,l),l}const Dl=500;class wg{_container;_pool=[];_activeCount=0;_defaultTex;constructor(e){this._container=new we,this._container.label="particles",e.addChild(this._container),this._defaultTex=yg();for(let t=0;t<Dl;t++){const i=new _t(this._defaultTex);i.anchor.set(.5),i.visible=!1,this._container.addChild(i),this._pool.push({sprite:i,active:!1})}}setSpriteRegistry(e){this._sprites=e}_sprites=null;update(e,t,i){let s=0;for(const a of e){if(!a.alive||s>=Dl)continue;const r=this._pool[s],n=a.x-t,l=a.y-i;r.sprite.x=n,r.sprite.y=l,r.sprite.alpha=Math.max(0,Math.min(1,a.alpha)),r.sprite.visible=!0;const h=a.vfxKey,c=h?this._sprites?.getVFXSprite(h):void 0;if(c&&c.naturalWidth>0){const d=Math.floor(Date.now()/80)%8,u=bg(c,d);r.sprite.texture!==u&&(r.sprite.texture=u);const f=a.radius*4;r.sprite.width=f,r.sprite.height=f}else r.sprite.texture!==this._defaultTex&&(r.sprite.texture=this._defaultTex),r.sprite.width=a.radius*2,r.sprite.height=a.radius*2;r.sprite.tint=vg(a.color),r.active=!0,s++}for(let a=s;a<this._activeCount;a++)this._pool[a].sprite.visible=!1,this._pool[a].active=!1;this._activeCount=s}setBlendMode(e){for(const t of this._pool)t.sprite.blendMode=e}destroy(){this._container.removeFromParent(),this._container.destroy({children:!0})}}function vg(o){if(o.startsWith("#"))return parseInt(o.slice(1,7),16)||16777215;if(o.startsWith("rgb")){const e=o.match(/(\d+)/g);if(e&&e.length>=3)return parseInt(e[0])<<16|parseInt(e[1])<<8|parseInt(e[2])}return 16777215}const Fl=new Map;function Sg(o=128){let e=Fl.get(o);if(e)return e;const t=document.createElement("canvas");t.width=o,t.height=o;const i=t.getContext("2d"),s=o/2,a=i.createRadialGradient(s,s,0,s,s,s);a.addColorStop(0,"rgba(255,255,255,1)"),a.addColorStop(.3,"rgba(255,255,255,0.6)"),a.addColorStop(.6,"rgba(255,255,255,0.2)"),a.addColorStop(1,"rgba(255,255,255,0)"),i.fillStyle=a,i.fillRect(0,0,o,o);const r=new nt({resource:t,scaleMode:"linear"});return e=new Z({source:r}),Fl.set(o,e),e}const $l=30;class kg{_container;_ambientOverlay;_lightContainer;_lightPool=[];_activeLights=0;_ambient=1;constructor(e){this._container=e,this._ambientOverlay=new Ne,this._ambientOverlay.blendMode="multiply",this._container.addChild(this._ambientOverlay),this._lightContainer=new we,this._lightContainer.blendMode="add",this._container.addChild(this._lightContainer);const t=Sg(128);for(let i=0;i<$l;i++){const s=new _t(t);s.anchor.set(.5),s.visible=!1,this._lightContainer.addChild(s),this._lightPool.push({sprite:s,active:!1})}}update(e,t,i,s,a,r,n){if(this._ambient=i,i>=.95&&s.length===0){this._ambientOverlay.visible=!1;for(let f=0;f<this._activeLights;f++)this._lightPool[f].sprite.visible=!1;this._activeLights=0;return}const l=Math.floor(i*255),h=Math.floor(i*230),c=Math.floor(i*200),d=l<<16|h<<8|c;this._ambientOverlay.clear(),this._ambientOverlay.rect(0,0,e,t),this._ambientOverlay.fill({color:d}),this._ambientOverlay.visible=!0;let u=0;for(const f of s){if(u>=$l)break;const m=f.x-a,_=f.y-r;if(m<-f.radius||m>e+f.radius||_<-f.radius||_>t+f.radius)continue;let p=f.intensity;f.flicker&&(p+=Math.sin(n*f.flickerSpeed)*f.flickerAmount,p=Math.max(0,Math.min(1,p)));const g=this._lightPool[u];g.sprite.x=m,g.sprite.y=_,g.sprite.width=f.radius*2,g.sprite.height=f.radius*2,g.sprite.alpha=p,g.sprite.tint=f._r<<16|f._g<<8|f._b,g.sprite.visible=!0,g.active=!0,u++}for(let f=u;f<this._activeLights;f++)this._lightPool[f].sprite.visible=!1,this._lightPool[f].active=!1;this._activeLights=u}destroy(){this._container.removeFromParent(),this._container.destroy({children:!0})}}class Tg{_container;_nightOverlay;_damageFlash;_levelUpFlash;_comboFlash;_lowHealthVignette;_corruptionTint;_width=0;_height=0;constructor(e){this._container=e,this._corruptionTint=new Ne,this._container.addChild(this._corruptionTint),this._nightOverlay=new Ne,this._container.addChild(this._nightOverlay),this._damageFlash=new Ne,this._container.addChild(this._damageFlash),this._levelUpFlash=new Ne,this._container.addChild(this._levelUpFlash),this._comboFlash=new Ne,this._container.addChild(this._comboFlash),this._lowHealthVignette=new Ne,this._container.addChild(this._lowHealthVignette)}setViewport(e,t){this._width=e,this._height=t}updateNight(e){if(e<=0){this._nightOverlay.visible=!1;return}this._nightOverlay.clear(),this._nightOverlay.rect(0,0,this._width,this._height),this._nightOverlay.fill({color:657960,alpha:e*.6}),this._nightOverlay.visible=!0}updateDamageFlash(e){if(e<=0){this._damageFlash.visible=!1;return}const t=e/.2*.18;this._damageFlash.clear(),this._damageFlash.rect(0,0,this._width,this._height),this._damageFlash.fill({color:13112340,alpha:t}),this._damageFlash.visible=!0}updateLevelUpFlash(e){if(e<=0){this._levelUpFlash.visible=!1;return}const t=Math.sin(e*8)*.15;if(t<=0){this._levelUpFlash.visible=!1;return}this._levelUpFlash.clear(),this._levelUpFlash.rect(0,0,this._width,this._height),this._levelUpFlash.fill({color:16766720,alpha:t}),this._levelUpFlash.visible=!0}updateComboFlash(e,t){if(e<=0){this._comboFlash.visible=!1;return}this._comboFlash.clear(),this._comboFlash.rect(0,0,this._width,this._height),this._comboFlash.fill({color:t,alpha:e*.2}),this._comboFlash.visible=!0}updateLowHealth(e){if(e>=.3||e<=0){this._lowHealthVignette.visible=!1;return}const t=1-e/.3,i=.5+.5*Math.sin(performance.now()*.004),s=t*i*.25;this._lowHealthVignette.clear(),this._lowHealthVignette.rect(0,0,this._width,this._height),this._lowHealthVignette.fill({color:11796480,alpha:s}),this._lowHealthVignette.visible=!0}updateCorruptionTint(e){if(e<=0){this._corruptionTint.visible=!1;return}this._corruptionTint.clear(),this._corruptionTint.rect(0,0,this._width,this._height),this._corruptionTint.fill({color:2752576,alpha:Math.min(e,.3)}),this._corruptionTint.visible=!0}hideAll(){this._nightOverlay.visible=!1,this._damageFlash.visible=!1,this._levelUpFlash.visible=!1,this._comboFlash.visible=!1,this._lowHealthVignette.visible=!1,this._corruptionTint.visible=!1}destroy(){this._container.removeFromParent(),this._container.destroy({children:!0})}}const Ia=new Map,Aa=new Map;function Ll(o){if(!o||o.naturalWidth===0)return Z.EMPTY;let e=Ia.get(o.src);if(e)return e;let t=Aa.get(o.src);return t||(t=new nt({resource:o,scaleMode:"nearest"}),Aa.set(o.src,t)),e=new Z({source:t}),Ia.set(o.src,e),e}const od={cave:{wallColor:3815994,floorColor:5592405,doorColor:9071162,trapColor:11158596,accentColor:8956552,bgColor:1710618},ruins:{wallColor:5921376,floorColor:6974064,doorColor:9075290,trapColor:11167300,accentColor:8947872,bgColor:2763312},crypt:{wallColor:3816010,floorColor:4868698,doorColor:6969930,trapColor:11158664,accentColor:7829418,bgColor:1710634},mine:{wallColor:4864554,floorColor:5917242,doorColor:8022602,trapColor:13404228,accentColor:11176004,bgColor:2759178},corruption_core:{wallColor:3807802,floorColor:4860490,doorColor:6961770,trapColor:11158698,accentColor:10502348,bgColor:1706522},rift:{wallColor:2763338,floorColor:3816026,doorColor:5917322,trapColor:8930508,accentColor:6702250,bgColor:657962},sewer:{wallColor:3820090,floorColor:4872778,doorColor:6978138,trapColor:4500036,accentColor:6728294,bgColor:1714714}},Mg=od.cave,J=16;class Cg{container;_floorLayer;_wallLayer;_objectLayer;entityLayer;_fogLayer;_sprites=null;_builtFloor=null;_tileGraphics=null;constructor(){this.container=new we,this.container.label="dungeon",this._floorLayer=new we,this._floorLayer.label="dungeon_floor",this._wallLayer=new we,this._wallLayer.label="dungeon_walls",this._objectLayer=new we,this._objectLayer.label="dungeon_objects",this.entityLayer=new we,this.entityLayer.label="dungeon_entities",this.entityLayer.sortableChildren=!0,this._fogLayer=new we,this._fogLayer.label="dungeon_fog",this.container.addChild(this._floorLayer),this.container.addChild(this._wallLayer),this.container.addChild(this._objectLayer),this.container.addChild(this.entityLayer),this.container.addChild(this._fogLayer)}setSpriteRegistry(e){this._sprites=e}buildFloor(e){this.clear(),this._builtFloor=e;const t=od[e.theme]??Mg,i=new Ne;for(let s=0;s<e.height;s++){const a=e.tiles[s];if(a)for(let r=0;r<e.width;r++){const n=a[r];if(!n)continue;const l=r*J,h=s*J,c=this._getTileSpriteKey(n,r,s),d=c&&this._sprites?this._sprites.getSprite(ka[c]??""):void 0;if(d&&d.naturalWidth>0){const u=Ll(d);if(u!==Z.EMPTY){const f=new _t(u);f.x=l,f.y=h,f.width=J,f.height=J,n==="wall"||n==="hidden_wall"?this._wallLayer.addChild(f):n==="door"||n==="chest"||n==="trap"||n==="stairs_up"||n==="stairs_down"?this._objectLayer.addChild(f):this._floorLayer.addChild(f);continue}}this._drawTile(i,n,l,h,t,e,r,s)}}this._tileGraphics=i,this._floorLayer.addChild(i)}_getTileSpriteKey(e,t,i){switch(e){case"floor":{const s=(t*73+i*137&7)+1;return`floor_${Math.min(s,8)}`}case"wall":return"wall_mid";case"hidden_wall":return"wall_mid";case"door":return"door_closed";case"chest":return"chest_full_f0";case"trap":return"spikes_f0";case"stairs_up":return"stairs";case"stairs_down":return"ladder";default:return null}}_drawTile(e,t,i,s,a,r,n,l){switch(t){case"wall":{e.rect(i,s,J,J),e.fill(a.wallColor),e.rect(i,s,J,1),e.fill({color:16777215,alpha:.05}),e.rect(i,s,1,J),e.fill({color:16777215,alpha:.05});break}case"floor":{e.rect(i,s,J,J),e.fill(a.floorColor),e.rect(i,s,J,J),e.stroke({color:0,width:.5,alpha:.1});break}case"door":{e.rect(i,s,J,J),e.fill(a.floorColor),e.rect(i+2,s+2,J-4,J-4),e.fill(a.doorColor);break}case"chest":{e.rect(i,s,J,J),e.fill(a.floorColor),e.rect(i+3,s+4,J-6,J-6),e.fill(13408546),e.rect(i+4,s+5,J-8,J-8),e.fill(16764006);break}case"trap":{e.rect(i,s,J,J),e.fill(a.floorColor),e.circle(i+J/2,s+J/2,3),e.fill(a.trapColor);break}case"stairs_up":{e.rect(i,s,J,J),e.fill(a.floorColor);for(let h=0;h<4;h++)e.rect(i+2,s+2+h*3,J-4,2),e.fill(a.accentColor);break}case"stairs_down":{e.rect(i,s,J,J),e.fill(2236962);for(let h=0;h<3;h++)e.rect(i+4,s+4+h*3,J-8,2),e.fill(a.accentColor);break}case"boss_gate":{e.rect(i,s,J,J),e.fill(4460834),e.rect(i,s,J,J),e.fill({color:16711680,alpha:.15});break}case"corruption":{e.rect(i,s,J,J),e.fill(a.floorColor),e.rect(i,s,J,J),e.fill({color:8913151,alpha:.3});break}case"water":{e.rect(i,s,J,J),e.fill(2245802);break}case"lava":{e.rect(i,s,J,J),e.fill(13386752);break}case"ice":{e.rect(i,s,J,J),e.fill(8965375);break}case"seal_altar":{e.rect(i,s,J,J),e.fill(a.floorColor),e.circle(i+J/2,s+J/2,5),e.fill(16768324);break}case"ore_vein":{e.rect(i,s,J,J),e.fill(a.wallColor),e.circle(i+5,s+6,2),e.fill(11176004),e.circle(i+11,s+10,2),e.fill(13412966);break}case"hidden_wall":{e.rect(i,s,J,J),e.fill(a.wallColor);break}default:{e.rect(i,s,J,J),e.fill(0);break}}}setCamera(e,t,i,s){this.container.x=i/2-e,this.container.y=s/2-t}updateEntitySprite(e,t,i,s,a=6,r=!1,n){if(n&&n.naturalWidth>0){let h=this.entityLayer.getChildByLabel(`ent_spr_${e}`);h||(h=new _t(Z.EMPTY),h.label=`ent_spr_${e}`,h.anchor.set(.5,.85),this.entityLayer.addChild(h));const c=Ll(n);if(c!==Z.EMPTY&&h.texture!==c){const f=n.naturalWidth,m=n.naturalHeight;let _=f,p=m;for(const g of[80,48,32,16])if(f>=g*2&&f%g===0&&m%g===0){_=g,p=g;break}if(_<f||p<m){const g=`${n.src}:dg:0:0:${_}:${p}`;let y=Ia.get(g);if(!y){let S=Aa.get(n.src);S||(S=new nt({resource:n,scaleMode:"nearest"}),Aa.set(n.src,S)),y=new Z({source:S,frame:new $e(0,0,_,p)}),Ia.set(g,y)}h.texture=y}else h.texture=c}const d=r?a*3.5:a*3;h.width=d,h.height=d,h.x=t,h.y=i,h.zIndex=i,h.tint=r?16777215:s;const u=this.entityLayer.getChildByLabel(`ent_${e}`);u&&(this.entityLayer.removeChild(u),u.destroy());return}let l=this.entityLayer.getChildByLabel(`ent_${e}`);l||(l=new Ne,l.label=`ent_${e}`,this.entityLayer.addChild(l)),l.clear(),l.circle(0,0,a),l.fill(s),r&&(l.circle(0,0,a+1),l.stroke({color:16777215,width:1})),l.x=t,l.y=i,l.zIndex=i}removeEntitySprite(e){for(const t of[`ent_${e}`,`ent_spr_${e}`]){const i=this.entityLayer.getChildByLabel(t);i&&(this.entityLayer.removeChild(i),i.destroy())}}clearEntities(){this.entityLayer.removeChildren()}clear(){this._floorLayer.removeChildren(),this._wallLayer.removeChildren(),this._objectLayer.removeChildren(),this.entityLayer.removeChildren(),this._fogLayer.removeChildren(),this._tileGraphics=null,this._builtFloor=null}get hasFloor(){return this._builtFloor!==null}}const Bl={forest:{skyTop:1717026,skyBottom:2774323,floorColor:3820090,wallColor:2767402,fogColor:8956552,accentColor:4500036},fire:{skyTop:2755072,skyBottom:5904896,floorColor:4860442,wallColor:3807754,fogColor:11158528,accentColor:16737792},water:{skyTop:662074,skyBottom:1718874,floorColor:2767450,wallColor:1714762,fogColor:4491468,accentColor:4491519},bone:{skyTop:1710618,skyBottom:3815994,floorColor:4868666,wallColor:3815978,fogColor:8947831,accentColor:13421738},void:{skyTop:657946,skyBottom:1710650,floorColor:2759226,wallColor:1706538,fogColor:6702250,accentColor:11158783},corruption:{skyTop:1706522,skyBottom:3807802,floorColor:3811898,wallColor:2759210,fogColor:8930440,accentColor:13386956},eden:{skyTop:2767434,skyBottom:4876938,floorColor:5929578,wallColor:4876890,fogColor:8956620,accentColor:16766720}},Pg={width:800,height:400,floorY:320,theme:"forest",bossName:"Unknown",biome:"haven"};class Ig{container;_bgLayer;_midLayer;_floorLayer;entityLayer;_fxLayer;_uiLayer;_config={...Pg};_sprites=null;_built=!1;_bgScrollX=0;_midScrollX=0;constructor(){this.container=new we,this.container.label="boss_arena",this._bgLayer=new we,this._bgLayer.label="arena_bg",this._midLayer=new we,this._midLayer.label="arena_mid",this._floorLayer=new we,this._floorLayer.label="arena_floor",this.entityLayer=new we,this.entityLayer.label="arena_entities",this.entityLayer.sortableChildren=!0,this._fxLayer=new we,this._fxLayer.label="arena_fx",this._uiLayer=new we,this._uiLayer.label="arena_ui",this.container.addChild(this._bgLayer),this.container.addChild(this._midLayer),this.container.addChild(this._floorLayer),this.container.addChild(this.entityLayer),this.container.addChild(this._fxLayer),this.container.addChild(this._uiLayer)}setSpriteRegistry(e){this._sprites=e}get config(){return this._config}get built(){return this._built}buildArena(e){this.clear(),this._config={...e};const t=Bl[e.theme]??Bl.forest;this._buildBackground(t,e),this._buildMidground(t,e),this._buildFloor(t,e),this._built=!0}_buildBackground(e,t){const i=new Ne,s=t.floorY;for(let a=0;a<s;a+=4){const r=a/s,n=(e.skyTop>>16&255)*(1-r)+(e.skyBottom>>16&255)*r,l=(e.skyTop>>8&255)*(1-r)+(e.skyBottom>>8&255)*r,h=(e.skyTop&255)*(1-r)+(e.skyBottom&255)*r,c=Math.round(n)<<16|Math.round(l)<<8|Math.round(h);i.rect(0,a,t.width,4),i.fill(c)}this._bgLayer.addChild(i)}_buildMidground(e,t){const i=new Ne,s=t.floorY-80;for(let a=0;a<t.width;a+=40){const r=20+Math.sin(a*.05)*30+Math.sin(a*.02)*20;i.rect(a,s-r,40,r+80),i.fill({color:e.fogColor,alpha:.15})}this._midLayer.addChild(i)}_buildFloor(e,t){const i=new Ne;i.rect(0,t.floorY,t.width,t.height-t.floorY),i.fill(e.floorColor);for(let s=0;s<t.width;s+=32)i.rect(s,t.floorY,32,1),i.fill({color:0,alpha:.1});i.rect(0,0,16,t.height),i.fill(e.wallColor),i.rect(t.width-16,0,16,t.height),i.fill(e.wallColor),i.rect(16,t.floorY-2,t.width-32,2),i.fill(e.accentColor),this._floorLayer.addChild(i)}setCamera(e,t,i){const s=t/2,a=Math.max(s,Math.min(this._config.width-s,e));this.container.x=t/2-a,this.container.y=0,this._bgLayer.x=(a-s)*.1,this._midLayer.x=(a-s)*.3}updateEntitySprite(e,t,i,s,a,r,n=!0){let l=this.entityLayer.getChildByLabel(e);l||(l=new Ne,l.label=e,this.entityLayer.addChild(l)),l.clear(),l.rect(-a/2,-r,a,r),l.fill(s);const h=n?a/2+3:-a/2-3;l.circle(h,-r/2,2),l.fill(16777215),l.x=t,l.y=i,l.zIndex=i}spawnProjectileVFX(e,t,i,s,a=4){const r=new Ne;r.label=`proj_${e}`,r.circle(0,0,a),r.fill(s),r.x=t,r.y=i,this._fxLayer.addChild(r)}updateProjectileVFX(e,t,i){const s=this._fxLayer.getChildByLabel(`proj_${e}`);s&&(s.x=t,s.y=i)}removeProjectileVFX(e){const t=this._fxLayer.getChildByLabel(`proj_${e}`);t&&(this._fxLayer.removeChild(t),t.destroy())}updateBossHealthBar(e,t,i,s,a=400){let r=this._uiLayer.getChildByLabel("boss_hp");r||(r=new Ne,r.label="boss_hp",this._uiLayer.addChild(r)),r.clear();const n=(this._config.width-a)/2,l=16,h=12;r.rect(n-2,l-2,a+4,h+4),r.fill(0);const c=Math.max(0,t/i),d=c>.5?13378082:c>.25?13395490:13378116;r.rect(n,l,a*c,h),r.fill(d),r.rect(n,l,a,h),r.stroke({color:16777215,width:1,alpha:.5})}clearEntities(){this.entityLayer.removeChildren()}clearFX(){this._fxLayer.removeChildren()}clear(){this._bgLayer.removeChildren(),this._midLayer.removeChildren(),this._floorLayer.removeChildren(),this.entityLayer.removeChildren(),this._fxLayer.removeChildren(),this._uiLayer.removeChildren(),this._built=!1}}class Ag{eid;appearance;animation="stand";animFrame=0;animTimer=0;isMoving=!1;isSprinting=!1;speed;sprintMultiplier;weatherSpeedMod=1;sprintCostMult=1;isAttacking=!1;attackTimer=0;invincible=!0;invincibleTimer=5;hitFlash=0;isDodging=!1;dodgeTimer=0;dodgeCooldown=0;dodgeVx=0;dodgeVy=0;static DODGE_SPEED=380;static DODGE_DURATION=.18;static DODGE_COOLDOWN=.6;static DODGE_STAMINA_COST=15;level=1;xp=0;xpToNext=100;gold=0;constructor(e){this.eid=Is(e),ce(e,j,this.eid),ce(e,U,this.eid),ce(e,Ge,this.eid),ce(e,x,this.eid),ce(e,ke,this.eid),ce(e,Qe,this.eid),ce(e,Oa,this.eid),ce(e,ye,this.eid),ce(e,xe,this.eid),ce(e,Wi,this.eid),xe.value[this.eid]=1,ye.width[this.eid]=48,ye.height[this.eid]=48,ye.totalFrames[this.eid]=6,Wi.count[this.eid]=0;const t=rs;j.x[this.eid]=t.startX,j.y[this.eid]=t.startY,Ge.dir[this.eid]=0,x.current[this.eid]=t.maxHealth,x.max[this.eid]=t.maxHealth,ke.current[this.eid]=t.maxStamina,ke.max[this.eid]=t.maxStamina,Qe.current[this.eid]=t.maxHunger,Qe.max[this.eid]=t.maxHunger,this.speed=t.speed,this.sprintMultiplier=t.sprintMultiplier;const i=gp[t.outfit];this.appearance={skinTone:t.skinTone,hairstyle:t.hairstyle,hairColor:t.hairColor,outfit:t.outfit,outfitPack:i?.pack,outfitLayer:i?.layer,outfitCode:i?.code,outfitVariant:i?.variant}}async preload(e){await z_(e,this.appearance),console.log("[Player] Mana Seed sprites loaded")}get x(){return j.x[this.eid]}set x(e){j.x[this.eid]=e}get y(){return j.y[this.eid]}set y(e){j.y[this.eid]=e}get facing(){return Ge.dir[this.eid]}set facing(e){Ge.dir[this.eid]=e}get health(){return x.current[this.eid]}get maxHealth(){return x.max[this.eid]}get stamina(){return ke.current[this.eid]}get maxStamina(){return ke.max[this.eid]}get hunger(){return Qe.current[this.eid]}get maxHunger(){return Qe.max[this.eid]}handleInput(e,t){let i=0,s=0,a=this.speed*this.weatherSpeedMod;const r=e.isHeld("ShiftLeft")||e.isHeld("ShiftRight");if(this.isSprinting=r&&this.stamina>0,this.isSprinting&&(a*=this.sprintMultiplier),(e.isHeld("KeyA")||e.isHeld("ArrowLeft"))&&(i=-a,Ge.dir[this.eid]=3),(e.isHeld("KeyD")||e.isHeld("ArrowRight"))&&(i=a,Ge.dir[this.eid]=2),(e.isHeld("KeyW")||e.isHeld("ArrowUp"))&&(s=-a,Ge.dir[this.eid]=1),(e.isHeld("KeyS")||e.isHeld("ArrowDown"))&&(s=a,Ge.dir[this.eid]=0),i!==0&&s!==0){const n=1/Math.SQRT2;i*=n,s*=n}this.isMoving=i!==0||s!==0,U.vx[this.eid]=i,U.vy[this.eid]=s,this.isSprinting&&this.isMoving&&(ke.current[this.eid]=Math.max(0,this.stamina-mp*this.sprintCostMult*t))}updateAnimation(e){const t=this.animation;this.isAttacking?this.animation="push":this.isMoving?this.animation=this.isSprinting?"run":"walk":this.animation="stand",this.animation!==t&&(this.animFrame=0,this.animTimer=0);const i=Rc[this.animation];i&&i.frames>1?(this.animTimer+=e*1e3,this.animTimer>=i.speed&&(this.animTimer-=i.speed,this.animFrame=(this.animFrame+1)%i.frames)):this.animFrame=0,this.hitFlash>0&&(this.hitFlash=Math.max(0,this.hitFlash-e)),this.invincible&&(this.invincibleTimer-=e,this.invincibleTimer<=0&&(this.invincible=!1,this.invincibleTimer=0))}draw(e,t,i,s,a){const r=t.worldToScreen(this.x,this.y),n=Math.floor(r.sx-s),l=Math.floor(r.sy-a),h=pp,c=64*h,d=64*h;if(this.invincible&&this.invincibleTimer<1.2){const m=.5+.3*Math.sin(Date.now()*.012);e.globalAlpha=m}e.fillStyle="rgba(0,0,0,0.3)",e.beginPath(),e.ellipse(n,l+20,c*.22,5,0,0,Math.PI*2),e.fill();let u=0;!this.isMoving&&!this.isAttacking&&(u=Math.sin(Date.now()*.003)*1.5);const f=ed(e,i,this.appearance,{x:n-c/2,y:l-d+24+u,animation:this.animation,direction:this.facing,frame:this.animFrame,scale:h});if(f&&this.hitFlash>0){const m=this.hitFlash/.15*.5;e.fillStyle=`rgba(255, 0, 0, ${m})`,e.globalCompositeOperation="source-atop",e.fillRect(n-c/2,l-d,c,d),e.globalCompositeOperation="source-over"}e.globalAlpha=1,f||(e.fillStyle="#ffcc44",e.fillRect(n-12,l-24,24,24),e.strokeStyle="#000",e.lineWidth=1,e.strokeRect(n-12,l-24,24,24))}get str(){return 5+this.level*3}takeDamage(e){if(this.invincible)return;const t=Nt.baseDefense+(this.level-1)*Nt.defensePerLevel,i=t/(t+30),s=Math.max(1,Math.round(e*(1-i)));x.current[this.eid]=Math.max(0,this.health-s),this.hitFlash=.15,this.invincible=!0,this.invincibleTimer=yp.invulnerabilityTime}heal(e){x.current[this.eid]=Math.min(this.maxHealth,this.health+e)}addXP(e){this.xp+=e;let t=!1;for(;this.xp>=this.xpToNext;)this.xp-=this.xpToNext,this.level++,this.xpToNext=Math.floor(Nt.baseXPToLevel*Math.pow(Nt.xpLevelScaling,this.level-1)),x.max[this.eid]=(x.max[this.eid]??100)+Nt.healthPerLevel,x.current[this.eid]=x.max[this.eid],t=!0,console.log(`[Player] Level up! Now level ${this.level} (HP: ${x.max[this.eid]})`);return t}setPosition(e,t){this.x=e,this.y=t}restoreStats(e){this.level=e.level,this.xp=e.xp,this.gold=e.gold??this.gold,this.xpToNext=Math.floor(Nt.baseXPToLevel*Math.pow(Nt.xpLevelScaling,e.level-1)),x.max[this.eid]=e.maxHealth,x.current[this.eid]=e.health,ke.max[this.eid]=e.maxStamina,ke.current[this.eid]=e.stamina,Qe.max[this.eid]=e.maxHunger,Qe.current[this.eid]=e.hunger}}const Qs={slime:{id:"slime",name:"Slime",icon:"",health:30,damage:5,defense:1,aggroRange:100,speed:30,color:"#4ade80",glowColor:"#22c55e",width:24,height:20,xpReward:10,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Slime/Slime.png",weakness:"Fire",resistance:"Poison",behavior:"wander",category:"common",biome:"haven",description:"A gelatinous creature that bounces toward its prey.",lootTable:[{id:"slime_gel",chance:.6,min:1,max:2},{id:"copper_ore",chance:.2,min:1,max:1}]},red_slime:{id:"red_slime",name:"Red Slime",icon:"",health:45,damage:8,defense:2,aggroRange:110,speed:35,color:"#ef4444",glowColor:"#dc2626",width:26,height:22,xpReward:18,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Slime2/Slime2.png",weakness:"Ice",resistance:"Fire",behavior:"wander",category:"common",effect:"burn",biome:"ashlands",description:"A fiery slime that burns everything it touches.",abilities:["Burns on contact"],lootTable:[{id:"slime_gel",chance:.4,min:1,max:2},{id:"coal",chance:.3,min:1,max:1}]},wolf:{id:"wolf",name:"Shadow Wolf",icon:"",health:50,damage:12,defense:3,aggroRange:150,speed:65,color:"#78716c",glowColor:"#a8a29e",width:28,height:24,xpReward:25,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Animals/Dog2/SpriteSheet.png",weakness:"Fire",resistance:"Ice",behavior:"pack",category:"common",biome:"rotwood",description:"A wild predator that hunts in packs.",abilities:["Pack tactics - stronger with allies"],lootTable:[{id:"fur",chance:.7,min:1,max:3},{id:"fang",chance:.4,min:1,max:2},{id:"raw_meat",chance:.5,min:1,max:1}]},skeleton:{id:"skeleton",name:"Skeleton Warrior",icon:"",health:60,damage:15,defense:5,aggroRange:130,speed:40,color:"#d4d4d8",glowColor:"#e4e4e7",width:48,height:48,xpReward:30,spriteType:"skeleton_grunt",frameSize:Je,tileSprite:"Sprites/Supplementary/0x72-dungeon-tileset-ii/0x72_DungeonTilesetII_v1.7/frames/skelet_idle_anim_f0.png",weakness:"Blunt",resistance:"Pierce",behavior:"chase",category:"dungeon",biome:"bone_wastes",description:"An animated pile of bones wielding ancient weapons.",lootTable:[{id:"bone",chance:.5,min:1,max:2},{id:"stone",chance:.4,min:1,max:3},{id:"coal",chance:.2,min:1,max:1}]},mushroom_spirit:{id:"mushroom_spirit",name:"Fungal Spirit",icon:"",health:35,damage:7,defense:2,aggroRange:80,speed:25,color:"#a855f7",glowColor:"#c084fc",width:22,height:26,xpReward:15,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Mushroom/mushroom.png",weakness:"Fire",resistance:"Poison",behavior:"wander",category:"common",effect:"poison",biome:"rotwood",description:"A giant mushroom that releases poisonous spores.",abilities:["Poison cloud on death"],lootTable:[{id:"spore",chance:.35,min:1,max:2},{id:"mushroom",chance:.5,min:1,max:2}]},shadow_wisp:{id:"shadow_wisp",name:"Shadow Wisp",icon:"",health:30,damage:18,defense:0,aggroRange:180,speed:50,color:"#312e81",glowColor:"#6366f1",width:20,height:20,xpReward:35,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Spirit/SpriteSheet.png",weakness:"Light",resistance:"Dark",behavior:"phase",category:"common",effect:"fear",biome:"the_void",description:"A spectral wisp that phases through walls.",lootTable:[{id:"ectoplasm",chance:.5,min:1,max:2},{id:"soul_fragment",chance:.2,min:1,max:1},{id:"corruption_shard",chance:.15,min:1,max:1}]},skeleton_grunt:{id:"skeleton_grunt",name:"Skeleton Grunt",icon:"",health:55,damage:14,defense:4,aggroRange:120,speed:42,color:"#d4d4d8",glowColor:"#e4e4e7",width:48,height:48,xpReward:28,spriteType:"skeleton_grunt",frameSize:Je,tileSprite:"Sprites/Supplementary/0x72-dungeon-tileset-ii/0x72_DungeonTilesetII_v1.7/frames/skelet_idle_anim_f0.png",weakness:"Blunt",resistance:"Pierce",behavior:"chase",category:"common",biome:"bone_wastes",description:"A lumbering skeletal soldier.",lootTable:[{id:"bone",chance:.8,min:1,max:3},{id:"iron_ore",chance:.15,min:1,max:1},{id:"crystal",chance:.1,min:1,max:1}]},skeleton_hunter:{id:"skeleton_hunter",name:"Skeleton Hunter",icon:"",health:40,damage:18,defense:2,aggroRange:180,speed:38,color:"#d4d4d8",glowColor:"#a3a3a3",width:48,height:48,xpReward:32,spriteType:"skeleton_hunter",frameSize:Je,tileSprite:"Sprites/Supplementary/0x72-dungeon-tileset-ii/0x72_DungeonTilesetII_v1.7/frames/skelet_idle_anim_f0.png",weakness:"Blunt",resistance:"Pierce",behavior:"ranged",category:"dungeon",biome:"bone_wastes",description:"A skeletal archer that attacks from range.",abilities:["Ranged attacks","Keeps distance"],attackRange:180,projectileSpeed:150,lootTable:[{id:"bone",chance:.6,min:1,max:3},{id:"arrow",chance:.4,min:3,max:8}]},goblin_berserker:{id:"goblin_berserker",name:"Goblin Berserker",icon:"",health:70,damage:20,defense:3,aggroRange:140,speed:55,color:"#4ade80",glowColor:"#dc2626",width:48,height:48,xpReward:35,spriteType:"goblin_berserker",frameSize:Je,tileSprite:"Sprites/Supplementary/0x72-dungeon-tileset-ii/0x72_DungeonTilesetII_v1.7/frames/goblin_idle_anim_f0.png",weakness:"Fire",resistance:null,behavior:"chase",category:"common",biome:"rotwood",description:"A frenzied goblin warrior that charges headlong.",lootTable:[{id:"gold_coin",chance:.6,min:5,max:15},{id:"dagger",chance:.1,min:1,max:1}]},goblin_slinger:{id:"goblin_slinger",name:"Goblin Slinger",icon:"",health:35,damage:12,defense:1,aggroRange:160,speed:45,color:"#4ade80",glowColor:"#a3e635",width:48,height:48,xpReward:22,spriteType:"goblin_slinger",frameSize:Je,tileSprite:"Sprites/Supplementary/0x72-dungeon-tileset-ii/0x72_DungeonTilesetII_v1.7/frames/goblin_idle_anim_f0.png",weakness:"Fire",resistance:null,behavior:"ranged",category:"common",biome:"rotwood",description:"A goblin that hurls rocks from a safe distance.",attackRange:160,projectileSpeed:120,lootTable:[{id:"stone",chance:.5,min:2,max:5},{id:"gold_coin",chance:.4,min:3,max:8}]},cultist:{id:"cultist",name:"Cultist",icon:"",health:45,damage:16,defense:2,aggroRange:150,speed:32,color:"#6d28d9",glowColor:"#a855f7",width:48,height:48,xpReward:30,spriteType:"cultist",frameSize:Je,tileSprite:"Sprites/Supplementary/0x72-dungeon-tileset-ii/0x72_DungeonTilesetII_v1.7/frames/orc_shaman_idle_anim_f0.png",weakness:"Physical",resistance:"Magic",behavior:"support",category:"dungeon",biome:"the_void",description:"A dark magic-user that heals and buffs allies.",abilities:["Heals allies","Buffs nearby cultists"],lootTable:[{id:"magic_herb",chance:.3,min:1,max:2},{id:"gold_coin",chance:.8,min:10,max:25},{id:"corruption_shard",chance:.2,min:1,max:2}]},possessed:{id:"possessed",name:"Possessed",icon:"",health:50,damage:22,defense:1,aggroRange:130,speed:60,color:"#7c3aed",glowColor:"#c084fc",width:48,height:48,xpReward:34,spriteType:"possessed",frameSize:Je,tileSprite:"Sprites/Supplementary/0x72-dungeon-tileset-ii/0x72_DungeonTilesetII_v1.7/frames/imp_idle_anim_f0.png",weakness:"Holy",resistance:"Dark",behavior:"phase",category:"dungeon",effect:"fear",biome:"the_void",description:"A host body taken over by a malevolent spirit.",lootTable:[{id:"void_essence",chance:.4,min:1,max:2},{id:"ectoplasm",chance:.3,min:1,max:1}]},corpse_spider:{id:"corpse_spider",name:"Corpse Spider",icon:"",health:45,damage:12,defense:2,aggroRange:110,speed:55,color:"#1a1a1a",glowColor:"#333333",width:28,height:24,xpReward:32,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/SpiderRed/SpriteSheet.png",weakness:"Fire",resistance:null,behavior:"ambush",category:"common",effect:"poison",biome:"rotwood",description:"A giant spider that lurks in web-draped trees.",lootTable:[{id:"spider_silk",chance:.6,min:1,max:3},{id:"venom_gland",chance:.4,min:1,max:1}]},rotting_treant:{id:"rotting_treant",name:"Rotting Treant",icon:"",health:80,damage:18,defense:8,aggroRange:90,speed:18,color:"#2d2d1a",glowColor:"#556b2f",width:36,height:40,xpReward:60,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Bamboo/SpriteSheet.png",weakness:"Fire",resistance:"Physical",behavior:"guard",category:"dungeon",biome:"rotwood",description:"A once-majestic tree corrupted into a lumbering horror.",lootTable:[{id:"cursed_bark",chance:.5,min:1,max:2},{id:"dark_sap",chance:.3,min:1,max:1},{id:"rotted_wood",chance:.8,min:3,max:8}]},fire_imp:{id:"fire_imp",name:"Fire Imp",icon:"",health:35,damage:12,defense:1,aggroRange:120,speed:60,color:"#ff6347",glowColor:"#ff4500",width:22,height:24,xpReward:32,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Flam/SpriteSheet.png",weakness:"Ice",resistance:"Fire",behavior:"chase",category:"common",effect:"burn",biome:"ashlands",description:"A small fiery demon that dashes at the player.",lootTable:[{id:"ash",chance:.8,min:2,max:5},{id:"fire_crystal",chance:.2,min:1,max:1}]},magma_golem:{id:"magma_golem",name:"Magma Golem",icon:"",health:100,damage:20,defense:12,aggroRange:100,speed:18,color:"#ff4500",glowColor:"#ff6600",width:36,height:40,xpReward:65,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/TRex/SpriteSheet.png",weakness:"Ice",resistance:"Fire",behavior:"chase",category:"dungeon",effect:"burn",biome:"ashlands",description:"A lumbering golem of living magma.",lootTable:[{id:"magma_core",chance:.4,min:1,max:2},{id:"fire_ore",chance:.7,min:2,max:5},{id:"obsidian",chance:.5,min:1,max:3}]},flame_sprite:{id:"flame_sprite",name:"Flame Sprite",icon:"",health:28,damage:10,defense:0,aggroRange:160,speed:75,color:"#ffa500",glowColor:"#ffcc00",width:18,height:20,xpReward:25,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Flam2/SpriteSheet.png",weakness:"Ice",resistance:"Fire",behavior:"swoop",category:"common",effect:"burn",biome:"ashlands",description:"A living mote of fire that swoops erratically.",lootTable:[{id:"flame_core",chance:.1,min:1,max:1},{id:"ash",chance:.6,min:1,max:3}]},drowned_sailor:{id:"drowned_sailor",name:"Drowned Sailor",icon:"",health:48,damage:11,defense:2,aggroRange:100,speed:28,color:"#4a5d4a",glowColor:"#2d5016",width:24,height:32,xpReward:35,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/SkullBlue/SpriteSheet.png",weakness:"Fire",resistance:"Poison",behavior:"chase",category:"common",biome:"drowned_depths",description:"A waterlogged corpse animated by dark magic.",lootTable:[{id:"seaweed",chance:.6,min:1,max:3},{id:"rusty_coin",chance:.4,min:2,max:6}]},marsh_lurker:{id:"marsh_lurker",name:"Marsh Lurker",icon:"",health:55,damage:14,defense:5,aggroRange:110,speed:35,color:"#6b8e23",glowColor:"#556b2f",width:30,height:24,xpReward:38,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Reptile/Reptile.png",weakness:"Ice",resistance:"Poison",behavior:"ambush",category:"common",effect:"slow",biome:"drowned_depths",description:"Submerged predator that lunges from the murk.",lootTable:[{id:"lurker_scale",chance:.5,min:1,max:2},{id:"swamp_moss",chance:.7,min:2,max:5}]},poison_toad:{id:"poison_toad",name:"Giant Poison Toad",icon:"",health:40,damage:10,defense:3,aggroRange:90,speed:45,color:"#9acd32",glowColor:"#7cfc00",width:26,height:22,xpReward:30,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Animals/Frog/SpriteSheet.png",weakness:"Ice",resistance:"Poison",behavior:"wander",category:"common",effect:"poison",biome:"drowned_depths",description:"A bloated toad that spits toxic bile.",lootTable:[{id:"toxin_gland",chance:.5,min:1,max:2},{id:"venom_sac",chance:.3,min:1,max:1}]},zombie:{id:"zombie",name:"Zombie",icon:"",health:50,damage:10,defense:3,aggroRange:100,speed:25,color:"#808000",glowColor:"#556b2f",width:26,height:32,xpReward:25,tileSprite:"Sprites/Supplementary/0x72-dungeon-tileset-ii/0x72_DungeonTilesetII_v1.7/frames/big_zombie_idle_anim_f0.png",weakness:"Fire",resistance:"Poison",behavior:"chase",category:"common",biome:"bone_wastes",description:"A shambling undead driven by hunger.",lootTable:[{id:"grave_dust",chance:.7,min:1,max:3},{id:"bone",chance:.5,min:1,max:2}]},wraith:{id:"wraith",name:"Wraith",icon:"",health:45,damage:14,defense:1,aggroRange:140,speed:55,color:"#708090",glowColor:"#b0c4de",width:48,height:48,xpReward:55,spriteType:"possessed",frameSize:Je,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Spirit2/SpriteSheet.png",weakness:"Holy",resistance:"Physical",behavior:"phase",category:"dungeon",effect:"slow",biome:"bone_wastes",description:"A spectral entity that phases through walls.",lootTable:[{id:"ectoplasm",chance:.6,min:1,max:3},{id:"spirit_essence",chance:.3,min:1,max:1}]},bone_knight:{id:"bone_knight",name:"Bone Knight",icon:"",health:80,damage:18,defense:10,aggroRange:120,speed:35,color:"#d3d3d3",glowColor:"#c0c0c0",width:48,height:48,xpReward:60,spriteType:"skeleton_grunt",frameSize:Je,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Characters/Skeleton/SpriteSheet.png",weakness:"Blunt",resistance:"Pierce",behavior:"chase",category:"dungeon",biome:"bone_wastes",description:"An armored skeletal warrior wielding cursed weapons.",lootTable:[{id:"bone",chance:.8,min:2,max:5},{id:"cursed_bone",chance:.4,min:1,max:2},{id:"iron_sword",chance:.05,min:1,max:1}]},necromancer:{id:"necromancer",name:"Necromancer",icon:"",health:55,damage:12,defense:2,aggroRange:160,speed:30,color:"#4b0082",glowColor:"#9400d3",width:48,height:48,xpReward:70,spriteType:"cultist",frameSize:Je,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Characters/SorcererBlack/SpriteSheet.png",weakness:"Light",resistance:"Dark",behavior:"support",category:"elite",biome:"bone_wastes",description:"A dark mage that raises undead servants.",abilities:["Summons skeletons"],lootTable:[{id:"soul_fragment",chance:.5,min:1,max:2},{id:"cursed_relic",chance:.2,min:1,max:1}]},phantom:{id:"phantom",name:"Phantom",icon:"",health:35,damage:14,defense:0,aggroRange:150,speed:60,color:"#8b8bcd",glowColor:"#b0c4de",width:48,height:48,xpReward:45,spriteType:"possessed",frameSize:Je,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Eye/Eye.png",weakness:"Light",resistance:"Physical",behavior:"phase",category:"common",effect:"fear",biome:"the_void",nightOnly:!0,description:"A spectral shade that haunts the boundary between worlds.",lootTable:[{id:"void_essence",chance:.5,min:1,max:2},{id:"ectoplasm",chance:.3,min:1,max:1}]},void_crawler:{id:"void_crawler",name:"Void Crawler",icon:"",health:80,damage:20,defense:4,aggroRange:120,speed:45,color:"#0d0d0d",glowColor:"#1a1a2e",width:48,height:48,xpReward:95,spriteType:"cultist",frameSize:Je,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Cyclope2/SpriteSheet.png",weakness:"Light",resistance:"Dark",behavior:"chase",category:"elite",effect:"slow",biome:"the_void",nightOnly:!0,description:"An abomination from the deepest void.",lootTable:[{id:"void_essence",chance:.7,min:2,max:4},{id:"ancient_coin",chance:.3,min:1,max:3}]},ice_wolf:{id:"ice_wolf",name:"Frost Wolf",icon:"",health:55,damage:14,defense:3,aggroRange:150,speed:70,color:"#b0e0e6",glowColor:"#add8e6",width:28,height:24,xpReward:48,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Animals/Dog/SpriteSheet.png",weakness:"Fire",resistance:"Ice",behavior:"pack",category:"common",effect:"slow",biome:"drowned_depths",description:"A frost-coated wolf that hunts in packs.",lootTable:[{id:"fur",chance:.8,min:1,max:3},{id:"frozen_tear",chance:.3,min:1,max:1}]},ice_elemental:{id:"ice_elemental",name:"Ice Elemental",icon:"",health:60,damage:14,defense:4,aggroRange:150,speed:30,color:"#add8e6",glowColor:"#e0ffff",width:28,height:32,xpReward:50,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Mollusc2/Mollusc2.png",weakness:"Fire",resistance:"Ice",behavior:"ranged",category:"dungeon",effect:"freeze",biome:"drowned_depths",description:"A living shard of pure frost.",attackRange:150,projectileSpeed:120,lootTable:[{id:"ice_crystal",chance:.6,min:2,max:4},{id:"permafrost",chance:.3,min:1,max:2}]},alpha_wolf:{id:"alpha_wolf",name:"Alpha Wolf",icon:"",health:90,damage:20,defense:5,aggroRange:170,speed:80,color:"#1c1c1c",glowColor:"#333333",tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Animals/Lion/SpriteSheetRed.png",width:32,height:28,xpReward:80,weakness:"Fire",resistance:"Ice",behavior:"pack",category:"elite",isElite:!0,biome:"rotwood",description:"The leader of a wolf pack. Empowers nearby wolves.",lootTable:[{id:"fur",chance:1,min:3,max:6},{id:"fang",chance:.8,min:2,max:4}]},goblin_chief:{id:"goblin_chief",name:"Goblin Chief",icon:"",health:75,damage:16,defense:6,aggroRange:140,speed:50,color:"#8b0000",glowColor:"#dc143c",width:30,height:32,xpReward:75,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/KappaRed/SpriteSheet.png",weakness:"Fire",resistance:null,behavior:"ambush",category:"elite",isElite:!0,biome:"rotwood",description:"A cunning goblin leader who commands raiders.",lootTable:[{id:"gold_coin",chance:1,min:30,max:60},{id:"ruby_ring",chance:.1,min:1,max:1}]},skeleton_lord:{id:"skeleton_lord",name:"Skeleton Lord",icon:"",health:100,damage:20,defense:8,aggroRange:130,speed:42,color:"#c0c0c0",glowColor:"#d4d4d8",width:48,height:48,xpReward:90,spriteType:"skeleton_hunter",frameSize:Je,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Characters/SkeletonDemon/SpriteSheet.png",weakness:"Blunt",resistance:"Pierce",behavior:"chase",category:"elite",isElite:!0,biome:"bone_wastes",description:"An elite skeletal commander wreathed in dark flame.",lootTable:[{id:"bone",chance:1,min:5,max:10},{id:"cursed_bone",chance:.6,min:2,max:4},{id:"bone_crown",chance:.15,min:1,max:1}]},cave_bat:{id:"cave_bat",name:"Cave Bat",icon:"",health:18,damage:4,defense:0,aggroRange:100,speed:70,color:"#4a3a5a",glowColor:"#6a5a7a",width:20,height:18,xpReward:8,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/BlueBat/SpriteSheet.png",weakness:"Fire",resistance:null,behavior:"swoop",category:"common",biome:"haven",description:"A small bat that swoops from dark caves.",lootTable:[{id:"bat_wing",chance:.5,min:1,max:2}]},field_mouse:{id:"field_mouse",name:"Giant Field Mouse",icon:"",health:12,damage:3,defense:0,aggroRange:60,speed:65,color:"#8a7a6a",glowColor:"#aa9a8a",width:16,height:14,xpReward:5,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Mouse/SpriteSheet.png",weakness:null,resistance:null,behavior:"flee",category:"common",biome:"haven",description:"A large rodent that flees when spotted but bites if cornered.",lootTable:[{id:"fiber",chance:.4,min:1,max:2},{id:"herb",chance:.2,min:1,max:1}]},forest_bear:{id:"forest_bear",name:"Corrupted Bear",icon:"",health:120,damage:25,defense:8,aggroRange:130,speed:40,color:"#5a3a1a",glowColor:"#3a2a0a",width:36,height:34,xpReward:75,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Bear/SpriteSheet.png",weakness:"Fire",resistance:"Physical",behavior:"guard",category:"elite",isElite:!0,biome:"rotwood",description:"A massive bear corrupted by spore infection. Extremely aggressive when provoked.",abilities:["Maul attack","Ground slam stun"],lootTable:[{id:"fur",chance:1,min:3,max:6},{id:"monster_hide",chance:.7,min:2,max:4},{id:"bear_claw",chance:.4,min:1,max:2}]},spore_larva:{id:"spore_larva",name:"Spore Larva",icon:"",health:20,damage:6,defense:1,aggroRange:70,speed:20,color:"#6a8a3a",glowColor:"#4a6a2a",width:20,height:16,xpReward:12,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Larva/Larva.png",weakness:"Fire",resistance:"Poison",behavior:"wander",category:"common",effect:"poison",biome:"rotwood",description:"A bloated larva that bursts into a poison cloud on death.",lootTable:[{id:"slime_gel",chance:.4,min:1,max:2},{id:"spore_cap",chance:.3,min:1,max:1}]},venomous_snake:{id:"venomous_snake",name:"Venomous Snake",icon:"",health:30,damage:10,defense:1,aggroRange:80,speed:60,color:"#2a5a2a",glowColor:"#4a8a2a",width:24,height:16,xpReward:18,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Snake/Snake.png",weakness:"Ice",resistance:"Poison",behavior:"ambush",category:"common",effect:"poison",biome:"rotwood",description:"A swift serpent that strikes from concealment.",lootTable:[{id:"venom_gland",chance:.6,min:1,max:2},{id:"snake_scale",chance:.3,min:1,max:1}]},lava_serpent:{id:"lava_serpent",name:"Lava Serpent",icon:"",health:65,damage:18,defense:3,aggroRange:120,speed:50,color:"#cc3300",glowColor:"#ff5500",width:28,height:18,xpReward:45,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Snake3/Snake3.png",weakness:"Ice",resistance:"Fire",behavior:"ambush",category:"common",effect:"burn",biome:"ashlands",description:"A serpent born of molten rock, slithering through lava flows.",lootTable:[{id:"magma_core",chance:.3,min:1,max:1},{id:"ash_powder",chance:.7,min:2,max:4}]},ember_bat:{id:"ember_bat",name:"Ember Bat",icon:"",health:22,damage:8,defense:0,aggroRange:140,speed:80,color:"#ff6600",glowColor:"#ffaa00",width:20,height:18,xpReward:20,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/YellowsBat/SpriteSheet.png",weakness:"Ice",resistance:"Fire",behavior:"swoop",category:"common",effect:"burn",biome:"ashlands",description:"A bat wreathed in embers that dives from volcanic cliffs.",lootTable:[{id:"bat_wing",chance:.5,min:1,max:2},{id:"ash_powder",chance:.4,min:1,max:2}]},deep_octopus:{id:"deep_octopus",name:"Abyssal Octopus",icon:"",health:70,damage:16,defense:3,aggroRange:130,speed:35,color:"#2a3a5a",glowColor:"#3a5a8a",width:30,height:28,xpReward:50,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/GreenOctopus/SpriteSheet.png",weakness:"Lightning",resistance:"Ice",behavior:"ambush",category:"dungeon",effect:"slow",biome:"drowned_depths",description:"A tentacled horror from the sunken ruins.",abilities:["Ink cloud blinds nearby players"],lootTable:[{id:"ink_sac",chance:.6,min:1,max:2},{id:"tentacle",chance:.4,min:1,max:3}]},swamp_mole:{id:"swamp_mole",name:"Swamp Mole",icon:"",health:40,damage:8,defense:6,aggroRange:70,speed:25,color:"#4a3a2a",glowColor:"#6a5a3a",width:24,height:20,xpReward:22,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Mole/Mole.png",weakness:"Fire",resistance:null,behavior:"ambush",category:"common",biome:"drowned_depths",description:"A burrowing creature that ambushes from the mud.",lootTable:[{id:"mud_clod",chance:.6,min:1,max:3},{id:"iron_ore",chance:.2,min:1,max:1}]},skeletal_owl:{id:"skeletal_owl",name:"Skeletal Owl",icon:"",health:32,damage:12,defense:1,aggroRange:170,speed:65,color:"#aaaaaa",glowColor:"#cccccc",width:22,height:24,xpReward:35,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Owl/Owl.png",weakness:"Fire",resistance:"Dark",behavior:"swoop",category:"common",biome:"bone_wastes",nightOnly:!0,description:"An undead owl that hunts in the perpetual twilight of the wastes.",lootTable:[{id:"bone_fragment",chance:.5,min:1,max:2},{id:"ghost_feather",chance:.3,min:1,max:1}]},bone_lizard:{id:"bone_lizard",name:"Bone Lizard",icon:"",health:55,damage:14,defense:7,aggroRange:100,speed:45,color:"#baa882",glowColor:"#d4c8a0",width:28,height:20,xpReward:40,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Lizard/Lizard.png",weakness:"Ice",resistance:"Physical",behavior:"ambush",category:"common",biome:"bone_wastes",description:"A skeletal reptile that burrows through bone piles.",lootTable:[{id:"bone_fragment",chance:.7,min:2,max:4},{id:"dragon_scale",chance:.1,min:1,max:1}]},void_dragon:{id:"void_dragon",name:"Void Wyrm",icon:"",health:150,damage:30,defense:8,aggroRange:200,speed:50,color:"#2a0a4a",glowColor:"#5a1a8a",width:40,height:36,xpReward:180,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Dragon/SpriteSheet.png",weakness:"Light",resistance:"Dark",behavior:"chase",category:"elite",isElite:!0,biome:"the_void",description:"A draconic creature born from pure void energy. Extremely dangerous.",abilities:["Void breath attack","Dimensional dash"],lootTable:[{id:"void_shard",chance:.8,min:2,max:5},{id:"dragon_scale",chance:.5,min:1,max:3},{id:"void_gem",chance:.15,min:1,max:1}]},reality_warper:{id:"reality_warper",name:"Reality Warper",icon:"",health:60,damage:22,defense:2,aggroRange:160,speed:55,color:"#4a0080",glowColor:"#8800ff",width:48,height:48,xpReward:80,spriteType:"cultist",frameSize:Je,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/LanternRed/SpriteSheet.png",weakness:"Physical",resistance:"Magic",behavior:"phase",category:"dungeon",effect:"slow",biome:"the_void",description:"A floating entity that distorts space around it.",abilities:["Teleport","Gravity well"],lootTable:[{id:"void_essence",chance:.6,min:1,max:3},{id:"corruption_essence",chance:.4,min:1,max:2}]},void_panda:{id:"void_panda",name:"Corrupted Guardian",icon:"",health:95,damage:18,defense:12,aggroRange:100,speed:30,color:"#1a1a2e",glowColor:"#4a4a6e",width:32,height:32,xpReward:65,tileSprite:"Sprites/Supplementary/ninja-adventure/Ninja Adventure - Asset Pack/Actor/Monsters/Panda/SpriteSheet.png",weakness:"Light",resistance:"Dark",behavior:"guard",category:"dungeon",biome:"the_void",description:"Once a sacred guardian, now twisted by void corruption.",lootTable:[{id:"corruption_essence",chance:.7,min:2,max:4},{id:"ancient_relic",chance:.2,min:1,max:1}]}},Wl={idle:"Idle",run:"Run",attack:"Attack01",hurt:"Hurt",death:"Death"},Rg={idle:!0,run:!0,attack:!1,hurt:!1,death:!1};function xg(o,e){if(o===0&&e===0)return"Down";const t=Math.atan2(e,o);return t>-Math.PI/4&&t<=Math.PI/4?"Right":t>Math.PI/4&&t<=3*Math.PI/4?"Down":t>-3*Math.PI/4&&t<=-Math.PI/4?"Up":"Left"}class ei{eid;def;isCommander=!1;commanderDef=null;_aiTimer=0;_aiState="idle";_wanderDirX=0;_wanderDirY=0;_animTime=0;_hitFlash=0;_sprites=null;_spriteAnim="idle";_spriteDir="Down";_spriteFrame=0;_spriteFrameTimer=0;_spriteAnimDone=!1;_prevAnim="idle";_tileSpriteImg=null;_tileSpriteLoaded=!1;constructor(e,t,i,s,a){if(this.eid=Is(e),this.def=t,ce(e,j,this.eid),ce(e,U,this.eid),ce(e,Ge,this.eid),ce(e,x,this.eid),ce(e,Cs,this.eid),ce(e,lo,this.eid),ce(e,Ga,this.eid),ce(e,ye,this.eid),ce(e,xe,this.eid),ce(e,vt,this.eid),ce(e,Wi,this.eid),j.x[this.eid]=i,j.y[this.eid]=s,x.current[this.eid]=t.health,x.max[this.eid]=t.health,Cs.amount[this.eid]=t.damage,lo.range[this.eid]=t.aggroRange,Ge.dir[this.eid]=0,xe.value[this.eid]=1,vt.timer[this.eid]=0,vt.baseCooldown[this.eid]=t.attackSpeed??1,Wi.count[this.eid]=0,ye.width[this.eid]=t.frameSize??Je,ye.height[this.eid]=t.frameSize??Je,ye.totalFrames[this.eid]=6,a&&(this._sprites=a),t.tileSprite&&!t.spriteType){const r=new Image;r.src="/"+t.tileSprite,r.onload=()=>{this._tileSpriteLoaded=!0},this._tileSpriteImg=r}}get x(){return j.x[this.eid]}get y(){return j.y[this.eid]}get health(){return x.current[this.eid]}get maxHealth(){return x.max[this.eid]}get alive(){const t=(x.current[this.eid]??0)>0;return xe.value[this.eid]!==void 0&&(xe.value[this.eid]=t?1:0),t}get hitFlash(){return this._hitFlash}get isChasing(){return this._aiState==="chase"||this._aiState==="attack"}get hasSprite(){return!!this.def.spriteType&&!!this._sprites}get spriteDir(){return this._spriteDir}get hasTileSprite(){return this._tileSpriteLoaded&&!!this._tileSpriteImg}get tileSpriteImg(){return this._tileSpriteImg}updateAI(e,t,i,s){this._animTime+=e,this._hitFlash>0&&(this._hitFlash-=e);const a=t-this.x,r=i-this.y,n=Math.sqrt(a*a+r*r);this._aiTimer-=e;const l=this.def.behavior??"chase";switch(l){case"guard":n<this.def.aggroRange*.6?this._aiState="chase":this._aiState="idle";break;case"ambush":this._aiState==="chase"?n>this.def.aggroRange*1.5&&(this._aiState="idle"):n<this.def.aggroRange*.5?this._aiState="chase":this._aiState="idle";break;case"ranged":n<this.def.aggroRange?n<this.def.aggroRange*.35?this._aiState="attack":this._aiState="chase":this._aiTimer<=0&&(this._aiState=Math.random()<.4?"wander":"idle",this._aiTimer=2+Math.random()*3,this._wanderDirX=(Math.random()-.5)*2,this._wanderDirY=(Math.random()-.5)*2);break;case"swoop":n<this.def.aggroRange?this._aiState!=="attack"&&this._aiTimer<=0?(this._aiState="chase",this._aiTimer=.8+Math.random()*.4):this._aiState==="chase"&&this._aiTimer<=0?(this._aiState="attack",this._aiTimer=1.5+Math.random()*1):this._aiState==="attack"&&this._aiTimer<=0&&(this._aiState="idle",this._aiTimer=.5):(this._aiState="wander",this._aiTimer<=0&&(this._aiTimer=3+Math.random()*3,this._wanderDirX=(Math.random()-.5)*2,this._wanderDirY=(Math.random()-.5)*2));break;case"phase":if(n<this.def.aggroRange)if(this._aiTimer<=0){const c=Math.random()*Math.PI*2,d=40+Math.random()*60;j.x[this.eid]=t+Math.cos(c)*d,j.y[this.eid]=i+Math.sin(c)*d,this._aiState="chase",this._aiTimer=1.5+Math.random()*2}else this._aiState="chase";else this._aiTimer<=0&&(this._aiState=Math.random()<.3?"wander":"idle",this._aiTimer=2+Math.random()*4,this._wanderDirX=(Math.random()-.5)*2,this._wanderDirY=(Math.random()-.5)*2);break;case"flee":this.health<this.maxHealth*.3?this._aiState="attack":n<this.def.aggroRange?this._aiState="chase":this._aiTimer<=0&&(this._aiState=Math.random()<.4?"wander":"idle",this._aiTimer=2+Math.random()*3,this._wanderDirX=(Math.random()-.5)*2,this._wanderDirY=(Math.random()-.5)*2);break;case"support":if(n<this.def.aggroRange*.4)this._aiState="attack";else if(n<this.def.aggroRange){if(this._aiState="wander",this._aiTimer<=0)if(this._aiTimer=1+Math.random()*2,s&&s.length>0){const c=s[0],d=c.x-this.x,u=c.y-this.y,f=Math.sqrt(d*d+u*u)||1;this._wanderDirX=d/f,this._wanderDirY=u/f}else this._wanderDirX=(Math.random()-.5)*2,this._wanderDirY=(Math.random()-.5)*2}else this._aiTimer<=0&&(this._aiState=Math.random()<.4?"wander":"idle",this._aiTimer=2+Math.random()*3,this._wanderDirX=(Math.random()-.5)*2,this._wanderDirY=(Math.random()-.5)*2);break;case"pack":n<this.def.aggroRange?this._aiState="chase":this._aiTimer<=0&&(this._aiState=Math.random()<.4?"wander":"idle",this._aiTimer=2+Math.random()*3,this._wanderDirX=(Math.random()-.5)*2,this._wanderDirY=(Math.random()-.5)*2);break;default:n<this.def.aggroRange?this._aiState="chase":this._aiTimer<=0&&(this._aiState=Math.random()<.4?"wander":"idle",this._aiTimer=2+Math.random()*3,this._wanderDirX=(Math.random()-.5)*2,this._wanderDirY=(Math.random()-.5)*2);break}const h=l==="pack"&&s&&s.length>=2?1.3:1;switch(this._aiState){case"chase":{const c=a/(n||1),d=r/(n||1),u=this.def.speed*h;if(l==="ranged"){const f=Math.atan2(d,c)+Math.PI*.5;U.vx[this.eid]=Math.cos(f)*u*.6,U.vy[this.eid]=Math.sin(f)*u*.6}else l==="ambush"?(U.vx[this.eid]=c*u*1.8,U.vy[this.eid]=d*u*1.8):l==="swoop"?(U.vx[this.eid]=c*u*2,U.vy[this.eid]=d*u*2):(U.vx[this.eid]=c*u,U.vy[this.eid]=d*u);Math.abs(a)>Math.abs(r)?Ge.dir[this.eid]=a>0?2:3:Ge.dir[this.eid]=r>0?0:1;break}case"attack":{const c=a/(n||1),d=r/(n||1);U.vx[this.eid]=-c*this.def.speed*.8,U.vy[this.eid]=-d*this.def.speed*.8,Math.abs(a)>Math.abs(r)?Ge.dir[this.eid]=a>0?3:2:Ge.dir[this.eid]=r>0?1:0;break}case"wander":{U.vx[this.eid]=this._wanderDirX*this.def.speed*.3,U.vy[this.eid]=this._wanderDirY*this.def.speed*.3;break}default:{U.vx[this.eid]=0,U.vy[this.eid]=0;break}}this.hasSprite&&this._updateSpriteAnimation(e)}_updateSpriteAnimation(e){const t=U.vx[this.eid],i=U.vy[this.eid];(t!==0||i!==0)&&(this._spriteDir=xg(t,i));let s;this.alive?this._spriteAnim==="hurt"&&!this._spriteAnimDone?s="hurt":this._spriteAnim==="attack"&&!this._spriteAnimDone?s="attack":this._aiState==="chase"||this._aiState==="wander"?s="run":s="idle":s="death",s!==this._spriteAnim&&(this._prevAnim=this._spriteAnim,this._spriteAnim=s,this._spriteFrame=0,this._spriteFrameTimer=0,this._spriteAnimDone=!1);const a=Wl[this._spriteAnim],r=ml[a],n=this._spriteAnim==="attack"?.08:.12;this._spriteFrameTimer+=e,this._spriteFrameTimer>=n&&(this._spriteFrameTimer-=n,this._spriteFrame++,this._spriteFrame>=r&&(Rg[this._spriteAnim]?this._spriteFrame=0:(this._spriteFrame=r-1,this._spriteAnimDone=!0,(this._spriteAnim==="hurt"||this._spriteAnim==="attack")&&(this._spriteAnim="idle",this._spriteFrame=0,this._spriteFrameTimer=0,this._spriteAnimDone=!1))))}triggerAttack(){this.hasSprite&&(this._spriteAnim="attack",this._spriteFrame=0,this._spriteFrameTimer=0,this._spriteAnimDone=!1)}draw(e,t,i,s){const a=t.worldToScreen(this.x,this.y),r=a.sx-i+e.canvas.width/2,n=a.sy-s+e.canvas.height/2;if(r<-60||r>e.canvas.width+60||n<-60||n>e.canvas.height+60)return;e.save(),this._hitFlash>0&&(e.globalAlpha=.85);const l=this.def.isElite||this.def.category==="elite";if(l){const c=.15+Math.sin(this._animTime*3)*.08;e.fillStyle=`rgba(251,191,36,${c})`,e.beginPath(),e.arc(r,n-10,28,0,Math.PI*2),e.fill()}if(this._aiState==="chase"&&!l){const c=.06+Math.sin(this._animTime*5)*.04;e.fillStyle=`rgba(239,68,68,${c})`,e.beginPath(),e.arc(r,n-8,22,0,Math.PI*2),e.fill()}if(this.hasSprite?this._drawSprite(e,r,n):this.hasTileSprite?this._drawTileSprite(e,r,n):this._drawProcedural(e,r,n),this._hitFlash>0){const c=Math.min(1,this._hitFlash/.15);e.globalCompositeOperation="source-atop",e.fillStyle=`rgba(255,255,255,${(c*.85).toFixed(2)})`;const d=this.def.width*1.3,u=this.def.height*1.3;e.fillRect(r-d/2,n-u,d,u),e.globalCompositeOperation="source-over",e.globalAlpha=1}const h=n-(this.hasSprite?34:this.hasTileSprite?30:this.def.height*.8);if(this.health<this.maxHealth){const c=h;this._drawHealthBar(e,r,c),this._drawNameLabel(e,r,c-10,!0)}else this._aiState==="chase"?this._drawNameLabel(e,r,h-4,!0):this._drawNameLabel(e,r,h-4,!1);e.restore()}_drawSprite(e,t,i){const s=this._sprites,a=this.def.spriteType,r=this.def.frameSize??Je,n=Wl[this._spriteAnim],l=s.getEnemySpritePath(a,this._spriteDir,n),h=s.getSprite(l);if(!h||!h.naturalWidth){e.fillStyle=this.def.color,e.fillRect(t-r/4,i-r/2,r/2,r/2);return}e.fillStyle="rgba(0,0,0,0.25)",e.beginPath(),e.ellipse(t,i+2,r*.35,r*.1,0,0,Math.PI*2),e.fill();const c=ml[n],d=Math.min(this._spriteFrame,c-1),u=Math.round(r*1.6),f=t-u/2,m=i-u+6;s.drawFrame(e,h,d,c,r,r,f,m,u,u)}_drawTileSprite(e,t,i){const s=this._tileSpriteImg,a=s.naturalWidth,r=s.naturalHeight;let n=16,l=!1;for(const u of[16,32,48]){const f=Math.floor(a/u),m=Math.floor(r/u);if(f>=2&&m>=1&&a%u===0&&r%u===0){n=u,l=!0;break}}l||(n=Math.min(a,r));const h=n<=16?3.5:n<=32?2.4:1.6,c=Math.min(n*h,80),d=Math.min(n*h,80);if(e.fillStyle="rgba(0,0,0,0.2)",e.beginPath(),e.ellipse(t,i+2,c*.35,d*.08,0,0,Math.PI*2),e.fill(),l){const u=Math.floor(a/n),f=Math.floor(r/n);let m=0;if(f>=4){const b=U.vx[this.eid]??0,w=U.vy[this.eid]??0;Math.abs(w)>=Math.abs(b)?m=w<0?1:0:m=b<0?2:3}const _=Math.min(u,8),y=Math.floor(this._animTime*4)%Math.max(1,_)*n,S=m*n;e.drawImage(s,y,S,n,n,t-c/2,i-d+4,c,d)}else e.drawImage(s,t-c/2,i-d+4,c,d)}_drawProcedural(e,t,i){const a=this.def.width*1.8,r=this.def.height*1.8,n=this._animTime;switch(e.fillStyle="rgba(0,0,0,0.3)",e.beginPath(),e.ellipse(t,i+r*.3,a*.4,a*.12,0,0,Math.PI*2),e.fill(),this.def.id){case"slime":case"red_slime":this._drawSlime(e,t,i,a,r,n);break;case"wolf":case"alpha_wolf":case"ice_wolf":this._drawWolf(e,t,i,a,r,n);break;case"skeleton":this._drawSkeleton(e,t,i,a,r,n);break;case"mushroom_spirit":this._drawMushroom(e,t,i,a,r,n);break;case"shadow_wisp":this._drawWisp(e,t,i,a,r,n);break;case"corpse_spider":this._drawCorpseSpider(e,t,i,a,r,n);break;case"rotting_treant":this._drawRottingTreant(e,t,i,a,r,n);break;case"fire_imp":this._drawFireImp(e,t,i,a,r,n);break;case"magma_golem":this._drawMagmaGolem(e,t,i,a,r,n);break;case"flame_sprite":this._drawFlameSprite(e,t,i,a,r,n);break;case"marsh_lurker":this._drawMarshLurker(e,t,i,a,r,n);break;case"poison_toad":this._drawPoisonToad(e,t,i,a,r,n);break;case"zombie":this._drawZombie(e,t,i,a,r,n);break;case"wraith":case"phantom":this._drawWraith(e,t,i,a,r,n);break;case"bone_knight":case"skeleton_lord":case"bone_revenant":this._drawBoneRevenant(e,t,i,a,r,n);break;case"necromancer":this._drawNecromancer(e,t,i,a,r,n);break;case"void_crawler":case"void_stalker":this._drawVoidStalker(e,t,i,a,r,n);break;case"abyssal_horror":this._drawAbyssalHorror(e,t,i,a,r,n);break;case"ice_elemental":this._drawIceElemental(e,t,i,a,r,n);break;case"goblin_chief":this._drawGoblinChief(e,t,i,a,r,n);break;case"drowned_sailor":this._drawDrownedSailor(e,t,i,a,r,n);break;case"cave_bat":case"ember_bat":this._drawBat(e,t,i,a,r,n);break;case"field_mouse":this._drawFieldMouse(e,t,i,a,r,n);break;case"venomous_snake":case"lava_serpent":this._drawSnake(e,t,i,a,r,n);break;case"deep_octopus":this._drawOctopus(e,t,i,a,r,n);break;case"swamp_mole":this._drawMole(e,t,i,a,r,n);break;case"skeletal_owl":this._drawSkeletalOwl(e,t,i,a,r,n);break;case"bone_lizard":this._drawBoneLizard(e,t,i,a,r,n);break;case"void_dragon":this._drawVoidDragon(e,t,i,a,r,n);break;case"reality_warper":this._drawRealityWarper(e,t,i,a,r,n);break;case"void_panda":this._drawVoidPanda(e,t,i,a,r,n);break;case"spore_larva":this._drawSporeLarva(e,t,i,a,r,n);break;case"forest_bear":this._drawForestBear(e,t,i,a,r,n);break;default:this._drawGeneric(e,t,i,a,r);break}}_drawSlime(e,t,i,s,a,r){const n=1+Math.sin(r*4)*.1,l=Math.abs(Math.sin(r*4))*3;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-l-a*.2,s*.5*n,a*.4/n,0,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255,255,255,0.35)",e.beginPath(),e.ellipse(t-s*.12,i-l-a*.35,s*.12,a*.1,-.3,0,Math.PI*2),e.fill(),e.fillStyle="#111",e.beginPath(),e.arc(t-4,i-l-a*.25,2,0,Math.PI*2),e.arc(t+4,i-l-a*.25,2,0,Math.PI*2),e.fill()}_drawWolf(e,t,i,s,a,r){const n=Math.sin(r*6)*1.5;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.3+n,s*.55,a*.35,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(t+s*.3,i-a*.4+n,s*.25,a*.2,-.2,0,Math.PI*2),e.fill(),e.fillStyle="#5c534c",e.beginPath(),e.moveTo(t+s*.35,i-a*.55+n),e.lineTo(t+s*.45,i-a*.7+n),e.lineTo(t+s*.5,i-a*.5+n),e.fill(),e.fillStyle="#facc15",e.beginPath(),e.arc(t+s*.38,i-a*.4+n,2,0,Math.PI*2),e.fill(),e.fillStyle="#57534e";const l=Math.sin(r*8)*3,h=Math.sin(r*8+Math.PI)*3;e.fillRect(t-s*.3,i-a*.05,3,6+l),e.fillRect(t-s*.1,i-a*.05,3,6+h),e.fillRect(t+s*.1,i-a*.05,3,6+l),e.fillRect(t+s*.3,i-a*.05,3,6+h)}_drawSkeleton(e,t,i,s,a,r){const n=Math.sin(r*2)*2;e.strokeStyle=this.def.color,e.lineWidth=2,e.beginPath(),e.moveTo(t+n,i-a*.7),e.lineTo(t+n*.5,i-a*.2),e.stroke();for(let l=0;l<3;l++){const h=i-a*.6+l*6;e.beginPath(),e.moveTo(t-6+n,h),e.lineTo(t+6+n,h),e.stroke()}e.fillStyle=this.def.color,e.beginPath(),e.arc(t+n,i-a*.78,7,0,Math.PI*2),e.fill(),e.fillStyle="#ef4444",e.beginPath(),e.arc(t-3+n,i-a*.8,1.5,0,Math.PI*2),e.arc(t+3+n,i-a*.8,1.5,0,Math.PI*2),e.fill(),e.strokeStyle=this.def.color,e.lineWidth=1.5,e.beginPath(),e.moveTo(t-6+n,i-a*.55),e.lineTo(t-10+n+Math.sin(r*3)*3,i-a*.3),e.stroke(),e.beginPath(),e.moveTo(t+6+n,i-a*.55),e.lineTo(t+10+n+Math.sin(r*3+1)*3,i-a*.3),e.stroke(),e.beginPath(),e.moveTo(t+n*.5,i-a*.2),e.lineTo(t-5,i+a*.1),e.stroke(),e.beginPath(),e.moveTo(t+n*.5,i-a*.2),e.lineTo(t+5,i+a*.1),e.stroke()}_drawMushroom(e,t,i,s,a,r){const n=Math.sin(r*3)*2;e.fillStyle="#e5d5c0",e.fillRect(t-3,i-a*.35,6,a*.35),e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.45+n,s*.5,a*.3,0,Math.PI,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(t,i-a*.45+n,s*.5,a*.12,0,0,Math.PI),e.fill(),e.fillStyle="rgba(255,255,255,0.5)",e.beginPath(),e.arc(t-4,i-a*.55+n,2,0,Math.PI*2),e.arc(t+5,i-a*.6+n,1.5,0,Math.PI*2),e.fill(),e.fillStyle=`rgba(168,85,247,${.3+Math.sin(r*5)*.2})`;for(let l=0;l<3;l++){const h=t+Math.sin(r*2+l*2)*12,c=i-a*.5+n-Math.abs(Math.sin(r*1.5+l))*15;e.beginPath(),e.arc(h,c,1.5,0,Math.PI*2),e.fill()}e.fillStyle="#fbbf24",e.beginPath(),e.arc(t-3,i-a*.28,2,0,Math.PI*2),e.arc(t+3,i-a*.28,2,0,Math.PI*2),e.fill()}_drawWisp(e,t,i,s,a,r){const n=Math.sin(r*2)*5,l=.7+Math.sin(r*4)*.3,h=e.createRadialGradient(t,i-a*.3+n,0,t,i-a*.3+n,s);h.addColorStop(0,`rgba(99,102,241,${l*.3})`),h.addColorStop(1,"transparent"),e.fillStyle=h,e.fillRect(t-s,i-a+n,s*2,a*1.5),e.fillStyle=this.def.glowColor,e.globalAlpha=l,e.beginPath(),e.arc(t,i-a*.3+n,s*.3,0,Math.PI*2),e.fill(),e.fillStyle="#e0e7ff",e.beginPath(),e.arc(t,i-a*.3+n,s*.15,0,Math.PI*2),e.fill(),e.globalAlpha=1;for(let c=0;c<4;c++){const d=t+Math.sin(r*3+c*1.5)*8,u=i-a*.3+n+c*4+5;e.fillStyle=`rgba(99,102,241,${.4-c*.08})`,e.beginPath(),e.arc(d,u,2-c*.3,0,Math.PI*2),e.fill()}}_drawCorpseSpider(e,t,i,s,a,r){const n=Math.sin(r*5)*1.5,l=Math.sin(r*6)*.15;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t-s*.15,i-a*.25+n,s*.35,a*.35,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(t+s*.15,i-a*.35+n,s*.25,a*.2,0,0,Math.PI*2),e.fill(),e.strokeStyle=this.def.glowColor,e.lineWidth=1.5;for(let h=-1;h<=1;h+=2)for(let c=0;c<4;c++){const d=t+(c-1.5)*s*.12+h*s*.08,u=i-a*.3+n,f=h*(.3+c*.2+l),m=d+Math.cos(f)*s*.35*h,_=u+Math.sin(f)*s*.35;e.beginPath(),e.moveTo(d,u),e.lineTo(m,_),e.stroke()}e.fillStyle="#ef4444";for(let h=0;h<2;h++)for(let c=-1;c<=1;c++)e.beginPath(),e.arc(t+s*.2+c*4,i-a*.38+n-h*3,1.5,0,Math.PI*2),e.fill()}_drawRottingTreant(e,t,i,s,a,r){const n=Math.sin(r*1.5)*3,l=Math.sin(r*2+1)*2;e.fillStyle=this.def.color,e.beginPath(),e.moveTo(t-s*.25+n,i),e.lineTo(t-s*.2,i-a*.5),e.lineTo(t,i-a*.7),e.lineTo(t+s*.2,i-a*.5),e.lineTo(t+s*.25-n,i),e.closePath(),e.fill(),e.strokeStyle="rgba(0,0,0,0.4)",e.lineWidth=1,e.beginPath(),e.moveTo(t-2,i-a*.3),e.lineTo(t+3,i-a*.5),e.moveTo(t+4,i-a*.25),e.lineTo(t-1,i-a*.1),e.stroke(),e.strokeStyle=this.def.glowColor,e.lineWidth=4,e.beginPath(),e.moveTo(t-s*.15,i-a*.55),e.lineTo(t-s*.4+l,i-a*.4),e.stroke(),e.beginPath(),e.moveTo(t+s*.15,i-a*.55),e.lineTo(t+s*.4-l,i-a*.4),e.stroke(),e.fillStyle="#1a1a1a",e.beginPath(),e.ellipse(t-5,i-a*.65,4,5,0,0,Math.PI*2),e.ellipse(t+5,i-a*.65,4,5,0,0,Math.PI*2),e.fill(),e.fillStyle="#ef4444",e.beginPath(),e.arc(t-5,i-a*.65,1.5,0,Math.PI*2),e.arc(t+5,i-a*.65,1.5,0,Math.PI*2),e.fill(),e.strokeStyle="#2d2d1a",e.lineWidth=2,e.beginPath(),e.arc(t,i-a*.55,6,.2*Math.PI,.8*Math.PI),e.stroke()}_drawFireImp(e,t,i,s,a,r){const n=Math.sin(r*6)*2,l=Math.sin(r*12)*.1;e.fillStyle=`rgba(255,100,0,${.4+l})`,e.beginPath(),e.moveTo(t-s*.4,i-a*.2+n),e.quadraticCurveTo(t-s*.6,i-a*.5,t-s*.25,i-a*.1),e.fill(),e.beginPath(),e.moveTo(t+s*.4,i-a*.2+n),e.quadraticCurveTo(t+s*.6,i-a*.5,t+s*.25,i-a*.1),e.fill();const h=e.createRadialGradient(t,i-a*.2,0,t,i-a*.2,s*.5);h.addColorStop(0,this.def.glowColor),h.addColorStop(1,this.def.color),e.fillStyle=h,e.beginPath(),e.ellipse(t,i-a*.25+n,s*.35,a*.35,0,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t,i-a*.5+n,s*.2,0,Math.PI*2),e.fill(),e.strokeStyle=this.def.color,e.lineWidth=2,e.beginPath(),e.moveTo(t-s*.15,i-a*.55+n),e.lineTo(t-s*.25,i-a*.75+n),e.stroke(),e.beginPath(),e.moveTo(t+s*.15,i-a*.55+n),e.lineTo(t+s*.25,i-a*.75+n),e.stroke(),e.fillStyle="#fff",e.beginPath(),e.arc(t-4,i-a*.52+n,2,0,Math.PI*2),e.arc(t+4,i-a*.52+n,2,0,Math.PI*2),e.fill(),e.fillStyle="#ff4500",e.beginPath(),e.arc(t-4,i-a*.52+n,1,0,Math.PI*2),e.arc(t+4,i-a*.52+n,1,0,Math.PI*2),e.fill(),e.strokeStyle=this.def.glowColor,e.lineWidth=2,e.beginPath(),e.moveTo(t+s*.2,i-a*.1+n),e.lineTo(t+s*.4,i+a*.1),e.stroke()}_drawMagmaGolem(e,t,i,s,a,r){const n=.7+Math.sin(r*3)*.3,l=Math.sin(r*4)*.2;e.fillStyle="#2d2d2d",e.beginPath(),e.moveTo(t-s*.35,i),e.lineTo(t-s*.3,i-a*.4),e.lineTo(t,i-a*.7),e.lineTo(t+s*.3,i-a*.4),e.lineTo(t+s*.35,i),e.closePath(),e.fill(),e.strokeStyle=`rgba(255,100,0,${.4+l})`,e.lineWidth=2,e.beginPath(),e.moveTo(t-s*.15,i-a*.2),e.lineTo(t-s*.1,i-a*.5),e.lineTo(t,i-a*.6),e.stroke(),e.beginPath(),e.moveTo(t+s*.1,i-a*.35),e.lineTo(t+s*.05,i-a*.1),e.stroke();const h=e.createRadialGradient(t,i-a*.2,0,t,i-a*.2,s*.3);h.addColorStop(0,`rgba(255,200,100,${n})`),h.addColorStop(.5,this.def.glowColor),h.addColorStop(1,this.def.color),e.fillStyle=h,e.beginPath(),e.arc(t,i-a*.3,s*.2,0,Math.PI*2),e.fill(),e.fillStyle="#1a1a1a",e.fillRect(t-s*.2,i-a*.75,s*.4,a*.15),e.fillStyle=`rgba(255,100,0,${.6+l})`,e.beginPath(),e.arc(t-6,i-a*.68,.5,0,Math.PI*2),e.arc(t+6,i-a*.68,.5,0,Math.PI*2),e.fill()}_drawFlameSprite(e,t,i,s,a,r){const n=Math.sin(r*4)*4,l=.8+Math.sin(r*15)*.2,h=e.createRadialGradient(t,i-a*.3+n,0,t,i-a*.3+n,s);h.addColorStop(0,`rgba(255,255,200,${l})`),h.addColorStop(.4,this.def.glowColor),h.addColorStop(1,"transparent"),e.fillStyle=h,e.beginPath(),e.arc(t,i-a*.3+n,s*.5,0,Math.PI*2),e.fill(),e.fillStyle=this.def.color,e.globalAlpha=l,e.beginPath(),e.arc(t,i-a*.3+n,s*.25,0,Math.PI*2),e.fill(),e.globalAlpha=1}_drawMarshLurker(e,t,i,s,a,r){const n=Math.sin(r*6)*1.5;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.25+n,s*.5,a*.3,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(t+s*.35,i-a*.2+n,s*.2,a*.12,0,0,Math.PI*2),e.fill(),e.strokeStyle=this.def.glowColor,e.lineWidth=1;for(let l=0;l<4;l++){const h=t-s*.3+l*s*.2;e.beginPath(),e.moveTo(h,i-a*.35+n),e.lineTo(h+5,i-a*.1+n),e.stroke()}e.fillStyle="#facc15",e.beginPath(),e.arc(t+s*.25,i-a*.3+n,3,0,Math.PI*2),e.fill(),e.fillStyle="#111",e.beginPath(),e.arc(t+s*.26,i-a*.31+n,1.5,0,Math.PI*2),e.fill(),e.fillStyle=this.def.glowColor,e.fillRect(t-s*.3,i-a*.05,4,6),e.fillRect(t-s*.1,i-a*.05,4,6),e.fillRect(t+s*.1,i-a*.05,4,6),e.fillRect(t+s*.3,i-a*.05,4,6)}_drawPoisonToad(e,t,i,s,a,r){const n=1+Math.sin(r*4)*.08,l=Math.sin(r*5)*1;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.25+l,s*.45*n,a*.35/n,0,0,Math.PI*2),e.fill(),e.fillStyle=this.def.glowColor,e.beginPath(),e.arc(t-6,i-a*.2,2.5,0,Math.PI*2),e.arc(t+7,i-a*.25,2,0,Math.PI*2),e.arc(t+2,i-a*.3,2,0,Math.PI*2),e.fill(),e.fillStyle="#1a1a1a",e.beginPath(),e.ellipse(t-6,i-a*.35+l,4,5,0,0,Math.PI*2),e.ellipse(t+6,i-a*.35+l,4,5,0,0,Math.PI*2),e.fill(),e.fillStyle="#7cfc00",e.beginPath(),e.arc(t-6,i-a*.35+l,1.5,0,Math.PI*2),e.arc(t+6,i-a*.35+l,1.5,0,Math.PI*2),e.fill(),e.fillStyle=this.def.glowColor,e.fillRect(t-s*.35,i-a*.05,5,8),e.fillRect(t+s*.25,i-a*.05,5,8)}_drawZombie(e,t,i,s,a,r){const n=Math.sin(r*2)*2;e.fillStyle=this.def.color,e.beginPath(),e.moveTo(t-s*.2+n,i-a*.1),e.lineTo(t-s*.15,i-a*.5),e.lineTo(t,i-a*.65),e.lineTo(t+s*.15,i-a*.5),e.lineTo(t+s*.2-n,i-a*.1),e.closePath(),e.fill(),e.beginPath(),e.ellipse(t+n*.5,i-a*.75,s*.2,a*.15,.1,0,Math.PI*2),e.fill(),e.fillStyle="#1a1a1a",e.beginPath(),e.arc(t-4+n,i-a*.76,.5,0,Math.PI*2),e.arc(t+6+n,i-a*.76,.5,0,Math.PI*2),e.fill(),e.strokeStyle=this.def.glowColor,e.lineWidth=3,e.beginPath(),e.moveTo(t-s*.2,i-a*.45),e.lineTo(t-s*.45,i-a*.2),e.stroke(),e.beginPath(),e.moveTo(t+s*.2,i-a*.45),e.lineTo(t+s*.45,i-a*.2),e.stroke(),e.beginPath(),e.moveTo(t-5,i-a*.1),e.lineTo(t-8,i+a*.1),e.stroke(),e.beginPath(),e.moveTo(t+5,i-a*.1),e.lineTo(t+8,i+a*.1),e.stroke()}_drawWraith(e,t,i,s,a,r){const n=Math.sin(r*2)*6,l=.5+Math.sin(r*3)*.2;e.fillStyle=`rgba(112,128,144,${l*.6})`,e.beginPath(),e.moveTo(t,i-a*.6+n),e.lineTo(t-s*.3,i-a*.4),e.lineTo(t-s*.2,i+a*.1),e.lineTo(t,i+a*.2),e.lineTo(t+s*.2,i+a*.1),e.lineTo(t+s*.3,i-a*.4),e.closePath(),e.fill(),e.fillStyle=this.def.glowColor,e.globalAlpha=l,e.beginPath(),e.arc(t-4,i-a*.5+n,2,0,Math.PI*2),e.arc(t+4,i-a*.5+n,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}_drawBoneRevenant(e,t,i,s,a,r){const n=Math.sin(r*2)*2;e.fillStyle="#4a4a4a",e.beginPath(),e.moveTo(t-s*.25,i-a*.15),e.lineTo(t-s*.2,i-a*.5),e.lineTo(t,i-a*.65),e.lineTo(t+s*.2,i-a*.5),e.lineTo(t+s*.25,i-a*.15),e.closePath(),e.fill(),e.strokeStyle="#2d2d2d",e.lineWidth=1,e.stroke(),e.strokeStyle=this.def.color,e.lineWidth=1.5;for(let l=0;l<3;l++){const h=i-a*.55+l*6+n*.3;e.beginPath(),e.moveTo(t-8,h),e.lineTo(t+8,h),e.stroke()}e.fillStyle=this.def.color,e.beginPath(),e.arc(t+n,i-a*.78,8,0,Math.PI*2),e.fill(),e.fillStyle="#1a1a1a",e.fillRect(t-6+n,i-a*.82,12,5),e.fillStyle="#ef4444",e.beginPath(),e.arc(t-3+n,i-a*.8,1.5,0,Math.PI*2),e.arc(t+3+n,i-a*.8,1.5,0,Math.PI*2),e.fill(),e.fillStyle="#5a5a5a",e.beginPath(),e.arc(t-s*.35,i-a*.5,6,0,Math.PI*2),e.arc(t+s*.35,i-a*.5,6,0,Math.PI*2),e.fill(),e.strokeStyle=this.def.color,e.lineWidth=2,e.beginPath(),e.moveTo(t-s*.2,i-a*.45),e.lineTo(t-s*.4+Math.sin(r*3)*4,i-a*.2),e.stroke(),e.beginPath(),e.moveTo(t+s*.2,i-a*.45),e.lineTo(t+s*.4+Math.sin(r*3+1)*4,i-a*.2),e.stroke(),e.beginPath(),e.moveTo(t-5,i-a*.1),e.lineTo(t-8,i+a*.15),e.stroke(),e.beginPath(),e.moveTo(t+5,i-a*.1),e.lineTo(t+8,i+a*.15),e.stroke()}_drawNecromancer(e,t,i,s,a,r){const n=Math.sin(r*2)*2,l=.6+Math.sin(r*4)*.2;e.fillStyle=this.def.color,e.beginPath(),e.moveTo(t-s*.25,i),e.lineTo(t-s*.2,i-a*.5),e.lineTo(t,i-a*.7+n),e.lineTo(t+s*.2,i-a*.5),e.lineTo(t+s*.25,i),e.closePath(),e.fill(),e.fillStyle="#3d0066",e.beginPath(),e.ellipse(t,i-a*.75+n,s*.25,a*.2,0,0,Math.PI*2),e.fill(),e.fillStyle=`rgba(148,0,211,${l})`,e.beginPath(),e.arc(t-4,i-a*.75+n,2,0,Math.PI*2),e.arc(t+4,i-a*.75+n,2,0,Math.PI*2),e.fill(),e.strokeStyle="#2d1b4e",e.lineWidth=2,e.beginPath(),e.moveTo(t+s*.3,i-a*.4),e.lineTo(t+s*.45,i+a*.1),e.stroke(),e.fillStyle=this.def.glowColor,e.beginPath(),e.arc(t+s*.45,i+a*.05,4,0,Math.PI*2),e.fill()}_drawVoidStalker(e,t,i,s,a,r){const n=Math.sin(r*3)*.15,l=.6+Math.sin(r*2)*.2;e.fillStyle=`rgba(13,13,13,${l})`,e.beginPath(),e.moveTo(t,i-a*.7),e.lineTo(t-s*.25,i-a*.4),e.lineTo(t-s*.2,i+a*.1),e.lineTo(t,i+a*.2),e.lineTo(t+s*.2,i+a*.1),e.lineTo(t+s*.25,i-a*.4),e.closePath(),e.fill(),e.strokeStyle=`rgba(26,26,46,${.8-n})`,e.lineWidth=1,e.stroke(),e.fillStyle=this.def.glowColor,e.globalAlpha=.8+Math.sin(r*5)*.2,e.beginPath(),e.ellipse(t-5,i-a*.55,3,1.5,0,0,Math.PI*2),e.ellipse(t+5,i-a*.55,3,1.5,0,0,Math.PI*2),e.fill(),e.globalAlpha=1;for(let h=0;h<3;h++){const c=t+Math.sin(r*4+h*2)*12,d=i-a*.3+h*6;e.fillStyle=`rgba(26,26,46,${.3-h*.08})`,e.beginPath(),e.arc(c,d,1.5,0,Math.PI*2),e.fill()}}_drawAbyssalHorror(e,t,i,s,a,r){const n=Math.sin(r*4)*.2,l=.7+Math.sin(r*3)*.2;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.2,s*.5,a*.4,0,0,Math.PI*2),e.fill(),e.strokeStyle=this.def.glowColor,e.lineWidth=3;const h=8;for(let d=0;d<h;d++){const u=d/h*Math.PI*1.5-Math.PI*.5+n,f=t+Math.cos(u)*s*.2,m=i-a*.15,_=Math.sin(r*5+d)*8,p=f+Math.cos(u)*s*.5+_,g=m+Math.sin(u)*s*.4+15;e.beginPath(),e.moveTo(f,m),e.quadraticCurveTo(f+_*.5,m+10,p,g),e.stroke()}e.fillStyle="#ef4444";const c=[[-6,-12],[6,-12],[-4,-8],[4,-8],[0,-6]];for(let d=0;d<5;d++){const[u,f]=c[d];e.globalAlpha=l,e.beginPath(),e.arc(t+u,i-a*.2+f,2,0,Math.PI*2),e.fill()}e.globalAlpha=1,e.fillStyle="#1a1a1a",e.beginPath(),e.ellipse(t,i-a*.1,8,4,0,0,Math.PI*2),e.fill()}_drawIceElemental(e,t,i,s,a,r){const n=Math.sin(r*2)*3,l=.8+Math.sin(r*5)*.2;e.fillStyle=`rgba(173,216,230,${l})`,e.beginPath(),e.moveTo(t,i-a*.7+n),e.lineTo(t-s*.25,i-a*.2),e.lineTo(t-s*.1,i+a*.1),e.lineTo(t,i+a*.15),e.lineTo(t+s*.1,i+a*.1),e.lineTo(t+s*.25,i-a*.2),e.closePath(),e.fill(),e.strokeStyle=this.def.glowColor,e.lineWidth=1,e.stroke(),e.fillStyle="#e0ffff",e.beginPath(),e.arc(t,i-a*.3+n,5,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255,255,255,0.6)";for(let h=0;h<4;h++){const c=t+Math.sin(r*3+h)*10,d=i-a*.4+n+Math.cos(r*2+h)*8;e.beginPath(),e.arc(c,d,1.5,0,Math.PI*2),e.fill()}}_drawGoblinChief(e,t,i,s,a,r){const n=Math.sin(r*5)*1.5;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.3+n,s*.4,a*.35,0,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t,i-a*.55+n,s*.22,0,Math.PI*2),e.fill(),e.fillStyle=this.def.glowColor,e.fillRect(t-s*.15,i-a*.7+n,s*.3,4),e.fillStyle="#facc15",e.beginPath(),e.arc(t-5,i-a*.56+n,2.5,0,Math.PI*2),e.arc(t+5,i-a*.56+n,2.5,0,Math.PI*2),e.fill(),e.strokeStyle="#5c4033",e.lineWidth=3,e.beginPath(),e.moveTo(t+s*.25,i-a*.35),e.lineTo(t+s*.5,i+a*.1),e.stroke()}_drawDrownedSailor(e,t,i,s,a,r){const n=Math.sin(r*2)*2,l=Math.sin(r*3)*.3;e.fillStyle=this.def.color,e.beginPath(),e.moveTo(t-s*.2+n,i-a*.1),e.lineTo(t-s*.15,i-a*.5),e.lineTo(t,i-a*.65),e.lineTo(t+s*.15,i-a*.5),e.lineTo(t+s*.2-n,i-a*.1),e.closePath(),e.fill(),e.strokeStyle="#2d5016",e.lineWidth=2;for(let h=0;h<4;h++){const c=t-8+h*6+Math.sin(l+h)*3;e.beginPath(),e.moveTo(c,i-a*.4),e.quadraticCurveTo(c+5,i,c+8,i+a*.2),e.stroke()}e.fillStyle="#8b7355",e.beginPath(),e.arc(t+n*.5,i-a*.78,8,0,Math.PI*2),e.fill(),e.fillStyle="#1a1a1a",e.beginPath(),e.arc(t-4+n,i-a*.8,1.5,0,Math.PI*2),e.arc(t+4+n,i-a*.8,1.5,0,Math.PI*2),e.fill(),e.strokeStyle="#6b5b4f",e.lineWidth=2,e.beginPath(),e.moveTo(t-s*.2,i-a*.45),e.lineTo(t-s*.35,i-a*.1),e.stroke(),e.beginPath(),e.moveTo(t+s*.2,i-a*.45),e.lineTo(t+s*.35,i-a*.1),e.stroke()}_drawBat(e,t,i,s,a,r){const n=Math.sin(r*12)*.7,l=Math.sin(r*6)*3;e.fillStyle=this.def.color,e.save(),e.translate(t,i-a*.4+l),e.save(),e.rotate(-n),e.beginPath(),e.moveTo(0,0),e.quadraticCurveTo(-s*.6,-a*.3,-s*.7,a*.1),e.lineTo(0,a*.1),e.fill(),e.restore(),e.save(),e.rotate(n),e.beginPath(),e.moveTo(0,0),e.quadraticCurveTo(s*.6,-a*.3,s*.7,a*.1),e.lineTo(0,a*.1),e.fill(),e.restore(),e.beginPath(),e.ellipse(0,0,s*.2,a*.25,0,0,Math.PI*2),e.fill(),e.fillStyle=this.def.glowColor,e.beginPath(),e.arc(-3,-3,1.5,0,Math.PI*2),e.arc(3,-3,1.5,0,Math.PI*2),e.fill(),e.restore()}_drawFieldMouse(e,t,i,s,a,r){const n=Math.sin(r*8)*1;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.2+n,s*.4,a*.25,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(t+s*.25,i-a*.3+n,s*.18,a*.15,-.2,0,Math.PI*2),e.fill(),e.fillStyle="#bb9977",e.beginPath(),e.arc(t+s*.3,i-a*.42+n,3,0,Math.PI*2),e.arc(t+s*.2,i-a*.42+n,3,0,Math.PI*2),e.fill(),e.strokeStyle=this.def.color,e.lineWidth=1.5,e.beginPath(),e.moveTo(t-s*.3,i-a*.15+n),e.quadraticCurveTo(t-s*.5,i-a*.4+n,t-s*.6,i-a*.2+n),e.stroke(),e.fillStyle="#111",e.beginPath(),e.arc(t+s*.32,i-a*.32+n,1.5,0,Math.PI*2),e.fill()}_drawSnake(e,t,i,s,a,r){const n=Math.sin(r*5)*4;e.strokeStyle=this.def.color,e.lineWidth=a*.4,e.lineCap="round",e.beginPath(),e.moveTo(t-s*.5,i-a*.1),e.quadraticCurveTo(t-s*.15,i-a*.3+n,t+s*.1,i-a*.1-n*.5),e.quadraticCurveTo(t+s*.35,i+a*.1+n*.5,t+s*.5,i-a*.15),e.stroke(),e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t+s*.5,i-a*.15,s*.12,a*.2,0,0,Math.PI*2),e.fill(),e.fillStyle=this.def.glowColor,e.beginPath(),e.arc(t+s*.53,i-a*.22,1.5,0,Math.PI*2),e.fill(),e.strokeStyle="#cc0000",e.lineWidth=1,(Math.sin(r*10)>0||!1)&&(e.beginPath(),e.moveTo(t+s*.6,i-a*.15),e.lineTo(t+s*.7,i-a*.2),e.moveTo(t+s*.65,i-a*.17),e.lineTo(t+s*.7,i-a*.1),e.stroke())}_drawOctopus(e,t,i,s,a,r){const n=1+Math.sin(r*3)*.08;e.strokeStyle=this.def.color,e.lineWidth=2.5,e.lineCap="round";for(let l=0;l<6;l++){const h=l/6*Math.PI+Math.PI*.15,c=s*.6,d=Math.sin(r*4+l*1.2)*5;e.beginPath(),e.moveTo(t+Math.cos(h)*s*.15,i+Math.sin(h)*a*.1),e.quadraticCurveTo(t+Math.cos(h)*c*.5+d,i+Math.sin(h)*c*.5+a*.1,t+Math.cos(h)*c,i+Math.sin(h)*c*.3+a*.15),e.stroke()}e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.25,s*.35*n,a*.4*n,0,0,Math.PI*2),e.fill(),e.fillStyle=this.def.glowColor,e.beginPath(),e.arc(t-5,i-a*.3,3,0,Math.PI*2),e.arc(t+5,i-a*.3,3,0,Math.PI*2),e.fill(),e.fillStyle="#111",e.beginPath(),e.arc(t-5,i-a*.3,1.5,0,Math.PI*2),e.arc(t+5,i-a*.3,1.5,0,Math.PI*2),e.fill()}_drawMole(e,t,i,s,a,r){const n=Math.sin(r*5)*2;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.25+n,s*.45,a*.35,0,0,Math.PI*2),e.fill(),e.fillStyle="#cc8888",e.beginPath(),e.ellipse(t,i-a*.15+n,s*.15,a*.12,0,0,Math.PI*2),e.fill(),e.fillStyle="#8a6a4a",e.beginPath(),e.ellipse(t-s*.35,i-a*.1+n,s*.12,a*.08,-.3,0,Math.PI*2),e.ellipse(t+s*.35,i-a*.1+n,s*.12,a*.08,.3,0,Math.PI*2),e.fill(),e.fillStyle="#111",e.beginPath(),e.arc(t-4,i-a*.32+n,1,0,Math.PI*2),e.arc(t+4,i-a*.32+n,1,0,Math.PI*2),e.fill()}_drawSkeletalOwl(e,t,i,s,a,r){const n=Math.sin(r*4)*2,l=Math.sin(r*6)*.4;e.fillStyle=this.def.color,e.save(),e.translate(t,i-a*.35+n),e.save(),e.rotate(-l-.3),e.beginPath(),e.ellipse(-s*.3,0,s*.3,a*.15,0,0,Math.PI*2),e.fill(),e.restore(),e.save(),e.rotate(l+.3),e.beginPath(),e.ellipse(s*.3,0,s*.3,a*.15,0,0,Math.PI*2),e.fill(),e.restore(),e.beginPath(),e.ellipse(0,0,s*.25,a*.3,0,0,Math.PI*2),e.fill(),e.fillStyle="#111",e.beginPath(),e.arc(-4,-5,4,0,Math.PI*2),e.arc(4,-5,4,0,Math.PI*2),e.fill(),e.fillStyle=this.def.glowColor,e.beginPath(),e.arc(-4,-5,2.5,0,Math.PI*2),e.arc(4,-5,2.5,0,Math.PI*2),e.fill(),e.fillStyle="#aa9900",e.beginPath(),e.moveTo(0,-2),e.lineTo(-2,3),e.lineTo(2,3),e.closePath(),e.fill(),e.restore()}_drawBoneLizard(e,t,i,s,a,r){const n=Math.sin(r*4)*3;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t+n*.3,i-a*.2,s*.55,a*.25,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(t+s*.4+n*.5,i-a*.25,s*.18,a*.18,0,0,Math.PI*2),e.fill(),e.fillStyle="#d4c8a0";for(let l=0;l<4;l++){const h=t-s*.2+l*s*.15+n*.2;e.beginPath(),e.moveTo(h,i-a*.4),e.lineTo(h-3,i-a*.2),e.lineTo(h+3,i-a*.2),e.closePath(),e.fill()}e.strokeStyle=this.def.color,e.lineWidth=2,e.beginPath(),e.moveTo(t-s*.45,i-a*.15),e.quadraticCurveTo(t-s*.7,i-a*.3+n,t-s*.8,i-a*.1),e.stroke(),e.fillStyle="#ff4444",e.beginPath(),e.arc(t+s*.45+n*.5,i-a*.28,2,0,Math.PI*2),e.fill()}_drawVoidDragon(e,t,i,s,a,r){const n=Math.sin(r*3)*.5,l=Math.sin(r*2)*3,h=.15+Math.sin(r*4)*.1;e.fillStyle=`rgba(90,26,138,${h})`,e.beginPath(),e.arc(t,i-a*.3+l,s*.8,0,Math.PI*2),e.fill(),e.fillStyle="#1a0a2a",e.save(),e.translate(t,i-a*.4+l),e.save(),e.rotate(-n-.5),e.beginPath(),e.moveTo(0,0),e.lineTo(-s*.9,-a*.4),e.lineTo(-s*.6,a*.2),e.closePath(),e.fill(),e.restore(),e.save(),e.rotate(n+.5),e.beginPath(),e.moveTo(0,0),e.lineTo(s*.9,-a*.4),e.lineTo(s*.6,a*.2),e.closePath(),e.fill(),e.restore(),e.fillStyle=this.def.color,e.beginPath(),e.ellipse(0,0,s*.35,a*.4,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(0,-a*.35,s*.2,a*.2,0,0,Math.PI*2),e.fill(),e.fillStyle="#aa44ff",e.beginPath(),e.arc(-5,-a*.38,3,0,Math.PI*2),e.arc(5,-a*.38,3,0,Math.PI*2),e.fill(),e.restore()}_drawRealityWarper(e,t,i,s,a,r){const n=Math.sin(r*3)*4,l=r*2;e.strokeStyle=`rgba(136,0,255,${.3+Math.sin(r*5)*.15})`,e.lineWidth=1.5;for(let h=0;h<3;h++){const c=s*.3+h*6+Math.sin(r*3+h)*3;e.beginPath(),e.ellipse(t,i-a*.3+n,c,c*.4,l+h*.8,0,Math.PI*2),e.stroke()}e.fillStyle=this.def.color,e.beginPath(),e.arc(t,i-a*.3+n,s*.25,0,Math.PI*2),e.fill(),e.fillStyle=this.def.glowColor,e.beginPath(),e.arc(t,i-a*.3+n,s*.15,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.beginPath(),e.ellipse(t,i-a*.3+n,4,2.5,l*.5,0,Math.PI*2),e.fill()}_drawVoidPanda(e,t,i,s,a,r){const n=Math.sin(r*3)*1.5;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.25+n,s*.45,a*.4,0,0,Math.PI*2),e.fill(),e.fillStyle="#0a0a1e",e.beginPath(),e.ellipse(t,i-a*.15+n,s*.25,a*.25,0,0,Math.PI*2),e.fill(),e.fillStyle=this.def.color,e.beginPath(),e.arc(t,i-a*.55+n,s*.28,0,Math.PI*2),e.fill(),e.fillStyle="#3a3a5e",e.beginPath(),e.arc(t-s*.22,i-a*.72+n,s*.1,0,Math.PI*2),e.arc(t+s*.22,i-a*.72+n,s*.1,0,Math.PI*2),e.fill(),e.fillStyle="#4a4a6e",e.beginPath(),e.ellipse(t-6,i-a*.57+n,5,4,-.2,0,Math.PI*2),e.ellipse(t+6,i-a*.57+n,5,4,.2,0,Math.PI*2),e.fill(),e.fillStyle="#8844cc",e.beginPath(),e.arc(t-6,i-a*.57+n,2.5,0,Math.PI*2),e.arc(t+6,i-a*.57+n,2.5,0,Math.PI*2),e.fill()}_drawSporeLarva(e,t,i,s,a,r){const n=Math.sin(r*6)*2,l=Math.sin(r*4);e.fillStyle=this.def.color;for(let h=0;h<4;h++){const c=t-s*.2+h*s*.15+Math.sin(r*4+h*.8)*2,d=i-a*.2+n*(h/4),u=s*(.2-h*.02);e.beginPath(),e.ellipse(c,d,u,a*.15,0,0,Math.PI*2),e.fill()}e.fillStyle=this.def.glowColor,e.beginPath(),e.arc(t+s*.25+l,i-a*.2,s*.12,0,Math.PI*2),e.fill(),e.fillStyle="rgba(100,180,50,0.5)",e.beginPath(),e.arc(t,i-a*.25,2,0,Math.PI*2),e.arc(t-5,i-a*.15,1.5,0,Math.PI*2),e.fill()}_drawForestBear(e,t,i,s,a,r){const n=Math.sin(r*3)*1;e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.25+n,s*.5,a*.4,0,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t+s*.3,i-a*.45+n,s*.22,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(t+s*.2,i-a*.62+n,s*.08,0,Math.PI*2),e.arc(t+s*.4,i-a*.62+n,s*.08,0,Math.PI*2),e.fill(),e.fillStyle="#7a5a3a",e.beginPath(),e.ellipse(t+s*.38,i-a*.4+n,s*.1,a*.06,0,0,Math.PI*2),e.fill(),e.fillStyle="rgba(80,140,40,0.4)",e.beginPath(),e.arc(t-s*.15,i-a*.35+n,5,0,Math.PI*2),e.arc(t+s*.1,i-a*.1+n,4,0,Math.PI*2),e.fill(),e.fillStyle="#ff3333",e.beginPath(),e.arc(t+s*.25,i-a*.48+n,2.5,0,Math.PI*2),e.arc(t+s*.35,i-a*.48+n,2.5,0,Math.PI*2),e.fill(),e.strokeStyle="#333",e.lineWidth=1.5;for(let l=0;l<3;l++)e.beginPath(),e.moveTo(t-s*.35+l*4,i+a*.1+n),e.lineTo(t-s*.38+l*4,i+a*.2+n),e.stroke()}_drawGeneric(e,t,i,s,a){e.fillStyle=this.def.color,e.beginPath(),e.ellipse(t,i-a*.3,s*.4,a*.4,0,0,Math.PI*2),e.fill()}_drawNameLabel(e,t,i,s){const a=this.def.level??1,r=this.def.isElite||this.def.category==="elite",n=`${r?" ":""}${this.def.name} Lv.${a}`;e.font="bold 8px monospace",e.textAlign="center";const h=e.measureText(n).width+8,c=12,d=t-h/2,u=i-c+2;e.fillStyle=s?"rgba(10, 10, 20, 0.75)":"rgba(10, 10, 20, 0.45)",e.beginPath(),e.roundRect(d,u,h,c,3),e.fill(),r?e.fillStyle=s?"#fbbf24":"rgba(251,191,36,0.6)":this._aiState==="chase"?e.fillStyle="#ff6b6b":e.fillStyle=s?"#e5e7eb":"rgba(229,231,235,0.5)",e.fillText(n,t,i)}_drawHealthBar(e,t,i){const r=this.health/this.maxHealth;e.fillStyle="rgba(0,0,0,0.8)",e.beginPath(),e.roundRect(t-48/2-2,i-1,52,7,2),e.fill();const n=r>.5?"#4ade80":r>.25?"#facc15":"#ef4444";e.fillStyle=n,e.beginPath(),e.roundRect(t-48/2,i,48*r,5,1),e.fill(),e.fillStyle="rgba(255,255,255,0.15)",e.fillRect(t-48/2,i,48*r,5/2)}takeDamage(e){const t=Math.max(1,e-this.def.defense),i=Math.max(0,this.health-t);x.current[this.eid]=i,xe.value[this.eid]=i>0?1:0,this._hitFlash=.3,this.hasSprite&&i>0&&(this._spriteAnim="hurt",this._spriteFrame=0,this._spriteFrameTimer=0,this._spriteAnimDone=!1),this.hasSprite&&i<=0&&(this._spriteAnim="death",this._spriteFrame=0,this._spriteFrameTimer=0,this._spriteAnimDone=!1)}_knockbackVx=0;_knockbackVy=0;_knockbackTimer=0;applyKnockback(e,t){this._knockbackVx=e,this._knockbackVy=t,this._knockbackTimer=.15}updateKnockback(e){if(this._knockbackTimer<=0)return!1;this._knockbackTimer-=e;const t=this._knockbackTimer/.15;return j.x[this.eid]+=this._knockbackVx*e*t,j.y[this.eid]+=this._knockbackVy*e*t,this._knockbackTimer<=0&&(this._knockbackVx=0,this._knockbackVy=0),!0}}const Eg={elder_miriam:{id:"elder_miriam",name:"Elder Miriam",icon:"",occupation:"Elder",personality:"Wise and burdened",bodyColor:"#4a5d8a",hairColor:"#5a5a5a",skinColor:"#ffd9b3",greeting:"Welcome to Haven, pilgrim. This refuge is all that stands between us and the darkness.",homeX:20,homeY:20,birthday:{season:0,day:11},loves:["relic_fragment","purified_water","sacred_tome"],likes:["medicine","cooked_food","gold_ore","wine"],dislikes:["corrupted_flesh","void_shard","rotten_food"],hates:["void_egg","cursed_bone"],quests:["welcome_quest","haven_defense"],schedule:{default:[{start:6,end:8,location:"mayor_house",activity:"home"},{start:8,end:12,location:"town_hall",activity:"work"},{start:12,end:13,location:"tavern",activity:"lunch"},{start:13,end:18,location:"town_hall",activity:"work"},{start:18,end:22,location:"town_square",activity:"socialize"},{start:22,end:6,location:"mayor_house",activity:"sleep"}],rainy:[{start:6,end:22,location:"town_hall",activity:"work"},{start:22,end:6,location:"mayor_house",activity:"sleep"}]},dialogues:{greeting:["Welcome to Haven, pilgrim. I am Elder Miriam. This refuge is all that stands between us and the darkness.","Another soul drawn to the light... Haven is open to all who resist the corruption. Speak to Martha for supplies.","The corruption spreads further each day. If you have the strength, Haven needs defenders.","There are tasks that need doing, pilgrim. The bounty board at the tavern, the forgemaster's repairs... every hand counts."],highFriendship:["You have become the backbone of Haven. We would not survive without you.","In you I see the same fire that burned in the old world's heroes."],gift_loved:"This... this is beyond precious. You honor us.",gift_liked:"A generous offering. Haven thanks you.",gift_disliked:"I appreciate the thought, but perhaps save this for another purpose.",quest:"There is a matter of urgency. Will you hear it?"}},martha:{id:"martha",name:"Martha",icon:"",occupation:"Merchant",personality:"Resourceful and shrewd",bodyColor:"#8a5a4a",hairColor:"#c45a2a",skinColor:"#ffd9b3",greeting:"Welcome to Martha's Provisions. The right supplies mean life or death.",homeX:30,homeY:15,birthday:{season:1,day:18},isShopkeeper:!0,shopId:"general_store",loves:["diamond","gold_bar","rare_artifact"],likes:["gems","cooked_food","herbs","trade_goods"],dislikes:["corrupted_flesh","rotten_food","clay"],hates:["void_shard","cursed_bone"],schedule:{default:[{start:6,end:8,location:"shop_house",activity:"home"},{start:8,end:20,location:"general_store",activity:"work"},{start:20,end:22,location:"tavern",activity:"socialize"},{start:22,end:6,location:"shop_house",activity:"sleep"}]},dialogues:{greeting:["Welcome to Martha's Provisions. In times like these, the right supplies mean life or death.","Need gear? Rations? Bandages? I salvage what I can and keep prices fair. Mostly.","Every supply run gets more dangerous. If you find anything useful out there, I'll trade for it.","The Forgemaster can temper your weapons, but start with what I have here. You'll need it."],shop:"Let me show you what I've managed to stock.",closed:"The shop is barred for the night. Come back at dawn."}},garrett:{id:"garrett",name:"Garrett",icon:"",occupation:"Forgemaster",personality:"Gruff but dependable",bodyColor:"#5a3a2a",hairColor:"#2a2a2a",skinColor:"#c9a78c",greeting:"The forge burns day and night. What do you need, pilgrim?",homeX:40,homeY:25,birthday:{season:3,day:5},isShopkeeper:!0,shopId:"blacksmith",loves:["iridium_bar","gold_bar","ancient_metal"],likes:["ores","gems","beer","copper_bar","iron_bar"],dislikes:["herbs","sweets","fish"],hates:["corrupted_ore","void_shard"],schedule:{default:[{start:6,end:7,location:"blacksmith_house",activity:"home"},{start:7,end:18,location:"blacksmith",activity:"work"},{start:18,end:21,location:"tavern",activity:"socialize"},{start:21,end:6,location:"blacksmith_house",activity:"sleep"}]},dialogues:{greeting:["*hammering* Hm. Need a blade sharpened? Armor patched?","The forge burns hot today. Good. We'll need weapons before the next assault.","Bring me ore from the deep veins. I'll forge something that can cut through the dark."],upgrade:"Want me to reinforce your gear? It'll cost materials and gold."}},lily:{id:"lily",name:"Lily",icon:"",occupation:"Herbalist",personality:"Quiet and resilient",bodyColor:"#7aa85a",hairColor:"#8a5a3a",skinColor:"#ffe0c0",greeting:"Oh... hello. The herbs still grow, even in the corruption.",homeX:15,homeY:30,birthday:{season:0,day:24},isRomanceable:!0,loves:["moonpetal","sacred_herb","glowmoss"],likes:["herbs","medicinal_root","honey","bandages"],dislikes:["weapons","monster_parts","corrupted_flesh"],hates:["void_shard","cursed_bone","corrupted_ore"],heartEvents:["lily_herb_garden","lily_moonpetal"],schedule:{default:[{start:6,end:8,location:"lily_farm",activity:"home"},{start:8,end:12,location:"lily_fields",activity:"gathering"},{start:12,end:13,location:"lily_farm",activity:"lunch"},{start:13,end:17,location:"lily_fields",activity:"gathering"},{start:17,end:19,location:"forest_path",activity:"walk"},{start:19,end:22,location:"lily_farm",activity:"home"},{start:22,end:6,location:"lily_farm",activity:"sleep"}],rainy:[{start:6,end:22,location:"lily_farm",activity:"home"},{start:22,end:6,location:"lily_farm",activity:"sleep"}]},dialogues:{greeting:["Oh... hello. I was just preparing poultices.","The herbs still grow, even in the corruption. Life persists.","I found a patch of moonpetal near the old ruins... it glows at night."],highFriendship:["You're one of the few people I feel safe around...","When you're here, the darkness doesn't feel so close."],romance:["I... I keep looking for you when you're out there. Please come back safe.","In a world this dark, you are my light."]}},harold:{id:"harold",name:"Harold",icon:"",occupation:"Innkeeper",personality:"Grizzled but warm",bodyColor:"#8a6a4a",hairColor:"#5a3a2a",skinColor:"#e8c8a0",greeting:"Welcome to the Last Hearth. Warm food, strong drink, and a bed mostly free of lice.",homeX:25,homeY:12,birthday:{season:2,day:8},isShopkeeper:!0,shopId:"tavern",loves:[],likes:["beer","wine","cooked_food","firewood"],dislikes:["corrupted_flesh"],hates:[],schedule:{default:[{start:6,end:10,location:"inn_kitchen",activity:"cooking"},{start:10,end:24,location:"tavern",activity:"work"},{start:0,end:2,location:"tavern",activity:"cleaning"},{start:2,end:6,location:"inn_room",activity:"sleep"}]},dialogues:{greeting:["Welcome to the Last Hearth, pilgrim. I'm Harold. Warm food, strong drink, and a bed that's mostly free of lice.","Pull up a chair. Rumors travel fast through here -- bounty board's by the door if you're looking for work.","Another survivor? Good. Haven grows stronger with each soul that makes it through the darkness.","Check the bounty board. Gold for those brave enough to venture out. Or foolish enough."],rent:"Lodging isn't free, friend. Upkeep costs what it costs.",room:"A safe bed for the night? 50 gold. Worth every coin out here."}},eldric:{id:"eldric",name:"Eldric",icon:"",occupation:"Occultist",personality:"Cryptic and knowing",bodyColor:"#5a4a8a",hairColor:"#8a8aaa",skinColor:"#e8d8c0",greeting:"The corruption speaks to me in whispers. I choose not to listen... most of the time.",homeX:50,homeY:10,birthday:{season:3,day:17},loves:[],likes:["void_essence","ancient_relic","corrupted_crystal"],dislikes:["mundane_items"],hates:[],quests:["corruption_source","seal_quest"],schedule:{default:[{start:0,end:6,location:"wizard_tower",activity:"research"},{start:6,end:12,location:"wizard_tower",activity:"sleep"},{start:12,end:18,location:"wizard_tower",activity:"experiments"},{start:18,end:24,location:"forest_shrine",activity:"ritual"}]},dialogues:{greeting:["The corruption speaks to me in whispers. I choose not to listen... most of the time.","Ah, the pilgrim. The old texts foretold someone like you. Or warned against you. The translation is unclear.","Reality frays at the edges. Can you not feel it?"],quest:"I have deciphered something in the ancient texts. You need to see this..."}},marcus:{id:"marcus",name:"Marcus",icon:"",occupation:"Scout",personality:"Battle-hardened and loyal",bodyColor:"#5a6a5a",hairColor:"#3a3a3a",skinColor:"#d4b896",greeting:"Pilgrim. The wastes are crawling today. Watch your back out there.",homeX:45,homeY:20,birthday:{season:1,day:2},isRomanceable:!0,loves:[],likes:["weapons","monster_parts","beer","armor"],dislikes:["herbs","trinkets"],hates:[],heartEvents:["marcus_ambush","marcus_campfire"],schedule:{default:[{start:6,end:10,location:"adventurer_guild",activity:"training"},{start:10,end:18,location:"dungeon_entrance",activity:"exploring"},{start:18,end:23,location:"tavern",activity:"drinking"},{start:23,end:6,location:"adventurer_guild",activity:"sleep"}]},dialogues:{greeting:["Pilgrim. The wastes are crawling today. Watch your back out there.","I mapped a new route through the ashen fields. Dangerous, but passable.","Lost three scouts last month. The corruption takes the careless first."],dungeon:"I've found a passage deeper into the ruins. Want to check it out together?"}},elena:{id:"elena",name:"Dr. Elena",icon:"",occupation:"Healer",personality:"Stern but compassionate",bodyColor:"#8a8a9a",hairColor:"#4a3a3a",skinColor:"#f0d8c0",greeting:"Another injury? Sit down. Let me see it before the corruption sets in.",homeX:12,homeY:18,birthday:{season:2,day:21},isRomanceable:!0,canHeal:!0,loves:[],likes:["medicine","herbs","bandages","clean_water"],dislikes:["alcohol","corrupted_flesh"],hates:[],schedule:{default:[{start:6,end:8,location:"clinic_house",activity:"home"},{start:8,end:18,location:"clinic",activity:"work"},{start:18,end:20,location:"beach",activity:"walk"},{start:20,end:22,location:"clinic_house",activity:"reading"},{start:22,end:6,location:"clinic_house",activity:"sleep"}]},dialogues:{greeting:["Another injury? Sit down. Let me see it before the corruption sets in.","I'm running low on antiseptic. If you find medicinal herbs out there, bring them to me.","The corruption infections are getting worse. I do what I can, but I'm only one healer."],heal:"Hold still. This will sting, but it's better than losing the limb."}},penny:{id:"penny",name:"Penny",icon:"",occupation:"Animal Handler",personality:"Gentle and protective",bodyColor:"#d4a574",hairColor:"#6b4423",skinColor:"#e8c8a0",greeting:"The animals sense the corruption before we do. They have been restless lately.",homeX:10,homeY:25,birthday:{season:0,day:7},isShopkeeper:!0,shopId:"pet_shop",loves:[],likes:["animal_feed","herbs","leather","bone"],dislikes:["monster_parts","void_shard"],hates:[],schedule:{default:[{start:6,end:9,location:"pet_shop_house",activity:"home"},{start:9,end:18,location:"pet_shop",activity:"work"},{start:18,end:20,location:"forest_path",activity:"walk_pets"},{start:20,end:22,location:"tavern",activity:"socialize"},{start:22,end:6,location:"pet_shop_house",activity:"sleep"}]},dialogues:{greeting:["The animals sense the corruption before we do. They've been restless lately.","I saved these creatures from the wastes. They need homes -- and you might need a companion.","A trained hound can smell danger from fifty paces. Could save your life out there."],shop:"Looking for a companion? These survivors need someone to care for them.",closed:"The animals are resting. Come back in the morning."}}},Dg={town_square:{x:0,y:0},mayor_house:{x:-80,y:-120},town_hall:{x:80,y:-80},general_store:{x:-120,y:40},shop_house:{x:-160,y:40},blacksmith:{x:120,y:40},blacksmith_house:{x:160,y:80},tavern:{x:0,y:80},inn_room:{x:40,y:120},inn_kitchen:{x:-40,y:120},lily_farm:{x:-200,y:-80},lily_fields:{x:-240,y:-40},forest_path:{x:-280,y:0},wizard_tower:{x:200,y:-160},forest_shrine:{x:280,y:-200},adventurer_guild:{x:160,y:-40},dungeon_entrance:{x:240,y:80},clinic:{x:-80,y:-40},clinic_house:{x:-120,y:-80},beach:{x:0,y:200},pet_shop:{x:-160,y:-40},pet_shop_house:{x:-200,y:-80}},Fg=new Set(["mayor_house","shop_house","blacksmith_house","lily_farm","inn_room","inn_kitchen","general_store","blacksmith","tavern","town_hall","wizard_tower","clinic","adventurer_guild","pet_shop","pet_shop_house"]);class $g{eid;def;_animTime=0;_walkTimer=0;_walkDirX=0;_walkDirY=0;_isMoving=!1;_flinchTimer=0;_tileSpriteImg=null;_tileSpriteLoaded=!1;constructor(e,t){this.eid=Is(e),this.def=t,ce(e,j,this.eid),ce(e,U,this.eid),ce(e,Ge,this.eid),ce(e,x,this.eid),ce(e,Gc,this.eid),ce(e,ye,this.eid),ce(e,xe,this.eid),j.x[this.eid]=t.homeX*32,j.y[this.eid]=t.homeY*32,x.current[this.eid]=100,x.max[this.eid]=100,Ge.dir[this.eid]=0,xe.value[this.eid]=1,ye.width[this.eid]=32,ye.height[this.eid]=32,ye.totalFrames[this.eid]=1;const i=No[t.id];if(i){const s=new Image;s.src="/"+i,s.onload=()=>{this._tileSpriteLoaded=!0},this._tileSpriteImg=s}}get x(){return j.x[this.eid]}get y(){return j.y[this.eid]}get name(){return this.def.name}get flinchTimer(){return this._flinchTimer}flinch(){this._flinchTimer=.3}_currentLocation="";setScheduleTarget(e){this._currentLocation=e}get isIndoors(){return Fg.has(this._currentLocation)}updateAI(e,t,i){this._animTime+=e,this._walkTimer-=e,this._flinchTimer>0&&(this._flinchTimer-=e);let s=this.def.homeX*32,a=this.def.homeY*32;if(t!==void 0){const d=i&&this.def.schedule.rainy?this.def.schedule.rainy:this.def.schedule.default;for(const u of d)if(u.start<=u.end?t>=u.start&&t<u.end:t>=u.start||t<u.end){this._currentLocation=u.location;const m=Dg[u.location];m&&(s=m.x,a=m.y);break}}const r=this.x-s,n=this.y-a,l=Math.sqrt(r*r+n*n);if(l>40){const d=-r/l,u=-n/l,f=Math.min(l*.3,50);U.vx[this.eid]=d*f,U.vy[this.eid]=u*f,this._isMoving=!0}else if(this._walkTimer<=0&&(Math.random()<.4?(this._isMoving=!0,this._walkDirX=(Math.random()-.5)*2,this._walkDirY=(Math.random()-.5)*2,this._walkTimer=1+Math.random()*2):(this._isMoving=!1,this._walkTimer=2+Math.random()*4)),l>80){const d=-r/l,u=-n/l,f=Math.min(l*.5,40);U.vx[this.eid]=d*f,U.vy[this.eid]=u*f,this._isMoving=!0}else this._isMoving?(U.vx[this.eid]=this._walkDirX*20,U.vy[this.eid]=this._walkDirY*20):(U.vx[this.eid]=0,U.vy[this.eid]=0);const h=U.vx[this.eid],c=U.vy[this.eid];(Math.abs(h)>1||Math.abs(c)>1)&&(Math.abs(h)>Math.abs(c)?Ge.dir[this.eid]=h>0?2:3:Ge.dir[this.eid]=c>0?0:1)}draw(e,t,i,s,a){const r=t.worldToScreen(this.x,this.y),n=r.sx-i+e.canvas.width/2,l=r.sy-s+e.canvas.height/2;if(n<-80||n>e.canvas.width+80||l<-80||l>e.canvas.height+80)return;e.save();const h=this._isMoving?Math.sin(this._animTime*6)*1.5:0,c=this._flinchTimer>0?-Math.sin(this._flinchTimer/.3*Math.PI)*4:0,d=h+c;e.fillStyle="rgba(0,0,0,0.3)",e.beginPath(),e.ellipse(n,l+2,14,5,0,0,Math.PI*2),e.fill();let u=!1;if(a){const S=Ge.dir[this.eid],b=S===3?"Left":S===1?"Up":S===2?"Right":"Down",w=this._isMoving?"Run":"Idle",k=a.getNPCSpritePath(this.def.id,b,w);if(k){const T=a.getSprite(k);if(T&&T.complete&&T.naturalWidth>0){const M=T.naturalHeight,C=M,P=Math.floor(T.naturalWidth/C),R=this._isMoving?8:4,F=Math.floor(this._animTime*R%P)*C,W=64;e.drawImage(T,F,0,C,M,n-W/2,l-W+6+d,W,W),u=!0}}}if(!u&&this._tileSpriteLoaded&&this._tileSpriteImg){const S=this._tileSpriteImg,b=S.naturalWidth,w=S.naturalHeight;let k=16;for(const $ of[16,32,48]){const H=Math.floor(b/$),te=Math.floor(w/$);if(H>=2&&te>=1&&b%$===0&&w%$===0){k=$;break}}const T=Math.floor(b/k),M=Math.floor(w/k),C=k<=16?3.5:k<=32?2.4:1.6,P=Math.min(k*C,76),R=Ge.dir[this.eid];let B=0;M>=4&&(B=R===1?1:R===3?2:R===2?3:0);const F=this._isMoving?6:3,W=Math.min(T,8),X=Math.floor(this._animTime*F)%Math.max(1,W);e.drawImage(S,X*k,B*k,k,k,n-P/2,l-P+6+d,P,P),u=!0}if(!u){e.fillStyle="#3a3a4a";const S=this._isMoving?Math.sin(this._animTime*8)*2:0,b=this._isMoving?Math.sin(this._animTime*8+Math.PI)*2:0;e.fillRect(n-4,l-6+S,3,8),e.fillRect(n+1,l-6+b,3,8),e.fillStyle=this.def.bodyColor,e.beginPath(),e.roundRect(n-7,l-18+d,14,14,3),e.fill(),e.fillRect(n-10,l-16+d,3,10),e.fillRect(n+7,l-16+d,3,10),e.fillStyle=this.def.skinColor,e.beginPath(),e.arc(n-8.5,l-6+d,2,0,Math.PI*2),e.arc(n+8.5,l-6+d,2,0,Math.PI*2),e.fill(),e.fillStyle=this.def.skinColor,e.beginPath(),e.arc(n,l-22+d,6,0,Math.PI*2),e.fill(),e.fillStyle=this.def.hairColor,e.beginPath(),e.arc(n,l-24+d,6,Math.PI,Math.PI*2),e.fill();const w=Ge.dir[this.eid];if(e.fillStyle="#222",w!==2){const k=w===1?-3:w===3?1:-2,T=w===1||w===3?0:4;e.beginPath(),e.arc(n+k,l-22+d,1.2,0,Math.PI*2),T>0&&e.arc(n+k+T,l-22+d,1.2,0,Math.PI*2),e.fill()}}const f=u?l-42+d:l-34+d;e.font="bold 9px monospace",e.textAlign="center";const _=e.measureText(this.def.name).width+8,p=13,g=n-_/2,y=f-p+3;e.fillStyle="rgba(10, 10, 20, 0.7)",e.beginPath(),e.roundRect(g,y,_,p,3),e.fill(),e.fillStyle="#e5e7eb",e.fillText(this.def.name,n,f),e.font="7px monospace",e.fillStyle="rgba(212,160,48,0.5)",e.fillText(this.def.occupation,n,f-10),e.restore()}}const xt={guild_hall:{id:"guild_hall",name:"Adventurer Guild",icon:"",category:"guild",color:"#5a5045",roofColor:"#8b4513",accentColor:"#d4a030",widthTiles:4,heightTiles:3,features:["quests","bounties"]},general_store:{id:"general_store",name:"Martha's Provisions",icon:"",category:"shop",color:"#6b5a4a",roofColor:"#654321",accentColor:"#c9a050",widthTiles:3,heightTiles:3,features:["shop"]},blacksmith:{id:"blacksmith",name:"Garrett's Forge",icon:"",category:"profession",color:"#4a4040",roofColor:"#333",accentColor:"#ff6b35",widthTiles:3,heightTiles:3,features:["forge","upgrade"]},tavern:{id:"tavern",name:"The Last Hearth",icon:"",category:"social",color:"#7a6a5a",roofColor:"#5c4033",accentColor:"#ffc107",widthTiles:4,heightTiles:3,features:["rest","rumors"]},herb_shop:{id:"herb_shop",name:"Lily's Apothecary",icon:"",category:"shop",color:"#4a6a4a",roofColor:"#2d5a2d",accentColor:"#90ee90",widthTiles:2,heightTiles:2,features:["potions","herbs"]},chapel:{id:"chapel",name:"Chapel of Light",icon:"",category:"faith",color:"#8a8a8a",roofColor:"#555",accentColor:"#7dd3fc",widthTiles:3,heightTiles:4,features:["heal","bless"]},watchtower:{id:"watchtower",name:"Watchtower",icon:"",category:"defense",color:"#6a6a6a",roofColor:"#444",accentColor:"#ef4444",widthTiles:2,heightTiles:2,features:["defense"]},corruption_dungeon:{id:"corruption_dungeon",name:"Corruption Core",icon:"",category:"dungeon",color:"#3a1a3a",roofColor:"#2a0a2a",accentColor:"#a040cc",widthTiles:3,heightTiles:3,features:["dungeon"]},mine_entrance:{id:"mine_entrance",name:"Abandoned Mine",icon:"",category:"dungeon",color:"#5a4a3a",roofColor:"#3a2a1a",accentColor:"#aa8844",widthTiles:2,heightTiles:2,features:["dungeon"]},ancient_ruins:{id:"ancient_ruins",name:"Ancient Ruins",icon:"",category:"dungeon",color:"#5a5a60",roofColor:"#4a4a50",accentColor:"#8888a0",widthTiles:3,heightTiles:3,features:["dungeon"]}};function Lg(o,e){const t=Is(o);ce(o,Wo,t),ce(o,ui,t),ce(o,x,t),ce(o,xe,t),ce(o,j,t),ce(o,ye,t);const i=32;return ui.tileX[t]=e.tileX,ui.tileY[t]=e.tileY,ui.widthTiles[t]=e.def.widthTiles,ui.heightTiles[t]=e.def.heightTiles,x.current[t]=200,x.max[t]=200,xe.value[t]=1,ye.width[t]=e.def.widthTiles*48,ye.height[t]=e.def.heightTiles*48,ye.totalFrames[t]=1,j.x[t]=(e.tileX+e.def.widthTiles/2)*i,j.y[t]=(e.tileY+e.def.heightTiles/2)*i,e.eid=t,t}function Bg(o,e,t,i,s,a,r){const n=e.def,l=e.tileX*32+n.widthTiles*32/2,h=e.tileY*32+n.heightTiles*32/2,c=t.worldToScreen(l,h),d=c.sx-i+o.canvas.width/2,u=c.sy-s+o.canvas.height/2;if(d<-200||d>o.canvas.width+200||u<-200||u>o.canvas.height+200)return;const f=n.widthTiles*48,m=n.heightTiles*35,_=m*1.2;o.save();const p=r?.getBuildingSpritePath(n.id)??"";let g=!1;if(r&&p){const w=r.getSprite(p);if(w&&w.complete&&w.naturalWidth>0){const k=f*2.8,T=w.naturalHeight/w.naturalWidth,M=k*T;if(o.fillStyle="rgba(0,0,0,0.18)",o.beginPath(),o.ellipse(d+6,u+4,k*.4,k*.12,0,0,Math.PI*2),o.fill(),o.drawImage(w,d-k/2,u-M+m*.3,k,M),a){o.globalAlpha=.15;const C=o.createRadialGradient(d,u-M*.4,0,d,u-M*.4,k*.5);C.addColorStop(0,"rgba(255,200,50,0.3)"),C.addColorStop(1,"transparent"),o.fillStyle=C,o.fillRect(d-k/2,u-M,k,M),o.globalAlpha=1}g=!0}}if(!g){o.fillStyle="rgba(0,0,0,0.2)",o.beginPath(),o.ellipse(d+8,u+6,f*.55,f*.18,0,0,Math.PI*2),o.fill(),o.fillStyle=n.color,o.beginPath(),o.moveTo(d-f/2,u),o.lineTo(d,u+m/2),o.lineTo(d+f/2,u),o.lineTo(d+f/2,u-_),o.lineTo(d,u-_+m/4),o.lineTo(d-f/2,u-_),o.closePath(),o.fill(),o.fillStyle=Si(n.color,.2),o.beginPath(),o.moveTo(d,u+m/2),o.lineTo(d+f/2,u),o.lineTo(d+f/2,u-_),o.lineTo(d,u-_+m/4),o.closePath(),o.fill(),o.fillStyle=Si(n.color,.1),o.beginPath(),o.moveTo(d-f/2,u),o.lineTo(d,u+m/2),o.lineTo(d,u-_+m/4),o.lineTo(d-f/2,u-_),o.closePath(),o.fill();const w=_*.5,k=6;o.fillStyle=n.roofColor,o.beginPath(),o.moveTo(d,u-_-w),o.lineTo(d-f/2-k,u-_+4),o.lineTo(d,u-_+m/4+4),o.lineTo(d+f/2+k,u-_+4),o.closePath(),o.fill(),o.fillStyle=Si(n.roofColor,.2),o.beginPath(),o.moveTo(d,u-_-w),o.lineTo(d+f/2+k,u-_+4),o.lineTo(d,u-_+m/4+4),o.closePath(),o.fill(),o.fillStyle=Si(n.color,.35);const T=8,M=14;o.fillRect(d-T/2-f*.1,u-M+2,T,M),o.fillStyle=n.accentColor,o.beginPath(),o.arc(d+T*.2-f*.1,u-M/2+2,1.5,0,Math.PI*2),o.fill();const C=6,P=[{x:d-f*.28,y:u-_*.5},{x:d+f*.15,y:u-_*.5}];for(const R of P){if(o.fillStyle=Si(n.color,.25),o.fillRect(R.x-C/2-1,R.y-C/2-1,C+2,C+2),a){o.fillStyle="rgba(255,200,50,0.8)",o.fillRect(R.x-C/2,R.y-C/2,C,C);const B=o.createRadialGradient(R.x,R.y,0,R.x,R.y,15);B.addColorStop(0,"rgba(255,200,50,0.15)"),B.addColorStop(1,"transparent"),o.fillStyle=B,o.fillRect(R.x-15,R.y-15,30,30)}else o.fillStyle="rgba(120,170,220,0.4)",o.fillRect(R.x-C/2,R.y-C/2,C,C);o.strokeStyle=Si(n.color,.3),o.lineWidth=1,o.beginPath(),o.moveTo(R.x,R.y-C/2),o.lineTo(R.x,R.y+C/2),o.moveTo(R.x-C/2,R.y),o.lineTo(R.x+C/2,R.y),o.stroke()}}o.font="12px sans-serif",o.textAlign="center";const y=g?u-m*1.2:u-_*.2;o.fillText(n.icon,d-f*.35,y),o.font="8px monospace",o.fillStyle="rgba(255,255,255,0.5)",o.textAlign="center";const S=_*.5,b=g?u-m*1.5:u-_-S-8;o.fillText(n.name,d,b),o.restore()}function Si(o,e){const t=parseInt(o.slice(1,3),16),i=parseInt(o.slice(3,5),16),s=parseInt(o.slice(5,7),16),a=1-e;return`rgb(${Math.round(t*a)}, ${Math.round(i*a)}, ${Math.round(s*a)})`}function Wg(){return[{def:xt.guild_hall,tileX:8,tileY:8},{def:xt.general_store,tileX:18,tileY:6},{def:xt.blacksmith,tileX:28,tileY:12},{def:xt.tavern,tileX:14,tileY:18},{def:xt.herb_shop,tileX:4,tileY:20},{def:xt.chapel,tileX:22,tileY:22},{def:xt.watchtower,tileX:35,tileY:5},{def:xt.corruption_dungeon,tileX:-15,tileY:-20},{def:xt.mine_entrance,tileX:45,tileY:30},{def:xt.ancient_ruins,tileX:-25,tileY:35}]}function Zs(o,e,t){let i=t;return i^=o*374761393,i^=e*668265263,i=Math.imul(i,1274126177),i^=i>>>16,(i>>>0)/4294967296}function lt(o,e,t,i){const s=o/i,a=e/i,r=Math.floor(s),n=Math.floor(a),l=s-r,h=a-n,c=l*l*(3-2*l),d=h*h*(3-2*h),u=Zs(r,n,t),f=Zs(r+1,n,t),m=Zs(r,n+1,t),_=Zs(r+1,n+1,t);return u*(1-c)*(1-d)+f*c*(1-d)+m*(1-c)*d+_*c*d}function Zi(o,e,t){const i=lt(o,e,t,32)*.4+lt(o,e,t+1e3,16)*.3+lt(o,e,t+2e3,8)*.2+lt(o,e,t+3e3,4)*.1,s=lt(o,e,t+4e3,24)*.6+lt(o,e,t+4500,10)*.4,a=lt(o,e,t+6e3,6),r=Math.sqrt(o*o+e*e),n=40,l=lt(o,e,t+9e3,12)*8-4,h=r+l;let c;h<n?c="haven":h<n*2.5?c="rotwood":h<n*4?c="ashlands":h<n*5.5?c="drowned_depths":h<n*7?c="bone_wastes":h<n*9?c="the_void":c="edilas";const d=lt(o,e,t+8e3,20),u=Math.min(1,r/(n*8)),f=d*u>.55;let m;if(c==="drowned_depths"?i<.35?m=6:i<.42?m=3:i<.5&&s>.5?m=6:i<.65?m=0:i<.75?m=1:m=2:c==="ashlands"?i<.1?m=6:i<.25?m=1:i<.45?m=2:i<.55&&a>.6?m=1:i<.7?m=2:m=0:c==="bone_wastes"?i<.15?m=6:i<.35?m=1:i<.55?m=2:i<.7&&s<.4?m=1:i<.7?m=2:m=0:c==="the_void"?i<.2?m=6:i<.4?m=2:a>.7?m=9:m=1:c==="edilas"?i<.12?m=6:i<.18?m=3:i<.75?m=0:m=5:i<.18?m=6:i<.22?m=3:i<.3?m=s>.55?0:1:i<.55?a>.72&&s<.4?m=1:a>.78?m=2:m=0:i<.65?m=s>.5?0:1:i<.78?m=a>.5?2:1:m=2,f&&m!==6&&(m=9),r<35&&m!==6&&m!==9){const p=Math.atan2(e,o),g=[0,Math.PI/2,Math.PI,-Math.PI/2];for(const b of g)if(Math.abs((p-b+Math.PI)%(Math.PI*2)-Math.PI)<.12&&r>3&&r<30){m=5;break}const y=lt(o,e,t+5e3,3),S=lt(o,e,t+5500,5);(y>.62||S>.68)&&(m===0||m===1)&&(m=5)}if(m!==9){const p=lt(o,e,t+1e4,18),g=lt(o,e,t+10500,6),y=Math.atan2(e,o)-Math.PI*.3,S=Math.atan2(e,o)+Math.PI*.7,b=Math.abs(Math.sin(y*3+p*2)),w=Math.abs(Math.sin(S*2.5+g*1.5)),k=.04+g*.02;(b<k||w<k)&&r>8&&r<n*8&&(m=6)}if(r>25&&r<n*9&&m!==6&&m!==9){const p=lt(o,e,t+7e3,8),g=Math.atan2(e,o),y=[Math.PI/4,3*Math.PI/4,-Math.PI/4,-3*Math.PI/4];for(const S of y)if(Math.abs((g-S+Math.PI)%(Math.PI*2)-Math.PI)<.06&&p>.45){m=5;break}}const _=Math.abs((o*7+e*13+t)%4);return{type:m,biome:c,variant:_}}const Ng={head:null,chest:null,legs:null,boots:null,gloves:null,cape:null,ring:null,amulet:null,weapon:null,tool:null};class Og{_slots;_hotbar;_equipment;_gold;capacity;constructor(e=36){this.capacity=e,this._slots=new Array(e).fill(null),this._hotbar=new Array(9).fill(null),this._equipment={...Ng},this._gold=100}get gold(){return this._gold}get slots(){return this._slots}get hotbar(){return this._hotbar}get equipment(){return this._equipment}getSlot(e){return this._slots[e]??null}getHotbarSlot(e){return this._hotbar[e]??null}toggleFavorite(e){const t=this._slots[e];return t?(t.favorite=!t.favorite,t.favorite):!1}isFavorite(e){return this._slots[e]?.favorite===!0}setGold(e){this._gold=Math.max(0,e)}addGold(e){this._gold=Math.max(0,this._gold+e)}removeGold(e){return this._gold<e?!1:(this._gold-=e,!0)}canAddItem(e,t=1){const i=pe(e);if(!i)return!1;let s=t;if(i.stackable)for(let a=0;a<this._slots.length&&s>0;a++){const r=this._slots[a];r&&r.itemId===e&&r.count<i.maxStack&&(s-=i.maxStack-r.count)}for(let a=0;a<this._slots.length&&s>0;a++)this._slots[a]===null&&(s-=i.stackable?i.maxStack:1);return s<=0}addItem(e,t=1){const i=pe(e);if(!i)return t;let s=t;if(i.stackable)for(let a=0;a<this._slots.length&&s>0;a++){const r=this._slots[a];if(r&&r.itemId===e&&r.count<i.maxStack){const n=i.maxStack-r.count,l=Math.min(s,n);r.count+=l,s-=l}}for(;s>0;){const a=this._slots.indexOf(null);if(a===-1)break;const r=i.stackable?Math.min(s,i.maxStack):1;this._slots[a]={itemId:e,count:r},s-=r}return s}addItemWithAffixes(e,t,i){let s=t;for(;s>0;){const a=this._slots.indexOf(null);if(a===-1)break;this._slots[a]={itemId:e,count:1,affixes:[...i]},s--}return s}removeItem(e,t=1){if(this.countItem(e)<t)return!1;let s=t;for(let a=this._slots.length-1;a>=0&&s>0;a--){const r=this._slots[a];if(r&&r.itemId===e){const n=Math.min(s,r.count);r.count-=n,s-=n,r.count<=0&&(this._slots[a]=null)}}return!0}removeSlot(e,t=1){const i=this._slots[e];return i?t>=i.count?(this._slots[e]=null,i):(i.count-=t,{itemId:i.itemId,count:t}):null}countItem(e){let t=0;for(const i of this._slots)i&&i.itemId===e&&(t+=i.count);return t}hasItem(e,t=1){return this.countItem(e)>=t}isFull(){return this._slots.every(e=>e!==null)}firstEmptySlot(){return this._slots.indexOf(null)}assignToHotbar(e,t){t<0||t>=9||(this._hotbar[t]=this._slots[e]??null)}clearHotbar(e){e>=0&&e<9&&(this._hotbar[e]=null)}equip(e){const t=this._slots[e];if(!t)return!1;const i=pe(t.itemId);if(!i)return!1;if(i.category==="weapon")return this._equipment.weapon&&this.addItem(this._equipment.weapon.itemId,this._equipment.weapon.count)>0?!1:(this._equipment.weapon={...t},this._slots[e]=null,!0);if(i.category==="tool")return this._equipment.tool&&this.addItem(this._equipment.tool.itemId,this._equipment.tool.count)>0?!1:(this._equipment.tool={...t},this._slots[e]=null,!0);if(i.category==="armor"&&i.armorSlot){const s=i.armorSlot,a=this._equipment[s];return a&&this.addItem(a.itemId,a.count)>0?!1:(this._equipment[s]={...t},this._slots[e]=null,!0)}return!1}unequip(e){const t=this._equipment[e];return!t||this.addItem(t.itemId,t.count)>0?!1:(this._equipment[e]=null,!0)}getEquipmentStats(){const e={damage:0,defense:0,health:0,stamina:0,speed:0,critChance:0,critDamage:0,purification:0};for(const t of Object.values(this._equipment)){if(!t)continue;const i=pe(t.itemId);if(i?.stats&&(e.damage+=i.stats.damage??0,e.defense+=i.stats.defense??0,e.health+=i.stats.health??0,e.stamina+=i.stats.stamina??0,e.speed+=i.stats.speed??0,e.critChance+=i.stats.critChance??0,e.critDamage+=i.stats.critDamage??0,e.purification+=i.stats.purification??0),t.affixes)for(const s of t.affixes){const a=s.stat;a in e&&(e[a]+=s.value)}}return e}swapSlots(e,t){const i=this._slots[e]??null;this._slots[e]=this._slots[t]??null,this._slots[t]=i}sort(){const e=this._slots.filter(s=>s!==null),t={weapon:0,armor:1,accessory:2,tool:3,potion:4,food:5,consumable:6,material:7,ore:8,gem:9,seed:10,key:11,quest:12,relic:13,trophy:14,misc:15},i={mythic:0,legendary:1,epic:2,rare:3,uncommon:4,common:5};e.sort((s,a)=>{const r=pe(s.itemId),n=pe(a.itemId);if(!r||!n)return 0;const l=(t[r.category]??99)-(t[n.category]??99);if(l!==0)return l;const h=(i[r.rarity]??99)-(i[n.rarity]??99);return h!==0?h:r.name.localeCompare(n.name)}),this._slots=new Array(this.capacity).fill(null);for(let s=0;s<e.length&&s<this.capacity;s++)this._slots[s]=e[s]}serialize(){return{slots:this._slots,hotbar:this._hotbar,equipment:this._equipment,gold:this._gold}}deserialize(e){this._slots=e.slots,this._hotbar=e.hotbar,this._equipment=e.equipment,this._gold=e.gold}}const ti={haven:{id:"haven",name:"Haven",icon:"",order:0,description:"A peaceful settlement. The last bastion of uncorrupted land.",baseCorruption:.05,temperature:20,dangerLevel:1,enemies:["slime","mushroom_spirit","goblin_slinger"],resources:["wood","stone","iron_ore","herb","fiber"],tileColors:{grass:"#4a8c3f",dirt:"#8b7355",water:"#3366aa",sand:"#c4b078",rock:"#6a6a6a",corruption:"#3a1a3a"},ambientMusic:"calm",ambient:{particleColor:"#88cc66",particleType:"sparkle",particleCount:18,fogTint:"#f0f8e8",fogAlpha:.03,borderGlow:"#66aa44"}},rotwood:{id:"rotwood",name:"Rotwood",icon:"",order:1,description:"A corrupted forest teeming with fungal beasts and spore nests.",baseCorruption:.4,temperature:15,dangerLevel:3,enemies:["slime","red_slime","mushroom_spirit","wolf","goblin_berserker","goblin_slinger","possessed"],resources:["wood","herb","spore_cap","iron_ore","fiber"],titanId:"forest_titan",coreGuardianId:"sporelord",factionId:"fungal",unlockRequirement:"ms_first_blade",tileColors:{grass:"#3a6a2a",dirt:"#5a4a30",water:"#2a4a3a",sand:"#6a5a40",rock:"#4a4a3a",corruption:"#2a4a1a"},ambientMusic:"dungeon",ambient:{particleColor:"#66aa33",particleType:"spore",particleCount:20,fogTint:"#1a3a0a",fogAlpha:.08,borderGlow:"#3a6a1a"}},ashlands:{id:"ashlands",name:"Ashlands",icon:"",order:2,description:"A volcanic wasteland ruled by fire cultists and magma golems.",baseCorruption:.5,temperature:45,dangerLevel:5,enemies:["red_slime","cultist","skeleton_grunt","shadow_wisp"],resources:["stone","iron_ore","gold_ore","ruby"],titanId:"lava_titan",coreGuardianId:"flame_lord",factionId:"cultist",unlockRequirement:"ms_rotwood_core",tileColors:{grass:"#4a3a2a",dirt:"#6a4a2a",water:"#aa4400",sand:"#8a6a40",rock:"#5a3a2a",corruption:"#6a1a0a"},ambientMusic:"combat",ambient:{particleColor:"#ff6622",particleType:"ember",particleCount:25,fogTint:"#3a1a00",fogAlpha:.1,borderGlow:"#aa4400"}},drowned_depths:{id:"drowned_depths",name:"Drowned Depths",icon:"",order:3,description:"Flooded ruins haunted by undead sailors and sea monsters.",baseCorruption:.55,temperature:10,dangerLevel:6,enemies:["skeleton_grunt","skeleton_hunter","possessed","shadow_wisp"],resources:["stone","gold_ore","sapphire","corruption_essence"],titanId:"sea_leviathan",coreGuardianId:"drowned_admiral",factionId:"undead",unlockRequirement:"ms_ashlands_core",tileColors:{grass:"#2a4a4a",dirt:"#3a4a5a",water:"#1a3a5a",sand:"#5a6a7a",rock:"#3a3a4a",corruption:"#1a2a4a"},ambientMusic:"dungeon",ambient:{particleColor:"#4488cc",particleType:"bubble",particleCount:18,fogTint:"#0a1a3a",fogAlpha:.12,borderGlow:"#2255aa"}},bone_wastes:{id:"bone_wastes",name:"Bone Wastes",icon:"",order:4,description:"A desolate graveyard under the necromancers' control.",baseCorruption:.7,temperature:-5,dangerLevel:8,enemies:["skeleton_grunt","skeleton_hunter","cultist","shadow_wisp"],resources:["bone_fragment","corruption_essence","void_shard","emerald"],titanId:"bone_colossus",coreGuardianId:"lich_empress",factionId:"necro",unlockRequirement:"ms_drowned_core",tileColors:{grass:"#3a3a2a",dirt:"#5a5a4a",water:"#2a2a3a",sand:"#6a6a5a",rock:"#4a4a4a",corruption:"#3a2a3a"},ambientMusic:"boss",ambient:{particleColor:"#aaaaaa",particleType:"dust",particleCount:15,fogTint:"#2a2a2a",fogAlpha:.15,borderGlow:"#555555"}},the_void:{id:"the_void",name:"The Void",icon:"",order:5,description:"Reality itself fractures here. The final biome before EDILAS.",baseCorruption:.9,temperature:0,dangerLevel:10,enemies:["shadow_wisp","skeleton_grunt","skeleton_hunter","cultist","possessed"],resources:["void_shard","void_gem","corruption_essence"],titanId:"void_serpent",coreGuardianId:"void_emperor",factionId:"void",unlockRequirement:"ms_bone_core",tileColors:{grass:"#1a0a2a",dirt:"#2a1a3a",water:"#0a0a3a",sand:"#3a2a4a",rock:"#2a2a3a",corruption:"#4a0a4a"},ambientMusic:"boss",ambient:{particleColor:"#8800ff",particleType:"wisp",particleCount:12,fogTint:"#1a0a2a",fogAlpha:.2,borderGlow:"#6600cc"}},edilas:{id:"edilas",name:"EDILAS",icon:"",order:6,description:"The mythical destination. The end of the pilgrimage.",baseCorruption:0,temperature:22,dangerLevel:0,enemies:[],resources:[],unlockRequirement:"ms_void_core",tileColors:{grass:"#6aaa5a",dirt:"#aa9a7a",water:"#4488cc",sand:"#ddc888",rock:"#8a8a8a",corruption:"#ffffff"},ambientMusic:"calm",ambient:{particleColor:"#ffdd88",particleType:"sparkle",particleCount:30,fogTint:"#ffffee",fogAlpha:.05,borderGlow:"#ffcc44"}}};function Js(o,e){const t=o/32,i=e/32,s=Math.sqrt(t*t+i*i),a=40;return s<a?ti.haven:s<a*2.5?ti.rotwood:s<a*4?ti.ashlands:s<a*5.5?ti.drowned_depths:s<a*7?ti.bone_wastes:s<a*9?ti.the_void:ti.edilas}const Cr={spike:{type:"spike",damage:15,cooldown:3,detectionDC:.3,disarmDC:.2,aoeRadius:0},arrow:{type:"arrow",damage:20,cooldown:5,detectionDC:.5,disarmDC:.4,aoeRadius:0},poison_gas:{type:"poison_gas",damage:5,cooldown:8,detectionDC:.4,disarmDC:.5,aoeRadius:2,statusEffect:"poison",statusDuration:8},pitfall:{type:"pitfall",damage:30,cooldown:0,detectionDC:.6,disarmDC:0,aoeRadius:0,statusEffect:"stun",statusDuration:2},boulder:{type:"boulder",damage:40,cooldown:0,detectionDC:.3,disarmDC:0,aoeRadius:1},fire_vent:{type:"fire_vent",damage:25,cooldown:4,detectionDC:.2,disarmDC:.3,aoeRadius:1,statusEffect:"burn",statusDuration:5},ice_spike:{type:"ice_spike",damage:18,cooldown:6,detectionDC:.4,disarmDC:.3,aoeRadius:0,statusEffect:"freeze",statusDuration:3},void_snare:{type:"void_snare",damage:10,cooldown:10,detectionDC:.7,disarmDC:.6,aoeRadius:2,statusEffect:"corruption",statusDuration:10}},Gg={normal:{type:"normal",minSize:[5,5],maxSize:[12,10],enemyCountRange:[1,4],chestChance:.1,trapChance:.3},treasure:{type:"treasure",minSize:[6,6],maxSize:[8,8],enemyCountRange:[2,5],chestChance:1,trapChance:.5,specialFeature:"locked_chest"},trap:{type:"trap",minSize:[5,5],maxSize:[10,8],enemyCountRange:[0,2],chestChance:.3,trapChance:1},boss:{type:"boss",minSize:[10,10],maxSize:[16,14],enemyCountRange:[1,1],chestChance:1,trapChance:0,specialFeature:"boss_gate"},rest:{type:"rest",minSize:[6,6],maxSize:[8,8],enemyCountRange:[0,0],chestChance:0,trapChance:0,specialFeature:"campfire"},shop:{type:"shop",minSize:[6,6],maxSize:[10,8],enemyCountRange:[0,0],chestChance:0,trapChance:0,specialFeature:"merchant"},puzzle:{type:"puzzle",minSize:[7,7],maxSize:[12,10],enemyCountRange:[0,1],chestChance:.8,trapChance:.2,specialFeature:"seal_altar"},entrance:{type:"entrance",minSize:[6,6],maxSize:[8,8],enemyCountRange:[0,0],chestChance:0,trapChance:0}},Hg=[{id:"iron_vein",name:"Iron Vein",itemId:"iron_ore",yieldRange:[2,5],hardness:3,minDungeonLevel:1,themes:["cave","mine","ruins"]},{id:"gold_vein",name:"Gold Vein",itemId:"gold_ore",yieldRange:[1,3],hardness:5,minDungeonLevel:3,themes:["cave","mine"]},{id:"crystal_vein",name:"Crystal Vein",itemId:"gem",yieldRange:[1,2],hardness:6,minDungeonLevel:5,themes:["cave","mine","crypt"]},{id:"void_vein",name:"Void Vein",itemId:"void_shard",yieldRange:[1,2],hardness:8,minDungeonLevel:8,themes:["corruption_core","rift"]},{id:"ember_vein",name:"Ember Vein",itemId:"ember_shard",yieldRange:[1,3],hardness:7,minDungeonLevel:6,themes:["cave","rift"]}],nd={cave:{wallColor:"#3a3528",floorColor:"#645a48",accentColor:"#8a7a5a",doorColor:"#6a5a3a",trapColor:"#886644",enemies:["slime","mushroom_spirit","goblin_slinger"],bossId:"cave_troll"},ruins:{wallColor:"#4a4a50",floorColor:"#686870",accentColor:"#8888a0",doorColor:"#5a5a60",trapColor:"#666688",enemies:["skeleton_grunt","skeleton_hunter","shadow_wisp"],bossId:"ancient_guardian"},crypt:{wallColor:"#2a2a30",floorColor:"#484850",accentColor:"#6868a0",doorColor:"#3a3a50",trapColor:"#5050aa",enemies:["skeleton_grunt","skeleton_hunter","cultist"],bossId:"lich_king"},mine:{wallColor:"#4a3a2a",floorColor:"#685a48",accentColor:"#887040",doorColor:"#5a4a30",trapColor:"#886644",enemies:["slime","red_slime","goblin_berserker"],bossId:"mine_golem"},corruption_core:{wallColor:"#2a0a2a",floorColor:"#4a1a4a",accentColor:"#8a40aa",doorColor:"#5a2060",trapColor:"#aa44cc",enemies:["cultist","possessed","shadow_wisp"],bossId:"sporelord"},rift:{wallColor:"#0a0a2a",floorColor:"#1a1a4a",accentColor:"#4040aa",doorColor:"#2020a0",trapColor:"#6060ff",enemies:["shadow_wisp","skeleton_grunt","goblin_berserker","cultist"],bossId:"void_walker"},sewer:{wallColor:"#2a3a2a",floorColor:"#3a5a3a",accentColor:"#4a8a4a",doorColor:"#3a5a3a",trapColor:"#448844",enemies:["slime","red_slime","goblin_slinger"],bossId:"sewer_king"}};class ld{_rng;constructor(e){this._rng=this._seededRandom(e)}generate(e,t,i=8,s=1){const a=60+t*5,r=50+t*4,n=[];for(let _=0;_<r;_++){n[_]=[];for(let p=0;p<a;p++)n[_][p]="wall"}const l=[],h=500,c=this._createRoom(5,5,8,8,"entrance");this._carveRoom(n,c),l.push(c);for(let _=0;_<h&&l.length<i;_++){const p=5+Math.floor(this._rng()*8),g=5+Math.floor(this._rng()*6),y=2+Math.floor(this._rng()*(a-p-4)),S=2+Math.floor(this._rng()*(r-g-4)),b=this._createRoom(y,S,p,g,"normal");let w=!1;for(const k of l)if(this._roomsOverlap(b,k,2)){w=!0;break}w||(this._carveRoom(n,b),l.push(b))}if(l.length>=3){if(l[l.length-1].type="boss",l.length>=5&&(l[Math.floor(l.length/2)].type="treasure"),l.length>=6&&(l[Math.floor(l.length*.3)].type="rest"),l.length>=7){const _=Math.floor(l.length*.6);l[_].type==="normal"&&(l[_].type="shop")}if(l.length>=8){const _=Math.floor(l.length*.75);l[_].type==="normal"&&(l[_].type="puzzle")}}for(let _=1;_<l.length;_++){const p=l[_-1],g=l[_];this._carveCorridor(n,p,g)}this._placeDoors(n,l);const d=nd[e];for(const _ of l){if(_.type==="entrance"||_.type==="rest"||_.type==="shop")continue;const p=Gg[_.type],[g,y]=p.enemyCountRange,S=_.type==="boss"?1:g+Math.floor(this._rng()*(y-g+1+t*.3));for(let b=0;b<S;b++){const w=_.type==="boss"?d.bossId:d.enemies[Math.floor(this._rng()*d.enemies.length)];_.enemies.push({type:w,x:_.x+1+Math.floor(this._rng()*Math.max(1,_.width-2)),y:_.y+1+Math.floor(this._rng()*Math.max(1,_.height-2))})}if(_.type==="treasure"){const b=1+Math.floor(s*.5+this._rng()*1.5);for(let w=0;w<b;w++){const k=_.x+1+Math.floor(this._rng()*Math.max(1,_.width-2)),T=_.y+1+Math.floor(this._rng()*Math.max(1,_.height-2));n[T]?.[k]==="floor"&&(n[T][k]="chest",_.loot.push({itemId:this._rollLootItem(t,s),count:1+Math.floor(this._rng()*3*s),x:k,y:T}))}}if(this._rng()<p.trapChance){const b=_.x+1+Math.floor(this._rng()*(_.width-2)),w=_.y+1+Math.floor(this._rng()*(_.height-2));n[w][b]="trap"}}if(Hg.filter(_=>_.minDungeonLevel<=t&&_.themes.includes(e)).length>0){const _=2+Math.floor(this._rng()*3);for(let p=0;p<_;p++){const g=2+Math.floor(this._rng()*(a-4)),y=2+Math.floor(this._rng()*(r-4));n[y]?.[g]==="wall"&&[n[y-1]?.[g],n[y+1]?.[g],n[y]?.[g-1],n[y]?.[g+1]].some(b=>b==="floor")&&(n[y][g]="ore_vein")}}if(t>=3&&l.length>=5){let _=1+Math.floor(this._rng()*2),p=0;for(let g=0;g<_*10&&p<_;g++){const y=2+Math.floor(this._rng()*(a-4)),S=2+Math.floor(this._rng()*(r-4));if(n[S]?.[y]==="wall"){const b=n[S]?.[y-1]==="floor"&&n[S]?.[y+1]==="floor",w=n[S-1]?.[y]==="floor"&&n[S+1]?.[y]==="floor";(b||w)&&(n[S][y]="hidden_wall",p++)}}}const f=l[0];n[f.y+1][f.x+1]="stairs_up";const m=l.find(_=>_.type==="boss");if(m){n[m.y+Math.floor(m.height/2)][m.x+Math.floor(m.width/2)]="stairs_down";const _={x:m.x,y:m.y+Math.floor(m.height/2)};_.x>0&&_.y>0&&(n[_.y][_.x]="boss_gate");const p=m.x+Math.floor(m.width/2)+1,g=m.y+Math.floor(m.height/2)-1;if(n[g]?.[p]==="floor"){n[g][p]="chest";const y=2+Math.floor(this._rng()*2);for(let S=0;S<y;S++)m.loot.push({itemId:this._rollLootItem(t+3,s*1.5),count:1+Math.floor(this._rng()*2),x:p,y:g})}}return{width:a,height:r,tiles:n,rooms:l,spawnX:f.x+Math.floor(f.width/2),spawnY:f.y+Math.floor(f.height/2),theme:e,level:t,bossDefeated:!1}}_createRoom(e,t,i,s,a){return{x:e,y:t,width:i,height:s,type:a,enemies:[],loot:[],cleared:!1}}_carveRoom(e,t){for(let i=t.y;i<t.y+t.height;i++)for(let s=t.x;s<t.x+t.width;s++)e[i]&&e[i][s]!==void 0&&(e[i][s]="floor")}_carveCorridor(e,t,i){const s=t.x+Math.floor(t.width/2),a=t.y+Math.floor(t.height/2),r=i.x+Math.floor(i.width/2),n=i.y+Math.floor(i.height/2);let l=s,h=a;for(;l!==r;)e[h]&&e[h][l]!==void 0&&(e[h][l]="floor",e[h+1]&&e[h+1][l]!==void 0&&(e[h+1][l]="floor")),l+=l<r?1:-1;for(;h!==n;)e[h]&&e[h][l]!==void 0&&(e[h][l]="floor",e[h][l+1]!==void 0&&(e[h][l+1]="floor")),h+=h<n?1:-1}_placeDoors(e,t){for(const i of t){for(let s=i.x;s<i.x+i.width;s++){i.y>0&&e[i.y-1]?.[s]==="floor"&&e[i.y]?.[s]==="floor"&&this._rng()<.3&&(e[i.y][s]="door");const a=i.y+i.height-1;e[a+1]?.[s]==="floor"&&e[a]?.[s]==="floor"&&this._rng()<.3&&(e[a][s]="door")}for(let s=i.y;s<i.y+i.height;s++){i.x>0&&e[s]?.[i.x-1]==="floor"&&e[s]?.[i.x]==="floor"&&this._rng()<.3&&(e[s][i.x]="door");const a=i.x+i.width-1;e[s]?.[a+1]==="floor"&&e[s]?.[a]==="floor"&&this._rng()<.3&&(e[s][a]="door")}}}_roomsOverlap(e,t,i){return!(e.x+e.width+i<=t.x||t.x+t.width+i<=e.x||e.y+e.height+i<=t.y||t.y+t.height+i<=e.y)}_rollLootItem(e,t=1){const i=[{itemId:"health_potion",weight:30},{itemId:"iron_ore",weight:20},{itemId:"gold_ore",weight:10*t},{itemId:"herb",weight:15},{itemId:"slime_gel",weight:10},{itemId:"gem",weight:(5+e)*t},{itemId:"dungeon_key",weight:3*t},{itemId:"void_shard",weight:Math.max(0,e-3)*t},{itemId:"ember_shard",weight:Math.max(0,e-5)*t},{itemId:"ancient_relic",weight:Math.max(0,e-8)*t},{itemId:"soul_fragment",weight:Math.max(0,e-10)*t},{itemId:"spirit_essence",weight:Math.max(0,e-12)*t}],s=i.reduce((r,n)=>r+n.weight,0);let a=this._rng()*s;for(const r of i)if(a-=r.weight,a<=0)return r.itemId;return"health_potion"}_seededRandom(e){let t=e;return()=>{t|=0,t=t+1831565813|0;let i=Math.imul(t^t>>>15,1|t);return i=i+Math.imul(i^i>>>7,61|i)^i,((i^i>>>14)>>>0)/4294967296}}}class zg{_tileSize=16;_spriteRegistry=null;setSpriteRegistry(e){this._spriteRegistry=e}_drawTileSprite(e,t,i,s,a,r){if(!this._spriteRegistry)return!1;const n=ka[t];if(!n)return!1;const l=this._spriteRegistry.getSprite(n);return!l||!l.complete||l.naturalWidth===0?!1:(e.drawImage(l,i,s,a,r),!0)}_drawItemSprite(e,t,i,s,a,r){if(!this._spriteRegistry)return!1;const n=this._spriteRegistry.getItemSprite(t);return!n||!n.complete||n.naturalWidth===0?!1:(e.drawImage(n,i,s,a,r),!0)}_floorVariant(e,t,i=0){return((e*73856093^t*19349663^i*83492791)>>>0)%8+1}render(e,t,i,s,a,r){const n=nd[t.theme],l=this._tileSize,h=Math.max(0,Math.floor((i-a/2)/l)),c=Math.min(t.width,Math.ceil((i+a/2)/l)+1),d=Math.max(0,Math.floor((s-r/2)/l)),u=Math.min(t.height,Math.ceil((s+r/2)/l)+1),f=a/2-i,m=r/2-s,_=Date.now();for(let p=d;p<u;p++){const g=t.tiles[p];if(g)for(let y=h;y<c;y++){const S=g[y];if(!S)continue;const b=y*l+f,w=p*l+m;switch(S){case"wall":{const k=t.tiles[p+1]?.[y],T=k&&k!=="wall"?"wall_mid":"wall_top_mid";this._drawTileSprite(e,T,b,w,l,l)||(e.fillStyle=n.wallColor,e.fillRect(b,w,l,l),e.fillStyle="rgba(255,255,255,0.05)",e.fillRect(b,w,l,1),e.fillRect(b,w,1,l));break}case"floor":{const k=this._floorVariant(y,p,t.level);this._drawTileSprite(e,`floor_${k}`,b,w,l,l)||(e.fillStyle=n.floorColor,e.fillRect(b,w,l,l),e.strokeStyle="rgba(0,0,0,0.1)",e.strokeRect(b,w,l,l));break}case"door":{this._drawTileSprite(e,`floor_${this._floorVariant(y,p,t.level)}`,b,w,l,l),this._drawTileSprite(e,"door_closed",b,w,l,l)||(e.fillStyle=n.doorColor,e.fillRect(b,w,l,l),e.fillStyle="#aa8844",e.fillRect(b+2,w+2,l-4,l-4));break}case"chest":{this._drawTileSprite(e,`floor_${this._floorVariant(y,p,t.level)}`,b,w,l,l),this._drawTileSprite(e,"chest_full_f0",b,w,l,l)||(e.fillStyle="#cc9922",e.fillRect(b+3,w+4,l-6,l-6),e.fillStyle="#ffcc66",e.fillRect(b+4,w+5,l-8,l-8));break}case"trap":{this._drawTileSprite(e,`floor_${this._floorVariant(y,p,t.level)}`,b,w,l,l);const k=Math.floor(_/400%4);if(!this._drawTileSprite(e,`spikes_f${k}`,b,w,l,l)){e.fillStyle=n.trapColor;for(let T=0;T<3;T++)e.beginPath(),e.moveTo(b+3+T*5,w+l-2),e.lineTo(b+5+T*5,w+4),e.lineTo(b+7+T*5,w+l-2),e.fill()}break}case"stairs_up":{if(this._drawTileSprite(e,`floor_${this._floorVariant(y,p,t.level)}`,b,w,l,l),!this._drawTileSprite(e,"stairs",b,w,l,l)){e.fillStyle=n.accentColor;for(let k=0;k<4;k++)e.fillRect(b+2,w+2+k*3,l-4,2)}break}case"stairs_down":{if(this._drawTileSprite(e,`floor_${this._floorVariant(y,p,t.level)}`,b,w,l,l),!this._drawTileSprite(e,"ladder",b,w,l,l)){e.fillStyle="#222",e.fillRect(b+3,w+3,l-6,l-6),e.fillStyle=n.accentColor;for(let k=0;k<3;k++)e.fillRect(b+4,w+4+k*3,l-8,2)}break}case"boss_gate":{this._drawTileSprite(e,"wall_mid",b,w,l,l)||(e.fillStyle="#441122",e.fillRect(b,w,l,l)),!this._drawTileSprite(e,"skull",b+2,w+2,l-4,l-4)&&!this._drawItemSprite(e,"corruption_core",b+2,w+2,l-4,l-4)&&!this._drawItemSprite(e,"void_shard",b+2,w+2,l-4,l-4)&&(e.fillStyle="#ff4444",e.font=`${l-4}px serif`,e.textAlign="center",e.fillText("",b+l/2,w+l-2)),e.fillStyle="rgba(255,0,0,0.15)",e.fillRect(b,w,l,l);break}case"corruption":{this._drawTileSprite(e,`floor_${this._floorVariant(y,p,t.level)}`,b,w,l,l),this._drawTileSprite(e,"wall_goo",b,w,l,l);const k=Math.sin(_*.003)*.15;e.fillStyle=`rgba(160,0,160,${.25+k})`,e.fillRect(b,w,l,l);break}case"water":e.fillStyle="#223388",e.fillRect(b,w,l,l),e.fillStyle=`rgba(100,150,255,${.3+Math.sin(_*.002+y)*.1})`,e.fillRect(b,w,l,l);break;case"lava":{e.fillStyle="#882200",e.fillRect(b,w,l,l);const k=Math.sin(_*.004+y*.5+p*.3)*.15;e.fillStyle=`rgba(255,100,0,${.4+k})`,e.fillRect(b,w,l,l),e.fillStyle="#ffcc00",Math.sin(_*.01+y*p)>.8&&e.fillRect(b+l*.3,w+l*.4,2,2);break}case"ice":e.fillStyle="#aaccee",e.fillRect(b,w,l,l),e.fillStyle=`rgba(200,230,255,${.3+Math.sin(_*.001+y)*.1})`,e.fillRect(b,w,l,l),e.strokeStyle="rgba(255,255,255,0.15)",e.beginPath(),e.moveTo(b+2,w+l-2),e.lineTo(b+l-2,w+2),e.stroke();break;case"seal_altar":{this._drawTileSprite(e,`floor_${this._floorVariant(y,p,t.level)}`,b,w,l,l),!this._drawTileSprite(e,"column",b,w-l*.3,l,l*1.3)&&!this._drawItemSprite(e,"purification_crystal",b+3,w+1,l-6,l-6)&&(e.strokeStyle="#8866ff",e.lineWidth=1,e.beginPath(),e.arc(b+l/2,w+l/2,l*.35,0,Math.PI*2),e.stroke());const k=Math.sin(_*.003)*.2;e.fillStyle=`rgba(136,102,255,${.2+k})`,e.beginPath(),e.arc(b+l/2,w+l/2,l*.35,0,Math.PI*2),e.fill();break}case"ore_vein":{this._drawTileSprite(e,"wall_mid",b,w,l,l)||(e.fillStyle=n.wallColor,e.fillRect(b,w,l,l)),e.fillStyle="#ccaa44",e.fillRect(b+3,w+4,3,2),e.fillRect(b+8,w+7,2,3),e.fillRect(b+5,w+11,3,2),Math.sin(_*.005+y*7+p*3)>.7&&(e.fillStyle="rgba(255,215,0,0.4)",e.fillRect(b+6,w+5,2,2));break}case"hidden_wall":{this._drawTileSprite(e,"wall_top_mid",b,w,l,l)||(e.fillStyle=n.wallColor,e.fillRect(b,w,l,l)),e.strokeStyle="rgba(255,255,255,0.06)",e.lineWidth=.5,e.beginPath(),e.moveTo(b+3,w+2),e.lineTo(b+7,w+8),e.lineTo(b+5,w+14),e.stroke(),e.beginPath(),e.moveTo(b+11,w+4),e.lineTo(b+9,w+10),e.stroke();break}}}}}static triggerTrap(e,t){const i=Cr[e],s=Math.min(.8,t*.03);return Math.random()<s?{damage:0,avoided:!0}:{damage:i.damage,statusEffect:i.statusEffect,statusDuration:i.statusDuration,avoided:!1}}static detectTrap(e,t){const i=Cr[e];return Math.random()+t>i.detectionDC}static disarmTrap(e,t){const i=Cr[e];return i.disarmDC<=0?!1:Math.random()+t>i.disarmDC}}function ki(o,e){const t=[];for(let i=0;i<e;i++){const s=[];for(let a=0;a<o;a++)i===0||i===e-1||a===0||a===o-1?s.push("wall"):s.push("floor");t.push(s)}return t}function De(o,e,t,i){o[t]&&e>=0&&e<o[t].length&&(o[t][e]=i)}const Xg={elder_house:(()=>{const t=ki(10,8);De(t,4,7,"door"),De(t,2,0,"window"),De(t,7,0,"window"),De(t,5,1,"fireplace");for(let i=3;i<=5;i++)for(let s=3;s<=6;s++)De(t,s,i,"rug");return{id:"elder_house",name:"Elder Miriam's Home",width:10,height:8,tiles:t,furniture:[{x:1,y:1,type:"bookshelf",icon:"",interactable:!0,interactAction:"read_lore"},{x:8,y:1,type:"table",icon:"",interactable:!1},{x:1,y:6,type:"bed",icon:"",interactable:!0,interactAction:"sleep"},{x:8,y:6,type:"chest",icon:"",interactable:!0,interactAction:"storage"},{x:4,y:2,type:"candle",icon:"",interactable:!1}],npcPositions:[{npcId:"elder_miriam",x:4,y:3,facing:"down"}],ambientLight:.6,musicMood:"calm"}})(),smithy:(()=>{const t=ki(12,8);De(t,5,7,"door"),De(t,3,0,"window"),De(t,9,0,"window");for(let i=2;i<=9;i++)De(t,i,3,"counter");return{id:"smithy",name:"Garrett's Smithy",width:12,height:8,tiles:t,furniture:[{x:1,y:1,type:"anvil",icon:"",interactable:!0,interactAction:"craft_weapon"},{x:3,y:1,type:"forge",icon:"",interactable:!0,interactAction:"smelt"},{x:7,y:1,type:"grindstone",icon:"",interactable:!0,interactAction:"sharpen"},{x:10,y:1,type:"weapon_rack",icon:"",interactable:!0,interactAction:"browse_weapons"},{x:5,y:5,type:"barrel",icon:"",interactable:!1},{x:10,y:6,type:"chest",icon:"",interactable:!0,interactAction:"storage"}],npcPositions:[{npcId:"garrett",x:5,y:2,facing:"down"}],ambientLight:.5,musicMood:"calm"}})(),general_store:(()=>{const t=ki(10,8);De(t,4,7,"door");for(let i=2;i<=7;i++)De(t,i,4,"counter");return{id:"general_store",name:"Martha's General Store",width:10,height:8,tiles:t,furniture:[{x:1,y:1,type:"shelf",icon:"",interactable:!1},{x:3,y:1,type:"shelf",icon:"",interactable:!1},{x:5,y:1,type:"shelf",icon:"",interactable:!1},{x:7,y:1,type:"shelf",icon:"",interactable:!1},{x:8,y:1,type:"shelf",icon:"",interactable:!1},{x:4,y:3,type:"register",icon:"",interactable:!0,interactAction:"shop"}],npcPositions:[{npcId:"martha",x:4,y:3,facing:"down"}],ambientLight:.7,musicMood:"calm"}})(),tavern:(()=>{const t=ki(14,10);De(t,6,9,"door"),De(t,2,0,"window"),De(t,11,0,"window");for(let i=2;i<=6;i++)De(t,i,3,"counter");De(t,12,1,"fireplace");for(let i=2;i<=3;i++)for(let s=10;s<=12;s++)De(t,s,i,"rug");return{id:"tavern",name:"Harold's Tavern",width:14,height:10,tiles:t,furniture:[{x:4,y:2,type:"barrel",icon:"",interactable:!1},{x:2,y:5,type:"table",icon:"",interactable:!0,interactAction:"sit"},{x:6,y:5,type:"table",icon:"",interactable:!0,interactAction:"sit"},{x:10,y:5,type:"table",icon:"",interactable:!0,interactAction:"dice_game"},{x:6,y:8,type:"stage",icon:"",interactable:!0,interactAction:"listen_music"},{x:3,y:2,type:"tap",icon:"",interactable:!0,interactAction:"buy_drink"}],npcPositions:[{npcId:"harold",x:3,y:2,facing:"down"}],ambientLight:.5,musicMood:"calm"}})(),apothecary:(()=>{const t=ki(8,8);De(t,3,7,"door"),De(t,2,0,"window"),De(t,5,0,"window");for(let i=2;i<=5;i++)De(t,i,4,"counter");return{id:"apothecary",name:"Lily's Apothecary",width:8,height:8,tiles:t,furniture:[{x:1,y:1,type:"herb_rack",icon:"",interactable:!1},{x:3,y:1,type:"cauldron",icon:"",interactable:!0,interactAction:"brew_potion"},{x:6,y:1,type:"herb_rack",icon:"",interactable:!1},{x:3,y:3,type:"mortar",icon:"",interactable:!0,interactAction:"alchemy"},{x:6,y:6,type:"chest",icon:"",interactable:!0,interactAction:"storage"}],npcPositions:[{npcId:"lily",x:3,y:3,facing:"down"}],ambientLight:.6,musicMood:"calm"}})(),dungeon_entrance:(()=>{const t=ki(8,8);return De(t,3,7,"door"),De(t,3,0,"stairs"),{id:"dungeon_entrance",name:"Dungeon Entrance",width:8,height:8,tiles:t,furniture:[{x:1,y:1,type:"torch",icon:"",interactable:!1},{x:6,y:1,type:"torch",icon:"",interactable:!1},{x:3,y:1,type:"stairs_down",icon:"",interactable:!0,interactAction:"enter_dungeon"},{x:1,y:6,type:"sign",icon:"",interactable:!0,interactAction:"read_warning"}],npcPositions:[],ambientLight:.3,musicMood:"dungeon"}})()};class Vg{_currentInterior=null;_playerX=0;_playerY=0;get currentInterior(){return this._currentInterior}get isInInterior(){return this._currentInterior!==null}enter(e,t,i){const s=Xg[e];if(!s)return!1;if(this._currentInterior=s,t!==void 0&&i!==void 0)this._playerX=t,this._playerY=i;else for(let a=0;a<s.height;a++)for(let r=0;r<s.width;r++)if(s.tiles[a]?.[r]==="door")return this._playerX=r,this._playerY=a-1,!0;return!0}exit(){this._currentInterior=null}renderInterior(e,t,i,s){if(!this._currentInterior)return;const a=this._currentInterior,r=Math.min(Math.floor(t/a.width),Math.floor(i/a.height),48),n=(t-a.width*r)/2,l=(i-a.height*r)/2,h={floor:"#5a4a3a",wall:"#3a2a1a",door:"#6a4a2a",window:"#88aacc",counter:"#7a5a3a",rug:"#8a3a3a",fireplace:"#aa4400",stairs:"#444"};for(let c=0;c<a.height;c++)for(let d=0;d<a.width;d++){const u=a.tiles[c]?.[d]??"floor",f=n+d*r,m=l+c*r;let _=!1;if(s){let p=u;u==="floor"&&(d+c)%2===0&&(p="floor_alt");const g=s.getInteriorTilePath(p),y=g?s.getSprite(g):void 0;y&&y.naturalWidth&&(e.drawImage(y,f,m,r,r),_=!0)}if(_||(e.fillStyle=h[u],e.fillRect(f,m,r,r)),e.strokeStyle="rgba(0,0,0,0.15)",e.lineWidth=.5,e.strokeRect(f,m,r,r),u==="rug"&&_&&(e.fillStyle="rgba(140,50,50,0.25)",e.fillRect(f,m,r,r)),u==="fireplace"){const p=.15+Math.sin(Date.now()*.005)*.1;e.fillStyle=`rgba(255,120,0,${p})`,e.beginPath(),e.arc(f+r/2,m+r/2,r*.8,0,Math.PI*2),e.fill()}}e.font=`${r*.6}px serif`,e.textAlign="center";for(const c of a.furniture){const d=n+c.x*r+r/2,u=l+c.y*r+r*.7;e.fillText(c.icon,d,u),c.interactable&&(e.strokeStyle="rgba(129,140,248,0.3)",e.lineWidth=1,e.strokeRect(n+c.x*r+2,l+c.y*r+2,r-4,r-4))}for(const c of a.npcPositions){const d=n+c.x*r+r/2,u=l+c.y*r+r*.7;let f=!1;if(s){const m=s.getNPCSpritePath(c.npcId,"Down","Idle"),_=m?s.getSprite(m):void 0;if(_&&_.naturalWidth){const p=_.naturalWidth/6,g=_.naturalHeight,y=r*.8/g,S=p*y,b=g*y;e.drawImage(_,0,0,p,g,d-S/2,l+c.y*r+r-b,S,b),f=!0}}f||e.fillText("",d,u),e.font="8px monospace",e.fillStyle="#aaa",e.textAlign="center",e.fillText(c.npcId.replace("_"," "),d,u+12),e.font=`${r*.6}px serif`}e.font="bold 14px monospace",e.textAlign="center",e.fillStyle="#e5e7eb",e.fillText(a.name,t/2,l-10)}}const uo=60,hd=24,qg=hd*uo,fo=30,cd=4,Yg=fo*cd,Ug=["spring","summer","autumn","winter"],jg={spring:{sky:"#87CEEB",ambient:"#ffe8c8",tint:[255,245,230]},summer:{sky:"#4DC4FF",ambient:"#fff4d6",tint:[255,250,220]},autumn:{sky:"#E8A06E",ambient:"#ffd8a0",tint:[255,220,180]},winter:{sky:"#A0C4E8",ambient:"#d0e8ff",tint:[210,230,255]}};class Kg{_totalMinutes=360;_timeScale=1;_paused=!1;update(e){this._paused||(this._totalMinutes+=e*this._timeScale)}get totalMinutes(){return this._totalMinutes}get minute(){return Math.floor(this._totalMinutes)%60}get hour(){return Math.floor(this._totalMinutes/uo)%hd}get day(){return Math.floor(this._totalMinutes/qg)+1}get dayOfSeason(){return(this.day-1)%fo+1}get season(){const e=Math.floor((this.day-1)/fo)%cd;return Ug[e]}get year(){return Math.floor((this.day-1)/Yg)+1}get timeOfDay(){const e=this.hour;return e>=5&&e<7?"dawn":e>=7&&e<10?"morning":e>=10&&e<14?"noon":e>=14&&e<17?"afternoon":e>=17&&e<19?"dusk":e>=19&&e<22?"evening":e>=22||e<2?"night":"midnight"}get isNight(){const e=this.hour;return e>=20||e<5}get isDawn(){const e=this.hour;return e>=5&&e<7}get isDusk(){const e=this.hour;return e>=17&&e<20}get isDay(){const e=this.hour;return e>=7&&e<17}get darkness(){const e=this.hour+this.minute/60;return e>=7&&e<=17?0:e>=21||e<=4?.85:e>17&&e<21?(e-17)/4*.85:e>4&&e<7?(1-(e-4)/3)*.85:0}get nightOverlay(){const e=this.darkness;return e<=0?"transparent":`rgba(10, 10, 40, ${e.toFixed(3)})`}get seasonColors(){return jg[this.season]}get timeString(){const e=this.hour,t=this.minute,i=e>=12?"PM":"AM";return`${e%12||12}:${t.toString().padStart(2,"0")} ${i}`}get dateString(){const e=this.season.charAt(0).toUpperCase()+this.season.slice(1);return`Day ${this.dayOfSeason} of ${e}, Year ${this.year}`}pause(){this._paused=!0}resume(){this._paused=!1}get isPaused(){return this._paused}setTimeScale(e){this._timeScale=Math.max(0,e)}get timeScale(){return this._timeScale}skipMinutes(e){this._totalMinutes+=e}skipToHour(e){const t=this.hour;let i=e-t;i<=0&&(i+=24),this._totalMinutes+=i*uo}serialize(){return{totalMinutes:this._totalMinutes,timeScale:this._timeScale}}deserialize(e){this._totalMinutes=e.totalMinutes,this._timeScale=e.timeScale}}const Ji={clear:{name:"Clear",intensity:0,windStrength:0,visibility:1,tint:"transparent",particleCount:0,particleColor:"#fff",lightReduction:0},cloudy:{name:"Cloudy",intensity:.2,windStrength:10,visibility:.9,tint:"rgba(100,100,120,0.08)",particleCount:0,particleColor:"#fff",lightReduction:.05},rain:{name:"Rain",intensity:.5,windStrength:30,visibility:.7,tint:"rgba(60,80,100,0.12)",particleCount:50,particleColor:"#8cb4d4",soundId:"rain",lightReduction:.1},heavy_rain:{name:"Heavy Rain",intensity:.7,windStrength:50,visibility:.5,tint:"rgba(40,60,80,0.2)",particleCount:120,particleColor:"#7aa8c8",soundId:"rain_heavy",lightReduction:.2},storm:{name:"Thunderstorm",intensity:.9,windStrength:80,visibility:.3,tint:"rgba(20,20,40,0.3)",particleCount:150,particleColor:"#6090b0",soundId:"storm",lightReduction:.35},snow:{name:"Snow",intensity:.4,windStrength:15,visibility:.7,tint:"rgba(200,210,230,0.1)",particleCount:60,particleColor:"#e8f0ff",soundId:"wind_light",lightReduction:.05},blizzard:{name:"Blizzard",intensity:.9,windStrength:100,visibility:.2,tint:"rgba(200,210,230,0.3)",particleCount:200,particleColor:"#d0e0ff",soundId:"blizzard",lightReduction:.25},fog:{name:"Fog",intensity:.5,windStrength:5,visibility:.35,tint:"rgba(180,190,200,0.25)",particleCount:30,particleColor:"#c0c8d0",lightReduction:.1},corruption_storm:{name:"Corruption Storm",intensity:1,windStrength:60,visibility:.25,tint:"rgba(80,0,80,0.3)",particleCount:100,particleColor:"#a040a0",soundId:"corruption",lightReduction:.4}},Qg={spring:[{type:"clear",weight:35},{type:"cloudy",weight:25},{type:"rain",weight:25},{type:"heavy_rain",weight:10},{type:"fog",weight:5}],summer:[{type:"clear",weight:50},{type:"cloudy",weight:20},{type:"rain",weight:10},{type:"storm",weight:15},{type:"fog",weight:5}],autumn:[{type:"clear",weight:20},{type:"cloudy",weight:25},{type:"rain",weight:25},{type:"heavy_rain",weight:15},{type:"fog",weight:15}],winter:[{type:"clear",weight:15},{type:"cloudy",weight:20},{type:"snow",weight:30},{type:"blizzard",weight:15},{type:"fog",weight:10},{type:"storm",weight:10}]};class Zg{_current="clear";_target="clear";_intensity=0;_transitionTimer=0;_durationTimer=0;_particles=[];_lightningTimer=0;_lightningFlash=0;_windOffset=0;get current(){return this._current}get def(){return Ji[this._current]}get intensity(){return this._intensity}get lightningFlash(){return this._lightningFlash}get windOffset(){return this._windOffset}get particles(){return this._particles}update(e,t,i=0){this._durationTimer-=e,this._durationTimer<=0&&this._pickNewWeather(t,i);const s=Ji[this._current].intensity;this._intensity+=(s-this._intensity)*e*2,this._windOffset+=Ji[this._current].windStrength*e,(this._current==="storm"||this._current==="corruption_storm")&&(this._lightningTimer-=e,this._lightningTimer<=0&&(this._lightningFlash=1,this._lightningTimer=3+Math.random()*8)),this._lightningFlash=Math.max(0,this._lightningFlash-e*5),this._updateParticles(e)}_pickNewWeather(e,t){const i=e.season;let a=[...Qg[i]];t>.5&&a.push({type:"corruption_storm",weight:Math.floor(t*30)});const r=a.reduce((h,c)=>h+c.weight,0);let n=Math.random()*r,l="clear";for(const h of a)if(n-=h.weight,n<=0){l=h.type;break}this._current=l,this._durationTimer=300+Math.random()*900}_updateParticles(e){const t=Ji[this._current],i=Math.floor(t.particleCount*e);for(let a=0;a<i;a++)this._particles.push({x:Math.random()*1200-100,y:-10-Math.random()*50,vx:t.windStrength*.5+(Math.random()-.5)*20,vy:100+Math.random()*200+t.intensity*200,size:1+Math.random()*2,alpha:.3+Math.random()*.5,life:2+Math.random()*2});let s=0;for(;s<this._particles.length;){const a=this._particles[s];if(a.x+=a.vx*e,a.y+=a.vy*e,a.life-=e,a.life<=0||a.y>900){const r=this._particles.length-1;s!==r&&(this._particles[s]=this._particles[r]),this._particles.length=r}else s++}this._particles.length>500&&(this._particles.length=500)}render(e,t,i){const s=Ji[this._current];s.tint!=="transparent"&&(e.fillStyle=s.tint,e.fillRect(0,0,t,i)),this._lightningFlash>0&&(e.fillStyle=`rgba(255,255,255,${(this._lightningFlash*.4).toFixed(3)})`,e.fillRect(0,0,t,i));const a=this._particles.length;if(a>0){e.save();const r=this._current==="snow"||this._current==="blizzard",n=this._current==="fog",l=this._current==="corruption_storm",h=Math.PI*2;if(e.fillStyle=s.particleColor,r||n||l){const c=n?8:l?1.5:1;for(let d=0;d<a;d++){const u=this._particles[d];e.globalAlpha=u.alpha,e.beginPath(),e.arc(u.x,u.y,u.size*c,0,h),e.fill()}}else for(let c=0;c<a;c++){const d=this._particles[c];e.globalAlpha=d.alpha,e.fillRect(d.x,d.y,1,d.size*4)}e.restore()}this._current==="fog"&&(e.fillStyle="rgba(180,190,200,0.18)",e.fillRect(0,0,t,i))}forceWeather(e,t=300){this._current=e,this._durationTimer=t}serialize(){return{current:this._current,durationTimer:this._durationTimer}}deserialize(e){this._current=e.current,this._durationTimer=e.durationTimer}}const Jg={rotwood:{faction:"fungal",name:"Fungal Horde",color:"#44aa44"},ashlands:{faction:"cultist",name:"Fire Cultists",color:"#ff6600"},drowned_depths:{faction:"undead",name:"Drowned Legion",color:"#4488bb"},bone_wastes:{faction:"necro",name:"Necromancer Order",color:"#aa88cc"},the_void:{faction:"void",name:"Reality Warpers",color:"#8800ff"}},e0={fungal:["possessed","goblin_slinger","mushroom_spirit"],cultist:["cultist","skeleton_grunt"],undead:["skeleton_grunt","skeleton_hunter"],necro:["skeleton_grunt","skeleton_hunter","cultist"],void:["cultist","possessed","shadow_wisp"]},Se=16,t0=30;class i0{_chunks=new Map;_factions=new Map;_spreadTimer=0;_eventQueue=[];_globalCorruption=.3;_purifiedTiles=0;_totalTiles=0;_activeRaids=[];_elapsedTime=0;_spreadMult=1;setSpreadMultiplier(e){this._spreadMult=e}constructor(){for(const[e,t]of Object.entries(Jg))this._factions.set(t.faction,{id:t.faction,name:t.name,color:t.color,strength:.5,aggressionTimer:60+Math.random()*120,commandersAlive:0,biome:e})}get globalCorruption(){return this._globalCorruption}get purifiedPercent(){return this._totalTiles>0?this._purifiedTiles/this._totalTiles:0}get events(){return this._eventQueue}getFaction(e){return this._factions.get(e)}_chunkKey(e,t){return`${e},${t}`}_getChunk(e,t){const i=this._chunkKey(e,t);let s=this._chunks.get(i);return s||(s=new Float32Array(Se*Se),s.fill(this._globalCorruption),this._chunks.set(i,s),this._totalTiles+=Se*Se),s}getCorruptionAt(e,t){const i=Math.floor(e/Se),s=Math.floor(t/Se),a=(e%Se+Se)%Se,r=(t%Se+Se)%Se;return this._getChunk(i,s)[r*Se+a]}setCorruptionAt(e,t,i){const s=Math.floor(e/Se),a=Math.floor(t/Se),r=(e%Se+Se)%Se,n=(t%Se+Se)%Se,l=this._getChunk(s,a),h=n*Se+r,c=l[h];l[h]=Math.max(0,Math.min(1,i)),c>.1&&l[h]<=.1&&this._purifiedTiles++,c<=.1&&l[h]>.1&&this._purifiedTiles--}purifyRadius(e,t,i,s){let a=0;const r=Math.floor(e-i),n=Math.ceil(e+i),l=Math.floor(t-i),h=Math.ceil(t+i);for(let c=l;c<=h;c++)for(let d=r;d<=n;d++){const u=d-e,f=c-t,m=Math.sqrt(u*u+f*f);if(m<=i){const _=1-m/i,p=this.getCorruptionAt(d,c),g=s*_;p>0&&(this.setCorruptionAt(d,c,p-g),a++)}}return a}getActiveRaids(){return this._activeRaids.filter(e=>e.active)}spawnRaidParty(e,t,i,s){const a=e0[e]??["skeleton_grunt","possessed"],n=this._factions.get(e)?.strength??.5,l=3+Math.floor(n*7),h={factionId:e,biomeId:t,targetX:i,targetY:s,enemyTypes:a,enemyCount:l,startTime:this._elapsedTime,duration:120,active:!0};return this._activeRaids.push(h),h}updateRaids(e){for(let t=this._activeRaids.length-1;t>=0;t--){const i=this._activeRaids[t];if(!i.active)continue;this._elapsedTime-i.startTime>=i.duration&&(i.active=!1)}if(this._activeRaids.length>20){const t=this._activeRaids.filter(i=>!i.active);t.length>10&&(this._activeRaids=[...this._activeRaids.filter(i=>i.active),...t.slice(-10)])}}_updateCount=0;update(e,t,i,s){this._updateCount++,this._eventQueue=[],this._spreadTimer+=e,this._elapsedTime+=e,this.updateRaids(e),this._spreadTimer>=t0&&(this._spreadTimer=0,this._tickSpread());for(const[,a]of this._factions)a.aggressionTimer-=e,a.aggressionTimer<=0&&(a.aggressionTimer=60+Math.random()*180,this._triggerFactionEvent(a,i,s)),a.strength=Math.min(1,a.strength+e*.001*this._globalCorruption);this._updateCount%60===0&&this._recalcGlobal(),t.isNight&&(this._globalCorruption=Math.min(1,this._globalCorruption+e*5e-4*this._spreadMult))}_tickSpread(){const e=[...this._chunks.keys()],t=e.length;for(let i=0;i<t;i++){const s=e[i],a=this._chunks.get(s);if(!a)continue;const[r,n]=s.split(","),l=Number(r),h=Number(n);for(let c=0;c<Se;c++)for(let d=0;d<Se;d++){const u=c*Se+d,f=a[u];if(f>.3){const m=f*.02*this._spreadMult,_=[[d-1,c],[d+1,c],[d,c-1],[d,c+1]];for(const[p,g]of _)if(p>=0&&p<Se&&g>=0&&g<Se){const y=g*Se+p,S=a[y];S<f&&(a[y]=Math.min(1,S+m))}else if(f>.5){const y=l*Se+p,S=h*Se+g,b=this.getCorruptionAt(y,S);b<f&&this.setCorruptionAt(y,S,Math.min(1,b+m*.5))}}}}}_triggerFactionEvent(e,t,i){const s=Math.random();if(s<.3&&e.strength>.3){const a=t+(Math.random()-.5)*500,r=i+(Math.random()-.5)*500;this._eventQueue.push({type:"raid",x:a,y:r,faction:e.id,severity:e.strength}),this.spawnRaidParty(e.id,e.biome,a,r)}else if(s<.5&&e.strength>.5)this._eventQueue.push({type:"commander_spawn",x:t+(Math.random()-.5)*800,y:i+(Math.random()-.5)*800,faction:e.id,severity:e.strength}),e.commandersAlive++;else if(s<.7){this._eventQueue.push({type:"outbreak",x:t+(Math.random()-.5)*600,y:i+(Math.random()-.5)*600,faction:e.id,severity:e.strength*.5});const a=Math.floor(t/32+(Math.random()-.5)*20),r=Math.floor(i/32+(Math.random()-.5)*20);for(let n=-3;n<=3;n++)for(let l=-3;l<=3;l++){const h=this.getCorruptionAt(a+l,r+n);this.setCorruptionAt(a+l,r+n,h+.2)}}else this._eventQueue.push({type:"spread",x:t,y:i,faction:e.id,severity:e.strength*.2})}_recalcGlobal(){if(this._chunks.size===0)return;let e=0,t=0;for(const i of this._chunks.values())for(let s=0;s<i.length;s++)e+=i[s],t++;this._globalCorruption=t>0?e/t:.3}_particles=[];_particleTimer=0;_spawnParticles(e,t){if(this._particles.length>=60)return;const i=Math.min(2,Math.floor(this._globalCorruption*3));for(let s=0;s<i;s++){const r=[...this._factions.values()][Math.floor(Math.random()*this._factions.size)]?.color??"#8800ff";this._particles.push({x:Math.random()*e,y:t+10,vx:(Math.random()-.5)*.6,vy:-(.3+Math.random()*.8),life:0,maxLife:120+Math.random()*180,size:1.5+Math.random()*3,color:r})}}_updateParticles(){for(let e=this._particles.length-1;e>=0;e--){const t=this._particles[e];t.x+=t.vx+Math.sin(t.life*.03)*.3,t.y+=t.vy,t.life++,(t.life>=t.maxLife||t.y<-10)&&this._particles.splice(e,1)}}renderOverlay(e,t,i){const s=this._globalCorruption;if(s<.05)return;this._particleTimer++,this._particleTimer>=6&&(this._particleTimer=0,this._spawnParticles(t,i)),this._updateParticles();for(const n of this._particles){const l=n.life/n.maxLife,h=Math.min(l*5,1)*(1-Math.max((l-.7)/.3,0))*s*.5;h<=.01||(e.globalAlpha=h,e.fillStyle=n.color,e.fillRect(n.x-n.size,n.y-n.size,n.size*2,n.size*2))}e.globalAlpha=1;const a=Math.sin(Date.now()*.001)*.03,r=s*.12+a;if(r>0&&(e.fillStyle=`rgba(80, 0, 80, ${r.toFixed(4)})`,e.fillRect(0,0,t,i)),s>.3){const n=((s-.3)*.15).toFixed(3);e.fillStyle=`rgba(30, 0, 50, ${n})`,e.fillRect(0,0,t,i)}}getCorruptionGlow(e,t){const i=this.getCorruptionAt(e,t);if(i<.3)return null;let s="#8800ff",a=0;for(const r of this._factions.values())r.strength>a&&(a=r.strength,s=r.color);return{color:s,intensity:i}}serialize(){return{globalCorruption:this._globalCorruption,purifiedTiles:this._purifiedTiles,factions:[...this._factions.entries()],activeRaids:this._activeRaids.filter(e=>e.active),elapsedTime:this._elapsedTime}}deserialize(e){this._globalCorruption=e.globalCorruption,this._purifiedTiles=e.purifiedTiles;for(const[t,i]of e.factions)this._factions.set(t,i);this._activeRaids=e.activeRaids??[],this._elapsedTime=e.elapsedTime??0}}const s0=.06,a0=.09,r0=12,o0=.5,Nl=.7,n0=1,l0=.8,h0={spring:10,summer:20,autumn:6,winter:-8};class c0{_state={hunger:100,maxHunger:100,thirst:100,maxThirst:100,temperature:37,warmth:0,comfort:50,isExhausted:!1,isFreezing:!1,isOverheating:!1,isStarving:!1,isDehydrated:!1};_nearFire=!1;_inShelter=!1;_inWater=!1;_biomeTemp=20;_hungerDrainMult=1;get state(){return this._state}get hunger(){return this._state.hunger}get thirst(){return this._state.thirst}setNearFire(e){this._nearFire=e}setInShelter(e){this._inShelter=e}setInWater(e){this._inWater=e}setBiomeTemp(e){this._biomeTemp=e}setHungerDrainMult(e){this._hungerDrainMult=e}update(e,t,i,s,a){let r=0,n=0,l=s0*e*this._hungerDrainMult;i&&(l*=2),t.isNight&&(l*=.8),this._state.hunger=Math.max(0,this._state.hunger-l),this._state.isStarving=this._state.hunger<=0,this._state.isStarving&&(r+=o0*e);let h=a0*e;return i&&(h*=1.5),this._state.thirst=Math.max(0,this._state.thirst-h),this._state.isDehydrated=this._state.thirst<=0,this._state.isDehydrated&&(r+=Nl*e),r+=this._updateEnvironment(e,t,a),i&&(n=r0*e),{healthDrain:r,staminaDrain:n}}updateEnvironmentOnly(e,t,i,s,a){this._state.hunger=s,this._state.isStarving=s<=0,a!==void 0&&(this._state.thirst=a,this._state.isDehydrated=a<=0);let r=this._updateEnvironment(e,t,i);return this._state.isDehydrated&&(r+=Nl*e),r}_updateEnvironment(e,t,i){let s=0;const a=h0[t.season];let r=this._biomeTemp+a;t.isNight&&(r-=8),this._nearFire&&(r+=15),this._inShelter&&(r=r*.6+20*.4),this._inWater&&(r-=10);const n=37+(r-20)*.15+this._state.warmth*.5;this._state.temperature+=(n-this._state.temperature)*e*.08,this._state.isFreezing=this._state.temperature<28,this._state.isOverheating=this._state.temperature>44,this._state.isFreezing&&(s+=n0*e),this._state.isOverheating&&(s+=l0*e);let l=50;return this._nearFire&&(l+=20),this._inShelter&&(l+=15),!this._state.isStarving&&!this._state.isDehydrated&&(l+=10),(this._state.isFreezing||this._state.isOverheating)&&(l-=30),i>.5&&(l-=20),this._state.comfort+=(Math.max(0,Math.min(100,l))-this._state.comfort)*e*.05,this._state.isExhausted=this._state.comfort<20,s}eat(e){this._state.hunger=Math.min(this._state.maxHunger,this._state.hunger+e)}drink(e){this._state.thirst=Math.min(this._state.maxThirst,this._state.thirst+e)}setWarmth(e){this._state.warmth=e}serialize(){return{...this._state}}deserialize(e){this._state={...e}}}const ea={sword:[{state:"attack_1",damage:1,duration:.4,hitFrame:.5,comboWindow:.3,knockback:15,staminaCost:10},{state:"attack_2",damage:1.2,duration:.35,hitFrame:.5,comboWindow:.25,knockback:20,staminaCost:12},{state:"attack_3",damage:1.5,duration:.5,hitFrame:.6,comboWindow:.2,knockback:25,staminaCost:15},{state:"finisher",damage:2.5,duration:.8,hitFrame:.5,comboWindow:0,knockback:40,staminaCost:25}],dagger:[{state:"attack_1",damage:.6,duration:.2,hitFrame:.4,comboWindow:.2,knockback:5,staminaCost:6},{state:"attack_2",damage:.7,duration:.2,hitFrame:.4,comboWindow:.2,knockback:5,staminaCost:7},{state:"attack_3",damage:.8,duration:.25,hitFrame:.5,comboWindow:.15,knockback:8,staminaCost:8},{state:"finisher",damage:2,duration:.5,hitFrame:.4,comboWindow:0,knockback:15,staminaCost:15}],hammer:[{state:"attack_1",damage:1.5,duration:.6,hitFrame:.6,comboWindow:.35,knockback:30,staminaCost:18},{state:"attack_2",damage:1.8,duration:.7,hitFrame:.6,comboWindow:.3,knockback:35,staminaCost:20},{state:"finisher",damage:3.5,duration:1,hitFrame:.7,comboWindow:0,knockback:60,staminaCost:35}],bow:[{state:"attack_1",damage:1.2,duration:.5,hitFrame:.8,comboWindow:.2,knockback:0,staminaCost:12},{state:"attack_2",damage:1.5,duration:.6,hitFrame:.8,comboWindow:0,knockback:0,staminaCost:15}],staff:[{state:"attack_1",damage:.8,duration:.4,hitFrame:.5,comboWindow:.3,knockback:10,staminaCost:8},{state:"attack_2",damage:1,duration:.45,hitFrame:.5,comboWindow:.25,knockback:15,staminaCost:10},{state:"finisher",damage:2,duration:.7,hitFrame:.6,comboWindow:0,knockback:25,staminaCost:20}]};class d0{_comboIndex=0;_comboState="idle";_attackTimer=0;_comboWindowTimer=0;_recoveryTimer=0;_hitLanded=!1;_weapon="sword";_comboCount=0;_maxCombo=0;_parryWindow=0;_parryActive=!1;_perfectParryWindow=.1;_normalParryWindow=.3;_dodgeTimer=0;_dodgeCooldown=0;_dodgeIFrames=.2;_dodgeDuration=.4;_isDodging=!1;_attackBuffered=!1;_attackBufferTimer=0;get comboState(){return this._comboState}get comboCount(){return this._comboCount}get maxCombo(){return this._maxCombo}get isAttacking(){return this._comboState!=="idle"&&this._comboState!=="recovery"}get isDodging(){return this._isDodging}get isInvulnerable(){return this._isDodging&&this._dodgeTimer<this._dodgeIFrames}get isParrying(){return this._parryActive}setWeapon(e){this._weapon=e}startAttack(){const e=ea[this._weapon]??ea.sword;if(this._isDodging||this._recoveryTimer>0)return null;if(!(this._comboWindowTimer>0&&this._comboIndex<e.length)){if(this._comboState!=="idle")return this._attackBuffered=!0,this._attackBufferTimer=.15,null;this._comboIndex=0}if(this._comboIndex>=e.length)return this._comboState="recovery",this._recoveryTimer=.5,this._comboIndex=0,this._comboCount=0,null;const t=e[this._comboIndex];return this._comboState=t.state,this._attackTimer=t.duration,this._hitLanded=!1,this._comboWindowTimer=0,this._comboIndex++,this._comboCount++,this._comboCount>this._maxCombo&&(this._maxCombo=this._comboCount),t}startParry(){this._isDodging||this.isAttacking||(this._parryActive=!0,this._parryWindow=this._normalParryWindow)}checkParry(){if(!this._parryActive)return{success:!1,perfect:!1,stunDuration:0,damageReflect:0};const t=this._normalParryWindow-this._parryWindow<=this._perfectParryWindow;return this._parryActive=!1,this._parryWindow=0,{success:!0,perfect:t,stunDuration:t?1.5:.5,damageReflect:t?.5:.2}}startDodge(){return this._isDodging||this._dodgeCooldown>0||this.isAttacking?!1:(this._isDodging=!0,this._dodgeTimer=0,this._dodgeCooldown=1,this._comboState="idle",this._comboIndex=0,!0)}getDodgeDirection(e){return{dx:Math.cos(e)*120,dy:Math.sin(e)*120}}get hasBufferedAttack(){return this._attackBuffered}update(e){let t=!1,i=null;const s=ea[this._weapon]??ea.sword;if(this._attackBuffered&&(this._attackBufferTimer-=e,this._attackBufferTimer<=0&&(this._attackBuffered=!1)),this._comboState!=="idle"&&this._comboState!=="recovery"){this._attackTimer-=e;const a=this._comboIndex-1;if(a>=0&&a<s.length){i=s[a];const r=1-this._attackTimer/i.duration;!this._hitLanded&&r>=i.hitFrame&&(this._hitLanded=!0,t=!0)}this._attackTimer<=0&&(i&&i.comboWindow>0?(this._comboWindowTimer=i.comboWindow,this._comboState="idle",this._attackBuffered&&(this._attackBuffered=!1)):(this._comboState="recovery",this._recoveryTimer=.3,this._comboIndex=0,this._comboCount=0))}return this._comboWindowTimer>0&&(this._comboWindowTimer-=e,this._comboWindowTimer<=0&&(this._comboIndex=0,this._comboCount=0,this._comboState="idle")),this._recoveryTimer>0&&(this._recoveryTimer-=e,this._recoveryTimer<=0&&(this._comboState="idle")),this._parryActive&&(this._parryWindow-=e,this._parryWindow<=0&&(this._parryActive=!1)),this._isDodging&&(this._dodgeTimer+=e,this._dodgeTimer>=this._dodgeDuration&&(this._isDodging=!1)),this._dodgeCooldown>0&&(this._dodgeCooldown-=e),{shouldHit:t,attackDef:t?i:null}}reset(){this._comboState="idle",this._comboIndex=0,this._attackTimer=0,this._comboWindowTimer=0,this._recoveryTimer=0,this._hitLanded=!1,this._isDodging=!1,this._parryActive=!1}}const es={burn:{id:"burn",name:"Burning",icon:"",category:"dot",description:"Taking fire damage over time.",maxStacks:3,defaultDuration:5,tickRate:1,damagePerTick:.03,statModifiers:{},visualColor:"#ff4400",canImmune:!0},poison:{id:"poison",name:"Poisoned",icon:"",category:"dot",description:"Taking poison damage over time.",maxStacks:5,defaultDuration:8,tickRate:2,damagePerTick:.02,statModifiers:{speed:-.1},visualColor:"#44aa00",canImmune:!0},freeze:{id:"freeze",name:"Frozen",icon:"",category:"cc",description:"Movement speed greatly reduced.",maxStacks:1,defaultDuration:3,tickRate:0,damagePerTick:0,statModifiers:{speed:-.6},visualColor:"#88ccff",canImmune:!0},stun:{id:"stun",name:"Stunned",icon:"",category:"cc",description:"Cannot move or attack.",maxStacks:1,defaultDuration:1.5,tickRate:0,damagePerTick:0,statModifiers:{speed:-1,damage:-1},visualColor:"#ffff00",canImmune:!0},bleed:{id:"bleed",name:"Bleeding",icon:"",category:"dot",description:"Losing blood. Movement causes extra damage.",maxStacks:5,defaultDuration:6,tickRate:1,damagePerTick:.025,statModifiers:{},visualColor:"#cc0000",canImmune:!0},regen:{id:"regen",name:"Regenerating",icon:"",category:"buff",description:"Healing over time.",maxStacks:3,defaultDuration:10,tickRate:1,damagePerTick:-.02,statModifiers:{},visualColor:"#44ff44",canImmune:!1},shield:{id:"shield",name:"Shielded",icon:"",category:"buff",description:"Absorbing incoming damage.",maxStacks:1,defaultDuration:8,tickRate:0,damagePerTick:0,statModifiers:{defense:.5},visualColor:"#88aaff",canImmune:!1},damage_boost:{id:"damage_boost",name:"Empowered",icon:"",category:"buff",description:"Dealing increased damage.",maxStacks:1,defaultDuration:10,tickRate:0,damagePerTick:0,statModifiers:{damage:.3},visualColor:"#ff8800",canImmune:!1},speed_boost:{id:"speed_boost",name:"Haste",icon:"",category:"buff",description:"Moving faster.",maxStacks:1,defaultDuration:8,tickRate:0,damagePerTick:0,statModifiers:{speed:.3},visualColor:"#88ff88",canImmune:!1},slow:{id:"slow",name:"Slowed",icon:"",category:"debuff",description:"Movement speed reduced.",maxStacks:1,defaultDuration:4,tickRate:0,damagePerTick:0,statModifiers:{speed:-.3},visualColor:"#886644",canImmune:!0},curse:{id:"curse",name:"Cursed",icon:"",category:"debuff",description:"Reduced healing and increased damage taken.",maxStacks:1,defaultDuration:12,tickRate:0,damagePerTick:0,statModifiers:{defense:-.3,healingReceived:-.5},visualColor:"#6600aa",canImmune:!0},blind:{id:"blind",name:"Blinded",icon:"",category:"cc",description:"Cannot see far. Reduced accuracy.",maxStacks:1,defaultDuration:3,tickRate:0,damagePerTick:0,statModifiers:{accuracy:-.5},visualColor:"#222222",canImmune:!0},silence:{id:"silence",name:"Silenced",icon:"",category:"cc",description:"Cannot use skills.",maxStacks:1,defaultDuration:4,tickRate:0,damagePerTick:0,statModifiers:{},visualColor:"#aa44aa",canImmune:!0},thorns:{id:"thorns",name:"Thorns",icon:"",category:"buff",description:"Reflect damage to attackers.",maxStacks:1,defaultDuration:15,tickRate:0,damagePerTick:0,statModifiers:{thorns:.2},visualColor:"#44aa44",canImmune:!1},lifesteal:{id:"lifesteal",name:"Lifesteal",icon:"",category:"buff",description:"Heal for a portion of damage dealt.",maxStacks:1,defaultDuration:10,tickRate:0,damagePerTick:0,statModifiers:{lifesteal:.15},visualColor:"#cc0044",canImmune:!1},invulnerable:{id:"invulnerable",name:"Invulnerable",icon:"",category:"buff",description:"Cannot take damage.",maxStacks:1,defaultDuration:3,tickRate:0,damagePerTick:0,statModifiers:{defense:99},visualColor:"#ffdd00",canImmune:!1}};class u0{_effects=[];_immunities=new Set;get effects(){return this._effects}apply(e,t="unknown",i,s=1){const a=es[e];if(!a||a.canImmune&&this._immunities.has(e))return!1;const r=this._effects.find(n=>n.id===e);return r?(r.stacks=Math.min(r.stacks+s,a.maxStacks),r.remainingDuration=Math.max(r.remainingDuration,i??a.defaultDuration),!0):(this._effects.push({id:e,stacks:Math.min(s,a.maxStacks),remainingDuration:i??a.defaultDuration,tickTimer:a.tickRate,source:t}),!0)}remove(e){const t=this._effects.findIndex(i=>i.id===e);return t===-1?!1:(this._effects.splice(t,1),!0)}removeAll(){this._effects.length=0}removeByCategory(e){this._effects=this._effects.filter(t=>es[t.id].category!==e)}has(e){return this._effects.some(t=>t.id===e)}getStacks(e){return this._effects.find(t=>t.id===e)?.stacks??0}isStunned(){return this.has("stun")}isFrozen(){return this.has("freeze")}isSilenced(){return this.has("silence")}isInvulnerable(){return this.has("invulnerable")}addImmunity(e){this._immunities.add(e)}removeImmunity(e){this._immunities.delete(e)}getStatModifier(e){let t=0;for(const i of this._effects){const s=es[i.id];if(!s)continue;const a=s.statModifiers[e];a!==void 0&&(t+=a*i.stacks)}return t}update(e,t){let i=0,s=0;for(let a=this._effects.length-1;a>=0;a--){const r=this._effects[a],n=es[r.id];if(!n){this._effects.splice(a,1);continue}if(r.remainingDuration-=e,r.remainingDuration<=0){this._effects.splice(a,1);continue}if(n.tickRate>0&&(r.tickTimer-=e,r.tickTimer<=0)){r.tickTimer=n.tickRate;const l=n.damagePerTick*t*r.stacks;l>0?i+=l:s+=Math.abs(l)}}return{damage:i,healing:s}}renderIcons(e,t,i){if(this._effects.length===0)return;const s=20,a=4,r=t-this._effects.length*(s+a)/2;for(let n=0;n<this._effects.length;n++){const l=this._effects[n],h=es[l.id];if(!h)continue;const c=r+n*(s+a);e.fillStyle=h.visualColor+"33",e.beginPath(),e.roundRect(c,i,s,s,4),e.fill(),e.strokeStyle=h.visualColor,e.lineWidth=1,e.beginPath(),e.roundRect(c,i,s,s,4),e.stroke(),e.font=`${s-6}px serif`,e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.fillText(h.icon,c+s/2,i+s/2);const d=Math.min(1,l.remainingDuration/h.defaultDuration);e.fillStyle="rgba(0,0,0,0.5)",e.beginPath(),e.roundRect(c,i+s+1,s,3,1),e.fill(),e.fillStyle=h.visualColor,e.beginPath(),e.roundRect(c,i+s+1,Math.max(2,s*d),3,1),e.fill(),l.stacks>1&&(e.font="bold 7px monospace",e.textBaseline="top",e.fillStyle="#fff",e.textAlign="right",e.fillText(`${l.stacks}`,c+s-1,i+1))}e.textBaseline="alphabetic"}serialize(){return this._effects.map(e=>({...e}))}deserialize(e){this._effects=e.map(t=>({...t}))}}const f0={ms_welcome:{id:"ms_welcome",title:"Welcome to Haven",description:"Speak with Elder Miriam to learn about the pilgrimage.",icon:"",giver:"elder_miriam",biome:"haven",chain:"main_story",chainOrder:1,objectives:[{type:"talk",description:"Speak with Elder Miriam",targetId:"elder_miriam",targetCount:1}],rewards:{xp:50,gold:100}},ms_first_blade:{id:"ms_first_blade",title:"A Blade for the Road",description:"Garrett has forged a sword for you. Collect it and test it on the local slimes.",icon:"",giver:"garrett",biome:"haven",chain:"main_story",chainOrder:2,prerequisites:["ms_welcome"],objectives:[{type:"talk",description:"Visit Garrett at the forge",targetId:"garrett",targetCount:1},{type:"collect",description:"Receive the Iron Sword",targetId:"iron_sword",targetCount:1},{type:"kill",description:"Slay 5 Slimes",targetId:"slime",targetCount:5}],rewards:{xp:100,gold:50,items:[{itemId:"health_potion",count:3}]}},ms_rotwood_gate:{id:"ms_rotwood_gate",title:"Into the Rotwood",description:"The corruption is strongest in the Rotwood. Find the Corruption Core dungeon.",icon:"",giver:"elder_miriam",biome:"rotwood",chain:"main_story",chainOrder:3,prerequisites:["ms_first_blade"],objectives:[{type:"explore",description:"Find the Rotwood Corruption Core entrance",targetId:"rotwood_core",targetCount:1},{type:"purify",description:"Purify 50 corrupted tiles",targetCount:50}],rewards:{xp:250,gold:200,unlocks:["rotwood_core_dungeon"]}},ms_rotwood_titan:{id:"ms_rotwood_titan",title:"The Forest Titan",description:"Track and defeat the roaming Forest Titan threatening Rotwood.",icon:"",biome:"rotwood",chain:"main_story",chainOrder:4,prerequisites:["ms_rotwood_gate"],objectives:[{type:"explore",description:"Find Titan footprints",targetId:"titan_tracks",targetCount:3},{type:"boss",description:"Defeat the Forest Titan",targetId:"forest_titan",targetCount:1}],rewards:{xp:1e3,gold:500,items:[{itemId:"titan_bone",count:3}],unlocks:["ashlands"]}},ms_rotwood_core:{id:"ms_rotwood_core",title:"Heart of Rot",description:"Enter the Corruption Core dungeon and destroy the Core Guardian.",icon:"",biome:"rotwood",chain:"main_story",chainOrder:5,prerequisites:["ms_rotwood_titan"],objectives:[{type:"boss",description:"Defeat the Core Guardian: Sporelord",targetId:"sporelord",targetCount:1}],rewards:{xp:2e3,gold:1e3,items:[{itemId:"corruption_core",count:1}],unlocks:["ashlands_unlocked"]}},ms_ashlands_arrive:{id:"ms_ashlands_arrive",title:"Into the Ashes",description:"The Ashlands burn eternal. Establish a forward outpost.",icon:"",biome:"ashlands",chain:"main_story",chainOrder:6,prerequisites:["ms_rotwood_core"],objectives:[{type:"reach",description:"Enter the Ashlands biome",targetId:"ashlands",targetCount:1},{type:"build",description:"Build an outpost",targetId:"outpost",targetCount:1}],rewards:{xp:500,gold:300}},sq_herb_gathering:{id:"sq_herb_gathering",title:"Lily's Herbs",description:"Lily needs herbs for her potions. Gather some from the wilds.",icon:"",giver:"lily",biome:"haven",objectives:[{type:"collect",description:"Gather 10 Medicinal Herbs",targetId:"herb",targetCount:10}],rewards:{xp:75,gold:50,items:[{itemId:"health_potion",count:5}]},repeatable:!0},sq_slime_problem:{id:"sq_slime_problem",title:"Slime Infestation",description:"Slimes are overrunning the outskirts. Clear them out!",icon:"",biome:"haven",objectives:[{type:"kill",description:"Kill 15 slimes",targetId:"slime",targetCount:15}],rewards:{xp:120,gold:80},repeatable:!0},sq_wolf_pelts:{id:"sq_wolf_pelts",title:"Winter Preparations",description:"Harold needs wolf pelts for the tavern blankets.",icon:"",giver:"harold",biome:"haven",objectives:[{type:"collect",description:"Gather 5 Wolf Pelts",targetId:"wolf_pelt",targetCount:5}],rewards:{xp:100,gold:150,items:[{itemId:"mushroom_stew",count:3}]}},sq_iron_supply:{id:"sq_iron_supply",title:"Iron for the Forge",description:"Garrett needs iron ore for the forge. Mine some from the nearby caves.",icon:"",giver:"garrett",biome:"haven",objectives:[{type:"collect",description:"Gather 20 Iron Ore",targetId:"iron_ore",targetCount:20}],rewards:{xp:150,gold:100,items:[{itemId:"iron_bar",count:5}],unlocks:["recipe_steel_sword"]}},sq_merchant_delivery:{id:"sq_merchant_delivery",title:"Martha's Delivery",description:"Martha needs supplies delivered to the watchtower guards.",icon:"",giver:"martha",biome:"haven",objectives:[{type:"reach",description:"Deliver supplies to watchtower",targetId:"watchtower",targetCount:1}],rewards:{xp:80,gold:200}},lh_storm_stag:{id:"lh_storm_stag",title:"Hunt: Storm Stag",description:"A legendary creature appears only during thunderstorms. Track it down.",icon:"",objectives:[{type:"kill",description:"Defeat the Storm Stag (during a storm)",targetId:"storm_stag",targetCount:1}],rewards:{xp:800,gold:1e3,items:[{itemId:"storm_staff",count:1}]}},lh_shadow_wyrm:{id:"lh_shadow_wyrm",title:"Hunt: Shadow Wyrm",description:"The Shadow Wyrm dwells at maximum corruption. Find and slay it.",icon:"",objectives:[{type:"kill",description:"Defeat the Shadow Wyrm",targetId:"shadow_wyrm",targetCount:1}],rewards:{xp:2e3,gold:3e3,items:[{itemId:"void_shard",count:5}]}},ds_darkness_awakens:{id:"ds_darkness_awakens",title:"Darkness Awakens",description:"Strange whispers echo from the corruption. Investigate the source.",icon:"",biome:"rotwood",chain:"dark_story",chainOrder:1,prerequisites:["ms_rotwood_gate"],objectives:[{type:"explore",description:"Find the Whispering Shrine",targetId:"whispering_shrine",targetCount:1},{type:"collect",description:"Gather 3 Corruption Samples",targetId:"corruption_sample",targetCount:3}],rewards:{xp:300,gold:200,unlocks:["ds_shadow_cult"]}},ds_shadow_cult:{id:"ds_shadow_cult",title:"The Shadow Cult",description:"A hidden cult worships the corruption. Infiltrate their hideout.",icon:"",biome:"rotwood",chain:"dark_story",chainOrder:2,prerequisites:["ds_darkness_awakens"],objectives:[{type:"explore",description:"Locate the Cultist Hideout",targetId:"cultist_hideout",targetCount:1},{type:"kill",description:"Defeat 8 Cultists",targetId:"cultist",targetCount:8},{type:"collect",description:"Obtain the Cult Ledger",targetId:"cult_ledger",targetCount:1}],rewards:{xp:500,gold:400,items:[{itemId:"shadow_cloak",count:1}],unlocks:["ds_corruption_source"]}},ds_corruption_source:{id:"ds_corruption_source",title:"Source of Corruption",description:"The ledger reveals the corruption flows from the Void Rift. Seal it.",icon:"",biome:"the_void",chain:"dark_story",chainOrder:3,prerequisites:["ds_shadow_cult"],objectives:[{type:"explore",description:"Reach the Void Rift entrance",targetId:"void_rift",targetCount:1},{type:"purify",description:"Purify 100 corruption tiles",targetCount:100},{type:"boss",description:"Defeat the Void Herald",targetId:"void_herald",targetCount:1}],rewards:{xp:1500,gold:1e3,items:[{itemId:"void_shard",count:3}],unlocks:["ds_edilas_ascension"]}},ds_edilas_ascension:{id:"ds_edilas_ascension",title:"Ascension to EDILAS",description:"With the corruption sealed, the path to EDILAS reveals itself.",icon:"",biome:"edilas",chain:"dark_story",chainOrder:4,prerequisites:["ds_corruption_source"],objectives:[{type:"reach",description:"Enter EDILAS",targetId:"edilas",targetCount:1},{type:"boss",description:"Face the Corrupted Heart",targetId:"corrupted_heart",targetCount:1}],rewards:{xp:5e3,gold:5e3,items:[{itemId:"pilgrims_crown",count:1}],unlocks:["endgame_newgameplus"]}},ms_drowned_arrive:{id:"ms_drowned_arrive",title:"Into the Depths",description:"The Drowned Depths lie beyond the Ashlands. Navigate the flooded ruins.",icon:"",biome:"drowned_depths",chain:"main_story",chainOrder:7,prerequisites:["ms_ashlands_arrive"],objectives:[{type:"reach",description:"Enter the Drowned Depths",targetId:"drowned_depths",targetCount:1},{type:"explore",description:"Find the Sunken Temple",targetId:"sunken_temple",targetCount:1}],rewards:{xp:800,gold:500,unlocks:["ms_leviathan"]}},ms_leviathan:{id:"ms_leviathan",title:"The Leviathan",description:"A monstrous leviathan guards the depths. Slay the beast.",icon:"",biome:"drowned_depths",chain:"main_story",chainOrder:8,prerequisites:["ms_drowned_arrive"],objectives:[{type:"boss",description:"Defeat the Leviathan",targetId:"leviathan",targetCount:1}],rewards:{xp:3e3,gold:2e3,items:[{itemId:"leviathan_scale",count:3}],unlocks:["bone_wastes"]}},cd_haven_market:{id:"cd_haven_market",title:"Heart of Haven",description:"Explore Haven and visit its key locations.",icon:"",biome:"haven",objectives:[{type:"reach",description:"Visit the Market Square",targetId:"market_square",targetCount:1},{type:"reach",description:"Visit the Tavern",targetId:"tavern",targetCount:1},{type:"reach",description:"Visit the Smithy",targetId:"smithy",targetCount:1},{type:"talk",description:"Speak with the Traveler",targetId:"traveler_npc",targetCount:1}],rewards:{xp:100,gold:150}},cd_rotwood_ruins:{id:"cd_rotwood_ruins",title:"Ruins of the Old World",description:"Explore the ruins scattered across Rotwood.",icon:"",biome:"rotwood",prerequisites:["ms_rotwood_gate"],objectives:[{type:"explore",description:"Discover the Ancient Library",targetId:"ancient_library",targetCount:1},{type:"collect",description:"Find 3 Lore Fragments",targetId:"lore_fragment",targetCount:3}],rewards:{xp:200,gold:250,items:[{itemId:"knowledge_scroll",count:1}]}},mh_goblin_chieftain:{id:"mh_goblin_chieftain",title:"Hunt: Goblin Chieftain",description:"A particularly nasty goblin chieftain has set up camp nearby.",icon:"",biome:"haven",objectives:[{type:"kill",description:"Kill 10 Goblin Berserkers",targetId:"goblin_berserker",targetCount:10},{type:"kill",description:"Defeat the Goblin Chieftain",targetId:"goblin_chieftain",targetCount:1}],rewards:{xp:300,gold:400,items:[{itemId:"goblin_trophy",count:1}]}},mh_skeleton_horde:{id:"mh_skeleton_horde",title:"Hunt: Skeleton Horde",description:"Undead are rising in numbers near the Bone Wastes border.",icon:"",biome:"bone_wastes",prerequisites:["ms_leviathan"],objectives:[{type:"kill",description:"Destroy 25 Skeletons",targetId:"skeleton_grunt",targetCount:25},{type:"kill",description:"Defeat the Skeleton Commander",targetId:"skeleton_commander",targetCount:1}],rewards:{xp:600,gold:800,items:[{itemId:"bone_charm",count:1}]}},mh_corrupted_beast:{id:"mh_corrupted_beast",title:"Hunt: Corrupted Beast",description:"A massive beast, twisted by corruption, stalks the night.",icon:"",objectives:[{type:"kill",description:"Track and slay the Corrupted Beast",targetId:"corrupted_beast",targetCount:1}],rewards:{xp:500,gold:600,items:[{itemId:"beast_fang",count:2},{itemId:"corruption_sample",count:1}]}},wm_sword_mastery:{id:"wm_sword_mastery",title:"Way of the Blade",description:"Master the sword by completing combat challenges.",icon:"",giver:"garrett",biome:"haven",objectives:[{type:"kill",description:"Slay 50 enemies with a sword equipped",targetId:"sword_kill",targetCount:50},{type:"kill",description:"Achieve a 20-hit combo",targetId:"combo_20",targetCount:1}],rewards:{xp:400,gold:300,unlocks:["mastery_sword_tier2"]}},wm_bow_mastery:{id:"wm_bow_mastery",title:"Eagle Eye",description:"Prove your skill with ranged weapons.",icon:"",biome:"haven",objectives:[{type:"kill",description:"Slay 30 enemies with ranged attacks",targetId:"ranged_kill",targetCount:30}],rewards:{xp:400,gold:300,unlocks:["mastery_bow_tier2"]}},pq_master_farmer:{id:"pq_master_farmer",title:"Green Thumb",description:"Demonstrate farming expertise by harvesting a variety of crops.",icon:"",giver:"lily",biome:"haven",objectives:[{type:"collect",description:"Harvest 20 Wheat",targetId:"wheat",targetCount:20},{type:"collect",description:"Harvest 10 Tomatoes",targetId:"tomato",targetCount:10},{type:"collect",description:"Harvest 5 Moonpetals",targetId:"moonpetal",targetCount:5}],rewards:{xp:300,gold:500,items:[{itemId:"golden_hoe",count:1}],unlocks:["profession_farmer_tier2"]}},pq_master_fisher:{id:"pq_master_fisher",title:"Master Angler",description:"Catch a variety of fish across different biomes.",icon:"",biome:"haven",objectives:[{type:"collect",description:"Catch 30 fish total",targetId:"any_fish",targetCount:30},{type:"collect",description:"Catch a Golden Koi",targetId:"golden_koi",targetCount:1}],rewards:{xp:300,gold:500,items:[{itemId:"master_rod",count:1}],unlocks:["profession_fisher_tier2"]}}},Ol=[{type:"bounty",titleTemplate:"Bounty: Slay {target}",descriptionTemplate:"Eliminate {count} {target} threatening the settlement.",icon:"",objectiveType:"kill",targetPool:["slime","goblin_berserker","skeleton_grunt","cultist","shadow_wisp"],countRange:[5,20],baseXP:100,baseGold:80},{type:"gathering",titleTemplate:"Gather: {target}",descriptionTemplate:"Collect {count} {target} for the colony.",icon:"",objectiveType:"collect",targetPool:["herb","iron_ore","wood","stone","fiber"],countRange:[10,30],baseXP:80,baseGold:100},{type:"purification",titleTemplate:"Cleanse the Land",descriptionTemplate:"Purify {count} corrupted tiles in the surrounding area.",icon:"",objectiveType:"purify",targetPool:["corruption"],countRange:[20,50],baseXP:120,baseGold:120}];class m0{_quests=new Map;_completedIds=new Set;_repeatTimers=[];_recentProgress=[];consumeProgress(){if(this._recentProgress.length===0)return this._recentProgress;const e=this._recentProgress;return this._recentProgress=[],e}constructor(){for(const[e,t]of Object.entries(f0)){const i=!t.prerequisites||t.prerequisites.length===0?"available":"locked";this._quests.set(e,{def:t,status:i,objectives:t.objectives.map(s=>({...s,currentCount:0,completed:!1})),timer:t.timeLimit??0})}}destroy(){for(const e of this._repeatTimers)clearTimeout(e);this._repeatTimers.length=0}getQuest(e){return this._quests.get(e)}getActiveQuests(){return[...this._quests.values()].filter(e=>e.status==="active")}getAvailableQuests(){return[...this._quests.values()].filter(e=>e.status==="available")}getCompletedQuests(){return[...this._quests.values()].filter(e=>e.status==="completed")}acceptQuest(e){const t=this._quests.get(e)??this._dailyContracts.get(e);return!t||t.status!=="available"?!1:(t.status="active",!0)}completeQuest(e,t,i){const s=this._quests.get(e)??this._dailyContracts.get(e);if(!s||s.status!=="active"||!s.objectives.every(r=>r.completed))return!1;s.status="completed",this._completedIds.add(e);const a=s.def.rewards;if(a.xp&&i&&i.addXP(a.xp),a.gold&&t.addGold(a.gold),a.items)for(const r of a.items)t.addItem(r.itemId,r.count);if(a.unlocks)for(const r of a.unlocks){const n=this._quests.get(r);n&&n.status==="locked"&&(n.def.prerequisites?.every(h=>this._completedIds.has(h))??!0)&&(n.status="available")}if(s.def.repeatable){const r=setTimeout(()=>{const n=this._repeatTimers.indexOf(r);n!==-1&&this._repeatTimers.splice(n,1),s.status="available";for(const l of s.objectives)l.currentCount=0,l.completed=!1},5e3);this._repeatTimers.push(r)}return!0}onKill(e){this._progressObjective("kill",e)}onCollect(e,t=1){this._progressObjective("collect",e,t)}onReach(e){this._progressObjective("reach",e),this._progressObjective("explore",e)}onTalk(e){this._progressObjective("talk",e)}onBuild(e){this._progressObjective("build",e)}onPurify(e){const t=[this._quests,this._dailyContracts];for(const i of t)for(const s of i.values())if(s.status==="active")for(const a of s.objectives)a.type==="purify"&&!a.completed&&(a.currentCount=Math.min(a.targetCount,a.currentCount+e),a.currentCount>=a.targetCount&&(a.completed=!0))}onBossKill(e){this._progressObjective("boss",e)}onCraft(e,t=1){this._progressObjective("craft",e,t)}onSurviveTick(e){const t=[this._quests,this._dailyContracts];for(const i of t)for(const s of i.values())if(s.status==="active")for(const a of s.objectives)a.type==="survive"&&!a.completed&&(a.currentCount=Math.min(a.targetCount,a.currentCount+e),a.currentCount>=a.targetCount&&(a.completed=!0))}_dailyContracts=new Map;_lastContractDay=-1;get dailyContracts(){return[...this._dailyContracts.values()]}getAvailableContracts(){return[...this._dailyContracts.values()].filter(e=>e.status==="available")}getActiveContracts(){return[...this._dailyContracts.values()].filter(e=>e.status==="active")}generateDailyContracts(e,t,i=3){if(e!==this._lastContractDay){this._lastContractDay=e,this._dailyContracts.clear();for(let s=0;s<i;s++){const a=Ol[Math.floor(Math.random()*Ol.length)],r=a.targetPool[Math.floor(Math.random()*a.targetPool.length)],n=a.countRange[0]+Math.floor(Math.random()*(a.countRange[1]-a.countRange[0])),l=1+t*.1,h=`daily_${e}_${s}`,c={id:h,title:a.titleTemplate.replace("{target}",r),description:a.descriptionTemplate.replace("{count}",String(n)).replace("{target}",r),icon:a.icon,objectives:[{type:a.objectiveType,description:`${r}: ${n}`,targetId:r,targetCount:n}],rewards:{xp:Math.floor(a.baseXP*l),gold:Math.floor(a.baseGold*l)},timeLimit:24*3600,repeatable:!1};this._dailyContracts.set(h,{def:c,status:"active",objectives:c.objectives.map(d=>({...d,currentCount:0,completed:!1})),timer:c.timeLimit??0})}}}_progressObjective(e,t,i=1){const s=[this._quests,this._dailyContracts];for(const a of s)for(const r of a.values())if(r.status==="active"){for(const n of r.objectives)if(n.type===e&&n.targetId===t&&!n.completed){const l=n.currentCount;n.currentCount=Math.min(n.targetCount,n.currentCount+i);const h=n.currentCount>=n.targetCount;h&&(n.completed=!0),n.currentCount!==l&&this._recentProgress.push({questTitle:r.def.title,questIcon:r.def.icon,objectiveDesc:n.description,current:n.currentCount,target:n.targetCount,justCompleted:h})}}}update(e){for(const t of this._quests.values())t.status==="active"&&t.def.timeLimit&&t.def.timeLimit>0&&(t.timer-=e,t.timer<=0&&(t.status="failed"));for(const t of this._dailyContracts.values())t.status==="active"&&t.def.timeLimit&&t.def.timeLimit>0&&(t.timer-=e,t.timer<=0&&(t.status="failed"));for(const t of this._quests.values()){if(t.status!=="locked")continue;const i=t.def.prerequisites;i&&i.every(s=>this._completedIds.has(s))&&(t.status="available")}}serialize(){const e=[];for(const[i,s]of this._quests)e.push([i,{status:s.status,objectives:s.objectives,timer:s.timer}]);const t=[];for(const[i,s]of this._dailyContracts)t.push([i,{def:s.def,status:s.status,objectives:s.objectives,timer:s.timer}]);return{quests:e,completed:[...this._completedIds],dailyContracts:t,lastContractDay:this._lastContractDay}}deserialize(e){this._completedIds=new Set(e.completed);for(const[t,i]of e.quests){const s=this._quests.get(t);s&&(s.status=i.status,s.objectives=i.objectives,s.timer=i.timer)}if(e.dailyContracts){this._dailyContracts.clear();for(const[t,i]of e.dailyContracts)this._dailyContracts.set(t,{def:i.def,status:i.status,objectives:i.objectives,timer:i.timer})}e.lastContractDay!=null&&(this._lastContractDay=e.lastContractDay)}}const Pr=[{id:"first_blood",name:"First Blood",icon:"",description:"Defeat your first enemy.",category:"combat",hidden:!1,requirement:1},{id:"slime_slayer",name:"Slime Slayer",icon:"",description:"Defeat 50 slimes.",category:"combat",hidden:!1,requirement:50},{id:"centurion",name:"Centurion",icon:"",description:"Defeat 100 enemies.",category:"combat",hidden:!1,requirement:100},{id:"thousand_kills",name:"The Thousand",icon:"",description:"Defeat 1,000 enemies.",category:"combat",hidden:!1,requirement:1e3},{id:"titan_slayer",name:"Titan Slayer",icon:"",description:"Defeat your first Titan.",category:"combat",hidden:!1,requirement:1},{id:"all_titans",name:"Titanfall",icon:"",description:"Defeat all 5 Titans.",category:"combat",hidden:!0,requirement:5},{id:"no_damage_boss",name:"Untouchable",icon:"",description:"Defeat a boss without taking damage.",category:"combat",hidden:!0,requirement:1},{id:"combo_10",name:"Combo Master",icon:"",description:"Reach a 10-hit combo.",category:"combat",hidden:!1,requirement:10},{id:"first_steps",name:"First Steps",icon:"",description:"Leave Haven for the first time.",category:"exploration",hidden:!1,requirement:1},{id:"biome_2",name:"Into the Unknown",icon:"",description:"Reach the second biome.",category:"exploration",hidden:!1,requirement:2},{id:"all_biomes",name:"World Traveler",icon:"",description:"Visit all biomes.",category:"exploration",hidden:!1,requirement:6},{id:"rift_5",name:"Rift Walker",icon:"",description:"Complete 5 rift dungeon floors.",category:"exploration",hidden:!1,requirement:5},{id:"rift_50",name:"Rift Master",icon:"",description:"Reach rift depth 50.",category:"exploration",hidden:!0,requirement:50},{id:"dungeon_clear",name:"Dungeon Delver",icon:"",description:"Clear your first dungeon.",category:"exploration",hidden:!1,requirement:1},{id:"first_craft",name:"Handiwork",icon:"",description:"Craft your first item.",category:"crafting",hidden:!1,requirement:1},{id:"craft_50",name:"Artisan",icon:"",description:"Craft 50 items.",category:"crafting",hidden:!1,requirement:50},{id:"craft_legendary",name:"Legendary Crafter",icon:"",description:"Craft a legendary item.",category:"crafting",hidden:!0,requirement:1},{id:"cook_10",name:"Home Cooking",icon:"",description:"Cook 10 meals.",category:"crafting",hidden:!1,requirement:10},{id:"first_building",name:"Founder",icon:"",description:"Build your first structure.",category:"colony",hidden:!1,requirement:1},{id:"settlement",name:"Settlement Builder",icon:"",description:"Have 10 structures in a settlement.",category:"colony",hidden:!1,requirement:10},{id:"metropolis",name:"Metropolis",icon:"",description:"Have 50 structures across all settlements.",category:"colony",hidden:!0,requirement:50},{id:"recruit_5",name:"Recruiter",icon:"",description:"Recruit 5 settlers.",category:"colony",hidden:!1,requirement:5},{id:"defend_raid",name:"Defender",icon:"",description:"Successfully defend against a raid.",category:"colony",hidden:!1,requirement:1},{id:"first_catch",name:"First Catch",icon:"",description:"Catch your first fish.",category:"fishing",hidden:!1,requirement:1},{id:"catch_legendary",name:"Legendary Angler",icon:"",description:"Catch a legendary fish.",category:"fishing",hidden:!0,requirement:1},{id:"fish_all",name:"Master Fisher",icon:"",description:"Catch all fish types.",category:"fishing",hidden:!0,requirement:28},{id:"reach_edilas",name:"The Living Pilgrimage",icon:"",description:"Reach EDILAS.",category:"story",hidden:!0,requirement:1,reward:{unlocks:"new_game_plus"}},{id:"purify_100",name:"Purifier",icon:"",description:"Purify 100 corrupted tiles.",category:"story",hidden:!1,requirement:100},{id:"purify_world",name:"World Purified",icon:"",description:"Purify the entire world map.",category:"endgame",hidden:!0,requirement:1,reward:{gold:1e5,unlocks:"true_ending"}},{id:"friend_1",name:"New Friend",icon:"",description:"Reach friendly status with an NPC.",category:"social",hidden:!1,requirement:1},{id:"best_friend",name:"Best Friend",icon:"",description:"Reach best friend status.",category:"social",hidden:!1,requirement:1},{id:"romance",name:"Love in Corruption",icon:"",description:"Start a romance.",category:"social",hidden:!0,requirement:1},{id:"rich",name:"Rich",icon:"",description:"Have 10,000 gold at once.",category:"misc",hidden:!1,requirement:1e4},{id:"die_first",name:"Trial by Fire",icon:"",description:"Die for the first time.",category:"misc",hidden:!0,requirement:1},{id:"play_10h",name:"Dedicated",icon:"",description:"Play for 10 hours.",category:"misc",hidden:!1,requirement:36e3},{id:"explorer",name:"Explorer",icon:"",description:"Discover 3 different biomes.",category:"exploration",hidden:!1,requirement:3},{id:"first_gift",name:"Gift Giver",icon:"",description:"Give a gift to an NPC.",category:"social",hidden:!1,requirement:1},{id:"festival_goer",name:"Festival Goer",icon:"",description:"Participate in 5 festival activities.",category:"misc",hidden:!1,requirement:5},{id:"quest_complete",name:"Questor",icon:"",description:"Complete 10 quests.",category:"story",hidden:!1,requirement:10}];class p0{_unlocked=new Set;_progress=new Map;_recentUnlock=null;_recentTimer=0;get recentUnlock(){return this._recentUnlock}get recentTimer(){return this._recentTimer}isUnlocked(e){return this._unlocked.has(e)}getProgress(e){return this._progress.get(e)??0}getUnlockedCount(){return this._unlocked.size}getTotalCount(){return Pr.length}progress(e,t=1){if(this._unlocked.has(e))return!1;const i=Pr.find(a=>a.id===e);if(!i)return!1;const s=(this._progress.get(e)??0)+t;return this._progress.set(e,s),s>=i.requirement?(this._unlocked.add(e),this._recentUnlock=i,this._recentTimer=4,console.log(`[Achievement]  ${i.name}: ${i.description}`),!0):!1}setProgress(e,t){if(this._unlocked.has(e))return!1;const i=Pr.find(s=>s.id===e);return i?(this._progress.set(e,t),t>=i.requirement?(this._unlocked.add(e),this._recentUnlock=i,this._recentTimer=4,!0):!1):!1}update(e){this._recentTimer>0&&(this._recentTimer-=e,this._recentTimer<=0&&(this._recentUnlock=null))}renderPopup(e,t){if(!this._recentUnlock||this._recentTimer<=0)return;const i=this._recentUnlock,s=Math.min(1,this._recentTimer/.5);e.save(),e.globalAlpha=s;const a=Math.max(0,(1-Math.min(1,(4-this._recentTimer)*3))*-60),r=280,n=50,l=t/2-r/2,h=20+a;e.fillStyle="rgba(20,20,20,0.9)",e.beginPath(),e.roundRect(l,h,r,n,8),e.fill(),e.strokeStyle="#f59e0b",e.lineWidth=2,e.stroke(),e.font="20px serif",e.textAlign="left",e.fillStyle="#fff",e.fillText(i.icon,l+10,h+32),e.font="bold 12px monospace",e.fillStyle="#f59e0b",e.fillText(" Achievement Unlocked!",l+40,h+18),e.font="11px monospace",e.fillStyle="#e5e7eb",e.fillText(i.name,l+40,h+36),e.restore()}serialize(){return{unlocked:[...this._unlocked],progress:[...this._progress]}}deserialize(e){this._unlocked=new Set(e.unlocked),this._progress=new Map(e.progress)}}const ii={r_cloth:{id:"r_cloth",name:"Cloth",icon:"",station:"hand",materials:[{itemId:"fiber",count:3}],output:{itemId:"cloth",count:1},craftTime:2,levelRequired:0,unlocked:!0},r_torch:{id:"r_torch",name:"Torch",icon:"",station:"hand",materials:[{itemId:"wood",count:2},{itemId:"cloth",count:1}],output:{itemId:"torch",count:1},craftTime:3,levelRequired:0,unlocked:!0},r_wooden_sword:{id:"r_wooden_sword",name:"Wooden Sword",icon:"",station:"workbench",materials:[{itemId:"wood",count:5}],output:{itemId:"wooden_sword",count:1},craftTime:5,levelRequired:0,unlocked:!0},r_shortbow:{id:"r_shortbow",name:"Shortbow",icon:"",station:"workbench",materials:[{itemId:"wood",count:8},{itemId:"fiber",count:5}],output:{itemId:"shortbow",count:1},craftTime:8,levelRequired:2,unlocked:!0},r_leather_vest:{id:"r_leather_vest",name:"Leather Vest",icon:"",station:"workbench",materials:[{itemId:"monster_hide",count:5},{itemId:"cloth",count:2}],output:{itemId:"leather_vest",count:1},craftTime:10,levelRequired:1,unlocked:!0},r_leather_cap:{id:"r_leather_cap",name:"Leather Cap",icon:"",station:"workbench",materials:[{itemId:"monster_hide",count:3}],output:{itemId:"leather_cap",count:1},craftTime:6,levelRequired:1,unlocked:!0},r_iron_bar:{id:"r_iron_bar",name:"Iron Bar",icon:"",station:"forge",materials:[{itemId:"iron_ore",count:3}],output:{itemId:"iron_bar",count:1},craftTime:5,levelRequired:0,unlocked:!0},r_gold_bar:{id:"r_gold_bar",name:"Gold Bar",icon:"",station:"forge",materials:[{itemId:"gold_ore",count:3}],output:{itemId:"gold_bar",count:1},craftTime:8,levelRequired:3,unlocked:!0},r_iron_sword:{id:"r_iron_sword",name:"Iron Sword",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:3},{itemId:"wood",count:2}],output:{itemId:"iron_sword",count:1},craftTime:10,levelRequired:1,unlocked:!0},r_steel_sword:{id:"r_steel_sword",name:"Steel Sword",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:5},{itemId:"gold_bar",count:1}],output:{itemId:"steel_sword",count:1},craftTime:15,levelRequired:3,unlocked:!1},r_silver_sword:{id:"r_silver_sword",name:"Silver Sword",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:4},{itemId:"gold_bar",count:2},{itemId:"crystal",count:1}],output:{itemId:"silver_sword",count:1},craftTime:18,levelRequired:4,unlocked:!1},r_corrupted_greatsword:{id:"r_corrupted_greatsword",name:"Corrupted Greatsword",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:8},{itemId:"corruption_shard",count:5},{itemId:"shadow_essence",count:2}],output:{itemId:"corrupted_greatsword",count:1},craftTime:25,levelRequired:6,unlocked:!1},r_iron_helm:{id:"r_iron_helm",name:"Iron Helm",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:4}],output:{itemId:"iron_helm",count:1},craftTime:12,levelRequired:2,unlocked:!0},r_chainmail_helm:{id:"r_chainmail_helm",name:"Chainmail Coif",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:6},{itemId:"cloth",count:2}],output:{itemId:"chainmail_helm",count:1},craftTime:15,levelRequired:3,unlocked:!1},r_iron_chestplate:{id:"r_iron_chestplate",name:"Iron Chestplate",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:8},{itemId:"cloth",count:3}],output:{itemId:"iron_chestplate",count:1},craftTime:20,levelRequired:3,unlocked:!0},r_chainmail_chestplate:{id:"r_chainmail_chestplate",name:"Chainmail Hauberk",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:10},{itemId:"cloth",count:4},{itemId:"gold_bar",count:1}],output:{itemId:"chainmail_chestplate",count:1},craftTime:22,levelRequired:4,unlocked:!1},r_superior_health_potion:{id:"r_superior_health_potion",name:"Superior Health Potion",icon:"",station:"alchemy_table",materials:[{itemId:"health_potion",count:2},{itemId:"moonpetal",count:1}],output:{itemId:"superior_health_potion",count:1},craftTime:6,levelRequired:2,unlocked:!1},r_battle_axe:{id:"r_battle_axe",name:"Battle Axe",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:6},{itemId:"wood",count:3}],output:{itemId:"battle_axe",count:1},craftTime:14,levelRequired:2,unlocked:!0},r_pickaxe:{id:"r_pickaxe",name:"Pickaxe",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:2},{itemId:"wood",count:3}],output:{itemId:"pickaxe",count:1},craftTime:8,levelRequired:0,unlocked:!0},r_health_potion:{id:"r_health_potion",name:"Health Potion",icon:"",station:"alchemy_table",materials:[{itemId:"herb",count:3},{itemId:"slime_gel",count:1}],output:{itemId:"health_potion",count:1},craftTime:5,levelRequired:0,unlocked:!0},r_greater_health:{id:"r_greater_health",name:"Greater Health Potion",icon:"",station:"alchemy_table",materials:[{itemId:"herb",count:5},{itemId:"spore_cap",count:2},{itemId:"slime_gel",count:2}],output:{itemId:"greater_health_potion",count:1},craftTime:10,levelRequired:3,unlocked:!1},r_antidote:{id:"r_antidote",name:"Antidote",icon:"",station:"alchemy_table",materials:[{itemId:"herb",count:2},{itemId:"spore_cap",count:1}],output:{itemId:"antidote",count:1},craftTime:5,levelRequired:1,unlocked:!0},r_purification_crystal:{id:"r_purification_crystal",name:"Purification Crystal",icon:"",station:"alchemy_table",materials:[{itemId:"corruption_essence",count:3},{itemId:"ruby",count:1}],output:{itemId:"purification_crystal",count:1},craftTime:15,levelRequired:5,unlocked:!1},r_bread:{id:"r_bread",name:"Bread",icon:"",station:"cooking_fire",materials:[{itemId:"wheat",count:3}],output:{itemId:"bread",count:2},craftTime:5,levelRequired:0,unlocked:!0},r_grilled_fish:{id:"r_grilled_fish",name:"Grilled Fish",icon:"",station:"cooking_fire",materials:[{itemId:"raw_fish",count:1},{itemId:"wood",count:1}],output:{itemId:"grilled_fish",count:1},craftTime:4,levelRequired:0,unlocked:!0},r_mushroom_stew:{id:"r_mushroom_stew",name:"Mushroom Stew",icon:"",station:"cooking_fire",materials:[{itemId:"spore_cap",count:3},{itemId:"herb",count:2}],output:{itemId:"mushroom_stew",count:1},craftTime:8,levelRequired:2,unlocked:!0},r_venom_blade:{id:"r_venom_blade",name:"Venom Blade",icon:"",station:"forge",materials:[{itemId:"iron_bar",count:4},{itemId:"venom_gland",count:3},{itemId:"snake_scale",count:2}],output:{itemId:"venom_blade",count:1},craftTime:18,levelRequired:4,unlocked:!1},r_bone_shield:{id:"r_bone_shield",name:"Bone Shield",icon:"",station:"forge",materials:[{itemId:"cursed_bone",count:5},{itemId:"iron_bar",count:3},{itemId:"soul_fragment",count:1}],output:{itemId:"bone_shield",count:1},craftTime:20,levelRequired:5,unlocked:!1},r_spider_silk_robe:{id:"r_spider_silk_robe",name:"Spider Silk Robe",icon:"",station:"workbench",materials:[{itemId:"spider_silk",count:8},{itemId:"cloth",count:3}],output:{itemId:"spider_silk_robe",count:1},craftTime:15,levelRequired:3,unlocked:!1},r_void_staff:{id:"r_void_staff",name:"Void Staff",icon:"",station:"forge",materials:[{itemId:"void_essence",count:5},{itemId:"cursed_bark",count:3},{itemId:"gold_bar",count:2}],output:{itemId:"void_staff",count:1},craftTime:25,levelRequired:6,unlocked:!1},r_bear_cloak:{id:"r_bear_cloak",name:"Bear Cloak",icon:"",station:"workbench",materials:[{itemId:"bear_claw",count:4},{itemId:"fur",count:6},{itemId:"cloth",count:2}],output:{itemId:"bear_cloak",count:1},craftTime:12,levelRequired:2,unlocked:!1},r_ghost_ward:{id:"r_ghost_ward",name:"Ghost Ward",icon:"",station:"alchemy_table",materials:[{itemId:"ghost_feather",count:3},{itemId:"ectoplasm",count:2},{itemId:"herb",count:5}],output:{itemId:"ghost_ward",count:1},craftTime:12,levelRequired:4,unlocked:!1},r_ink_bomb:{id:"r_ink_bomb",name:"Ink Bomb",icon:"",station:"alchemy_table",materials:[{itemId:"ink_sac",count:3},{itemId:"slime_gel",count:2}],output:{itemId:"ink_bomb",count:3},craftTime:6,levelRequired:2,unlocked:!1},r_pilgrim_cloak:{id:"r_pilgrim_cloak",name:"Pilgrim's Cloak",icon:"",station:"enchanting_table",materials:[{itemId:"cloth",count:10},{itemId:"purification_crystal",count:2},{itemId:"shadow_essence",count:5}],output:{itemId:"pilgrim_cloak",count:1},craftTime:30,levelRequired:5,unlocked:!1},r_purifier_beacon:{id:"r_purifier_beacon",name:"Purification Beacon",icon:"",station:"enchanting_table",materials:[{itemId:"purification_crystal",count:5},{itemId:"gold_bar",count:3},{itemId:"stone",count:20}],output:{itemId:"purifier",count:1},craftTime:60,levelRequired:8,unlocked:!1}};class _0{_craftingLevel=0;_craftingXP=0;_xpToNext=100;_activeCraft=null;_unlockedRecipes=new Set;_pendingOverflow=null;_lastCompletedRecipe=null;_materialCostReduction=0;get lastCompletedRecipe(){return this._lastCompletedRecipe}setMaterialCostReduction(e){this._materialCostReduction=e}constructor(){for(const[e,t]of Object.entries(ii))t.unlocked&&this._unlockedRecipes.add(e)}get level(){return this._craftingLevel}get xp(){return this._craftingXP}get xpToNext(){return this._xpToNext}get activeCraft(){return this._activeCraft}consumeOverflow(){const e=this._pendingOverflow;return this._pendingOverflow=null,e}isRecipeUnlocked(e){return this._unlockedRecipes.has(e)}getAvailableRecipes(e){return Object.values(ii).filter(t=>t.station===e&&this._unlockedRecipes.has(t.id)&&t.levelRequired<=this._craftingLevel)}canCraft(e,t){const i=ii[e];if(!i||!this._unlockedRecipes.has(e)||i.levelRequired>this._craftingLevel)return!1;for(const s of i.materials){const a=this._materialCostReduction>0?Math.max(1,Math.ceil(s.count*(1-this._materialCostReduction))):s.count;if(!t.hasItem(s.itemId,a))return!1}return!0}startCraft(e,t){if(this._activeCraft||!this.canCraft(e,t))return!1;const i=ii[e];if(!i||!t.canAddItem(i.output.itemId,i.output.count))return!1;for(const s of i.materials){const a=this._materialCostReduction>0?Math.max(1,Math.ceil(s.count*(1-this._materialCostReduction))):s.count;t.removeItem(s.itemId,a)}return this._activeCraft={recipe:i,timer:i.craftTime},!0}update(e,t){if(!this._activeCraft)return!1;if(this._activeCraft.timer-=e,this._activeCraft.timer<=0){const i=this._activeCraft.recipe,s=t.addItem(i.output.itemId,i.output.count);s>0&&(this._pendingOverflow={itemId:i.output.itemId,count:s});const a=10+i.levelRequired*5;for(this._craftingXP+=a;this._craftingXP>=this._xpToNext;)this._craftingXP-=this._xpToNext,this._craftingLevel++,this._xpToNext=Math.floor(100*Math.pow(1.3,this._craftingLevel));return this._lastCompletedRecipe=i,this._activeCraft=null,!0}return!1}unlockRecipe(e){return ii[e]?(this._unlockedRecipes.add(e),!0):!1}onMaterialAcquired(e){const t=[];for(const[i,s]of Object.entries(ii))this._unlockedRecipes.has(i)||s.levelRequired>this._craftingLevel+2||!s.materials.some(r=>r.itemId===e)||(this._unlockedRecipes.add(i),t.push(i));return t}getRecipeName(e){return ii[e]?.name??e}serialize(){return{level:this._craftingLevel,xp:this._craftingXP,xpToNext:this._xpToNext,unlocked:[...this._unlockedRecipes]}}deserialize(e){this._craftingLevel=e.level,this._craftingXP=e.xp,this._xpToNext=e.xpToNext,this._unlockedRecipes=new Set(e.unlocked)}}const g0={damage:0,defense:0,health:0,stamina:0,speed:0,critChance:0,critDamage:0,warmth:0},Ra={purification_spread:{id:"purification_spread",name:"Light of EDILAS",description:"On kill, purifies corruption in a small radius.",trigger:"onKill",cooldown:10,chance:1,magnitude:5},corruption_absorb:{id:"corruption_absorb",name:"Corruption Siphon",description:"On hit, absorbs corruption to restore health.",trigger:"onHit",cooldown:8,chance:.3,magnitude:15},spectral_allies:{id:"spectral_allies",name:"Spectral Host",description:"On kill, summon spectral allies for 10 seconds.",trigger:"onKill",cooldown:30,chance:.5,magnitude:3},lifesteal_aura:{id:"lifesteal_aura",name:"Vampiric Presence",description:"Passively steal 5% of damage dealt as health.",trigger:"passive",cooldown:0,chance:1,magnitude:.05},elemental_burst:{id:"elemental_burst",name:"Elemental Burst",description:"On crit, release an elemental explosion.",trigger:"onCrit",cooldown:6,chance:.8,magnitude:200},shadow_phase:{id:"shadow_phase",name:"Shadow Phase",description:"On dodge, become untargetable for 2 seconds.",trigger:"onDodge",cooldown:20,chance:.5,magnitude:2},titan_slayer:{id:"titan_slayer",name:"Titan Slayer",description:"Deal 25% bonus damage to titans and bosses.",trigger:"passive",cooldown:0,chance:1,magnitude:.25},rift_walker:{id:"rift_walker",name:"Rift Walker",description:"On kill in rifts, gain bonus rift modifiers.",trigger:"onKill",cooldown:0,chance:.2,magnitude:1},undead_bane:{id:"undead_bane",name:"Undead Bane",description:"Deal 40% bonus damage to undead enemies.",trigger:"passive",cooldown:0,chance:1,magnitude:.4},void_resistance:{id:"void_resistance",name:"Void Ward",description:"Reduce void damage taken by 30%.",trigger:"onDamaged",cooldown:0,chance:1,magnitude:.3},chain_lightning:{id:"chain_lightning",name:"Chain Lightning",description:"On hit, lightning chains to 3 nearby enemies.",trigger:"onHit",cooldown:4,chance:.4,magnitude:80},berserker_rage:{id:"berserker_rage",name:"Berserker Rage",description:"On being damaged below 30% HP, gain 50% damage for 8s.",trigger:"onDamaged",cooldown:30,chance:1,magnitude:.5}};class y0{_slots=new Map([["weapon",null],["shield",null],["helmet",null],["chest",null],["legs",null],["boots",null],["ring_1",null],["ring_2",null],["amulet",null]]);_legendaryEffects=new Map;_effectCooldowns=new Map;equip(e,t){if(!ga[e])return null;const s=this._slots.get(t)??null;return this._slots.set(t,{itemId:e,slot:t,durability:100,maxDurability:100,enchantments:[]}),s}unequip(e){const t=this._slots.get(e)??null;return this._slots.set(e,null),t}getEquipped(e){return this._slots.get(e)??null}getAllEquipped(){const e=[];for(const t of this._slots.values())t&&e.push(t);return e}getTotalStats(){const e={...g0};for(const t of this._slots.values()){if(!t)continue;const i=ga[t.itemId];if(!(!i||!i.stats))for(const[s,a]of Object.entries(i.stats))s in e&&(e[s]=(e[s]??0)+a)}return e}getWeaponType(){const e=this._slots.get("weapon");return e?ga[e.itemId]?.weaponType??"sword":"fist"}degradeSlot(e,t=1){const i=this._slots.get(e);return i?(i.durability=Math.max(0,i.durability-t),i.durability<=0?(this._slots.set(e,null),!0):!1):!1}repairSlot(e){const t=this._slots.get(e);t&&(t.durability=t.maxDurability)}repairAll(){for(const e of this._slots.values())e&&(e.durability=e.maxDurability)}enchant(e,t){const i=this._slots.get(e);return!i||i.enchantments.length>=3?!1:(i.enchantments.push(t),!0)}getLegendaryEffect(e){return this._legendaryEffects.get(e)}addLegendaryEffect(e){const t=Ra[e];return t?(this._legendaryEffects.set(e,t),this._effectCooldowns.set(e,0),!0):!1}removeLegendaryEffect(e){return this._effectCooldowns.delete(e),this._legendaryEffects.delete(e)}getAllLegendaryEffects(){return[...this._legendaryEffects.values()]}triggerEffects(e){const t=[];for(const[i,s]of this._legendaryEffects)s.trigger!==e||(this._effectCooldowns.get(i)??0)>0||Math.random()>s.chance||(t.push({effectId:i,magnitude:s.magnitude}),s.cooldown>0&&this._effectCooldowns.set(i,s.cooldown));return t}updateCooldowns(e){for(const[t,i]of this._effectCooldowns)i>0&&this._effectCooldowns.set(t,Math.max(0,i-e))}serialize(){return{slots:[...this._slots.entries()],legendaryEffects:[...this._legendaryEffects.keys()],effectCooldowns:[...this._effectCooldowns.entries()]}}deserialize(e){if(Array.isArray(e)&&e.length>0&&Array.isArray(e[0])){this._slots=new Map(e);return}const t=e;if(this._slots=new Map(t.slots),t.legendaryEffects){this._legendaryEffects.clear();for(const i of t.legendaryEffects){const s=Ra[i];s&&this._legendaryEffects.set(i,s)}}t.effectCooldowns&&(this._effectCooldowns=new Map(t.effectCooldowns))}}const mi=[{id:"martha_general",name:"Martha's General Store",ownerId:"martha",icon:"",buyMarkup:1.2,sellMarkdown:.4,items:[{itemId:"health_potion",basePrice:50,stock:10,maxStock:10,restockRate:2,category:"consumable"},{itemId:"superior_health_potion",basePrice:90,stock:5,maxStock:5,restockRate:1,category:"consumable"},{itemId:"antidote",basePrice:40,stock:5,maxStock:5,restockRate:1,category:"consumable"},{itemId:"bread",basePrice:15,stock:20,maxStock:20,restockRate:5,category:"food"},{itemId:"torch",basePrice:10,stock:15,maxStock:15,restockRate:3,category:"tool"},{itemId:"rope",basePrice:25,stock:5,maxStock:5,restockRate:1,category:"tool"},{itemId:"fiber",basePrice:5,stock:30,maxStock:30,restockRate:5,category:"material"},{itemId:"wood",basePrice:8,stock:-1,maxStock:-1,restockRate:0,category:"material"},{itemId:"stone",basePrice:8,stock:-1,maxStock:-1,restockRate:0,category:"material"}]},{id:"garrett_smithy",name:"Garrett's Smithy",ownerId:"garrett",icon:"",buyMarkup:1.3,sellMarkdown:.5,items:[{itemId:"iron_sword",basePrice:200,stock:3,maxStock:3,restockRate:.5,category:"weapon"},{itemId:"silver_sword",basePrice:650,stock:1,maxStock:1,restockRate:.1,category:"weapon"},{itemId:"iron_shield",basePrice:180,stock:2,maxStock:2,restockRate:.3,category:"armor"},{itemId:"iron_helmet",basePrice:150,stock:2,maxStock:2,restockRate:.3,category:"armor"},{itemId:"chainmail_helm",basePrice:380,stock:1,maxStock:1,restockRate:.2,category:"armor"},{itemId:"chainmail_chestplate",basePrice:750,stock:1,maxStock:1,restockRate:.1,category:"armor"},{itemId:"iron_ore",basePrice:20,stock:15,maxStock:15,restockRate:3,category:"material"},{itemId:"iron_bar",basePrice:40,stock:8,maxStock:8,restockRate:1,category:"material"},{itemId:"gold_bar",basePrice:200,stock:3,maxStock:3,restockRate:.2,category:"material"},{itemId:"pickaxe",basePrice:120,stock:2,maxStock:2,restockRate:.5,category:"tool"}]},{id:"lily_herbs",name:"Lily's Apothecary",ownerId:"lily",icon:"",buyMarkup:1.15,sellMarkdown:.45,items:[{itemId:"herb",basePrice:10,stock:25,maxStock:25,restockRate:5,category:"material"},{itemId:"health_potion",basePrice:45,stock:8,maxStock:8,restockRate:2,category:"consumable"},{itemId:"antidote",basePrice:35,stock:10,maxStock:10,restockRate:2,category:"consumable"},{itemId:"stamina_potion",basePrice:55,stock:5,maxStock:5,restockRate:1,category:"consumable"},{itemId:"purification_potion",basePrice:100,stock:3,maxStock:3,restockRate:.5,category:"consumable"},{itemId:"moonpetal_seed",basePrice:150,stock:2,maxStock:2,restockRate:.1,category:"material"}]},{id:"harold_tavern",name:"Harold's Tavern",ownerId:"harold",icon:"",buyMarkup:1.1,sellMarkdown:.35,items:[{itemId:"bread",basePrice:12,stock:20,maxStock:20,restockRate:8,category:"food"},{itemId:"grilled_fish",basePrice:30,stock:8,maxStock:8,restockRate:3,category:"food"},{itemId:"mushroom_stew",basePrice:35,stock:5,maxStock:5,restockRate:2,category:"food"},{itemId:"golden_feast",basePrice:200,stock:1,maxStock:1,restockRate:.1,category:"food"}]}];class b0{_merchants=[];_nextMerchantDay=7;_merchantInterval=7;get nextMerchantDay(){return this._nextMerchantDay}generateMerchant(e){const i=[...[{itemId:"ruby",basePrice:300,stock:2,maxStock:2,restockRate:0,category:"gem"},{itemId:"sapphire",basePrice:300,stock:2,maxStock:2,restockRate:0,category:"gem"},{itemId:"emerald",basePrice:300,stock:2,maxStock:2,restockRate:0,category:"gem"},{itemId:"void_shard",basePrice:500,stock:1,maxStock:1,restockRate:0,category:"rare"},{itemId:"purification_crystal",basePrice:400,stock:2,maxStock:2,restockRate:0,category:"rare"},{itemId:"gold_bar",basePrice:180,stock:5,maxStock:5,restockRate:0,category:"material"}]].sort(()=>Math.random()-.5),s=4+Math.floor(Math.random()*3),a=i.slice(0,s),r={name:this._randomMerchantName(),icon:"",arrivalDay:e,departurDay:e+3,items:a,buyMarkup:1.4,sellMarkdown:.6,visited:!1};return this._merchants.push(r),this._nextMerchantDay=e+this._merchantInterval,r}checkArrival(e){return e>=this._nextMerchantDay?this.generateMerchant(e):null}getActiveMerchant(e){return this._merchants.find(t=>e>=t.arrivalDay&&e<=t.departurDay)??null}buyItem(e,t,i,s,a=0){const r=("items"in e?e.items:[]).find(h=>h.itemId===t);if(!r)return{success:!1,cost:0};if(r.stock>=0&&r.stock<1)return{success:!1,cost:0};const n=Math.ceil(r.basePrice*e.buyMarkup),l=a>0?Math.max(1,Math.floor(n*(1-a))):n;return s<l?{success:!1,cost:l}:i.canAddItem(t,1)?(r.stock>=1&&(r.stock=Math.floor(r.stock)-1),i.addItem(t,1),{success:!0,cost:l}):{success:!1,cost:0}}sellItem(e,t,i){if(!i.hasItem(t,1))return{success:!1,value:0};const a=e.items.find(n=>n.itemId===t)?.basePrice??10,r=Math.floor(a*e.sellMarkdown);return i.removeItem(t,1),{success:!0,value:r}}restockShops(e){for(const t of mi)for(const i of t.items)i.stock<0||i.stock<i.maxStock&&(i.stock=Math.min(i.maxStock,i.stock+i.restockRate*e/1200))}_randomMerchantName(){const e=["Magnus the Wanderer","Zara the Trader","Old Bartholomew","Silk Wind","Rose Thornberry"];return e[Math.floor(Math.random()*e.length)]}serialize(){const e={};for(const t of mi){e[t.id]={};for(const i of t.items)i.stock>=0&&(e[t.id][i.itemId]=i.stock)}return{merchants:this._merchants,nextDay:this._nextMerchantDay,shopStock:e}}deserialize(e){if(this._merchants=e.merchants,this._nextMerchantDay=e.nextDay,e.shopStock)for(const t of mi){const i=e.shopStock[t.id];if(i)for(const s of t.items)s.stock>=0&&i[s.itemId]!==void 0&&(s.stock=i[s.itemId])}}}const It={wall:{type:"wall",name:"Stone Wall",icon:"",description:"A defensive wall segment.",widthTiles:1,heightTiles:1,maxHealth:200,buildCost:[{itemId:"stone",count:5}],buildTime:5,defenseBonus:10},gate:{type:"gate",name:"Gate",icon:"",description:"An openable gate for walls.",widthTiles:2,heightTiles:1,maxHealth:300,buildCost:[{itemId:"stone",count:10},{itemId:"iron_bar",count:3}],buildTime:15,defenseBonus:5},tower:{type:"tower",name:"Guard Tower",icon:"",description:"A tower for guards. Increases vision and defense.",widthTiles:2,heightTiles:2,maxHealth:500,buildCost:[{itemId:"stone",count:30},{itemId:"wood",count:20}],buildTime:60,defenseBonus:25},workshop:{type:"workshop",name:"Workshop",icon:"",description:"A general crafting station.",widthTiles:3,heightTiles:3,maxHealth:400,buildCost:[{itemId:"wood",count:30},{itemId:"stone",count:15}],buildTime:45,provides:"workbench"},barracks:{type:"barracks",name:"Barracks",icon:"",description:"Houses guards. Increases settlement defense.",widthTiles:4,heightTiles:3,maxHealth:600,buildCost:[{itemId:"stone",count:40},{itemId:"wood",count:30},{itemId:"iron_bar",count:10}],buildTime:90,defenseBonus:40,housingCapacity:4},purifier:{type:"purifier",name:"Purification Beacon",icon:"",description:"Cleanses corruption in a radius around the settlement.",widthTiles:2,heightTiles:2,maxHealth:300,buildCost:[{itemId:"stone",count:20},{itemId:"purification_crystal",count:5}],buildTime:60,purificationRadius:10},trade_post:{type:"trade_post",name:"Trade Post",icon:"",description:"Enables trading with merchants and other settlements.",widthTiles:3,heightTiles:3,maxHealth:400,buildCost:[{itemId:"wood",count:25},{itemId:"gold_bar",count:3}],buildTime:60,provides:"trading"},farm:{type:"farm",name:"Farm Plot",icon:"",description:"Grow crops for food.",widthTiles:4,heightTiles:4,maxHealth:100,buildCost:[{itemId:"wood",count:10}],buildTime:15},house:{type:"house",name:"House",icon:"",description:"Housing for settlers.",widthTiles:3,heightTiles:3,maxHealth:300,buildCost:[{itemId:"wood",count:20},{itemId:"stone",count:10}],buildTime:30,housingCapacity:2},storage:{type:"storage",name:"Storage Chest",icon:"",description:"Extra storage for items.",widthTiles:1,heightTiles:1,maxHealth:150,buildCost:[{itemId:"wood",count:10}],buildTime:10,storageCapacity:24},forge:{type:"forge",name:"Forge",icon:"",description:"Smelting and metalworking station.",widthTiles:3,heightTiles:2,maxHealth:500,buildCost:[{itemId:"stone",count:30},{itemId:"iron_bar",count:10}],buildTime:60,provides:"forge"},alchemy_lab:{type:"alchemy_lab",name:"Alchemy Lab",icon:"",description:"Brew potions and elixirs.",widthTiles:3,heightTiles:2,maxHealth:300,buildCost:[{itemId:"wood",count:15},{itemId:"stone",count:10},{itemId:"herb",count:20}],buildTime:45,provides:"alchemy_table"},cooking_station:{type:"cooking_station",name:"Cooking Fire",icon:"",description:"Cook food for buffs and healing.",widthTiles:2,heightTiles:2,maxHealth:100,buildCost:[{itemId:"stone",count:8},{itemId:"wood",count:5}],buildTime:10,provides:"cooking_fire"},enchanting_table:{type:"enchanting_table",name:"Enchanting Table",icon:"",description:"Enchant gear with magical properties.",widthTiles:2,heightTiles:2,maxHealth:400,buildCost:[{itemId:"stone",count:20},{itemId:"gold_bar",count:5},{itemId:"void_shard",count:3}],buildTime:90,provides:"enchanting_table"},watchtower:{type:"watchtower",name:"Watchtower",icon:"",description:"Reveals nearby map. Early warning of raids.",widthTiles:2,heightTiles:2,maxHealth:400,buildCost:[{itemId:"wood",count:20},{itemId:"stone",count:15}],buildTime:45,defenseBonus:15},well:{type:"well",name:"Well",icon:"",description:"Water source for settlement.",widthTiles:1,heightTiles:1,maxHealth:200,buildCost:[{itemId:"stone",count:15}],buildTime:20},road:{type:"road",name:"Road",icon:"",description:"Increases movement speed in settlement.",widthTiles:1,heightTiles:1,maxHealth:100,buildCost:[{itemId:"stone",count:3}],buildTime:3}};class Gl{id;name;centerX;centerY;structures=[];npcs=[];defense=0;population=0;maxPopulation=0;level=1;xp=0;buildSpeedMult=1;structureHpMult=1;_nextStructId=1;constructor(e,t,i,s){this.id=e,this.name=t,this.centerX=i,this.centerY=s}placeStructure(e,t,i){const s=It[e],a={id:this._nextStructId++,type:e,tileX:t,tileY:i,health:s.maxHealth,buildProgress:0};return this.structures.push(a),a}removeStructure(e){const t=this.structures.findIndex(i=>i.id===e);return t===-1?!1:(this.structures.splice(t,1),this._recalcStats(),!0)}update(e){for(const s of this.structures)if(s.buildProgress<1){const a=It[s.type];s.buildProgress=Math.min(1,s.buildProgress+e*this.buildSpeedMult/a.buildTime)}this._recalcStats(),this.updateNPCBehaviors(e);const t=this.structures.some(s=>s.type==="well"&&s.buildProgress>=1),i=this.structures.some(s=>(s.type==="farm"||s.type==="cooking_station")&&s.buildProgress>=1);for(const s of this.npcs){let a=0;t&&(a+=1),i&&(a+=1),this.defense>20&&(a+=.5),s.satisfaction=Math.min(100,Math.max(0,s.satisfaction+a*e*.1))}}updateNPCBehaviors(e){for(const t of this.npcs){if(t.role==="idle"||t.role==="farmer")continue;(!t.behavior||t.behavior.role!==t.role)&&(t.behavior=this._initBehavior(t.role));const i=t.behavior;switch(i.timer-=e,t.role){case"guard":this._updateGuard(t,i,e);break;case"crafter":this._updateCrafter(t,i,e);break;case"explorer":this._updateExplorer(t,i,e);break;case"trader":this._updateTrader(t,i,e);break;case"healer":this._updateHealer(t,i,e);break;case"engineer":this._updateEngineer(t,i,e);break}}}getNPCState(e){return this.npcs.find(i=>i.id===e)?.behavior}_initBehavior(e){const t={role:e,state:"idle",timer:0};switch(e){case"guard":t.state="patrol",t.patrolIndex=0,t.timer=5;break;case"crafter":t.state="waiting",t.craftQueue=[],t.timer=10;break;case"explorer":t.state="exploring",t.exploreRadius=50,t.timer=15;break;case"trader":t.state="idle",t.timer=30;break;case"healer":t.state="scanning",t.timer=5;break;case"engineer":t.state="scanning",t.timer=8;break}return t}_updateGuard(e,t,i){t.timer<=0&&(t.state==="patrol"?(t.patrolIndex=((t.patrolIndex??0)+1)%4,t.timer=5+Math.random()*5):(t.state="patrol",t.timer=3))}_updateCrafter(e,t,i){t.timer<=0&&(t.state==="waiting"?this.hasStation("workbench")||this.hasStation("forge")?(t.state="crafting",t.timer=20/e.efficiency):t.timer=10:t.state==="crafting"&&(this.xp+=5,t.state="waiting",t.timer=8))}_updateExplorer(e,t,i){t.timer<=0&&(t.state==="exploring"?(t.exploreRadius=Math.min(300,(t.exploreRadius??50)+10),Math.random()<.3?(t.state="returning",t.timer=10,this.xp+=3):t.timer=15):t.state==="returning"&&(t.state="exploring",t.timer=15))}_updateTrader(e,t,i){t.timer<=0&&(t.state==="idle"?this.hasStation("trading")?(t.state="trading",t.timer=30):t.timer=20:t.state==="trading"&&(this.xp+=8,t.state="idle",t.timer=20))}_updateHealer(e,t,i){if(t.timer<=0){if(t.state==="scanning"){const s=this.npcs.find(a=>a.satisfaction<30&&a.id!==e.id);s?(t.state="healing",t.target={id:s.id},t.timer=8):t.timer=5}else if(t.state==="healing"){if(t.target?.id){const s=this.npcs.find(a=>a.id===t.target.id);s&&(s.satisfaction=Math.min(100,s.satisfaction+20))}t.state="scanning",t.timer=5}}}_updateEngineer(e,t,i){if(t.timer<=0){if(t.state==="scanning"){const s=this.structures.find(a=>{const r=It[a.type];return a.health<r.maxHealth});s?(t.state="repairing",t.target={id:s.id},t.timer=10):t.timer=8}else if(t.state==="repairing"){if(t.target?.id!=null){const s=this.structures.find(a=>a.id===t.target.id);if(s){const a=It[s.type];s.health=Math.min(a.maxHealth,s.health+a.maxHealth*.15)}}t.state="scanning",t.timer=8}}}_recalcStats(){this.defense=0,this.maxPopulation=0;for(const e of this.structures){if(e.buildProgress<1)continue;const t=It[e.type];this.defense+=t.defenseBonus??0,this.maxPopulation+=t.housingCapacity??0}for(const e of this.npcs)e.role==="guard"&&e.behavior?.state==="patrol"&&(this.defense+=2);this.population=this.npcs.length}addNPC(e,t,i="idle"){this.npcs.push({id:e,name:t,role:i,satisfaction:50,efficiency:.5}),this._recalcStats()}assignRole(e,t){const i=this.npcs.find(s=>s.id===e);return i?(i.role=t,!0):!1}getStructuresByType(e){return this.structures.filter(t=>t.type===e)}hasStation(e){return this.structures.some(t=>It[t.type].provides===e&&t.buildProgress>=1)}getNPCsByRole(e){return this.npcs.filter(t=>t.role===e)}serialize(){return{id:this.id,name:this.name,centerX:this.centerX,centerY:this.centerY,structures:this.structures,npcs:this.npcs.map(e=>({id:e.id,name:e.name,role:e.role,satisfaction:e.satisfaction,efficiency:e.efficiency,behavior:e.behavior})),level:this.level,xp:this.xp,nextStructId:this._nextStructId}}}class w0{_settlements=[];_nextId=1;_supplyRoutes=[];_activeCaravans=[];_nextRouteId=1;_nextCaravanId=1;get settlements(){return this._settlements}createSettlement(e,t,i){const s=new Gl(this._nextId++,e,t,i);return this._settlements.push(s),s}getSettlement(e){return this._settlements.find(t=>t.id===e)}getNearestSettlement(e,t){let i,s=1/0;for(const a of this._settlements){const r=a.centerX-e,n=a.centerY-t,l=r*r+n*n;l<s&&(s=l,i=a)}return i}update(e){for(const t of this._settlements)t.update(e);this.updateCaravans(e)}get supplyRoutes(){return this._supplyRoutes}get activeCaravans(){return this._activeCaravans}createRoute(e,t){const i=this.getSettlement(e),s=this.getSettlement(t);if(!i||!s||this._supplyRoutes.some(c=>c.fromSettlementId===e&&c.toSettlementId===t||c.fromSettlementId===t&&c.toSettlementId===e))return null;const r=i.centerX-s.centerX,n=i.centerY-s.centerY,l=Math.sqrt(r*r+n*n),h={id:this._nextRouteId++,fromSettlementId:e,toSettlementId:t,distance:l,dangerLevel:Math.min(1,l/3e3),established:!0,efficiency:.5};return this._supplyRoutes.push(h),h}dispatchCaravan(e,t,i=1,s=0){const a=this._supplyRoutes.find(n=>n.id===e);if(!a||!a.established)return null;const r={id:this._nextCaravanId++,routeId:e,status:"loading",progress:0,speed:30*(1+a.efficiency*.5),cargo:t,guards:i,departureTime:s};return this._activeCaravans.push(r),r}updateCaravans(e){for(const t of this._activeCaravans){const i=this._supplyRoutes.find(s=>s.id===t.routeId);if(i)switch(t.status){case"loading":t.progress+=e/5,t.progress>=1&&(t.progress=0,t.status="traveling");break;case"traveling":{const s=t.speed*e;t.progress+=s/i.distance;const a=i.dangerLevel*.001*e/Math.max(1,t.guards);if(Math.random()<a){t.status="ambushed";break}t.progress>=1&&(t.progress=1,t.status="unloading",i.efficiency=Math.min(1,i.efficiency+.02));break}case"unloading":t.progress-=e/3,t.progress<=0&&(t.status="arrived");break;case"ambushed":t.cargo=t.cargo.map(s=>({...s,count:Math.max(0,s.count-Math.ceil(s.count*.5))})),t.status="returning";break;case"returning":t.progress-=t.speed*e/(i.distance||1),t.progress<=0&&(t.status="arrived");break}}this._activeCaravans=this._activeCaravans.filter(t=>t.status!=="arrived")}getRouteEfficiency(e){return this._supplyRoutes.find(i=>i.id===e)?.efficiency??0}getConnectedSettlements(e){const t=[];for(const i of this._supplyRoutes)i.established&&(i.fromSettlementId===e?t.push(i.toSettlementId):i.toSettlementId===e&&t.push(i.fromSettlementId));return t}serialize(){return{settlements:this._settlements.map(e=>e.serialize()),nextId:this._nextId,supplyRoutes:this._supplyRoutes,activeCaravans:this._activeCaravans,nextRouteId:this._nextRouteId,nextCaravanId:this._nextCaravanId}}deserialize(e){if(e.nextId&&(this._nextId=e.nextId),e.supplyRoutes&&(this._supplyRoutes=e.supplyRoutes),e.activeCaravans&&(this._activeCaravans=e.activeCaravans),e.nextRouteId&&(this._nextRouteId=e.nextRouteId),e.nextCaravanId&&(this._nextCaravanId=e.nextCaravanId),e.settlements){this._settlements=[];for(const t of e.settlements){const i=t,s=new Gl(i.id,i.name,i.centerX,i.centerY);s.structures=i.structures??[],s.npcs=(i.npcs??[]).map(a=>({id:a.id,name:a.name,role:a.role,satisfaction:a.satisfaction,efficiency:a.efficiency,behavior:a.behavior})),s.level=i.level??1,s.xp=i.xp??0,s._nextStructId=i.nextStructId??1,this._settlements.push(s)}}}}const dd={empowered:{name:"Empowered",icon:"",description:"Enemies deal +30% damage",color:"#ff4444"},fortified:{name:"Fortified",icon:"",description:"Enemies have +50% HP",color:"#4488ff"},swift:{name:"Swift",icon:"",description:"Enemies move 40% faster",color:"#ffff44"},corrupted:{name:"Corrupted",icon:"",description:"Corruption damage over time",color:"#aa44ff"},dark:{name:"Dark",icon:"",description:"Greatly reduced visibility",color:"#222244"},explosive:{name:"Explosive",icon:"",description:"Enemies explode on death",color:"#ff8800"},regenerating:{name:"Regenerating",icon:"",description:"Enemies slowly regenerate HP",color:"#44ff44"},swarm:{name:"Swarm",icon:"",description:"Double enemy spawns",color:"#888844"},boss_rush:{name:"Boss Rush",icon:"",description:"Mini-boss in every room",color:"#ff44ff"},treasure:{name:"Treasure",icon:"",description:"Double loot drops",color:"#ffcc44"},cursed:{name:"Cursed",icon:"",description:"Cannot heal inside the rift",color:"#884444"},burning:{name:"Burning",icon:"",description:"Fire damage ticks",color:"#ff4400"},frozen:{name:"Frozen",icon:"",description:"Movement slowed by 20%",color:"#88ccff"},void_touched:{name:"Void-Touched",icon:"",description:"Random teleportation effects",color:"#6600cc"}},v0=Object.keys(dd);class S0{_rifts=[];_nextId=1;_highestDepth=0;_totalRiftsCompleted=0;_spawnTimer=0;_spawnInterval=300;get rifts(){return this._rifts}get highestDepth(){return this._highestDepth}get totalCompleted(){return this._totalRiftsCompleted}spawnRift(e,t,i){const s={id:this._nextId++,seed:i??Math.floor(Math.random()*99999999),worldX:e,worldY:t,maxDepthReached:0,currentDepth:0,floors:[],active:!1,totalKills:0,totalLoot:0};for(let a=1;a<=100;a++)s.floors.push(this._generateFloorDef(a,s.seed+a));return this._rifts.push(s),s}enterRift(e){const t=this._rifts.find(i=>i.id===e);return t?(t.active=!0,t.currentDepth=1,t.floors[0]??null):null}advanceFloor(e){const t=this._rifts.find(s=>s.id===e);if(!t||!t.active)return null;const i=t.floors[t.currentDepth-1];return i&&(i.completed=!0),t.currentDepth++,t.currentDepth>t.maxDepthReached&&(t.maxDepthReached=t.currentDepth,t.currentDepth>this._highestDepth&&(this._highestDepth=t.currentDepth)),t.floors[t.currentDepth-1]??null}exitRift(e){const t=this._rifts.find(i=>i.id===e);t&&(t.active=!1,this._totalRiftsCompleted++)}removeRift(e){this._rifts=this._rifts.filter(t=>t.id!==e)}update(e,t,i,s){this._spawnTimer+=e;const a=this._spawnInterval*(1-s*.5);if(this._spawnTimer>=a){this._spawnTimer=0;const r=Math.random()*Math.PI*2,n=200+Math.random()*400,l=t+Math.cos(r)*n,h=i+Math.sin(r)*n;this.spawnRift(l,h)}for(;this._rifts.length>10;){const r=this._rifts.find(n=>!n.active);if(r)this.removeRift(r.id);else break}}_generateFloorDef(e,t){const i=1+e*.15,s=1+e*.1,a=Math.min(12,4+Math.floor(e/3)),r=Math.min(4,Math.floor(e/5)+1),n=[],l=this._seededRandom(t),h=[...v0];for(let d=0;d<r&&h.length>0;d++){const u=Math.floor(l()*h.length);n.push(h[u]),h.splice(u,1)}const c=e>10?Math.max(60,300-e*5):0;return{depth:e,roomCount:a,modifiers:n,enemyScaling:i,lootBonus:s,timeLimit:c,completed:!1}}getModifierInfo(e){return dd[e]}_seededRandom(e){let t=e;return()=>{t|=0,t=t+1831565813|0;let i=Math.imul(t^t>>>15,1|t);return i=i+Math.imul(i^i>>>7,61|i)^i,((i^i>>>14)>>>0)/4294967296}}serialize(){return{highestDepth:this._highestDepth,totalCompleted:this._totalRiftsCompleted,rifts:this._rifts.map(e=>({...e,floors:e.floors.map(t=>({...t}))}))}}deserialize(e){this._highestDepth=e.highestDepth,this._totalRiftsCompleted=e.totalCompleted,this._rifts=e.rifts,this._nextId=Math.max(...e.rifts.map(t=>t.id),0)+1}}const ys={forest_titan:{id:"forest_titan",name:"Forest Titan",icon:"",biome:"rotwood",description:"A massive living tree creature. Creates fallen trees, destroys structures.",maxHealth:5e3,armorStages:3,damage:80,speed:20,aggroRange:200,footprintFrequency:30,worldEffect:{type:"terrain_destruction",radius:5,duration:60,corruptionIncrease:.05},corruptionReduction:.2,respawnDays:30,lootTable:[{itemId:"titan_bone",count:5,chance:1},{itemId:"wood",count:100,chance:1},{itemId:"purification_crystal",count:3,chance:.5}],spriteType:"goblin_beast"},lava_titan:{id:"lava_titan",name:"Lava Titan",icon:"",biome:"ashlands",description:"A molten golem of living magma. Creates rivers of fire.",maxHealth:7e3,armorStages:4,damage:100,speed:15,aggroRange:180,footprintFrequency:25,worldEffect:{type:"fire_trail",radius:3,duration:120,corruptionIncrease:.08},corruptionReduction:.25,respawnDays:45,lootTable:[{itemId:"titan_bone",count:5,chance:1},{itemId:"ruby",count:5,chance:.8},{itemId:"void_shard",count:2,chance:.3}],spriteType:"goblin_rider"},sea_leviathan:{id:"sea_leviathan",name:"Sea Leviathan",icon:"",biome:"drowned_depths",description:"An ancient sea creature. Floods regions temporarily.",maxHealth:6e3,armorStages:3,damage:90,speed:25,aggroRange:250,footprintFrequency:40,worldEffect:{type:"flood",radius:8,duration:180,corruptionIncrease:.06},corruptionReduction:.2,respawnDays:40,lootTable:[{itemId:"titan_bone",count:5,chance:1},{itemId:"sapphire",count:5,chance:.8},{itemId:"corruption_essence",count:10,chance:.6}]},bone_colossus:{id:"bone_colossus",name:"Bone Colossus",icon:"",biome:"bone_wastes",description:"A titanic skeleton construct. Raises undead hordes.",maxHealth:8e3,armorStages:4,damage:110,speed:12,aggroRange:200,footprintFrequency:20,worldEffect:{type:"undead_spawn",radius:10,duration:300,corruptionIncrease:.1},corruptionReduction:.3,respawnDays:60,lootTable:[{itemId:"titan_bone",count:8,chance:1},{itemId:"bone_fragment",count:50,chance:1},{itemId:"void_gem",count:1,chance:.2}],spriteType:"skeleton_king"},void_serpent:{id:"void_serpent",name:"Void Serpent",icon:"",biome:"the_void",description:"A reality-warping serpent. Distorts terrain around it.",maxHealth:1e4,armorStages:5,damage:130,speed:30,aggroRange:300,footprintFrequency:15,worldEffect:{type:"terrain_warp",radius:6,duration:600,corruptionIncrease:.15},corruptionReduction:.4,respawnDays:90,lootTable:[{itemId:"titan_bone",count:10,chance:1},{itemId:"void_shard",count:10,chance:1},{itemId:"void_gem",count:3,chance:.5}]}},k0={sporelord:"goblin_beast",ember_titan:"goblin_rider",ancient_guardian:"ancient_boss"};function T0(o){const e=ys[o];return e?.spriteType?e.spriteType:k0[o]}const M0={ballista:{type:"ballista",name:"Giant Ballista",icon:"",damage:500,range:400,reloadTime:8,buildCost:[{itemId:"wood",count:40},{itemId:"iron_bar",count:15}],specialEffect:"armor_pierce"},catapult:{type:"catapult",name:"Siege Catapult",icon:"",damage:800,range:600,reloadTime:15,buildCost:[{itemId:"wood",count:60},{itemId:"stone",count:40}],specialEffect:"area_damage"},harpoon_launcher:{type:"harpoon_launcher",name:"Harpoon Launcher",icon:"",damage:350,range:300,reloadTime:5,buildCost:[{itemId:"iron_bar",count:20},{itemId:"rope",count:10}],specialEffect:"slow"},lightning_rod:{type:"lightning_rod",name:"Lightning Rod",icon:"",damage:1200,range:250,reloadTime:25,buildCost:[{itemId:"gold_bar",count:10},{itemId:"void_shard",count:5}],specialEffect:"stun"}},C0={pitfall:{type:"pitfall",name:"Titan Pitfall",icon:"",damage:200,effect:"immobilize",effectDuration:10,buildCost:[{itemId:"stone",count:30},{itemId:"wood",count:20}],triggerRadius:80},spike_trap:{type:"spike_trap",name:"Mega Spike Trap",icon:"",damage:600,effect:"bleed",effectDuration:15,buildCost:[{itemId:"iron_bar",count:25},{itemId:"stone",count:15}],triggerRadius:60},net_launcher:{type:"net_launcher",name:"Titan Net",icon:"",damage:50,effect:"slow",effectDuration:20,buildCost:[{itemId:"rope",count:30},{itemId:"wood",count:15}],triggerRadius:100},explosive_mine:{type:"explosive_mine",name:"Explosive Mine",icon:"",damage:1e3,effect:"stun",effectDuration:5,buildCost:[{itemId:"iron_bar",count:10},{itemId:"sulfur",count:15}],triggerRadius:70}},P0={forest_titan:{types:["corruption_boost"],radius:300},lava_titan:{types:["terrain_damage"],radius:200},sea_leviathan:{types:["weather_change"],radius:400},bone_colossus:{types:["enemy_buff"],radius:350},void_serpent:{types:["corruption_boost","enemy_buff"],radius:250}};class I0{_titans=new Map;_footprints=[];_activeBoss=null;_siegeWeapons=[];_traps=[];_armorPlates=new Map;_nextSiegeId=1;_nextTrapId=1;_respawnMult=1;setRespawnMultiplier(e){this._respawnMult=e}get footprints(){return this._footprints}get activeBossFight(){return this._activeBoss}get siegeWeapons(){return this._siegeWeapons}endBossPhase(e){if(!this._activeBoss)return;const t=this._titans.get(this._activeBoss);if(!t){this._activeBoss=null;return}e?(t.state="defeated",t.killCount++,t.respawnTimer=t.def.respawnDays*60):(t.state="enraged",t.enrageTimer=60),this._activeBoss=null}get traps(){return this._traps}constructor(){for(const[e,t]of Object.entries(ys)){const i=Math.random()*2e3+500,s=Math.random()*2e3+500,a=e;this._titans.set(a,{def:t,x:i,y:s,health:t.maxHealth,armorBroken:0,state:"roaming",roamAngle:Math.random()*Math.PI*2,roamTimer:10+Math.random()*20,footprintTimer:t.footprintFrequency,respawnTimer:0,enrageTimer:0,killCount:0}),this._armorPlates.set(a,this._createArmorPlates(a))}}_createArmorPlates(e){return this._createArmorPlatesScaled(e,0)}_createArmorPlatesScaled(e,t){const s=ys[e].maxHealth*(1+t*.2),a=Math.floor(s*.3),r=["physical","fire","ice","void","nature"],n=[];for(let l=0;l<3;l++){const h=r[l%r.length],c=r[(l+2)%r.length];n.push({index:l,maxHealth:a,health:a,broken:!1,element:h,weakness:c})}return n}getTitan(e){return this._titans.get(e)}getAllTitans(){return[...this._titans.values()]}getTitanEnvironmentalEffects(){const e=[];for(const[t,i]of this._titans){if(i.state!=="roaming"&&i.state!=="enraged")continue;const s=P0[t],a=i.state==="enraged"?1:.6;for(const r of s.types)e.push({titanId:t,effectType:r,centerX:i.x,centerY:i.y,radius:s.radius,intensity:a})}return e}getEffectsAtPosition(e,t){return this.getTitanEnvironmentalEffects().filter(s=>{const a=e-s.centerX,r=t-s.centerY;return a*a+r*r<=s.radius*s.radius})}update(e,t,i){for(const[s,a]of this._titans){if(a.state==="defeated"){a.respawnTimer-=e*(1/this._respawnMult),a.respawnTimer<=0&&(a.state="roaming",a.health=a.def.maxHealth*(1+a.killCount*.2),a.armorBroken=0,this._armorPlates.set(s,this._createArmorPlatesScaled(s,a.killCount)),a.x=Math.random()*2e3+500,a.y=Math.random()*2e3+500);continue}if(a.state==="dormant"||a.state==="boss_phase")continue;const r=t-a.x,n=i-a.y,l=Math.sqrt(r*r+n*n);if(l<a.def.aggroRange&&a.state==="roaming"&&(a.state="enraged",a.enrageTimer=30),a.state==="roaming"&&(a.roamTimer-=e,a.roamTimer<=0&&(a.roamAngle=Math.random()*Math.PI*2,a.roamTimer=10+Math.random()*30),a.x+=Math.cos(a.roamAngle)*a.def.speed*e,a.y+=Math.sin(a.roamAngle)*a.def.speed*e),a.state==="enraged"){a.enrageTimer-=e;const h=r/(l||1),c=n/(l||1);a.x+=h*a.def.speed*1.5*e,a.y+=c*a.def.speed*1.5*e,(a.enrageTimer<=0||l>a.def.aggroRange*2)&&(a.state="roaming")}a.footprintTimer-=e,a.footprintTimer<=0&&(a.footprintTimer=a.def.footprintFrequency,this._footprints.push({x:a.x,y:a.y,titanId:s,age:0,maxAge:600}))}for(let s=this._footprints.length-1;s>=0;s--){const a=this._footprints[s];a.age+=e,a.age>=a.maxAge&&this._footprints.splice(s,1)}for(const s of this._siegeWeapons)s.reloadTimer>0&&(s.reloadTimer=Math.max(0,s.reloadTimer-e));this.checkTraps()}attackTitan(e,t){const i=this._titans.get(e);if(!i||i.state==="defeated"||i.state==="dormant")return{killed:!1,armorBroken:!1,bossPhase:!1};i.health-=t;const s=i.def.maxHealth/(i.def.armorStages+1),a=Math.floor((i.def.maxHealth-i.health)/s),r=a>i.armorBroken;return i.armorBroken=Math.min(a,i.def.armorStages),i.armorBroken>=i.def.armorStages&&i.state!=="boss_phase"?(i.state="boss_phase",this._activeBoss=e,{killed:!1,armorBroken:r,bossPhase:!0}):i.health<=0?(i.state="defeated",i.killCount++,i.respawnTimer=i.def.respawnDays*60,this._activeBoss=null,{killed:!0,armorBroken:r,bossPhase:!1,loot:this.getTitanLoot(e)}):{killed:!1,armorBroken:r,bossPhase:!1}}placeSiegeWeapon(e,t,i,s=10){const a={id:this._nextSiegeId++,type:e,x:t,y:i,reloadTimer:0,ammo:s};return this._siegeWeapons.push(a),a}fireSiegeWeapon(e,t){const i=this._siegeWeapons.find(c=>c.id===e);if(!i||i.reloadTimer>0||i.ammo<=0)return{hit:!1,damage:0,effect:void 0};const s=this._titans.get(t);if(!s||s.state==="defeated"||s.state==="dormant")return{hit:!1,damage:0,effect:void 0};const a=M0[i.type],r=s.x-i.x,n=s.y-i.y;if(Math.sqrt(r*r+n*n)>a.range)return{hit:!1,damage:0,effect:void 0};i.reloadTimer=a.reloadTime,i.ammo--;const h=this._damageArmorPlates(t,a.damage);return s.health-=h,{hit:!0,damage:a.damage,effect:a.specialEffect}}placeTrap(e,t,i){const s={id:this._nextTrapId++,type:e,x:t,y:i,triggered:!1};return this._traps.push(s),s}checkTraps(){const e=[];for(const t of this._traps){if(t.triggered)continue;const i=C0[t.type];for(const[s,a]of this._titans){if(a.state==="defeated"||a.state==="dormant")continue;const r=a.x-t.x,n=a.y-t.y;if(Math.sqrt(r*r+n*n)<=i.triggerRadius){t.triggered=!0;const h=this._damageArmorPlates(s,i.damage);a.health-=h,e.push({titanId:s,trapType:t.type,damage:i.damage,effect:i.effect});break}}}return this._traps=this._traps.filter(t=>!t.triggered),e}getArmorPlates(e){return this._armorPlates.get(e)??[]}allPlatesBroken(e){const t=this._armorPlates.get(e);return t?t.every(i=>i.broken):!0}_damageArmorPlates(e,t){const i=this._armorPlates.get(e);if(!i)return t;let s=t;for(const a of i){if(a.broken||s<=0)continue;const r=Math.min(a.health,s);a.health-=r,s-=r,a.health<=0&&(a.broken=!0)}return s}allTitansDefeated(){for(const e of this._titans.values())if(e.state!=="defeated"&&e.killCount===0)return!1;return!0}getTitanLoot(e){const t=this._titans.get(e);if(!t)return[];const i=[];for(const s of t.def.lootTable)Math.random()<s.chance&&i.push({itemId:s.itemId,count:s.count});return i}serialize(){const e=[];for(const[t,i]of this._titans){const{def:s,...a}=i;e.push([t,a])}return{titans:e,siegeWeapons:this._siegeWeapons,traps:this._traps,armorPlates:[...this._armorPlates.entries()],nextSiegeId:this._nextSiegeId,nextTrapId:this._nextTrapId}}deserialize(e){for(const[t,i]of e.titans){const s=ys[t];s&&this._titans.set(t,{...i,def:s})}e.siegeWeapons&&(this._siegeWeapons=e.siegeWeapons),e.traps&&(this._traps=e.traps),e.armorPlates&&(this._armorPlates=new Map(e.armorPlates)),e.nextSiegeId&&(this._nextSiegeId=e.nextSiegeId),e.nextTrapId&&(this._nextTrapId=e.nextTrapId)}}const A0=[{id:"prologue_intro",speaker:"Narrator",lines:["You awaken at the edge of a village, the air thick with a strange haze.","Your memory is blank. You know only your name and the ache of a long journey.","A figure approaches  an old woman. She looks at you with recognition.",'"I knew you would come," she says. "My granddaughter... or is it grandson?"','"No matter. Come inside. There is much to tell you."','"The corruption spreads. And you are the only one who can stop it."']},{id:"mayor_welcome",speaker:"Mayor Thomas",lines:['"Welcome to Haven, traveler. I am Thomas, the mayor."','"This village has survived the corruption longer than most, but we grow weaker."','"We need strong arms and brave hearts. Will you help us?"','"Speak with the villagers. Learn their crafts. Together, we can push back the darkness."']},{id:"first_friend",speaker:"Narrator",lines:["You have made your first friend in Haven.","In a world consumed by corruption, every bond is a candle against the dark."]},{id:"shopkeeper_story",speaker:"Martha",lines:['"I have run this shop since before the corruption came."','"My husband... he went to fight it. Never came back."','"But I keep the shop open. The village needs supplies, and I need purpose."']},{id:"blacksmith_wisdom",speaker:"Garrett",lines:[`"Steel won't save you from corruption, but it'll keep you alive long enough to find what will."`,'"I forge weapons not because I believe in war, but because I believe in survival."']},{id:"wizard_prophecy",speaker:"Eldric",lines:['"There are three seals hidden across the land  Earth, Water, and Spirit."','"Collect them all, and we can perform a ritual to banish the corruption for good."','"But beware  the corruption guards its secrets fiercely."']},{id:"lily_secret",speaker:"Lily",lines:[`"Don't tell anyone, but... I hear voices at night."`,`"They whisper about a city of light. A place where corruption can't reach."`,`"EDILAS, they call it. I think it's real. I think you can find it."`]},{id:"innkeeper_rumors",speaker:"Harold",lines:['"Strange things happening lately. The nights are getting longer."','"Travelers speak of shadows moving in the Rotwood."','"And the mines... something stirs in the deep."']},{id:"curse_hint",speaker:"Eldric",lines:['"The corruption is not natural. It was created  by someone or something."','"The ancient spirits know the truth, but they speak only to those who have purified the land."']},{id:"mine_floor_10",speaker:"Narrator",lines:["The mines grow darker as you descend.","Strange crystals pulse with an inner light. The corruption seeps through the rock."]},{id:"mine_floor_25",speaker:"Whispering Voice",lines:['"Deeper... come deeper..."',`"The truth lies below. The corruption's heart beats in the stone."`]},{id:"curse_reveal",speaker:"Ancient Spirit",lines:['"At last, one who can hear me."','"The corruption was born from grief  a powerful sorcerer who lost everything."','"His pain became a curse, and the curse consumed the world."','"Only by gathering the three seals can the ritual of cleansing be performed."']},{id:"spirit_backstory",speaker:"Ancient Spirit",lines:['"Long ago, this land was whole. The sorcerer loved deeply  and lost deeply."','"His tears became poison. His rage became fire. His despair became void."','"Three seals were created to contain his power, but they were scattered."']},{id:"spirit_hope",speaker:"Ancient Spirit",lines:['"You carry the hope of this world, Pilgrim."','"The bonds you have forged with the people of Haven are your true strength."',`"When the time comes, those bonds will shield you from the corruption's final assault."`]},{id:"ending_good",speaker:"Narrator",lines:["The final corruption core shatters.","Light floods the land. The darkness recedes.","Haven celebrates. The pilgrimage is complete."]},{id:"ending_ceremony",speaker:"Mayor Thomas",lines:['"Today, we celebrate not just the lifting of the curse..."','"...but the pilgrim who made it possible."','"May the light of EDILAS shine upon us all."']},{id:"epilogue_next_morning",speaker:"Narrator",lines:["The next morning dawns bright and clear  the first true dawn in years.","The village stirs with a renewed energy."]},{id:"epilogue_grandmother_letter",speaker:"Grandmother",lines:['"My dearest child,"','"If you are reading this, then you have done what I could not."','"You have walked the path through darkness and emerged into light."','"EDILAS is not a place on any map."','"It is the world that remains when corruption is defeated,"','"when hope outlasts despair, when the pilgrim refuses to stop walking."','"Rest now, my child. You have earned it."','"With all my love,"','" Grandmother"']},{id:"epilogue_celebration",speaker:"Mayor Thomas",lines:['"A toast! To the pilgrim who saved us all!"','"May Haven stand for a thousand years more!"']},{id:"epilogue_villagers",speaker:"Villagers",lines:['Martha: "My shop is yours, pilgrim. Anything you need, on the house."','Garrett: "Finest warrior I ever armed. You did good."','Lily: "I knew you could do it. I always knew."','Harold: "Drinks are free tonight! And every night!"','Eldric: "The seals are at peace. The cycle is complete."',`Dr. Elena: "You healed the world. Not bad for a day's work."`]},{id:"epilogue_spirit_farewell",speaker:"Ancient Spirit",lines:['"It is done. The corruption fades."','"I can feel the land breathing again."','"You have my eternal gratitude, Pilgrim."','"But know this  the corruption is patient."','"It will return, in time. As it always does."','"When that day comes, another pilgrim will rise."','"That is the cycle. That is the hope."','"Farewell, child of light."']},{id:"epilogue_closing",speaker:"Narrator",lines:["The sun sets on Haven, painting the sky in shades of gold and amber.","For the first time in years, the stars are visible.","The corruption is gone. The seals are restored.","But somewhere, in the deepest reaches of the world...","...a faint pulse remains.","The cycle continues.","And EDILAS waits.","THE END","...","Or is it?","[New Game+ Unlocked]"]},{id:"seal_earth_found",speaker:"Narrator",lines:["You have found the Seal of Earth. The ground hums with ancient power."]},{id:"seal_water_found",speaker:"Narrator",lines:["You have found the Seal of Water. Waves of calm energy wash over you."]},{id:"seal_spirit_found",speaker:"Narrator",lines:["You have found the Seal of Spirit. Ghostly whispers swirl around you."]},{id:"wizard_one_seal",speaker:"Eldric",lines:['"You found a seal! Excellent. But one alone is not enough."','"The ritual requires all three. Keep searching."']},{id:"wizard_two_seals",speaker:"Eldric",lines:['"Two seals! The magic grows stronger."','"One more remains. The corruption will fight harder to keep it hidden."']},{id:"wizard_all_seals",speaker:"Eldric",lines:['"All three seals! The ritual can begin!"','"Meet me at the ancient circle when you are ready."','"This ends tonight."']},{id:"seal_ritual_begin",speaker:"Eldric",lines:['"Place the seals upon the altars."','"Earth... Water... Spirit..."','"By the ancient pact, I call upon the light!"']},{id:"seal_ritual_climax",speaker:"Narrator",lines:["The seals glow with blinding intensity.","The ground trembles. The corruption screams.","A pillar of light erupts from the circle, piercing the sky."]},{id:"curse_floor_75",speaker:"Narrator",lines:["The mine shudders. You are close to the corruption's heart."]},{id:"curse_floor_100",speaker:"Narrator",lines:["The deepest chamber of the mine lies before you. The corruption pulses with raw malice."]},{id:"mayor_curse_aware",speaker:"Mayor Thomas",lines:['"The corruption is real, then. I feared as much. What do you need from us?"']},{id:"martha_curse_aware",speaker:"Martha",lines:[`"Corruption or no corruption, we keep going. That's what Haven does."`]}],R0=[{id:"ct_prologue",dialogueId:"prologue_intro",condition:"game_start",oneShot:!0},{id:"ct_mayor",dialogueId:"mayor_welcome",condition:"npc_met_mayor",oneShot:!0},{id:"ct_wizard_prophecy",dialogueId:"wizard_prophecy",condition:"npc_met_eldric",oneShot:!0},{id:"ct_lily_secret",dialogueId:"lily_secret",condition:"friendship_lily_3",oneShot:!0},{id:"ct_curse_hint",dialogueId:"curse_hint",condition:"corruption_purified_3",oneShot:!0},{id:"ct_curse_reveal",dialogueId:"curse_reveal",condition:"corruption_purified_4",oneShot:!0},{id:"ct_spirit_backstory",dialogueId:"spirit_backstory",condition:"corruption_purified_5",oneShot:!0},{id:"ct_spirit_hope",dialogueId:"spirit_hope",condition:"corruption_purified_5_friendship_5",oneShot:!0},{id:"ct_mine_deep",dialogueId:"mine_floor_25",condition:"mine_floor_25",oneShot:!0},{id:"ct_seal_earth",dialogueId:"seal_earth_found",condition:"seal_earth_collected",oneShot:!0},{id:"ct_seal_water",dialogueId:"seal_water_found",condition:"seal_water_collected",oneShot:!0},{id:"ct_seal_spirit",dialogueId:"seal_spirit_found",condition:"seal_spirit_collected",oneShot:!0},{id:"ct_ritual_ready",dialogueId:"wizard_all_seals",condition:"all_seals_collected",oneShot:!0}],ta=[{id:"ms_awakening",chapter:"prologue",name:"Awakening",description:"You awaken at the edge of Haven with no memory. Find Elder Miriam.",objectives:[{description:"Speak to Elder Miriam",count:1}],reward:{xp:50,gold:0},dialogue:{start:"A world consumed by corruption... and you are its last hope.",progress:"The Elder must know more about what happened.",complete:"Miriam told you of EDILAS  a mythical city of purity. The pilgrimage begins."}},{id:"ms_first_blade",chapter:"prologue",name:"First Blade",description:"Garrett the blacksmith will forge you a weapon  if you bring materials.",objectives:[{description:"Gather 5 iron ore",count:5},{description:"Deliver to Garrett",count:1}],reward:{xp:100,gold:50,items:[{itemId:"iron_sword",count:1}]},biomeUnlocks:"rotwood",dialogue:{start:'Garrett grunts. "You want a blade? Bring me ore. 5 pieces."',progress:"Keep mining. Garrett is strict about quality.",complete:'"Fine work." Garrett hands you a sturdy iron sword. The Rotwood awaits.'}},{id:"ms_rotwood_core",chapter:"chapter_1_rotwood",name:"Heart of the Rot",description:"The Sporelord guards the corruption core in Rotwood's deepest dungeon.",objectives:[{description:"Enter Rotwood Dungeon",count:1},{description:"Defeat the Sporelord",count:1},{description:"Purify the Corruption Core",count:1}],bossId:"sporelord",biomeUnlocks:"ashlands",reward:{xp:500,gold:300,items:[{itemId:"purification_crystal",count:3}]},dialogue:{start:"The forest groans with corruption. Deep within lies the Sporelord  kill it, and you purify the biome.",progress:"Follow the mushroom trails. They lead to the corruption core.",complete:"The Sporelord falls. Light returns to the forest. But the Ashlands burn ahead..."}},{id:"ms_ashlands_core",chapter:"chapter_2_ashlands",name:"Forge of the Fallen",description:"The Flame Lord controls an ancient forge, fueling the corruption's spread.",objectives:[{description:"Survive the Ashlands heat (reach the ruins)",count:1},{description:"Defeat the Flame Lord",count:1},{description:"Purify the Corruption Core",count:1}],bossId:"flame_lord",biomeUnlocks:"drowned_depths",reward:{xp:1e3,gold:600,items:[{itemId:"ruby",count:5}]},dialogue:{start:"The Ashlands burn eternally. An ancient forge  corrupted  powers the fire.",progress:"The heat is unbearable. You need fire-resistant equipment.",complete:"The Flame Lord crumbles. The forge quiets. Ahead, floodwaters rise..."}},{id:"ms_drowned_core",chapter:"chapter_3_drowned",name:"The Sunken Fleet",description:"The Drowned Admiral commands an undead armada beneath the waves.",objectives:[{description:"Navigate the flooded ruins",count:1},{description:"Defeat the Drowned Admiral",count:1},{description:"Purify the Corruption Core",count:1}],bossId:"drowned_admiral",biomeUnlocks:"bone_wastes",reward:{xp:1500,gold:1e3,items:[{itemId:"sapphire",count:5}]},dialogue:{start:"Beneath the waterline, a fleet of ghost ships obeys a dead captain.",progress:"The current pulls you deeper. Hold your breath.",complete:"The Admiral sinks for the last time. The waters recede. Only death lies ahead."}},{id:"ms_bone_core",chapter:"chapter_4_bone",name:"The Lich's Throne",description:"The Lich Empress raises an undead army. End her reign.",objectives:[{description:"Storm the Bone Citadel",count:1},{description:"Defeat the Lich Empress",count:1},{description:"Purify the Corruption Core",count:1}],bossId:"lich_empress",biomeUnlocks:"the_void",reward:{xp:2500,gold:2e3,items:[{itemId:"void_shard",count:5}]},dialogue:{start:"An empire of bones. At its center, a queen who refused to die.",progress:"Break through the undead legions. Find the throne room.",complete:"The Empress crumbles to dust. Reality itself begins to crack ahead..."}},{id:"ms_void_core",chapter:"chapter_5_void",name:"Edge of Oblivion",description:"The Void Emperor threatens to consume reality itself.",objectives:[{description:"Cross the fractured plains",count:1},{description:"Defeat the Void Emperor",count:1},{description:"Purify the final Corruption Core",count:1}],bossId:"void_emperor",biomeUnlocks:"edilas",reward:{xp:5e3,gold:5e3,items:[{itemId:"void_gem",count:3}]},dialogue:{start:"Where reality ends and nothing begins. The final corruption awaits.",progress:"The ground shifts beneath you. Stay focused.",complete:"The Void Emperor falls. Ahead, a city of light shimmers. EDILAS. You've arrived."}},{id:"ms_edilas",chapter:"epilogue",name:"The Living Pilgrimage",description:"You have reached EDILAS. But the journey never truly ends...",objectives:[{description:"Enter the city of EDILAS",count:1}],reward:{xp:1e4,gold:1e4},dialogue:{start:"EDILAS stands before you. Everything you suffered was for this moment.",progress:"Walk through the gates. Your pilgrimage is complete.",complete:"You stand in EDILAS. The corruption is purified. But beyond the gates, New Game+ awaits..."}}];class x0{_currentChapter="prologue";_activeQuest=null;_completedQuests=new Set;_questProgress=new Map;get currentChapter(){return this._currentChapter}get activeQuest(){return this._activeQuest}startNextQuest(){const e=ta.find(t=>!this._completedQuests.has(t.id));return e?(this._activeQuest=e.id,this._currentChapter=e.chapter,this._questProgress.set(e.id,new Array(e.objectives.length).fill(0)),e):null}getCurrentQuest(){return this._activeQuest?ta.find(e=>e.id===this._activeQuest)??null:null}getProgress(){return this._activeQuest?this._questProgress.get(this._activeQuest)??[]:[]}progressObjective(e,t=1){if(!this._activeQuest)return!1;const i=this._questProgress.get(this._activeQuest),s=this.getCurrentQuest();return!i||!s||e>=s.objectives.length?!1:(i[e]=Math.min((i[e]??0)+t,s.objectives[e].count),s.objectives.every((r,n)=>(i[n]??0)>=r.count)?this._completeQuest(s):!1)}_completeQuest(e){this._completedQuests.add(e.id),this._activeQuest=null,console.log(`[Story] Completed: ${e.name}`);const t=this.startNextQuest();return console.log(t?`[Story] Next quest: ${t.name}`:"[Story] All story quests completed!"),!0}isCompleted(e){return this._completedQuests.has(e)}isBiomeUnlocked(e){if(e==="haven")return!0;for(const t of ta)if(t.biomeUnlocks===e&&this._completedQuests.has(t.id))return!0;return!1}getCompletedCount(){return this._completedQuests.size}getTotalCount(){return ta.length}serialize(){return{chapter:this._currentChapter,activeQuest:this._activeQuest,completed:[...this._completedQuests],progress:[...this._questProgress]}}deserialize(e){this._currentChapter=e.chapter,this._activeQuest=e.activeQuest,this._completedQuests=new Set(e.completed),this._questProgress=new Map(e.progress)}}const ia=[{id:"wheat",name:"Wheat",icon:"",seedId:"wheat_seed",harvestId:"wheat",harvestCount:[2,4],growthStages:4,growthTime:6,waterNeeded:!0,seasons:["spring","summer"],sellPrice:15,regrowth:!1},{id:"carrot",name:"Carrot",icon:"",seedId:"carrot_seed",harvestId:"carrot",harvestCount:[1,3],growthStages:3,growthTime:4,waterNeeded:!0,seasons:["spring","autumn"],sellPrice:20,regrowth:!1},{id:"potato",name:"Potato",icon:"",seedId:"potato_seed",harvestId:"potato",harvestCount:[2,5],growthStages:4,growthTime:8,waterNeeded:!0,seasons:["spring","summer","autumn"],sellPrice:12,regrowth:!1},{id:"tomato",name:"Tomato",icon:"",seedId:"tomato_seed",harvestId:"tomato",harvestCount:[1,3],growthStages:5,growthTime:5,waterNeeded:!0,seasons:["summer"],sellPrice:25,regrowth:!0},{id:"corn",name:"Corn",icon:"",seedId:"corn_seed",harvestId:"corn",harvestCount:[1,2],growthStages:6,growthTime:7,waterNeeded:!0,seasons:["summer"],sellPrice:30,regrowth:!1},{id:"pumpkin",name:"Pumpkin",icon:"",seedId:"pumpkin_seed",harvestId:"pumpkin",harvestCount:[1,1],growthStages:5,growthTime:10,waterNeeded:!0,seasons:["autumn"],sellPrice:80,regrowth:!1},{id:"herb_crop",name:"Herb",icon:"",seedId:"herb_seed",harvestId:"herb",harvestCount:[2,4],growthStages:3,growthTime:3,waterNeeded:!0,seasons:["spring","summer","autumn"],sellPrice:10,regrowth:!0},{id:"moonpetal",name:"Moonpetal",icon:"",seedId:"moonpetal_seed",harvestId:"moonpetal",harvestCount:[1,1],growthStages:6,growthTime:12,waterNeeded:!0,seasons:["spring"],sellPrice:200,regrowth:!1},{id:"firebloom",name:"Firebloom",icon:"",seedId:"firebloom_seed",harvestId:"firebloom",harvestCount:[1,2],growthStages:5,growthTime:8,waterNeeded:!1,seasons:["summer"],sellPrice:150,regrowth:!1},{id:"frostberry",name:"Frostberry",icon:"",seedId:"frostberry_seed",harvestId:"frostberry",harvestCount:[2,4],growthStages:4,growthTime:6,waterNeeded:!1,seasons:["winter"],sellPrice:120,regrowth:!0}],Hl=[{min:0,quality:"poor",priceMultiplier:.6,color:"#888888"},{min:.3,quality:"normal",priceMultiplier:1,color:"#ffffff"},{min:.6,quality:"good",priceMultiplier:1.5,color:"#44ff44"},{min:.8,quality:"excellent",priceMultiplier:2,color:"#4488ff"},{min:.95,quality:"legendary",priceMultiplier:3,color:"#ffaa00"}];function E0(o){let e=Hl[0];for(const t of Hl)o>=t.min&&(e=t);return e}const zl={health:.7,moisture:0,fertility:.5},xa={sprinkler:{baseRadius:2,effect:"auto_water",cost:[{itemId:"iron_bar",count:3},{itemId:"gold_ore",count:1}]},scarecrow:{baseRadius:3,effect:"pest_protection",cost:[{itemId:"wood",count:5},{itemId:"fiber",count:3}]},beehive:{baseRadius:2,effect:"pollination_boost",cost:[{itemId:"wood",count:8},{itemId:"herb",count:5}]},compost_bin:{baseRadius:1,effect:"auto_fertilize",cost:[{itemId:"wood",count:4},{itemId:"stone",count:4}]}},Xl={insects:{damagePerTick:.02,qualityReduction:.05,spreadChance:.3,scarecrowBlocks:!1},crows:{damagePerTick:.05,qualityReduction:.1,spreadChance:.1,scarecrowBlocks:!0},mold:{damagePerTick:.03,qualityReduction:.08,spreadChance:.5,scarecrowBlocks:!1},corruption_blight:{damagePerTick:.08,qualityReduction:.15,spreadChance:.4,scarecrowBlocks:!1}},Vl={spring:{growthMultiplier:1.2,qualityBonus:.05,pestChance:.1},summer:{growthMultiplier:1,qualityBonus:0,pestChance:.15},autumn:{growthMultiplier:.8,qualityBonus:.1,pestChance:.05},winter:{growthMultiplier:.4,qualityBonus:0,pestChance:0}};class D0{_plots=[];_farmLevel=0;_farmXP=0;_xpToNext=100;_totalHarvests=0;_growthSpeedBonus=0;_allSeasonGrow=!1;get plots(){return this._plots}get farmLevel(){return this._farmLevel}get farmXP(){return this._farmXP}get totalHarvests(){return this._totalHarvests}setGrowthSpeedBonus(e){this._growthSpeedBonus=e}setAllSeasonGrow(e){this._allSeasonGrow=e}createPlot(e,t){const i={x:e,y:t,cropId:null,state:"empty",stage:0,stageProgress:0,watered:!1,quality:.5,fertilized:!1,soil:{...zl},pestType:null,pestSeverity:0};return this._plots.push(i),i}getPlotAt(e,t){return this._plots.find(i=>i.x===e&&i.y===t)}plant(e,t,i){if(e.state!=="empty")return!1;const s=ia.find(a=>a.id===t);return!s||!this._allSeasonGrow&&!s.seasons.includes(i)?!1:(e.cropId=t,e.state="planted",e.stage=0,e.stageProgress=0,e.quality=e.fertilized?.8:.5,!0)}water(e){e.watered=!0}fertilize(e){e.fertilized=!0,e.quality=Math.min(1,e.quality+.2)}harvest(e){if(e.state!=="ready"||!e.cropId)return null;const t=ia.find(n=>n.id===e.cropId);if(!t)return null;const i=t.harvestCount[0]+Math.floor(Math.random()*(t.harvestCount[1]-t.harvestCount[0]+1)),s=Math.floor(i*e.quality),a=i+s;this._totalHarvests++,this._addXP(10+Math.floor(e.quality*20)),t.regrowth?(e.state="growing",e.stage=Math.max(0,t.growthStages-2),e.stageProgress=0):(e.state="empty",e.cropId=null,e.stage=0,e.stageProgress=0),e.watered=!1,e.fertilized=!1,e.soil.fertility=Math.max(0,e.soil.fertility-.15);const r=E0(e.quality);return{itemId:t.harvestId,count:a,...r}}_structures=[];get structures(){return this._structures}placeStructure(e,t,i){const s=xa[e],a={type:e,x:t,y:i,radius:s.baseRadius,level:1};return this._structures.push(a),a}upgradeStructure(e){return e.level>=3?!1:(e.level++,e.radius=xa[e.type].baseRadius+e.level-1,!0)}_isPlotInStructureRange(e,t){return this._structures.some(i=>i.type===t&&Math.abs(i.x-e.x)<=i.radius&&Math.abs(i.y-e.y)<=i.radius)}_pestEvents=[];_pestTimer=0;get activePests(){return this._pestEvents}_tickPests(e,t){const i=Vl[t];this._pestTimer+=e,this._pestTimer>=60&&(this._pestTimer=0,Math.random()<(i?.pestChance??.1)&&this._spawnPest());for(let s=this._pestEvents.length-1;s>=0;s--){const a=this._pestEvents[s];if(a.timer-=e,a.timer<=0){const r=Xl[a.type];for(const n of a.affectedPlots){const l=this._plots[n];!l||l.state==="empty"||r.scarecrowBlocks&&this._isPlotInStructureRange(l,"scarecrow")||(l.quality=Math.max(0,l.quality-r.qualityReduction*a.severity),l.soil.health=Math.max(0,l.soil.health-r.damagePerTick*a.severity),l.quality<=0&&(l.state="dead"))}this._pestEvents.splice(s,1)}}}_spawnPest(){if(this._plots.length===0)return;const e=["insects","crows","mold","corruption_blight"],t=e[Math.floor(Math.random()*e.length)],i=Math.floor(Math.random()*this._plots.length),s=[i],a=Xl[t];for(let r=0;r<this._plots.length;r++){if(r===i)continue;const n=this._plots[i],l=this._plots[r];Math.abs(n.x-l.x)<=2&&Math.abs(n.y-l.y)<=2&&Math.random()<a.spreadChance&&s.push(r)}this._pestEvents.push({type:t,affectedPlots:s,severity:.3+Math.random()*.7,timer:10+Math.random()*20})}_tickSoil(e){for(const t of this._plots)t.soil.moisture=Math.max(0,t.soil.moisture-.001*e),t.watered&&(t.soil.moisture=Math.min(1,t.soil.moisture+.3)),this._isPlotInStructureRange(t,"sprinkler")&&(t.watered=!0,t.soil.moisture=Math.min(1,t.soil.moisture+.2)),this._isPlotInStructureRange(t,"compost_bin")&&!t.fertilized&&(t.fertilized=!0,t.soil.fertility=Math.min(1,t.soil.fertility+.1)),this._isPlotInStructureRange(t,"beehive")&&t.state==="growing"&&(t.quality=Math.min(1,t.quality+.001*e)),t.soil.fertility<.2&&(t.soil.health=Math.max(0,t.soil.health-5e-4*e))}update(e,t,i=!1){for(const s of this._plots){if(i&&s.state!=="empty"&&!s.watered&&(s.watered=!0),s.state!=="planted"&&s.state!=="growing"||!s.cropId)continue;const a=ia.find(l=>l.id===s.cropId);if(!a)continue;if(!this._allSeasonGrow&&!a.seasons.includes(t.season)){s.state="dead";continue}let r=1/(a.growthTime*3600);(s.watered||!a.waterNeeded)&&(r*=1.5),s.fertilized&&(r*=1.3),a.seasons.includes(t.season)&&t.season===a.seasons[0]&&(r*=1.1),r*=.5+s.soil.health*.5,r*=.7+s.soil.fertility*.3;const n=Vl[t.season];n&&(r*=n.growthMultiplier),r*=1+this._farmLevel*.05,this._growthSpeedBonus>0&&(r*=1+this._growthSpeedBonus),s.stageProgress+=r*e,s.stageProgress>=1&&(s.stageProgress=0,s.stage++,s.state="growing",s.stage>=a.growthStages&&(s.state="ready"))}this._tickSoil(e),this._tickPests(e,t.season)}_addXP(e){for(this._farmXP+=e;this._farmXP>=this._xpToNext;)this._farmXP-=this._xpToNext,this._farmLevel++,this._xpToNext=Math.floor(100*Math.pow(1.2,this._farmLevel))}renderPlot(e,t,i,s,a,r){e.fillStyle=t.watered?"#5a4020":"#7a6040",e.fillRect(i,s,a,a),e.strokeStyle="rgba(0,0,0,0.2)";for(let c=0;c<3;c++)e.beginPath(),e.moveTo(i,s+4+c*(a/3)),e.lineTo(i+a,s+4+c*(a/3)),e.stroke();if(t.watered&&(e.fillStyle="rgba(100,180,255,0.1)",e.fillRect(i,s,a,a)),!t.cropId||t.state==="empty")return;const n=ia.find(c=>c.id===t.cropId);if(!n)return;if(t.state==="dead"){e.fillStyle="#666",e.font=`${a*.6}px serif`,e.textAlign="center",e.fillText("",i+a/2,s+a*.7);return}const l=t.stage/(n.growthStages??4);if(r){const c=r.getCropSpritePath(t.cropId),d=c?r.getSprite(c):void 0;if(d&&d.naturalWidth){const m=.25+.6*l,_=a*m,p=a*m,g=i+(a-_)/2,y=s+a-p-2,S=Math.sin(Date.now()*.0015+t.x*3+t.y*7)*(1-l)*1.5;if(e.save(),e.translate(g+_/2,y+p),e.rotate(S*.03),t.state!=="ready"&&(e.globalAlpha=.5+l*.5),e.drawImage(d,-_/2,-p,_,p),e.globalAlpha=1,e.restore(),t.state==="ready"){const b=.25+Math.sin(Date.now()*.004)*.15;e.fillStyle=`rgba(255,215,0,${b})`,e.beginPath(),e.arc(i+a/2,s+a*.5,a*.35,0,Math.PI*2),e.fill()}e.strokeStyle="#3a8a2a",e.lineWidth=2,e.beginPath(),e.moveTo(i+a/2,s+a),e.lineTo(i+a/2,y+p),e.stroke();return}}const h=a*.3*l;e.strokeStyle="#3a8a2a",e.lineWidth=2,e.beginPath(),e.moveTo(i+a/2,s+a),e.lineTo(i+a/2,s+a-h),e.stroke(),t.state==="ready"?(e.font=`${a*.5}px serif`,e.textAlign="center",e.fillText(n.icon,i+a/2,s+a*.5)):l>.3&&(e.fillStyle="#4a8a3a",e.beginPath(),e.ellipse(i+a/2+4,s+a-h+4,3,2,.3,0,Math.PI*2),e.fill())}serialize(){return{plots:this._plots.map(e=>({...e,soil:{...e.soil}})),level:this._farmLevel,xp:this._farmXP,totalHarvests:this._totalHarvests,structures:this._structures.map(e=>({...e})),pestEvents:this._pestEvents.map(e=>({...e,affectedPlots:[...e.affectedPlots]}))}}deserialize(e){this._plots=e.plots.map(t=>({...t,soil:t.soil??{...zl},pestType:t.pestType??null,pestSeverity:t.pestSeverity??0})),this._farmLevel=e.level,this._farmXP=e.xp,this._xpToNext=Math.floor(100*Math.pow(1.2,this._farmLevel)),this._totalHarvests=e.totalHarvests,this._structures=e.structures??[],this._pestEvents=e.pestEvents??[]}}const F0=[{id:"carp",name:"Carp",icon:"",rarity:"common",valueLow:10,valueHigh:20,difficulty:.1,biomes:["haven","rotwood"]},{id:"trout",name:"Trout",icon:"",rarity:"common",valueLow:15,valueHigh:30,difficulty:.2,biomes:["haven","rotwood","ashlands"]},{id:"perch",name:"Perch",icon:"",rarity:"common",valueLow:12,valueHigh:25,difficulty:.15,biomes:["haven","rotwood","drowned_depths"]},{id:"bluegill",name:"Bluegill",icon:"",rarity:"common",valueLow:8,valueHigh:18,difficulty:.1,biomes:["haven"]},{id:"mudfish",name:"Mudfish",icon:"",rarity:"common",valueLow:12,valueHigh:22,difficulty:.15,biomes:["rotwood"],conditions:{weather:"rain"}},{id:"salmon",name:"Salmon",icon:"",rarity:"uncommon",valueLow:30,valueHigh:60,difficulty:.35,biomes:["haven","drowned_depths"]},{id:"catfish",name:"Catfish",icon:"",rarity:"uncommon",valueLow:25,valueHigh:50,difficulty:.3,biomes:["haven","rotwood"],conditions:{timeOfDay:"night"}},{id:"pike",name:"Pike",icon:"",rarity:"uncommon",valueLow:35,valueHigh:65,difficulty:.4,biomes:["haven","rotwood","bone_wastes"]},{id:"char",name:"Arctic Char",icon:"",rarity:"uncommon",valueLow:40,valueHigh:70,difficulty:.4,biomes:["drowned_depths"],conditions:{season:"winter"}},{id:"bone_sucker",name:"Bone Sucker",icon:"",rarity:"uncommon",valueLow:45,valueHigh:80,difficulty:.45,biomes:["bone_wastes"],minLevel:3},{id:"ember_minnow",name:"Ember Minnow",icon:"",rarity:"uncommon",valueLow:40,valueHigh:75,difficulty:.4,biomes:["ashlands"]},{id:"golden_koi",name:"Golden Koi",icon:"",rarity:"rare",valueLow:100,valueHigh:200,difficulty:.6,biomes:["haven"],conditions:{season:"spring"}},{id:"lava_eel",name:"Lava Eel",icon:"",rarity:"rare",valueLow:150,valueHigh:300,difficulty:.7,biomes:["ashlands"]},{id:"ghost_fish",name:"Ghost Fish",icon:"",rarity:"rare",valueLow:200,valueHigh:400,difficulty:.75,biomes:["drowned_depths","bone_wastes"],conditions:{timeOfDay:"midnight"}},{id:"corrupted_bass",name:"Corrupted Bass",icon:"",rarity:"rare",valueLow:180,valueHigh:350,difficulty:.7,biomes:["rotwood","bone_wastes"],minLevel:5},{id:"shadow_trout",name:"Shadow Trout",icon:"",rarity:"rare",valueLow:170,valueHigh:320,difficulty:.65,biomes:["rotwood","the_void"],conditions:{timeOfDay:"night"},minLevel:4},{id:"frost_sturgeon",name:"Frost Sturgeon",icon:"",rarity:"rare",valueLow:200,valueHigh:380,difficulty:.7,biomes:["drowned_depths"],conditions:{season:"winter"},minLevel:6,xpBonus:15},{id:"void_angler",name:"Void Angler",icon:"",rarity:"legendary",valueLow:500,valueHigh:1e3,difficulty:.9,biomes:["the_void"],minLevel:8},{id:"storm_bass",name:"Storm Bass",icon:"",rarity:"legendary",valueLow:400,valueHigh:800,difficulty:.85,biomes:["haven","drowned_depths"],conditions:{weather:"storm"},minLevel:7},{id:"crystal_pike",name:"Crystal Pike",icon:"",rarity:"legendary",valueLow:600,valueHigh:1200,difficulty:.95,biomes:["bone_wastes"],conditions:{season:"winter"},minLevel:9},{id:"leviathan_fry",name:"Leviathan Fry",icon:"",rarity:"legendary",valueLow:800,valueHigh:1500,difficulty:.95,biomes:["drowned_depths"],conditions:{weather:"storm",season:"summer"},minLevel:10,xpBonus:50},{id:"phoenix_carp",name:"Phoenix Carp",icon:"",rarity:"legendary",valueLow:700,valueHigh:1300,difficulty:.9,biomes:["ashlands"],conditions:{timeOfDay:"dawn"},minLevel:8,xpBonus:40},{id:"eclipse_ray",name:"Eclipse Ray",icon:"",rarity:"legendary",valueLow:900,valueHigh:1800,difficulty:.98,biomes:["the_void"],conditions:{timeOfDay:"midnight"},minLevel:12,xpBonus:75}],Ti={wooden:{id:"wooden",name:"Wooden Rod",reelSpeed:1,tensionResist:0,biteChance:1,rarityBonus:0,minLevel:0},iron:{id:"iron",name:"Iron Rod",reelSpeed:1.15,tensionResist:.05,biteChance:1.1,rarityBonus:2,minLevel:3},steel:{id:"steel",name:"Steel Rod",reelSpeed:1.3,tensionResist:.1,biteChance:1.2,rarityBonus:5,minLevel:6},mithril:{id:"mithril",name:"Mithril Rod",reelSpeed:1.5,tensionResist:.15,biteChance:1.35,rarityBonus:10,minLevel:9},void:{id:"void",name:"Void Rod",reelSpeed:1.8,tensionResist:.2,biteChance:1.5,rarityBonus:20,minLevel:12}},Ir={worm:{id:"worm",name:"Worm",rarityBonus:0,biteSpeedBonus:.1},cricket:{id:"cricket",name:"Cricket",rarityBonus:3,biteSpeedBonus:.15},minnow:{id:"minnow",name:"Minnow",rarityBonus:5,biteSpeedBonus:.05,targetRarity:"uncommon"},glowgrub:{id:"glowgrub",name:"Glowgrub",rarityBonus:8,biteSpeedBonus:.2,targetBiomes:["drowned_depths","bone_wastes"]},blood_leech:{id:"blood_leech",name:"Blood Leech",rarityBonus:12,biteSpeedBonus:.1,targetRarity:"rare"},void_larva:{id:"void_larva",name:"Void Larva",rarityBonus:20,biteSpeedBonus:.25,targetBiomes:["the_void"],targetRarity:"legendary"}},Mi={clear:{biteSpeedMult:1,rarityMult:1,tensionMult:1},rain:{biteSpeedMult:1.2,rarityMult:1.15,tensionMult:.9},storm:{biteSpeedMult:.8,rarityMult:1.5,tensionMult:1.3},fog:{biteSpeedMult:1.1,rarityMult:1.2,tensionMult:1},snow:{biteSpeedMult:.7,rarityMult:1.1,tensionMult:.8},heatwave:{biteSpeedMult:.9,rarityMult:.9,tensionMult:1.1},blizzard:{biteSpeedMult:.5,rarityMult:1.3,tensionMult:1.4}},sa={spring:{biteSpeedMult:1.2,valueMult:1,xpMult:1.1},summer:{biteSpeedMult:1,valueMult:1.1,xpMult:1},autumn:{biteSpeedMult:.9,valueMult:1.2,xpMult:1.15},winter:{biteSpeedMult:.7,valueMult:1.3,xpMult:1.2}};class $0{_state="idle";_timer=0;_biteWindow=0;_reelProgress=0;_tension=0;_currentFish=null;_fishLevel=0;_fishXP=0;_xpToNext=100;_totalCaught=0;_caughtTypes=new Set;_equippedRod="wooden";_equippedBait=null;_baitCount=new Map;_currentWeather="clear";_currentSeason="spring";_biggestCatch=null;_totalValue=0;_streakCount=0;get state(){return this._state}get reelProgress(){return this._reelProgress}get tension(){return this._tension}get currentFish(){return this._currentFish}get fishLevel(){return this._fishLevel}get fishXP(){return this._fishXP}get xpToNext(){return this._xpToNext}get totalCaught(){return this._totalCaught}get uniqueCaught(){return this._caughtTypes.size}get equippedRod(){return Ti[this._equippedRod]}get equippedBait(){return this._equippedBait?Ir[this._equippedBait]:null}get biggestCatch(){return this._biggestCatch}get totalValue(){return this._totalValue}get streakCount(){return this._streakCount}equipRod(e){const t=Ti[e];return this._fishLevel<t.minLevel||this._state!=="idle"?!1:(this._equippedRod=e,!0)}addBait(e,t){this._baitCount.set(e,(this._baitCount.get(e)??0)+t)}equipBait(e){return(this._baitCount.get(e)??0)<=0||this._state!=="idle"?!1:(this._equippedBait=e,!0)}unequipBait(){this._equippedBait=null}getBaitCount(e){return this._baitCount.get(e)??0}setConditions(e,t){this._currentWeather=e,this._currentSeason=t}cast(e,t,i,s){if(this._state!=="idle")return;if(this._equippedBait){const p=this._baitCount.get(this._equippedBait)??0;p<=0?this._equippedBait=null:this._baitCount.set(this._equippedBait,p-1)}this._state="casting",this._timer=.5,s&&(this._currentWeather=s),t&&(this._currentSeason=t);const a=Ti[this._equippedRod],r=this._equippedBait?Ir[this._equippedBait]:null,n=F0.filter(p=>!(!p.biomes.includes(e)||p.conditions?.season&&p.conditions.season!==t||p.conditions?.timeOfDay&&p.conditions.timeOfDay!==i||p.conditions?.weather&&p.conditions.weather!==s||p.minLevel&&this._fishLevel<p.minLevel));if(n.length===0){this._state="idle",this._currentFish=null;return}const l={common:50,uncommon:30,rare:15,legendary:5},h=this._fishLevel*.5,c=a.rarityBonus,d=r?.rarityBonus??0,u=Mi[this._currentWeather]??Mi.clear,f=n.map(p=>{let g=l[p.rarity];return(p.rarity==="rare"||p.rarity==="legendary")&&(g+=h+c+d,g*=u.rarityMult),r?.targetRarity===p.rarity&&(g*=2),r?.targetBiomes?.includes(e)&&(g*=1.5),{fish:p,weight:g}}),m=f.reduce((p,g)=>p+g.weight,0);let _=Math.random()*m;this._currentFish=n[0]??null;for(const p of f)if(_-=p.weight,_<=0){this._currentFish=p.fish;break}}reel(e){if(this._state!=="reeling")return;const t=this._currentFish;if(!t)return;const i=Ti[this._equippedRod],s=Mi[this._currentWeather]??Mi.clear;this._reelProgress+=e*(.3-t.difficulty*.2)*i.reelSpeed;const a=e*t.difficulty*.4*s.tensionMult;this._tension+=Math.max(0,a-i.tensionResist*e),this._reelProgress>=1&&(this._state="caught"),this._tension>=1&&(this._state="lost",this._timer=0,this._currentFish=null,this._streakCount=0)}releaseLine(e){if(this._state!=="reeling")return;const t=Ti[this._equippedRod];this._reelProgress=Math.max(0,this._reelProgress-e*(.1/t.reelSpeed)),this._tension=Math.max(0,this._tension-e*.5)}hookFish(){return this._state!=="bite"?!1:(this._state="reeling",this._reelProgress=0,this._tension=0,!0)}collectFish(){if(this._state!=="caught"||!this._currentFish)return null;const e=this._currentFish,t=sa[this._currentSeason]??sa.spring,i=1+Math.min(this._streakCount*.05,.5),s=e.valueLow+Math.floor(Math.random()*(e.valueHigh-e.valueLow)),a=Math.floor(s*t.valueMult*i);this._totalCaught++,this._caughtTypes.add(e.id),this._totalValue+=a,this._streakCount++,(!this._biggestCatch||a>this._biggestCatch.value)&&(this._biggestCatch={fishId:e.id,value:a});let r=10+Math.floor(e.difficulty*50);for(r+=e.xpBonus??0,r=Math.floor(r*t.xpMult),this._fishXP+=r;this._fishXP>=this._xpToNext;)this._fishXP-=this._xpToNext,this._fishLevel++,this._xpToNext=Math.floor(100*Math.pow(1.2,this._fishLevel));return this._state="idle",this._currentFish=null,{fishDef:e,value:a,xpGained:r}}cancel(){this._state="idle",this._currentFish=null}update(e){if(this._state==="casting"&&(this._timer-=e,this._timer<=0)){this._state="waiting";const t=Ti[this._equippedRod],i=this._equippedBait?Ir[this._equippedBait]:null,s=Mi[this._currentWeather]??Mi.clear,a=sa[this._currentSeason]??sa.spring;let r=3+Math.random()*10;r/=t.biteChance,r*=1-(i?.biteSpeedBonus??0),r/=s.biteSpeedMult,r/=a.biteSpeedMult,this._timer=Math.max(1,r)}this._state==="waiting"&&(this._timer-=e,this._timer<=0&&(this._state="bite",this._biteWindow=1.5+Math.random()*1,this._timer=this._biteWindow)),this._state==="bite"&&(this._timer-=e,this._timer<=0&&(this._state="idle",this._currentFish=null,this._streakCount=0)),this._state==="lost"&&(this._timer+=e,this._timer>1&&(this._state="idle"))}serialize(){return{level:this._fishLevel,xp:this._fishXP,totalCaught:this._totalCaught,caughtTypes:[...this._caughtTypes],equippedRod:this._equippedRod,equippedBait:this._equippedBait,baitInventory:[...this._baitCount.entries()],biggestCatch:this._biggestCatch,totalValue:this._totalValue,streakCount:this._streakCount}}deserialize(e){this._fishLevel=e.level,this._fishXP=e.xp,this._xpToNext=Math.floor(100*Math.pow(1.2,this._fishLevel)),this._totalCaught=e.totalCaught,this._caughtTypes=new Set(e.caughtTypes),this._equippedRod=e.equippedRod??"wooden",this._equippedBait=e.equippedBait??null,this._baitCount=new Map(e.baitInventory??[]),this._biggestCatch=e.biggestCatch??null,this._totalValue=e.totalValue??0,this._streakCount=e.streakCount??0}}const Ar={elder_miriam:{id:"elder_miriam",name:"Elder Miriam",personality:"Wise and caring. Values knowledge and tradition.",giftPreferences:{loved:["purification_crystal","moonpetal_seed"],liked:["herb","health_potion","bread"],neutral:["stone","wood","iron_ore"],disliked:["slime_gel","bone_fragment"],hated:["corruption_essence","void_shard"]},dialogueGreeting:"Welcome, pilgrim. The path is long, but we walk it together.",dialogueFriendly:"You bring hope to Haven. I see great potential in you.",dialogueRomantic:""},garrett:{id:"garrett",name:"Garrett",personality:"Gruff but honorable blacksmith. Respects hard work.",giftPreferences:{loved:["iron_bar","gold_bar","ruby"],liked:["iron_ore","gold_ore","stone"],neutral:["wood","health_potion"],disliked:["herb","moonpetal_seed"],hated:["corruption_essence"]},dialogueGreeting:"Need something forged? I'm your man.",dialogueFriendly:"You know, you remind me of myself when I was younger. Determined.",dialogueRomantic:"I... don't usually say things like this. But I'm glad you're here."},martha:{id:"martha",name:"Martha",personality:"Kind shopkeeper. Loves community and gossip.",giftPreferences:{loved:["golden_feast","emerald","cloth"],liked:["bread","mushroom_stew","grilled_fish"],neutral:["wood","stone","fiber"],disliked:["bone_fragment","monster_hide"],hated:["void_shard"]},dialogueGreeting:"Welcome to my shop, dear! Looking for anything special?",dialogueFriendly:"You've been so good for Haven. Everyone notices, you know.",dialogueRomantic:"Oh my... well, I suppose a shopkeeper can dream too."},lily:{id:"lily",name:"Lily",personality:"Gentle herbalist. Shy but passionate about plants.",giftPreferences:{loved:["moonpetal_seed","herb","emerald"],liked:["spore_cap","health_potion","antidote"],neutral:["bread","cloth"],disliked:["iron_bar","bone_fragment"],hated:["corruption_essence","void_shard"]},dialogueGreeting:"Oh! H-hello... need any remedies?",dialogueFriendly:"I've been developing a new potion recipe... maybe you could try it?",dialogueRomantic:"Every time you bring me flowers, my heart blooms too..."},harold:{id:"harold",name:"Harold",personality:"Jovial tavern keeper. Loves stories and good food.",giftPreferences:{loved:["golden_feast","mushroom_stew","grilled_fish"],liked:["bread","wolf_pelt","gold_bar"],neutral:["wood","stone","herb"],disliked:["void_shard","corruption_essence"],hated:["slime_gel"]},dialogueGreeting:"Ha! Come in, come in! What'll it be?",dialogueFriendly:"You know, you've got the best stories of anyone who walks through that door.",dialogueRomantic:""}};function aa(o,e){return e&&o>=80?"romantic":o>=80?"best_friend":o>=50?"close_friend":o>=20?"friendly":o>=0?"acquaintance":"stranger"}class L0{_relationships=new Map;_giftCooldownPeriod=86400;constructor(){for(const e of Object.keys(Ar))this._relationships.set(e,{npcId:e,affinity:0,level:"stranger",giftCooldown:0,totalGiftsGiven:0,conversationCount:0,questsCompleted:0,isRomanceable:e==="garrett"||e==="lily"||e==="martha",romanceStarted:!1})}getRelationship(e){return this._relationships.get(e)}getAllRelationships(){return[...this._relationships.values()]}talkTo(e){const t=this._relationships.get(e),i=Ar[e];if(!t||!i)return{dialogue:"...",affinityGain:0};t.conversationCount++;const s=1+Math.floor(Math.random()*2);t.affinity=Math.min(100,t.affinity+s),t.level=aa(t.affinity,t.romanceStarted);let a=i.dialogueGreeting;return t.level==="romantic"?a=i.dialogueRomantic||i.dialogueFriendly:t.affinity>=40&&(a=i.dialogueFriendly),{dialogue:a,affinityGain:s}}giveGift(e,t){const i=this._relationships.get(e),s=Ar[e];if(!i||!s)return{reaction:"...",affinityChange:0};if(i.giftCooldown>0)return{reaction:"I appreciate it, but perhaps another time.",affinityChange:0};let a=0,r="";return s.giftPreferences.loved.includes(t)?(a=15,r="Oh! I love this! Thank you so much!"):s.giftPreferences.liked.includes(t)?(a=8,r="This is nice, thank you!"):s.giftPreferences.neutral.includes(t)?(a=3,r="Oh, thanks."):s.giftPreferences.disliked.includes(t)?(a=-5,r="Um... this isn't really my thing."):s.giftPreferences.hated.includes(t)?(a=-15,r="What?! Why would you give me this?!"):(a=2,r="Thank you for thinking of me."),i.affinity=Math.max(-100,Math.min(100,i.affinity+a)),i.giftCooldown=this._giftCooldownPeriod,i.totalGiftsGiven++,i.level=aa(i.affinity,i.romanceStarted),{reaction:r,affinityChange:a}}startRomance(e){const t=this._relationships.get(e);return!t||!t.isRomanceable||t.affinity<70?!1:(t.romanceStarted=!0,t.level=aa(t.affinity,!0),!0)}onQuestCompleteForNPC(e){const t=this._relationships.get(e);t&&(t.questsCompleted++,t.affinity=Math.min(100,t.affinity+10),t.level=aa(t.affinity,t.romanceStarted))}update(e){for(const t of this._relationships.values())t.giftCooldown>0&&(t.giftCooldown=Math.max(0,t.giftCooldown-e))}serialize(){return[...this._relationships.entries()]}deserialize(e){this._relationships=new Map(e)}}const $i={blacksmith:{id:"blacksmith",name:"Blacksmith",icon:"",description:"Craft weapons and armor with greater efficiency.",maxLevel:10,xpPerLevel:200,bonuses:[{level:2,description:"Crafted weapons +10% damage",effect:"weapon_damage_10"},{level:5,description:"Reduced material costs",effect:"material_cost_-20"},{level:8,description:"Chance for masterwork quality",effect:"masterwork_chance_15"},{level:10,description:"Legendary recipe access",effect:"legendary_recipes"}]},alchemist:{id:"alchemist",name:"Alchemist",icon:"",description:"Brew potions with enhanced effects.",maxLevel:10,xpPerLevel:180,bonuses:[{level:2,description:"Potions heal +20%",effect:"potion_heal_20"},{level:5,description:"Double potion yield",effect:"potion_yield_2x"},{level:8,description:"Rare reagent discovery",effect:"rare_reagent_chance"},{level:10,description:"Transmutation recipes",effect:"transmute_recipes"}]},farmer:{id:"farmer",name:"Farmer",icon:"",description:"Grow crops faster with better yields.",maxLevel:10,xpPerLevel:150,bonuses:[{level:2,description:"Crop growth +20%",effect:"growth_speed_20"},{level:5,description:"Rare seed drops",effect:"rare_seeds"},{level:8,description:"Triple harvest chance",effect:"triple_harvest_15"},{level:10,description:"Grow any crop in any season",effect:"all_season_grow"}]},hunter:{id:"hunter",name:"Hunter",icon:"",description:"Track and defeat enemies for better loot.",maxLevel:10,xpPerLevel:220,bonuses:[{level:2,description:"+20% loot from beasts",effect:"beast_loot_20"},{level:5,description:"See enemy HP bars",effect:"enemy_hp_bars"},{level:8,description:"Track Titans",effect:"titan_tracking"},{level:10,description:"Guaranteed rare drops",effect:"guaranteed_rare_drop"}]},miner:{id:"miner",name:"Miner",icon:"",description:"Extract more ore and find rare minerals.",maxLevel:10,xpPerLevel:190,bonuses:[{level:2,description:"+1 ore per node",effect:"ore_plus_1"},{level:5,description:"Find gem deposits",effect:"gem_discovery"},{level:8,description:"Double ore chance",effect:"double_ore_20"},{level:10,description:"Void ore discovery",effect:"void_ore"}]},cook:{id:"cook",name:"Cook",icon:"",description:"Prepare meals with bonus effects.",maxLevel:10,xpPerLevel:160,bonuses:[{level:2,description:"Meals restore +25% more",effect:"meal_restore_25"},{level:5,description:"Meals give combat buffs",effect:"meal_combat_buff"},{level:8,description:"Golden feast recipe",effect:"golden_feast_recipe"},{level:10,description:"Legendary banquet",effect:"legendary_banquet"}]},enchanter:{id:"enchanter",name:"Enchanter",icon:"",description:"Imbue items with magical properties.",maxLevel:10,xpPerLevel:250,bonuses:[{level:2,description:"Basic enchantments",effect:"basic_enchant"},{level:5,description:"Dual enchantments",effect:"dual_enchant"},{level:8,description:"Corruption resistance enchant",effect:"corruption_resist_enchant"},{level:10,description:"Void enchantments",effect:"void_enchant"}]},builder:{id:"builder",name:"Builder",icon:"",description:"Construct settlement buildings faster and cheaper.",maxLevel:10,xpPerLevel:200,bonuses:[{level:2,description:"Build speed +30%",effect:"build_speed_30"},{level:5,description:"Reduced build costs",effect:"build_cost_-25"},{level:8,description:"Fortified structures",effect:"structure_hp_50"},{level:10,description:"Grand architecture",effect:"grand_structures"}]}};class B0{_professions=new Map;_activeProfession=null;get activeProfession(){return this._activeProfession}setProfession(e){this._activeProfession=e,this._professions.has(e)||this._professions.set(e,{level:1,xp:0})}getLevel(e){return this._professions.get(e)?.level??0}getXP(e){return this._professions.get(e)?.xp??0}addXP(e,t){const i=this._professions.get(e);if(!i)return!1;const s=$i[e];if(i.level>=s.maxLevel)return!1;i.xp+=t;let a=!1;for(;i.level<s.maxLevel;){const r=s.xpPerLevel*i.level;if(i.xp<r)break;i.xp-=r,i.level++,a=!0}return a}hasBonus(e,t){const i=this.getLevel(e);return $i[e].bonuses.some(a=>a.effect===t&&i>=a.level)}getActiveBonuses(){const e=[];for(const[t,i]of this._professions){const s=$i[t];for(const a of s.bonuses)i.level>=a.level&&e.push(a.effect)}return e}serialize(){return{professions:[...this._professions],active:this._activeProfession}}deserialize(e){this._professions=new Map(e.professions),this._activeProfession=e.active}}const Rr=[{id:"stone_walls",name:"Stone Walls",icon:"",category:"infrastructure",tier:1,description:"Unlock stone wall construction.",researchCost:[{itemId:"stone",count:20}],researchTime:2,prerequisites:[],effects:["unlock_stone_wall"]},{id:"water_well",name:"Water Well",icon:"",category:"infrastructure",tier:1,description:"Unlock well construction for water supply.",researchCost:[{itemId:"stone",count:15}],researchTime:1,prerequisites:[],effects:["unlock_well"]},{id:"roads",name:"Roads",icon:"",category:"infrastructure",tier:1,description:"Build roads for faster movement in settlements.",researchCost:[{itemId:"stone",count:30}],researchTime:3,prerequisites:["stone_walls"],effects:["unlock_road","settlement_speed_10"]},{id:"housing",name:"Housing",icon:"",category:"infrastructure",tier:2,description:"Build houses to increase settlement population.",researchCost:[{itemId:"wood",count:40},{itemId:"stone",count:20}],researchTime:4,prerequisites:["stone_walls"],effects:["unlock_house"]},{id:"storage_tech",name:"Storage",icon:"",category:"infrastructure",tier:2,description:"Build storage chests.",researchCost:[{itemId:"wood",count:25}],researchTime:2,prerequisites:[],effects:["unlock_storage"]},{id:"guard_tower",name:"Guard Towers",icon:"",category:"military",tier:1,description:"Build watchtowers for defense.",researchCost:[{itemId:"wood",count:30},{itemId:"stone",count:20}],researchTime:3,prerequisites:["stone_walls"],effects:["unlock_tower"]},{id:"barracks_tech",name:"Barracks",icon:"",category:"military",tier:2,description:"Train guards to defend the settlement.",researchCost:[{itemId:"stone",count:40},{itemId:"iron_bar",count:10}],researchTime:6,prerequisites:["guard_tower"],effects:["unlock_barracks","guard_role"]},{id:"workshop_tech",name:"Workshop",icon:"",category:"production",tier:1,description:"Unlock basic crafting station.",researchCost:[{itemId:"wood",count:20}],researchTime:2,prerequisites:[],effects:["unlock_workshop"]},{id:"forge_tech",name:"Forge",icon:"",category:"production",tier:2,description:"Unlock smelting and metalworking.",researchCost:[{itemId:"stone",count:30},{itemId:"iron_ore",count:10}],researchTime:5,prerequisites:["workshop_tech"],effects:["unlock_forge"]},{id:"alchemy_tech",name:"Alchemy",icon:"",category:"production",tier:2,description:"Unlock potion brewing.",researchCost:[{itemId:"herb",count:30},{itemId:"stone",count:15}],researchTime:4,prerequisites:["workshop_tech"],effects:["unlock_alchemy_lab"]},{id:"cooking_tech",name:"Cooking",icon:"",category:"production",tier:1,description:"Unlock cooking fire for food preparation.",researchCost:[{itemId:"stone",count:10},{itemId:"wood",count:5}],researchTime:1,prerequisites:[],effects:["unlock_cooking_station"]},{id:"farming_tech",name:"Farming",icon:"",category:"production",tier:1,description:"Unlock farm plots.",researchCost:[{itemId:"wood",count:15}],researchTime:2,prerequisites:[],effects:["unlock_farm"]},{id:"enchanting_tech",name:"Enchanting",icon:"",category:"magic",tier:3,description:"Unlock enchanting table for gear enhancements.",researchCost:[{itemId:"gold_bar",count:5},{itemId:"void_shard",count:2}],researchTime:8,prerequisites:["forge_tech"],effects:["unlock_enchanting_table"]},{id:"purifier_tech",name:"Purification Beacon",icon:"",category:"magic",tier:3,description:"Build beacons that cleanse corruption.",researchCost:[{itemId:"purification_crystal",count:5},{itemId:"stone",count:30}],researchTime:10,prerequisites:["stone_walls"],effects:["unlock_purifier"]},{id:"trade_tech",name:"Trade Post",icon:"",category:"exploration",tier:2,description:"Build trade posts to attract merchants.",researchCost:[{itemId:"wood",count:30},{itemId:"gold_bar",count:3}],researchTime:5,prerequisites:["housing"],effects:["unlock_trade_post","merchant_visits"]},{id:"watchtower_tech",name:"Watchtower",icon:"",category:"exploration",tier:2,description:"Reveal surrounding map areas.",researchCost:[{itemId:"wood",count:20},{itemId:"stone",count:15}],researchTime:4,prerequisites:["guard_tower"],effects:["unlock_watchtower","map_reveal"]}];class W0{_researched=new Set;_inProgress=null;get inProgress(){return this._inProgress}isResearched(e){return this._researched.has(e)}canResearch(e){const t=Rr.find(i=>i.id===e);return!t||this._researched.has(e)?!1:t.prerequisites.every(i=>this._researched.has(i))}getAvailableTechs(){return Rr.filter(e=>this.canResearch(e.id))}startResearch(e){if(!this.canResearch(e)||this._inProgress)return!1;const t=Rr.find(i=>i.id===e);return t?(this._inProgress={techId:e,progress:0,total:t.researchTime*3600},!0):!1}update(e){if(!this._inProgress)return null;if(this._inProgress.progress+=e,this._inProgress.progress>=this._inProgress.total){const t=this._inProgress.techId;return this._researched.add(t),this._inProgress=null,t}return null}getResearchProgress(){return this._inProgress?this._inProgress.progress/this._inProgress.total:0}serialize(){return{researched:[...this._researched],inProgress:this._inProgress}}deserialize(e){this._researched=new Set(e.researched),this._inProgress=e.inProgress}}class N0{_ctx=null;_masterVolume=.7;_musicVolume=.5;_sfxVolume=.8;_ambientVolume=.3;_muted=!1;_currentMusic=null;init(){try{this._ctx=new AudioContext}catch{console.warn("[AudioSystem] Web Audio API not available")}}get context(){return this._ctx}get masterVolume(){return this._masterVolume}set masterVolume(e){this._masterVolume=Math.max(0,Math.min(1,e))}get musicVolume(){return this._musicVolume}set musicVolume(e){this._musicVolume=Math.max(0,Math.min(1,e))}get sfxVolume(){return this._sfxVolume}set sfxVolume(e){this._sfxVolume=Math.max(0,Math.min(1,e))}get isMuted(){return this._muted}toggleMute(){this._muted=!this._muted}playSFX(e,t){if(!this._ctx||this._muted)return;const i=this._ctx,s=this._masterVolume*this._sfxVolume,a=i.createGain();a.connect(i.destination),a.gain.setValueAtTime(s,i.currentTime);const r=i.createOscillator();r.connect(a);const n=t??.9+Math.random()*.2;switch(e){case"hit":{r.type="sawtooth",r.frequency.setValueAtTime(200*n,i.currentTime),r.frequency.exponentialRampToValueAtTime(80*n,i.currentTime+.1),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.1),r.start(),r.stop(i.currentTime+.1);const l=i.createOscillator(),h=i.createGain();l.connect(h),h.connect(i.destination),l.type="square",l.frequency.setValueAtTime(120*n,i.currentTime),l.frequency.exponentialRampToValueAtTime(40,i.currentTime+.06),h.gain.setValueAtTime(s*.3,i.currentTime),h.gain.exponentialRampToValueAtTime(.01,i.currentTime+.06),l.start(),l.stop(i.currentTime+.06);break}case"kill":{r.type="square",r.frequency.setValueAtTime(400*n,i.currentTime),r.frequency.exponentialRampToValueAtTime(800*n,i.currentTime+.15),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.2),r.start(),r.stop(i.currentTime+.2);const l=i.createOscillator(),h=i.createGain();l.connect(h),h.connect(i.destination),l.type="sine",l.frequency.setValueAtTime(600*n,i.currentTime+.05),l.frequency.exponentialRampToValueAtTime(1200,i.currentTime+.2),h.gain.setValueAtTime(s*.25,i.currentTime+.05),h.gain.exponentialRampToValueAtTime(.01,i.currentTime+.25),l.start(i.currentTime+.05),l.stop(i.currentTime+.25);break}case"pickup":r.type="sine",r.frequency.setValueAtTime(500*n,i.currentTime),r.frequency.exponentialRampToValueAtTime(1e3*n,i.currentTime+.1),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.15),r.start(),r.stop(i.currentTime+.15);break;case"menu_click":r.type="sine",r.frequency.setValueAtTime(800,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.05),r.start(),r.stop(i.currentTime+.05);break;case"menu_hover":r.type="sine",r.frequency.setValueAtTime(600,i.currentTime),a.gain.setValueAtTime(s*.3,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.03),r.start(),r.stop(i.currentTime+.03);break;case"craft":r.type="triangle",r.frequency.setValueAtTime(300,i.currentTime),r.frequency.linearRampToValueAtTime(600,i.currentTime+.2),r.frequency.linearRampToValueAtTime(900,i.currentTime+.4),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.5),r.start(),r.stop(i.currentTime+.5);break;case"level_up":{const l=[523,659,784,1047];for(let h=0;h<l.length;h++){const c=i.createOscillator(),d=i.createGain();c.connect(d),d.connect(i.destination),c.type="sine",c.frequency.setValueAtTime(l[h],i.currentTime+h*.1),d.gain.setValueAtTime(s*.5,i.currentTime+h*.1),d.gain.exponentialRampToValueAtTime(.01,i.currentTime+h*.1+.2),c.start(i.currentTime+h*.1),c.stop(i.currentTime+h*.1+.2)}r.disconnect();break}case"quest_complete":{const l=[392,494,587,784];for(let h=0;h<l.length;h++){const c=i.createOscillator(),d=i.createGain();c.connect(d),d.connect(i.destination),c.type="triangle",c.frequency.setValueAtTime(l[h],i.currentTime+h*.12),d.gain.setValueAtTime(s*.4,i.currentTime+h*.12),d.gain.exponentialRampToValueAtTime(.01,i.currentTime+h*.12+.3),c.start(i.currentTime+h*.12),c.stop(i.currentTime+h*.12+.3)}r.disconnect();break}case"damage":{r.type="sawtooth",r.frequency.setValueAtTime(100*n,i.currentTime),r.frequency.exponentialRampToValueAtTime(40,i.currentTime+.15),a.gain.setValueAtTime(s*1.2,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.15),r.start(),r.stop(i.currentTime+.15);const l=i.createOscillator(),h=i.createGain();l.connect(h),h.connect(i.destination),l.type="sine",l.frequency.setValueAtTime(60,i.currentTime),l.frequency.exponentialRampToValueAtTime(30,i.currentTime+.12),h.gain.setValueAtTime(s*.5,i.currentTime),h.gain.exponentialRampToValueAtTime(.01,i.currentTime+.12),l.start(),l.stop(i.currentTime+.12);break}case"heal":{r.type="sine",r.frequency.setValueAtTime(400*n,i.currentTime),r.frequency.linearRampToValueAtTime(600*n,i.currentTime+.3),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.4),r.start(),r.stop(i.currentTime+.4);const l=i.createOscillator(),h=i.createGain();l.connect(h),h.connect(i.destination),l.type="sine",l.frequency.setValueAtTime(800,i.currentTime+.1),l.frequency.linearRampToValueAtTime(1200,i.currentTime+.35),h.gain.setValueAtTime(s*.15,i.currentTime+.1),h.gain.exponentialRampToValueAtTime(.01,i.currentTime+.4),l.start(i.currentTime+.1),l.stop(i.currentTime+.4);break}case"error":r.type="square",r.frequency.setValueAtTime(200,i.currentTime),r.frequency.setValueAtTime(150,i.currentTime+.1),a.gain.setValueAtTime(s*.3,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.2),r.start(),r.stop(i.currentTime+.2);break;case"dodge":{r.type="sine",r.frequency.setValueAtTime(1200*n,i.currentTime),r.frequency.exponentialRampToValueAtTime(300*n,i.currentTime+.12),a.gain.setValueAtTime(s*.35,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.15),r.start(),r.stop(i.currentTime+.15);const l=i.createOscillator(),h=i.createGain();l.connect(h),h.connect(i.destination),l.type="sawtooth",l.frequency.setValueAtTime(800,i.currentTime),l.frequency.exponentialRampToValueAtTime(200,i.currentTime+.1),h.gain.setValueAtTime(s*.12,i.currentTime),h.gain.exponentialRampToValueAtTime(.01,i.currentTime+.1),l.start(),l.stop(i.currentTime+.1);break}case"parry":{r.type="triangle",r.frequency.setValueAtTime(900*n,i.currentTime),r.frequency.exponentialRampToValueAtTime(600,i.currentTime+.08),a.gain.setValueAtTime(s*.6,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.2),r.start(),r.stop(i.currentTime+.2);const l=i.createOscillator(),h=i.createGain();l.connect(h),h.connect(i.destination),l.type="sine",l.frequency.setValueAtTime(1800,i.currentTime),l.frequency.exponentialRampToValueAtTime(1400,i.currentTime+.15),h.gain.setValueAtTime(s*.2,i.currentTime),h.gain.exponentialRampToValueAtTime(.01,i.currentTime+.25),l.start(),l.stop(i.currentTime+.25);break}case"footstep":{r.type="sine",r.frequency.setValueAtTime(80*n,i.currentTime),r.frequency.exponentialRampToValueAtTime(40,i.currentTime+.04),a.gain.setValueAtTime(s*.08,i.currentTime),a.gain.exponentialRampToValueAtTime(.001,i.currentTime+.06),r.start(),r.stop(i.currentTime+.06);break}case"alert":{r.type="square",r.frequency.setValueAtTime(600*n,i.currentTime),r.frequency.exponentialRampToValueAtTime(1200*n,i.currentTime+.08),a.gain.setValueAtTime(s*.25,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.12),r.start(),r.stop(i.currentTime+.12);break}case"gather":{r.type="sawtooth",r.frequency.setValueAtTime(150*n,i.currentTime),r.frequency.exponentialRampToValueAtTime(60,i.currentTime+.08),a.gain.setValueAtTime(s*.3,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.1),r.start(),r.stop(i.currentTime+.1);const l=i.createOscillator(),h=i.createGain();l.connect(h),h.connect(i.destination),l.type="square",l.frequency.setValueAtTime(250*n,i.currentTime),l.frequency.exponentialRampToValueAtTime(80,i.currentTime+.06),h.gain.setValueAtTime(s*.15,i.currentTime),h.gain.exponentialRampToValueAtTime(.01,i.currentTime+.08),l.start(),l.stop(i.currentTime+.08);break}case"combo_hit":{r.type="sine",r.frequency.setValueAtTime(400*n,i.currentTime),r.frequency.exponentialRampToValueAtTime(600*n,i.currentTime+.06),a.gain.setValueAtTime(s*.1,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.08),r.start(),r.stop(i.currentTime+.08);break}case"heartbeat":{r.type="sine",r.frequency.setValueAtTime(50,i.currentTime),a.gain.setValueAtTime(s*.25,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+.12),r.start(),r.stop(i.currentTime+.12);const l=i.createOscillator(),h=i.createGain();l.connect(h),h.connect(i.destination),l.type="sine",l.frequency.setValueAtTime(45,i.currentTime+.15),h.gain.setValueAtTime(0,i.currentTime),h.gain.setValueAtTime(s*.18,i.currentTime+.15),h.gain.exponentialRampToValueAtTime(.01,i.currentTime+.25),l.start(i.currentTime+.15),l.stop(i.currentTime+.25);break}}}startAmbientMusic(e){if(!this._ctx||this._muted)return;this.stopMusic();const t=this._ctx,i=this._masterVolume*this._musicVolume,s=t.createGain();s.connect(t.destination),s.gain.setValueAtTime(i*.15,t.currentTime);const a={calm:[220,277,330,440],combat:[196,233,294,392],dungeon:[185,220,277,370],boss:[175,220,262,349],title:[262,330,392,523]},r=a[e]??a.calm,n=[];for(const l of r){const h=t.createOscillator(),c=t.createGain();h.type="sine",h.frequency.setValueAtTime(l,t.currentTime),h.detune.setValueAtTime((Math.random()-.5)*10,t.currentTime),c.gain.setValueAtTime(.25,t.currentTime),h.connect(c),c.connect(s),h.start(),n.push(h)}this._currentMusic={oscillators:n,gainNode:s}}stopMusic(){if(this._currentMusic){const e=(this._ctx?.currentTime??0)+.8;try{this._currentMusic.gainNode.gain.exponentialRampToValueAtTime(.001,e);for(const t of this._currentMusic.oscillators)try{t.stop(e+.05)}catch{}}catch{}this._currentMusic=null}}async resume(){this._ctx&&this._ctx.state==="suspended"&&await this._ctx.resume()}destroy(){this.stopMusic(),this._ctx&&(this._ctx.close(),this._ctx=null)}serialize(){return{masterVolume:this._masterVolume,musicVolume:this._musicVolume,sfxVolume:this._sfxVolume,ambientVolume:this._ambientVolume,muted:this._muted}}deserialize(e){this._masterVolume=e.masterVolume,this._musicVolume=e.musicVolume,this._sfxVolume=e.sfxVolume,this._ambientVolume=e.ambientVolume,this._muted=e.muted}}const xr=[{id:"welcome",title:"Welcome to EDILAS",icon:"",text:`You are a pilgrim seeking the mythical city of EDILAS.
The world is corrupted. Only you can purify it.`,position:"center"},{id:"movement",title:"Movement",icon:"",text:"Use WASD or arrow keys to move.",requiredAction:"move",position:"top"},{id:"interact",title:"Interact",icon:"",text:"Press E to interact with NPCs and objects.",requiredAction:"interact",position:"top"},{id:"combat",title:"Combat",icon:"",text:"SPACE to attack, SHIFT to parry, CTRL to dodge roll.",requiredAction:"attack",position:"top"},{id:"inventory",title:"Inventory",icon:"",text:"Press I to open your inventory. Pick up items with E.",requiredAction:"open_inventory",position:"top"},{id:"hotbar",title:"Hotbar",icon:"1",text:`Press number keys 1-9 to use items from your hotbar.
Drag items from inventory to the hotbar for quick access.`,position:"bottom"},{id:"crafting",title:"Crafting",icon:"",text:"Press R to open crafting. Combine materials to create items.",requiredAction:"open_crafting",position:"top"},{id:"quests",title:"Quests",icon:"",text:"Press Q to check your quests. Follow the milestones to reach EDILAS.",requiredAction:"open_quests",position:"top"},{id:"building",title:"Building",icon:"",text:`Press B to enter build mode. Place structures to create
your outpost and push back the corruption.`,requiredAction:"enter_build_mode",position:"top"},{id:"survival",title:"Survival",icon:"",text:"Watch your hunger and thirst bars. Eat food and drink water to survive.",position:"bottom"},{id:"corruption",title:"Corruption",icon:"",text:"Purple tiles are corrupted. Defeat bosses to purify biomes.",position:"top"},{id:"done",title:"Good Luck, Pilgrim",icon:"",text:"Your journey begins. Speak to Elder Miriam to start your first quest.",position:"center"}];class O0{_currentStep=0;_active=!0;_completedActions=new Set;_showTimer=0;_skipTimer=0;_stepAdvancedThisFrame=!1;get isActive(){return this._active}get currentStep(){return!this._active||this._currentStep>=xr.length?null:xr[this._currentStep]}start(){this._currentStep=0,this._active=!0,this._showTimer=0}skip(){this._active=!1}hasCompleted(e){return this._completedActions.has(e)}completeAction(e){if(this._completedActions.add(e),this._stepAdvancedThisFrame)return;const t=this.currentStep;t?.requiredAction&&t.requiredAction===e&&(this._stepAdvancedThisFrame=!0,this.advance())}resetFrameGuard(){this._stepAdvancedThisFrame=!1}advance(){this._currentStep++,this._showTimer=0,this._currentStep>=xr.length&&(this._active=!1)}update(e){if(!this._active)return;this._showTimer+=e;const t=this.currentStep;t&&!t.requiredAction&&this._showTimer>5&&this.advance()}render(e,t,i){const s=this.currentStep;if(!s)return;const a=Math.min(1,this._showTimer*3);e.save(),e.globalAlpha=a;const r=Math.min(420,t-40),n=100;let l=(t-r)/2,h;switch(s.position){case"top":h=80;break;case"bottom":h=i-n-80;break;default:h=(i-n)/2}s.position==="center"&&(e.fillStyle="rgba(0,0,0,0.5)",e.fillRect(0,0,t,i)),e.fillStyle="rgba(15,15,30,0.95)",e.beginPath(),e.roundRect(l,h,r,n,10),e.fill(),e.strokeStyle="#6366f1",e.lineWidth=2,e.stroke(),e.font="bold 14px monospace",e.textAlign="left",e.fillStyle="#818cf8",e.fillText(`${s.icon}  ${s.title}`,l+15,h+25),e.font="11px monospace",e.fillStyle="#d1d5db";const c=s.text.split(`
`);for(let d=0;d<c.length;d++)e.fillText(c[d],l+15,h+48+d*16);e.font="9px monospace",e.fillStyle="#6b7280",e.textAlign="right",s.requiredAction?e.fillText(`(${s.requiredAction.replace("_"," ").toUpperCase()} to continue    ESC to skip all)`,l+r-10,h+n-10):e.fillText("(SPACE to continue    ESC to skip all)",l+r-10,h+n-10),e.restore()}serialize(){return{step:this._currentStep,active:this._active}}deserialize(e){this._currentStep=e.step,this._active=e.active}}const ba={poison:{type:"poison",defaultDuration:8,tickInterval:1,maxStacks:5,stackBehavior:"intensity",baseDamagePerTick:2,speedMultiplier:1},burn:{type:"burn",defaultDuration:5,tickInterval:.5,maxStacks:3,stackBehavior:"refresh",baseDamagePerTick:3,speedMultiplier:1},freeze:{type:"freeze",defaultDuration:4,tickInterval:1,maxStacks:3,stackBehavior:"intensity",baseDamagePerTick:1,speedMultiplier:.4},stun:{type:"stun",defaultDuration:2,tickInterval:0,maxStacks:1,stackBehavior:"refresh",baseDamagePerTick:0,speedMultiplier:0},bleed:{type:"bleed",defaultDuration:6,tickInterval:1,maxStacks:5,stackBehavior:"intensity",baseDamagePerTick:2,speedMultiplier:1},corruption:{type:"corruption",defaultDuration:10,tickInterval:2,maxStacks:3,stackBehavior:"intensity",baseDamagePerTick:3,speedMultiplier:.8},regen:{type:"regen",defaultDuration:10,tickInterval:1,maxStacks:3,stackBehavior:"refresh",baseDamagePerTick:-3,speedMultiplier:1},shield:{type:"shield",defaultDuration:8,tickInterval:0,maxStacks:1,stackBehavior:"refresh",baseDamagePerTick:0,speedMultiplier:1},speed_boost:{type:"speed_boost",defaultDuration:5,tickInterval:0,maxStacks:1,stackBehavior:"refresh",baseDamagePerTick:0,speedMultiplier:1.5},damage_boost:{type:"damage_boost",defaultDuration:5,tickInterval:0,maxStacks:3,stackBehavior:"intensity",baseDamagePerTick:0,speedMultiplier:1}};class G0{_effects=new Map;apply(e,t){let i=this._effects.get(e);i||(i=[],this._effects.set(e,i));const s=ba[t.type],a=i.find(r=>r.type===t.type);if(a){s.stackBehavior==="refresh"?(a.remaining=t.duration,a.stacks=Math.min(a.stacks+t.stacks,s.maxStacks)):(a.stacks=Math.min(a.stacks+t.stacks,s.maxStacks),a.remaining=t.duration);return}i.push({...t,remaining:t.duration,tickTimer:0})}getEffects(e){return this._effects.get(e)??[]}hasEffect(e,t){const i=this._effects.get(e);return i?i.some(s=>s.type===t):!1}getStacks(e,t){const i=this._effects.get(e);return i?i.find(a=>a.type===t)?.stacks??0:0}clearEntity(e){this._effects.delete(e)}clearEffect(e,t){const i=this._effects.get(e);if(!i)return;const s=i.findIndex(a=>a.type===t);s!==-1&&i.splice(s,1),i.length===0&&this._effects.delete(e)}getSpeedMultiplier(e){const t=this._effects.get(e);if(!t||t.length===0)return 1;let i=1,s=1;for(const a of t){const r=ba[a.type];r.speedMultiplier<1?i=Math.min(i,r.speedMultiplier):r.speedMultiplier>1&&(s=Math.max(s,r.speedMultiplier))}return i<1?i:s}getDamageMultiplier(e){return 1+this.getStacks(e,"damage_boost")*.15}hasMarkDebuff(e){return this.getStacks(e,"corruption")>=3}tick(e){for(const[t,i]of this._effects){for(let s=i.length-1;s>=0;s--){const a=i[s];if(a.remaining-=e,a.tickTimer+=e,a.tickInterval>0&&a.tickTimer>=a.tickInterval&&a.tickDamage!==0){a.tickTimer-=a.tickInterval;const r=x.current[t];if(r!==void 0){const n=x.max[t]??100,l=a.tickDamage*a.stacks;x.current[t]=Math.max(0,Math.min(n,r-l))}}a.remaining<=0&&i.splice(s,1)}Wi.count[t]!==void 0&&(Wi.count[t]=i.length),i.length===0&&this._effects.delete(t)}}get entityCount(){return this._effects.size}serialize(){const e={};for(const[t,i]of this._effects)e[t]=i.map(s=>({type:s.type,remaining:s.remaining,stacks:s.stacks}));return e}deserialize(e){this._effects.clear();for(const t of Object.keys(e)){const i=Number(t),s=[];for(const a of e[i]){const r=ba[a.type];r&&s.push({type:a.type,duration:r.defaultDuration,remaining:a.remaining,tickDamage:r.baseDamagePerTick,tickInterval:r.tickInterval,tickTimer:0,stacks:a.stacks,sourceEid:0})}s.length>0&&this._effects.set(i,s)}}}const H0={common:60,uncommon:25,rare:10,epic:4,legendary:1},z0={common:1,uncommon:1.3,rare:1.6,epic:2,legendary:3},X0={physical:{dotChance:0,bonusMultiplier:1},fire:{dotType:"burn",dotChance:.25,bonusMultiplier:1.1},ice:{dotType:"freeze",dotChance:.2,bonusMultiplier:.9},lightning:{dotType:"stun",dotChance:.15,bonusMultiplier:1.15},poison:{dotType:"poison",dotChance:.35,bonusMultiplier:.85},void:{dotType:"corruption",dotChance:.3,bonusMultiplier:1.2},holy:{dotChance:0,bonusMultiplier:1}},ud=[5,10,20,50,100],mo=["D","C","B","A","S","SS"],ls=["#aaaaaa","#ffffff","#44ff44","#4488ff","#ff8800","#ff4444"],ql=.02;function Yl(o){let e=0;for(const t of ud)if(o>=t)e++;else break;return e}const V0=40,q0=.5,ra=80,oa=1.2,Y0={physical:"#ffffff",fire:"#ff6600",ice:"#66ccff",lightning:"#ffee44",poison:"#44ff44",void:"#aa00ff",holy:"#ffffff"};class U0{_damageNumbers=[];_projectiles=[];_statusSystem=new G0;_combatTiming=null;_parryEvents=[];setCombatTiming(e){this._combatTiming=e}consumeParryEvents(){if(this._parryEvents.length===0)return[];const e=this._parryEvents;return this._parryEvents=[],e}_attackCooldown=0;_comboCount=0;_comboTimer=0;_comboMaxTimer=2;_highestCombo=0;_lastAttackTime=0;_killCount=0;_ecsWorld=null;_totalKills=0;_bossKills=0;_eliteKills=0;_nightKills=0;_damageDealt=0;_damageTaken=0;_enemyDamageMult=1;setEnemyDamageMult(e){this._enemyDamageMult=e}_playerDefense=0;setPlayerDefense(e){this._playerDefense=e}_bonusDamageMult=1;setBonusDamageMult(e){this._bonusDamageMult=e}_critChanceBonus=0;setCritChanceBonus(e){this._critChanceBonus=e}_critDamageBonus=0;setCritDamageBonus(e){this._critDamageBonus=e}_aggroReduction=0;setAggroReduction(e){this._aggroReduction=e}setWorld(e){this._ecsWorld=e}_removeProjectile(e){const t=this._projectiles[e];if(t.eid&&this._ecsWorld)try{Lc(this._ecsWorld,t.eid)}catch{}const i=this._projectiles.length-1;e!==i&&(this._projectiles[e]=this._projectiles[i]),this._projectiles.length=i}get statusSystem(){return this._statusSystem}getAliveEnemyCount(){return this._ecsWorld?y_(this._ecsWorld):0}findEnemiesInRange(e,t){return this._ecsWorld?__(this._ecsWorld,e,t):[]}get killCount(){return this._killCount}get comboCount(){return this._comboCount}resetCombo(){this._comboCount=0,this._comboTimer=0}get comboTier(){return Yl(this._comboCount)}get comboTierName(){return mo[this.comboTier]??"D"}get highestCombo(){return this._highestCombo}get totalKills(){return this._totalKills}get bossKills(){return this._bossKills}get eliteKills(){return this._eliteKills}get nightKills(){return this._nightKills}get damageDealt(){return this._damageDealt}get damageTaken(){return this._damageTaken}calculateElementalDamage(e,t,i,s=0){const a=X0[t];let r=e*a.bonusMultiplier;if(this._statusSystem.hasMarkDebuff(i)&&(r*=1.5),s>0&&(r*=this._statusSystem.getDamageMultiplier(s)),a.dotType&&Math.random()<a.dotChance){const n=ba[a.dotType];n&&this._statusSystem.apply(i,{type:a.dotType,duration:n.defaultDuration,tickDamage:n.baseDamagePerTick,tickInterval:n.tickInterval,stacks:1,sourceEid:s})}return Math.round(r)}rollLootRarity(e){const t=["common","uncommon","rare","epic","legendary"],i=t.map(r=>H0[r]+(r!=="common"?e*.5:0)),s=i.reduce((r,n)=>r+n,0);let a=Math.random()*s;for(let r=0;r<t.length;r++)if(a-=i[r],a<=0)return t[r];return t[t.length-1]}getSpeedMultiplier(e){return this._statusSystem.getSpeedMultiplier(e)}recordKill(e){this._killCount++,this._totalKills++,e?.isBoss&&this._bossKills++,e?.isElite&&this._eliteKills++,e?.isNight&&this._nightKills++}playerAttack(e,t,i,s="physical"){if(this._attackCooldown>0)return[];const a=i.getEquipmentStats(),r=Nt.baseDamage+a.damage+Math.floor(e.str*Nt.strDamageMultiplier),n=.05+a.critChance+this._critChanceBonus,l=1.5+a.critDamage+this._critDamageBonus,h=[];for(const c of t){if(!c.alive)continue;const d=c.x-e.x,u=c.y-e.y,f=Math.sqrt(d*d+u*u);if(f<=V0){const m=Math.random()<n,_=1+this._comboCount*ql;let p=r*_;m&&(p*=l),p=this.calculateElementalDamage(p,s,c.eid,e.eid),p*=this._bonusDamageMult,p*=.9+Math.random()*.2,p=Math.round(p),this._damageDealt+=p;const g={sourceEid:e.eid,targetEid:c.eid,amount:p,type:s,isCrit:m,knockback:ra};if(h.push(g),c.takeDamage(p),c.alive&&ra>0&&f>.1){const y=d/f*ra,S=u/f*ra;c.applyKnockback(y,S)}c.alive||this._statusSystem.clearEntity(c.eid),this._damageNumbers.push({x:c.x,y:c.y,amount:p,isCrit:m,type:s,timer:oa,vy:-60-Math.random()*30}),this._comboCount++,this._comboCount>this._highestCombo&&(this._highestCombo=this._comboCount),this._comboTimer=this._comboMaxTimer}}return this._attackCooldown=q0,h}processEnemyAttacks(e,t,i){let a=0;for(const r of t){if(!r.alive)continue;if(a>=3)break;const n=e.x-r.x,l=e.y-r.y,h=Math.sqrt(n*n+l*l),c=r.def.aggroRange*.25*(1-this._aggroReduction);if(this._statusSystem.getSpeedMultiplier(r.eid)<=0)continue;const u=vt.timer[r.eid]??0;if(h<=c&&u<=0){const f=r.def.damageType??"physical";let m=Math.round(r.def.damage*(.9+Math.random()*.2)*this._enemyDamageMult);m=this.calculateElementalDamage(m,f,e.eid,r.eid);const _=this._combatTiming?.checkParry();if(_?.success){const p=Math.max(1,Math.round(m*_.damageReflect));r.takeDamage(p),vt.timer[r.eid]=_.stunDuration,this._parryEvents.push({enemyX:r.x,enemyY:r.y,perfect:_.perfect,reflectDmg:p})}else{if(this._playerDefense>0){const p=this._playerDefense/(this._playerDefense+50);m=Math.max(1,Math.round(m*(1-p)))}e.takeDamage(m),this._damageTaken+=m,this._damageNumbers.push({x:e.x,y:e.y,amount:m,isCrit:!1,type:f,timer:oa,vy:-50-Math.random()*20})}vt.timer[r.eid]=r.def.attackSpeed??1,a++}}}_dropLoot(e,t){const i=[],s=e.def.lootTable;if(s){for(const n of s)if(Math.random()<n.chance){const l=this.rollLootRarity(e.def.level??1),h=z0[l],c=n.min+Math.floor(Math.random()*(n.max-n.min+1)),d=Math.max(1,Math.round(c*h));t.addItem(n.id,d),i.push({itemId:n.id,count:d,rarity:l})}}const a=1+this.comboTier*.1,r=Math.floor((e.def.xpReward*.5+Math.random()*e.def.xpReward)*a);return t.addGold(r),i}spawnProjectile(e,t,i,s,a,r,n,l){const h=i-e,c=s-t,d=Math.sqrt(h*h+c*c)||1,u=l?.speed??200,f=h/d*u,m=c/d*u,_=l?.size??4,p=l?.piercing??!1;let g=0;this._ecsWorld&&(g=Is(this._ecsWorld),ce(this._ecsWorld,j,g),ce(this._ecsWorld,U,g),ce(this._ecsWorld,i_,g),ce(this._ecsWorld,Bt,g),j.x[g]=e,j.y[g]=t,U.vx[g]=f,U.vy[g]=m,Bt.vx[g]=f,Bt.vy[g]=m,Bt.damage[g]=a,Bt.life[g]=3,Bt.size[g]=_,Bt.sourceEid[g]=n,Bt.piercing[g]=p?1:0),this._projectiles.push({eid:g,x:e,y:t,vx:f,vy:m,damage:a,type:r,sourceEid:n,size:_,color:l?.color??"#ffaa00",life:3,piercing:p,hitEids:new Set})}applyStatus(e,t){this._statusSystem.apply(e,{type:t.type,duration:t.duration,tickDamage:t.tickDamage,tickInterval:t.tickInterval,stacks:t.stacks,sourceEid:t.sourceEid})}getStatusEffects(e){return this._statusSystem.getEffects(e)}clearStatusEffects(e){this._statusSystem.clearEntity(e)}update(e,t,i){this._attackCooldown=Math.max(0,this._attackCooldown-e),this._comboTimer-=e,this._comboTimer<=0&&(this._comboCount=0);{let s=0;for(;s<this._damageNumbers.length;){const a=this._damageNumbers[s];if(a.timer-=e,a.y+=a.vy*e,a.vy+=50*e,a.timer<=0){const r=this._damageNumbers.length-1;s!==r&&(this._damageNumbers[s]=this._damageNumbers[r]),this._damageNumbers.length=r}else s++}}{let s=0;for(;s<this._projectiles.length;){const a=this._projectiles[s];a.x+=a.vx*e,a.y+=a.vy*e,a.life-=e,a.eid&&this._ecsWorld&&(j.x[a.eid]=a.x,j.y[a.eid]=a.y,Bt.life[a.eid]=a.life);let r=!1;if(a.life<=0){this._removeProjectile(s);continue}if(a.sourceEid===t.eid)for(let n=0;n<i.length;n++){const l=i[n];if(!l.alive||a.hitEids.has(l.eid))continue;const h=l.x-a.x,c=l.y-a.y;if(Math.sqrt(h*h+c*c)<20&&(l.takeDamage(a.damage),a.hitEids.add(l.eid),this._damageNumbers.push({x:l.x,y:l.y,amount:a.damage,isCrit:!1,type:a.type,timer:oa,vy:-50}),!a.piercing)){this._removeProjectile(s),r=!0;break}}else if(!a.hitEids.has(t.eid)&&t.health>0){const n=t.x-a.x,l=t.y-a.y;if(Math.sqrt(n*n+l*l)<16){let c=Math.round(a.damage*this._enemyDamageMult);if(this._playerDefense>0){const d=this._playerDefense/(this._playerDefense+50);c=Math.max(1,Math.round(c*(1-d)))}t.takeDamage(c),a.hitEids.add(t.eid),this._damageNumbers.push({x:t.x,y:t.y,amount:c,isCrit:!1,type:a.type,timer:oa,vy:-50}),a.piercing||(this._removeProjectile(s),r=!0)}}r||s++}}this._statusSystem.tick(e),this.processEnemyAttacks(t,i,e)}render(e,t,i,s){const a=e.canvas.width/2,r=e.canvas.height/2,n=Math.PI*2;if(this._projectiles.length>0){e.save();for(let l=0;l<this._projectiles.length;l++){const h=this._projectiles[l],c=t.worldToScreen(h.x,h.y),d=c.sx-i+a,u=c.sy-s+r;e.globalAlpha=1,e.fillStyle=h.color,e.beginPath(),e.arc(d,u,h.size,0,n),e.fill();const f=d-h.vx*.02,m=u-h.vy*.02;e.globalAlpha=.3,e.strokeStyle=h.color,e.lineWidth=h.size*.6,e.beginPath(),e.moveTo(d,u),e.lineTo(f,m),e.stroke()}e.restore()}if(this._damageNumbers.length>0){e.save(),e.textAlign="center",e.strokeStyle="#000",e.lineWidth=3;for(let l=0;l<this._damageNumbers.length;l++){const h=this._damageNumbers[l],c=t.worldToScreen(h.x,h.y),d=c.sx-i+a,u=c.sy-s+r,f=Math.min(1,h.timer/.3),m=h.isCrit?1.5:1;e.globalAlpha=f,e.font=`bold ${Math.round(12*m)}px monospace`,e.strokeText(String(h.amount),d,u),e.fillStyle=h.isCrit?"#ffff00":Y0[h.type]??"#ffffff",e.fillText(String(h.amount),d,u),h.isCrit&&(e.font="bold 8px monospace",e.fillStyle="#ff4444",e.fillText("CRIT!",d,u-14))}e.restore()}if(this._comboCount>=2){const l=Yl(this._comboCount),h=ls[l]??"#aaaaaa",c=mo[l]??"D",d=1+l*.08;e.save(),e.font=`bold ${Math.round(14*d)}px monospace`,e.textAlign="left",e.fillStyle=h,e.globalAlpha=Math.min(1,this._comboTimer),e.strokeStyle="#000",e.lineWidth=3,e.strokeText(`${c}  ${this._comboCount} COMBO`,20,120),e.fillText(`${c}  ${this._comboCount} COMBO`,20,120);const u=Math.round(this._comboCount*ql*100);e.font="bold 10px monospace",e.fillStyle="#cccccc",e.fillText(`+${u}% damage`,20,136),e.restore()}}serialize(){return{killCount:this._killCount,highestCombo:this._highestCombo,totalKills:this._totalKills,bossKills:this._bossKills,eliteKills:this._eliteKills,nightKills:this._nightKills,damageDealt:this._damageDealt,damageTaken:this._damageTaken}}deserialize(e){this._killCount=e.killCount,this._highestCombo=e.highestCombo??0,this._totalKills=e.totalKills??e.killCount,this._bossKills=e.bossKills??0,this._eliteKills=e.eliteKills??0,this._nightKills=e.nightKills??0,this._damageDealt=e.damageDealt??0,this._damageTaken=e.damageTaken??0}}const j0={opening:{id:"opening",lines:[{text:"The world was whole, once.",duration:3,bgColor:"#000000",effect:"fade_in"},{text:"Then the Corruption came.",duration:3,bgColor:"#1a0a2a"},{text:"Cities fell. People fled. Hope withered.",duration:3,bgColor:"#2a0a3a"},{text:"But there is a legend...",duration:3,bgColor:"#1a0a2a"},{text:"A city untouched by Corruption.",duration:3,bgColor:"#0a1a3a",effect:"flash"},{text:"EDILAS.",duration:4,bgColor:"#0a0a15"},{text:"They say the journey purifies the land.",duration:3,bgColor:"#0a0a15"},{text:"And so... you walk.",duration:3,bgColor:"#0a0a15",effect:"fade_out"},{speaker:"???",icon:"",text:"Wake up, pilgrim. Your journey begins.",bgColor:"#0a0a15"}]},boss_sporelord:{id:"boss_sporelord",lines:[{text:"The forest floor trembles.",duration:2,effect:"shake"},{speaker:"Sporelord",icon:"",text:"YOU DARE ENTER MY DOMAIN?!",bgColor:"#1a2a0a"},{text:"The massive creature rises from the fungal growth.",duration:2},{speaker:"Sporelord",icon:"",text:"THE ROT IS MINE TO COMMAND!",bgColor:"#2a3a0a"}]},reaching_edilas:{id:"reaching_edilas",lines:[{text:"After everything...",duration:3,effect:"fade_in"},{text:"The burning wastelands. The drowned ruins.",duration:3},{text:"The bone fields. The fractured void.",duration:3},{text:"You stand before gates of pure light.",duration:3,bgColor:"#2a3a4a",effect:"flash"},{text:"EDILAS.",duration:4,bgColor:"#4a5a6a"},{text:"The city is real. The legend is true.",duration:3,bgColor:"#5a7a5a"},{text:"But looking back... the corruption still spreads.",duration:4,bgColor:"#3a4a3a"},{text:"The pilgrimage never truly ends.",duration:3,effect:"fade_out"}]}};class K0{_active=!1;_def=null;_lineIndex=0;_lineTimer=0;_fadeAlpha=0;_shakeTimer=0;_flashTimer=0;_onComplete=null;_input;_typewriterPos=0;_typewriterSpeed=30;get isActive(){return this._active}constructor(e){this._input=e}play(e,t){const i=j0[e];i&&(this._def=i,this._active=!0,this._lineIndex=0,this._lineTimer=0,this._fadeAlpha=0,this._typewriterPos=0,this._onComplete=t??null)}update(e){if(!this._active||!this._def)return;const t=this._def.lines[this._lineIndex];if(!t){this._complete();return}this._lineTimer+=e,this._typewriterPos+=this._typewriterSpeed*e,this._shakeTimer>0&&(this._shakeTimer-=e),this._flashTimer>0&&(this._flashTimer-=e),this._lineTimer<e*2&&(t.effect==="fade_in"&&(this._fadeAlpha=1),t.effect==="shake"&&(this._shakeTimer=.5),t.effect==="flash"&&(this._flashTimer=.3)),t.effect==="fade_in"&&(this._fadeAlpha=Math.max(0,1-this._lineTimer)),t.duration&&t.duration>0?this._lineTimer>=t.duration&&this._advanceLine():(this._input.wasPressed("Space")||this._input.wasPressed("Enter"))&&(this._typewriterPos>=t.text.length?this._advanceLine():this._typewriterPos=t.text.length),this._input.wasPressed("Escape")&&this._complete()}_advanceLine(){this._lineIndex++,this._lineTimer=0,this._typewriterPos=0,this._def&&this._lineIndex>=this._def.lines.length&&this._complete()}_complete(){this._active=!1,this._def=null,this._onComplete&&this._onComplete()}render(e,t,i){if(!this._active||!this._def)return;const s=this._def.lines[this._lineIndex];if(!s)return;if(e.save(),this._shakeTimer>0){const n=this._shakeTimer*10;e.translate((Math.random()-.5)*n,(Math.random()-.5)*n)}const a=s.bgColor??"#000000";e.fillStyle=a,e.fillRect(0,0,t,i),this._flashTimer>0&&(e.fillStyle=`rgba(255,255,255,${this._flashTimer})`,e.fillRect(0,0,t,i));const r=s.text.substring(0,Math.floor(this._typewriterPos));if(s.speaker){const l=i-120-30;e.fillStyle="rgba(10,10,20,0.9)",e.beginPath(),e.roundRect(30,l,t-60,120,8),e.fill(),e.strokeStyle="#6366f1",e.lineWidth=1,e.stroke(),e.font="bold 14px monospace",e.textAlign="left",e.fillStyle="#818cf8",e.fillText(`${s.icon??""}  ${s.speaker}`,50,l+28),e.font="12px monospace",e.fillStyle="#e5e7eb",e.fillText(r,50,l+55),s.duration||(e.font="9px monospace",e.fillStyle="#555",e.textAlign="center",e.fillText(" SPACE",t/2,l+120-10))}else e.font="16px monospace",e.textAlign="center",e.fillStyle="#e5e7eb",e.globalAlpha=Math.min(1,this._lineTimer*3),e.fillText(r,t/2,i/2),e.globalAlpha=1;if(this._fadeAlpha>0&&(e.fillStyle=`rgba(0,0,0,${this._fadeAlpha})`,e.fillRect(0,0,t,i)),s.effect==="fade_out"){const n=Math.max(0,this._lineTimer-((s.duration??3)-1));n>0&&(e.fillStyle=`rgba(0,0,0,${Math.min(1,n)})`,e.fillRect(0,0,t,i))}e.font="8px monospace",e.fillStyle="#444",e.textAlign="right",e.fillText("ESC to skip",t-15,i-10),e.restore()}}class Q0{_cellSize;_cells=new Map;_entityCells=new Map;constructor(e=128){this._cellSize=e}_key(e,t){return`${e},${t}`}_cellCoords(e,t){return[Math.floor(e/this._cellSize),Math.floor(t/this._cellSize)]}insert(e){const[t,i]=this._cellCoords(e.x,e.y),s=e.radius??0,a=[],r=Math.floor((e.x-s)/this._cellSize),n=Math.floor((e.x+s)/this._cellSize),l=Math.floor((e.y-s)/this._cellSize),h=Math.floor((e.y+s)/this._cellSize);for(let c=l;c<=h;c++)for(let d=r;d<=n;d++){const u=this._key(d,c);let f=this._cells.get(u);f||(f=[],this._cells.set(u,f)),f.push(e),a.push(u)}this._entityCells.set(e.id,a)}remove(e){const t=this._entityCells.get(e.id);if(t){for(const i of t){const s=this._cells.get(i);if(s){const a=s.indexOf(e);a>=0&&s.splice(a,1),s.length===0&&this._cells.delete(i)}}this._entityCells.delete(e.id)}}update(e){this.remove(e),this.insert(e)}queryRadius(e,t,i){const s=[],a=new Set,r=Math.floor((e-i)/this._cellSize),n=Math.floor((e+i)/this._cellSize),l=Math.floor((t-i)/this._cellSize),h=Math.floor((t+i)/this._cellSize),c=i*i;for(let d=l;d<=h;d++)for(let u=r;u<=n;u++){const f=this._cells.get(this._key(u,d));if(f)for(const m of f){if(a.has(m.id))continue;const _=m.x-e,p=m.y-t;_*_+p*p<=c&&(s.push(m),a.add(m.id))}}return s}queryRect(e,t,i,s){const a=[],r=new Set,n=Math.floor(e/this._cellSize),l=Math.floor((e+i)/this._cellSize),h=Math.floor(t/this._cellSize),c=Math.floor((t+s)/this._cellSize);for(let d=h;d<=c;d++)for(let u=n;u<=l;u++){const f=this._cells.get(this._key(u,d));if(f)for(const m of f)r.has(m.id)||m.x>=e&&m.x<=e+i&&m.y>=t&&m.y<=t+s&&(a.push(m),r.add(m.id))}return a}queryNearest(e,t,i=500){let s=null,a=i*i;const r=this.queryRadius(e,t,i);for(const n of r){const l=n.x-e,h=n.y-t,c=l*l+h*h;c<a&&(a=c,s=n)}return s}clear(){this._cells.clear(),this._entityCells.clear()}get entityCount(){return this._entityCells.size}get cellCount(){return this._cells.size}}const Fi={pilgrim:{id:"pilgrim",name:"Pilgrim",icon:"",description:"A balanced traveler. Jack of all trades.",baseStats:{health:100,stamina:100,damage:10,defense:5,speed:100,critChance:.05},primaryWeapon:"sword",skills:["basic_attack","dodge_roll","purify_touch"],passives:["survivor","fast_learner"]},warrior:{id:"warrior",name:"Warrior",icon:"",description:"A front-line fighter. High health, heavy damage.",baseStats:{health:150,stamina:80,damage:15,defense:10,speed:85,critChance:.08},primaryWeapon:"sword",skills:["basic_attack","shield_bash","whirlwind","battle_cry","ground_slam"],passives:["iron_skin","berserker","counter_strike"]},ranger:{id:"ranger",name:"Ranger",icon:"",description:"A swift hunter. Master of ranged combat and tracking.",baseStats:{health:90,stamina:120,damage:12,defense:4,speed:115,critChance:.12},primaryWeapon:"bow",skills:["basic_attack","aimed_shot","multishot","trap_set","tracking"],passives:["eagle_eye","fleet_foot","nature_bond"]},mage:{id:"mage",name:"Mage",icon:"",description:"A wielder of arcane power. Devastating spells, fragile body.",baseStats:{health:70,stamina:140,damage:18,defense:2,speed:90,critChance:.1},primaryWeapon:"staff",skills:["basic_attack","fireball","ice_lance","chain_lightning","teleport"],passives:["mana_flow","elemental_mastery","spell_echo"]},shadow:{id:"shadow",name:"Shadow",icon:"",description:"A master of stealth and precision. Deadly crits.",baseStats:{health:80,stamina:110,damage:14,defense:3,speed:120,critChance:.2},primaryWeapon:"dagger",skills:["basic_attack","backstab","smoke_bomb","shadow_step","poison_blade"],passives:["assassin","shadow_cloak","death_mark"]},paladin:{id:"paladin",name:"Paladin",icon:"",description:"A holy warrior. Heals allies, purifies corruption.",baseStats:{health:130,stamina:90,damage:12,defense:12,speed:90,critChance:.05},primaryWeapon:"hammer",skills:["basic_attack","holy_strike","divine_shield","consecrate","lay_on_hands"],passives:["holy_aura","corruption_resistance","righteous_fury"]}},bs={basic_attack:{id:"basic_attack",name:"Attack",icon:"",description:"A basic melee attack.",type:"active",targetType:"enemy",cooldown:.5,staminaCost:5,damage:1,range:40,aoeRadius:0,unlockLevel:1,maxRank:5,rankBonus:.1},dodge_roll:{id:"dodge_roll",name:"Dodge Roll",icon:"",description:"Roll to evade attacks. Brief invulnerability.",type:"active",targetType:"self",cooldown:1.5,staminaCost:20,damage:0,range:0,aoeRadius:0,unlockLevel:1,maxRank:3,rankBonus:0},purify_touch:{id:"purify_touch",name:"Purification Touch",icon:"",description:"Cleanse corruption from nearby tiles.",type:"active",targetType:"area",cooldown:10,staminaCost:30,damage:0,range:0,aoeRadius:60,unlockLevel:1,maxRank:5,rankBonus:0},shield_bash:{id:"shield_bash",name:"Shield Bash",icon:"",description:"Bash an enemy, stunning them briefly.",type:"active",targetType:"enemy",cooldown:4,staminaCost:25,damage:.8,range:35,aoeRadius:0,effects:["stun"],unlockLevel:3,maxRank:5,rankBonus:.15},whirlwind:{id:"whirlwind",name:"Whirlwind",icon:"",description:"Spin attack hitting all nearby enemies.",type:"active",targetType:"area",cooldown:6,staminaCost:35,damage:1.2,range:0,aoeRadius:50,unlockLevel:5,maxRank:5,rankBonus:.1},battle_cry:{id:"battle_cry",name:"Battle Cry",icon:"",description:"Boost damage for 10 seconds.",type:"active",targetType:"self",cooldown:20,staminaCost:20,damage:0,range:0,aoeRadius:0,effects:["damage_boost"],unlockLevel:8,maxRank:3,rankBonus:0},ground_slam:{id:"ground_slam",name:"Ground Slam",icon:"",description:"Slam the ground, damaging and knocking back enemies.",type:"active",targetType:"area",cooldown:10,staminaCost:40,damage:2,range:0,aoeRadius:80,effects:["stun"],unlockLevel:12,maxRank:5,rankBonus:.15},aimed_shot:{id:"aimed_shot",name:"Aimed Shot",icon:"",description:"A precise shot with guaranteed crit.",type:"active",targetType:"enemy",cooldown:5,staminaCost:30,damage:2.5,range:200,aoeRadius:0,unlockLevel:3,maxRank:5,rankBonus:.2},multishot:{id:"multishot",name:"Multishot",icon:"",description:"Fire 3 arrows in a spread pattern.",type:"active",targetType:"direction",cooldown:4,staminaCost:25,damage:.6,range:150,aoeRadius:30,unlockLevel:6,maxRank:5,rankBonus:.1},trap_set:{id:"trap_set",name:"Set Trap",icon:"",description:"Place a trap that snares enemies.",type:"active",targetType:"area",cooldown:12,staminaCost:20,damage:.5,range:60,aoeRadius:25,effects:["freeze"],unlockLevel:8,maxRank:3,rankBonus:.1},tracking:{id:"tracking",name:"Tracking",icon:"",description:"Reveal nearby enemies and resources.",type:"active",targetType:"self",cooldown:30,staminaCost:15,damage:0,range:0,aoeRadius:200,unlockLevel:4,maxRank:3,rankBonus:0},fireball:{id:"fireball",name:"Fireball",icon:"",description:"Hurl a fireball that explodes on impact.",type:"active",targetType:"enemy",cooldown:3,staminaCost:25,damage:1.8,range:150,aoeRadius:40,effects:["burn"],unlockLevel:3,maxRank:5,rankBonus:.2},ice_lance:{id:"ice_lance",name:"Ice Lance",icon:"",description:"Pierce through enemies with ice. Slows targets.",type:"active",targetType:"direction",cooldown:2,staminaCost:20,damage:1.2,range:180,aoeRadius:0,effects:["freeze"],unlockLevel:5,maxRank:5,rankBonus:.15},chain_lightning:{id:"chain_lightning",name:"Chain Lightning",icon:"",description:"Lightning that bounces between enemies.",type:"active",targetType:"enemy",cooldown:8,staminaCost:40,damage:1.5,range:120,aoeRadius:100,unlockLevel:10,maxRank:5,rankBonus:.15},teleport:{id:"teleport",name:"Teleport",icon:"",description:"Blink to a nearby location.",type:"active",targetType:"area",cooldown:8,staminaCost:30,damage:0,range:120,aoeRadius:0,unlockLevel:7,maxRank:3,rankBonus:0},backstab:{id:"backstab",name:"Backstab",icon:"",description:"Strike from behind for massive damage.",type:"active",targetType:"enemy",cooldown:3,staminaCost:20,damage:3,range:30,aoeRadius:0,unlockLevel:3,maxRank:5,rankBonus:.25},smoke_bomb:{id:"smoke_bomb",name:"Smoke Bomb",icon:"",description:"Create a smoke cloud. Enemies lose aggro.",type:"active",targetType:"area",cooldown:15,staminaCost:25,damage:0,range:0,aoeRadius:60,effects:["stun"],unlockLevel:5,maxRank:3,rankBonus:0},shadow_step:{id:"shadow_step",name:"Shadow Step",icon:"",description:"Teleport behind an enemy.",type:"active",targetType:"enemy",cooldown:6,staminaCost:20,damage:0,range:100,aoeRadius:0,unlockLevel:7,maxRank:3,rankBonus:0},poison_blade:{id:"poison_blade",name:"Poison Blade",icon:"",description:"Coat your weapon with poison.",type:"active",targetType:"self",cooldown:20,staminaCost:15,damage:0,range:0,aoeRadius:0,effects:["poison"],unlockLevel:4,maxRank:5,rankBonus:0},holy_strike:{id:"holy_strike",name:"Holy Strike",icon:"",description:"A strike infused with holy energy. Extra vs corruption.",type:"active",targetType:"enemy",cooldown:3,staminaCost:20,damage:1.5,range:40,aoeRadius:0,unlockLevel:3,maxRank:5,rankBonus:.15},divine_shield:{id:"divine_shield",name:"Divine Shield",icon:"",description:"Become invulnerable for 3 seconds.",type:"active",targetType:"self",cooldown:30,staminaCost:40,damage:0,range:0,aoeRadius:0,effects:["shield"],unlockLevel:8,maxRank:3,rankBonus:0},consecrate:{id:"consecrate",name:"Consecrate",icon:"",description:"Purify the ground, damaging enemies and cleansing corruption.",type:"active",targetType:"area",cooldown:12,staminaCost:35,damage:.8,range:0,aoeRadius:80,unlockLevel:6,maxRank:5,rankBonus:.1},lay_on_hands:{id:"lay_on_hands",name:"Lay on Hands",icon:"",description:"Fully heal yourself. Long cooldown.",type:"active",targetType:"self",cooldown:60,staminaCost:50,damage:0,range:0,aoeRadius:0,effects:["regen"],unlockLevel:10,maxRank:3,rankBonus:0}},Er={survivor:{id:"survivor",name:"Survivor",icon:"",description:"+5% max health per rank",maxRank:5,effect:{stat:"health",valuePerRank:.05},unlockLevel:1},fast_learner:{id:"fast_learner",name:"Fast Learner",icon:"",description:"+10% XP per rank",maxRank:3,effect:{stat:"xp_bonus",valuePerRank:.1},unlockLevel:1},iron_skin:{id:"iron_skin",name:"Iron Skin",icon:"",description:"+8% defense per rank",maxRank:5,effect:{stat:"defense",valuePerRank:.08},unlockLevel:2},berserker:{id:"berserker",name:"Berserker",icon:"",description:"+10% damage when below 30% HP",maxRank:3,effect:{stat:"low_hp_damage",valuePerRank:.1},unlockLevel:6},counter_strike:{id:"counter_strike",name:"Counter Strike",icon:"",description:"10% chance to counter on block",maxRank:3,effect:{stat:"counter_chance",valuePerRank:.1},unlockLevel:10},eagle_eye:{id:"eagle_eye",name:"Eagle Eye",icon:"",description:"+5% crit chance per rank",maxRank:5,effect:{stat:"critChance",valuePerRank:.05},unlockLevel:2},fleet_foot:{id:"fleet_foot",name:"Fleet Foot",icon:"",description:"+5% movement speed",maxRank:3,effect:{stat:"speed",valuePerRank:.05},unlockLevel:5},nature_bond:{id:"nature_bond",name:"Nature Bond",icon:"",description:"Passive HP regen in forests",maxRank:3,effect:{stat:"forest_regen",valuePerRank:1},unlockLevel:8},mana_flow:{id:"mana_flow",name:"Mana Flow",icon:"",description:"-5% stamina cost per rank",maxRank:5,effect:{stat:"stamina_cost",valuePerRank:-.05},unlockLevel:2},elemental_mastery:{id:"elemental_mastery",name:"Elemental Mastery",icon:"",description:"+10% elemental damage",maxRank:5,effect:{stat:"elemental_damage",valuePerRank:.1},unlockLevel:6},spell_echo:{id:"spell_echo",name:"Spell Echo",icon:"",description:"10% chance to cast twice",maxRank:3,effect:{stat:"spell_echo",valuePerRank:.1},unlockLevel:10},assassin:{id:"assassin",name:"Assassin",icon:"",description:"+15% crit damage per rank",maxRank:5,effect:{stat:"critDamage",valuePerRank:.15},unlockLevel:2},shadow_cloak:{id:"shadow_cloak",name:"Shadow Cloak",icon:"",description:"Reduced enemy aggro range",maxRank:3,effect:{stat:"aggro_reduction",valuePerRank:.15},unlockLevel:6},death_mark:{id:"death_mark",name:"Death Mark",icon:"",description:"Marked enemies take +20% dmg",maxRank:3,effect:{stat:"mark_damage",valuePerRank:.2},unlockLevel:10},holy_aura:{id:"holy_aura",name:"Holy Aura",icon:"",description:"Passive purification aura",maxRank:3,effect:{stat:"purification",valuePerRank:2},unlockLevel:2},corruption_resistance:{id:"corruption_resistance",name:"Corruption Resistance",icon:"",description:"-15% corruption damage",maxRank:5,effect:{stat:"corruption_resist",valuePerRank:.15},unlockLevel:5},righteous_fury:{id:"righteous_fury",name:"Righteous Fury",icon:"",description:"Damage boost vs corrupted enemies",maxRank:3,effect:{stat:"corruption_damage",valuePerRank:.2},unlockLevel:8}};class Z0{_class="pilgrim";_level=1;_xp=0;_xpToNext=100;_skillPoints=0;_skillRanks=new Map;_passiveRanks=new Map;_cooldowns=new Map;get className(){return this._class}get classDef(){return Fi[this._class]}get level(){return this._level}get xp(){return this._xp}get xpToNext(){return this._xpToNext}get skillPoints(){return this._skillPoints}setClass(e){this._class=e,this._skillRanks.clear(),this._passiveRanks.clear();for(const t of Fi[e].skills)this._skillRanks.set(t,1)}addXP(e){this._xp+=e;let t=!1;for(;this._xp>=this._xpToNext;)this._xp-=this._xpToNext,this._level++,this._skillPoints+=2,this._xpToNext=Math.floor(100*Math.pow(1.15,this._level-1)),t=!0;return t}getSkillRank(e){return this._skillRanks.get(e)??0}upgradeSkill(e){if(this._skillPoints<=0)return!1;const t=bs[e];if(!t||t.unlockLevel>this._level)return!1;const i=this._skillRanks.get(e)??0;return i>=t.maxRank?!1:(this._skillRanks.set(e,i+1),this._skillPoints--,!0)}getPassiveRank(e){return this._passiveRanks.get(e)??0}upgradePassive(e){if(this._skillPoints<=0)return!1;const t=Er[e];if(!t||t.unlockLevel>this._level)return!1;const i=this._passiveRanks.get(e)??0;return i>=t.maxRank?!1:(this._passiveRanks.set(e,i+1),this._skillPoints--,!0)}getPassiveBonus(e){let t=0;for(const[i,s]of this._passiveRanks){const a=Er[i];a&&a.effect.stat===e&&(t+=a.effect.valuePerRank*s)}return t}getSkillsUnlockedAtLevel(e){const t=Fi[this._class],i=[];for(const s of t.skills){const a=bs[s];a&&a.unlockLevel===e&&i.push(a)}return i}getPassivesUnlockedAtLevel(e){const t=Fi[this._class],i=[];for(const s of t.passives){const a=Er[s];a&&a.unlockLevel===e&&i.push(a)}return i}isOnCooldown(e){return(this._cooldowns.get(e)??0)>0}getCooldown(e){return this._cooldowns.get(e)??0}triggerCooldown(e){const t=bs[e];t&&this._cooldowns.set(e,t.cooldown)}updateCooldowns(e){for(const[t,i]of this._cooldowns)i>0&&this._cooldowns.set(t,Math.max(0,i-e))}serialize(){return{className:this._class,level:this._level,xp:this._xp,xpToNext:this._xpToNext,skillPoints:this._skillPoints,skillRanks:[...this._skillRanks],passiveRanks:[...this._passiveRanks]}}deserialize(e){this._class=e.className,this._level=e.level,this._xp=e.xp,this._xpToNext=e.xpToNext,this._skillPoints=e.skillPoints,this._skillRanks=new Map(e.skillRanks),this._passiveRanks=new Map(e.passiveRanks)}}function J0(o){const e={cycle:o,enemyHealthMult:1+o*.5,enemyDamageMult:1+o*.3,xpMult:1+o*.2,lootRarityBonus:o*.1,corruptionSpeedMult:1+o*.15,newEnemies:[],removedSafeZones:o>=3,titanRespawnMult:Math.max(.5,1-o*.1),specialModifiers:[]};return o>=1&&(e.newEnemies.push("shadow_knight","corrupted_mage"),e.specialModifiers.push("elite_enemies")),o>=2&&(e.newEnemies.push("void_stalker","abyssal_horror"),e.specialModifiers.push("random_rifts","corruption_storms")),o>=3&&e.specialModifiers.push("permanent_night","no_fast_travel"),o>=5&&e.specialModifiers.push("one_life","all_titans_active"),e}const Ul={keep:["weapon_mastery","class_unlocks","crafting_recipes","trophies","titles","achievements"],lose:["items","city_levels","npc_relationships","map_progress","quest_progress"],goldRetention:.1},ey=[{id:"lq_master_forger",name:"Master Forger",icon:"",description:"Craft one of every weapon and armor type.",unlockCondition:"crafting_level_10",objectives:[{description:"Craft all weapon types",count:5},{description:"Craft all armor types",count:4}],reward:{xp:5e3,gold:3e3,items:[{itemId:"legendary_hammer",count:1}],title:"Master Forger"}},{id:"lq_purifier",name:"Light of the World",icon:"",description:"Purify every biome's corruption core.",unlockCondition:"biome_3_unlocked",objectives:[{description:"Purify all corruption cores",count:5}],reward:{xp:1e4,gold:5e3,items:[{itemId:"purifier_amulet",count:1}],title:"Purifier",unlocks:"pure_mode"}},{id:"lq_titan_hunter",name:"Titanfall",icon:"",description:"Defeat all five Titans.",unlockCondition:"kill_titan_1",objectives:[{description:"Defeat all Titans",count:5}],reward:{xp:15e3,gold:1e4,items:[{itemId:"titan_set_blueprint",count:1}],title:"Titanslayer"}},{id:"lq_rift_master",name:"Abyssal Conqueror",icon:"",description:"Reach rift depth 100.",unlockCondition:"rift_depth_20",objectives:[{description:"Reach rift depth 100",count:100}],reward:{xp:2e4,gold:15e3,items:[{itemId:"void_gem",count:5}],title:"Rift Lord"}},{id:"lq_colony_master",name:"Empire Builder",icon:"",description:"Build 3 settlements with max population.",unlockCondition:"settlement_level_5",objectives:[{description:"Max out 3 settlements",count:3}],reward:{xp:8e3,gold:2e4,items:[{itemId:"crown",count:1}],title:"Emperor"}},{id:"lq_completionist",name:"True Pilgrim",icon:"",description:"Complete all other legendary quests.",unlockCondition:"legendary_quests_4",objectives:[{description:"Complete all legendary quests",count:4}],reward:{xp:5e4,gold:5e4,items:[{itemId:"pilgrim_relic",count:1}],title:"True Pilgrim",unlocks:"true_ending"}}],ty=[{id:"hunt_alpha_wolf",name:"The Alpha",icon:"",targetName:"Fenris, Alpha Wolf",biome:"rotwood",description:"A massive corrupted wolf leading a pack in the Rotwood.",healthMult:5,damageMult:3,specialAbilities:["howl","pack_summon","dash"],timeLimit:300,reward:{xp:2e3,gold:1e3,items:[{itemId:"wolf_fang_necklace",count:1}]}},{id:"hunt_magma_worm",name:"The Burrower",icon:"",targetName:"Pyrax, the Magma Worm",biome:"ashlands",description:"An enormous worm that tunnels through lava.",healthMult:8,damageMult:4,specialAbilities:["burrow","fire_breath","eruption"],timeLimit:600,reward:{xp:5e3,gold:3e3,items:[{itemId:"magma_core",count:1}]}},{id:"hunt_kraken",name:"The Kraken",icon:"",targetName:"Thalassus, the Deep One",biome:"drowned_depths",description:"A colossal squid lurking in the deepest trenches.",healthMult:10,damageMult:5,specialAbilities:["tentacle_slam","ink_cloud","whirlpool"],timeLimit:600,reward:{xp:8e3,gold:5e3,items:[{itemId:"kraken_eye",count:1}]}},{id:"hunt_death_knight",name:"The Fallen Paladin",icon:"",targetName:"Sir Aldric, Death Knight",biome:"bone_wastes",description:"Once a paladin, now a corrupted undead warrior of immense power.",healthMult:12,damageMult:6,specialAbilities:["corruption_slash","undead_army","dark_shield"],timeLimit:0,reward:{xp:12e3,gold:8e3,items:[{itemId:"cursed_blade",count:1}]}},{id:"hunt_void_dragon",name:"The World Eater",icon:"",targetName:"Nihilus, Void Dragon",biome:"the_void",description:"A reality-bending dragon that consumes entire regions.",healthMult:20,damageMult:8,specialAbilities:["void_breath","reality_shatter","phase_shift","summon_void_spawn"],timeLimit:0,reward:{xp:25e3,gold:15e3,items:[{itemId:"dragon_scale",count:1},{itemId:"void_gem",count:2}]}}];class iy{_ngPlusCycle=0;_modifiers=null;_completedLegendary=new Set;_completedHunts=new Set;_titles=[];_totalPlayTime=0;get ngPlusCycle(){return this._ngPlusCycle}get modifiers(){return this._modifiers}get titles(){return this._titles}startNewGamePlus(){return this._ngPlusCycle++,this._modifiers=J0(this._ngPlusCycle),this._modifiers}computeGoldCarryover(e){return Math.floor(e*Ul.goldRetention)}get carryoverRules(){return Ul}completeLegendaryQuest(e){const t=ey.find(i=>i.id===e);return!t||this._completedLegendary.has(e)?null:(this._completedLegendary.add(e),t.reward.title&&this._titles.push(t.reward.title),t)}isLegendaryComplete(e){return this._completedLegendary.has(e)}getLegendaryProgress(){return this._completedLegendary.size}completeHunt(e){const t=ty.find(i=>i.id===e);return!t||this._completedHunts.has(e)?null:(this._completedHunts.add(e),t)}isHuntComplete(e){return this._completedHunts.has(e)}getHuntProgress(){return this._completedHunts.size}serialize(){return{ngPlusCycle:this._ngPlusCycle,modifiers:this._modifiers,completedLegendary:[...this._completedLegendary],completedHunts:[...this._completedHunts],titles:this._titles,totalPlayTime:this._totalPlayTime}}deserialize(e){this._ngPlusCycle=e.ngPlusCycle,this._modifiers=e.modifiers,this._completedLegendary=new Set(e.completedLegendary),this._completedHunts=new Set(e.completedHunts),this._titles=e.titles,this._totalPlayTime=e.totalPlayTime}}const jl=[{id:"spring_bloom",name:"Spring Bloom Festival",icon:"",season:"spring",dayOfSeason:14,duration:3,description:"Celebrate the return of life! Flower decorations, special seeds, and garden contests.",activities:["flower_arranging","seed_exchange","garden_contest","dance"],rewards:[{itemId:"moonpetal_seed",count:3},{itemId:"gold_bar",count:1}],shopDiscounts:.2,xpBonus:.25},{id:"summer_solstice",name:"Summer Solstice",icon:"",season:"summer",dayOfSeason:21,duration:2,description:"The longest day! Bonfires, combat tournaments, and feasting.",activities:["combat_tournament","bonfire","feast","treasure_hunt"],rewards:[{itemId:"ruby",count:2},{itemId:"golden_feast",count:3}],shopDiscounts:.15,xpBonus:.5,specialNPC:"traveling_champion"},{id:"harvest_moon",name:"Harvest Moon Festival",icon:"",season:"autumn",dayOfSeason:15,duration:3,description:"Celebrate the harvest! Cooking contests, crop auctions, and stargazing.",activities:["cooking_contest","crop_auction","stargazing","fortune_telling"],rewards:[{itemId:"pumpkin",count:5},{itemId:"emerald",count:2}],shopDiscounts:.3,xpBonus:.3},{id:"winter_star",name:"Star of Winter",icon:"",season:"winter",dayOfSeason:25,duration:3,description:"Gift-giving, warm drinks, and a mysterious traveler bearing gifts.",activities:["gift_exchange","snowball_fight","hot_drinks","mystery_gifts"],rewards:[{itemId:"sapphire",count:2},{itemId:"void_shard",count:1}],shopDiscounts:.4,xpBonus:.2,specialNPC:"winter_spirit"},{id:"pilgrims_day",name:"Pilgrim's Day",icon:"",season:"spring",dayOfSeason:1,duration:1,description:"Honor the pilgrimage. Miriam tells stories of EDILAS.",activities:["story_telling","prayer","memorial"],rewards:[{itemId:"purification_crystal",count:1}],shopDiscounts:0,xpBonus:.5},{id:"corruption_vigil",name:"Corruption Vigil",icon:"",season:"autumn",dayOfSeason:28,duration:1,description:"A solemn night of purifying the borders. All hands on deck.",activities:["purification_ritual","border_patrol","vigil_bonfire"],rewards:[{itemId:"purification_crystal",count:3}],shopDiscounts:0,xpBonus:0}],Kl=[{id:"merchant_caravan",name:"Merchant Caravan",icon:"",description:"A large caravan has arrived with exotic goods!",probability:.05,duration:2,effects:["extra_merchant","rare_stock"]},{id:"corruption_surge",name:"Corruption Surge",icon:"",description:"The corruption is surging! Enemies are stronger.",probability:.03,duration:3,effects:["enemy_buff_30","corruption_speed_2x"]},{id:"meteor_shower",name:"Meteor Shower",icon:"",description:"Meteors streak across the sky! Rare ores can be found.",probability:.02,duration:1,effects:["rare_ore_spawns","xp_boost_20"]},{id:"lost_traveler",name:"Lost Traveler",icon:"",description:"A lost traveler needs help finding their way.",probability:.08,duration:1,effects:[],choices:[{text:"Help them",outcome:"They join your settlement!",reward:{itemId:"gold_bar",count:2}},{text:"Ignore them",outcome:"They wander off into the corruption..."}]},{id:"blood_moon",name:"Blood Moon",icon:"",description:"The moon turns red. Enemies are frenzied and attack settlements.",probability:.02,duration:1,effects:["enemy_frenzy","settlement_raid","double_loot"]},{id:"wandering_bard",name:"Wandering Bard",icon:"",description:"A bard visits Haven, boosting morale.",probability:.06,duration:2,effects:["npc_happiness_boost","xp_boost_10"]},{id:"natural_spring",name:"Natural Spring",icon:"",description:"A natural spring was discovered! Crops grow faster.",probability:.04,duration:5,effects:["crop_growth_2x"]},{id:"eclipse",name:"Solar Eclipse",icon:"",description:"An eclipse darkens the sky. Shadow creatures appear in force.",probability:.01,duration:1,effects:["permanent_night_1day","shadow_spawn_3x","rare_shadow_loot"]}];class sy{_activeFestival=null;_activeEvents=[];_completedFestivals=new Set;_lastEventRoll=-1;get activeFestival(){return this._activeFestival}get activeEvents(){return this._activeEvents}checkFestival(e,t){if(this._activeFestival){const i=this._activeFestival.dayOfSeason+this._activeFestival.duration;(t>=i||e!==this._activeFestival.season)&&(this._completedFestivals.add(this._activeFestival.id),this._activeFestival=null)}if(!this._activeFestival){const i=jl.find(s=>s.season===e&&t>=s.dayOfSeason&&t<s.dayOfSeason+s.duration);if(i)return this._activeFestival=i,i}return null}rollDailyEvents(e){if(e===this._lastEventRoll)return[];this._lastEventRoll=e;const t=[];for(let i=this._activeEvents.length-1;i>=0;i--)this._activeEvents[i].daysRemaining--,this._activeEvents[i].daysRemaining<=0&&this._activeEvents.splice(i,1);for(const i of Kl)this._activeEvents.some(s=>s.def.id===i.id)||Math.random()<i.probability&&(this._activeEvents.push({def:i,daysRemaining:i.duration}),t.push(i));return t}hasActiveEvent(e){return this._activeEvents.some(t=>t.def.id===e)}getXPBonus(){let e=0;this._activeFestival&&(e+=this._activeFestival.xpBonus);for(const t of this._activeEvents)t.def.effects.includes("xp_boost_20")&&(e+=.2),t.def.effects.includes("xp_boost_10")&&(e+=.1);return e}getShopDiscount(){return this._activeFestival?.shopDiscounts??0}participateActivity(e){if(!this._activeFestival)return null;const t=this._activeFestival.activities;if(e<0||e>=t.length)return null;const i=t[e],a={flower_arranging:{item:{itemId:"herb",count:5},xp:30,gold:20,msg:"Your bouquet wins praise!"},seed_exchange:{item:{itemId:"wheat_seed",count:10},xp:20,gold:0,msg:"You trade seeds with other farmers."},garden_contest:{item:{itemId:"pumpkin",count:3},xp:50,gold:50,msg:"Your garden impresses the judges!"},dance:{xp:20,gold:0,msg:"You dance under the stars."},combat_tournament:{xp:80,gold:100,msg:"The crowd roars as you fight!"},bonfire:{xp:15,gold:0,msg:"The bonfire warms your spirit."},feast:{item:{itemId:"bread",count:5},xp:25,gold:0,msg:"A magnificent feast!"},treasure_hunt:{item:{itemId:"gold_bar",count:1},xp:40,gold:75,msg:"You found hidden treasure!"},cooking_contest:{xp:60,gold:80,msg:"The judges savor your dish!"},crop_auction:{xp:30,gold:120,msg:"Your crops sell for a premium!"},stargazing:{xp:25,gold:0,msg:"The stars reveal ancient patterns."},fortune_telling:{xp:15,gold:10,msg:"A mysterious fortune awaits..."},gift_exchange:{item:{itemId:"health_potion",count:3},xp:20,gold:0,msg:"You receive a thoughtful gift!"},snowball_fight:{xp:30,gold:0,msg:"Direct hit! You win the snowball fight!"},hot_drinks:{xp:10,gold:0,msg:"Warm drinks on a cold day."},mystery_gifts:{item:{itemId:"gem",count:1},xp:20,gold:0,msg:"You unwrap a mystery gift!"},story_telling:{xp:30,gold:0,msg:"Ancient tales fill the gathering."},prayer:{xp:20,gold:0,msg:"You pray for the journey ahead."},memorial:{xp:15,gold:0,msg:"You honor those lost to the corruption."},purification_ritual:{xp:50,gold:0,msg:"The ritual cleanses the area."},border_patrol:{xp:40,gold:30,msg:"You help defend the borders."},vigil_bonfire:{xp:20,gold:0,msg:"The vigil fire burns bright."}}[i]??{xp:15,gold:10,msg:"You participate in the festival."};return{name:i.replace(/_/g," "),reward:a.item??null,xpReward:a.xp,goldReward:a.gold,message:a.msg}}serialize(){return{activeFestival:this._activeFestival?.id??null,activeEvents:this._activeEvents.map(e=>({id:e.def.id,days:e.daysRemaining})),completed:[...this._completedFestivals],lastRoll:this._lastEventRoll}}deserialize(e){if(e.activeFestival&&(this._activeFestival=jl.find(t=>t.id===e.activeFestival)??null),e.activeEvents){this._activeEvents=[];for(const t of e.activeEvents){const i=Kl.find(s=>s.id===t.id);i&&this._activeEvents.push({def:i,daysRemaining:t.days})}}e.completed&&(this._completedFestivals=new Set(e.completed)),e.lastRoll!==void 0&&(this._lastEventRoll=e.lastRoll)}}class ay{_inbox=[];_nextId=1;_maxInbox=50;get inbox(){return this._inbox}get unreadCount(){let e=0;for(const t of this._inbox)t.read||e++;return e}send(e,t,i,s,a,r=[]){this._inbox.unshift({id:this._nextId++,from:e,subject:t,body:i,category:s,timestamp:a,read:!1,attachments:r,claimed:r.length===0}),this._inbox.length>this._maxInbox&&(this._inbox=this._inbox.slice(0,this._maxInbox))}readMail(e){const t=this._inbox.find(i=>i.id===e);return t&&(t.read=!0),t??null}claimAttachments(e){const t=this._inbox.find(i=>i.id===e);return!t||t.claimed?[]:(t.claimed=!0,t.attachments)}deleteMail(e){this._inbox=this._inbox.filter(t=>t.id!==e)}deleteAllRead(){this._inbox=this._inbox.filter(e=>!e.read||!e.claimed)}sendQuestComplete(e,t,i){this.send("Quest Board",`Quest Complete: ${e}`,`You completed "${e}"! Collect your rewards.`,"quest",t,i)}sendNPCGift(e,t,i,s){this.send(e,`A Gift from ${e}`,`"I wanted to thank you for everything. Here's a little something."  ${e}`,"npc",t,[{itemId:i,count:s}])}sendFestivalNotice(e,t){this.send("Elder Miriam",`${e} Begins!`,`The ${e} has started! Visit Haven's center to participate.`,"event",t)}sendMerchantArrival(e,t){this.send(e,"Merchant Has Arrived",`${e} has set up shop near the town gate. They'll be here for 3 days!`,"merchant",t)}checkDailyReward(e){if(e<=this._lastRewardDay)return!1;const t=e-this._lastRewardDay;this._lastRewardDay=e,this._loginStreak=t<=2?this._loginStreak+1:1;const i=[];this._loginStreak>=7?i.push({itemId:"prismatic_shard",count:1}):this._loginStreak>=3?(i.push({itemId:"health_potion",count:3}),i.push({itemId:"iron_ore",count:5})):i.push({itemId:"health_potion",count:1});const s=this._loginStreak>1?` (${this._loginStreak}-day streak!)`:"";return this.send("Elder Miriam",`Daily Gift${s}`,`Welcome back, Pilgrim! The world grows darker but your light endures. Here's a small gift to aid your journey.${s}`,"reward",e,i),!0}_lastRewardDay=0;_loginStreak=0;serialize(){return{inbox:this._inbox,lastRewardDay:this._lastRewardDay,loginStreak:this._loginStreak}}deserialize(e){Array.isArray(e)?(this._inbox=e,this._nextId=Math.max(...e.map(t=>t.id),0)+1):(this._inbox=e.inbox,this._nextId=Math.max(...e.inbox.map(t=>t.id),0)+1,this._lastRewardDay=e.lastRewardDay??0,this._loginStreak=e.loginStreak??0)}}class ry{_pins=[];_currentPin=0;_targetZone=0;_cursor=0;_cursorSpeed=.5;_cursorDir=1;_tolerance=.15;_state="inactive";_lockpicksLeft=0;get state(){return this._state}get currentPin(){return this._currentPin}get totalPins(){return this._pins.length}get cursor(){return this._cursor}get targetZone(){return this._targetZone}get tolerance(){return this._tolerance}get lockpicksLeft(){return this._lockpicksLeft}start(e,t=3){const i=3+Math.floor(e*3);this._pins=[];for(let s=0;s<i;s++)this._pins.push(Math.random());this._currentPin=0,this._targetZone=this._pins[0],this._cursor=0,this._cursorSpeed=.3+e*.5,this._tolerance=Math.max(.05,.2-e*.05),this._cursorDir=1,this._lockpicksLeft=t,this._state="playing"}update(e){this._state==="playing"&&(this._cursor+=this._cursorSpeed*this._cursorDir*e,(this._cursor>=1||this._cursor<=0)&&(this._cursorDir*=-1,this._cursor=Math.max(0,Math.min(1,this._cursor))))}tryPick(){return this._state!=="playing"?!1:Math.abs(this._cursor-this._targetZone)<=this._tolerance?(this._currentPin++,this._currentPin>=this._pins.length?(this._state="won",!0):(this._targetZone=this._pins[this._currentPin],!0)):(this._lockpicksLeft--,this._lockpicksLeft<=0&&(this._state="lost"),!1)}}class oy{_playerDice=[];_opponentDice=[];_bet=0;_state="inactive";_rounds=0;_playerWins=0;_opponentWins=0;get state(){return this._state}get playerDice(){return this._playerDice}get opponentDice(){return this._opponentDice}get bet(){return this._bet}get playerWins(){return this._playerWins}get opponentWins(){return this._opponentWins}start(e,t=3){this._bet=e,this._rounds=t,this._playerWins=0,this._opponentWins=0,this._state="playing"}rollRound(){if(this._state!=="playing")return{playerTotal:0,opponentTotal:0,won:!1};this._playerDice=[1+Math.floor(Math.random()*6),1+Math.floor(Math.random()*6)],this._opponentDice=[1+Math.floor(Math.random()*6),1+Math.floor(Math.random()*6)];const e=this._playerDice.reduce((a,r)=>a+r,0),t=this._opponentDice.reduce((a,r)=>a+r,0),i=e>t;i?this._playerWins++:e<t&&this._opponentWins++;const s=Math.ceil(this._rounds/2);return this._playerWins>=s?this._state="won":this._opponentWins>=s&&(this._state="lost"),{playerTotal:e,opponentTotal:t,won:i}}}class ny{_targetX=.5;_targetY=.5;_aimX=.5;_aimY=.5;_sway=0;_swaySpeed=2;_shotsLeft=5;_score=0;_state="inactive";get state(){return this._state}get aimX(){return this._aimX}get aimY(){return this._aimY}get score(){return this._score}get shotsLeft(){return this._shotsLeft}start(e=.5){this._shotsLeft=5,this._score=0,this._swaySpeed=1.5+e*3,this._state="playing",this._targetX=.5,this._targetY=.5}update(e){this._state==="playing"&&(this._sway+=e*this._swaySpeed,this._aimX=.5+Math.sin(this._sway*1.3)*.15+Math.sin(this._sway*3.7)*.05,this._aimY=.5+Math.cos(this._sway*1.1)*.12+Math.cos(this._sway*2.9)*.04)}shoot(){if(this._state!=="playing")return 0;const e=this._aimX-this._targetX,t=this._aimY-this._targetY,i=Math.sqrt(e*e+t*t);let s=0;return i<.03?s=10:i<.08?s=8:i<.15?s=5:i<.25?s=3:i<.4&&(s=1),this._score+=s,this._shotsLeft--,this._shotsLeft<=0&&(this._state=this._score>=30?"won":"lost"),s}}class ly{lockpick=new ry;dice=new oy;archery=new ny;_activeGame=null;get activeGame(){return this._activeGame}startMinigame(e){this._activeGame=e}endMinigame(){if(!this._activeGame)return null;let e={won:!1,score:0};switch(this._activeGame){case"lockpick":e={won:this.lockpick.state==="won",score:this.lockpick.currentPin};break;case"dice":e={won:this.dice.state==="won",score:this.dice.playerWins,reward:this.dice.state==="won"?{gold:this.dice.bet*2}:void 0};break;case"archery":e={won:this.archery.state==="won",score:this.archery.score,reward:this.archery.state==="won"?{xp:this.archery.score*10}:void 0};break}return this._activeGame=null,e}}class hy{_containers=new Map;_nextId=1;get containers(){return[...this._containers.values()]}createContainer(e,t,i,s=24,a=!1,r=0){const n={id:this._nextId++,name:e,x:t,y:i,capacity:s,items:[],locked:a,lockDifficulty:r};return this._containers.set(n.id,n),n}getContainer(e){return this._containers.get(e)}getNearby(e,t,i=50){const s=[];for(const a of this._containers.values()){const r=a.x-e,n=a.y-t;r*r+n*n<=i*i&&s.push(a)}return s}addItem(e,t,i=1){const s=this._containers.get(e);if(!s||s.locked)return!1;const a=s.items.find(r=>r.itemId===t);return a?(a.count+=i,!0):s.items.length>=s.capacity?!1:(s.items.push({itemId:t,count:i}),!0)}removeItem(e,t,i=1){const s=this._containers.get(e);if(!s||s.locked)return!1;const a=s.items.find(r=>r.itemId===t);return!a||a.count<i?!1:(a.count-=i,a.count<=0&&(s.items=s.items.filter(r=>r.itemId!==t)),!0)}hasItem(e,t,i=1){const s=this._containers.get(e);return s?(s.items.find(r=>r.itemId===t)?.count??0)>=i:!1}unlock(e){const t=this._containers.get(e);return t?(t.locked=!1,!0):!1}quickStack(e,t){const i=this._containers.get(e);if(!i||i.locked)return 0;let s=0;const a=new Set(i.items.map(r=>r.itemId));for(let r=0;r<t.slots.length;r++){const n=t.slots[r];if(!(!n||n.favorite)&&a.has(n.itemId)){const l=n.count;this.addItem(e,n.itemId,l)&&(t.removeSlot(r,l),s+=l)}}return s}depositAll(e,t){const i=this._containers.get(e);if(!i||i.locked)return 0;let s=0;for(let a=0;a<t.slots.length;a++){const r=t.slots[a];if(!r||r.favorite)continue;if(i.items.length>=i.capacity&&!i.items.find(h=>h.itemId===r.itemId))break;const n=r.count;this.addItem(e,r.itemId,n)&&(t.removeSlot(a,n),s+=n)}return s}lootAll(e,t){const i=this._containers.get(e);if(!i||i.locked)return 0;let s=0;for(let a=i.items.length-1;a>=0;a--){const r=i.items[a],n=t.addItem(r.itemId,r.count),l=r.count-n;if(l>0&&(this.removeItem(e,r.itemId,l),s+=l),n>0)break}return s}removeContainer(e){const t=this._containers.get(e);if(!t)return[];const i=[...t.items];return this._containers.delete(e),i}serialize(){return[...this._containers.values()]}deserialize(e){this._containers.clear();for(const t of e)this._containers.set(t.id,t),t.id>=this._nextId&&(this._nextId=t.id+1)}}const na="edilas_save_",la="edilas_save_slots",cy=3,ha=1,dy=120;class uy{_autoSaveTimer=0;_currentSlotId=0;_playTimeSeconds=0;_lastSaveTime=0;_saving=!1;get currentSlotId(){return this._currentSlotId}get playTime(){return this._playTimeSeconds}get timeSinceLastSave(){return Date.now()-this._lastSaveTime}update(e){return this._playTimeSeconds+=e,this._autoSaveTimer+=e,this._autoSaveTimer>=dy?(this._autoSaveTimer=0,!0):!1}listSlots(){try{const e=localStorage.getItem(la);return e?JSON.parse(e):[]}catch{console.warn("[SaveManager] Corrupted slots list, recovering from individual saves");const e=[];for(let t=1;t<=3;t++)try{const i=localStorage.getItem(`${na}${t}`);if(i){const s=JSON.parse(i);s.slot&&e.push(s.slot)}}catch{}return e.length>0&&localStorage.setItem(la,JSON.stringify(e)),e}}save(e,t,i,s,a,r,n,l,h,c,d="haven",u,f,m,_,p){if(this._saving)return!1;this._saving=!0;try{const g={version:ha,slot:{id:e,name:t,timestamp:Date.now(),playTimeSeconds:this._playTimeSeconds,playerLevel:i.level,biome:d,day:a.day,season:a.season,version:ha},player:{x:i.x,y:i.y,level:i.level,xp:i.xp,gold:i.gold,health:i.health,maxHealth:i.maxHealth,stamina:i.stamina,maxStamina:i.maxStamina,hunger:i.hunger,maxHunger:i.maxHunger},inventory:s.serialize(),gameTime:a.serialize(),weather:r.serialize(),combat:n.serialize(),corruption:l.serialize(),quests:h.serialize(),crafting:c.serialize(),cooking:u?.serialize(),temperature:f?.serialize(),weaponMastery:m?.serialize(),skills:_?.serialize(),systemData:p},y=JSON.stringify(g);try{localStorage.setItem(`${na}${e}`,y)}catch(w){return console.error("[SaveManager] localStorage quota exceeded:",w),!1}const S=this.listSlots(),b=S.findIndex(w=>w.id===e);return b>=0?S[b]=g.slot:S.push(g.slot),localStorage.setItem(la,JSON.stringify(S)),this._currentSlotId=e,this._lastSaveTime=Date.now(),console.log(`[SaveManager] Saved to slot ${e} (${(y.length/1024).toFixed(1)} KB)`),!0}catch(g){return console.error("[SaveManager] Save failed:",g),!1}finally{this._saving=!1}}load(e){try{const t=localStorage.getItem(`${na}${e}`);if(!t)return null;const i=JSON.parse(t);return i.version<ha&&console.log(`[SaveManager] Migrating save from v${i.version} to v${ha}`),this._currentSlotId=e,this._playTimeSeconds=i.slot.playTimeSeconds,this._lastSaveTime=i.slot.timestamp,console.log(`[SaveManager] Loaded slot ${e}`),i}catch(t){return console.error("[SaveManager] Load failed:",t),null}}applyToSystems(e,t,i,s,a,r,n,l,h,c,d,u,f,m){t.x=e.player.x,t.y=e.player.y,t.restoreStats(e.player),i.deserialize(e.inventory),s.deserialize(e.gameTime),a.deserialize(e.weather),r.deserialize(e.combat),n.deserialize(e.corruption),l.deserialize(e.quests),h.deserialize(e.crafting),c&&e.cooking&&c.deserialize(e.cooking),d&&e.temperature&&d.deserialize(e.temperature),u&&e.weaponMastery&&u.deserialize(e.weaponMastery),f&&e.skills&&f.deserialize(e.skills),e.systemData&&m&&m(e.systemData),console.log("[SaveManager] Applied save data to all systems")}deleteSlot(e){try{localStorage.removeItem(`${na}${e}`);const t=this.listSlots().filter(i=>i.id!==e);return localStorage.setItem(la,JSON.stringify(t)),console.log(`[SaveManager] Deleted slot ${e}`),!0}catch(t){return console.error("[SaveManager] Delete failed:",t),!1}}hasAnySaves(){return this.listSlots().length>0}getNextFreeSlot(){const e=this.listSlots();for(let t=1;t<=cy;t++)if(!e.find(i=>i.id===t))return t;return 1}formatPlayTime(e){const t=e??this._playTimeSeconds,i=Math.floor(t/3600),s=Math.floor(t%3600/60);return i>0?`${i}h ${s}m`:`${s}m`}}const si={masterVolume:.7,musicVolume:.5,sfxVolume:.8,ambientVolume:.6,screenShake:!0,particleCount:2,showFPS:!1,showDamageNumbers:!0,showMinimap:!0,uiScale:1,fontScale:1,colorBlindMode:"none",autoSaveInterval:120,difficultyModifier:1,deathPenalty:"normal",tutorialEnabled:!0,showTutorialHints:!0,pauseOnFocusLost:!0,keyBindings:{move_up:"KeyW",move_down:"KeyS",move_left:"KeyA",move_right:"KeyD",attack:"Space",interact:"KeyE",dodge:"ShiftLeft",parry:"KeyQ",inventory:"KeyI",crafting:"KeyC",quests:"KeyJ",map:"KeyM",skills:"KeyK",pause:"Escape",sprint:"ShiftRight",use_item_1:"Digit1",use_item_2:"Digit2",use_item_3:"Digit3",use_item_4:"Digit4",skill_1:"KeyZ",skill_2:"KeyX",skill_3:"KeyV"}};class fy{_settings;_storageKey="edilas_settings";constructor(){this._settings={...si,keyBindings:{...si.keyBindings}},this.load()}get settings(){return this._settings}get(e){return this._settings[e]}set(e,t){this._settings[e]=t,this.save()}getKeyForAction(e){return this._settings.keyBindings[e]??""}rebindKey(e,t){this._settings.keyBindings[e]=t,this.save()}resetKeybindings(){this._settings.keyBindings={...si.keyBindings},this.save()}save(){try{localStorage.setItem(this._storageKey,JSON.stringify(this._settings))}catch{}}load(){try{const e=localStorage.getItem(this._storageKey);if(e){const t=JSON.parse(e);this._settings={...si,...t,keyBindings:{...si.keyBindings,...t.keyBindings}}}}catch{}}reset(){this._settings={...si,keyBindings:{...si.keyBindings}},this.save()}getColorTransform(){switch(this._settings.colorBlindMode){case"protanopia":return(e,t,i)=>[.567*e+.433*t,.558*e+.442*t,.242*t+.758*i];case"deuteranopia":return(e,t,i)=>[.625*e+.375*t,.7*e+.3*t,.3*t+.7*i];case"tritanopia":return(e,t,i)=>[.95*e+.05*t,.433*t+.567*i,.475*t+.525*i];default:return null}}_selectedIdx=0;get selectedIdx(){return this._selectedIdx}navigateSettings(e){e==="up"?this._selectedIdx=(this._selectedIdx-1+14)%14:this._selectedIdx=(this._selectedIdx+1)%14}adjustSetting(e){const t=e==="right"?1:-1;switch(this._selectedIdx){case 0:this._settings.masterVolume=Math.max(0,Math.min(1,this._settings.masterVolume+t*.1));break;case 1:this._settings.musicVolume=Math.max(0,Math.min(1,this._settings.musicVolume+t*.1));break;case 2:this._settings.sfxVolume=Math.max(0,Math.min(1,this._settings.sfxVolume+t*.1));break;case 3:this._settings.screenShake=!this._settings.screenShake;break;case 4:this._settings.particleCount=Math.max(0,Math.min(2,this._settings.particleCount+t));break;case 5:this._settings.showFPS=!this._settings.showFPS;break;case 6:this._settings.showDamageNumbers=!this._settings.showDamageNumbers;break;case 7:this._settings.showMinimap=!this._settings.showMinimap;break;case 8:this._settings.uiScale=Math.max(.8,Math.min(1.5,+(this._settings.uiScale+t*.1).toFixed(1)));break;case 9:{const i=["none","protanopia","deuteranopia","tritanopia"],s=i.indexOf(this._settings.colorBlindMode);this._settings.colorBlindMode=i[(s+t+i.length)%i.length]}break;case 10:this._settings.difficultyModifier=Math.max(.5,Math.min(2,+(this._settings.difficultyModifier+t*.1).toFixed(1)));break;case 11:{const i=["none","light","normal","hardcore"],s=i.indexOf(this._settings.deathPenalty);this._settings.deathPenalty=i[(s+t+i.length)%i.length]}break;case 12:this._settings.autoSaveInterval=Math.max(30,Math.min(600,this._settings.autoSaveInterval+t*30));break;case 13:this._settings.tutorialEnabled=!this._settings.tutorialEnabled;break}this.save()}renderSettingsPanel(e,t,i){const s=Math.min(500,t-60),a=Math.min(480,i-80),r=(t-s)/2,n=(i-a)/2;e.fillStyle="rgba(15,15,25,0.95)",e.beginPath(),e.roundRect(r,n,s,a,10),e.fill(),e.strokeStyle="#6366f1",e.lineWidth=2,e.stroke(),e.font="bold 16px monospace",e.textAlign="center",e.fillStyle="#e5e7eb",e.fillText("  Settings",t/2,n+30);const l=[["Master Volume",`${Math.round(this._settings.masterVolume*100)}%`],["Music Volume",`${Math.round(this._settings.musicVolume*100)}%`],["SFX Volume",`${Math.round(this._settings.sfxVolume*100)}%`],["Screen Shake",this._settings.screenShake?"ON":"OFF"],["Particles",["Low","Medium","High"][this._settings.particleCount]??"High"],["Show FPS",this._settings.showFPS?"ON":"OFF"],["Damage Numbers",this._settings.showDamageNumbers?"ON":"OFF"],["Minimap",this._settings.showMinimap?"ON":"OFF"],["UI Scale",`${Math.round(this._settings.uiScale*100)}%`],["Color Blind Mode",this._settings.colorBlindMode],["Difficulty",`${Math.round(this._settings.difficultyModifier*100)}%`],["Death Penalty",this._settings.deathPenalty],["Auto-Save",`${this._settings.autoSaveInterval}s`],["Tutorial",this._settings.tutorialEnabled?"ON":"OFF"]];e.font="11px monospace";let h=n+60;for(let c=0;c<l.length;c++){const[d,u]=l[c],f=c===this._selectedIdx;f&&(e.fillStyle="rgba(99,102,241,0.2)",e.fillRect(r+10,h-14,s-20,22)),e.textAlign="left",e.fillStyle=f?"#a5b4fc":"#9ca3af",e.fillText(f?` ${d}`:`  ${d}`,r+14,h),e.textAlign="right",e.fillStyle=f?"#e0e7ff":"#e5e7eb",e.fillText(f?` ${u} `:u,r+s-20,h),h+=24}e.font="9px monospace",e.textAlign="center",e.fillStyle="#6b7280",e.fillText("ESC close     navigate     adjust",t/2,n+a-15)}}const my={burnt:.3,poor:.6,normal:1,good:1.25,excellent:1.5,masterwork:2},py=[{min:.95,quality:"masterwork"},{min:.8,quality:"excellent"},{min:.6,quality:"good"},{min:.35,quality:"normal"},{min:.15,quality:"poor"},{min:0,quality:"burnt"}],Pt={fried_egg:{id:"fried_egg",name:"Fried Egg",icon:"",station:"campfire",ingredients:[{itemId:"egg",count:1}],output:{itemId:"fried_egg",count:1},difficulty:1,cookTime:3,levelRequired:0,effects:{hunger:25,stamina:15}},grilled_fish:{id:"grilled_fish",name:"Grilled Fish",icon:"",station:"campfire",ingredients:[{itemId:"fish",count:1}],output:{itemId:"grilled_fish",count:1},difficulty:1,cookTime:3,levelRequired:0,effects:{hunger:45,stamina:30}},cooked_meat:{id:"cooked_meat",name:"Cooked Meat",icon:"",station:"campfire",ingredients:[{itemId:"raw_meat",count:1}],output:{itemId:"cooked_meat",count:1},difficulty:1,cookTime:3,levelRequired:0,effects:{hunger:40,stamina:25}},grilled_corn:{id:"grilled_corn",name:"Grilled Corn",icon:"",station:"campfire",ingredients:[{itemId:"corn",count:1}],output:{itemId:"grilled_corn",count:1},difficulty:1,cookTime:3,levelRequired:0,effects:{hunger:20,stamina:10}},baked_potato:{id:"baked_potato",name:"Baked Potato",icon:"",station:"campfire",ingredients:[{itemId:"potato",count:1}],output:{itemId:"baked_potato",count:1},difficulty:1,cookTime:4,levelRequired:0,effects:{hunger:45,stamina:25}},grilled_boar:{id:"grilled_boar",name:"Grilled Wild Boar",icon:"",station:"campfire",ingredients:[{itemId:"boar_meat",count:1}],output:{itemId:"grilled_boar",count:1},difficulty:2,cookTime:5,levelRequired:1,effects:{hunger:65,stamina:40,health:10}},roasted_venison:{id:"roasted_venison",name:"Roasted Venison",icon:"",station:"campfire",ingredients:[{itemId:"venison",count:1},{itemId:"honey",count:1}],output:{itemId:"roasted_venison",count:1},difficulty:3,cookTime:7,levelRequired:2,effects:{hunger:70,stamina:45,health:15}},grilled_salmon:{id:"grilled_salmon",name:"Grilled Salmon",icon:"",station:"campfire",ingredients:[{itemId:"salmon",count:1},{itemId:"hot_pepper",count:1}],output:{itemId:"grilled_salmon",count:1},difficulty:2,cookTime:5,levelRequired:1,effects:{hunger:55,stamina:40}},herbal_tea:{id:"herbal_tea",name:"Herbal Tea",icon:"",station:"campfire",ingredients:[{itemId:"herb",count:2}],output:{itemId:"herbal_tea",count:1},difficulty:1,cookTime:2,levelRequired:0,effects:{stamina:40,health:10}},roasted_cauliflower:{id:"roasted_cauliflower",name:"Roasted Cauliflower",icon:"",station:"campfire",ingredients:[{itemId:"cauliflower",count:2},{itemId:"honey",count:1}],output:{itemId:"roasted_cauliflower",count:1},difficulty:1,cookTime:4,levelRequired:0,effects:{hunger:30,stamina:25}},slime_jelly_toast:{id:"slime_jelly_toast",name:"Slime Jelly Toast",icon:"",station:"campfire",ingredients:[{itemId:"slime_gel",count:3},{itemId:"bread",count:1}],output:{itemId:"slime_jelly_toast",count:1},difficulty:2,cookTime:3,levelRequired:1,effects:{hunger:30,stamina:50,speed:15,duration:240}},dark_bread:{id:"dark_bread",name:"Dark Rye Bread",icon:"",station:"campfire",ingredients:[{itemId:"wheat_seed",count:4},{itemId:"honey",count:1}],output:{itemId:"dark_bread",count:2},difficulty:2,cookTime:5,levelRequired:1,effects:{hunger:40,stamina:20}},vegetable_soup:{id:"vegetable_soup",name:"Vegetable Soup",icon:"",station:"kitchen",ingredients:[{itemId:"potato",count:1},{itemId:"carrot",count:1}],output:{itemId:"vegetable_soup",count:1},difficulty:2,cookTime:5,levelRequired:1,effects:{hunger:50,stamina:30,health:10}},fish_stew:{id:"fish_stew",name:"Fish Stew",icon:"",station:"kitchen",ingredients:[{itemId:"fish",count:2},{itemId:"potato",count:1}],output:{itemId:"fish_stew",count:1},difficulty:3,cookTime:6,levelRequired:2,effects:{hunger:60,stamina:40,health:15}},mushroom_stew:{id:"mushroom_stew",name:"Mushroom Stew",icon:"",station:"kitchen",ingredients:[{itemId:"spore_cap",count:3},{itemId:"herb",count:2}],output:{itemId:"mushroom_stew",count:1},difficulty:2,cookTime:6,levelRequired:1,effects:{hunger:55,stamina:35}},tomato_soup:{id:"tomato_soup",name:"Tomato Soup",icon:"",station:"kitchen",ingredients:[{itemId:"tomato",count:3}],output:{itemId:"tomato_soup",count:1},difficulty:1,cookTime:4,levelRequired:0,effects:{hunger:35,stamina:20}},meat_stew:{id:"meat_stew",name:"Hearty Meat Stew",icon:"",station:"kitchen",ingredients:[{itemId:"raw_meat",count:2},{itemId:"potato",count:1},{itemId:"carrot",count:1}],output:{itemId:"meat_stew",count:1},difficulty:3,cookTime:8,levelRequired:2,effects:{hunger:80,stamina:50,health:20}},rabbit_pie:{id:"rabbit_pie",name:"Rabbit Pie",icon:"",station:"kitchen",ingredients:[{itemId:"rabbit_meat",count:2},{itemId:"potato",count:1},{itemId:"carrot",count:1}],output:{itemId:"rabbit_pie",count:1},difficulty:4,cookTime:9,levelRequired:3,effects:{hunger:75,stamina:55,health:10}},pumpkin_pie:{id:"pumpkin_pie",name:"Pumpkin Pie",icon:"",station:"kitchen",ingredients:[{itemId:"pumpkin",count:1},{itemId:"wheat_seed",count:4},{itemId:"egg",count:1}],output:{itemId:"pumpkin_pie",count:1},difficulty:4,cookTime:8,levelRequired:3,effects:{hunger:80,stamina:60,health:20}},honey_glazed_ham:{id:"honey_glazed_ham",name:"Honey Glazed Ham",icon:"",station:"kitchen",ingredients:[{itemId:"boar_meat",count:2},{itemId:"honey",count:2}],output:{itemId:"honey_glazed_ham",count:1},difficulty:4,cookTime:10,levelRequired:3,effects:{hunger:85,stamina:60,health:25}},bone_marrow_soup:{id:"bone_marrow_soup",name:"Bone Marrow Soup",icon:"",station:"kitchen",ingredients:[{itemId:"bone_fragment",count:3},{itemId:"potato",count:1}],output:{itemId:"bone_marrow_soup",count:1},difficulty:2,cookTime:9,levelRequired:1,effects:{hunger:55,stamina:35,health:30}},honey_cake:{id:"honey_cake",name:"Honey Cake",icon:"",station:"kitchen",ingredients:[{itemId:"honey",count:2},{itemId:"egg",count:2},{itemId:"wheat_seed",count:3}],output:{itemId:"honey_cake",count:1},difficulty:3,cookTime:8,levelRequired:2,effects:{hunger:45,stamina:40}},war_rations:{id:"war_rations",name:"War Rations",icon:"",station:"kitchen",ingredients:[{itemId:"raw_meat",count:2},{itemId:"bread",count:2},{itemId:"carrot",count:2}],output:{itemId:"war_rations",count:2},difficulty:3,cookTime:7,levelRequired:2,effects:{hunger:60,stamina:40,health:15}},peppered_venison:{id:"peppered_venison",name:"Peppered Venison Steak",icon:"",station:"kitchen",ingredients:[{itemId:"venison",count:1},{itemId:"hot_pepper",count:2}],output:{itemId:"peppered_venison",count:1},difficulty:3,cookTime:6,levelRequired:2,effects:{hunger:75,stamina:50,speed:20,duration:300}},spicy_eel:{id:"spicy_eel",name:"Spicy Eel",icon:"",station:"cauldron",ingredients:[{itemId:"eel",count:1},{itemId:"hot_pepper",count:1}],output:{itemId:"spicy_eel",count:1},difficulty:4,cookTime:6,levelRequired:3,effects:{hunger:45,speed:30,luck:20,duration:420}},hunters_stew:{id:"hunters_stew",name:"Hunter's Stew",icon:"",station:"cauldron",ingredients:[{itemId:"venison",count:1},{itemId:"spore_cap",count:2},{itemId:"carrot",count:1},{itemId:"potato",count:1}],output:{itemId:"hunters_stew",count:1},difficulty:4,cookTime:10,levelRequired:3,effects:{hunger:85,stamina:60,health:20,speed:15,duration:480}},adventurers_meal:{id:"adventurers_meal",name:"Adventurer's Meal",icon:"",station:"cauldron",ingredients:[{itemId:"raw_meat",count:2},{itemId:"potato",count:2},{itemId:"carrot",count:1},{itemId:"bread",count:1}],output:{itemId:"adventurers_meal",count:1},difficulty:4,cookTime:10,levelRequired:3,effects:{hunger:90,stamina:70,health:40}},miners_special:{id:"miners_special",name:"Miner's Special",icon:"",station:"cauldron",ingredients:[{itemId:"raw_meat",count:1},{itemId:"potato",count:2},{itemId:"spore_cap",count:2}],output:{itemId:"miners_special",count:1},difficulty:3,cookTime:8,levelRequired:2,effects:{hunger:75,stamina:100}},dark_mushroom_broth:{id:"dark_mushroom_broth",name:"Dark Mushroom Broth",icon:"",station:"cauldron",ingredients:[{itemId:"spore_cap",count:5}],output:{itemId:"dark_mushroom_broth",count:1},difficulty:3,cookTime:6,levelRequired:2,effects:{hunger:40,stamina:30,health:25}},midnight_brew:{id:"midnight_brew",name:"Midnight Brew",icon:"",station:"cauldron",ingredients:[{itemId:"herb",count:4},{itemId:"spore_cap",count:2},{itemId:"honey",count:1}],output:{itemId:"midnight_brew",count:1},difficulty:3,cookTime:6,levelRequired:2,effects:{stamina:60,health:20,luck:10,duration:420}},survivors_feast:{id:"survivors_feast",name:"Survivor's Feast",icon:"",station:"cauldron",ingredients:[{itemId:"raw_meat",count:2},{itemId:"corn",count:2},{itemId:"potato",count:2}],output:{itemId:"survivors_feast",count:1},difficulty:5,cookTime:12,levelRequired:4,effects:{hunger:100,stamina:80,health:50,gatheringBonus:25,duration:900}},hunters_platter:{id:"hunters_platter",name:"Hunter's Platter",icon:"",station:"cauldron",ingredients:[{itemId:"venison",count:1},{itemId:"boar_meat",count:1},{itemId:"rabbit_meat",count:1}],output:{itemId:"hunters_platter",count:1},difficulty:5,cookTime:12,levelRequired:4,effects:{hunger:100,stamina:80,health:30}},stuffed_pumpkin:{id:"stuffed_pumpkin",name:"Stuffed Pumpkin",icon:"",station:"cauldron",ingredients:[{itemId:"pumpkin",count:1},{itemId:"raw_meat",count:1},{itemId:"corn",count:1},{itemId:"spore_cap",count:1}],output:{itemId:"stuffed_pumpkin",count:1},difficulty:4,cookTime:10,levelRequired:3,effects:{hunger:90,stamina:55,health:20}},sturgeon_feast:{id:"sturgeon_feast",name:"Sturgeon Feast",icon:"",station:"cauldron",ingredients:[{itemId:"sturgeon",count:1},{itemId:"potato",count:2},{itemId:"tomato",count:1},{itemId:"honey",count:1}],output:{itemId:"sturgeon_feast",count:1},difficulty:5,cookTime:12,levelRequired:4,effects:{hunger:95,stamina:75,health:30,luck:20,duration:600}},foragers_casserole:{id:"foragers_casserole",name:"Forager's Casserole",icon:"",station:"cauldron",ingredients:[{itemId:"pumpkin",count:1},{itemId:"corn",count:1},{itemId:"potato",count:1},{itemId:"egg",count:1}],output:{itemId:"foragers_casserole",count:1},difficulty:4,cookTime:11,levelRequired:3,effects:{hunger:100,stamina:70,health:25,gatheringBonus:30,duration:720}},royal_jelly_cake:{id:"royal_jelly_cake",name:"Royal Jelly Cake",icon:"",station:"cauldron",ingredients:[{itemId:"royal_jelly",count:1},{itemId:"wheat_seed",count:6},{itemId:"egg",count:2}],output:{itemId:"royal_jelly_cake",count:1},difficulty:5,cookTime:12,levelRequired:5,effects:{hunger:60,stamina:100,health:50,luck:35,duration:900}}};class _y{_cookingLevel=0;_cookingXP=0;_xpToNext=50;_activeCook=null;_discoveredRecipes=new Set;_cookedRecords=new Map;_activeBuffs=[];_currentDay=0;constructor(){for(const[e,t]of Object.entries(Pt))t.levelRequired===0&&t.station==="campfire"&&this._discoveredRecipes.add(e)}get level(){return this._cookingLevel}get xp(){return this._cookingXP}get xpToNext(){return this._xpToNext}get activeCook(){return this._activeCook}get activeBuffs(){return this._activeBuffs}isRecipeDiscovered(e){return this._discoveredRecipes.has(e)}getCookedRecord(e){return this._cookedRecords.get(e)}getDiscoveredRecipes(e){return Object.values(Pt).filter(t=>t.station===e&&this._discoveredRecipes.has(t.id)&&t.levelRequired<=this._cookingLevel)}getAllRecipesForStation(e){return Object.values(Pt).filter(t=>t.station===e)}canCook(e,t){const i=Pt[e];if(!i||!this._discoveredRecipes.has(e)||i.levelRequired>this._cookingLevel||this._activeCook)return!1;for(const s of i.ingredients)if(!t.hasItem(s.itemId,s.count))return!1;return!0}_calculateQuality(e){const i=.4+(this._cookingLevel-e.difficulty)*.1,s=Math.random()+i;for(const a of py)if(s>=a.min)return a.quality;return"burnt"}startCooking(e,t){if(!this.canCook(e,t))return!1;const i=Pt[e];for(const a of i.ingredients)t.removeItem(a.itemId,a.count);const s=this._calculateQuality(i);return this._activeCook={recipe:i,timer:i.cookTime,quality:s},!0}update(e,t,i){this._currentDay=i;for(let s=this._activeBuffs.length-1;s>=0;s--){const a=this._activeBuffs[s];a.remaining-=e,a.remaining<=0&&this._activeBuffs.splice(s,1)}if(!this._activeCook)return!1;if(this._activeCook.timer-=e,this._activeCook.timer<=0){const{recipe:s,quality:a}=this._activeCook;t.addItem(s.output.itemId,s.output.count),this._discoveredRecipes.has(s.id)||this._discoveredRecipes.add(s.id);const r=this._cookedRecords.get(s.id);if(r){r.count++;const l=["burnt","poor","normal","good","excellent","masterwork"];l.indexOf(a)>l.indexOf(r.bestQuality)&&(r.bestQuality=a)}else this._cookedRecords.set(s.id,{count:1,bestQuality:a,firstCookedDay:this._currentDay});const n=10+s.difficulty*8+(a==="masterwork"?15:0);return this._addXP(n),this._tryDiscoverRecipes(),this._activeCook=null,!0}return!1}applyFoodBuff(e,t){const i=Pt[e];if(!i)return;const s=my[t],a=(i.effects.duration??180)*s,r=this._activeBuffs.findIndex(l=>l.recipeId===e);r>=0&&this._activeBuffs.splice(r,1);const n={};for(const[l,h]of Object.entries(i.effects))l!=="duration"&&(n[l]=Math.round(h*s));n.duration=a,this._activeBuffs.push({recipeId:e,effects:n,remaining:a,quality:t})}getTotalBuffStats(){const e={};for(const t of this._activeBuffs)for(const[i,s]of Object.entries(t.effects)){if(i==="duration")continue;const a=i;e[a]=(e[a]??0)+s}return e}_tryDiscoverRecipes(){for(const[e,t]of Object.entries(Pt)){if(this._discoveredRecipes.has(e)||t.levelRequired>this._cookingLevel)continue;const i=t.station===(this._activeCook?.recipe.station??"campfire")?.6:.4;Math.random()<i&&this._discoveredRecipes.add(e)}}discoverRecipe(e){return Pt[e]?(this._discoveredRecipes.add(e),!0):!1}onMaterialAcquired(e){const t=[];for(const[i,s]of Object.entries(Pt))this._discoveredRecipes.has(i)||s.levelRequired>this._cookingLevel+2||!s.ingredients.some(r=>r.itemId===e)||Math.random()<.5&&(this._discoveredRecipes.add(i),t.push(s.name));return t}_addXP(e){for(this._cookingXP+=e;this._cookingXP>=this._xpToNext;)this._cookingXP-=this._xpToNext,this._cookingLevel++,this._xpToNext=Math.floor(50*Math.pow(1.35,this._cookingLevel)),this._tryDiscoverRecipes()}serialize(){return{level:this._cookingLevel,xp:this._cookingXP,xpToNext:this._xpToNext,discovered:[...this._discoveredRecipes],records:[...this._cookedRecords.entries()],buffs:this._activeBuffs.map(e=>({...e}))}}deserialize(e){this._cookingLevel=e.level,this._cookingXP=e.xp,this._xpToNext=e.xpToNext,this._discoveredRecipes=new Set(e.discovered),this._cookedRecords=new Map(e.records),this._activeBuffs=e.buffs.map(t=>({...t}))}}const ca=98.6,da=88,Dr=112,gy=.08,yy=.03,by=12,wy=3,vy=.4,Ql=2,Sy=93,ky=95,Zl=96.5,Jl=101,Ty=104,My=107,Cy=5,Py=2,Iy=3,Ay=6,Ry={haven:65,rotwood:60,ashlands:95,drowned_depths:50,bone_wastes:55,the_void:40,edilas:70,forest:60,ice:15,swamp:65,undead:45,volcano:100},xy={spring:0,summer:15,autumn:-5,winter:-25},eh={clear:{temp:5,wetness:0},cloudy:{temp:-3,wetness:0},rain:{temp:-10,wetness:25},storm:{temp:-15,wetness:40},snow:{temp:-20,wetness:15},blizzard:{temp:-30,wetness:20},fog:{temp:-5,wetness:10},heatwave:{temp:15,wetness:0},ashfall:{temp:10,wetness:0}},ua=[{name:"freezing",min:-50,max:20,color:"#4FC3F7",hazard:"frostbite"},{name:"cold",min:20,max:40,color:"#81D4FA",hazard:"hypothermia"},{name:"cool",min:40,max:55,color:"#B3E5FC",hazard:"chill"},{name:"temperate",min:55,max:80,color:"#C8E6C9",hazard:"none"},{name:"warm",min:80,max:95,color:"#FFCC80",hazard:"none"},{name:"hot",min:95,max:115,color:"#FF8A65",hazard:"heatstroke"},{name:"scorching",min:115,max:200,color:"#E53935",hazard:"burning"}];class Ey{_state={bodyTemp:ca,envTemp:65,targetBodyTemp:ca,wetness:0,totalInsulation:0,totalHeatResist:0,currentZone:"temperate",currentHazard:"none",hazardTimer:0,frostbiteStacks:0,heatstrokeStacks:0};_nearbyWarmthSources=[];_isInShelter=!1;_isInWater=!1;get state(){return this._state}get bodyTemp(){return this._state.bodyTemp}get envTemp(){return this._state.envTemp}get currentZone(){return this._state.currentZone}get currentHazard(){return this._state.currentHazard}get wetness(){return this._state.wetness}setInShelter(e){this._isInShelter=e}setInWater(e){this._isInWater=e}setNearbyWarmthSources(e){this._nearbyWarmthSources=e}setClothingWarmth(e){this._state.totalInsulation=0,this._state.totalHeatResist=0;for(const t of e)this._state.totalInsulation+=t.warmth,this._state.totalHeatResist+=t.heatResist}calculateEnvTemp(e,t,i,s,a){let r=Ry[e]??65;r+=xy[t.season];const n=t.hour;n>=0&&n<6?r-=12:n>=6&&n<12?r+=(n-6)*2:n>=12&&n<18?r+=12-(n-12)*1.5:r-=(n-18)*2;const l=eh[i];l&&(r+=l.temp),this._isInShelter&&(r=r*.5+65*.5),this._isInWater&&(r-=15);for(const h of this._nearbyWarmthSources){const c=s-h.x,d=a-h.y,u=Math.sqrt(c*c+d*d);if(u<h.radius){const f=1-u/h.radius;r+=h.warmth*f}}return r}_getZone(e){for(const t of ua)if(e>=t.min&&e<t.max)return t;return e<0?ua[0]:ua[ua.length-1]}_getHazard(e){return e<=Sy?"frostbite":e<=ky?"hypothermia":e<=Zl?"chill":e>=My?"burning":e>=Ty?"heatstroke":e>=Jl?"heat_fatigue":"none"}update(e,t,i,s,a,r){const n={healthDrain:0,staminaDrain:0,speedModifier:1,hazardMessage:null};this._state.envTemp=this.calculateEnvTemp(t,i,s,a,r);const l=this._getZone(this._state.envTemp);this._state.currentZone=l.name;const h=eh[s];h&&h.wetness>0&&!this._isInShelter&&(this._state.wetness=Math.min(100,this._state.wetness+h.wetness*e*.1)),this._isInWater&&(this._state.wetness=100);const c=this._state.envTemp>70?by:wy;!this._isInWater&&(h?.wetness??0)===0&&(this._state.wetness=Math.max(0,this._state.wetness-c*e*.1));const d=this._state.envTemp-65;let u=ca;if(d<0){const p=d*.15,g=this._state.totalInsulation*.3,y=this._state.wetness*vy*.01;u+=p+g-y}else if(d>0){const p=d*.12,g=this._state.totalHeatResist*.25;u+=p-g}this._state.targetBodyTemp=Math.max(da,Math.min(Dr,u));const f=this._state.targetBodyTemp-this._state.bodyTemp;this._state.bodyTemp+=f*gy*e;const m=ca-this._state.bodyTemp;this._state.bodyTemp+=m*yy*e,this._state.bodyTemp=Math.max(da,Math.min(Dr,this._state.bodyTemp));const _=this._getHazard(this._state.bodyTemp);if(this._state.currentHazard=_,_!=="none"){if(this._state.hazardTimer+=e,this._state.hazardTimer>=Ql)switch(this._state.hazardTimer-=Ql,_){case"frostbite":this._state.frostbiteStacks=Math.min(5,this._state.frostbiteStacks+1),n.healthDrain=Cy*(1+this._state.frostbiteStacks*.3),n.speedModifier=.5,n.staminaDrain=5,n.hazardMessage="Frostbite! Your extremities are freezing.";break;case"hypothermia":n.healthDrain=Py,n.speedModifier=.7,n.staminaDrain=3,n.hazardMessage="Hypothermia. Find warmth quickly.";break;case"chill":n.speedModifier=.85,n.staminaDrain=1;break;case"heat_fatigue":n.staminaDrain=4,n.speedModifier=.9;break;case"heatstroke":n.healthDrain=Iy,n.staminaDrain=6,n.speedModifier=.7,n.hazardMessage="Heatstroke! Cool down immediately.";break;case"burning":this._state.heatstrokeStacks=Math.min(5,this._state.heatstrokeStacks+1),n.healthDrain=Ay*(1+this._state.heatstrokeStacks*.3),n.speedModifier=.5,n.staminaDrain=8,n.hazardMessage="Burning! Your body is overheating dangerously.";break}}else this._state.hazardTimer=0,this._state.bodyTemp>Zl&&(this._state.frostbiteStacks=Math.max(0,this._state.frostbiteStacks-1)),this._state.bodyTemp<Jl&&(this._state.heatstrokeStacks=Math.max(0,this._state.heatstrokeStacks-1));return n}getZoneColor(){return this._getZone(this._state.envTemp).color}getBodyTempNormalized(){return(this._state.bodyTemp-da)/(Dr-da)}isComfortable(){return this._state.currentHazard==="none"}serialize(){return{bodyTemp:this._state.bodyTemp,envTemp:this._state.envTemp,wetness:this._state.wetness,insulation:this._state.totalInsulation,heatResist:this._state.totalHeatResist,frostbiteStacks:this._state.frostbiteStacks,heatstrokeStacks:this._state.heatstrokeStacks}}deserialize(e){this._state.bodyTemp=e.bodyTemp,this._state.envTemp=e.envTemp,this._state.wetness=e.wetness,this._state.totalInsulation=e.insulation,this._state.totalHeatResist=e.heatResist,this._state.frostbiteStacks=e.frostbiteStacks,this._state.heatstrokeStacks=e.heatstrokeStacks,this._state.currentZone=this._getZone(e.envTemp).name,this._state.currentHazard=this._getHazard(e.bodyTemp),this._state.targetBodyTemp=e.bodyTemp}}const Ci=20,Dy=100,Fy=1.15,Pi={sword:{id:"sword",name:"Sword Mastery",icon:"",description:"Master the art of the blade.",color:"#C0C0C0",passivePerLevel:{damage:.02,attackSpeed:.01,critChance:.005},skills:{5:{id:"quick_slash",name:"Quick Slash",description:"A rapid strike that hits twice.",icon:"",type:"active",cooldown:8,staminaCost:15,effect:{type:"multi_hit",hits:2,damageMultiplier:.6}},10:{id:"parry",name:"Parry",description:"Block the next attack and counter.",icon:"",type:"active",cooldown:12,staminaCost:10,effect:{type:"parry",duration:2,counterMultiplier:1.5}},15:{id:"blade_dance",name:"Blade Dance",description:"Whirl your blade, hitting all nearby enemies.",icon:"",type:"active",cooldown:20,staminaCost:25,effect:{type:"aoe",radius:80,damageMultiplier:.8}},20:{id:"sword_mastery",name:"True Sword Master",description:"+25% sword damage, attacks can crit for 3x.",icon:"",type:"passive",effect:{type:"mastery_bonus",damageBonus:.25,critMultiplier:3}}}},axe:{id:"axe",name:"Axe Mastery",icon:"",description:"Wield the power of the heavy axe.",color:"#8B4513",passivePerLevel:{damage:.03,armorPen:.01,stunChance:.005},skills:{5:{id:"cleave",name:"Cleave",description:"A powerful swing in an arc.",icon:"",type:"active",cooldown:10,staminaCost:20,effect:{type:"cone",angle:90,damageMultiplier:1.2}},10:{id:"rend",name:"Rend",description:"Cause bleeding damage over time.",icon:"",type:"active",cooldown:15,staminaCost:18,effect:{type:"bleed",duration:5,tickDamage:.1}},15:{id:"executioner",name:"Executioner",description:"Massive damage to enemies below 30% HP.",icon:"",type:"active",cooldown:25,staminaCost:30,effect:{type:"execute",threshold:.3,damageMultiplier:2.5}},20:{id:"axe_mastery",name:"Berserker",description:"+30% axe damage, 15% stun chance.",icon:"",type:"passive",effect:{type:"mastery_bonus",damageBonus:.3,stunChance:.15}}}},spear:{id:"spear",name:"Spear Mastery",icon:"",description:"Control the battlefield with reach.",color:"#4682B4",passivePerLevel:{damage:.02,range:.02,knockback:.01},skills:{5:{id:"thrust",name:"Piercing Thrust",description:"Long-range thrust that ignores armor.",icon:"",type:"active",cooldown:6,staminaCost:12,effect:{type:"thrust",range:120,armorPen:1}},10:{id:"sweep",name:"Leg Sweep",description:"Sweep enemies, slowing them.",icon:"",type:"active",cooldown:14,staminaCost:16,effect:{type:"slow",duration:3,slowAmount:.5}},15:{id:"impale",name:"Impale",description:"Pin an enemy in place.",icon:"",type:"active",cooldown:22,staminaCost:28,effect:{type:"root",duration:3,damageMultiplier:1.5}},20:{id:"spear_mastery",name:"Phalanx Master",description:"+20% damage, +50% range, first strike crits.",icon:"",type:"passive",effect:{type:"mastery_bonus",damageBonus:.2,rangeBonus:.5,firstStrikeCrit:!0}}}},bow:{id:"bow",name:"Bow Mastery",icon:"",description:"Strike from afar with deadly precision.",color:"#228B22",passivePerLevel:{damage:.02,accuracy:.015,drawSpeed:.01},skills:{5:{id:"power_shot",name:"Power Shot",description:"A charged shot with bonus damage.",icon:"",type:"active",cooldown:8,staminaCost:14,effect:{type:"charged",chargeTime:1.5,damageMultiplier:2}},10:{id:"rain_of_arrows",name:"Rain of Arrows",description:"Fire multiple arrows into an area.",icon:"",type:"active",cooldown:18,staminaCost:25,effect:{type:"aoe",radius:100,arrows:5,damageMultiplier:.4}},15:{id:"marked_for_death",name:"Mark Target",description:"Mark an enemy to take 50% more damage.",icon:"",type:"active",cooldown:20,staminaCost:15,effect:{type:"mark",duration:8,damageIncrease:.5}},20:{id:"bow_mastery",name:"Hawkeye",description:"+25% bow damage, arrows pierce enemies.",icon:"",type:"passive",effect:{type:"mastery_bonus",damageBonus:.25,pierce:!0}}}},staff:{id:"staff",name:"Staff Mastery",icon:"",description:"Channel arcane power through your staff.",color:"#9932CC",passivePerLevel:{damage:.02,manaRegen:.02,spellPower:.015},skills:{5:{id:"arcane_bolt",name:"Arcane Bolt",description:"Fire a bolt of pure arcane energy.",icon:"",type:"active",cooldown:4,staminaCost:10,effect:{type:"projectile",speed:300,damageMultiplier:1.2}},10:{id:"barrier",name:"Arcane Barrier",description:"Create a protective barrier.",icon:"",type:"active",cooldown:20,staminaCost:20,effect:{type:"shield",absorb:50,duration:5}},15:{id:"chain_lightning",name:"Chain Lightning",description:"Lightning that jumps between enemies.",icon:"",type:"active",cooldown:16,staminaCost:30,effect:{type:"chain",jumps:4,damageDecay:.8,damageMultiplier:1}},20:{id:"staff_mastery",name:"Archmage",description:"+30% staff damage, spells cost 25% less.",icon:"",type:"passive",effect:{type:"mastery_bonus",damageBonus:.3,costReduction:.25}}}},dagger:{id:"dagger",name:"Dagger Mastery",icon:"",description:"Strike from the shadows with lethal precision.",color:"#555555",passivePerLevel:{damage:.015,critChance:.02,attackSpeed:.015},skills:{5:{id:"backstab",name:"Backstab",description:"Deal 3x damage from behind.",icon:"",type:"active",cooldown:6,staminaCost:12,effect:{type:"backstab",damageMultiplier:3}},10:{id:"poison_blade",name:"Poison Blade",description:"Coat your blade in poison for 10s.",icon:"",type:"active",cooldown:18,staminaCost:15,effect:{type:"poison_coat",duration:10,tickDamage:.08}},15:{id:"shadow_step",name:"Shadow Step",description:"Teleport behind the nearest enemy.",icon:"",type:"active",cooldown:15,staminaCost:20,effect:{type:"teleport",range:120,damageMultiplier:1.5}},20:{id:"dagger_mastery",name:"Assassin",description:"+20% dagger damage, crits deal 4x.",icon:"",type:"passive",effect:{type:"mastery_bonus",damageBonus:.2,critMultiplier:4}}}},hammer:{id:"hammer",name:"Hammer Mastery",icon:"",description:"Crush foes with overwhelming force.",color:"#8B8B83",passivePerLevel:{damage:.025,stunChance:.01,knockback:.015},skills:{5:{id:"ground_slam",name:"Ground Slam",description:"Slam the ground, stunning nearby enemies.",icon:"",type:"active",cooldown:10,staminaCost:20,effect:{type:"aoe_stun",radius:60,duration:2,damageMultiplier:.8}},10:{id:"armor_break",name:"Armor Break",description:"Shatter enemy armor for 8 seconds.",icon:"",type:"active",cooldown:14,staminaCost:18,effect:{type:"debuff",duration:8,armorPen:1}},15:{id:"earthquake",name:"Earthquake",description:"Create a shockwave in a large area.",icon:"",type:"active",cooldown:25,staminaCost:35,effect:{type:"aoe",radius:120,damageMultiplier:1,knockback:150}},20:{id:"hammer_mastery",name:"Titan",description:"+30% hammer damage, attacks always knock back.",icon:"",type:"passive",effect:{type:"mastery_bonus",damageBonus:.3,knockback:200}}}},scythe:{id:"scythe",name:"Scythe Mastery",icon:"",description:"Reap enemies with sweeping strikes.",color:"#4B0082",passivePerLevel:{damage:.02,critChance:.01,attackSpeed:.01},skills:{5:{id:"reap",name:"Reap",description:"Sweep a wide arc, hitting all enemies in front.",icon:"",type:"active",cooldown:8,staminaCost:18,effect:{type:"cone",angle:120,damageMultiplier:.9}},10:{id:"life_drain",name:"Life Drain",description:"Drain HP from enemies hit.",icon:"",type:"active",cooldown:16,staminaCost:22,effect:{type:"lifesteal",duration:5,damageMultiplier:.7}},15:{id:"death_spiral",name:"Death Spiral",description:"Spin rapidly, dealing continuous damage.",icon:"",type:"active",cooldown:22,staminaCost:30,effect:{type:"channel",duration:3,damageMultiplier:.5,radius:70}},20:{id:"scythe_mastery",name:"Reaper",description:"+25% scythe damage, kills restore 10% HP.",icon:"",type:"passive",effect:{type:"mastery_bonus",damageBonus:.25}}}}};class $y{_masteries=new Map;_cooldowns=new Map;constructor(){for(const e of Object.keys(Pi))this._masteries.set(e,{level:1,xp:0,xpToNext:this._getXPForLevel(2),unlockedSkills:[]})}getLevel(e){return this._masteries.get(e)?.level??1}getProgress(e){return this._masteries.get(e)}getSummary(e){const t=this._masteries.get(e),i=Pi[e];if(!t||!i)return null;const s={};for(const[r,n]of Object.entries(i.passivePerLevel))s[r]=n*t.level;const a=[];for(const[r,n]of Object.entries(i.skills))t.level>=Number(r)&&a.push(n);return{weaponType:e,name:i.name,icon:i.icon,color:i.color,level:t.level,xp:t.xp,xpToNext:t.xpToNext,progress:t.xpToNext>0?t.xp/t.xpToNext:1,passives:s,skills:a,isMaxLevel:t.level>=Ci}}isSkillUnlocked(e,t){return this._masteries.get(e)?.unlockedSkills.includes(t)??!1}getSkillCooldown(e){return this._cooldowns.get(e)??0}addXP(e,t){const i=this._masteries.get(e);if(!i)return[];if(i.level>=Ci)return[];const s=[];for(i.xp+=t;i.xp>=i.xpToNext&&i.level<Ci;){i.xp-=i.xpToNext,i.level++,i.xpToNext=this._getXPForLevel(i.level+1);const a=Pi[e],r={weaponType:e,newLevel:i.level,weaponName:a.name,weaponIcon:a.icon},n=a.skills[i.level];n&&(i.unlockedSkills.push(n.id),r.unlockedSkill=n),s.push(r)}return i.level>=Ci&&(i.xp=0,i.xpToNext=0),s}getPassiveBonus(e,t){const i=this._masteries.get(e),s=Pi[e];return!i||!s?0:(s.passivePerLevel[t]??0)*i.level}getTotalDamageMultiplier(e){const t=this._masteries.get(e),i=Pi[e];if(!t||!i)return 1;let s=1+(i.passivePerLevel.damage??0)*t.level;const a=i.skills[Ci];return t.level>=Ci&&a?.effect.damageBonus&&(s+=a.effect.damageBonus),s}useSkill(e,t){const i=this._masteries.get(e);if(!i||!i.unlockedSkills.includes(t))return{success:!1};if((this._cooldowns.get(t)??0)>0)return{success:!1};const a=Pi[e];let r;for(const n of Object.values(a.skills))if(n.id===t&&n.type==="active"){r=n;break}return r?(r.cooldown&&this._cooldowns.set(t,r.cooldown),{success:!0,skill:r,staminaCost:r.staminaCost}):{success:!1}}update(e){for(const[t,i]of this._cooldowns){const s=i-e;s<=0?this._cooldowns.delete(t):this._cooldowns.set(t,s)}}_getXPForLevel(e){return e<=1?0:Math.floor(Dy*Math.pow(Fy,e-2))}serialize(){const e={};for(const[t,i]of this._masteries)e[t]={level:i.level,xp:i.xp,xpToNext:i.xpToNext,unlockedSkills:[...i.unlockedSkills]};return{masteries:e}}deserialize(e){for(const[t,i]of Object.entries(e.masteries))this._masteries.set(t,{level:i.level,xp:i.xp,xpToNext:i.xpToNext,unlockedSkills:[...i.unlockedSkills]})}}const qt={combat:{id:"combat",name:"Combat",icon:"",category:"combat",description:"Deal more damage and take less.",maxLevel:10,xpPerLevel:[100,250,500,1e3,2e3,3500,5500,8e3,12e3,2e4],perks:{2:{id:"fighter",name:"Fighter",description:"+10% attack damage",modifier:{stat:"attack",type:"multiplicative",value:.1}},4:{id:"defender",name:"Defender",description:"-15% damage taken",modifier:{stat:"defense",type:"multiplicative",value:.15}},6:{id:"critical_strike",name:"Critical Strike",description:"+10% crit chance",modifier:{stat:"crit_chance",type:"additive",value:.1}},8:{id:"vampiric",name:"Vampiric",description:"5% life steal",modifier:{stat:"lifesteal",type:"additive",value:.05}},10:{id:"warlord",name:"Warlord",description:"All combat bonuses doubled",modifier:{stat:"combat_all",type:"multiplicative",value:1}}}},tactics:{id:"tactics",name:"Tactics",icon:"",category:"combat",description:"Improve combat awareness and strategy.",maxLevel:10,xpPerLevel:[100,250,500,1e3,2e3,3500,5500,8e3,12e3,2e4],perks:{2:{id:"awareness",name:"Awareness",description:"See enemy HP bars",modifier:{stat:"enemy_info",type:"additive",value:1}},4:{id:"evasion",name:"Evasion",description:"+5% dodge chance",modifier:{stat:"dodge",type:"additive",value:.05}},6:{id:"counter_attack",name:"Counter Attack",description:"10% chance to counter",modifier:{stat:"counter",type:"additive",value:.1}},8:{id:"battle_hardened",name:"Battle Hardened",description:"+15% max HP",modifier:{stat:"max_hp",type:"multiplicative",value:.15}},10:{id:"strategist",name:"Strategist",description:"+20% XP from kills",modifier:{stat:"kill_xp",type:"multiplicative",value:.2}}}},mining:{id:"mining",name:"Mining",icon:"",category:"gathering",description:"Mine ore and break rocks faster.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:{2:{id:"prospector",name:"Prospector",description:"+20% ore find chance",modifier:{stat:"ore_chance",type:"multiplicative",value:.2}},4:{id:"efficient_mining",name:"Efficient Mining",description:"-25% mining stamina",modifier:{stat:"mine_stamina",type:"multiplicative",value:-.25}},6:{id:"gem_finder",name:"Gem Finder",description:"+30% gem find chance",modifier:{stat:"gem_chance",type:"multiplicative",value:.3}},8:{id:"excavator",name:"Excavator",description:"Break rocks in fewer hits",modifier:{stat:"mine_speed",type:"multiplicative",value:.25}},10:{id:"master_miner",name:"Master Miner",description:"Chance to find rare ores",modifier:{stat:"rare_ore",type:"additive",value:.1}}}},foraging:{id:"foraging",name:"Foraging",icon:"",category:"gathering",description:"Find more items while foraging.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:{2:{id:"gatherer",name:"Gatherer",description:"+25% forage amount",modifier:{stat:"forage_amount",type:"multiplicative",value:.25}},4:{id:"botanist",name:"Botanist",description:"All foraged items best quality",modifier:{stat:"forage_quality",type:"additive",value:1}},6:{id:"tracker",name:"Tracker",description:"Foragables highlighted on minimap",modifier:{stat:"forage_highlight",type:"additive",value:1}},8:{id:"lumberjack",name:"Lumberjack",description:"+50% wood from trees",modifier:{stat:"wood_amount",type:"multiplicative",value:.5}},10:{id:"nature_friend",name:"Nature Friend",description:"Animals are friendly",modifier:{stat:"animal_friendly",type:"additive",value:1}}}},fishing:{id:"fishing",name:"Fishing",icon:"",category:"gathering",description:"Catch fish more easily and find treasures.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:{2:{id:"fisher",name:"Fisher",description:"Fish bite faster",modifier:{stat:"fish_speed",type:"multiplicative",value:.3}},4:{id:"treasure_hunter",name:"Treasure Hunter",description:"+20% treasure chance",modifier:{stat:"treasure_chance",type:"multiplicative",value:.2}},6:{id:"angler",name:"Angler",description:"Fish sell for 25% more",modifier:{stat:"fish_value",type:"multiplicative",value:.25}},8:{id:"master_bait",name:"Master Bait",description:"Double bait effectiveness",modifier:{stat:"bait_effect",type:"multiplicative",value:1}},10:{id:"legendary_fisher",name:"Legendary Fisher",description:"Can catch legendary fish",modifier:{stat:"legendary_fish",type:"additive",value:1}}}},cooking:{id:"cooking",name:"Cooking",icon:"",category:"crafting",description:"Cook better dishes with more effects.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:{2:{id:"chef",name:"Chef",description:"+20% food healing",modifier:{stat:"food_healing",type:"multiplicative",value:.2}},4:{id:"seasoned",name:"Seasoned",description:"Food buffs last 25% longer",modifier:{stat:"buff_duration",type:"multiplicative",value:.25}},6:{id:"gourmet",name:"Gourmet",description:"Cooked food sells for more",modifier:{stat:"food_value",type:"multiplicative",value:.3}},8:{id:"efficiency",name:"Efficiency",description:"15% chance to save ingredients",modifier:{stat:"cook_save",type:"additive",value:.15}},10:{id:"master_chef",name:"Master Chef",description:"Unlock special recipes",modifier:{stat:"special_recipes",type:"additive",value:1}}}},smithing:{id:"smithing",name:"Smithing",icon:"",category:"crafting",description:"Forge better weapons and armor.",maxLevel:10,xpPerLevel:[75,175,375,750,1500,2500,4e3,6e3,9e3,15e3],perks:{2:{id:"apprentice_smith",name:"Apprentice Smith",description:"+10% crafting speed",modifier:{stat:"craft_speed",type:"multiplicative",value:.1}},4:{id:"quality_craft",name:"Quality Craft",description:"+15% crafted item stats",modifier:{stat:"craft_quality",type:"multiplicative",value:.15}},6:{id:"material_expert",name:"Material Expert",description:"10% chance to save materials",modifier:{stat:"material_save",type:"additive",value:.1}},8:{id:"masterwork",name:"Masterwork",description:"Chance to craft rare quality",modifier:{stat:"rare_craft",type:"additive",value:.1}},10:{id:"legendary_smith",name:"Legendary Smith",description:"Craft legendary items",modifier:{stat:"legendary_craft",type:"additive",value:1}}}},alchemy:{id:"alchemy",name:"Alchemy",icon:"",category:"crafting",description:"Brew potent potions and elixirs.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:{2:{id:"herbalist",name:"Herbalist",description:"+25% potion effectiveness",modifier:{stat:"potion_effect",type:"multiplicative",value:.25}},4:{id:"distiller",name:"Distiller",description:"Potions last 30% longer",modifier:{stat:"potion_duration",type:"multiplicative",value:.3}},6:{id:"experimenter",name:"Experimenter",description:"Discover recipes from combining",modifier:{stat:"recipe_discovery",type:"additive",value:1}},8:{id:"double_brew",name:"Double Brew",description:"20% chance to produce 2x",modifier:{stat:"double_potion",type:"additive",value:.2}},10:{id:"master_alchemist",name:"Master Alchemist",description:"Brew mythic elixirs",modifier:{stat:"mythic_brew",type:"additive",value:1}}}},survival:{id:"survival",name:"Survival",icon:"",category:"survival",description:"Endure harsh conditions and gather resources.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:{2:{id:"scavenger",name:"Scavenger",description:"+10% resource quality",modifier:{stat:"resource_quality",type:"multiplicative",value:.1}},4:{id:"efficient_forager",name:"Efficient Forager",description:"-25% gathering stamina",modifier:{stat:"gather_stamina",type:"multiplicative",value:-.25}},6:{id:"weather_resistant",name:"Weather Resistant",description:"-20% temperature effects",modifier:{stat:"temp_resist",type:"multiplicative",value:.2}},8:{id:"double_yield",name:"Double Yield",description:"15% double yield chance",modifier:{stat:"double_yield",type:"additive",value:.15}},10:{id:"master_survivor",name:"Master Survivor",description:"All survival bonuses doubled",modifier:{stat:"survival_all",type:"multiplicative",value:1}}}},endurance:{id:"endurance",name:"Endurance",icon:"",category:"survival",description:"Increase stamina and reduce hunger drain.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:{2:{id:"fit",name:"Fit",description:"+10% max stamina",modifier:{stat:"max_stamina",type:"multiplicative",value:.1}},4:{id:"slow_metabolism",name:"Slow Metabolism",description:"-20% hunger drain",modifier:{stat:"hunger_drain",type:"multiplicative",value:-.2}},6:{id:"sprint_master",name:"Sprint Master",description:"-30% sprint stamina cost",modifier:{stat:"sprint_cost",type:"multiplicative",value:-.3}},8:{id:"iron_gut",name:"Iron Gut",description:"+25% food effectiveness",modifier:{stat:"food_effect",type:"multiplicative",value:.25}},10:{id:"indomitable",name:"Indomitable",description:"Stamina regens while sprinting",modifier:{stat:"sprint_regen",type:"additive",value:1}}}},charisma:{id:"charisma",name:"Charisma",icon:"",category:"social",description:"Build relationships and get better deals.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:{2:{id:"smooth_talker",name:"Smooth Talker",description:"-10% shop prices",modifier:{stat:"shop_discount",type:"multiplicative",value:.1}},4:{id:"gift_giver",name:"Gift Giver",description:"+25% gift effectiveness",modifier:{stat:"gift_effect",type:"multiplicative",value:.25}},6:{id:"negotiator",name:"Negotiator",description:"+20% sell prices",modifier:{stat:"sell_bonus",type:"multiplicative",value:.2}},8:{id:"inspiring",name:"Inspiring",description:"Colony NPCs work 15% faster",modifier:{stat:"npc_speed",type:"multiplicative",value:.15}},10:{id:"beloved",name:"Beloved",description:"Max friendship with all NPCs faster",modifier:{stat:"friendship_rate",type:"multiplicative",value:.5}}}},leadership:{id:"leadership",name:"Leadership",icon:"",category:"social",description:"Inspire your colony and followers.",maxLevel:10,xpPerLevel:[75,175,375,750,1500,2500,4e3,6e3,9e3,15e3],perks:{2:{id:"rally",name:"Rally",description:"+10% colony output",modifier:{stat:"colony_output",type:"multiplicative",value:.1}},4:{id:"commander",name:"Commander",description:"Colony defense +20%",modifier:{stat:"colony_defense",type:"multiplicative",value:.2}},6:{id:"recruiter",name:"Recruiter",description:"Attract more NPCs to colony",modifier:{stat:"npc_attract",type:"additive",value:2}},8:{id:"governor",name:"Governor",description:"Colony buildings cost 15% less",modifier:{stat:"build_discount",type:"multiplicative",value:.15}},10:{id:"high_king",name:"High King",description:"All colony bonuses doubled",modifier:{stat:"colony_all",type:"multiplicative",value:1}}}}};class Ly{_skills=new Map;_unlockedPerks=new Set;constructor(){for(const e of Object.keys(qt))this._skills.set(e,{level:0,xp:0})}getLevel(e){return this._skills.get(e)?.level??0}getProgress(e){const t=this._skills.get(e),i=qt[e];if(!t||!i)return 0;if(t.level>=i.maxLevel)return 1;const s=i.xpPerLevel[t.level];return s>0?t.xp/s:1}hasPerk(e){return this._unlockedPerks.has(e)}getUnlockedPerks(e){const t=qt[e],i=this._skills.get(e);if(!t||!i)return[];const s=[];for(let a=1;a<=i.level;a++)t.perks[a]&&s.push(t.perks[a]);return s}getSkillsByCategory(e){return Object.values(qt).filter(t=>t.category===e)}addXP(e,t){const i=this._skills.get(e),s=qt[e];if(!i||!s)return[];if(i.level>=s.maxLevel)return[];const a=[];for(i.xp+=t;i.level<s.maxLevel;){const r=s.xpPerLevel[i.level];if(i.xp<r)break;i.xp-=r,i.level++;const n={skillId:e,skillName:s.name,newLevel:i.level},l=s.perks[i.level];l&&(this._unlockedPerks.add(l.id),n.unlockedPerk=l),a.push(n)}return a}getModifier(e){let t=0,i=1;for(const s of Object.values(qt))for(const a of Object.values(s.perks))this._unlockedPerks.has(a.id)&&a.modifier.stat===e&&(a.modifier.type==="additive"?t+=a.modifier.value:i*=1+a.modifier.value);return(1+t)*i}getAdditiveModifier(e){let t=0;for(const i of Object.values(qt))for(const s of Object.values(i.perks))this._unlockedPerks.has(s.id)&&s.modifier.stat===e&&(t+=s.modifier.value);return t}update(e){}serialize(){const e={};for(const[t,i]of this._skills)e[t]={level:i.level,xp:i.xp};return{skills:e,unlockedPerks:[...this._unlockedPerks]}}deserialize(e){for(const[t,i]of Object.entries(e.skills))this._skills.set(t,{level:i.level,xp:i.xp});this._unlockedPerks=new Set(e.unlockedPerks);for(const t of Object.keys(qt))this._skills.has(t)||this._skills.set(t,{level:0,xp:0})}}const th={shadow_ore:{id:"shadow_ore",name:"Shadow Ore",icon:"",description:"Dark metal that phases between dimensions. Used in high-tier crafting.",rarity:"uncommon",minCorruption:.2,biomes:["rotwood","ashlands","bone_wastes"],gatherTime:4,value:45},void_essence:{id:"void_essence",name:"Void Essence",icon:"",description:"Concentrated void energy. Unstable but powerful.",rarity:"rare",minCorruption:.4,biomes:["the_void","bone_wastes","drowned_depths"],gatherTime:6,value:120},corrupted_crystal:{id:"corrupted_crystal",name:"Corrupted Crystal",icon:"",description:"A crystal warped by shadow corruption. Pulses with dark energy.",rarity:"rare",minCorruption:.5,biomes:["ashlands","the_void"],gatherTime:8,value:180},twilight_shard:{id:"twilight_shard",name:"Twilight Shard",icon:"",description:"Fragment of the boundary between dimensions.",rarity:"epic",minCorruption:.6,biomes:["drowned_depths","bone_wastes","the_void"],gatherTime:10,value:350},dimensional_tear:{id:"dimensional_tear",name:"Dimensional Tear",icon:"",description:"A solidified rip in reality. Extremely rare and valuable.",rarity:"legendary",minCorruption:.8,biomes:["the_void"],gatherTime:15,value:800},shadow_silk:{id:"shadow_silk",name:"Shadow Silk",icon:"",description:"Woven from threads of shadow. Light as air, strong as steel.",rarity:"epic",minCorruption:.5,biomes:["rotwood","drowned_depths"],gatherTime:7,value:250}},ai={healthMultiplier:1.6,damageMultiplier:1.5,defenseMultiplier:1.3,speedMultiplier:1.2,xpMultiplier:2,lootRarityBoost:.15,visibilityReduction:.4},Fr={terrain_warp:{id:"terrain_warp",name:"Terrain Warp",description:"The ground shifts and buckles, creating impassable terrain.",radius:5,duration:120,minCorruption:.3,effects:{speedMod:.6}},time_dilation:{id:"time_dilation",name:"Time Dilation Zone",description:"Time flows differently here. Everything feels sluggish.",radius:8,duration:90,minCorruption:.4,effects:{speedMod:.5,timeMod:.5}},gravity_shift:{id:"gravity_shift",name:"Gravity Shift",description:"Gravity weakens, making movement unpredictable.",radius:6,duration:60,minCorruption:.5,effects:{gravityMod:.3,speedMod:1.3}},void_rift:{id:"void_rift",name:"Void Rift",description:"A tear in reality that pulls everything toward it.",radius:4,duration:45,minCorruption:.7,effects:{damageMod:1.5,visionMod:.3}},echo_zone:{id:"echo_zone",name:"Echo Zone",description:"Echoes of past events replay here. Enemies respawn faster.",radius:10,duration:0,minCorruption:.6,effects:{timeMod:2}}},$r={twilight_warden:{id:"twilight_warden",name:"Twilight Warden",icon:"",description:"A guardian that exists in both worlds simultaneously. Must be damaged in both layers.",biome:"rotwood",health:2500,damage:60,defense:35,speed:45,phaseInterval:15,wrongLayerDamageReduction:.9,minChunkCorruption:.5,drops:[{id:"twilight_shard",count:3,chance:1},{id:"shadow_silk",count:2,chance:.6},{id:"dimensional_tear",count:1,chance:.15}],abilities:["shadow_slam","phase_shift","void_beam"]},rift_stalker:{id:"rift_stalker",name:"Rift Stalker",icon:"",description:"Hunts prey across dimensions. Teleports between shadow and normal to ambush.",biome:"bone_wastes",health:3200,damage:75,defense:25,speed:70,phaseInterval:8,wrongLayerDamageReduction:.95,minChunkCorruption:.6,drops:[{id:"void_essence",count:4,chance:1},{id:"corrupted_crystal",count:2,chance:.5},{id:"dimensional_tear",count:1,chance:.2}],abilities:["dimension_slash","blink_strike","shadow_clones"]},void_sovereign:{id:"void_sovereign",name:"Void Sovereign",icon:"",description:"The master of the space between worlds. Commands reality distortions.",biome:"the_void",health:5e3,damage:90,defense:45,speed:40,phaseInterval:20,wrongLayerDamageReduction:.85,minChunkCorruption:.8,drops:[{id:"dimensional_tear",count:2,chance:1},{id:"void_essence",count:5,chance:1},{id:"corrupted_crystal",count:3,chance:.7}],abilities:["reality_shatter","void_nova","dimension_lock","summon_echoes"]},abyssal_mirror:{id:"abyssal_mirror",name:"Abyssal Mirror",icon:"",description:"A reflection of the player made manifest. Copies abilities and grows stronger.",biome:"drowned_depths",health:2800,damage:65,defense:30,speed:55,phaseInterval:12,wrongLayerDamageReduction:.88,minChunkCorruption:.55,drops:[{id:"twilight_shard",count:2,chance:1},{id:"shadow_ore",count:5,chance:.8},{id:"shadow_silk",count:2,chance:.4}],abilities:["mirror_strike","reflection_shield","copy_ability"]}},tt=16,By=10,Wy=25,Ny=1.5,Oy=120,Gy=2e-4;class Hy{_phaseState={currentLayer:"normal",cooldownRemaining:0,staminaCost:Wy,isTransitioning:!1,transitionProgress:0};_chunkStates=new Map;_activeDistortions=[];_crossBosses=new Map;_distortionTimer=0;_resourceTimer=0;_elapsedTime=0;_totalShadowExplored=0;_shadowResourcesGathered=0;constructor(){}get currentLayer(){return this._phaseState.currentLayer}get isInShadow(){return this._phaseState.currentLayer==="shadow"}get isTransitioning(){return this._phaseState.isTransitioning}get transitionProgress(){return this._phaseState.transitionProgress}get phaseCooldown(){return this._phaseState.cooldownRemaining}get canPhaseShift(){return this._phaseState.cooldownRemaining<=0&&!this._phaseState.isTransitioning}get totalShadowExplored(){return this._totalShadowExplored}_chunkKey(e,t){return`${e},${t}`}_getChunkState(e,t){const i=this._chunkKey(e,t);let s=this._chunkStates.get(i);return s||(s={discovered:!1,corruptionLevel:.1+Math.random()*.3,activeDistortions:[],hiddenPathsRevealed:!1},this._chunkStates.set(i,s)),s}getChunkCorruption(e,t){const i=Math.floor(e/tt),s=Math.floor(t/tt);return this._getChunkState(i,s).corruptionLevel}isChunkDiscovered(e,t){const i=Math.floor(e/tt),s=Math.floor(t/tt);return this._chunkStates.get(this._chunkKey(i,s))?.discovered??!1}startPhaseShift(e){return!this.canPhaseShift||e<this._phaseState.staminaCost?!1:(this._phaseState.isTransitioning=!0,this._phaseState.transitionProgress=0,!0)}getPhaseStaminaCost(){return this._phaseState.staminaCost}_completePhaseShift(e,t){const i=this._phaseState.currentLayer==="normal"?"shadow":"normal";if(this._phaseState.currentLayer=i,this._phaseState.cooldownRemaining=By,this._phaseState.isTransitioning=!1,this._phaseState.transitionProgress=0,i==="shadow"){const s=Math.floor(e/(tt*32)),a=Math.floor(t/(tt*32)),r=this._getChunkState(s,a);r.discovered||(r.discovered=!0,this._totalShadowExplored++)}}getShadowEnemyModifiers(e,t){if(!this.isInShadow)return{healthMultiplier:1,damageMultiplier:1,defenseMultiplier:1,speedMultiplier:1,xpMultiplier:1,lootRarityBoost:0,visibilityReduction:0};const i=this.getChunkCorruption(e,t),s=1+i*.5;return{healthMultiplier:ai.healthMultiplier*s,damageMultiplier:ai.damageMultiplier*s,defenseMultiplier:ai.defenseMultiplier*s,speedMultiplier:ai.speedMultiplier,xpMultiplier:ai.xpMultiplier*s,lootRarityBoost:ai.lootRarityBoost+i*.1,visibilityReduction:ai.visibilityReduction+i*.2}}getAvailableResources(e,t,i){if(!this.isInShadow)return[];const s=this.getChunkCorruption(e,t),a=[];for(const r of Object.values(th))s>=r.minCorruption&&r.biomes.includes(i)&&a.push(r);return a}gatherResource(e){return e in th?(this._shadowResourcesGathered++,!0):!1}getDistortionsAt(e,t){const i=[];for(const s of this._activeDistortions){const a=e-s.centerX,r=t-s.centerY,n=Fr[s.type];a*a+r*r<=n.radius*n.radius&&i.push(s)}return i}getDistortionEffects(e,t){const i={speedMod:1,damageMod:1,gravityMod:1,timeMod:1,visionMod:1};if(!this.isInShadow)return i;const s=this.getDistortionsAt(e,t);for(const a of s){const r=Fr[a.type];r.effects.speedMod!==void 0&&(i.speedMod*=r.effects.speedMod),r.effects.damageMod!==void 0&&(i.damageMod*=r.effects.damageMod),r.effects.gravityMod!==void 0&&(i.gravityMod*=r.effects.gravityMod),r.effects.timeMod!==void 0&&(i.timeMod*=r.effects.timeMod),r.effects.visionMod!==void 0&&(i.visionMod*=r.effects.visionMod)}return i}_spawnDistortion(e,t){if(!this.isInShadow)return;const i=Math.floor(e/(tt*32)),s=Math.floor(t/(tt*32)),a=this._getChunkState(i,s),r=Object.values(Fr).filter(u=>a.corruptionLevel>=u.minCorruption);if(r.length===0)return;const n=r[Math.floor(Math.random()*r.length)],l=(Math.random()-.5)*tt*32,h=(Math.random()-.5)*tt*32,c=this._chunkKey(i,s),d={type:n.id,chunkKey:c,centerX:Math.floor((e+l)/32),centerY:Math.floor((t+h)/32),remainingDuration:n.duration>0?n.duration:-1,spawnTime:this._elapsedTime};this._activeDistortions.push(d),a.activeDistortions.push(n.id)}getActiveBosses(){return[...this._crossBosses.values()].filter(e=>e.active)}spawnCrossBoss(e,t,i){const s=$r[e];return!s||this._crossBosses.has(e)||this.getChunkCorruption(Math.floor(t/32),Math.floor(i/32))<s.minChunkCorruption?!1:(this._crossBosses.set(e,{id:e,currentLayer:this._phaseState.currentLayer,phaseTimer:s.phaseInterval,healthRemaining:s.health,normalDamageDealt:0,shadowDamageDealt:0,active:!0}),!0)}damageCrossBoss(e,t){const i=this._crossBosses.get(e);if(!i||!i.active)return 0;const s=$r[e];if(!s)return 0;const a=i.currentLayer===this._phaseState.currentLayer,r=a?t:t*(1-s.wrongLayerDamageReduction);return i.healthRemaining=Math.max(0,i.healthRemaining-r),a&&(this._phaseState.currentLayer==="normal"?i.normalDamageDealt+=r:i.shadowDamageDealt+=r),i.healthRemaining<=0&&(i.active=!1),r}_updateCrossBosses(e){for(const t of this._crossBosses.values()){if(!t.active)continue;const i=$r[t.id];i&&(t.phaseTimer-=e,t.phaseTimer<=0&&(t.currentLayer=t.currentLayer==="normal"?"shadow":"normal",t.phaseTimer=i.phaseInterval))}}revealHiddenPaths(e,t){if(!this.isInShadow)return!1;const i=Math.floor(e/tt),s=Math.floor(t/tt),a=this._getChunkState(i,s);return a.hiddenPathsRevealed?!1:(a.hiddenPathsRevealed=!0,!0)}arePathsRevealed(e,t){const i=Math.floor(e/tt),s=Math.floor(t/tt);return this._chunkStates.get(this._chunkKey(i,s))?.hiddenPathsRevealed??!1}update(e,t,i,s){if(this._elapsedTime+=e,this._phaseState.isTransitioning&&(this._phaseState.transitionProgress+=e/Ny,this._phaseState.transitionProgress>=1&&this._completePhaseShift(i,s)),this._phaseState.cooldownRemaining>0&&(this._phaseState.cooldownRemaining=Math.max(0,this._phaseState.cooldownRemaining-e)),this.isInShadow){const a=Math.floor(i/(tt*32)),r=Math.floor(s/(tt*32)),n=this._getChunkState(a,r);n.corruptionLevel=Math.min(1,n.corruptionLevel+Gy*e)}this._distortionTimer+=e,this._distortionTimer>=Oy&&(this._distortionTimer=0,this.isInShadow&&Math.random()<.4&&this._spawnDistortion(i,s));for(let a=this._activeDistortions.length-1;a>=0;a--){const r=this._activeDistortions[a];if(r.remainingDuration>0&&(r.remainingDuration-=e,r.remainingDuration<=0)){const n=this._chunkStates.get(r.chunkKey);if(n){const l=n.activeDistortions.indexOf(r.type);l>=0&&n.activeDistortions.splice(l,1)}this._activeDistortions.splice(a,1)}}this._updateCrossBosses(e)}serialize(){return{currentLayer:this._phaseState.currentLayer,cooldownRemaining:this._phaseState.cooldownRemaining,chunkStates:[...this._chunkStates.entries()],distortions:this._activeDistortions,crossBosses:[...this._crossBosses.entries()],elapsedTime:this._elapsedTime,totalShadowExplored:this._totalShadowExplored,shadowResourcesGathered:this._shadowResourcesGathered}}deserialize(e){this._phaseState.currentLayer=e.currentLayer,this._phaseState.cooldownRemaining=e.cooldownRemaining,this._phaseState.isTransitioning=!1,this._phaseState.transitionProgress=0,this._chunkStates.clear();for(const[t,i]of e.chunkStates)this._chunkStates.set(t,i);this._activeDistortions=e.distortions??[],this._crossBosses.clear();for(const[t,i]of e.crossBosses??[])this._crossBosses.set(t,i);this._elapsedTime=e.elapsedTime??0,this._totalShadowExplored=e.totalShadowExplored??0,this._shadowResourcesGathered=e.shadowResourcesGathered??0}}const mt={fungal:{id:"fungal",name:"Fungal Horde",biome:"rotwood",description:"A vast mycelial network that infects and assimilates all living things.",color:"#44aa44",icon:"",enemyTypes:["possessed","goblin_slinger","mushroom_spirit"],eliteEnemyTypes:["spore_brute","mycelium_knight"],raidComposition:{minEnemies:4,maxEnemies:10,commanderChance:.2,waveCount:2},territoryRetakeRate:.003,aggressionBase:120},cultist:{id:"cultist",name:"Fire Cult",biome:"ashlands",description:"Fanatical pyromancers who worship the Ember Titan and seek to burn the world.",color:"#ff6600",icon:"",enemyTypes:["cultist","skeleton_grunt","red_slime"],eliteEnemyTypes:["flame_zealot","pyro_priest"],raidComposition:{minEnemies:5,maxEnemies:12,commanderChance:.25,waveCount:3},territoryRetakeRate:.004,aggressionBase:100},undead:{id:"undead",name:"Drowned Legion",biome:"drowned_depths",description:"Waterlogged corpses and sea spirits that drag the living into the abyss.",color:"#4488bb",icon:"",enemyTypes:["skeleton_grunt","skeleton_hunter"],eliteEnemyTypes:["tide_revenant","abyssal_siren"],raidComposition:{minEnemies:6,maxEnemies:15,commanderChance:.15,waveCount:3},territoryRetakeRate:.002,aggressionBase:150},necro:{id:"necro",name:"Bone Empire",biome:"bone_wastes",description:"An undead empire ruled by powerful necromancers who raise endless armies.",color:"#aa88cc",icon:"",enemyTypes:["skeleton_grunt","skeleton_hunter","cultist"],eliteEnemyTypes:["bone_golem","necro_lord"],raidComposition:{minEnemies:8,maxEnemies:20,commanderChance:.3,waveCount:4},territoryRetakeRate:.005,aggressionBase:90},void:{id:"void",name:"Void Weavers",biome:"the_void",description:"Entities from beyond reality that unravel the fabric of existence.",color:"#8800ff",icon:"",enemyTypes:["cultist","possessed","shadow_wisp"],eliteEnemyTypes:["void_stalker","reality_shredder"],raidComposition:{minEnemies:3,maxEnemies:8,commanderChance:.4,waveCount:2},territoryRetakeRate:.006,aggressionBase:180}},po={sporelord_prime:{id:"sporelord_prime",name:"Sporelord Prime",icon:"",faction:"fungal",health:1800,damage:50,defense:30,speed:35,strengthThreshold:40,abilities:["spore_cloud","root_grasp","fungal_shield"],drops:[{id:"corruption_essence",count:3,chance:1},{id:"shadow_essence",count:2,chance:.5},{id:"purification_crystal",count:1,chance:.2}],description:"The eldest mycelium node. Commands spore swarms and roots that trap."},ember_archon:{id:"ember_archon",name:"Ember Archon",icon:"",faction:"cultist",health:2e3,damage:65,defense:20,speed:45,strengthThreshold:45,abilities:["flame_wave","meteor_strike","fire_aura"],drops:[{id:"corruption_essence",count:3,chance:1},{id:"void_shard",count:2,chance:.4},{id:"purification_crystal",count:1,chance:.25}],description:"High priest of the Fire Cult. Channels the Ember Titan's fury."},tide_warden:{id:"tide_warden",name:"Tide Warden",icon:"",faction:"undead",health:2200,damage:45,defense:40,speed:30,strengthThreshold:50,abilities:["tidal_crush","drown","summon_drowned"],drops:[{id:"corruption_essence",count:4,chance:1},{id:"shadow_essence",count:2,chance:.5},{id:"void_gem",count:1,chance:.15}],description:"Guardian of the deep trenches. Drowns foes in spectral water."},bone_emperor:{id:"bone_emperor",name:"Bone Emperor",icon:"",faction:"necro",health:2500,damage:55,defense:45,speed:25,strengthThreshold:55,abilities:["raise_army","bone_storm","death_grip","necrotic_aura"],drops:[{id:"corruption_essence",count:5,chance:1},{id:"void_shard",count:3,chance:.5},{id:"purification_crystal",count:1,chance:.3}],description:"Rules the Bone Wastes with iron authority. Raises the dead en masse."},void_herald:{id:"void_herald",name:"Void Herald",icon:"",faction:"void",health:3e3,damage:70,defense:25,speed:55,strengthThreshold:60,abilities:["reality_tear","void_blast","phase_walk","unravel"],drops:[{id:"void_shard",count:4,chance:1},{id:"void_gem",count:2,chance:.5},{id:"purification_crystal",count:2,chance:.3}],description:"An emissary from beyond the void. Bends reality to its will."}},ih=[{id:"awakening",name:"Awakening",strengthThreshold:25,description:"The faction stirs. Enemies hit harder.",effects:{damageMultiplier:1.15}},{id:"fortification",name:"Fortification",strengthThreshold:50,description:"Faction defenses harden. Enemies become tougher.",effects:{healthBonus:50,defenseMultiplier:1.25}},{id:"frenzy",name:"Frenzy",strengthThreshold:75,description:"The faction enters a frenzy. More enemies, faster attacks.",effects:{speedMultiplier:1.3,spawnRateMultiplier:1.5,newAbility:"berserk"}},{id:"apex",name:"Apex Mutation",strengthThreshold:100,description:"Maximum mutation. The faction is at its most dangerous.",effects:{healthBonus:150,damageMultiplier:1.5,defenseMultiplier:1.4,speedMultiplier:1.2,spawnRateMultiplier:2,newAbility:"apex_strike"}}],zy=.01,sh=3,ah=180,Xy=10,Vy=.5,qy=300,Yy=120;class Uy{_factions=new Map;_activeRaids=[];_activeWars=[];_elapsedTime=0;_warTimer=0;_isPostgame=!1;_ngPlusCycle=0;_raidIdCounter=0;_warIdCounter=0;constructor(){const e=["fungal","cultist","undead","necro","void"];for(const t of e)this._factions.set(t,{id:t,strength:20,commandersAlive:0,commandersDefeated:0,activeMutations:[],raidCooldown:ah+Math.random()*60,territoryTilesClaimed:0,territoryTilesLost:0})}getFaction(e){return this._factions.get(e)}getFactionStrength(e){return this._factions.get(e)?.strength??0}getAllFactions(){return[...this._factions.values()]}getActiveRaids(){return this._activeRaids.filter(e=>e.active)}getActiveWars(){return this._activeWars.filter(e=>e.active)}get isPostgame(){return this._isPostgame}get ngPlusCycle(){return this._ngPlusCycle}getActiveMutations(e){const t=this._factions.get(e);return t?ih.filter(i=>t.strength>=i.strengthThreshold):[]}getMutationModifiers(e){const t={healthBonus:0,damageMultiplier:1,defenseMultiplier:1,speedMultiplier:1,spawnRateMultiplier:1,extraAbilities:[]},i=this.getActiveMutations(e);for(const s of i)s.effects.healthBonus&&(t.healthBonus+=s.effects.healthBonus),s.effects.damageMultiplier&&(t.damageMultiplier*=s.effects.damageMultiplier),s.effects.defenseMultiplier&&(t.defenseMultiplier*=s.effects.defenseMultiplier),s.effects.speedMultiplier&&(t.speedMultiplier*=s.effects.speedMultiplier),s.effects.spawnRateMultiplier&&(t.spawnRateMultiplier*=s.effects.spawnRateMultiplier),s.effects.newAbility&&t.extraAbilities.push(s.effects.newAbility);return t}onTilesPurified(e,t){const i=this._factions.get(e);i&&(i.strength=Math.max(0,i.strength-t*Vy),i.territoryTilesLost+=t,this._updateMutations(e))}onCommanderDefeated(e){const t=this._factions.get(e);t&&(t.commandersAlive=Math.max(0,t.commandersAlive-1),t.commandersDefeated++,t.strength=Math.max(0,t.strength-Xy),this._updateMutations(e))}enablePostgame(e){this._isPostgame=!0,this._ngPlusCycle=e;for(const t of this._factions.values())t.strength=Math.min(100,t.strength+10*e)}_updateMutations(e){const t=this._factions.get(e);t&&(t.activeMutations=ih.filter(i=>t.strength>=i.strengthThreshold).map(i=>i.id))}spawnRaid(e,t,i){const s=this._factions.get(e);if(!s||s.raidCooldown>0)return null;const a=mt[e],r=this.getMutationModifiers(e),n=s.strength/100,l=[],h=a.raidComposition.waveCount+(this._isPostgame?1:0);for(let d=0;d<h;d++){const u=d===h-1,f=a.raidComposition.minEnemies+Math.floor((a.raidComposition.maxEnemies-a.raidComposition.minEnemies)*n),m=Math.ceil(f*r.spawnRateMultiplier*(1+d*.2)),_=s.strength>=50?[...a.enemyTypes,...a.eliteEnemyTypes]:[...a.enemyTypes],p=u&&Math.random()<a.raidComposition.commanderChance+n*.2,g=Object.values(po).filter(S=>S.faction===e&&s.strength>=S.strengthThreshold),y=g.length>0?g[Math.floor(Math.random()*g.length)]:void 0;l.push({enemyTypes:_,enemyCount:m,delayAfterPrevious:d===0?0:15+d*5,hasCommander:p,commanderId:p?y?.id:void 0})}const c={id:`raid_${this._raidIdCounter++}`,factionId:e,biomeId:a.biome,targetX:t,targetY:i,waves:l,currentWave:0,waveTimer:0,startTime:this._elapsedTime,active:!0,difficulty:n};return this._activeRaids.push(c),s.raidCooldown=ah*(this._isPostgame?.5:1),c}_updateRaids(e){for(const t of this._activeRaids){if(!t.active)continue;if(t.waveTimer+=e,!t.waves[t.currentWave]){t.active=!1;continue}if(t.currentWave<t.waves.length-1){const s=t.waves[t.currentWave+1];s&&t.waveTimer>=s.delayAfterPrevious&&(t.currentWave++,t.waveTimer=0)}this._elapsedTime-t.startTime>300&&(t.active=!1)}if(this._activeRaids.length>40){const t=this._activeRaids.filter(i=>!i.active);t.length>20&&(this._activeRaids=[...this._activeRaids.filter(i=>i.active),...t.slice(-20)])}}checkCommanderSpawn(e){const t=this._factions.get(e);if(!t)return null;const i=this._isPostgame?3:1;if(t.commandersAlive>=i)return null;const s=Object.values(po).filter(r=>r.faction===e&&t.strength>=r.strengthThreshold);if(s.length===0)return null;const a=s[Math.floor(Math.random()*s.length)];return t.commandersAlive++,a}getTerritoryRetakeRate(e){const t=mt[e],i=this._factions.get(e);if(!i)return 0;const s=i.strength/100,a=this._isPostgame?sh:1;return t.territoryRetakeRate*s*a}_checkFactionWar(e,t){let i=0;for(const l of this._activeWars)l.active&&i++;if(i>=2)return;const s=[...this._factions.values()].filter(l=>l.strength>=40).sort(()=>Math.random()-.5);if(s.length<2)return;const a=s[0],r=s[1],n={id:`war_${this._warIdCounter++}`,attackerFaction:a.id,defenderFaction:r.id,locationX:e+(Math.random()-.5)*800,locationY:t+(Math.random()-.5)*800,startTime:this._elapsedTime,duration:Yy,attackerStrength:a.strength,defenderStrength:r.strength,active:!0,playerIntervened:!1};this._activeWars.push(n)}interveneInWar(e,t){const i=this._activeWars.find(r=>r.id===e&&r.active);if(!i||i.playerIntervened||t!==i.attackerFaction&&t!==i.defenderFaction)return!1;i.playerIntervened=!0,i.playerSide=t;const s=t===i.attackerFaction?i.defenderFaction:i.attackerFaction,a=this._factions.get(s);return a&&(a.strength=Math.max(0,a.strength-5)),!0}_resolveWar(e){const t=this._factions.get(e.attackerFaction),i=this._factions.get(e.defenderFaction);if(!t||!i)return;let s=e.attackerStrength,a=e.defenderStrength;e.playerIntervened&&(e.playerSide===e.attackerFaction?s+=20:a+=20);const r=s+a,n=s/r;Math.random()<n?(t.strength=Math.min(100,t.strength+5),i.strength=Math.max(0,i.strength-8)):(i.strength=Math.min(100,i.strength+3),t.strength=Math.max(0,t.strength-10)),this._updateMutations(e.attackerFaction),this._updateMutations(e.defenderFaction)}_updateWars(e){for(const t of this._activeWars)t.active&&this._elapsedTime-t.startTime>=t.duration&&(t.active=!1,this._resolveWar(t));this._activeWars.length>20&&(this._activeWars=[...this._activeWars.filter(t=>t.active),...this._activeWars.filter(t=>!t.active).slice(-10)])}getAlliedFactions(e){if(!this._isPostgame)return[];const t=this._factions.get(e);if(!t||t.strength<70)return[];const i=[];for(const[s,a]of this._factions)s!==e&&a.strength>=70&&i.push(s);return i}getEnemyPool(e){const t=mt[e],i=this._factions.get(e);if(!i)return t.enemyTypes;const s=[...t.enemyTypes];i.strength>=50&&s.push(...t.eliteEnemyTypes);const a=this.getAlliedFactions(e);for(const r of a){const n=mt[r];s.push(...n.enemyTypes.slice(0,2))}return s}update(e,t,i,s){this._elapsedTime+=e;const a=this._isPostgame?sh*(1+this._ngPlusCycle*.5):1;for(const r of this._factions.values()){r.strength=Math.min(100,r.strength+zy*e*a),r.raidCooldown>0&&(r.raidCooldown-=e);const n=mt[r.id];if(r.raidCooldown<=0&&r.strength>=30){const l=n.aggressionBase/a;if(Math.random()<e/l){const h=i+(Math.random()-.5)*600,c=s+(Math.random()-.5)*600;this.spawnRaid(r.id,h,c)}}this._updateMutations(r.id)}this._updateRaids(e),this._updateWars(e),this._warTimer+=e,this._warTimer>=qy&&(this._warTimer=0,Math.random()<.3&&this._checkFactionWar(i,s))}serialize(){return{factions:[...this._factions.entries()],activeRaids:this._activeRaids.filter(e=>e.active),activeWars:this._activeWars.filter(e=>e.active),elapsedTime:this._elapsedTime,isPostgame:this._isPostgame,ngPlusCycle:this._ngPlusCycle,raidIdCounter:this._raidIdCounter,warIdCounter:this._warIdCounter}}deserialize(e){this._factions.clear();for(const[t,i]of e.factions)this._factions.set(t,i);this._activeRaids=e.activeRaids??[],this._activeWars=e.activeWars??[],this._elapsedTime=e.elapsedTime??0,this._isPostgame=e.isPostgame??!1,this._ngPlusCycle=e.ngPlusCycle??0,this._raidIdCounter=e.raidIdCounter??0,this._warIdCounter=e.warIdCounter??0}}function me(o,e,t,i,s,a){return{name:o,phase:e,activeModes:t,update:i,serialize:s,deserialize:a}}function jy(o){const e=new Kg,t=new Zg,i=new i0,s=new c0,a=new d0,r=new u0,n=new m0,l=new p0,h=new _0,c=new y0,d=new b0,u=new w0,f=new ld(42069),m=new S0,_=new I0,p=new x0,g=new D0,y=new $0,S=new L0,b=new B0,w=new W0,k=new N0,T=new O0,M=new U0,C=new K0(o),P=new Q0(64),R=new Z0,B=new iy,F=new sy,W=new ay,X=new ly,$=new hy,H=new uy,te=new fy,K=new _y,ee=new Ey,ue=new $y,be=new Ly,Ee=new Hy,fe=new Uy,ve={gameTime:e,weather:t,corruption:i,survival:s,combatTiming:a,statusEffects:r,quest:n,achievement:l,crafting:h,equipment:c,shop:d,colony:u,dungeon:f,rift:m,titan:_,story:p,farming:g,fishing:y,relationship:S,profession:b,techTree:w,audio:k,tutorial:T,combat:M,cutscene:C,spatialHash:P,classSystem:R,endgame:B,festival:F,mail:W,minigame:X,storage:$,save:H,settings:te,cooking:K,temperature:ee,weaponMastery:ue,skills:be,shadowWorld:Ee,faction:fe},ae=null,Me=[se.ISOMETRIC],Le=[se.ISOMETRIC,se.TOP_DOWN],I=[se.ISOMETRIC,se.TOP_DOWN,se.SIDE_SCROLL],E=[me("GameTime",de.GAME_TIME,ae,A=>e.update(A),()=>e.serialize(),A=>e.deserialize(A)),me("Weather",de.GAME_TIME,Le,A=>t.update(A,e),()=>t.serialize(),A=>t.deserialize(A)),me("Corruption",de.WORLD,ae,(A,q)=>i.update(A,e,q.player.x,q.player.y),()=>i.serialize(),A=>i.deserialize(A)),me("Colony",de.WORLD,Me,A=>u.update(A),()=>u.serialize(),A=>u.deserialize(A)),me("Farming",de.WORLD,Me,()=>{},()=>g.serialize(),A=>g.deserialize(A)),me("Titan",de.AI,Me,(A,q)=>_.update(A,q.player.x,q.player.y),()=>_.serialize(),A=>_.deserialize(A)),me("Story",de.AI,ae,()=>{},()=>p.serialize(),A=>p.deserialize(A)),me("Tutorial",de.AI,ae,()=>{},()=>T.serialize(),A=>T.deserialize(A)),me("Survival",de.PHYSICS,Le,(A,q)=>s.update(A,e,!1,q.player.health,i.globalCorruption),()=>s.serialize(),A=>s.deserialize(A)),me("CombatTiming",de.COMBAT,I,A=>{a.update(A)}),me("StatusEffects",de.COMBAT,ae,()=>{},()=>r.serialize(),A=>r.deserialize(A)),me("Crafting",de.ECONOMY,ae,()=>{}),me("Equipment",de.ECONOMY,ae,A=>c.updateCooldowns(A),()=>c.serialize(),A=>c.deserialize(A)),me("Profession",de.ECONOMY,ae,()=>{},()=>b.serialize(),A=>b.deserialize(A)),me("TechTree",de.ECONOMY,Me,()=>{},()=>w.serialize(),A=>w.deserialize(A)),me("Shop",de.ECONOMY,ae,A=>d.restockShops(A),()=>d.serialize(),A=>d.deserialize(A)),me("Relationship",de.ECONOMY,Me,A=>S.update(A),()=>S.serialize(),A=>S.deserialize(A)),me("Fishing",de.ECONOMY,Me,()=>{},()=>y.serialize(),A=>y.deserialize(A)),me("Quest",de.META,ae,A=>n.update(A),()=>n.serialize(),A=>n.deserialize(A)),me("Achievement",de.META,ae,A=>l.update(A),()=>l.serialize(),A=>l.deserialize(A)),me("Rift",de.META,ae,()=>{},()=>m.serialize(),A=>m.deserialize(A)),me("Audio",de.META,ae,()=>{},()=>k.serialize(),A=>k.deserialize(A)),me("ClassSystem",de.COMBAT,ae,A=>R.updateCooldowns(A),()=>R.serialize(),A=>R.deserialize(A)),me("Endgame",de.META,ae,()=>{},()=>B.serialize(),A=>B.deserialize(A)),me("Festival",de.WORLD,Me,(()=>{let A=-1;return()=>{e.day!==A&&(A=e.day,F.checkFestival(e.season,e.dayOfSeason),F.rollDailyEvents(e.day))}})(),()=>F.serialize(),A=>F.deserialize(A)),me("Mail",de.META,ae,()=>{},()=>W.serialize(),A=>W.deserialize(A)),me("Storage",de.ECONOMY,ae,()=>{},()=>$.serialize(),A=>$.deserialize(A)),me("Cooking",de.ECONOMY,ae,()=>{},()=>K.serialize(),A=>K.deserialize(A)),me("Temperature",de.PHYSICS,Le,(A,q)=>ee.update(A,"haven",e,t.current,q.player.x,q.player.y),()=>ee.serialize(),A=>ee.deserialize(A)),me("WeaponMastery",de.COMBAT,ae,A=>ue.update(A),()=>ue.serialize(),A=>ue.deserialize(A)),me("Skills",de.META,ae,A=>be.update(A),()=>be.serialize(),A=>be.deserialize(A)),me("SaveManager",de.META,ae,()=>{}),me("ShadowWorld",de.WORLD,Le,(A,q)=>Ee.update(A,e,q.player.x,q.player.y),()=>Ee.serialize(),A=>Ee.deserialize(A)),me("Faction",de.WORLD,Le,(A,q)=>fe.update(A,e,q.player.x,q.player.y),()=>fe.serialize(),A=>fe.deserialize(A))];return{instances:ve,adapters:E}}class Ky{_pool=[];_active=[];_factory;_reset;constructor(e,t,i=0){this._factory=e,this._reset=t;for(let s=0;s<i;s++)this._pool.push(e())}get activeCount(){return this._active.length}get poolSize(){return this._pool.length}get active(){return this._active}acquire(){let e;return this._pool.length>0?e=this._pool.pop():e=this._factory(),this._reset(e),this._active.push(e),e}release(e){const t=this._active.indexOf(e);if(t>=0){const i=this._active.length-1;t!==i&&(this._active[t]=this._active[i]),this._active.length=i,this._pool.push(e)}}releaseAll(){for(let e=0;e<this._active.length;e++)this._pool.push(this._active[e]);this._active.length=0}updateAndRelease(e){let t=0;for(;t<this._active.length;)if(e(this._active[t])){this._pool.push(this._active[t]);const i=this._active.length-1;t!==i&&(this._active[t]=this._active[i]),this._active.length=i}else t++}}function Qy(o=500){return new Ky(()=>({x:0,y:0,vx:0,vy:0,life:0,maxLife:1,size:3,color:"#fff",alpha:1,gravity:0,vfxKey:""}),e=>{e.life=0,e.alpha=1,e.vfxKey=""},o)}class Zy{_pool;_maxActive;_transferBuf;_transferCount=0;constructor(e=300){this._pool=Qy(e),this._maxActive=e+100,this._transferBuf=[];for(let t=0;t<e;t++)this._transferBuf.push({x:0,y:0,radius:0,color:"",alpha:0,alive:!1,vfxKey:""})}get active(){return this._pool.active}getActiveParticles(){const e=this._pool.active,t=e.length;for(;this._transferBuf.length<t;)this._transferBuf.push({x:0,y:0,radius:0,color:"",alpha:0,alive:!1,vfxKey:""});for(let i=0;i<t;i++){const s=e[i],a=this._transferBuf[i];a.x=s.x,a.y=s.y,a.radius=s.size,a.color=s.color,a.alpha=s.alpha,a.alive=!0,a.vfxKey=s.vfxKey}return this._transferCount=t,this._transferBuf}get transferCount(){return this._transferCount}emit(e,t,i,s=5,a=30,r=.5){for(let n=0;n<s;n++){if(this._pool.activeCount>=this._maxActive)return;const l=this._pool.acquire();l.x=e,l.y=t;const h=Math.random()*Math.PI*2,c=Math.random()*a;l.vx=Math.cos(h)*c,l.vy=Math.sin(h)*c,l.life=r+Math.random()*r*.3,l.maxLife=l.life,l.color=i,l.size=2+Math.random()*3,l.gravity=20}}emitHit(e,t){this.emit(e,t,"#ff4444",8,60,.3)}emitHealBasic(e,t){const i=this._pool.activeCount;this.emit(e,t,"#44ff44",6,20,.6);const s=this._pool.active;for(let a=Math.max(i,s.length-6);a<s.length;a++){const r=s[a];r.vy=-Math.abs(r.vy)-20,r.gravity=0}}emitPickup(e,t,i="#ffd700"){this.emit(e,t,i,10,40,.4)}emitLevelUp(e,t){for(let i=0;i<20;i++){const s=this._pool.acquire();s.x=e+(Math.random()-.5)*30,s.y=t,s.vx=(Math.random()-.5)*20,s.vy=-50-Math.random()*50,s.life=1+Math.random()*.5,s.maxLife=s.life,s.color=["#ffd700","#ff8800","#ffdd00"][Math.floor(Math.random()*3)],s.size=3+Math.random()*4,s.gravity=30}}emitDeath(e,t){this.emit(e,t,"#ff0000",15,80,.6),this.emit(e,t,"#440000",10,50,.8)}emitCorruption(e,t){const i=this._pool.activeCount;this.emit(e,t,"#8b00ff",5,15,1);const s=this._pool.active;for(let a=Math.max(i,s.length-5);a<s.length;a++)s[a].gravity=-10}emitHeal(e,t){const i=["#4ade80","#86efac","#ffffff","#22c55e"];for(let s=0;s<12;s++){if(this._pool.activeCount>=this._maxActive)return;const a=this._pool.acquire();a.x=e+(Math.random()-.5)*24,a.y=t+(Math.random()-.5)*16,a.vx=(Math.random()-.5)*12,a.vy=-30-Math.random()*40,a.life=.8+Math.random()*.5,a.maxLife=a.life,a.color=i[Math.floor(Math.random()*i.length)],a.size=2+Math.random()*2,a.gravity=-15}}emitLoot(e,t){for(let i=0;i<8;i++){const s=this._pool.acquire();s.x=e+(Math.random()-.5)*16,s.y=t,s.vx=(Math.random()-.5)*30,s.vy=-40-Math.random()*30,s.life=.6+Math.random()*.4,s.maxLife=s.life,s.color=Math.random()>.5?"#ffd700":"#fbbf24",s.size=2+Math.random()*2,s.gravity=50}}emitPurify(e,t){const i=["#93c5fd","#bfdbfe","#ffffff","#60a5fa"];for(let s=0;s<16;s++){const a=s/16*Math.PI*2,r=50+Math.random()*30,n=this._pool.acquire();n.x=e,n.y=t,n.vx=Math.cos(a)*r,n.vy=Math.sin(a)*r,n.life=.7+Math.random()*.3,n.maxLife=n.life,n.color=i[Math.floor(Math.random()*i.length)],n.size=2+Math.random()*2,n.gravity=0}}emitSlash(e,t){if(this._pool.activeCount>=this._maxActive)return;const i=this._pool.acquire();i.x=e,i.y=t,i.vx=0,i.vy=0,i.life=.35,i.maxLife=.35,i.color="#ffffff",i.size=8,i.gravity=0,i.vfxKey="slash_cross"}emitMagicCircle(e,t){if(this._pool.activeCount>=this._maxActive)return;const i=this._pool.acquire();i.x=e,i.y=t,i.vx=0,i.vy=0,i.life=.6,i.maxLife=.6,i.color="#8844ff",i.size=10,i.gravity=0,i.vfxKey="magic_circle"}emitFlowerHeal(e,t){if(this._pool.activeCount>=this._maxActive)return;const i=this._pool.acquire();i.x=e,i.y=t,i.vx=0,i.vy=-15,i.life=.7,i.maxLife=.7,i.color="#44ff88",i.size=8,i.gravity=-10,i.vfxKey="flower_bloom"}emitFireSwoosh(e,t){if(this._pool.activeCount>=this._maxActive)return;const i=this._pool.acquire();i.x=e,i.y=t,i.vx=0,i.vy=0,i.life=.3,i.maxLife=.3,i.color="#ff6622",i.size=8,i.gravity=0,i.vfxKey="fire_swoosh"}emitImpactBurst(e,t){if(this._pool.activeCount>=this._maxActive)return;const i=this._pool.acquire();i.x=e,i.y=t,i.vx=0,i.vy=0,i.life=.25,i.maxLife=.25,i.color="#ffaa44",i.size=6,i.gravity=0,i.vfxKey="spike_burst"}emitSparkle(e,t){if(this._pool.activeCount>=this._maxActive)return;const i=this._pool.acquire();i.x=e,i.y=t,i.vx=0,i.vy=-20,i.life=.5,i.maxLife=.5,i.color="#ffdd44",i.size=6,i.gravity=-15,i.vfxKey="sparkle_burst"}update(e){this._pool.updateAndRelease(t=>(t.life-=e,t.life<=0?!0:(t.x+=t.vx*e,t.y+=t.vy*e,t.vy+=t.gravity*e,t.alpha=Math.max(0,t.life/t.maxLife),t.size*=.99,!1)))}render(e,t,i){const s=this._pool.active;if(s.length===0)return;e.save();let a="";const r=Math.PI*2;for(let n=0;n<s.length;n++){const l=s[n];e.globalAlpha=l.alpha,l.color!==a&&(a=l.color,e.fillStyle=a),e.beginPath(),e.arc(l.x-t,l.y-i,l.size,0,r),e.fill()}e.restore()}}const rh=16;class Jy{_systems=[];_sorted=!1;register(e,t,i=100){return this._systems.push({name:e,fn:t,priority:i,enabled:!0}),this._sorted=!1,this}remove(e){return this._systems=this._systems.filter(t=>t.name!==e),this}setEnabled(e,t){const i=this._systems.find(s=>s.name===e);i&&(i.enabled=t)}execute(e,t){this._sorted||(this._systems.sort((i,s)=>i.priority-s.priority),this._sorted=!0);for(let i=0;i<this._systems.length;i++){const s=this._systems[i];if(!s.enabled)continue;const a=performance.now();try{s.fn(e,t)}catch(n){console.error(`[SystemPipeline] "${s.name}" threw:`,n)}const r=performance.now()-a;r>rh&&console.warn(`[SystemPipeline] "${s.name}" took ${r.toFixed(1)}ms (>${rh}ms budget)`)}}getSystemNames(){return this._sorted||(this._systems.sort((e,t)=>e.priority-t.priority),this._sorted=!0),this._systems.map(e=>e.name)}clear(){this._systems=[],this._sorted=!1}}const eb=500;class tb{_container;_spriteMap=new Map;_freeList=[];_textureResolver;_frameTexCache=new Map;_renderQuery;_enterQuery;_exitQuery;constructor(e,t){this._container=e,this._container.sortableChildren=!0,this._textureResolver=t;const i=St([j,ye,xe]);this._renderQuery=i,this._enterQuery=Vp(i),this._exitQuery=qp(i)}update(e,t){this._processEntered(e),this._processExited(e),this._syncEntities(e,t)}destroy(){for(const e of this._spriteMap.values())e.removeFromParent(),e.destroy();for(const e of this._freeList)e.removeFromParent(),e.destroy();this._spriteMap.clear(),this._freeList.length=0,this._frameTexCache.clear()}get activeCount(){return this._spriteMap.size}get pooledCount(){return this._freeList.length}_processEntered(e){const t=this._enterQuery(e);for(let i=0;i<t.length;i++){const s=t[i];if(this._spriteMap.has(s))continue;if(this._spriteMap.size>=eb)break;const a=this._acquireSprite();this._spriteMap.set(s,a)}}_processExited(e){const t=this._exitQuery(e);for(let i=0;i<t.length;i++){const s=t[i],a=this._spriteMap.get(s);a&&(this._releaseSprite(a),this._spriteMap.delete(s))}}_syncEntities(e,t){const i=this._renderQuery(e);for(let s=0;s<i.length;s++){const a=i[s],r=this._spriteMap.get(a);if(!r)continue;if(xe.value[a]===0){r.visible=!1;continue}r.visible=!0,oo(e,Vs,a)?(r.x=Vs.screenX[a],r.y=Vs.screenY[a],r.zIndex=Vs.depth[a]):(r.x=j.x[a],r.y=j.y[a],r.zIndex=j.y[a]);const n=ye.textureId[a],l=this._textureResolver(n),h=ye.totalFrames[a]||1,c=ye.frame[a]%h;if(l!==Z.EMPTY&&h>1&&l.width>0){const f=Math.floor(l.width/h),m=l.height,_=`${n}:${c}:${f}:${m}`;let p=this._frameTexCache.get(_);if(!p){const g=c*f;p=new Z({source:l.source,frame:new $e(g,0,f,m)}),this._frameTexCache.set(_,p)}r.texture=p}else r.texture=l;const d=ye.width[a]||32,u=ye.height[a]||32;r.width=d,r.height=u,ye.flipX[a]&&(r.scale.x=-Math.abs(r.scale.x)),oo(e,Mt,a)&&this._advanceAnimation(a,t)}}_advanceAnimation(e,t){const i=Mt.speed[e];if(!(i<=0)&&(Mt.timer[e]=(Mt.timer[e]??0)+t*1e3,Mt.timer[e]>=i)){Mt.timer[e]=Mt.timer[e]-i;const s=Mt.totalFrames[e]||1;let a=Mt.frame[e]+1;a>=s&&(a=Mt.loop[e]?0:s-1),Mt.frame[e]=a,ye.frame[e]=a}}_acquireSprite(){const e=this._freeList.pop();if(e)return e.visible=!0,e.alpha=1,e.tint=16777215,e.scale.set(1,1),e.texture=Z.EMPTY,e.parent||this._container.addChild(e),e;const t=new _t(Z.EMPTY);return t.anchor.set(.5,.85),this._container.addChild(t),t}_releaseSprite(e){e.visible=!1,this._freeList.push(e)}}class ib{_textures=new Map;_nameToId=new Map;_nextId=1;register(e,t){const i=this._nameToId.get(e);if(i!==void 0)return this._textures.set(i,t),i;const s=this._nextId++;return this._nameToId.set(e,s),this._textures.set(s,t),s}resolve(e){return this._textures.get(e)??Z.EMPTY}getId(e){return this._nameToId.get(e)??0}get count(){return this._textures.size}clear(){this._textures.clear(),this._nameToId.clear(),this._nextId=1}}const Yt=["wall","road","gate","tower","house","storage","workshop","forge","farm","well","purifier","barracks","trade_post","alchemy_lab","cooking_station","enchanting_table","watchtower"],Lr={tree:{emoji:"",color:"#2a6a2a",size:28,drop:"wood",amount:[2,4]},rock:{emoji:"",color:"#6a6a6a",size:18,drop:"stone",amount:[1,3]},iron_ore:{emoji:"",color:"#8a6a4a",size:14,drop:"iron_ore",amount:[1,2]},herb:{emoji:"",color:"#4aaa4a",size:10,drop:"herb",amount:[1,2]},crystal:{emoji:"",color:"#7a4aba",size:12,drop:"corruption_essence",amount:[1,1]},mushroom:{emoji:"",color:"#8a4a2a",size:10,drop:"spore_cap",amount:[1,3]}},sb={tree:"tree",rock:"rock",iron_ore:"iron_ore",herb:"herb",crystal:"crystal",mushroom:"mushroom"};class Ea{_input;_camera;_loader;_ready=!1;_canvas;_bgCanvas;_ctx;_bgCtx;_vignetteCanvas=null;_container=null;_drawables=[];_mapIcons=[];_renderFrameSkip=0;_frameTimeMs=0;_lastDt=1/60;_ecsWorld;_entityRegistry;_viewMode;_systemManager;_sprites;_state;_systems;_isoRenderer;_sideScrollRenderer;_minimap;_ui;_webgl=null;_webglIso=null;_webglEntities=null;_webglParticles=null;_webglLighting=null;_webglScreenFX=null;_webglDungeon=null;_webglBossArena=null;_pixiApp=null;_ecsPipeline;_ecsRenderSystem=null;_textureRegistry=new ib;_player;_inventory;_enemies=[];_npcs=[];_buildings=[];_buildingsByEid=new Map;_worldDrops=[];_resources=[];_decorTrees=[];_attackCooldown=0;_attackSwingTimer=0;_hitPauseTimer=0;_damagePopups=[];_xpNotifications=[];_lootNotifications=[];_levelUpFlash=0;_damageFlash=0;_critFlash=0;_killStreak=0;_vfxSprites=[];_killStreakTimer=0;_purifierTickTimer=0;_prevComboTier=0;_comboMilestoneFlash=0;_comboMilestoneTier=0;_festivalActivityCooldown=0;_survivalWarnTimer=0;_dpsWindow=[];_dpsTimer=0;_dpsValue=0;_prevTimePhase="";_particles=new Zy(400);_prevAchievementTimer=0;_prevStoryQuestId=null;_triggeredCutscenes=new Set;_envParticles=[];_envParticleTimer=0;_footstepTimer=0;_footstepSoundCount=0;_statusEffectParticleTimer=0;_prevGameHour=-1;_heartbeatTimer=0;_chimneySmokeTimer=0;_enemyAggroAlerts=[];_prevEnemyChasingSet=new Set;_respawnQueue=[];_nearestResource=null;_nearestNPC=null;_nearestBuilding=null;_gatherTimer=0;_showInventory=!1;_inventorySelectedSlot=0;_showQuestPanel=!1;_showEquipment=!1;_showCrafting=!1;_craftingScrollIdx=0;_craftingStation="hand";_talkingToNpc=null;_dialogueStep=0;_dialogueChoiceIndex=0;_showShop=!1;_activeShop=null;_shopScrollOffset=0;_shopSelectedIndex=0;_shopMode="buy";_cachedSellableSlots=[];_sellableDirty=!0;_cachedBuildCostStr="";_cachedBuildType=-1;_dungeonGenerator;_dungeonRenderer;_currentDungeon=null;_dungeonFloor=1;_dungeonEnemies=[];_dungeonEnemyAttackCDs=new Map;_interiorManager=new Vg;_bossHealth=0;_bossMaxHealth=0;_bossName="";_bossIcon="";_bossX=0;_bossVelX=0;_bossAttackTimer=0;_bossAttackTelegraph=0;_bossHitFlash=0;_bossPhase=0;_sideScrollPlayerVelY=0;_sideScrollPlayerOnGround=!0;_sideScrollScreenShake=0;_playerDead=!1;_deathTimer=0;_deathFadeAlpha=0;_deathPenaltyApplied=!1;_hotbarSlot=0;_attackArcTimer=0;_attackArcAngle=0;_attackArcDmgType="physical";_itemUseCooldown=0;_storyStarted=!1;_showFarmUI=!1;_farmSelectedSeed=0;_nearFarmPlot=null;_showFishing=!1;_showTechTree=!1;_techScrollIdx=0;_exitTimer=null;_showSettings=!1;_gamePaused=!1;_escConsumed=!1;_escDebounceTimer=0;_showDebug=!1;_enemyPruneTimer=0;_showSaveMenu=!1;_saveMenuIdx=0;_showMail=!1;_mailScrollIdx=0;_showControls=!1;_prevPhaseCooldown=0;_sprintXpAccum=0;_hitStopTimer=0;_lootPickupRadius=80;_showStorage=!1;_activeContainer=null;_storageScrollIdx=0;_showMinigame=!1;_lastFestivalDay=-1;_lastDay=-1;_buildMode=!1;_buildCursorX=0;_buildCursorY=0;_buildSelectedType=0;_nearRift=null;_buildingFeatureCache=new Map;_itemStatStrCache=new Map;_skillBuffs=new Map;_trackingRevealTimer=0;_tempHazardCooldown=!1;_deathMarkedEids=new Set;_biomeAmbient=new og;_lighting=new ng;_playerLightId=-1;_currentBiome=null;_discoveredBiomes=new Set(["haven"]);_biomeBannerAlpha=0;_biomeBannerName="";_biomeBannerIcon="";_fps=0;_fpsFrames=0;_fpsTimer=0;_musicMoodTimer=0;_currentMusicMood="";static _minimapBiomeResult={tileColors:{grass:"#333"}};_minimapBiomeCb=(e,t)=>{const i=Js(e,t);return Ea._minimapBiomeResult.tileColors.grass=i?.tileColors?.grass??"#333",Ea._minimapBiomeResult};_gradGoldenGlow=null;_gradGoldenGlowKey="";_gradDmgVig=null;_gradDmgVigKey="";_gradPlayerBody=null;_gradPlayerBodyKey="";_gradDungeonVig=null;_gradDungeonVigKey="";_gradTorch=null;_gradTorchKey="";_gradCdBar=null;_gradCdBarKey="";_gradXpBar=null;_gradXpBarKey="";_gradCraftBar=null;_gradCraftBarKey="";_gradReelBar=null;_gradReelBarKey="";_gradTensBar=null;_gradTensBarKey="";_gradClassXp=null;_gradClassXpKey="";_gradDeathVig=null;_gradDeathVigKey="";constructor(e,t,i,s="warrior",a=null){this._input=e,this._camera=t,this._loader=i,this._pixiApp=a,this._state=v_(Vt,s),this._viewMode=new b_,this._viewMode.setImmediate(se.ISOMETRIC),this._viewMode.onChange((l,h)=>{console.log(`[WorldScene] View mode  ${se[h]}`),this._camera.applyConfig(this._viewMode.getCameraConfig()),h===se.ISOMETRIC&&l===se.TOP_DOWN&&(this._currentDungeon=null,this._dungeonEnemies=[],this._dungeonEnemyAttackCDs.clear(),this._player.setPosition(this._state.view.returnX,this._state.view.returnY))}),this._systemManager=new w_(this._viewMode),this._systemManager.setStateRef(this._state);const{instances:r,adapters:n}=jy(e);this._systems=r,this._systemManager.registerAll(...n),this._systems.classSystem.setClass(this._state.player.classId),this._sprites=new B_(i),this._ecsWorld=t_(),this._entityRegistry=new r_,this._systems.combat.setWorld(this._ecsWorld),this._systems.combat.setCombatTiming(this._systems.combatTiming),this._ecsPipeline=new Jy,this._ecsPipeline.register("movement",pr,10),this._ecsPipeline.register("enemyAI",(l,h)=>{this._entityRegistry.updateEnemyAI(l,h,this._player.x,this._player.y,800*800,14400)},15),this._ecsPipeline.register("survival",(l,h)=>{const d=this._systems.gameTime.timeScale*h;m_(l,h,d,this._player.isSprinting,12)},20),this._ecsPipeline.register("statusEffects",(l,h)=>{const c=this._systems.statusEffects.update(h,x.max[this._player.eid]??100);if(c.damage>0&&(x.current[this._player.eid]=Math.max(0,(x.current[this._player.eid]??100)-c.damage)),c.healing>0){const d=x.max[this._player.eid]??100;x.current[this._player.eid]=Math.min(d,(x.current[this._player.eid]??100)+c.healing)}},25),this._ecsPipeline.register("attackCooldowns",(l,h)=>{g_(l,h)},30),this._player=new Ag(this._ecsWorld),this._inventory=new Og(36),this._inventory.addItem("wooden_sword",1),this._inventory.equip(0),this._inventory.addItem("health_potion",3),this._inventory.addItem("bread",5),this._syncLegendaryEffects(),this._isoRenderer=new O_(i,(l,h)=>Zi(l,h,Vt)),this._minimap=new rg,this._ui=new Go,this._dungeonGenerator=new ld(Vt),this._dungeonRenderer=new zg,this._dungeonRenderer.setSpriteRegistry(this._sprites),this._sideScrollRenderer=new hg,this._sideScrollRenderer.setSpriteRegistry(this._sprites),this._sideScrollRenderer.setPlayerClass(this._state.player.classId),this._spawnEntities(),this._viewMode.onChange((l,h)=>{if(h===se.TOP_DOWN&&this._state.view.dungeonId)this._dungeonFloor=1,this._enterDungeonFloor(),this._webglDungeon&&this._webgl&&this._currentDungeon&&!this._webglDungeon.hasFloor&&(this._webglDungeon.buildFloor({width:this._currentDungeon.width,height:this._currentDungeon.height,tiles:this._currentDungeon.tiles,theme:this._currentDungeon.theme,level:this._currentDungeon.level}),this._webgl.world.children.includes(this._webglDungeon.container)||this._webgl.world.addChild(this._webglDungeon.container),this._webglDungeon.container.visible=!0,this._webgl.terrainLayer.visible=!1,this._webgl.groundLayer.visible=!1);else if(h===se.TOP_DOWN&&this._state.view.interiorId)this._interiorManager.enter(this._state.view.interiorId),this._webgl&&(this._webgl.terrainLayer.visible=!1,this._webgl.groundLayer.visible=!1);else if(h===se.SIDE_SCROLL&&this._state.view.bossArenaId)this._initBossArena();else if(h===se.ISOMETRIC){const c=this._state.view.returnX,d=this._state.view.returnY;this._player.setPosition(c,d),this._currentDungeon=null,this._dungeonEnemies=[],this._dungeonEnemyAttackCDs.clear(),this._interiorManager.exit(),this._state.view.dungeonId=null,this._state.view.interiorId=null,this._state.view.bossArenaId=null,this._webgl&&(this._webgl.terrainLayer.visible=!0,this._webgl.groundLayer.visible=!0,this._webglDungeon&&(this._webglDungeon.clear(),this._webglDungeon.container.visible=!1),this._webglBossArena&&(this._webglBossArena.clear(),this._webglBossArena.container.visible=!1))}}),console.log(`[WorldScene] Initialized: ${this._systemManager.totalRegistered} systems registered`)}get player(){return this._player}get state(){return this._state}get viewMode(){return this._viewMode}_spawnEntities(){this._buildings=Wg();for(const a of this._buildings)Lg(this._ecsWorld,a),a.eid!==void 0&&this._buildingsByEid.set(a.eid,a);for(const[,a]of Object.entries(Eg)){const r=new $g(this._ecsWorld,a);this._npcs.push(r),this._entityRegistry.registerNPC(r)}const e=this._seededRandom(Vt),t=[{biome:"haven",minDist:400,maxDist:900,count:8,defs:["slime","mushroom_spirit","cave_bat","field_mouse","wolf"]},{biome:"rotwood",minDist:900,maxDist:2200,count:16,defs:["goblin_berserker","goblin_slinger","wolf","corpse_spider","rotting_treant","mushroom_spirit","venomous_snake","spore_larva","forest_bear"]},{biome:"ashlands",minDist:2200,maxDist:3400,count:14,defs:["cultist","fire_imp","magma_golem","flame_sprite","red_slime","lava_serpent","ember_bat"]},{biome:"drowned_depths",minDist:3400,maxDist:4600,count:14,defs:["skeleton_grunt","skeleton_hunter","drowned_sailor","marsh_lurker","poison_toad","deep_octopus","swamp_mole","ice_wolf","ice_elemental"]},{biome:"bone_wastes",minDist:4600,maxDist:5800,count:14,defs:["skeleton_grunt","skeleton_hunter","zombie","wraith","bone_knight","necromancer","skeletal_owl","bone_lizard"]},{biome:"the_void",minDist:5800,maxDist:7400,count:12,defs:["possessed","phantom","void_crawler","shadow_wisp","cultist","void_dragon","reality_warper","void_panda"]}],i=300,s=i*i;for(const a of t){let r=0,n=0;const l=a.count*10;for(;r<a.count&&n<l;){n++;const h=e()*Math.PI*2,c=a.minDist+e()*(a.maxDist-a.minDist),d=Math.cos(h)*c,u=Math.sin(h)*c,f=600,m=d-rs.startX,_=u-rs.startY;if(m*m+_*_<f*f)continue;let p=!1;for(const S of this._enemies){const b=S.x-d,w=S.y-u;if(b*b+w*w<s){p=!0;break}}if(p)continue;const g=a.defs[Math.floor(e()*a.defs.length)],y=Qs[g];if(y){const S=new ei(this._ecsWorld,y,d,u,this._sprites);this._applyNGPlusHealthScaling(S),this._enemies.push(S),this._entityRegistry.registerEnemy(S),r++}}}for(const a of this._enemies)this._systems.spatialHash.insert({id:a.eid,x:a.x,y:a.y});this._spawnResources(e),this._spawnDecorTrees(e),console.log(`[WorldScene] Spawned: ${this._buildings.length} buildings, ${this._npcs.length} NPCs, ${this._enemies.length} enemies, ${this._resources.length} resources, ${this._decorTrees.length} decor trees`)}_spawnResources(e){const t=[{biome:"haven",minD:80,maxD:700,count:55,types:["tree","tree","tree","rock","herb"]},{biome:"rotwood",minD:700,maxD:2e3,count:70,types:["tree","tree","tree","rock","iron_ore","herb","mushroom"]},{biome:"ashlands",minD:2e3,maxD:3200,count:35,types:["rock","rock","iron_ore","crystal"]},{biome:"drowned_depths",minD:3200,maxD:4400,count:25,types:["tree","rock","herb","crystal","mushroom"]},{biome:"bone_wastes",minD:4400,maxD:5600,count:20,types:["rock","crystal"]},{biome:"the_void",minD:5600,maxD:7200,count:14,types:["crystal","crystal","rock"]}],i=140,s=i*i;for(const a of t){let r=0,n=0;const l=a.count*15;for(;r<a.count&&n<l;){n++;const h=e()*Math.PI*2,c=a.minD+e()*(a.maxD-a.minD),d=Math.cos(h)*c,u=Math.sin(h)*c;let f=!1;for(const p of this._resources){const g=p.x-d,y=p.y-u;if(g*g+y*y<s){f=!0;break}}if(f)continue;const m=a.types[Math.floor(e()*a.types.length)],_=m==="tree"?5:m==="rock"?4:2;this._resources.push({x:d,y:u,type:m,biome:a.biome,health:_,maxHealth:_,respawnTimer:0,depleted:!1}),r++}}}_spawnDecorTrees(e){const t=[{minD:60,maxD:700,count:80},{minD:700,maxD:2200,count:120},{minD:2200,maxD:3500,count:30}],i=1e4,s=4e4;for(const a of t){let r=0,n=0;for(;r<a.count&&n<a.count*8;){n++;const l=e()*Math.PI*2,h=a.minD+e()*(a.maxD-a.minD),c=Math.cos(l)*h,d=Math.sin(l)*h;let u=!1;for(const m of this._buildings){const _=m.tileX*32+m.def.widthTiles*16,p=m.tileY*32+m.def.heightTiles*16,g=_-c,y=p-d;if(g*g+y*y<s){u=!0;break}}if(u)continue;let f=!1;for(const m of this._decorTrees){const _=m.x-c,p=m.y-d;if(_*_+p*p<i){f=!0;break}}f||(this._decorTrees.push({x:c,y:d,seed:e()*65535|0,scale:.5+e()*.9}),r++)}}}_seededRandom(e){let t=e;return()=>{t|=0,t=t+1831565813|0;let i=Math.imul(t^t>>>15,1|t);return i=i+Math.imul(i^i>>>7,61|i)^i,((i^i>>>14)>>>0)/4294967296}}_populateTextureRegistry(){this._textureRegistry.clear();let e=0;const t=this._state.player.classId;for(const s of["Left","Right"])for(const a of["Idle","Run","Attack01","Death","Hurt"]){const r=this._sprites.getCharacterSpritePath(t,s,a);if(r){const n=this._sprites.getSprite(r);if(n&&n.naturalWidth>0){const l=Ut.textureFromImage(n);this._textureRegistry.register(`player_${s}_${a}`,l),e++}}}const i=["skeleton_grunt","skeleton_hunter","goblin_berserker","goblin_slinger","cultist","possessed"];for(const s of i)for(const a of["Down","Left","Right","Up"]){const r=this._sprites.getEnemySpritePath(s,a,"Idle");if(r){const n=this._sprites.getSprite(r);if(n&&n.naturalWidth>0){const l=Ut.textureFromImage(n);this._textureRegistry.register(`enemy_${s}_${a}_Idle`,l),e++}}}for(const[s,a]of Object.entries(No)){const r=this._sprites.getSprite(a);if(r&&r.naturalWidth>0){const n=Ut.textureFromImage(r);this._textureRegistry.register(`npc_${s}`,n),e++}}for(const s of this._buildings){const a=s.def.id,r=this._sprites.getBuildingSpritePath(a);if(r){const n=this._sprites.getSprite(r);if(n&&n.naturalWidth>0){const l=Ut.textureFromImage(n);this._textureRegistry.register(`building_${a}`,l),e++}}}console.log(`[TextureRegistry] Registered ${e} textures (${this._textureRegistry.count} unique)`)}_assignEntityTextureIds(){const e=this._textureRegistry.getId("player_Right_Idle");e>0&&(ye.textureId[this._player.eid]=e);for(const i of this._enemies){const s=i.def.spriteType;if(s){const a=this._textureRegistry.getId(`enemy_${s}_Right_Idle`);a>0&&(ye.textureId[i.eid]=a)}}for(const i of this._npcs){const s=this._textureRegistry.getId(`npc_${i.def.id}`);s>0&&(ye.textureId[i.eid]=s)}for(const i of this._buildings)if(i.eid!==void 0){const s=this._textureRegistry.getId(`building_${i.def.id}`);s>0&&(ye.textureId[i.eid]=s)}const t=this._buildings.filter(i=>i.eid!==void 0&&ye.textureId[i.eid]>0).length;console.log(`[WorldScene] Assigned textureIds  player: ${e>0}, enemies: ${this._enemies.filter(i=>ye.textureId[i.eid]>0).length}/${this._enemies.length}, NPCs: ${this._npcs.filter(i=>ye.textureId[i.eid]>0).length}/${this._npcs.length}, buildings: ${t}/${this._buildings.length}`)}async enter(e){this._container=e,console.log("[WorldScene] Loading assets..."),this._webgl=new Ut,this._pixiApp?this._webgl.initWithApp(this._pixiApp,{width:v.width,height:v.height}):await this._webgl.init({width:v.width,height:v.height,container:e,zIndex:1}),this._canvas=document.createElement("canvas"),this._canvas.width=v.width,this._canvas.height=v.height,this._canvas.style.cssText="position:absolute;top:0;left:0;width:100%;height:100%;z-index:3;image-rendering:pixelated;",this._ctx=this._canvas.getContext("2d"),e.appendChild(this._canvas),this._bgCanvas=document.createElement("canvas"),this._bgCanvas.width=v.width,this._bgCanvas.height=v.height,this._bgCanvas.style.cssText="position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;image-rendering:pixelated;display:none;",this._bgCtx=this._bgCanvas.getContext("2d",{alpha:!1}),e.appendChild(this._bgCanvas),console.log("[WorldScene] WebGL renderer initialized (PixiJS 8, always-on)");const t=[this._player.preload(this._loader),this._isoRenderer.preload(),this._sprites.preloadCharacter(this._state.player.classId),this._sprites.preloadTileset("exterior").catch(()=>{}),this._sprites.preloadDungeonTiles().catch(()=>{}),this._sprites.preloadBuildings().catch(()=>{}),this._sprites.preloadNPCs().catch(()=>{}),this._sprites.preloadEffects().catch(()=>{}),this._sprites.preloadEnemies(["skeleton_grunt","skeleton_hunter","goblin_berserker","goblin_slinger","cultist","possessed"]).catch(()=>{}),this._sprites.preloadBosses(["skeleton_king","ancient_boss","goblin_beast","goblin_rider"]).catch(()=>{}),this._sprites.preloadResources().catch(()=>{}),this._sprites.preloadTreeSprites().catch(()=>{}),this._sprites.preloadCrops().catch(()=>{}),this._sprites.preloadInteriorTiles().catch(()=>{}),this._sprites.preloadItemSprites().catch(()=>{})];this._webgl&&(this._webglIso=new mg(this._webgl.terrainLayer,this._webgl.groundLayer,this._loader,(s,a)=>Zi(s,a,Vt)),t.push(this._webglIso.preload())),await Promise.all(t),this._webgl&&(this._webglEntities=new gg(this._webgl.entityLayer,this._webgl.groundLayer,this._sprites,this._loader,(s,a)=>{const r=s/L,n=a/L;return{sx:(r-n)*32,sy:(r+n)*16}}),this._webglParticles=new wg(this._webgl.particleLayer),this._webglParticles.setSpriteRegistry(this._sprites),this._webglLighting=new kg(this._webgl.lighting),this._webglScreenFX=new Tg(this._webgl.screenFX),this._webglScreenFX.setViewport(v.width,v.height),this._webglIso.setCorruptionQuery((s,a)=>this._systems.corruption.getCorruptionAt(s,a)),this._webglDungeon=new Cg,this._webglDungeon.setSpriteRegistry(this._sprites),this._webglBossArena=new Ig,this._webglBossArena.setSpriteRegistry(this._sprites),this._populateTextureRegistry(),this._ecsRenderSystem=new tb(this._webgl.entityLayer,s=>this._textureRegistry.resolve(s)),this._assignEntityTextureIds(),console.log(`[WorldScene] WebGL sub-renderers initialized (iso + dungeon + boss arena, ${this._textureRegistry.count} textures registered)`));const i=this._isoRenderer.worldToScreen(this._player.x,this._player.y);if(this._camera.snapTo(i.sx,i.sy),this._isoRenderer.setCorruptionQuery((s,a)=>this._systems.corruption.getCorruptionAt(s,a)),this._ready=!0,!this._storyStarted){const s=this._systems.story.startNextQuest();s&&(console.log(`[Story] Quest started: ${s.name}`),this._lootNotifications.length<15&&this._lootNotifications.push({text:`New Quest: ${s.name}`,timer:4,color:"#ffd700"})),this._systems.quest.acceptQuest("ms_welcome"),this._systems.settings.settings.tutorialEnabled&&this._systems.tutorial.start(),this._storyStarted=!0}this._systems.audio.init(),this._systems.audio.startAmbientMusic("calm"),console.log(`[WorldScene] Ready (${this._sprites.loadedCount} sprites loaded)`)}exit(){console.log("[WorldScene] Exiting"),this._exitTimer&&(clearTimeout(this._exitTimer),this._exitTimer=null),this._systems?.quest?.destroy(),this._webgl&&(this._webglDungeon?.clear(),this._webglBossArena?.clear(),this._ecsRenderSystem?.destroy(),this._ecsRenderSystem=null,this._textureRegistry.clear(),this._webglEntities?.clear(),this._webglParticles?.destroy(),this._webglLighting?.destroy(),this._webglScreenFX?.destroy(),this._webgl.destroy()),this._input.destroy()}_safeFrameCount=0;_audioResumed=!1;update(e){if(!this._ready)return;if(this._lastDt=e,!this._audioResumed&&(this._input.state.justPressed.size>0||this._input.state.mouseClicked)&&(this._audioResumed=!0,this._systems.audio.resume()),this._escConsumed=!1,this._sellableDirty=!0,this._escDebounceTimer=Math.max(0,this._escDebounceTimer-e),this._safeFrameCount++,this._hitStopTimer>0){this._hitStopTimer-=e;return}const t=this._input.wheelDelta;if(t!==0&&!this._showInventory&&!this._showCrafting&&!this._showQuestPanel){const i=t>0?-.05:.05;this._camera.adjustZoom(i)}if(this._input.wasPressed("Home")&&Math.abs(this._camera.zoom-1)>.01&&(this._camera.zoom=1,this._ui.notify("Zoom reset","#888")),this._player.gold!==this._inventory.gold&&this._inventory.setGold(this._player.gold),this._fpsFrames++,this._fpsTimer+=e,this._fpsTimer>=1&&(this._fps=this._fpsFrames,this._fpsFrames=0,this._fpsTimer=0,this._safeFrameCount%600===0&&console.log(`[WorldScene] FPS=${this._fps} frame=${this._safeFrameCount}`)),this._input.wasPressed("Escape")&&!this._escConsumed&&this._escDebounceTimer<=0){let i=!1;this._showSettings?(this._showSettings=!1,this._gamePaused=!0,i=!0):this._gamePaused?(this._gamePaused=!1,i=!0):this._showInventory?(this._showInventory=!1,i=!0):this._showCrafting?(this._showCrafting=!1,i=!0):this._showEquipment?(this._showEquipment=!1,i=!0):this._showQuestPanel?(this._showQuestPanel=!1,i=!0):this._showMail?(this._showMail=!1,i=!0):this._showControls?(this._showControls=!1,i=!0):this._showTechTree?(this._showTechTree=!1,i=!0):this._showFishing?(this._systems.fishing.cancel(),this._showFishing=!1,i=!0):this._showFarmUI?(this._showFarmUI=!1,i=!0):this._showStorage?(this._showStorage=!1,i=!0):this._showShop?(this._showShop=!1,i=!0):this._buildMode?(this._buildMode=!1,i=!0):(this._gamePaused=!0,i=!0),i&&(this._escConsumed=!0,this._escDebounceTimer=.2,this._systems.audio.playSFX("menu_click"))}if(this._showSettings&&(this._input.wasPressed("ArrowUp")&&this._systems.settings.navigateSettings("up"),this._input.wasPressed("ArrowDown")&&this._systems.settings.navigateSettings("down"),this._input.wasPressed("ArrowLeft")&&(this._systems.settings.adjustSetting("left"),this._systems.audio.playSFX("menu_click")),this._input.wasPressed("ArrowRight")&&(this._systems.settings.adjustSetting("right"),this._systems.audio.playSFX("menu_click"))),this._gamePaused&&!this._showSettings&&(this._input.wasPressed("KeyS")&&(this._showSettings=!0,this._systems.audio.playSFX("menu_click")),this._input.wasPressed("F5")&&this._performSave("Quick Save"),this._input.wasPressed("F9")&&(this._performLoad(),this._gamePaused=!1)),!this._gamePaused){if(this._playerDead){if(this._deathTimer+=e,this._deathFadeAlpha=Math.min(1,this._deathTimer*.8),!this._deathPenaltyApplied){this._deathPenaltyApplied=!0;const i=this._systems.settings.get("deathPenalty");let s=0,a=0;switch(i){case"hardcore":s=.25,a=.15;break;case"normal":s=.1,a=.05;break;case"light":s=.05,a=0;break}const r=Math.floor(this._player.gold*s),n=Math.floor(this._player.xp*a);r>0&&(this._player.gold=Math.max(0,this._player.gold-r)),n>0&&(this._player.xp=Math.max(0,this._player.xp-n)),this._systems.audio.playSFX("damage");const l=[];r>0&&l.push(`${r} gold`),n>0&&l.push(`${n} XP`),l.length>0?this._ui.notify(`Lost ${l.join(" & ")}`,"#ff4444"):i==="none"&&this._ui.notify("No death penalty","#888")}this._deathTimer>3&&(this._input.wasPressed("Space")||this._input.wasPressed("Enter"))&&this._respawnPlayer();return}if(this._player.health<=0&&!this._playerDead&&(this._playerDead=!0,this._deathTimer=0,this._deathFadeAlpha=0,this._deathPenaltyApplied=!1,this._camera.shake(8,.5),this._systems.achievement.progress("die_first"),this._viewMode.mode===se.SIDE_SCROLL?this._ui.notify("Slain by the Titan...","#ff4444"):this._viewMode.mode===se.TOP_DOWN&&this._currentDungeon?this._ui.notify("Perished in the dungeon depths...","#ff4444"):this._ui.notify("You have fallen...","#ff4444")),this._hitPauseTimer>0){this._hitPauseTimer-=e;return}for(let i=1;i<=9;i++)if(this._input.wasPressed(`Digit${i}`)){this._hotbarSlot=i-1;break}if(this._itemUseCooldown>0&&(this._itemUseCooldown-=e),this._input.wasPressed("KeyF")&&this._itemUseCooldown<=0&&!this._showInventory&&!this._showCrafting&&!this._showStorage&&!this._showShop&&!this._showEquipment&&this._useHotbarItem(this._hotbarSlot),this._attackArcTimer>0&&(this._attackArcTimer-=e),this._viewMode.update(e),this._systemManager.update(e,this._state),this._syncStateFromSystems(),this._survivalWarnTimer-=e,this._survivalWarnTimer<=0){this._survivalWarnTimer=10;const i=this._systems.survival.state;i.isStarving?this._ui.notify("Starving! Eat food to restore hunger.","#ef4444"):i.hunger<25&&this._ui.notify("Getting hungry...","#f59e0b"),i.isDehydrated?this._ui.notify("Dehydrated! Find water or a drink.","#ef4444"):i.thirst<25&&this._ui.notify("Getting thirsty...","#f59e0b"),i.isFreezing&&this._ui.notify("Freezing! Find shelter or a fire.","#4FC3F7"),i.isOverheating&&this._ui.notify("Overheating! Seek shade or water.","#FF8A65")}switch(this._viewMode.mode){case se.ISOMETRIC:this._updateIsometric(e);break;case se.TOP_DOWN:this._updateTopDown(e);break;case se.SIDE_SCROLL:this._updateSideScroll(e);break}if(this._checkViewModeTriggers(),this._musicMoodTimer=(this._musicMoodTimer??0)+e,this._musicMoodTimer>=1){this._musicMoodTimer=0;const i=this._viewMode.mode;let s;i===se.SIDE_SCROLL?s="boss":i===se.TOP_DOWN?s="dungeon":s=this._enemies.some(r=>{if(!r.alive)return!1;const n=r.x-this._player.x,l=r.y-this._player.y;return n*n+l*l<r.def.aggroRange*r.def.aggroRange})?"combat":"calm",s!==this._currentMusicMood&&(this._currentMusicMood=s,this._systems.audio.startAmbientMusic(s))}}}_updateIsometric(e){const t=this._systems.weather.current;if(t==="blizzard"?this._player.weatherSpeedMod=.6:t==="storm"||t==="heavy_rain"?this._player.weatherSpeedMod=.8:t==="rain"||t==="snow"?this._player.weatherSpeedMod=.9:this._player.weatherSpeedMod=1,this._player.sprintCostMult=this._systems.skills.getModifier("sprint_cost"),this._player.handleInput(this._input,e),this._player.isSprinting&&this._player.isMoving&&(this._sprintXpAccum+=e,this._sprintXpAccum>=1&&(this._sprintXpAccum=0,this._awardSkillXP("endurance",1))),this._attackCooldown=Math.max(0,this._attackCooldown-e),this._attackSwingTimer=Math.max(0,this._attackSwingTimer-e),(this._input.wasPressed("Space")||this._input.state.mouseClicked||this._systems.combatTiming.hasBufferedAttack)&&this._attackCooldown<=0&&!this._player.isAttacking&&!this._systems.statusEffects.isStunned()&&!this._systems.statusEffects.isFrozen()&&this._performAttack(),this._input.wasPressed("KeyV")&&(this._systems.combatTiming.startParry(),this._spawnVFX("energy_swirl",this._player.x,this._player.y,.5,6,.04),this._systems.audio.playSFX("parry")),(this._input.wasPressed("ControlLeft")||this._input.wasPressed("ControlRight"))&&this._systems.combatTiming.startDodge()){const A=[Math.PI/2,-Math.PI/2,0,Math.PI][this._player.facing]??0,q=this._systems.combatTiming.getDodgeDirection(A);this._player.x+=q.dx,this._player.y+=q.dy,this._spawnVFX("wind_trail",this._player.x,this._player.y,.7,6,.05),this._spawnVFX("smoke_poof",this._player.x-q.dx*.5,this._player.y-q.dy*.5,.5,6,.06),this._systems.audio.playSFX("dodge")}this._systems.classSystem.updateCooldowns(e),this._systems.weaponMastery.update(e),this._systems.equipment.updateCooldowns(e),this._systems.relationship.update(e);for(const[I,E]of this._skillBuffs){const A=E-e;A<=0?(this._skillBuffs.delete(I),this._ui.notify(`${I.replace(/_/g," ")} faded`,"#9ca3af")):this._skillBuffs.set(I,A)}this._trackingRevealTimer>0&&(this._trackingRevealTimer-=e);const a=(Fi[this._systems.classSystem.className]?.skills??[]).filter(I=>I!=="basic_attack"&&I!=="dodge_roll"),r=["KeyZ","KeyX"];for(let I=0;I<r.length&&I<a.length;I++){if(!this._input.wasPressed(r[I]))continue;const E=a[I],A=bs[E];if(!A)continue;if(this._systems.classSystem.level<A.unlockLevel){this._ui.notify(`${A.name} unlocks at level ${A.unlockLevel}`,"#ef4444"),this._systems.audio.playSFX("error");continue}if(this._systems.classSystem.isOnCooldown(E)){const O=this._systems.classSystem.getCooldown(E);this._ui.notify(`${A.name} on cooldown (${O.toFixed(1)}s)`,"#f59e0b");continue}const q=Math.round(A.staminaCost*(1+this._systems.classSystem.getPassiveBonus("stamina_cost")));if(ke.current[this._player.eid]<q){this._ui.notify("Not enough stamina!","#ef4444"),this._systems.audio.playSFX("error");continue}if(this._systems.statusEffects.isStunned()||this._systems.statusEffects.isFrozen())continue;ke.current[this._player.eid]=Math.max(0,ke.current[this._player.eid]-q);const Ce=this._systems.classSystem.getPassiveBonus("spell_echo");Ce<=0||Math.random()>=Ce?this._systems.classSystem.triggerCooldown(E):(this._ui.notify("Spell Echo!","#a78bfa"),this._spawnVFX("magic_rune",this._player.x,this._player.y,.6,6,.05));const Ve=this._systems.classSystem.getSkillRank(E),Pe=1+(Ve>1?(Ve-1)*A.rankBonus:0),D=this._player.str+(this._inventory.getEquipmentStats().damage??0),N=Math.round(D*A.damage*Pe);this._executeClassSkill(E,A,N)}this._player.isAttacking&&(this._player.attackTimer-=e,this._player.attackTimer<=0&&(this._player.isAttacking=!1,this._player.attackTimer=0));const n=this._systems.endgame.modifiers;let l=n?.enemyDamageMult??1;this._systems.festival.hasActiveEvent("blood_moon")&&(l*=1.5),this._systems.festival.hasActiveEvent("corruption_surge")&&(l*=1.3);const h=this._systems.skills.getModifier("defense");h>1&&(l/=h),this._systems.combat.setEnemyDamageMult(l);let c=n?.corruptionSpeedMult??1;this._systems.festival.hasActiveEvent("corruption_surge")&&(c*=2),this._systems.corruption.setSpreadMultiplier(c),this._systems.titan.setRespawnMultiplier(n?.titanRespawnMult??1);const d=this._systems.classSystem.getPassiveBonus("health"),u=this._systems.skills.getModifier("max_hp");if(d>0||u>1){const I=100+(this._player.level-1)*12,E=this._inventory.getEquipmentStats().health??0;x.max[this._player.eid]=Math.round((I+E)*(1+d)*u)}const f=this._systems.skills.getModifier("max_stamina");if(f>1){const I=ke.max[this._player.eid]??100;ke.max[this._player.eid]=Math.round(I*f)}const m=this._inventory.getEquipmentStats().defense,_=this._systems.classSystem.getPassiveBonus("defense");this._systems.combat.setPlayerDefense(Math.round(m*(1+_)));let p=1;for(const I of this._systems.equipment.getAllLegendaryEffects())I.id==="undead_bane"&&(p+=I.magnitude);const g=this._systems.equipment.getWeaponType();if(g&&g!=="fist"&&(p*=this._systems.weaponMastery.getTotalDamageMultiplier(g)),this._systems.shadowWorld.isInShadow){const I=Math.floor(this._player.x/L),E=Math.floor(this._player.y/L);this._systems.shadowWorld.getShadowEnemyModifiers(I,E);const A=this._systems.shadowWorld.getDistortionEffects(I,E);p*=A.damageMod}if(this._skillBuffs.has("damage_boost")&&(p*=1.3),this._skillBuffs.has("poison_blade"))for(const I of this._enemies){if(!I.alive)continue;const E=I.x-this._player.x,A=I.y-this._player.y;E*E+A*A<2500&&this._player.isAttacking&&(x.current[I.eid]=Math.max(0,(x.current[I.eid]??0)-3),this._particles.emit(I.x,I.y,"#4ade80",3,15,.2))}(x.current[this._player.eid]??0)/(x.max[this._player.eid]??100)<.3&&(p*=1+this._systems.classSystem.getPassiveBonus("low_hp_damage"));const S=this._systems.classSystem.getPassiveBonus("corruption_damage");if(S>0){const I=Math.floor(this._player.x/L),E=Math.floor(this._player.y/L);this._systems.corruption.getCorruptionAt(I,E)>0&&(p*=1+S)}const b=this._systems.classSystem.getPassiveBonus("elemental_damage");b>0&&g==="staff"&&(p*=1+b),this._systems.profession.hasBonus("blacksmith","weapon_damage_10")&&(p*=1.1),this._skillBuffs.has("meal_buff")&&(p*=1.15),p*=this._systems.skills.getModifier("attack"),this._systems.combat.setBonusDamageMult(p),this._systems.combat.setCritChanceBonus(this._systems.classSystem.getPassiveBonus("critChance")+this._systems.skills.getAdditiveModifier("crit_chance")),this._systems.combat.setCritDamageBonus(this._systems.classSystem.getPassiveBonus("critDamage"));const w=this._systems.classSystem.getPassiveBonus("aggro_reduction");this._systems.combat.setAggroReduction(w+(this._skillBuffs.has("stealth")?.5:0)),this._skillBuffs.has("invulnerable")&&this._systems.combat.setPlayerDefense(9999);const k=x.current[this._player.eid]??0;this._systems.combat.update(e,this._player,this._enemies);const T=this._systems.combat.consumeParryEvents();for(const I of T){I.perfect?(this._spawnVFX("nova_burst",this._player.x,this._player.y,1.2,8,.04),this._spawnVFX("energy_swirl",I.enemyX,I.enemyY,.8,6,.05),this._camera.shake(5,.2),this._hitPauseTimer=.1,this._camera.zoomPulse(.06,.2),this._particles.emit(this._player.x,this._player.y,"#ffdd00",12,60,.5),this._ui.notify("PERFECT PARRY!","#ffd700"),this._systems.audio.playSFX("parry")):(this._spawnVFX("spike_burst",this._player.x,this._player.y,.7,6,.05),this._camera.shake(3,.15),this._hitPauseTimer=.04,this._particles.emit(this._player.x,this._player.y,"#aaccff",6,40,.3),this._ui.notify("Parried!","#88bbff"),this._systems.audio.playSFX("parry")),I.reflectDmg>0&&this._spawnDamagePopup(I.enemyX,I.enemyY,I.reflectDmg,I.perfect);const E=this._systems.classSystem.getPassiveBonus("counter_chance");if(E>0&&Math.random()<E){const A=Math.round((this._player.str+10)*1.5),q=this._enemies.find(Ce=>Ce.alive&&Math.abs(Ce.x-I.enemyX)<10&&Math.abs(Ce.y-I.enemyY)<10);q&&(x.current[q.eid]=Math.max(0,(x.current[q.eid]??0)-A),this._spawnDamagePopup(q.x,q.y,A,!0),this._spawnVFX("claw_slash",q.x,q.y,1,6,.04),this._ui.notify("COUNTER!","#ff8800"),q.alive||this._onEnemyKilled(q))}}const M=x.current[this._player.eid]??0;if(M<k&&k>0){let I=k-M;const E=this._systems.classSystem.getPassiveBonus("corruption_resist");if(E>0){const N=Math.floor(this._player.x/L),O=Math.floor(this._player.y/L);if(this._systems.corruption.getCorruptionAt(N,O)>0){const G=Math.round(I*E);G>0&&(x.current[this._player.eid]=Math.min(x.max[this._player.eid]??100,(x.current[this._player.eid]??0)+G),I-=G)}}const A=I/(x.max[this._player.eid]??100);this._damageFlash=Math.min(.4,.1+A*.8),this._spawnVFX("spike_burst",this._player.x,this._player.y,.6,6,.05);const q=Math.min(8,3+A*15);this._camera.shake(q,.15+A*.2);const Ce=["chest","helmet","legs","boots"],Ve=Ce[Math.floor(Math.random()*Ce.length)];this._systems.equipment.degradeSlot(Ve)&&(this._ui.notify(`Your ${Ve} armor BROKE!`,"#ff4444","#881111",4),this._systems.audio.playSFX("error"));const D=this._systems.equipment.triggerEffects("onDamaged");for(const N of D)if(N.effectId==="berserker_rage")M/(x.max[this._player.eid]??100)<.3&&(this._ui.notify("BERSERKER RAGE!","#ff4400","#881100",3),this._spawnVFX("flame_rise",this._player.x,this._player.y,1.2,8,.05),this._particles.emit(this._player.x,this._player.y,"#ff4400",12,60,.8));else if(N.effectId==="void_resistance"){const O=Math.round(I*N.magnitude);O>0&&(x.current[this._player.eid]=Math.min(x.max[this._player.eid]??100,M+O),this._spawnDamagePopup(this._player.x,this._player.y-15,O,!1,!0))}}if(this._systems.crafting.setMaterialCostReduction(this._systems.profession.hasBonus("blacksmith","material_cost_-20")?.2:0),this._systems.crafting.update(e,this._inventory)){const I=this._systems.crafting.lastCompletedRecipe;this._ui.notify("Craft complete!","#44ff44"),this._systems.audio.playSFX("craft"),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,.8,6,.07),this._spawnVFX("smoke_poof",this._player.x,this._player.y-10,.6,6,.06),this._systems.achievement.progress("first_craft"),this._systems.achievement.progress("craft_50"),I&&(this._systems.quest.onCraft(I.output.itemId,I.output.count),this._checkQuestCompletion()),I&&I.station==="alchemy_table"&&this._systems.profession.hasBonus("alchemist","potion_yield_2x")&&(this._inventory.addItem(I.output.itemId,I.output.count),this._ui.notify("Double potion yield!","#44ccff")),I&&(I.station==="forge"||I.station==="workbench")&&this._systems.profession.hasBonus("blacksmith","masterwork_chance_15")&&Math.random()<.15&&(this._inventory.addItem(I.output.itemId,1),this._ui.notify("Masterwork! Bonus item crafted!","#ffcc44"),this._spawnVFX("magic_rune",this._player.x,this._player.y,.8,6,.06)),this._craftingStation==="cooking_fire"?this._awardSkillXP("cooking",10):this._craftingStation==="alchemy_table"?this._awardSkillXP("alchemy",10):this._awardSkillXP("smithing",10);const E=this._systems.profession.activeProfession;E==="blacksmith"&&(this._craftingStation==="forge"||this._craftingStation==="workbench")?this._awardProfXP("blacksmith",20):E==="alchemist"&&this._craftingStation==="alchemy_table"?this._awardProfXP("alchemist",15):E==="cook"&&this._craftingStation==="cooking_fire"&&this._awardProfXP("cook",20),this._craftingStation==="cooking_fire"&&this._systems.achievement.progress("cook_10"),E==="enchanter"&&this._craftingStation==="enchanting_table"&&this._awardProfXP("enchanter",25),this._syncProfessionRecipes()}const P=this._systems.gameTime.hour,R=this._systems.weather.current==="rain"||this._systems.weather.current==="heavy_rain"||this._systems.weather.current==="storm";this._entityRegistry.updateNPCAI(this._ecsWorld,e,this._player.x,this._player.y,P,R,500*500),this._ecsPipeline.execute(this._ecsWorld,e);{let I=this._systems.profession.hasBonus("farmer","growth_speed_20")?.2:0;this._systems.festival.hasActiveEvent("natural_spring")&&(I+=1),this._systems.farming.setGrowthSpeedBonus(I),this._systems.farming.setAllSeasonGrow(this._systems.profession.hasBonus("farmer","all_season_grow"));const E=this._systems.weather.current==="rain"||this._systems.weather.current==="heavy_rain"||this._systems.weather.current==="storm";this._systems.farming.update(e,this._systems.gameTime,E)}{const I=this._systems.gameTime,E=Qe.current[this._player.eid]??100,A=this._systems.corruption.getCorruptionAt(Math.floor(this._player.x/L),Math.floor(this._player.y/L));this._currentBiome&&this._systems.survival.setBiomeTemp(this._currentBiome.temperature),this._systems.survival.setHungerDrainMult(this._systems.skills.getModifier("hunger_drain"));let q=!1,Ce=!1;for(const Pe of this._systems.colony.settlements)for(const D of Pe.structures){if(D.buildProgress<1)continue;const N=D.tileX*L,O=D.tileY*L,G=this._player.x-N,Y=this._player.y-O,Q=G*G+Y*Y;(D.type==="forge"||D.type==="cooking_station")&&Q<6400&&(q=!0),Q<3600&&(Ce=!0)}this._viewMode.mode===se.TOP_DOWN&&this._state.view.interiorId&&(Ce=!0),this._systems.survival.setNearFire(q),this._systems.survival.setInShelter(Ce);const Ve=this._systems.survival.updateEnvironmentOnly(e,I,A,E);Ve>0&&(x.current[this._player.eid]=Math.max(0,(x.current[this._player.eid]??100)-Ve))}this._player.updateAnimation(e);{const I=this._player.facing===3?"Left":"Right",E=this._player.isAttacking?"Attack01":this._player.isMoving?"Run":"Idle",A=`player_${I}_${E}`,q=this._textureRegistry.getId(A);q>0&&(ye.textureId[this._player.eid]=q)}for(const I of this._enemies){if(!I.alive)continue;const E=I.def.spriteType;if(!E)continue;const A=`enemy_${E}_${I.spriteDir}_Idle`,q=this._textureRegistry.getId(A);q>0&&(ye.textureId[I.eid]=q)}const B=this._isoRenderer.worldToScreen(this._player.x,this._player.y);this._camera.follow(B.sx,B.sy,.1),this._camera.update(e);const F=Js(this._player.x/L,this._player.y/L);this._biomeAmbient.setBiome(F,v.width,v.height),this._biomeAmbient.update(e);{const I=this._systems.gameTime,E=I.isNight||this._systems.festival.hasActiveEvent("eclipse");this._lighting.setTimeOfDay(I.hour,E,this._systems.weather.def.lightReduction),this._lighting.update(e),this._playerLightId<0&&(this._playerLightId=this._lighting.addLight(v.width/2,v.height/2,180,.75,"#ffcc66",!0)),this._lighting.moveLight(this._playerLightId,v.width/2,v.height/2)}{const I=this._systems.gameTime,E=I.isNight?"Night":I.isDawn?"Dawn":I.isDusk?"Dusk":"Day";if(this._prevTimePhase&&E!==this._prevTimePhase){const A={Dawn:["The sun rises...","#fbbf24"],Day:["Daylight returns.","#f59e0b"],Dusk:["The sun sets...","#c2410c"],Night:["Darkness falls. Beware.","#6366f1"]},[q,Ce]=A[E]??["","#888"];q&&this._ui.notify(q,Ce),E==="Dawn"?this._systems.audio.playSFX("level_up",.6):E==="Night"&&this._systems.audio.playSFX("alert",.5)}this._prevTimePhase=E}if(this._currentBiome?.id!==F.id&&(this._currentBiome=F,this._biomeBannerAlpha=3,this._biomeBannerName=F.name,this._biomeBannerIcon=F.icon,this._systems.quest.onReach(F.id),this._checkQuestCompletion(),!this._discoveredBiomes.has(F.id))){this._discoveredBiomes.add(F.id);const I=50*this._discoveredBiomes.size;this._player.addXP(I),this._ui.notify(`Discovered: ${F.name}! +${I} XP`,F.icon,"#ffd700",5),this._camera.shake(3,.3),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,1.2,8,.06),this._particles.emitSparkle(this._player.x,this._player.y),this._systems.achievement.progress("explorer"),this._systems.achievement.progress("first_steps"),this._discoveredBiomes.size>=2&&this._systems.achievement.progress("biome_2"),this._discoveredBiomes.size>=7&&this._systems.achievement.progress("all_biomes")}this._biomeBannerAlpha>0&&(this._biomeBannerAlpha-=e);const W=this._currentBiome?.id??"haven",X=this._systems.weather.current??"clear",$=this._systems.temperature.update(e,W,this._systems.gameTime,X,this._player.x,this._player.y);$.healthDrain>0&&(x.current[this._player.eid]=Math.max(0,(x.current[this._player.eid]??100)-$.healthDrain)),$.staminaDrain>0&&(ke.current[this._player.eid]=Math.max(0,(ke.current[this._player.eid]??100)-$.staminaDrain)),$.hazardMessage&&!this._tempHazardCooldown&&(this._ui.notify($.hazardMessage,"#ef4444"),this._tempHazardCooldown=!0,setTimeout(()=>{this._tempHazardCooldown=!1},5e3),this._awardSkillXP("survival",2)),this._systems.cooking.update(e,this._inventory,this._systems.gameTime.day)&&(this._systems.cooking.activeCook,this._ui.notify("Cooking complete! Check your inventory.","#fbbf24"),this._systems.audio.playSFX("craft"));const te=this._systems.cooking.getTotalBuffStats();if(te.health&&te.health>0){const I=x.max[this._player.eid]??100;x.current[this._player.eid]=Math.min(I,(x.current[this._player.eid]??0)+te.health*e*.01)}const K=this._systems.classSystem.getPassiveBonus("forest_regen");if(K>0&&(W==="haven"||W==="rotwood")){const I=x.max[this._player.eid]??100;x.current[this._player.eid]=Math.min(I,(x.current[this._player.eid]??0)+K*e*.5)}const ee=this._systems.classSystem.getPassiveBonus("purification");if(ee>0){const I=Math.floor(this._player.x/L),E=Math.floor(this._player.y/L);this._systems.corruption.purifyRadius(I,E,Math.ceil(ee),.01*e)}if(this._purifierTickTimer=(this._purifierTickTimer??0)+e,this._purifierTickTimer>=2){this._purifierTickTimer=0;for(const I of this._systems.colony.settlements)for(const E of I.structures)E.type==="purifier"&&E.buildProgress>=1&&this._systems.corruption.purifyRadius(E.tileX,E.tileY,10,.02)}if(this._killStreakTimer>0&&(this._killStreakTimer-=e,this._killStreakTimer<=0&&(this._killStreak=0)),this._dpsWindow.length>0||this._dpsTimer>0){for(let I=this._dpsWindow.length-1;I>=0;I--)this._dpsWindow[I].time-=e,this._dpsWindow[I].time<=0&&(this._dpsWindow[I]=this._dpsWindow[this._dpsWindow.length-1],this._dpsWindow.pop());if(this._dpsWindow.length>0){const I=this._dpsWindow.reduce((A,q)=>A+q.dmg,0),E=Math.max(.5,3-Math.min(...this._dpsWindow.map(A=>A.time)));this._dpsValue=Math.round(I/E)}this._dpsWindow.length===0?(this._dpsTimer-=e,this._dpsTimer<=0&&(this._dpsValue=0)):this._dpsTimer=2}this._levelUpFlash>0&&(this._levelUpFlash-=e),this._damageFlash>0&&(this._damageFlash-=e),this._critFlash>0&&(this._critFlash-=e),this._comboMilestoneFlash>0&&(this._comboMilestoneFlash-=e),this._festivalActivityCooldown>0&&(this._festivalActivityCooldown-=e),this._particles.update(e),this._envParticleTimer-=e,this._envParticleTimer<=0&&this._envParticles.length<120&&(this._envParticleTimer=.15+Math.random()*.2,this._spawnBiomeParticle());for(let I=this._envParticles.length-1;I>=0;I--){const E=this._envParticles[I];if(E.x+=E.vx*e,E.y+=E.vy*e,E.life-=e,E.alpha=Math.min(1,E.life/E.maxLife*2)*.6,E.life<=0){const A=this._envParticles.length-1;I!==A&&(this._envParticles[I]=this._envParticles[A]),this._envParticles.length=A}}if(this._chimneySmokeTimer-=e,this._chimneySmokeTimer<=0&&this._buildings.length>0){this._chimneySmokeTimer=.8+Math.random()*.5;const I=this._buildings.filter(E=>E.def.id==="tavern"||E.def.id==="forge"||E.def.id==="cooking_station");if(I.length>0){const E=I[Math.floor(Math.random()*I.length)],A=E.tileX*L+E.def.widthTiles*L*.7,q=E.tileY*L-4;this._envParticles.push({x:A+(Math.random()-.5)*4,y:q,vx:(Math.random()-.5)*3+1,vy:-8-Math.random()*6,life:3+Math.random()*2,maxLife:5,color:"#9ca3af",size:2+Math.random()*2,alpha:.3})}}if(this._footstepTimer-=e,this._player.isMoving&&this._footstepTimer<=0){const I=this._player.isSprinting?.12:.22;this._footstepTimer=I,this._footstepSoundCount=(this._footstepSoundCount??0)+1,this._footstepSoundCount%3===0&&this._systems.audio.playSFX("footstep");const E=this._currentBiome?.id??"haven",A=E==="ashlands"?"#8b5a2b":E==="bone_wastes"?"#c8c8c0":E==="drowned_depths"?"#2d5f3f":E==="the_void"?"#4338ca":"#a0845c";for(let q=0;q<2;q++)this._envParticles.push({x:this._player.x+(Math.random()-.5)*8,y:this._player.y+4+Math.random()*4,vx:(Math.random()-.5)*15,vy:-3-Math.random()*8,life:.4+Math.random()*.3,maxLife:.7,color:A,size:1+Math.random()*1.5,alpha:.5})}if(this._statusEffectParticleTimer-=e,this._statusEffectParticleTimer<=0){this._statusEffectParticleTimer=.3;for(const I of this._systems.statusEffects.effects){const E=this._player.x,A=this._player.y;I.id==="burn"?this._particles.emit(E+(Math.random()-.5)*12,A-4,"#ff6600",2,15,.4):I.id==="poison"||I.id==="curse"?this._particles.emit(E+(Math.random()-.5)*10,A+4,"#44ff44",1,10,.5):I.id==="freeze"?this._particles.emit(E+(Math.random()-.5)*12,A,"#88ddff",2,12,.4):I.id==="bleed"?this._particles.emit(E+(Math.random()-.5)*8,A+2,"#cc0000",1,8,.3):I.id==="regen"?this._particles.emit(E+(Math.random()-.5)*10,A-6,"#44ff88",1,-8,.6):I.id==="shield"?this._particles.emit(E+(Math.random()-.5)*14,A,"#4488ff",2,-5,.5):I.id==="speed_boost"?this._particles.emit(E-6,A+6,"#ffee44",1,5,.3):I.id==="stun"?this._particles.emit(E+(Math.random()-.5)*8,A-12,"#ffff88",1,-4,.4):I.id==="slow"&&this._particles.emit(E+(Math.random()-.5)*10,A+4,"#6688aa",1,3,.5)}}if(this._heartbeatTimer-=e,this._heartbeatTimer<=0){const I=this._player.maxHealth>0?this._player.health/this._player.maxHealth:1;I<.25&&I>0?(this._heartbeatTimer=.8+I*2.8,this._systems.audio.playSFX("heartbeat")):this._heartbeatTimer=.5}const ue=new Set;for(const I of this._enemies)!I.alive||!I.isChasing||(ue.add(I.eid),this._prevEnemyChasingSet.has(I.eid)||(this._enemyAggroAlerts.push({x:I.x,y:I.y-24,timer:.8}),this._systems.audio.playSFX("alert")));this._prevEnemyChasingSet=ue;for(let I=this._enemyAggroAlerts.length-1;I>=0;I--)this._enemyAggroAlerts[I].timer-=e,this._enemyAggroAlerts[I].timer<=0&&(this._enemyAggroAlerts[I]=this._enemyAggroAlerts[this._enemyAggroAlerts.length-1],this._enemyAggroAlerts.pop());this._systems.combat.comboCount===0&&(this._prevComboTier=0),this._systems.achievement.setProgress("combo_10",this._systems.combat.comboCount);const be=this._systems.achievement.recentTimer;if(be>3.5&&this._prevAchievementTimer<=3.5&&be>0){this._particles.emit(this._player.x,this._player.y,"#ffd700",20,60,1),this._particles.emit(this._player.x,this._player.y,"#ffffff",10,40,.6),this._spawnVFX("star_explosion",this._player.x,this._player.y,1.2,8,.06),this._spawnVFX("sparkle_burst",this._player.x,this._player.y-15,.8,6,.07),this._camera.shake(4,.25),this._systems.audio.playSFX("quest_complete");const I=this._systems.achievement.recentUnlock;I?.reward&&(I.reward.gold&&(this._player.gold+=I.reward.gold,this._ui.notify(`+${I.reward.gold} gold!`,"#ffd700")),I.reward.itemId&&I.reward.itemCount&&(this._inventory.addItem(I.reward.itemId,I.reward.itemCount),this._ui.notify(`Received ${I.reward.itemCount}x ${I.reward.itemId.replace(/_/g," ")}`,"#4ade80")))}this._prevAchievementTimer=be;const fe=this._systems.story.getCurrentQuest()?.id??null;this._prevStoryQuestId!==null&&fe===null&&this._systems.story.getCompletedCount()>0&&(this._particles.emitLevelUp(this._player.x,this._player.y),this._particles.emit(this._player.x,this._player.y,"#fbbf24",15,50,.8),this._spawnVFX("magic_rune",this._player.x,this._player.y,1,10,.06),this._spawnVFX("sparkle_collect",this._player.x,this._player.y-10,.8,6,.07),this._camera.shake(6,.3),this._levelUpFlash=1.5,this._systems.audio.playSFX("quest_complete"),this._systems.mail.sendQuestComplete(this._prevStoryQuestId,this._systems.gameTime.day,[{itemId:"health_potion",count:2}])),this._prevStoryQuestId=fe;for(let I=this._xpNotifications.length-1;I>=0;I--){const E=this._xpNotifications[I];if(E.timer-=e,E.y-=20*e,E.timer<=0){const A=this._xpNotifications.length-1;I!==A&&(this._xpNotifications[I]=this._xpNotifications[A]),this._xpNotifications.length=A}}for(let I=this._lootNotifications.length-1;I>=0;I--){const E=this._lootNotifications[I];if(E.timer-=e,E.timer<=0){const A=this._lootNotifications.length-1;I!==A&&(this._lootNotifications[I]=this._lootNotifications[A]),this._lootNotifications.length=A}}for(let I=this._damagePopups.length-1;I>=0;I--){const E=this._damagePopups[I];if(E.timer-=e,E.y+=E.vy*e,E.vy*=.96,E.timer<=0){const A=this._damagePopups.length-1;I!==A&&(this._damagePopups[I]=this._damagePopups[A]),this._damagePopups.length=A}}for(let I=this._vfxSprites.length-1;I>=0;I--){const E=this._vfxSprites[I];if(E.timer+=e,E.timer>=E.frameDuration&&(E.timer-=E.frameDuration,E.frame++,E.frame>=E.totalFrames)){const A=this._vfxSprites.length-1;I!==A&&(this._vfxSprites[I]=this._vfxSprites[A]),this._vfxSprites.length=A}}for(let I=this._respawnQueue.length-1;I>=0;I--){const E=this._respawnQueue[I];if(E.timer-=e,E.timer<=0){const A=Math.random()*Math.PI*2,q=50+Math.random()*100,Ce=E.x+Math.cos(A)*q,Ve=E.y+Math.sin(A)*q,Pe=new ei(this._ecsWorld,E.def,Ce,Ve,this._sprites);this._applyNGPlusHealthScaling(Pe),this._enemies.push(Pe),this._entityRegistry.registerEnemy(Pe);const D=this._respawnQueue.length-1;I!==D&&(this._respawnQueue[I]=this._respawnQueue[D]),this._respawnQueue.length=D}}if(this._enemyPruneTimer+=e,this._enemyPruneTimer>=5){this._enemyPruneTimer=0,this._entityRegistry.pruneDeadEnemies(this._ecsWorld);let I=0;for(let E=0;E<this._enemies.length;E++)this._enemies[E].alive&&(this._enemies[I++]=this._enemies[E]);this._enemies.length=I}this._updateWorldDrops(e),this._updateResources(e),this._updateNearestNPC(),this._updateNearestBuilding(),this._systems.rift.update(e,this._player.x,this._player.y,this._systems.corruption.globalCorruption),this._nearRift=null;const ve=60,ae=ve*ve;for(const I of this._systems.rift.rifts){if(I.active)continue;const E=this._player.x-I.worldX,A=this._player.y-I.worldY,q=E*E+A*A;q<ae&&(!this._nearRift||q<this._nearRift.distSq)&&(this._nearRift={id:I.id,dist:Math.sqrt(q),distSq:q})}if(this._ui.dialog)this._handleDialogueInput();else if(this._showShop)this._handleShopInput();else{if(this._input.wasPressed("KeyE")&&!this._showInventory&&this._tryInteractWithNPC(),(this._input.wasPressed("KeyI")||this._input.wasPressed("Tab"))&&(this._showInventory=!this._showInventory,this._showInventory&&(this._showShop=!1,this._showQuestPanel=!1,this._inventorySelectedSlot=0)),this._showInventory){const N=this._inventory.capacity-1;if(this._input.wasPressed("ArrowRight")&&(this._inventorySelectedSlot=Math.min(N,this._inventorySelectedSlot+1)),this._input.wasPressed("ArrowLeft")&&(this._inventorySelectedSlot=Math.max(0,this._inventorySelectedSlot-1)),this._input.wasPressed("ArrowDown")&&(this._inventorySelectedSlot=Math.min(N,this._inventorySelectedSlot+6)),this._input.wasPressed("ArrowUp")&&(this._inventorySelectedSlot=Math.max(0,this._inventorySelectedSlot-6)),this._input.wasPressed("KeyS")&&(this._inventory.sort(),this._ui.notify("Inventory sorted","#88ccff")),this._input.wasPressed("KeyF")){const O=this._inventory.toggleFavorite(this._inventorySelectedSlot),G=this._inventory.getSlot(this._inventorySelectedSlot);if(G){const Y=pe(G.itemId);this._ui.notify(O?`Locked ${Y?.name??G.itemId}`:`Unlocked ${Y?.name??G.itemId}`,O?"#f59e0b":"#888")}}if(this._input.wasPressed("Enter")||this._input.wasPressed("Space")){const O=this._inventory.getSlot(this._inventorySelectedSlot);if(O){const G=pe(O.itemId);if(G&&(G.category==="consumable"||G.category==="potion"||G.category==="food")){if(G.healAmount){const Y=Math.min(G.healAmount,this._player.maxHealth-this._player.health);x.current[this._player.eid]=Math.min(this._player.maxHealth,this._player.health+Y),this._spawnDamagePopup(this._player.x,this._player.y,Y,!1,!0)}this._inventory.removeItem(O.itemId,1),this._ui.notify(`Used ${G.name}`,"#4ade80"),this._systems.audio.playSFX("heal"),this._particles.emitHeal(this._player.x,this._player.y),this._particles.emitFlowerHeal(this._player.x,this._player.y)}else if(G&&(G.category==="weapon"||G.category==="armor"||G.category==="tool")){if(this._inventory.equip(this._inventorySelectedSlot),this._syncLegendaryEffects(),this._ui.notify(`Equipped ${G.name}`,"#a78bfa"),G.legendaryEffect){const Y=Ra[G.legendaryEffect];Y&&this._ui.notify(`Legendary: ${Y.name}`,"#ffd700","#886600",4)}this._systems.audio.playSFX("pickup")}}}}if(this._input.wasPressed("KeyC")&&(this._showEquipment=!this._showEquipment),this._input.wasPressed("KeyQ")&&(this._showQuestPanel=!this._showQuestPanel,this._showQuestPanel&&(this._showShop=!1,this._systems.tutorial.completeAction("open_quests"))),this._input.wasPressed("KeyR")&&(this._showCrafting=!this._showCrafting,this._showCrafting&&(this._showShop=!1,this._craftingScrollIdx=0,this._systems.tutorial.completeAction("open_crafting"))),this._showCrafting){const D=this._systems.crafting.getAvailableRecipes(this._craftingStation);if(this._input.wasPressed("ArrowUp")&&(this._craftingScrollIdx=Math.max(0,this._craftingScrollIdx-1)),this._input.wasPressed("ArrowDown")&&(this._craftingScrollIdx=Math.min(D.length-1,this._craftingScrollIdx+1)),this._input.wasPressed("Enter")&&D[this._craftingScrollIdx]){const G=D[this._craftingScrollIdx],Y=this._input.isHeld("ControlLeft")||this._input.isHeld("ControlRight")?99:this._input.isHeld("ShiftLeft")||this._input.isHeld("ShiftRight")?5:1;let Q=0;for(let he=0;he<Y&&this._systems.crafting.canCraft(G.id,this._inventory);he++)if(this._systems.crafting.startCraft(G.id,this._inventory))Q++;else break;if(Q>0){const he=Q>1?` x${Q}`:"";this._ui.notify(`Crafting ${G.name}${he}...`,"#ffcc44")}else if(this._systems.crafting.activeCraft)this._ui.notify("Already crafting! Wait for it to finish.","#ff8844");else if(!this._inventory.canAddItem(G.output.itemId,G.output.count))this._ui.notify("Inventory full!","#ff4444");else{const he=[];for(const Oe of G.materials){const qe=this._inventory.countItem(Oe.itemId);qe<Oe.count&&he.push(`${Oe.itemId.replace(/_/g," ")} (${qe}/${Oe.count})`)}he.length>0?this._ui.notify(`Need: ${he.join(", ")}`,"#ff4444"):this._ui.notify("Cannot craft (level too low?)","#ff4444")}}const N=["Digit1","Digit2","Digit3","Digit4","Digit5"],O=["hand","workbench","forge","alchemy_table","cooking_fire","enchanting_table"];for(let G=0;G<N.length;G++)this._input.wasPressed(N[G])&&(this._craftingStation=O[G],this._craftingScrollIdx=0)}if(this._input.wasPressed("KeyB")&&(this._buildMode=!this._buildMode,this._buildMode&&(this._systems.tutorial.completeAction("enter_build_mode"),this._buildCursorX=Math.floor(this._player.x/L),this._buildCursorY=Math.floor(this._player.y/L))),this._buildMode&&((this._input.wasPressed("ArrowUp")||this._input.wasPressed("Numpad8"))&&this._buildCursorY--,(this._input.wasPressed("ArrowDown")||this._input.wasPressed("Numpad2"))&&this._buildCursorY++,(this._input.wasPressed("ArrowLeft")||this._input.wasPressed("Numpad4"))&&this._buildCursorX--,(this._input.wasPressed("ArrowRight")||this._input.wasPressed("Numpad6"))&&this._buildCursorX++,this._input.wasPressed("BracketLeft")&&(this._buildSelectedType=(this._buildSelectedType-1+Yt.length)%Yt.length),this._input.wasPressed("BracketRight")&&(this._buildSelectedType=(this._buildSelectedType+1)%Yt.length),this._input.wasPressed("Enter")||this._input.wasPressed("Space"))){const D=Yt[this._buildSelectedType],N=It[D];let O=!1;for(let G=0;G<N.widthTiles&&!O;G++)for(let Y=0;Y<N.heightTiles&&!O;Y++){const Q=Zi(this._buildCursorX+G,this._buildCursorY+Y,Vt);(Q.type===6||Q.type===7)&&(O=!0)}if(O)this._ui.notify("Cannot build on water!","#ff4444");else{let G=!1;for(const Y of this._systems.colony.settlements){for(const Q of Y.structures){const ne=It[Q.type],he=ne.widthTiles,Oe=ne.heightTiles;if(this._buildCursorX<Q.tileX+he&&this._buildCursorX+N.widthTiles>Q.tileX&&this._buildCursorY<Q.tileY+Oe&&this._buildCursorY+N.heightTiles>Q.tileY){G=!0;break}}if(G)break}if(G)this._ui.notify("Already a structure here!","#ff4444");else{const Y=this._systems.profession.hasBonus("builder","build_cost_-25")?.75:1;let Q=!0;for(const ne of N.buildCost){const he=Math.max(1,Math.ceil(ne.count*Y));if(!this._inventory.hasItem(ne.itemId,he)){Q=!1,this._ui.notify(`Need ${he} ${ne.itemId}`,"#ff4444");break}}if(Q){for(const qe of N.buildCost){const Ye=Math.max(1,Math.ceil(qe.count*Y));this._inventory.removeItem(qe.itemId,Ye)}let ne=this._systems.colony.getNearestSettlement(this._buildCursorX*L,this._buildCursorY*L);ne||(ne=this._systems.colony.createSettlement("New Settlement",this._buildCursorX*L,this._buildCursorY*L)),ne.buildSpeedMult=this._systems.profession.hasBonus("builder","build_speed_30")?1.3:1,ne.structureHpMult=this._systems.profession.hasBonus("builder","structure_hp_50")?1.5:1,ne.placeStructure(D,this._buildCursorX,this._buildCursorY),this._ui.notify(`Built ${N.name}!`,"#44ff44"),console.log(`[Build] Placed ${N.name} at (${this._buildCursorX}, ${this._buildCursorY})`);const he=this._buildCursorX*L+N.widthTiles*L/2,Oe=this._buildCursorY*L+N.heightTiles*L/2;this._spawnVFX("smoke_explosion",he,Oe,1.2,10,.06),this._spawnVFX("sparkle_burst",he,Oe,.8,8,.07),this._particles.emit(he,Oe,"#ffcc44",12,40,.6),this._particles.emit(he,Oe,"#aa8866",8,30,.4),this._camera.shake(3,.2),this._systems.audio.playSFX("craft"),this._systems.quest.onBuild(D),this._systems.achievement.progress("first_building"),this._systems.achievement.progress("settlement"),this._checkQuestCompletion(),this._awardSkillXP("leadership",8),this._systems.profession.activeProfession==="builder"&&this._awardProfXP("builder",30)}}}}if(this._input.wasPressed("KeyF")){const D=Math.floor(this._player.x/L),N=Math.floor(this._player.y/L),O=this._systems.farming.getPlotAt(D,N);if(O)if(this._nearFarmPlot=O,O.state==="ready"){const G=this._systems.farming.harvest(O);if(G){let Y=G.count;if(this._systems.profession.hasBonus("farmer","triple_harvest_15")&&Math.random()<.15&&(Y*=3,this._ui.notify("Triple harvest!","#ffcc44")),this._inventory.addItem(G.itemId,Y),this._systems.quest.onCollect(G.itemId,Y),this._checkQuestCompletion(),this._ui.notify(`Harvested ${Y}x ${G.itemId.replace(/_/g," ")}!`,"#88cc44"),this._particles.emitPickup(this._player.x,this._player.y),this._systems.audio.playSFX("pickup"),this._systems.profession.hasBonus("farmer","rare_seeds")&&Math.random()<.15){const Q=["moonpetal_seed","firebloom_seed","frostberry_seed"],ne=Q[Math.floor(Math.random()*Q.length)];this._inventory.addItem(ne,1),this._ui.notify(`Found rare seed: ${ne.replace(/_/g," ")}!`,"#ffaa44")}this._awardSkillXP("foraging",12),this._systems.profession.activeProfession==="farmer"&&this._awardProfXP("farmer",25)}}else O.state==="empty"?this._showFarmUI=!this._showFarmUI:(O.state==="planted"||O.state==="growing")&&(this._systems.farming.water(O),this._ui.notify("Watered crop!","#4488ff"));else this._inventory.hasItem("wood",2)&&(this._inventory.removeItem("wood",2),this._systems.farming.createPlot(D,N),this._ui.notify("Created farm plot! (2 wood)","#88aa44"))}if(this._showFarmUI&&this._nearFarmPlot){const D=["wheat","carrot","potato","tomato","corn","herb_crop"];if(this._input.wasPressed("ArrowUp")&&(this._farmSelectedSeed=Math.max(0,this._farmSelectedSeed-1)),this._input.wasPressed("ArrowDown")&&(this._farmSelectedSeed=Math.min(D.length-1,this._farmSelectedSeed+1)),this._input.wasPressed("Enter")){const N=D[this._farmSelectedSeed],O=N+"_seed";if(this._inventory.hasItem(O,1)){const G=this._systems.gameTime.season;this._systems.farming.plant(this._nearFarmPlot,N,G)?(this._inventory.removeItem(O,1),this._ui.notify(`Planted ${N}!`,"#66aa44"),this._showFarmUI=!1):this._ui.notify("Wrong season for this crop!","#ff4444")}else this._ui.notify(`Need ${O.replace(/_/g," ")}!`,"#ff4444")}this._input.wasPressed("Escape")&&(this._showFarmUI=!1)}if(this._input.wasPressed("KeyH")){const D=Math.floor(this._player.x/L),N=Math.floor(this._player.y/L),G=["sprinkler","scarecrow","beehive","compost_bin"].map(Y=>{const ne=xa[Y].cost.map(he=>`${he.count}x ${he.itemId.replace(/_/g," ")}`).join(", ");return{text:`${Y.replace(/_/g," ")} (${ne})`,action:`farm_struct_${Y}`}});G.push({text:"Cancel",action:"close"}),this._ui.showDialog("Farm","","Place a farm structure? Structures affect nearby farm plots.",G,Y=>{const Q=G[Y];if(!Q||Q.action==="close")return;const ne=Q.action.replace("farm_struct_",""),he=xa[ne];let Oe=!0;for(const qe of he.cost)if(!this._inventory.hasItem(qe.itemId,qe.count)){Oe=!1,this._ui.notify(`Need ${qe.count}x ${qe.itemId.replace(/_/g," ")}`,"#ff4444");break}if(Oe){for(const qe of he.cost)this._inventory.removeItem(qe.itemId,qe.count);this._systems.farming.placeStructure(ne,D,N),this._ui.notify(`Placed ${ne.replace(/_/g," ")}! (radius: ${he.baseRadius} tiles)`,"#44cc44"),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,.6,6,.06),this._systems.audio.playSFX("craft")}})}const I=this._currentBiome?.id??"haven";if(this._input.wasPressed("KeyG")&&!this._showFishing){let D=!1;const N=3,O=Math.floor(this._player.x/L),G=Math.floor(this._player.y/L);for(let Y=-N;Y<=N&&!D;Y++)for(let Q=-N;Q<=N&&!D;Q++){const ne=Zi(O+Y,G+Q,Vt);(ne.type===6||ne.type===7)&&(D=!0)}if(!D)this._ui.notify("No water nearby to fish!","#888888");else{const Y=this._systems.fishing,Q=[],ne=["wooden","iron","steel","mithril","void"];for(const Ye of ne){const at=Y._equippedRod===Ye?`${Ye} [equipped]`:Ye,dt={wooden:0,iron:3,steel:6,mithril:9,void:12}[Ye],gt=Y.fishLevel<dt;Q.push({text:gt?`${Ye} (Lvl ${dt})`:at.charAt(0).toUpperCase()+at.slice(1),action:gt?"locked":`rod_${Ye}`})}const he=[{text:"No bait",action:"bait_none"}],Oe=["worm","cricket","minnow","glowgrub","blood_leech","void_larva"];for(const Ye of Oe){const at=Y.getBaitCount(Ye);at>0&&he.push({text:`${Ye} (${at})`,action:`bait_${Ye}`})}const qe=[{text:"Cast now!",action:"cast"},...Q.filter(Ye=>Ye.action!=="locked"),...he];this._ui.showDialog("Fishing","",`Rod: ${Y.equippedRod.name} | Bait: ${Y.equippedBait?.name??"None"}`,qe,Ye=>{const at=qe[Ye];if(at){if(at.action==="cast"){this._showFishing=!0;const dt=this._systems.gameTime;Y.cast(I,dt.season,dt.isNight?"night":"day",this._systems.weather.current),this._ui.notify("Casting line...","#4488cc")}else if(at.action.startsWith("rod_")){const dt=at.action.replace("rod_","");Y.equipRod(dt),this._ui.notify(`Equipped ${dt} rod!`,"#4488cc")}else if(at.action==="bait_none")Y.unequipBait(),this._ui.notify("Bait removed","#888");else if(at.action.startsWith("bait_")){const dt=at.action.replace("bait_","");Y.equipBait(dt),this._ui.notify(`Using ${dt} bait!`,"#4488cc")}}})}}if(this._showFishing){this._systems.fishing.update(e);const D=this._systems.fishing.state;if(D==="bite"&&this._input.wasPressed("Space")&&(this._systems.fishing.hookFish(),this._ui.notify("HOOKED! Hold Space to reel!","#ffcc00")),D==="reeling"&&(this._input.isHeld("Space")?this._systems.fishing.reel(e):this._systems.fishing.releaseLine(e)),D==="caught"){const N=this._systems.fishing.collectFish();if(N){const O=N.fishDef.id??"raw_fish";this._inventory.addItem(O,1)>0&&(this._worldDrops.push({x:this._player.x,y:this._player.y,itemId:O,count:1,timer:30,bobPhase:Math.random()*Math.PI*2,gold:0}),this._ui.notify("Inventory full! Fish dropped.","#ff8844")),this._ui.notify(`Caught ${N.fishDef.name}! Worth ${N.value}g`,"#44ff88"),this._inventory.addGold(N.value),this._particles.emitPickup(this._player.x,this._player.y),this._spawnVFX("sparkle_collect",this._player.x,this._player.y,.6,6,.06),this._systems.audio.playSFX("pickup"),this._systems.achievement.progress("first_catch"),this._awardSkillXP("fishing",10+(N.fishDef.rarity==="rare"?15:0)),this._systems.profession.activeProfession==="hunter"&&this._awardProfXP("hunter",15+(N.fishDef.rarity==="rare"?20:0));const Y=this._systems.cooking.onMaterialAcquired?.(O);if(Y&&Y.length>0)for(const Q of Y)this._ui.notify(`Recipe discovered: ${Q}!`,"#ffcc44","#886633",4);N.fishDef.rarity==="legendary"&&this._systems.achievement.progress("catch_legendary")}this._showFishing=!1}D==="lost"&&(this._ui.notify("Fish got away!","#ff6644"),this._showFishing=!1),D==="idle"&&this._showFishing&&(this._showFishing=!1,this._ui.notify("Line went slack...","#888")),this._input.wasPressed("Escape")&&(this._systems.fishing.cancel(),this._showFishing=!1)}if(this._input.wasPressed("KeyT")&&(this._showTechTree=!this._showTechTree,this._techScrollIdx=0),this._showTechTree){const D=this._systems.techTree.getAvailableTechs();if(this._input.wasPressed("ArrowUp")&&(this._techScrollIdx=Math.max(0,this._techScrollIdx-1)),this._input.wasPressed("ArrowDown")&&(this._techScrollIdx=Math.min(D.length-1,this._techScrollIdx+1)),this._input.wasPressed("Enter")&&D[this._techScrollIdx]){const N=D[this._techScrollIdx];this._systems.techTree.startResearch(N.id)?this._ui.notify(`Researching ${N.name}...`,"#6366f1"):this._ui.notify("Already researching!","#ff4444")}this._input.wasPressed("Escape")&&(this._showTechTree=!1)}this._input.wasPressed("KeyU")&&!this._showInventory&&!this._showCrafting&&!this._showStorage&&(this._input.isHeld("ShiftLeft")||this._input.isHeld("ShiftRight")?this._minimap.removeNearestWaypoint(this._player.x,this._player.y,200)?this._ui.notify("Waypoint removed","#888"):this._ui.notify("No nearby waypoint","#888"):(this._minimap.addWaypoint(this._player.x,this._player.y,"","#fbbf24"),this._ui.notify("Waypoint placed!","#fbbf24"),this._systems.audio.playSFX("menu_click")));const E=this._systems.techTree.update(e);E&&(this._ui.notify(`Research complete: ${E}!`,"#a78bfa"),this._spawnVFX("magic_rune",this._player.x,this._player.y,.8,8,.06),this._systems.audio.playSFX("quest_complete"),this._camera.shake(3,.2));const A=this._systems.corruption.events;for(const D of A)switch(D.type){case"outbreak":this._ui.notify(` Corruption outbreak at ${Math.floor(D.x)}, ${Math.floor(D.y)}!`,"#9333ea"),this._particles.emitCorruption(D.x,D.y),this._camera.shake(4,.3);break;case"raid":{const O=(D.faction?mt[D.faction]:null)?.name??D.faction??"Unknown";this._ui.notify(` ${O} raid incoming!`,"#ef4444"),this._camera.shake(6,.4),this._systems.audio.playSFX("damage");const Y=this._systems.corruption.getActiveRaids().find(Q=>Math.abs(Q.targetX-D.x)<50&&Math.abs(Q.targetY-D.y)<50);if(Y){const Q=D.faction?this._systems.faction.getMutationModifiers(D.faction):null;for(let ne=0;ne<Y.enemyCount;ne++){const he=Y.enemyTypes[ne%Y.enemyTypes.length],Oe=Qs[he];if(!Oe)continue;const qe=Math.random()*Math.PI*2,Ye=40+Math.random()*120,at=Y.targetX+Math.cos(qe)*Ye,dt=Y.targetY+Math.sin(qe)*Ye,gt=new ei(this._ecsWorld,Oe,at,dt,this._sprites);Q&&(x.max[gt.eid]=(x.max[gt.eid]??Oe.health)+Q.healthBonus,x.current[gt.eid]=x.max[gt.eid],Cs.amount[gt.eid]=Math.round((Cs.amount[gt.eid]??Oe.damage)*Q.damageMultiplier)),this._applyNGPlusHealthScaling(gt),this._enemies.push(gt),this._entityRegistry.registerEnemy(gt)}this._spawnVFX("smoke_explosion",Y.targetX,Y.targetY,1.5,10,.06)}break}case"commander_spawn":{const N=D.faction,O=N?this._systems.faction.checkCommanderSpawn(N):null;if(O){this._ui.notify(` ${O.name} has appeared!`,"#dc2626");const G=O.faction?mt[O.faction].enemyTypes[0]:"skeleton_grunt",Y=Qs[G];if(Y){const Q=new ei(this._ecsWorld,Y,D.x,D.y,this._sprites);x.max[Q.eid]=O.health,x.current[Q.eid]=O.health,Q.isCommander=!0,Q.commanderDef=O,this._applyNGPlusHealthScaling(Q),this._enemies.push(Q),this._entityRegistry.registerEnemy(Q)}}else this._ui.notify(" A corrupted commander has appeared!","#dc2626");this._particles.emit(D.x,D.y,"#dc2626",15,50,.8),this._camera.shake(5,.3);break}case"titan_stir":this._ui.notify(" A titan stirs in the corruption...","#f97316"),this._camera.shake(8,.5);break}const q=this._systems.faction.getActiveWars();for(const D of q){const N=this._player.x-D.locationX,O=this._player.y-D.locationY;if(Math.sqrt(N*N+O*O)<300&&!D.playerIntervened&&this._input.wasPressed("KeyJ")){const Y=mt[D.attackerFaction],Q=mt[D.defenderFaction];this._ui.showDialog("Faction War","",`${Y.name} vs ${Q.name}! Choose a side to intervene.`,[{text:`Help ${Y.name}`,action:`war_side_${D.attackerFaction}`},{text:`Help ${Q.name}`,action:`war_side_${D.defenderFaction}`},{text:"Stay out of it",action:"war_ignore"}],ne=>{ne===0?(this._systems.faction.interveneInWar(D.id,D.attackerFaction),this._ui.notify(`Joined ${Y.name}! Their enemies weaken.`,Y.color),this._player.xp+=50):ne===1&&(this._systems.faction.interveneInWar(D.id,D.defenderFaction),this._ui.notify(`Joined ${Q.name}! Their enemies weaken.`,Q.color),this._player.xp+=50)});break}}if(this._systems.tutorial.isActive&&(this._systems.tutorial.resetFrameGuard(),this._systems.tutorial.update(e),this._player.isMoving&&this._systems.tutorial.completeAction("move"),this._input.wasPressed("KeyE")&&this._systems.tutorial.completeAction("interact"),(this._input.wasPressed("Space")||this._input.state.mouseClicked)&&this._systems.tutorial.completeAction("attack"),this._showInventory&&this._systems.tutorial.completeAction("open_inventory"),this._systems.tutorial.currentStep&&(!this._systems.tutorial.currentStep.requiredAction&&this._input.wasPressed("Space")&&this._systems.tutorial.advance(),this._input.wasPressed("Escape")&&(this._systems.tutorial.skip(),this._escConsumed=!0))),this._systems.cutscene.isActive&&this._systems.cutscene.update(e),this._input.wasPressed("KeyV")&&!this._showInventory&&!this._showCrafting){const D=this._systems.shadowWorld,N=ke.current[this._player.eid]??0,O=D.getPhaseStaminaCost();if(D.canPhaseShift&&N>=O){if(D.startPhaseShift(N)){ke.current[this._player.eid]=Math.max(0,N-O);const Y=D.currentLayer==="normal"?"Shadow":"Normal";this._ui.notify(`Shifting to ${Y} world...`,"#a855f7"),this._camera.shake(3,.4),this._systems.audio.playSFX("level_up"),this._systems.tutorial.hasCompleted("first_shadow_phase")||(this._systems.tutorial.completeAction("first_shadow_phase"),this._ui.notify("Shadow world: 2x XP, stronger enemies, rare resources!","#c084fc"),this._ui.notify("Press V again to return to the normal world.","#9ca3af"))}}else if(D.canPhaseShift)this._ui.notify("Not enough stamina to phase shift!","#ff4444"),this._systems.audio.playSFX("error");else{const G=Math.ceil(D.phaseCooldown);this._ui.notify(`Phase shift on cooldown (${G}s)`,"#888"),this._systems.audio.playSFX("error")}}if(this._systems.shadowWorld.isInShadow){const D=Math.floor(this._player.x/L),N=Math.floor(this._player.y/L),O=this._systems.shadowWorld.getDistortionEffects(D,N);O.speedMod!==1&&(U.vx[this._player.eid]*=O.speedMod,U.vy[this._player.eid]*=O.speedMod)}const Ce=this._systems.shadowWorld.phaseCooldown;this._prevPhaseCooldown>0&&Ce<=0&&this._ui.notify("Phase shift ready!","#a855f7"),this._prevPhaseCooldown=Ce;{let D=1;const N=this._systems.cooking.getTotalBuffStats().speed??0;N>0&&(D*=1+N*.01);const O=this._systems.classSystem.getPassiveBonus("speed");O>0&&(D*=1+O),$.speedModifier<1&&(D*=$.speedModifier),D!==1&&(U.vx[this._player.eid]=(U.vx[this._player.eid]??0)*D,U.vy[this._player.eid]=(U.vy[this._player.eid]??0)*D)}if(this._input.wasPressed("F3")&&(this._showDebug=!this._showDebug),this._input.wasPressed("F5")&&this._performSave("Quick Save"),this._input.wasPressed("F9")&&this._performLoad(),this._systems.save.update(e)&&this._performSave("Auto Save",!0),this._input.wasPressed("F1")&&(this._showControls=!this._showControls),this._input.wasPressed("KeyN")&&(this._showMail=!this._showMail,this._mailScrollIdx=0,this._systems.audio.playSFX("menu_click")),this._showMail){const D=this._systems.mail.inbox;if(this._input.wasPressed("ArrowUp")&&(this._mailScrollIdx=Math.max(0,this._mailScrollIdx-1)),this._input.wasPressed("ArrowDown")&&(this._mailScrollIdx=Math.min(D.length-1,this._mailScrollIdx+1)),this._input.wasPressed("Enter")&&D[this._mailScrollIdx]){const N=D[this._mailScrollIdx];if(this._systems.mail.readMail(N.id),!N.claimed&&N.attachments.length>0){const O=this._systems.mail.claimAttachments(N.id);for(const G of O)this._inventory.addItem(G.itemId,G.count),this._lootNotifications.length<15&&this._lootNotifications.push({text:`+${G.count} ${G.itemId.replace(/_/g," ")}`,timer:2.5,color:"#4ade80"});this._systems.audio.playSFX("pickup"),this._spawnVFX("sparkle_collect",this._player.x,this._player.y,.8,6,.06)}}this._input.wasPressed("Escape")&&(this._showMail=!1)}if(this._input.wasPressed("Backspace")&&this._systems.titan.allTitansDefeated()){const D=this._systems.endgame.computeGoldCarryover(this._player.gold),N=this._player.gold-D;this._player.gold=D;const O=this._systems.endgame.startNewGamePlus();this._ui.notify(`NEW GAME+ Cycle ${this._systems.endgame.ngPlusCycle}!`,"#ffd700"),this._ui.notify(`Enemies: x${O.enemyHealthMult.toFixed(1)} HP, x${O.enemyDamageMult.toFixed(1)} DMG`,"#ff8888"),this._ui.notify(`Loot: +${Math.round(O.lootRarityBonus*100)}% rarity, XP: x${O.xpMult.toFixed(1)}`,"#88ff88"),N>0&&this._ui.notify(`Carried ${D}g into the new cycle (lost ${N}g)`,"#fbbf24"),this._camera.shake(10,.8),this._spawnVFX("nova_burst",this._player.x,this._player.y,2,12,.05),this._systems.audio.playSFX("level_up")}if(!this._showStorage){const D=this._systems.storage.getNearby(this._player.x,this._player.y,50);if(D.length>0&&this._input.wasPressed("KeyE")&&!this._talkingToNpc){const N=D[0];N.locked?(this._systems.minigame.lockpick.start(N.lockDifficulty),this._systems.minigame.startMinigame("lockpick"),this._showMinigame=!0,this._activeContainer=N,this._ui.notify(" Locked! Pick the lock...","#f59e0b")):(this._activeContainer=N,this._showStorage=!0,this._storageScrollIdx=0,this._systems.audio.playSFX("menu_click"))}}if(this._showStorage&&this._activeContainer){if(this._input.wasPressed("ArrowUp")&&(this._storageScrollIdx=Math.max(0,this._storageScrollIdx-1)),this._input.wasPressed("ArrowDown")&&(this._storageScrollIdx=Math.min(this._activeContainer.items.length-1,this._storageScrollIdx+1)),this._input.wasPressed("Enter")&&this._activeContainer.items[this._storageScrollIdx]){const D=this._activeContainer.items[this._storageScrollIdx];this._systems.storage.removeItem(this._activeContainer.id,D.itemId,1)&&(this._inventory.addItem(D.itemId,1),this._lootNotifications.length<15&&this._lootNotifications.push({text:`+1 ${D.itemId.replace(/_/g," ")}`,timer:2,color:"#4ade80"}),this._systems.audio.playSFX("pickup"),this._spawnVFX("sparkle_collect",this._player.x,this._player.y,.6,4,.05))}if(this._input.wasPressed("Tab")){const D=this._inventory.getSlot(this._inventorySelectedSlot);D&&(this._systems.storage.addItem(this._activeContainer.id,D.itemId,1),this._inventory.removeItem(D.itemId,1),this._ui.notify(`Stored ${D.itemId.replace(/_/g," ")}`,"#88ccff"),this._systems.audio.playSFX("menu_click"))}if(this._input.wasPressed("KeyQ")){const D=this._systems.storage.quickStack(this._activeContainer.id,this._inventory);D>0?(this._ui.notify(`Quick stacked ${D} items`,"#4ade80"),this._systems.audio.playSFX("pickup")):this._ui.notify("Nothing to stack","#888")}if(this._input.wasPressed("KeyD")){const D=this._systems.storage.depositAll(this._activeContainer.id,this._inventory);D>0?(this._ui.notify(`Deposited ${D} items`,"#4ade80"),this._systems.audio.playSFX("pickup")):this._ui.notify("Nothing to deposit","#888")}if(this._input.wasPressed("KeyL")){const D=this._systems.storage.lootAll(this._activeContainer.id,this._inventory);D>0?(this._ui.notify(`Looted ${D} items`,"#fbbf24"),this._systems.audio.playSFX("pickup")):this._ui.notify("Chest is empty","#888")}this._input.wasPressed("Escape")&&(this._showStorage=!1,this._activeContainer=null)}if(this._showMinigame&&this._systems.minigame.activeGame==="lockpick"&&(this._systems.minigame.lockpick.update(e),this._input.wasPressed("Space")&&(this._systems.minigame.lockpick.tryPick()?this._systems.audio.playSFX("hit"):this._camera.shake(2,.1)),this._systems.minigame.lockpick.state==="won"?(this._systems.minigame.endMinigame(),this._showMinigame=!1,this._activeContainer&&(this._systems.storage.unlock(this._activeContainer.id),this._showStorage=!0,this._storageScrollIdx=0,this._ui.notify(" Lock picked!","#44ff88"),this._systems.audio.playSFX("pickup"))):this._systems.minigame.lockpick.state==="lost"&&(this._systems.minigame.endMinigame(),this._showMinigame=!1,this._activeContainer=null,this._ui.notify(" Lockpick broke!","#ff4444")),this._input.wasPressed("Escape")&&(this._systems.minigame.endMinigame(),this._showMinigame=!1,this._activeContainer=null)),this._showMinigame&&this._systems.minigame.activeGame==="archery"){const D=this._systems.minigame.archery;if(D.update(e),this._input.wasPressed("Space")){const N=D.shoot();N>=10?(this._ui.notify(` Bullseye! +${N}`,"#fbbf24"),this._camera.shake(3,.15)):N>=5?this._ui.notify(` Good shot! +${N}`,"#22c55e"):N>0?this._ui.notify(` +${N}`,"#9ca3af"):this._ui.notify("Miss!","#ef4444"),this._systems.audio.playSFX("hit")}if(D.state==="won"){const N=D.score*10;this._player.xp+=N,this._ui.notify(` Archery win! Score: ${D.score}/50  +${N} XP`,"#fbbf24"),this._systems.audio.playSFX("quest_complete"),this._systems.minigame.endMinigame(),this._showMinigame=!1}else D.state==="lost"&&(this._ui.notify(`Archery over. Score: ${D.score}/30  not enough!`,"#ef4444"),this._systems.minigame.endMinigame(),this._showMinigame=!1);this._input.wasPressed("Escape")&&(this._systems.minigame.endMinigame(),this._showMinigame=!1)}const Pe=this._systems.gameTime.day;if(Pe!==this._lastDay){this._lastDay=Pe;const D=this._systems.festival.checkFestival(this._systems.gameTime.season,this._systems.gameTime.dayOfSeason);D&&Pe!==this._lastFestivalDay&&(this._lastFestivalDay=Pe,this._ui.notify(` ${D.name} has begun!`,"#fbbf24"),this._systems.mail.sendFestivalNotice(D.name,Pe),this._systems.audio.playSFX("level_up"));const N=this._systems.festival.rollDailyEvents(Pe);for(const G of N)if(this._ui.notify(`${G.icon} ${G.name}: ${G.description}`,"#a78bfa"),this._systems.mail.send("Town Crier",G.name,G.description,"event",Pe),G.id==="merchant_caravan"&&this._systems.mail.sendMerchantArrival("Traveling Merchant",Pe),G.choices&&G.choices.length>0){const Y=G.choices,Q=Y.map(ne=>({text:ne.text,action:ne.text}));this._ui.showDialog("Town Crier",G.icon,G.description,Q,ne=>{const he=Y[ne];he&&(this._ui.notify(he.outcome,"#a78bfa"),he.reward&&(this._inventory.addItem(he.reward.itemId,he.reward.count),this._ui.notify(`+${he.reward.count} ${he.reward.itemId.replace(/_/g," ")}`,"#44ff88")))});break}this._systems.mail.checkDailyReward(Pe),this._systems.quest.generateDailyContracts(Pe,this._player.level),this._ui.notify("New daily contracts available!","#fbbf24");const O=this._systems.shop.checkArrival(Pe);O&&(this._ui.notify(`${O.name} has arrived! (3 days)`,"#e879f9"),this._systems.audio.playSFX("quest_complete")),this._systems.achievement.setProgress("play_10h",this._systems.save.playTime),this._checkStoryCutscenes()}if(this._input.wasPressed("KeyP")&&this._systems.festival.activeFestival)if(this._festivalActivityCooldown>0)this._ui.notify(`Wait ${Math.ceil(this._festivalActivityCooldown)}s to participate again.`,"","#888");else{const D=this._systems.festival.activeFestival,N=Math.floor(Math.random()*D.activities.length),O=this._systems.festival.participateActivity(N);O&&(this._festivalActivityCooldown=30,this._ui.notify(`${O.message}`,"","#fbbf24"),O.reward&&(this._inventory.addItem(O.reward.itemId,O.reward.count),this._ui.notify(`+${O.reward.count} ${O.reward.itemId.replace(/_/g," ")}`,"","#44ff88")),O.goldReward>0&&(this._inventory.addGold(O.goldReward),this._ui.notify(`+${O.goldReward}g`,"","#ffd700")),O.xpReward>0&&(this._player.addXP(O.xpReward)&&this._handleLevelUp(),this._spawnFloatingXp(this._player.x,this._player.y,O.xpReward)),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,.8,6,.06),this._systems.audio.playSFX("quest_complete"),this._systems.achievement.progress("festival_goer"))}this._systems.achievement.setProgress("rich",this._player.gold),this._systems.quest.onSurviveTick(e)}this._ui.update(e);const Me=Math.floor(this._player.x/256),Le=Math.floor(this._player.y/256);for(let I=-2;I<=2;I++)for(let E=-2;E<=2;E++)this._minimap.revealChunk(Me+E,Le+I);this._state.player.x=this._player.x,this._state.player.y=this._player.y,this._state.player.isMoving=this._player.isMoving}_updateResources(e){const t=this._player.x,i=this._player.y,s=60;let a=null,r=1/0;const n=s*s;for(const l of this._resources){if(l.depleted){l.respawnTimer-=e,l.respawnTimer<=0&&(l.depleted=!1,l.health=l.maxHealth);continue}const h=l.x-t,c=l.y-i,d=h*h+c*c;d<n&&d<r&&(r=d,a=l)}if(this._nearestResource=a,a&&this._input.wasPressed("KeyE")){a.health--,this._systems.audio.playSFX("gather");const l=Lr[a.type]?.color??"#888";if(this._particles.emit(a.x,a.y,l,3,20,.3),this._spawnVFX("dust_puff",a.x,a.y,.6,6,.06),this._systems.equipment.degradeSlot("weapon")&&this._ui.notify("Your tool BROKE!","#ff4444","#881111",3),a.health<=0){const c=Lr[a.type];if(c){let d=c.amount[0]+Math.floor(Math.random()*(c.amount[1]-c.amount[0]+1));this._systems.profession.hasBonus("miner","ore_plus_1")&&(c.drop.includes("ore")||c.drop.includes("stone"))&&(d+=1),this._systems.profession.hasBonus("miner","double_ore_20")&&(c.drop.includes("ore")||c.drop.includes("stone"))&&Math.random()<.2&&(d*=2,this._ui.notify("Double ore!","#ffcc44")),this._inventory.addItem(c.drop,d),this._systems.quest.onCollect(c.drop,d),this._checkQuestCompletion();const u=this._systems.crafting.onMaterialAcquired(c.drop);for(const m of u)this._ui.notify(`Recipe discovered: ${this._systems.crafting.getRecipeName(m)}!`,"#ffcc44","#886633",4);this._lootNotifications.length<15&&this._lootNotifications.push({text:`+${d} ${c.drop}`,timer:2,color:c.color}),this._particles.emitPickup(a.x,a.y),this._systems.audio.playSFX("pickup");const f=a.type==="herb"||a.type==="mushroom";if(this._spawnVFX(f?"leaf_scatter":"shard_burst",a.x,a.y,.9,8,.06),c.drop.includes("ore")||c.drop.includes("stone")?this._awardSkillXP("mining",10):a.type==="herb"||a.type==="mushroom"?this._awardSkillXP("foraging",8):a.type==="tree"&&this._awardSkillXP("foraging",8),this._systems.profession.activeProfession==="miner"&&(c.drop.includes("ore")||c.drop.includes("stone"))&&this._awardProfXP("miner",15),this._systems.profession.hasBonus("miner","gem_discovery")&&(c.drop.includes("ore")||c.drop.includes("stone"))&&Math.random()<.1){const m=["ruby","emerald","sapphire"],_=m[Math.floor(Math.random()*m.length)];this._inventory.addItem(_,1),this._ui.notify(`Found a ${_}!`,"#ff44ff"),this._lootNotifications.length<15&&this._lootNotifications.push({text:`+1 ${_}`,timer:3,color:"#ff44ff"})}if(this._systems.profession.hasBonus("miner","void_ore")&&c.drop.includes("ore")&&Math.random()<.05&&(this._inventory.addItem("void_ore",1),this._ui.notify("Void ore discovered!","#a855f7"),this._lootNotifications.length<15&&this._lootNotifications.push({text:"+1 void ore",timer:3,color:"#a855f7"})),this._systems.profession.hasBonus("alchemist","rare_reagent_chance")&&(a.type==="herb"||a.type==="mushroom")&&Math.random()<.12){const m=["moonpetal","firebloom","spore_cap","corruption_essence"],_=m[Math.floor(Math.random()*m.length)];this._inventory.addItem(_,1),this._ui.notify(`Rare reagent: ${_.replace(/_/g," ")}!`,"#44ccff"),this._lootNotifications.length<15&&this._lootNotifications.push({text:`+1 ${_.replace(/_/g," ")}`,timer:3,color:"#44ccff"})}this._progressStoryObjective(c.drop.replace(/_/g," "),d)}if(this._systems.shadowWorld.isInShadow){const d=this._currentBiome?.id??"haven",u=this._systems.shadowWorld.getAvailableResources(Math.floor(a.x/L),Math.floor(a.y/L),d);if(u.length>0&&Math.random()<.3){const f=u[Math.floor(Math.random()*u.length)];this._inventory.addItem(f.id,1),this._systems.shadowWorld.gatherResource(f.id),this._ui.notify(`Shadow resource: ${f.name}!`,"#a855f7"),this._lootNotifications.length<15&&this._lootNotifications.push({text:`+1 ${f.name}`,timer:3,color:"#a855f7"})}}a.depleted=!0,a.respawnTimer=30+Math.random()*30}}}_updateWorldDrops(e){const t=this._player.x,i=this._player.y,s=this._systems.profession.hasBonus("hunter","beast_loot_20")?1.2:1,a=Math.round(24*s),r=Math.round(50*s);for(let n=this._worldDrops.length-1;n>=0;n--){const l=this._worldDrops[n];if(l.timer-=e,l.timer<=0){const u=this._worldDrops.length-1;n!==u&&(this._worldDrops[n]=this._worldDrops[u]),this._worldDrops.length=u;continue}const h=l.x-t,c=l.y-i,d=Math.sqrt(h*h+c*c);if(d<r&&d>a){const u=120*(1-d/r);l.x-=h/d*u*e,l.y-=c/d*u*e}if(d<a){if(l.gold>0)this._player.gold+=l.gold,this._spawnVFX("pickup_gold",l.x,l.y,.6,8,.06),this._lootNotifications.length<15&&this._lootNotifications.push({text:`+${l.gold} Gold`,timer:2,color:"#f59e0b"});else{l.affixes&&l.affixes.length>0?this._inventory.addItemWithAffixes(l.itemId,l.count,l.affixes):this._inventory.addItem(l.itemId,l.count);const f=pe(l.itemId),m=f?`${f.icon} ${f.name}`:l.itemId,_=l.affixes&&l.affixes.length>0?`${f?.icon??""} ${q_(f?.name??l.itemId,l.affixes)}`:m,p=f?rt[f.rarity]:"#4ade80",g=l.count>1?` x${l.count}`:"",y=f?.category==="potion"?"pickup_health":f?.category==="gem"?"pickup_gem":"sparkle_collect";this._spawnVFX(y,l.x,l.y,.6,8,.06);const S=f?.rarity??"common";if(S==="legendary"?(this._camera.shake(5,.5),this._spawnVFX("magic_rune",l.x,l.y,1.5,12,.1),this._spawnVFX("nova_burst",l.x,l.y,1.2,10,.06),this._particles.emit(l.x,l.y,"#ffd700",20,80,1),this._systems.audio.playSFX("level_up")):S==="epic"?(this._camera.shake(3,.3),this._spawnVFX("magic_rune",l.x,l.y,1,8,.08),this._particles.emit(l.x,l.y,"#a855f7",14,60,.8),this._systems.audio.playSFX("quest_complete")):S==="rare"&&(this._spawnVFX("sparkle_burst",l.x,l.y,.8,8,.07),this._particles.emit(l.x,l.y,"#facc15",10,50,.6),this._systems.audio.playSFX("hit")),this._lootNotifications.length<15&&this._lootNotifications.push({text:`${_}${g}`,timer:S==="legendary"?5:S==="epic"?4:2.5,color:p}),l.itemId){const b=this._systems.crafting.onMaterialAcquired(l.itemId);for(const w of b)this._ui.notify(`Recipe discovered: ${this._systems.crafting.getRecipeName(w)}!`,"#ffcc44","#886633",4)}}l.itemId&&(this._systems.quest.onCollect(l.itemId,l.count),this._checkQuestCompletion()),this._particles.emitPickup(l.x,l.y),this._systems.audio.playSFX("pickup");const u=this._worldDrops.length-1;n!==u&&(this._worldDrops[n]=this._worldDrops[u]),this._worldDrops.length=u}}}_updateNearestBuilding(){const t=n_(this._ecsWorld,this._player.x,this._player.y,55);let i=null,s=3025;for(const a of t){const r=this._buildingsByEid.get(a);if(!r)continue;const n=r.tileX*L+r.def.widthTiles*L/2,l=r.tileY*L+r.def.heightTiles*L/2,h=this._player.x-n,c=this._player.y-l,d=h*h+c*c;if(d<s){const u=r.def.features?.includes("dungeon")??!1,f=r.def.features?.includes("shop")||r.def.features?.includes("rest")||r.def.features?.includes("forge")||r.def.features?.includes("potions")||r.def.features?.includes("heal");if(u||f){const m=`[E] Enter ${r.def.name}`;s=d,i={building:r,label:m}}}}this._nearestBuilding=i}_updateNearestNPC(){if(this._talkingToNpc||this._showShop){this._nearestNPC=null;return}let e=null,t=5184;for(const i of this._npcs){if(i.isIndoors)continue;const s=i.x-this._player.x,a=i.y-this._player.y,r=s*s+a*a;r<t&&(t=r,e=i)}this._nearestNPC=e}_useHotbarItem(e){if(e<0||e>=this._inventory.slots.length)return;const t=this._inventory.slots[e];if(!t||t.count<=0)return;const i=pe(t.itemId);if(!i)return;if(!(i.category==="consumable"||i.category==="potion"||i.category==="food")){if((i.category==="weapon"||i.category==="armor"||i.category==="accessory")&&this._inventory.equip(e)){if(this._syncLegendaryEffects(),this._ui.notify(`Equipped ${i.name}`,i.icon,rt[i.rarity]),i.legendaryEffect){const r=Ra[i.legendaryEffect];r&&this._ui.notify(`Legendary: ${r.name}`,"#ffd700","#886600",4)}this._systems.audio.playSFX("menu_click"),this._spawnVFX("sparkle_spawn",this._player.x,this._player.y,.6,6,.06)}return}if(i.id==="stamina_potion"||i.id==="stamina_tonic"){const a=ke.max[this._player.eid]??100,r=ke.current[this._player.eid]??0;if(r>=a){this._ui.notify("Stamina already full!","","#ffaa44");return}const n=i.healAmount??40;ke.current[this._player.eid]=Math.min(a,r+n),this._ui.notify(`Used ${i.name} (+${n} Stamina)`,i.icon,"#ffaa44")}else if(i.healAmount&&i.healAmount>0){if(this._getActiveRiftModifiers().includes("cursed")){this._ui.notify("Cursed! Cannot heal inside the rift!","#884444");return}if(this._player.maxHealth-this._player.health<=0&&i.category==="potion"){this._ui.notify("Already at full health!","","#ff6666");return}let r=i.healAmount;if(i.category==="potion"&&this._systems.profession.hasBonus("alchemist","potion_heal_20")&&(r=Math.round(r*1.2)),i.category==="food"&&this._systems.profession.hasBonus("cook","meal_restore_25")&&(r=Math.round(r*1.25)),this._player.heal(r),i.category==="food"){rl(this._ecsWorld,r*.8),this._systems.survival.eat(r*.8),this._ui.notify(`Ate ${i.name} (+${r} HP)`,i.icon,"#88ff88");const n=Object.values(Pt).find(l=>l.output.itemId===i.id);if(n){this._systems.cooking.applyFoodBuff(n.id,"normal");const l=this._systems.cooking.getTotalBuffStats(),h=[];l.speed&&h.push(`+${l.speed}% speed`),l.luck&&h.push(`+${l.luck} luck`),l.fishingBonus&&h.push(`+${l.fishingBonus}% fishing`),l.gatheringBonus&&h.push(`+${l.gatheringBonus}% gathering`),h.length>0&&this._ui.notify(`Food buff: ${h.join(", ")}`,"#fbbf24")}this._systems.profession.hasBonus("cook","meal_combat_buff")&&(this._skillBuffs.set("meal_buff",60),this._ui.notify("Well-fed! +15% damage for 60s","#ffaa44"))}else this._ui.notify(`Used ${i.name} (+${r} HP)`,i.icon,"#ff6688")}if(i.id==="purification_potion"){const a=this._systems.corruption.purifyRadius(this._player.x/16,this._player.y/16,8,.4);this._spawnVFX("magic_circle",this._player.x,this._player.y,1.5,12,.08),this._particles.emitPurify(this._player.x,this._player.y),this._particles.emitMagicCircle(this._player.x,this._player.y),this._camera.shake(3,.2),this._ui.notify(`Purified ${a} tiles!`,i.icon,"#aaddff"),this._systems.quest.onPurify(a),this._checkQuestCompletion()}i.id==="torch"&&this._playerLightId>=0&&this._ui.notify("Torch lit! Brighter light for a while.",i.icon,"#ffcc44"),(i.id==="water_flask"||i.id==="herbal_tea"||i.id==="ale"||i.id==="berry_juice"||i.id==="milk"||i.id==="elixir_of_clarity")&&(this._systems.survival.drink(40),this._ui.notify(`Drank ${i.name}`,i.icon,"#4488ff")),this._inventory.removeItem(t.itemId,1),this._itemUseCooldown=.5,this._systems.audio.playSFX("pickup"),i.healAmount&&i.healAmount>0?(this._spawnVFX("flower_bloom",this._player.x,this._player.y,.8,8,.07),this._spawnVFX("flower_heal",this._player.x,this._player.y-10,.6,6,.08),this._spawnDamagePopup(this._player.x,this._player.y,i.healAmount,!1,!0,!1)):this._spawnVFX("sparkle_collect",this._player.x,this._player.y,.6,6,.07),this._particles.emit(this._player.x,this._player.y,"#00ff88",8,30,.5)}_performAttack(){this._player.isAttacking=!0,this._player.attackTimer=.3,this._attackCooldown=.45,this._attackSwingTimer=.15,this._attackArcTimer=.2;const e=[Math.PI/2,-Math.PI/2,0,Math.PI];this._attackArcAngle=e[this._player.facing]??Math.PI/2,this._systems.audio.playSFX("hit");for(const s of this._npcs){const a=s.x-this._player.x,r=s.y-this._player.y;a*a+r*r<14400&&s.flinch()}const t=this._systems.combat.playerAttack(this._player,this._enemies,this._inventory);t.length>0&&(this._attackArcDmgType=t[0].type);for(const s of t){const a=this._enemies.find(n=>n.eid===s.targetEid);if(!a)continue;this._dpsWindow.push({time:3,dmg:s.amount}),this._dpsTimer=3,this._spawnDamagePopup(a.x,a.y,s.amount,s.isCrit,!1,!0,s.type);const r=this._systems.classSystem.getPassiveBonus("mark_damage");if(r>0&&(s.isCrit&&(this._deathMarkedEids.add(a.eid),this._particles.emit(a.x,a.y-8,"#a855f7",4,20,.3)),this._deathMarkedEids.has(a.eid))){const n=Math.round(s.amount*r);x.current[a.eid]=Math.max(0,(x.current[a.eid]??0)-n),this._spawnDamagePopup(a.x,a.y-10,n,!1,!1,!0),a.alive||this._deathMarkedEids.delete(a.eid)}if(s.isCrit)this._spawnVFX("claw_slash",a.x,a.y,1.2,6,.05),this._particles.emitHit(a.x,a.y),this._particles.emitImpactBurst(a.x,a.y),this._particles.emit(a.x,a.y,"#ffdd00",6,40,.3);else{const n=["slash_cross","wind_slash","slash_line"][Math.floor(Math.random()*3)];this._spawnVFX(n,a.x,a.y,.8,6,.05,(Math.random()-.5)*.5),this._particles.emitSlash(a.x,a.y),this._particles.emit(a.x,a.y,"#ff6644",4,30,.25)}if(s.isCrit?(this._camera.shake(5,.2),this._camera.zoomPulse(.06,.18),this._hitPauseTimer=.05,this._critFlash=.12):this._camera.shake(2,.12),!a.alive){const n=(a.def.name??"").toLowerCase(),l=(a.def.id??"").toLowerCase();n.includes("slime")?(this._spawnVFX("blob_splash",a.x,a.y,1,8,.06),this._particles.emit(a.x,a.y,a.def.color??"#44ff44",14,50,.5)):l.includes("skeleton")||l.includes("bone")?(this._spawnVFX("shard_burst",a.x,a.y,1,8,.05),this._spawnVFX("smoke_poof",a.x,a.y,.6,6,.06),this._particles.emit(a.x,a.y,"#ccccaa",10,60,.5)):l.includes("wolf")||l.includes("beast")?(this._spawnVFX("smoke_explosion",a.x,a.y,.9,8,.06),this._particles.emit(a.x,a.y,"#884444",8,50,.4)):l.includes("cultist")||l.includes("mage")||l.includes("necromancer")?(this._spawnVFX("energy_swirl",a.x,a.y,1.1,8,.05),this._spawnVFX("nova_burst",a.x,a.y,.6,6,.06),this._particles.emit(a.x,a.y,"#aa44ff",10,60,.5)):l.includes("wisp")||l.includes("phantom")||l.includes("wraith")?(this._spawnVFX("nova_burst",a.x,a.y,1,8,.05),this._particles.emit(a.x,a.y,"#8888ff",12,70,.6)):l.includes("goblin")?(this._spawnVFX("smoke_explosion",a.x,a.y,.8,8,.06),this._particles.emit(a.x,a.y,"#66aa44",8,50,.4)):(this._spawnVFX("smoke_explosion",a.x,a.y,1,8,.06),this._particles.emit(a.x,a.y,"#ff4444",8,50,.4)),this._spawnVFX("destroy_effect",a.x,a.y,.8,8,.05),this._spawnVFX("sparkle_collect",a.x,a.y,.7,6,.07),this._particles.emitDeath(a.x,a.y),this._particles.emit(a.x,a.y,"#ffd700",12,70,.6),this._camera.shake(6,.25),this._camera.zoomPulse(.1,.25),this._hitPauseTimer=.08,this._onEnemyKilled(a)}}if(t.length>0){if(this._systems.equipment.degradeSlot("weapon"))this._ui.notify("Your weapon BROKE!","#ff4444","#881111",4),this._systems.audio.playSFX("error");else{const h=this._systems.equipment.getEquipped("weapon");h&&h.durability>0&&h.durability<=h.maxDurability*.25&&h.durability===Math.floor(h.maxDurability*.25)&&this._ui.notify("Weapon durability LOW!","#ff8844","#884400",3)}let a=0,r=!1,n=!1;for(const h of t){a+=h.amount,h.isCrit&&(r=!0);const c=this._enemies.find(d=>d.eid===h.targetEid);c&&!c.alive&&(n=!0)}const l=this._systems.equipment.triggerEffects("onHit");for(const h of l)this._processLegendaryEffect(h.effectId,h.magnitude,t[0]);if(r){const h=this._systems.equipment.triggerEffects("onCrit");for(const c of h)this._processLegendaryEffect(c.effectId,c.magnitude,t[0])}if(n){const h=this._systems.equipment.triggerEffects("onKill");for(const c of h)this._processLegendaryEffect(c.effectId,c.magnitude,t[0])}if(a>0){const h=this._systems.equipment.getAllLegendaryEffects().find(u=>u.id==="lifesteal_aura"),c=this._systems.skills.getAdditiveModifier("lifesteal"),d=(h?.magnitude??0)+c;if(d>0){const u=Math.max(1,Math.round(a*d)),f=x.max[this._player.eid]??100;x.current[this._player.eid]=Math.min(f,(x.current[this._player.eid]??0)+u),this._spawnDamagePopup(this._player.x,this._player.y-20,u,!1,!0)}}}if(t.length>0){const s=this._systems.equipment.getWeaponType();if(s&&s!=="fist"){const a=5+t.length*2,r=this._systems.weaponMastery.addXP(s,a);for(const n of r)this._ui.notify(`${n.weaponIcon} ${n.weaponName} mastery Lv${n.newLevel}!`,"#c084fc"),n.unlockedSkill&&this._ui.notify(`Unlocked: ${n.unlockedSkill.name}`,"#a78bfa")}}if(t.length>0){const s=this._systems.combat.comboTier;if(s>this._prevComboTier&&s>=1){const a=mo[s]??"D",r=ls[s]??"#aaaaaa",n=4+s*2,l=.04+s*.02;this._camera.shake(n,.3),this._hitPauseTimer=Math.max(this._hitPauseTimer,l);const h=10+s*5;this._particles.emit(this._player.x,this._player.y,r,h,50+s*15,.6+s*.1);const c=["energy_swirl","nova_burst","spike_burst","flame_rise","tentacle_burst"],d=c[Math.min(s-1,c.length-1)];this._spawnVFX(d,this._player.x,this._player.y,.8+s*.2,8,.05),this._particles.emitFireSwoosh(this._player.x,this._player.y),this._comboMilestoneFlash=.6,this._comboMilestoneTier=s;const u=ud[s-1]??0;this._xpNotifications.length<12&&this._xpNotifications.push({text:`COMBO ${a}! (${u} hits)`,timer:2.5,y:-40})}this._prevComboTier=s}if(t.length>0&&this._systems.combat.comboCount>=3){const s=this._systems.combat.comboCount,a=1+Math.min(s,30)*.03;this._systems.audio.playSFX("combo_hit",a),s>0&&s%5===0&&this._xpNotifications.length<12&&(this._xpNotifications.push({text:`x${s} COMBO!`,timer:1.5,y:-20}),this._particles.emit(this._player.x,this._player.y,"#f59e0b",8,35,.4))}this._systems.combat.comboCount===0&&(this._prevComboTier=0);const i=this._systems.titan.getAllTitans();for(const s of i){if(s.state==="defeated"||s.state==="dormant"||s.state==="boss_phase")continue;const a=this._player.x-s.x,r=this._player.y-s.y;if(Math.sqrt(a*a+r*r)<60){let l=this._player.str;const h=this._systems.equipment.getAllLegendaryEffects().find(d=>d.id==="titan_slayer");h&&(l=Math.round(l*(1+h.magnitude)));const c=this._systems.titan.attackTitan(s.def.id,l);if(this._camera.shake(6,.2),this._hitPauseTimer=.05,this._ui.notify(`Hit ${s.def.name}! (-${l})`,"#ff6644"),this._systems.audio.playSFX("hit"),c.armorBroken&&(this._ui.notify(`${s.def.name}'s armor cracked!`,"#ffaa00"),this._camera.shake(10,.4),this._hitPauseTimer=.12,this._spawnVFX("shard_burst",s.x,s.y,1.5,8,.05),this._spawnVFX("ground_slam",s.x,s.y+20,1.2,8,.06)),c.bossPhase&&(this._ui.notify(`${s.def.name} enters BOSS PHASE!`,"#ff0000"),this._camera.shake(8,.5),this._hitPauseTimer=.15,this._spawnVFX("flame_rise",s.x,s.y,1.8,10,.06),this._spawnVFX("energy_swirl",s.x,s.y,1.4,8,.07),this.enterBossArena(s.def.id)),c.killed){if(this._ui.notify(`${s.def.name} DEFEATED!`,"#ffd700"),this._systems.audio.playSFX("kill"),this._spawnVFX("nova_burst",s.x,s.y,2,10,.05),this._spawnVFX("star_explosion",s.x,s.y,1.6,8,.06),this._spawnVFX("smoke_explosion",s.x,s.y,1.4,8,.07),this._systems.achievement.progress("titan_slayer"),this._systems.achievement.progress("all_titans"),s.def.corruptionReduction){const u=this._systems.corruption.purifyRadius(s.x,s.y,150,s.def.corruptionReduction);u>0&&this._ui.notify(`Corruption cleansed! (${u} tiles purified)`,"#22d3ee")}this._systems.quest.onBossKill(s.def.id),this._checkQuestCompletion();const d=this._systems.titan.getTitanLoot(s.def.id);for(const u of d)this._inventory.addItem(u.itemId,u.count),this._lootNotifications.length<15&&this._lootNotifications.push({text:`+${u.count} ${u.itemId.replace(/_/g," ")}`,timer:3,color:"#ffd700"});this._systems.titan.allTitansDefeated()&&(this._ui.notify("ALL TITANS DEFEATED  The path to EDILAS is open!","#ffd700"),this._ui.notify("Press [Backspace] for New Game+ when ready.","#aaaaff"),this._systems.achievement.progress("reach_edilas"))}break}}for(const s of i){if(s.state!=="enraged"&&s.state!=="roaming")continue;const a=this._player.x-s.x,r=this._player.y-s.y,n=Math.sqrt(a*a+r*r);if(n<50&&!this._player.invincible){let h=Math.round(s.def.damage*.3);const c=this._inventory.getEquipmentStats().defense;if(c>0){const d=c/(c+50);h=Math.max(1,Math.round(h*(1-d)))}this._player.takeDamage(h),this._spawnDamagePopup(this._player.x,this._player.y,h,!1,!1,!1),this._spawnVFX("ground_slam",this._player.x,this._player.y,1,8,.06),this._camera.shake(8,.3),this._damageFlash=.3,this._systems.audio.playSFX("damage"),n>.1&&(j.x[this._player.eid]=(j.x[this._player.eid]??0)+a/n*120,j.y[this._player.eid]=(j.y[this._player.eid]??0)+r/n*120);break}}}_executeClassSkill(e,t,i){const s=this._player.x,a=this._player.y,n=[Math.PI/2,-Math.PI/2,0,Math.PI][this._player.facing]??0,l=(c,d,u,f,m)=>{let _=0;for(const p of this._enemies){if(!p.alive)continue;const g=p.x-c,y=p.y-d;if(g*g+y*y<u*u){if(f>0){const S=x.current[p.eid]??0;x.current[p.eid]=Math.max(0,S-f),this._spawnDamagePopup(p.x,p.y,f,!1)}m==="stun"?vt.timer[p.eid]=3:m==="freeze"?(vt.timer[p.eid]=4,U.vx[p.eid]=0,U.vy[p.eid]=0):m==="burn"?(x.current[p.eid]=Math.max(0,(x.current[p.eid]??0)-Math.round(f*.3)),this._particles.emit(p.x,p.y,"#f97316",4,20,.3)):m==="poison"&&(x.current[p.eid]=Math.max(0,(x.current[p.eid]??0)-Math.round(f*.2)),this._particles.emit(p.x,p.y,"#4ade80",3,15,.2)),x.current[p.eid]<=0&&this._onEnemyKilled(p),_++}}return _},h=c=>{let d=null,u=c*c;for(const f of this._enemies){if(!f.alive)continue;const m=f.x-s,_=f.y-a,p=m*m+_*_;p<u&&(u=p,d=f)}return d};switch(this._systems.audio.playSFX("hit"),e){case"purify_touch":{const c=t.aoeRadius+(this._systems.classSystem.getSkillRank(e)-1)*10;this._systems.corruption.purifyRadius(s/L,a/L,Math.ceil(c/L),.3),this._spawnVFX("flower_bloom",s,a,1.2,8,.06),this._spawnVFX("energy_swirl",s,a,.8,8,.05),this._particles.emit(s,a,"#a78bfa",12,40,.5),this._ui.notify("Purification Touch! Cleansed area","#a78bfa"),this._systems.quest.onPurify(Math.ceil(c/L)),this._systems.achievement.progress("purify_100",Math.ceil(c/L)),this._checkQuestCompletion();break}case"shield_bash":{const c=h(t.range+20);if(c){const d=x.current[c.eid]??0;x.current[c.eid]=Math.max(0,d-i),this._spawnDamagePopup(c.x,c.y,i,!1),vt.timer[c.eid]=3;const u=Math.atan2(c.y-a,c.x-s);j.x[c.eid]=(j.x[c.eid]??0)+Math.cos(u)*30,j.y[c.eid]=(j.y[c.eid]??0)+Math.sin(u)*30,this._spawnVFX("shard_burst",c.x,c.y,.8,6,.05),this._camera.shake(4,.15),x.current[c.eid]<=0&&this._onEnemyKilled(c),this._ui.notify("Shield Bash! Stunned enemy","#fbbf24")}else this._ui.notify("No target in range","#9ca3af");break}case"whirlwind":{const c=l(s,a,t.aoeRadius,i);this._spawnVFX("energy_swirl",s,a,1.4,8,.04),this._particles.emit(s,a,"#ef4444",14,50,.5),this._camera.shake(5,.2),this._player.isAttacking=!0,this._player.attackTimer=.3,this._ui.notify(`Whirlwind! Hit ${c} enemies`,"#ef4444");break}case"battle_cry":{const c=10+(this._systems.classSystem.getSkillRank(e)-1)*2;this._skillBuffs.set("damage_boost",c),this._spawnVFX("flame_rise",s,a,1,8,.05),this._particles.emit(s,a,"#f97316",10,40,.4),this._camera.shake(3,.15),this._ui.notify(`Battle Cry! +30% damage for ${c}s`,"#f97316");break}case"ground_slam":{const c=l(s,a,t.aoeRadius,i,"stun");this._spawnVFX("nova_burst",s,a,1.5,8,.04),this._spawnVFX("spike_burst",s,a,1,8,.05),this._particles.emit(s,a,"#a16207",18,60,.6),this._camera.shake(8,.3),this._hitPauseTimer=.06,this._ui.notify(`Ground Slam! Hit ${c}, stunned all`,"#a16207");break}case"aimed_shot":{const c=h(t.range);if(c){const d=Math.round(i*1.5),u=x.current[c.eid]??0;x.current[c.eid]=Math.max(0,u-d),this._spawnDamagePopup(c.x,c.y,d,!0),this._spawnVFX("slash_line",c.x,c.y,1,6,.04),this._particles.emit(c.x,c.y,"#fbbf24",8,40,.3),this._camera.shake(3,.15),x.current[c.eid]<=0&&this._onEnemyKilled(c),this._ui.notify("Aimed Shot! Critical hit!","#fbbf24")}else this._ui.notify("No target in range","#9ca3af");break}case"multishot":{const c=l(s+Math.cos(n)*60,a+Math.sin(n)*60,t.aoeRadius+40,i);this._spawnVFX("wind_slash",s+Math.cos(n)*40,a+Math.sin(n)*40,1,6,.04,n),this._particles.emit(s,a,"#22c55e",10,45,.3),this._ui.notify(`Multishot! Hit ${c} enemies`,"#22c55e");break}case"trap_set":{const c=s+Math.cos(n)*40,d=a+Math.sin(n)*40,u=l(c,d,t.aoeRadius+10,i,"freeze");this._spawnVFX("smoke_poof",c,d,.8,8,.06),this._particles.emit(c,d,"#60a5fa",8,30,.4),this._ui.notify(`Trap set! Froze ${u} enemies`,"#60a5fa");break}case"tracking":{this._trackingRevealTimer=10+(this._systems.classSystem.getSkillRank(e)-1)*5,this._spawnVFX("sparkle_collect",s,a,.6,6,.06),this._ui.notify(`Tracking! Enemies revealed for ${Math.round(this._trackingRevealTimer)}s`,"#a3e635");break}case"fireball":{const c=h(t.range);if(c){const d=l(c.x,c.y,t.aoeRadius,i,"burn");this._spawnVFX("flame_rise",c.x,c.y,1.2,8,.04),this._spawnVFX("nova_burst",c.x,c.y,.8,6,.05),this._particles.emit(c.x,c.y,"#f97316",16,50,.5),this._camera.shake(4,.2),this._ui.notify(`Fireball! Hit ${d}, burning!`,"#f97316")}else this._ui.notify("No target in range","#9ca3af");break}case"ice_lance":{const c=s+Math.cos(n)*80,d=a+Math.sin(n)*80,u=l(c,d,50,i,"freeze");this._spawnVFX("slash_line",c,d,1.2,6,.04,n),this._particles.emit(c,d,"#93c5fd",12,45,.4),this._ui.notify(`Ice Lance! Froze ${u} enemies`,"#93c5fd");break}case"chain_lightning":{const c=l(s,a,t.aoeRadius,i);this._spawnVFX("tentacle_burst",s,a,1.2,8,.04),this._particles.emit(s,a,"#facc15",16,55,.5),this._camera.shake(4,.2),this._ui.notify(`Chain Lightning! Struck ${c} enemies`,"#facc15");break}case"teleport":{const c=t.range+(this._systems.classSystem.getSkillRank(e)-1)*20;this._spawnVFX("smoke_poof",s,a,.6,6,.05),this._player.x+=Math.cos(n)*c,this._player.y+=Math.sin(n)*c,this._spawnVFX("sparkle_collect",this._player.x,this._player.y,.8,6,.05),this._particles.emit(this._player.x,this._player.y,"#c084fc",10,40,.3),this._ui.notify("Teleport!","#c084fc");break}case"backstab":{const c=h(t.range+10);if(c){const d=Math.round(i*1.5),u=x.current[c.eid]??0;x.current[c.eid]=Math.max(0,u-d),this._spawnDamagePopup(c.x,c.y,d,!0),this._spawnVFX("claw_slash",c.x,c.y,1,6,.04),this._camera.shake(4,.15),this._hitPauseTimer=.04,x.current[c.eid]<=0&&this._onEnemyKilled(c),this._ui.notify("Backstab! Critical strike!","#dc2626")}else this._ui.notify("No target in range","#9ca3af");break}case"smoke_bomb":{l(s,a,t.aoeRadius,0,"stun"),this._spawnVFX("smoke_poof",s,a,1.5,8,.06),this._spawnVFX("smoke_poof",s-20,a+10,1,8,.07),this._spawnVFX("smoke_poof",s+15,a-15,1,8,.07),this._particles.emit(s,a,"#6b7280",20,40,.6),this._skillBuffs.set("stealth",3),this._ui.notify("Smoke Bomb! Enemies stunned, 3s stealth","#6b7280");break}case"shadow_step":{const c=h(t.range);if(c){const d=Math.atan2(c.y-a,c.x-s);this._spawnVFX("smoke_poof",s,a,.5,6,.05),this._player.x=c.x-Math.cos(d)*25,this._player.y=c.y-Math.sin(d)*25,this._spawnVFX("sparkle_collect",this._player.x,this._player.y,.6,6,.05),this._ui.notify("Shadow Step!","#6366f1")}else this._ui.notify("No target in range","#9ca3af");break}case"poison_blade":{const c=15+(this._systems.classSystem.getSkillRank(e)-1)*3;this._skillBuffs.set("poison_blade",c),this._spawnVFX("blob_splash",s,a,.6,6,.06),this._particles.emit(s,a,"#4ade80",8,30,.4),this._ui.notify(`Poison Blade! Attacks poison for ${c}s`,"#4ade80");break}case"holy_strike":{const c=h(t.range+10);if(c){let d=i;const u=this._systems.corruption.getCorruptionAt(Math.floor(c.x/L),Math.floor(c.y/L));u>0&&(d=Math.round(d*1.5));const f=x.current[c.eid]??0;x.current[c.eid]=Math.max(0,f-d),this._spawnDamagePopup(c.x,c.y,d,u>0),this._spawnVFX("flower_bloom",c.x,c.y,1,6,.04),this._particles.emit(c.x,c.y,"#fde047",10,40,.3),this._camera.shake(3,.15),x.current[c.eid]<=0&&this._onEnemyKilled(c),this._ui.notify(u>0?"Holy Strike! Bonus vs corruption!":"Holy Strike!","#fde047")}else this._ui.notify("No target in range","#9ca3af");break}case"divine_shield":{const c=3+(this._systems.classSystem.getSkillRank(e)-1);this._skillBuffs.set("invulnerable",c),this._spawnVFX("energy_swirl",s,a,1.2,8,.05),this._spawnVFX("flower_bloom",s,a,1,8,.06),this._particles.emit(s,a,"#fde68a",14,40,.5),this._ui.notify(`Divine Shield! Invulnerable for ${c}s`,"#fde68a");break}case"consecrate":{const c=l(s,a,t.aoeRadius,i);this._systems.corruption.purifyRadius(s/L,a/L,Math.ceil(t.aoeRadius/L),.4),this._spawnVFX("nova_burst",s,a,1.3,8,.04),this._spawnVFX("flower_bloom",s,a,1,8,.05),this._particles.emit(s,a,"#fde047",16,50,.5),this._camera.shake(4,.2),this._ui.notify(`Consecrate! Hit ${c}, purified ground`,"#fde047"),this._systems.quest.onPurify(Math.ceil(t.aoeRadius/L)),this._systems.achievement.progress("purify_100",Math.ceil(t.aoeRadius/L)),this._checkQuestCompletion();break}case"lay_on_hands":{const c=x.max[this._player.eid]??100;x.current[this._player.eid]=c,this._spawnVFX("flower_heal",s,a,1.2,8,.05),this._spawnVFX("sparkle_collect",s,a,.8,8,.06),this._particles.emit(s,a,"#86efac",14,40,.5),this._spawnDamagePopup(s,a,c,!1,!0),this._ui.notify("Lay on Hands! Fully healed!","#86efac"),this._systems.audio.playSFX("heal");break}default:{this._ui.notify(`${t.name} activated!`,"#60a5fa");break}}}_spawnDamagePopup(e,t,i,s=!1,a=!1,r=!0,n){const l=(Math.random()-.5)*36,h=s?1.2:.9;let c;if(a?c="#4ade80":s?c="#ffffff":r?c="#e53935":c="#ffcc00",n&&n!=="physical"&&!a)switch(n){case"fire":c="#ff6b35";break;case"ice":c="#60a5fa";break;case"lightning":c="#facc15";break;case"poison":c="#84cc16";break;case"void":c="#a855f7";break;case"holy":c="#fef08a";break}let d="";n&&n!=="physical"&&!a&&(d={fire:"",ice:"",lightning:"",poison:"",void:"",holy:""}[n]??"");const u=s?22:a?18:16,f=Math.min(1.6,.85+i/80),m=Math.round(u*f),_=s?-90:a?-55:-(55+i*.3);s&&!a?this._hitStopTimer=.04:i>=30&&!a&&(this._hitStopTimer=.02),!(this._damagePopups.length>=40)&&this._damagePopups.push({x:e+l,y:t-10,text:a?`+${i}`:`${d}${i}`,timer:h,maxTimer:h,vy:_,color:c,startSize:m,showCrit:s,isXp:!1})}_spawnVFX(e,t,i,s=1,a=8,r=.06,n=0){const l=this._sprites.getVFXSprite(e);if(l&&l.naturalWidth){const h=l.naturalWidth/a,c=l.naturalHeight;if(this._vfxSprites.length>=50)return;this._vfxSprites.push({x:t,y:i,sprite:l,frame:0,totalFrames:a,frameW:h,frameH:c,timer:0,frameDuration:r,scale:s,alpha:1,rotation:n})}else{const c={nova_burst:"#ffdd44",energy_swirl:"#aa44ff",spike_burst:"#ff4444",smoke_explosion:"#666666",smoke_poof:"#888888",sparkle_collect:"#ffd700",sparkle_burst:"#ffffaa",shard_burst:"#ccccaa",blob_splash:"#44ff44",wind_slash:"#aaccff",wind_trail:"#88bbee",dust_puff:"#aa9977",leaf_scatter:"#44aa33",magic_rune:"#9966ff",star_explosion:"#ffee55",pickup_health:"#ff4466",pickup_mana:"#4488ff",pickup_stamina:"#44ff88",pickup_gold:"#ffd700",pickup_gem:"#ee44ff",destroy_effect:"#ff2200",rarity_common:"#aaaaaa",rarity_magic:"#4488ff",rarity_rare:"#ffdd00",rarity_legendary:"#ff8800",rarity_mythic:"#ff44ff"}[e]??"#ffffff",d=Math.round(6*s),u=40+s*20;this._particles.emit(t,i,c,d,u,a*r)}}_spawnBiomeParticle(){const e=this._currentBiome?.id??"haven",t=this._player.x+(Math.random()-.5)*v.width*.8,i=this._player.y+(Math.random()-.5)*v.height*.8;let s="#ffffff",a=2,r=0,n=0,l=4;const h=this._systems.gameTime.isNight;switch(e){case"haven":h&&Math.random()>.4?(s=Math.random()>.3?"#fde68a":"#a3e635",a=2+Math.random()*2,r=(Math.random()-.5)*6,n=(Math.random()-.5)*6,l=5+Math.random()*5):(s=Math.random()>.5?"#a3e635":"#fde047",a=1.5+Math.random()*1.5,r=(Math.random()-.5)*8,n=-5-Math.random()*10,l=3+Math.random()*3);break;case"rotwood":s=Math.random()>.4?"#a855f7":"#4ade80",a=2+Math.random()*2,r=(Math.random()-.5)*12,n=-8-Math.random()*15,l=2.5+Math.random()*2.5;break;case"ashlands":s=Math.random()>.3?"#ff6600":"#ff4444",a=1.5+Math.random()*2.5,r=(Math.random()-.5)*20,n=-15-Math.random()*25,l=2+Math.random()*2;break;case"drowned_depths":s=Math.random()>.5?"#60a5fa":"#34d399",a=2+Math.random()*3,r=(Math.random()-.5)*5,n=-3-Math.random()*8,l=3+Math.random()*4;break;case"bone_wastes":s=Math.random()>.5?"#d4d4d8":"#a3a3a3",a=1+Math.random()*2,r=10+Math.random()*20,n=-2-Math.random()*4,l=4+Math.random()*3;break;case"the_void":s=Math.random()>.4?"#6366f1":"#a855f7",a=2+Math.random()*3,r=(Math.random()-.5)*15,n=(Math.random()-.5)*15,l=2+Math.random()*3;break;default:s="#fbbf24",a=1.5+Math.random()*2,r=(Math.random()-.5)*10,n=-8-Math.random()*12,l=3+Math.random()*3}this._envParticles.push({x:t,y:i,vx:r,vy:n,life:l,maxLife:l,color:s,size:a,alpha:.6})}_spawnFloatingXp(e,t,i){if(this._damagePopups.length>=40)return;const s=(Math.random()-.5)*24,a=1.8;this._damagePopups.push({x:e+s,y:t-8,text:`+${i} XP`,timer:a,maxTimer:a,vy:-55,color:"#4ade80",startSize:14,showCrit:!1,isXp:!0})}_awardSkillXP(e,t){const i=this._systems.skills.addXP(e,t);for(const s of i)this._ui.notify(`${s.skillName} Level ${s.newLevel}!`,"#60a5fa"),s.unlockedPerk&&(this._ui.notify(`Perk unlocked: ${s.unlockedPerk.name}  ${s.unlockedPerk.description}`,"#c084fc"),this._spawnVFX("magic_rune",this._player.x,this._player.y,.8,8,.06),this._systems.audio.playSFX("quest_complete"))}_awardProfXP(e,t){if(this._systems.profession.addXP(e,t)){const s=this._systems.profession.getLevel(e);this._ui.notify(`${e} Level ${s}!`,"#34d399"),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,.8,8,.06),this._systems.audio.playSFX("level_up")}}_handleLevelUp(){const e=this._player.level;this._levelUpFlash=2,this._systems.audio.playSFX("level_up"),this._camera.shake(8,.4),this._hitPauseTimer=Math.max(this._hitPauseTimer,.12),this._particles.emitLevelUp(this._player.x,this._player.y),this._particles.emitSparkle(this._player.x,this._player.y),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,1.5,8,.08),this._spawnVFX("star_explosion",this._player.x,this._player.y-20,1.2,8,.07),this._spawnVFX("magic_circle",this._player.x,this._player.y+10,1,10,.06),this._xpNotifications.length<12&&this._xpNotifications.push({text:`LEVEL ${e}!`,timer:3.5,y:-20}),this._xpNotifications.length<12&&this._xpNotifications.push({text:`HP ${Math.ceil(this._player.maxHealth)} | STR ${this._player.str} | +2 SP`,timer:3,y:-40});const t=this._systems.classSystem.getSkillsUnlockedAtLevel(e);for(const s of t)this._ui.notify(`New Skill: ${s.icon} ${s.name}!`,"","#44ff88",5);const i=this._systems.classSystem.getPassivesUnlockedAtLevel(e);for(const s of i)this._ui.notify(`New Passive: ${s.icon} ${s.name}!`,"","#88aaff",5)}_onEnemyKilled(e){this._deathMarkedEids.delete(e.eid),this._systems.audio.playSFX("kill"),this._systems.achievement.progress("first_blood"),this._systems.achievement.progress("centurion"),this._systems.achievement.progress("thousand_kills"),e.def.id.includes("slime")&&this._systems.achievement.progress("slime_slayer"),this._systems.classSystem.addXP(Math.round(e.def.xpReward*.5)),this._systems.profession.activeProfession==="hunter"&&this._awardProfXP("hunter",20);const t=e.def.xpReward;this._awardSkillXP("combat",Math.max(5,Math.floor(t*.3))),this._awardSkillXP("tactics",Math.max(3,Math.floor(t*.15)));const i=Math.min(this._killStreak*.1,.5),s=this._systems.endgame.modifiers?.xpMult??1,a=1+this._systems.festival.getXPBonus(),r=this._systems.shadowWorld.isInShadow?this._systems.shadowWorld.getShadowEnemyModifiers(Math.floor(e.x/L),Math.floor(e.y/L)).xpMultiplier:1,n=1+this._systems.classSystem.getPassiveBonus("xp_bonus"),l=this._systems.skills.getModifier("kill_xp"),h=Math.round(t*(1+i)*s*a*r*n*l);this._killStreak++,this._killStreakTimer=5;const c=i>0?` (x${(1+i).toFixed(1)})`:"";this._xpNotifications.length<12&&this._xpNotifications.push({text:`+${h} XP${c}`,timer:2,y:0}),this._spawnFloatingXp(e.x,e.y,h),this._player.addXP(h)&&this._handleLevelUp();const u=Math.floor(e.def.xpReward*.5+Math.random()*e.def.xpReward);if(u>0&&this._worldDrops.length<100&&this._worldDrops.push({x:e.x+(Math.random()-.5)*12,y:e.y+(Math.random()-.5)*12,itemId:"",count:0,gold:u,timer:30,bobPhase:Math.random()*Math.PI*2}),e.def.lootTable){const f=this._systems.endgame.modifiers?.lootRarityBonus??0,m=this._systems.profession.hasBonus("hunter","beast_loot_20")?.2:0,_=this._systems.profession.hasBonus("hunter","guaranteed_rare_drop"),p=this._systems.festival.hasActiveEvent("blood_moon");let g=!1;for(const y of e.def.lootTable){const S=Math.random(),b=Math.min(1,y.chance+f+m);if(S<b||_&&!g){g=!0;let w=y.min+Math.floor(Math.random()*(y.max-y.min+1));if(p&&(w*=2),w<=0)continue;if(this._worldDrops.length>=100)break;const k=16,T=pe(y.id),C=T&&(T.category==="weapon"||T.category==="armor"||T.category==="accessory")?V_(T.rarity):void 0;this._worldDrops.push({x:e.x+(Math.random()-.5)*k,y:e.y+(Math.random()-.5)*k,itemId:y.id,count:w,gold:0,timer:30,bobPhase:Math.random()*Math.PI*2,affixes:C&&C.length>0?C:void 0})}else if(y.chance<=.15&&S<b+.03){const w=pe(y.id);w&&(w.rarity==="rare"||w.rarity==="epic"||w.rarity==="legendary")&&this._ui.notify(`So close! ${w.name} almost dropped...`,"#aaaacc","#888888",2)}}}if(e.isCommander&&e.commanderDef){const f=e.commanderDef;for(const _ of f.drops)Math.random()<_.chance&&this._worldDrops.length<100&&this._worldDrops.push({x:e.x+(Math.random()-.5)*20,y:e.y+(Math.random()-.5)*20,itemId:_.id,count:_.count,gold:0,timer:60,bobPhase:Math.random()*Math.PI*2});const m=po[f.id]?.faction;m&&this._systems.faction.onCommanderDefeated(m),this._ui.notify(`COMMANDER ${f.name} SLAIN!`,"#ffd700"),this._spawnVFX("nova_burst",e.x,e.y,2,12,.05),this._spawnVFX("star_explosion",e.x,e.y,1.5,10,.06),this._camera.shake(8,.5),this._player.addXP(200)&&this._ui.notify(`Level Up! Now level ${this._player.level}`,"#fbbf24"),this._systems.audio.playSFX("quest_complete")}this._respawnQueue.length<50&&this._respawnQueue.push({def:e.def,x:e.x,y:e.y,timer:30+Math.random()*30}),this._systems.combat.recordKill({isBoss:e.def.isBoss??!1,isElite:e.def.isElite??!1,isNight:this._systems.gameTime.hour>=20||this._systems.gameTime.hour<6}),this._systems.quest.onKill(e.def.id),e.def.isBoss&&this._systems.quest.onBossKill(e.def.id),this._checkQuestCompletion(),this._progressStoryObjective(`Defeat the ${e.def.name}`),this._progressStoryObjective(`Defeat ${e.def.name}`),e.def.isBoss&&this._progressStoryObjective("Defeat")}_syncProfessionRecipes(){if(this._systems.profession.hasBonus("blacksmith","legendary_recipes"))for(const e of["r_corrupted_greatsword","r_silver_sword","r_void_staff","r_steel_sword"])this._systems.crafting.isRecipeUnlocked(e)||(this._systems.crafting.unlockRecipe(e),this._ui.notify(`Legendary recipe unlocked: ${this._systems.crafting.getRecipeName(e)}!`,"#ffcc44"));if(this._systems.profession.hasBonus("alchemist","transmute_recipes"))for(const e of["r_purification_crystal","r_ghost_ward","r_greater_health"])this._systems.crafting.isRecipeUnlocked(e)||(this._systems.crafting.unlockRecipe(e),this._ui.notify(`Transmute recipe unlocked: ${this._systems.crafting.getRecipeName(e)}!`,"#44ccff"));if(this._systems.profession.hasBonus("cook","golden_feast_recipe")&&(this._systems.crafting.isRecipeUnlocked("r_mushroom_stew")||(this._systems.crafting.unlockRecipe("r_mushroom_stew"),this._ui.notify("Recipe unlocked: Mushroom Stew!","#ffaa44"))),this._systems.profession.hasBonus("cook","legendary_banquet"))for(const e of["r_golden_feast","r_pilgrims_banquet","r_titan_stew"])this._systems.crafting.isRecipeUnlocked(e)||(this._systems.crafting.unlockRecipe(e),this._ui.notify(`Legendary recipe unlocked: ${this._systems.crafting.getRecipeName(e)}!`,"#ffd700"));if(this._systems.profession.hasBonus("enchanter","dual_enchant"))for(const e of["r_flamebrand_enchant","r_frostguard_enchant"])this._systems.crafting.isRecipeUnlocked(e)||(this._systems.crafting.unlockRecipe(e),this._ui.notify(`Dual enchant recipe unlocked: ${this._systems.crafting.getRecipeName(e)}!`,"#a78bfa"));if(this._systems.profession.hasBonus("enchanter","void_enchant"))for(const e of["r_void_blade_enchant","r_corruption_ward_enchant"])this._systems.crafting.isRecipeUnlocked(e)||(this._systems.crafting.unlockRecipe(e),this._ui.notify(`Void enchant unlocked: ${this._systems.crafting.getRecipeName(e)}!`,"#7c3aed"));this._systems.profession.hasBonus("enchanter","basic_enchant")&&(this._systems.crafting.isRecipeUnlocked("r_pilgrim_cloak")||(this._systems.crafting.unlockRecipe("r_pilgrim_cloak"),this._ui.notify("Enchanting recipe unlocked: Pilgrim Cloak!","#a78bfa"))),this._systems.profession.hasBonus("enchanter","corruption_resist_enchant")&&(this._systems.crafting.isRecipeUnlocked("r_purifier_beacon")||(this._systems.crafting.unlockRecipe("r_purifier_beacon"),this._ui.notify("Enchanting recipe unlocked: Purification Beacon!","#a78bfa")))}_checkQuestCompletion(){const e=this._systems.quest.consumeProgress();for(const t of e)if(t.justCompleted)this._ui.notify(`${t.questIcon} ${t.objectiveDesc} - DONE!`,"#4ade80");else{const i=t.current/t.target,s=(t.current-1)/t.target;(t.target<=5||t.current===1||s<.25&&i>=.25||s<.5&&i>=.5||s<.75&&i>=.75)&&this._ui.notify(`${t.questIcon} ${t.objectiveDesc}: ${t.current}/${t.target}`,"#a3a3a3")}for(const t of this._systems.quest.getActiveQuests())t.objectives.every(i=>i.completed)&&this._systems.quest.completeQuest(t.def.id,this._inventory,this._player)&&(this._ui.notify(`Quest Complete: ${t.def.title}!`,"#ffd700"),this._systems.audio.playSFX("quest_complete"),this._camera.shake(4,.3),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,1,8,.06),this._systems.achievement.progress("quest_complete"),t.def.giver&&this._systems.relationship.onQuestCompleteForNPC(t.def.giver));for(const t of this._systems.quest.getActiveContracts())t.objectives.every(i=>i.completed)&&this._systems.quest.completeQuest(t.def.id,this._inventory,this._player)&&(this._ui.notify(`Contract Complete: ${t.def.title}!`,"#fbbf24"),this._systems.audio.playSFX("quest_complete"),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,.8,6,.06))}_progressStoryObjective(e,t=1){const i=this._systems.story.getCurrentQuest();if(i){for(let s=0;s<i.objectives.length;s++)if(i.objectives[s].description.toLowerCase().includes(e.toLowerCase())&&this._systems.story.progressObjective(s,t)){if(this._ui.notify(`Story Quest Complete: ${i.name}!`,"#ffd700"),this._systems.audio.playSFX("quest_complete"),this._camera.shake(6,.3),this._particles.emitLevelUp(this._player.x,this._player.y),this._ui.showDialog("Narrator","",i.dialogue.complete,[{text:"Continue",action:"close"}]),this._player.addXP(i.reward.xp),this._player.gold+=i.reward.gold,i.reward.items)for(const n of i.reward.items)this._inventory.addItem(n.itemId,n.count);this._systems.mail.sendQuestComplete(i.name,this._systems.gameTime.day,i.reward.items??[]);break}}}_checkStoryCutscenes(){const e=this._systems.combat.killCount,t=Math.floor(this._systems.corruption.purifiedPercent*10),i=Math.max(0,...["lily","marcus","elena","garrett","harold","elder_miriam","martha","eldric"].map(s=>this._systems.relationship.getRelationship(s)?.affinity??0));for(const s of R0){if(this._triggeredCutscenes.has(s.id))continue;let a=!1;switch(s.condition){case"game_start":a=e===0&&!this._triggeredCutscenes.has("ct_prologue");break;case"corruption_purified_3":a=t>=3;break;case"corruption_purified_4":a=t>=4;break;case"corruption_purified_5":a=t>=5;break;case"corruption_purified_5_friendship_5":a=t>=5&&i>=50;break}if(a&&s.oneShot){this._triggeredCutscenes.add(s.id);const r=A0.find(n=>n.id===s.dialogueId);r&&this._ui.showDialog(r.speaker,"",r.lines.join(`
`),[{text:"Continue",action:"close"}])}}}_interactWithNPCDirect(e){this._talkingToNpc=e,this._dialogueStep=0,this._systems.audio.playSFX("menu_click"),this._progressStoryObjective(`Speak to ${e.def.name}`),this._progressStoryObjective(`Talk to ${e.def.name}`),this._systems.quest.onTalk(e.def.id),this._checkQuestCompletion();const t=this._systems.relationship.talkTo(e.def.id);t.affinityGain>0&&this._ui.notify(`${e.def.name}: +${t.affinityGain} affinity`,"#f472b6"),this._awardSkillXP("charisma",3),this._systems.relationship.getRelationship(e.def.id);const i=[],s=mi.find(n=>n.ownerId===e.def.id);if(s&&i.push({text:`Browse ${s.name}`,action:"shop"}),e.def.canHeal&&this._player.health<this._player.maxHealth){const n=Math.max(5,Math.floor(this._player.level*3));i.push({text:`Heal me (${n}g)`,action:`heal_${n}`})}if(e.def.id==="garrett"){const n=this._systems.equipment.getAllEquipped().filter(l=>l.durability<l.maxDurability);if(n.length>0){const l=n.length*25;i.push({text:`Repair all gear (${l}g)`,action:`repair_${l}`})}}for(const n of this._systems.quest.getAvailableQuests())if(n.def.giver===e.def.id){i.push({text:`Quest: ${n.def.title}`,action:`offer_quest_${n.def.id}`});break}e.def.id==="harold"&&i.push({text:"Play dice (50g)",action:"dice_50"});const a=this._inventory.getHotbarSlot(this._hotbarSlot);if(a){const n=pe(a.itemId);n&&i.push({text:`Give ${n.name}`,action:`gift_${a.itemId}`})}e.def.id==="elder_miriam"&&i.push({text:"Change profession",action:"choose_profession"}),i.push({text:"Goodbye",action:"close"});const r=e.def.greeting??"Hello, traveler.";this._ui.showDialog(e.def.name,e.def.icon,r,i,n=>{const l=i[n];l&&this._handleNpcDialogChoice(l.action,e,s??void 0)},e.def.id)}_handleNpcDialogChoice(e,t,i){switch(e){case"close":this._talkingToNpc=null;break;case"shop":{i&&(this._activeShop=i,this._showShop=!0,this._shopMode="buy",this._shopSelectedIndex=0,this._shopScrollOffset=0,this._showInventory=!1);break}default:{if(e.startsWith("heal_")){const s=parseInt(e.split("_")[1],10);this._player.gold>=s?(this._player.gold-=s,x.current[this._player.eid]=x.max[this._player.eid]??100,this._ui.notify("Fully healed!","#4ade80"),this._systems.audio.playSFX("heal")):this._ui.notify("Not enough gold!","#ef4444")}else if(e.startsWith("gift_")){const s=e.replace("gift_","");if(this._inventory.removeItem(s,1)){const a=this._systems.relationship.giveGift(t.def.id,s);if(this._ui.showDialog(t.def.name,t.def.icon,a.reaction,[{text:"Continue",action:"close"}],void 0,t.def.id),a.affinityChange!==0){const r=a.affinityChange>0?"#f472b6":"#ef4444";this._ui.notify(`${a.affinityChange>0?"+":""}${a.affinityChange} affinity`,r)}this._systems.audio.playSFX("pickup"),this._systems.achievement.progress("first_gift")}}else if(e.startsWith("repair_")){const s=parseInt(e.split("_")[1],10);this._inventory.removeGold(s)?(this._systems.equipment.repairAll(),this._ui.notify("All gear repaired!","#44ff88"),this._systems.audio.playSFX("craft")):this._ui.notify("Not enough gold!","#ef4444")}else if(e.startsWith("offer_quest_")){const s=e.replace("offer_quest_","");this._systems.quest.acceptQuest(s)&&(this._ui.notify("New quest accepted!","#fbbf24"),this._systems.audio.playSFX("quest_complete"))}else if(e.startsWith("dice_")){const s=parseInt(e.split("_")[1],10);this._player.gold>=s?(this._player.gold-=s,this._systems.minigame.dice.start(s,3),this._systems.minigame.startMinigame("dice")):this._ui.notify("Not enough gold!","#ef4444")}else if(e==="choose_profession"){const a=Object.values($i).map(r=>({text:`${r.name}  ${r.description}`,action:`set_prof_${r.id}`}));a.push({text:"Never mind",action:"close"}),this._ui.showDialog("Elder Miriam","","Choose your path:",a,r=>{const n=a[r];if(n&&n.action.startsWith("set_prof_")){const l=n.action.replace("set_prof_","");this._systems.profession.setProfession(l),this._ui.notify(`Profession set: ${l}`,"#60a5fa")}})}break}}}_handleInteriorAction(e){switch(e){case"sleep":this._player.heal(this._player.maxHealth),ke.current[this._player.eid]=ke.max[this._player.eid],this._systems.gameTime.skipMinutes(480),this._ui.notify("You rested and recovered fully.","","#4ade80"),this._systems.audio.playSFX("quest_complete");break;case"read_lore":this._ui.showDialog("Elder Miriam","","Ancient texts describe the Pilgrimage  a journey through seven corrupted biomes toward EDILAS, the last paradise.",[{text:"Interesting",action:"close"}]);break;case"storage":{const t=this._systems.storage;if(t){const i=t.getNearby(this._state.view.returnX,this._state.view.returnY,80);i.length>0?this._activeContainer=i[0]:this._activeContainer=t.createContainer("Storage Chest",this._state.view.returnX,this._state.view.returnY,24),this._showStorage=!0,this._storageScrollIdx=0,this._systems.audio.playSFX("menu_click")}break}case"shop":case"browse_weapons":{const i=(this._interiorManager.currentInterior?.npcPositions??[]).find(a=>mi.some(r=>r.ownerId===a.npcId))?.npcId,s=i?mi.find(a=>a.ownerId===i):void 0;s&&(this._activeShop=s,this._showShop=!0,this._shopMode="buy",this._shopSelectedIndex=0,this._shopScrollOffset=0,this._showInventory=!1,this._systems.audio.playSFX("menu_click"));break}case"craft_weapon":case"sharpen":case"smelt":this._showCrafting=!0,this._systems.audio.playSFX("menu_click");break;case"brew_potion":case"alchemy":this._showCrafting=!0,this._systems.audio.playSFX("menu_click");break;case"buy_drink":this._player.gold>=5?(this._player.gold-=5,rl(this._ecsWorld,20),this._ui.notify("Bought a drink. (-5g)","","#fbbf24"),this._systems.audio.playSFX("pickup")):this._ui.notify("Not enough gold for a drink.","#ff4444");break;case"dice_game":this._ui.showDialog("Harold","","Care for a game of dice?",[{text:"Bet 10g",action:"dice_10"},{text:"Bet 25g",action:"dice_25"},{text:"No thanks",action:"close"}]);break;case"enter_dungeon":this.exitToOverworld();break;case"read_warning":this._ui.showDialog("Sign","","DANGER: Dungeon ahead. Prepare yourself before entering.",[{text:"Noted",action:"close"}]);break;case"sit":this._ui.notify("You sit down for a moment.","#aaa");break;case"listen_music":this._ui.notify("A bard plays a soothing melody...","#c084fc");break;default:this._ui.notify(`Interaction: ${e}`,"#aaa")}}_performSave(e,t=!1){const i=this._systems.save.currentSlotId||1,s=this._systemManager.serializeAll();s._discoveredBiomes=[...this._discoveredBiomes];const a=this._currentDungeon!==null||this._state.view.interiorId!==null||this._state.view.bossArenaId!==null;let r,n;a&&(r=this._player.x,n=this._player.y,this._player.x=this._state.view.returnX,this._player.y=this._state.view.returnY);const l=this._systems.save.save(i,e,this._player,this._inventory,this._systems.gameTime,this._systems.weather,this._systems.combat,this._systems.corruption,this._systems.quest,this._systems.crafting,this._currentBiome?.id??"haven",this._systems.cooking,this._systems.temperature,this._systems.weaponMastery,this._systems.skills,s);a&&r!==void 0&&n!==void 0&&(this._player.x=r,this._player.y=n),t?l?this._ui.notify("Auto-saved","#66bb99"):this._ui.notify("Auto-save failed!","#ef4444"):this._ui.notify(l?`Saved! (${e})`:"Save failed!",l?"#44ff88":"#ff4444"),this._systems.audio.playSFX("menu_click")}_performLoad(){const e=this._systems.save.currentSlotId||1,t=this._systems.save.load(e);if(!t){this._ui.notify("No save found!","#ff4444"),this._systems.audio.playSFX("error");return}(this._currentDungeon||this._state.view.interiorId||this._state.view.bossArenaId)&&(this._currentDungeon=null,this._dungeonEnemies=[],this._dungeonEnemyAttackCDs.clear(),this._dungeonFloor=1,this._state.view.dungeonId=null,this._state.view.interiorId=null,this._state.view.bossArenaId=null,this._viewMode.setImmediate(se.ISOMETRIC)),this._systems.save.applyToSystems(t,this._player,this._inventory,this._systems.gameTime,this._systems.weather,this._systems.combat,this._systems.corruption,this._systems.quest,this._systems.crafting,this._systems.cooking,this._systems.temperature,this._systems.weaponMastery,this._systems.skills,i=>{this._systemManager.deserializeAll(i);const s=i._discoveredBiomes;Array.isArray(s)&&(this._discoveredBiomes=new Set(s))}),this._syncLegendaryEffects(),this._ui.notify("Loaded!","#44ff88"),this._systems.audio.playSFX("menu_click")}_syncLegendaryEffects(){for(const t of this._systems.equipment.getAllLegendaryEffects())this._systems.equipment.removeLegendaryEffect(t.id);const e=this._inventory.equipment;for(const t of Object.values(e)){if(!t)continue;const i=pe(t.itemId);i?.legendaryEffect&&this._systems.equipment.addLegendaryEffect(i.legendaryEffect)}}_processLegendaryEffect(e,t,i){const s=this._enemies.find(n=>n.eid===i.targetEid),a=s?.x??this._player.x,r=s?.y??this._player.y;switch(e){case"chain_lightning":{this._spawnVFX("energy_swirl",a,r,1,8,.04),this._particles.emit(a,r,"#44ccff",12,60,.5),this._camera.shake(3,.15);let n=3;for(const l of this._enemies){if(!l.alive||l.eid===i.targetEid)continue;const h=l.x-a,c=l.y-r;if(h*h+c*c<14400&&(l.takeDamage(Math.round(t)),this._spawnDamagePopup(l.x,l.y,Math.round(t),!1,!1,!1),this._spawnVFX("spark_burst",l.x,l.y,.5,6,.04),--n<=0))break}this._ui.notify("Chain Lightning!","#44ccff","#224466",2);break}case"elemental_burst":{this._spawnVFX("nova_burst",a,r,1.4,8,.04),this._spawnVFX("flame_rise",a,r,1,8,.05),this._particles.emit(a,r,"#ff6644",16,70,.6),this._camera.shake(5,.2);for(const n of this._enemies){if(!n.alive)continue;const l=n.x-a,h=n.y-r;l*l+h*h<1e4&&(n.takeDamage(Math.round(t)),this._spawnDamagePopup(n.x,n.y,Math.round(t),!1,!1,!1))}this._ui.notify("Elemental Burst!","#ff6644","#663322",2);break}case"corruption_absorb":{const n=Math.round(t),l=x.max[this._player.eid]??100;x.current[this._player.eid]=Math.min(l,(x.current[this._player.eid]??0)+n),this._spawnDamagePopup(this._player.x,this._player.y-20,n,!1,!0),this._spawnVFX("sparkle_collect",this._player.x,this._player.y,.6,6,.06);break}case"purification_spread":{const n=Math.floor(a/64),l=Math.floor(r/64);this._systems.corruption.purifyRadius(n,l,Math.ceil(t),.15),this._spawnVFX("nova_burst",a,r,1.2,8,.05),this._particles.emit(a,r,"#ffffaa",14,60,.7),this._ui.notify("Light of EDILAS purifies!","#ffffaa","#888844",2);break}case"spectral_allies":{for(let n=0;n<Math.min(t,3);n++){const l=Math.PI*2*n/t,h=this._player.x+Math.cos(l)*40,c=this._player.y+Math.sin(l)*40;this._spawnVFX("energy_swirl",h,c,.6,6,.08)}this._particles.emit(this._player.x,this._player.y,"#88aaff",10,50,.6),this._ui.notify("Spectral Host!","#88aaff","#445588",2);break}}}_updateTopDown(e){if(this._player.dodgeCooldown=Math.max(0,this._player.dodgeCooldown-e),this._player.isDodging){this._player.dodgeTimer-=e;const r=this._player.speed*3.5,l=[Math.PI/2,-Math.PI/2,0,Math.PI][this._player.facing]??0;U.vx[this._player.eid]=Math.cos(l)*r,U.vy[this._player.eid]=Math.sin(l)*r,pr(this._ecsWorld,e),this._player.dodgeTimer<=0&&(this._player.isDodging=!1,U.vx[this._player.eid]=0,U.vy[this._player.eid]=0)}else{if(this._player.handleInput(this._input,e),(this._input.wasPressed("ShiftLeft")||this._input.wasPressed("ShiftRight"))&&this._player.dodgeCooldown<=0&&this._player.stamina>10){this._player.isDodging=!0,this._player.dodgeTimer=.25,this._player.dodgeCooldown=.8,ke.current[this._player.eid]=Math.max(0,this._player.stamina-15),this._spawnVFX("wind_slash",this._player.x,this._player.y,.5,6,.04),this._particles.emit(this._player.x,this._player.y,"#aaccff",6,40,.3);const n=this._systems.equipment.triggerEffects("onDodge");for(const l of n)l.effectId==="shadow_phase"&&(this._ui.notify("Shadow Phase!","#8844cc","#441166",2),this._spawnVFX("energy_swirl",this._player.x,this._player.y,1,8,.05),this._particles.emit(this._player.x,this._player.y,"#8844cc",10,50,.6))}pr(this._ecsWorld,e)}this._player.updateAnimation(e),this._player.isAttacking&&(this._player.attackTimer-=e,this._player.attackTimer<=0&&(this._player.isAttacking=!1)),this._camera.follow(this._player.x,this._player.y,.15),this._camera.update(e);for(const r of this._dungeonEnemies)r.alive&&r.updateAI(e,this._player.x,this._player.y);const t=this._getActiveRiftModifiers(),i=t.includes("empowered")?1.3:1,s=t.includes("frozen");if(t.includes("swift"))for(const r of this._dungeonEnemies)r.alive&&(U.vx[r.eid]=(U.vx[r.eid]??0)*1.4,U.vy[r.eid]=(U.vy[r.eid]??0)*1.4);if(t.includes("void_touched")&&Math.random()<.002){const r=this._player.x+(Math.random()-.5)*200,n=this._player.y+(Math.random()-.5)*200;j.x[this._player.eid]=r,j.y[this._player.eid]=n,this._spawnVFX("energy_swirl",r,n,.8,6,.06),this._ui.notify("Void shift!","#7c3aed")}if(s&&!this._player.isDodging&&(U.vx[this._player.eid]=(U.vx[this._player.eid]??0)*.8,U.vy[this._player.eid]=(U.vy[this._player.eid]??0)*.8),t.includes("corrupted")||t.includes("burning")){const r=(t.includes("corrupted")?.5:0)+(t.includes("burning")?.8:0);x.current[this._player.eid]=Math.max(0,(x.current[this._player.eid]??0)-r*e)}if(t.includes("regenerating"))for(const r of this._dungeonEnemies)r.alive&&(x.current[r.eid]=Math.min(x.max[r.eid]??100,(x.current[r.eid]??0)+2*e));t.includes("cursed");for(const r of this._dungeonEnemies){if(!r.alive||this._player.isDodging)continue;const n=this._player.x-r.x,l=this._player.y-r.y,h=Math.sqrt(n*n+l*l),c=28,d=this._dungeonEnemyAttackCDs.get(r.eid)??0;if(d>0){this._dungeonEnemyAttackCDs.set(r.eid,d-e);continue}if(h<=c&&this._player.health>0){const u=Math.round(r.def.damage*(.9+Math.random()*.2)*i);this._player.takeDamage(u),this._spawnDamagePopup(this._player.x,this._player.y,u,!1,!1,!1),this._camera.shake(4,.15),this._hitPauseTimer=.03,this._damageFlash=.15,this._particles.emitHit(this._player.x,this._player.y),this._spawnVFX("spike_burst",this._player.x,this._player.y,.6,6,.05),this._systems.audio.playSFX("damage"),this._dungeonEnemyAttackCDs.set(r.eid,r.def.attackSpeed??1)}}if(this._attackCooldown=Math.max(0,this._attackCooldown-e),this._input.wasPressed("Space")&&this._attackCooldown<=0){this._attackCooldown=.4,this._player.isAttacking=!0,this._player.attackTimer=.25;let r=!1;for(const n of this._dungeonEnemies){if(!n.alive)continue;const l=n.x-this._player.x,h=n.y-this._player.y,c=Math.sqrt(l*l+h*h);if(c<50){r=!0;const d=this._player.str+5;n.takeDamage(d),this._spawnDamagePopup(n.x,n.y,d);const u=Math.atan2(h,l),f=["slash_cross","wind_slash","slash_line"][Math.floor(Math.random()*3)];if(this._spawnVFX(f,n.x,n.y,.7,6,.05,u),c>.1&&n.alive){const _=l/c*80,p=h/c*80;n.applyKnockback(_,p)}if(this._camera.shake(3,.12),this._hitPauseTimer=.04,this._systems.audio.playSFX("damage"),!n.alive){this._camera.shake(6,.25),this._camera.zoomPulse(.08,.22),this._hitPauseTimer=.08,this._spawnVFX("smoke_explosion",n.x,n.y,.9,8,.06),this._spawnVFX("shard_burst",n.x,n.y,.7,6,.05);const m=this._player.addXP(n.def.xpReward);if(this._xpNotifications.length<12&&this._xpNotifications.push({text:`+${n.def.xpReward} XP`,timer:2,y:0}),this._particles.emitDeath(n.x,n.y),this._particles.emit(n.x,n.y,"#ffd700",10,60,.5),this._spawnFloatingXp(n.x,n.y,n.def.xpReward),this._systems.audio.playSFX("kill"),m&&this._handleLevelUp(),t.includes("explosive")){const y=Math.round(n.def.damage*.5);this._spawnVFX("fire_burst",n.x,n.y,1.2,8,.05),this._camera.shake(8,.2);for(const w of this._dungeonEnemies){if(!w.alive||w===n)continue;const k=w.x-n.x,T=w.y-n.y;Math.sqrt(k*k+T*T)<60&&(w.takeDamage(y),this._spawnDamagePopup(w.x,w.y,y))}const S=this._player.x-n.x,b=this._player.y-n.y;Math.sqrt(S*S+b*b)<60&&!this._player.isDodging&&this._player.takeDamage(Math.round(y*.5))}const _=t.includes("treasure")?2:1,p=Math.floor((n.def.xpReward*.3+Math.random()*n.def.xpReward*.3)*_);if(p>0&&(this._player.gold+=p,this._lootNotifications.length<15&&this._lootNotifications.push({text:`+${p} Gold`,timer:2,color:"#f59e0b"})),n.def.lootTable){const g=(this._systems.endgame.modifiers?.lootRarityBonus??0)+(_>1?.2:0);for(const y of n.def.lootTable)if(Math.random()<Math.min(1,y.chance+g)){const S=(y.min+Math.floor(Math.random()*(y.max-y.min+1)))*_;if(S<=0)continue;this._inventory.addItem(y.id,S);const b=pe(y.id),w=b?`${b.icon} ${b.name}`:y.id,k=b?rt[b.rarity]:"#4ade80";this._lootNotifications.length<15&&this._lootNotifications.push({text:`${w}${S>1?` x${S}`:""}`,timer:2.5,color:k})}}}}}r||this._spawnVFX("wind_slash",this._player.x+20,this._player.y,.5,6,.04)}if(this._currentDungeon&&this._input.wasPressed("KeyE")){const n=Math.floor(this._player.x/16),l=Math.floor(this._player.y/16);for(let h=-1;h<=1;h++)for(let c=-1;c<=1;c++){const d=n+c,u=l+h;if(this._currentDungeon.tiles[u]?.[d]==="chest"){this._currentDungeon.tiles[u][d]="floor";const f=1+Math.floor(Math.random()*3);this._inventory.addItem("health_potion",f),this._systems.audio.playSFX("pickup"),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,.8,8,.06),this._particles.emit(this._player.x,this._player.y,"#ffd700",8,40,.5);const m=pe("health_potion");this._lootNotifications.length<15&&this._lootNotifications.push({text:`${m?.icon??""} Health Potion x${f}`,timer:2.5,color:m?rt[m.rarity]:"#cc9922"})}if(this._currentDungeon.tiles[u]?.[d]==="stairs_up"){if(this._dungeonEnemies.length>0&&this._dungeonEnemies.every(m=>!m.alive)){this._state.progression.dungeonsClearedCount++,this._systems.achievement.progress("dungeon_clear");const m=this._currentDungeon.level,_=30+m*20,p=15+m*10,g=this._player.addXP(_);this._player.gold+=p,g&&this._handleLevelUp(),this._ui.notify("Dungeon Cleared!","#4ade80"),this._ui.notify(`+${_} XP, +${p} Gold`,"#ffd700"),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,1,10,.06),this._systems.audio.playSFX("level_up")}this.exitToOverworld();return}if(this._currentDungeon.tiles[u]?.[d]==="stairs_down"){this._dungeonFloor=(this._dungeonFloor??1)+1,this._enterDungeonFloor(),this._ui.notify(`Descended to floor ${this._dungeonFloor}`,"#aaaaff"),this._spawnVFX("energy_swirl",this._player.x,this._player.y,.8,6,.05),this._systems.audio.playSFX("menu_click");return}if(this._currentDungeon.tiles[u]?.[d]==="boss_gate")if(this._currentDungeon.bossDefeated)this._ui.notify("The boss has already been defeated.","#888");else{const f=this._currentDungeon.rooms.find(m=>m.type==="boss");if(f&&f.enemies.length>0){const m=f.enemies[0].type;this._state.view.bossArenaId=m,this._state.view.returnX=this._player.x,this._state.view.returnY=this._player.y,this._viewMode.startTransition(se.SIDE_SCROLL,"enter_boss_arena",this._player.x,this._player.y),console.log(`[Dungeon] Entering boss arena: ${m}`);return}}}}if(this._interiorManager.isInInterior&&this._input.wasPressed("KeyE")){const r=this._interiorManager.currentInterior,n=Math.min(Math.floor(v.width/r.width),Math.floor(v.height/r.height),48),l=(v.width-r.width*n)/2,h=(v.height-r.height*n)/2,c=Math.floor((v.width/2-l)/n),d=Math.floor((v.height/2-h)/n);for(const u of r.furniture){if(!u.interactable||!u.interactAction)continue;const f=Math.abs(u.x-c),m=Math.abs(u.y-d);if(f<=2&&m<=2){this._handleInteriorAction(u.interactAction);break}}for(const u of r.npcPositions){const f=Math.abs(u.x-c),m=Math.abs(u.y-d);if(f<=2&&m<=2){const _=this._npcs.find(p=>p.def.id===u.npcId);_&&this._interactWithNPCDirect(_);break}}}if(this._interiorManager.isInInterior&&!this._currentDungeon&&this._input.wasPressed("Escape")&&!this._gamePaused&&!this._showInventory&&!this._showShop&&!this._ui.dialog&&this.exitToOverworld(),this._currentDungeon){const n=Math.floor(this._player.x/16),l=Math.floor(this._player.y/16);if(this._currentDungeon.tiles[l]?.[n]==="wall"){const c=this._player.x-U.vx[this._player.eid]*.016,d=this._player.y-U.vy[this._player.eid]*.016;this._player.setPosition(c,d),U.vx[this._player.eid]=0,U.vy[this._player.eid]=0}}this._input.wasPressed("Escape")&&!this._escConsumed&&!this._gamePaused&&this.exitToOverworld();const a=this._state.view.dungeonId;if(a&&a.startsWith("rift_")&&this._dungeonEnemies.length>0&&this._dungeonEnemies.every(n=>!n.alive)&&this._input.wasPressed("KeyE")){const n=parseInt(a.slice(5),10);if(!isNaN(n)){const l=this._systems.rift.advanceFloor(n);if(this._systems.achievement.progress("rift_5"),this._systems.achievement.setProgress("rift_50",this._dungeonFloor),l){if(this._ui.notify(`Rift Floor ${l.depth}!`,"#c4b5fd"),l.modifiers.length>0){const h=l.modifiers.map(c=>this._systems.rift.getModifierInfo(c).name).join(", ");this._ui.notify(`Modifiers: ${h}`,"#a78bfa")}this._dungeonFloor=l.depth,this._enterDungeonFloor()}else this._state.progression.dungeonsClearedCount++,this._ui.notify("Rift complete!","#ffd700"),this._systems.achievement.progress("dungeon_clear"),this.exitToOverworld()}}this._input.wasPressed("KeyQ")&&(this._showQuestPanel=!this._showQuestPanel)}_updateSideScroll(e){const t=v.height*.75,i=800,s=-350;if(this._sideScrollScreenShake=Math.max(0,this._sideScrollScreenShake-e*3),(this._input.wasPressed("ControlLeft")||this._input.wasPressed("ControlRight"))&&this._systems.combatTiming.startDodge()){const u=this._player.x<this._bossX?-1:1;this._player.x+=u*120,this._player.x=Math.max(30,Math.min(v.width-30,this._player.x)),this._spawnVFX("wind_trail",this._player.x,this._player.y,.7,6,.05),this._spawnVFX("smoke_poof",this._player.x-u*60,this._player.y,.5,6,.06),this._systems.audio.playSFX("dodge")}let a=0;(this._input.isHeld("KeyA")||this._input.isHeld("ArrowLeft"))&&(a=-1),(this._input.isHeld("KeyD")||this._input.isHeld("ArrowRight"))&&(a=1);let r=this._player.x+a*200*e;(this._input.wasPressed("KeyW")||this._input.wasPressed("ArrowUp"))&&this._sideScrollPlayerOnGround&&(this._sideScrollPlayerVelY=s,this._sideScrollPlayerOnGround=!1);let n=this._player.y;this._sideScrollPlayerOnGround||(this._sideScrollPlayerVelY+=i*e,n+=this._sideScrollPlayerVelY*e),n+48>=t&&(n=t-48,this._sideScrollPlayerVelY=0,this._sideScrollPlayerOnGround=!0),r=Math.max(30,Math.min(v.width-30,r)),this._player.setPosition(r,n),this._player.updateAnimation(e),this._bossAttackTimer-=e,this._bossHitFlash=Math.max(0,this._bossHitFlash-e);const h=this._bossHealth/this._bossMaxHealth;h<=.25&&this._bossPhase<2?(this._bossPhase=2,this._sideScrollScreenShake=1,this._ui.notify("BOSS ENRAGED!","#ff2222"),this._camera.shake(10,.5),this._hitPauseTimer=.15,this._spawnVFX("flame_rise",this._bossX,v.height*.4,1.6,10,.05),this._spawnVFX("nova_burst",this._bossX,v.height*.4,1.4,8,.06),this._particles.emit(this._bossX,v.height*.4,"#ff4400",16,80,.6),this._systems.audio.playSFX("damage"),this._damageFlash=.3):h<=.5&&this._bossPhase<1&&(this._bossPhase=1,this._sideScrollScreenShake=.5,this._ui.notify("Boss grows aggressive!","#ff8800"),this._camera.shake(6,.3),this._hitPauseTimer=.1,this._spawnVFX("energy_swirl",this._bossX,v.height*.4,1.2,8,.05),this._particles.emit(this._bossX,v.height*.4,"#ffaa00",10,60,.4),this._systems.audio.playSFX("hit"));const c=1+this._bossPhase*.4;if(this._bossX+=this._bossVelX*c*e,this._bossX<v.width*.3&&(this._bossX=v.width*.3,this._bossVelX=Math.abs(this._bossVelX)),this._bossX>v.width*.9&&(this._bossX=v.width*.9,this._bossVelX=-Math.abs(this._bossVelX)),this._bossAttackTimer>0&&this._bossAttackTimer<=.5?this._bossAttackTelegraph=this._bossAttackTimer:this._bossAttackTelegraph=0,this._bossAttackTimer<=0){const d=this._player.x-this._bossX;if(Math.abs(d)>100?this._bossVelX=d>0?100*c:-100*c:this._bossVelX=d>0?80:-80,this._bossAttackTimer=Math.max(.8,2.5-this._bossPhase*.6)+Math.random(),Math.abs(this._player.x-this._bossX)<60){const f=10+this._bossPhase*5+Math.floor(Math.random()*10);this._player.takeDamage(f),this._sideScrollScreenShake=Math.max(this._sideScrollScreenShake,.6),this._camera.shake(4,.2),this._hitPauseTimer=.04,this._damageFlash=.2,this._spawnVFX("spike_burst",this._player.x,this._player.y,.7,6,.05),this._systems.audio.playSFX("damage"),this._spawnDamagePopup(this._player.x,this._player.y,f,!1,!1,!1)}}if(this._attackCooldown=Math.max(0,this._attackCooldown-e),this._input.wasPressed("Space")&&this._attackCooldown<=0&&(this._attackCooldown=.4,Math.abs(this._player.x-this._bossX)<80)){const d=this._player.str+8;this._bossHealth-=d,this._bossHitFlash=.15,this._sideScrollScreenShake=Math.max(this._sideScrollScreenShake,.3),this._camera.shake(3,.1),this._camera.zoomPulse(.05,.15),this._hitPauseTimer=.04,this._spawnDamagePopup(this._bossX,v.height*.4,d);const u=["claw_slash","crescent_slash","diagonal_slash"][Math.floor(Math.random()*3)];if(this._spawnVFX(u,this._bossX,v.height*.4,1,6,.04),this._bossHealth<=0){this._camera.shake(12,.6),this._camera.zoomPulse(.15,.4),this._hitPauseTimer=.2,this._particles.emitDeath(this._bossX,v.height*.4),this._particles.emit(this._bossX,v.height*.4,"#ffd700",30,80,1.2),this._particles.emit(this._bossX,v.height*.4,"#ff8800",20,60,.8),this._spawnVFX("nova_burst",this._bossX,v.height*.4,2,10,.05),this._spawnVFX("star_explosion",this._bossX,v.height*.4-20,1.5,8,.06),this._spawnVFX("smoke_explosion",this._bossX,v.height*.4+15,1.3,8,.07),this._levelUpFlash=2.5;const f=this._state.view.bossArenaId;if(this._lootNotifications.length<15&&this._lootNotifications.push({text:`${this._bossName} DEFEATED!`,timer:5,color:"#ffd700"}),this._player.addXP(500)&&this._handleLevelUp(),this._currentDungeon&&(this._currentDungeon.bossDefeated=!0),this._systems.titan.endBossPhase(!0),f){const _=f,p=ys[_];if(p?.corruptionReduction){const S=this._systems.titan.getTitan(_),b=S?.x??this._player.x,w=S?.y??this._player.y,k=this._systems.corruption.purifyRadius(b,w,150,p.corruptionReduction);k>0&&this._ui.notify(`Corruption cleansed! (${k} tiles purified)`,"#22d3ee")}const g=100+(p?.maxHealth??5e3)/50;this._player.gold+=g,this._lootNotifications.length<15&&this._lootNotifications.push({text:`+${g} Gold`,timer:3,color:"#ffd700"});const y=this._systems.titan.getTitanLoot(_);for(const S of y)this._inventory.addItem(S.itemId,S.count),this._lootNotifications.length<15&&this._lootNotifications.push({text:`+${S.count} ${S.itemId.replace(/_/g," ")}`,timer:3,color:"#a855f7"});this._systems.achievement.progress("titan_slayer"),this._systems.achievement.progress("all_titans"),this._systems.quest.onBossKill(_),this._checkQuestCompletion()}this._systems.audio.playSFX("level_up"),this._exitTimer=setTimeout(()=>{this._exitTimer=null,this.exitToOverworld()},3e3)}}this._input.wasPressed("Escape")&&!this._escConsumed&&!this._gamePaused&&(this._systems.titan.endBossPhase(!1),this.exitToOverworld())}_enterDungeonFloor(){const e=this._state.view.dungeonId??"cave",i={corruption_dungeon:"corruption_core",mine_entrance:"mine",ancient_ruins:"ruins"}[e]??"cave",s=this._player.level+(this._dungeonFloor-1)*2,a=6+Math.floor(s/2)+this._dungeonFloor,r=1+Math.min(1.5,s*.1);this._currentDungeon=this._dungeonGenerator.generate(i,s,a,r);const n=16;this._player.setPosition(this._currentDungeon.spawnX*n+n/2,this._currentDungeon.spawnY*n+n/2),this._dungeonEnemies=[],this._dungeonEnemyAttackCDs.clear();for(const h of this._currentDungeon.rooms)for(const c of h.enemies){const d=Qs[c.type];if(d){const u=new ei(this._ecsWorld,d,c.x*n+n/2,c.y*n+n/2,this._sprites);this._applyNGPlusHealthScaling(u),this._dungeonEnemies.push(u)}}const l=this._getActiveRiftModifiers();if(l.length>0){const h=l.includes("swarm"),c=l.includes("fortified"),d=[];for(const u of this._dungeonEnemies)if(c&&(x.max[u.eid]=Math.round((x.max[u.eid]??100)*1.5),x.current[u.eid]=x.max[u.eid]),h){const f=20+Math.random()*20,m=Math.random()*Math.PI*2,_=new ei(this._ecsWorld,u.def,u.x+Math.cos(m)*f,u.y+Math.sin(m)*f,this._sprites);c&&(x.max[_.eid]=Math.round((x.max[_.eid]??100)*1.5),x.current[_.eid]=x.max[_.eid]),d.push(_)}if(this._dungeonEnemies.push(...d),l.includes("boss_rush")&&this._dungeonEnemies.length>0){const u=this._dungeonEnemies[0],f=new ei(this._ecsWorld,{...u.def,name:`Elite ${u.def.name}`,isBoss:!0,isElite:!0},u.x+40,u.y+40,this._sprites);x.max[f.eid]=Math.round((x.max[u.eid]??100)*3),x.current[f.eid]=x.max[f.eid],this._dungeonEnemies.push(f)}}this._camera.snapTo(this._player.x,this._player.y),this._webglDungeon&&this._webgl&&(this._webglDungeon.buildFloor({width:this._currentDungeon.width,height:this._currentDungeon.height,tiles:this._currentDungeon.tiles,theme:i,level:s}),this._webgl.world.children.includes(this._webglDungeon.container)||this._webgl.world.addChild(this._webglDungeon.container),this._webglDungeon.container.visible=!0,this._webgl.terrainLayer.visible=!1,this._webgl.groundLayer.visible=!1),console.log(`[Dungeon] Generated ${i} dungeon (level ${s}): ${this._currentDungeon.rooms.length} rooms, ${this._dungeonEnemies.length} enemies`)}_initBossArena(){const e=this._state.view.bossArenaId;if(!e)return;const t=this._systems.titan.getTitan(e);t?(this._bossHealth=t.health,this._bossMaxHealth=t.def.maxHealth,this._bossName=t.def.name,this._bossIcon=t.def.icon):(this._bossHealth=1e3,this._bossMaxHealth=1e3,this._bossName="Unknown Boss",this._bossIcon=""),this._bossX=v.width*.7,this._bossVelX=-60,this._bossAttackTimer=3,this._bossHitFlash=0,this._bossPhase=0,this._sideScrollPlayerVelY=0,this._sideScrollPlayerOnGround=!0,this._sideScrollScreenShake=0,this._attackCooldown=0;const i=v.height*.75;if(this._player.setPosition(v.width*.2,i-48),this._webglBossArena&&this._webgl){const s={rotwood:"forest",ashlands:"fire",drowned_depths:"water",bone_wastes:"bone",the_void:"void",edilas:"eden"},a=Js(this._player.x,this._player.y)?.id??"haven",r=s[a]??"forest";this._webglBossArena.buildArena({width:v.width*1.5,height:v.height,floorY:i,theme:r,bossName:this._bossName??"Boss",biome:a}),this._webgl.world.children.includes(this._webglBossArena.container)||this._webgl.world.addChild(this._webglBossArena.container),this._webglBossArena.container.visible=!0,this._webgl.terrainLayer.visible=!1,this._webgl.groundLayer.visible=!1,this._webglDungeon&&(this._webglDungeon.container.visible=!1)}}_syncStateFromSystems(){const e=this._systems.gameTime;this._state.world.gameTime=e.totalMinutes,this._state.world.day=e.day,this._state.world.hour=e.hour,this._state.world.minute=e.minute,this._state.world.season=["spring","summer","autumn","winter"].indexOf(e.season),this._state.world.globalCorruption=this._systems.corruption.globalCorruption}_checkViewModeTriggers(){if(this._viewMode.mode!==se.ISOMETRIC||this._viewMode.isTransitioning)return;const e=this._input.wasPressed("KeyE");for(const t of this._buildings){if(!(t.def.features?.includes("dungeon")??!1))continue;const s=t.tileX*L+t.def.widthTiles*L/2,a=t.tileY*L+t.def.heightTiles*L/2,r=this._player.x-s,n=this._player.y-a;if(Math.sqrt(r*r+n*n)<48&&e){this._state.view.dungeonId=t.def.id,this._viewMode.startTransition(se.TOP_DOWN,"enter_dungeon",this._player.x,this._player.y),this._state.view.returnX=this._player.x,this._state.view.returnY=this._player.y,console.log(`[WorldScene] Entering dungeon: ${t.def.id}`);return}}for(const t of this._buildings){if(!(t.def.features?.includes("shop")||t.def.features?.includes("rest")||t.def.features?.includes("forge")||t.def.features?.includes("potions")||t.def.features?.includes("heal")))continue;const s=t.tileX*L+t.def.widthTiles*L/2,a=t.tileY*L+t.def.heightTiles*L,r=this._player.x-s,n=this._player.y-a;if(Math.sqrt(r*r+n*n)<40&&e){const c={blacksmith:"smithy",herb_shop:"apothecary"}[t.def.id]??t.def.id;this._viewMode.startTransition(se.TOP_DOWN,"enter_interior",this._player.x,this._player.y),this._state.view.interiorId=c,console.log(`[WorldScene] Entering ${t.def.id} (interior: ${c})...`);return}}if(e&&this._nearRift){const t=this._systems.rift.enterRift(this._nearRift.id);if(t){console.log(`[WorldScene] Entering rift portal (depth ${t.depth}, mods: ${t.modifiers.join(", ")})`),this._ui.notify(`Entering Rift (Floor ${t.depth})`,"#c4b5fd"),t.modifiers.length>0&&this._ui.notify(`Modifiers: ${t.modifiers.join(", ")}`,"#9ca3af"),this._spawnVFX("energy_swirl",this._player.x,this._player.y,1.2,10,.06),this._spawnVFX("magic_circle",this._player.x,this._player.y+5,1,10,.07),this._state.view.dungeonId=`rift_${this._nearRift.id}`,this._viewMode.startTransition(se.TOP_DOWN,"enter_dungeon",this._player.x,this._player.y),this._state.view.returnX=this._player.x,this._state.view.returnY=this._player.y;return}}if(e)for(const t of this._systems.colony.settlements)for(const i of t.structures){if(i.type!=="well"||i.buildProgress<1)continue;const s=i.tileX*L,a=i.tileY*L,r=this._player.x-s,n=this._player.y-a;if(r*r+n*n<2304){this._systems.survival.drink(60),this._ui.notify("Drank from the well. Thirst restored!","#4FC3F7"),this._spawnVFX("water_splash",this._player.x,this._player.y,.8,6,.08),this._systems.audio.playSFX("pickup");return}}}render(){if(!this._ready)return;const e=this._ctx,t=this._bgCtx;if(!e)return;const i=performance.now();this._frameTimeMs=Date.now(),this._renderFrameSkip=(this._renderFrameSkip+1)%3600,e.clearRect(0,0,v.width,v.height);const s=this._viewMode.mode;if(s===se.ISOMETRIC&&this._webgl?.ready)this._webgl.canvas.style.display="",this._bgCanvas.style.display="none",this._renderIsometricWebGL();else if(s===se.TOP_DOWN&&this._webglDungeon&&this._webgl?.ready)this._webgl.canvas.style.display="",this._bgCanvas.style.display="none",this._renderTopDownWebGL();else if(s===se.SIDE_SCROLL&&this._webglBossArena?.built&&this._webgl?.ready)this._webgl.canvas.style.display="",this._bgCanvas.style.display="none",this._renderSideScrollWebGL();else{this._webgl&&(this._webgl.canvas.style.display="none"),this._bgCanvas.style.display="";const m=Math.abs(Math.round(this._camera.x)-this._lastBgCamX),_=Math.abs(Math.round(this._camera.y)-this._lastBgCamY),p=m>3||_>3,g=this._renderFrameSkip<=1||p||this._renderFrameSkip%4===0;switch(g&&t&&t.clearRect(0,0,v.width,v.height),s){case se.ISOMETRIC:this._renderIsometric(e,g&&t?t:null);break;case se.TOP_DOWN:this._renderTopDown(e,g&&t?t:null);break;case se.SIDE_SCROLL:this._renderSideScroll(e,g&&t?t:null);break}if(this._systems.corruption.renderOverlay(e,v.width,v.height),this._systems.shadowWorld.isInShadow){const b=.25+Math.sin(performance.now()*.001)*.05;e.fillStyle=`rgba(80, 20, 120, ${b.toFixed(3)})`,e.fillRect(0,0,v.width,v.height)}if(this._systems.shadowWorld.isTransitioning){const b=this._systems.shadowWorld.transitionProgress,w=Math.sin(b*Math.PI);e.fillStyle=`rgba(120, 40, 200, ${(w*.6).toFixed(3)})`,e.fillRect(0,0,v.width,v.height)}const y=this._systems.gameTime.darkness;if(y>0&&(e.fillStyle=`rgba(10, 10, 40, ${(y*.6).toFixed(2)})`,e.fillRect(0,0,v.width,v.height)),this._levelUpFlash>0){const b=this._levelUpFlash;if(b>1.7){const R=(b-1.7)/.3*.4;e.fillStyle=`rgba(255,255,255,${R.toFixed(3)})`,e.fillRect(0,0,v.width,v.height)}const w=Math.sin(b*8)*.12;w>0&&(e.fillStyle=`rgba(255,215,0,${w.toFixed(3)})`,e.fillRect(0,0,v.width,v.height));const k=Math.min(.15,b*.05),T=this._isoRenderer.worldToScreen(this._player.x,this._player.y),M=T.sx-(this._camera.x-v.width/2)+v.width/2,C=T.sy-(this._camera.y-v.height/2)+v.height/2,P=`${M|0}:${C|0}:${k*1e3|0}`;(!this._gradGoldenGlow||this._gradGoldenGlowKey!==P)&&(this._gradGoldenGlow=e.createRadialGradient(M,C,0,M,C,200),this._gradGoldenGlow.addColorStop(0,`rgba(255,215,0,${k.toFixed(3)})`),this._gradGoldenGlow.addColorStop(1,"rgba(255,215,0,0)"),this._gradGoldenGlowKey=P),e.fillStyle=this._gradGoldenGlow,e.fillRect(0,0,v.width,v.height)}if(this._damageFlash>0){const b=this._damageFlash/.2*.18,w=`${v.width}:${v.height}:${b*1e3|0}`;(!this._gradDmgVig||this._gradDmgVigKey!==w)&&(this._gradDmgVig=e.createRadialGradient(v.width/2,v.height/2,v.height*.3,v.width/2,v.height/2,v.height*.7),this._gradDmgVig.addColorStop(0,"rgba(200,20,20,0)"),this._gradDmgVig.addColorStop(1,`rgba(200,20,20,${(b*1.5).toFixed(3)})`),this._gradDmgVigKey=w),e.fillStyle=this._gradDmgVig,e.fillRect(0,0,v.width,v.height)}if(this._comboMilestoneFlash>0){const b=ls[this._comboMilestoneTier]??"#ffffff";e.globalAlpha=this._comboMilestoneFlash*.2,e.fillStyle=b,e.fillRect(0,0,v.width,v.height),e.globalAlpha=1}const S=this._player.health/this._player.maxHealth;if(S<.3&&S>0){const b=1-S/.3,w=.5+.5*Math.sin(performance.now()*.004),k=b*w*.25;e.fillStyle=`rgba(180, 0, 0, ${k.toFixed(2)})`,e.fillRect(0,0,v.width,v.height)}}this._viewMode.renderTransition(e,v.width,v.height);const a=this._systems.gameTime,r=a.isNight?"Night":a.isDawn?"Dawn":a.isDusk?"Dusk":"Day";ag(e,this._damageFlash),this._critFlash>0&&(e.save(),e.globalAlpha=this._critFlash/.12*.1,e.fillStyle="#ffd700",e.fillRect(0,0,v.width,v.height),e.restore());const n=this._systems.survival.state.temperature;if(n<32){const m=Math.min(.35,(32-n)/30);e.save();const _=e.createRadialGradient(v.width/2,v.height/2,v.width*.3,v.width/2,v.height/2,v.width*.65);_.addColorStop(0,"rgba(100,160,255,0)"),_.addColorStop(1,`rgba(100,160,255,${m})`),e.fillStyle=_,e.fillRect(0,0,v.width,v.height),e.restore()}else if(n>42){const m=Math.min(.35,(n-42)/20);e.save();const _=e.createRadialGradient(v.width/2,v.height/2,v.width*.3,v.width/2,v.height/2,v.width*.65);_.addColorStop(0,"rgba(255,120,50,0)"),_.addColorStop(1,`rgba(255,120,50,${m})`),e.fillStyle=_,e.fillRect(0,0,v.width,v.height),e.restore()}const l=this._player.maxHealth>0?this._player.health/this._player.maxHealth:1;if(l<.25&&l>0){const m=.5+.5*Math.sin(performance.now()*.006),_=Math.min(.4,(.25-l)*2)*m;e.save();const p=e.createRadialGradient(v.width/2,v.height/2,v.width*.2,v.width/2,v.height/2,v.width*.6);p.addColorStop(0,"rgba(180,0,0,0)"),p.addColorStop(1,`rgba(180,0,0,${_})`),e.fillStyle=p,e.fillRect(0,0,v.width,v.height),e.restore()}const h=this._systems.corruption.getCorruptionAt(Math.floor(this._player.x/L),Math.floor(this._player.y/L));if(h>.1){const m=.7+.3*Math.sin(performance.now()*.003),_=Math.min(.25,h*.3)*m;e.save();const p=e.createRadialGradient(v.width/2,v.height/2,v.width*.25,v.width/2,v.height/2,v.width*.7);p.addColorStop(0,"rgba(80,20,120,0)"),p.addColorStop(1,`rgba(80,20,120,${_})`),e.fillStyle=p,e.fillRect(0,0,v.width,v.height),e.restore()}J_(e,this._player,this._fps,a.day,r,this._systems.survival.state,this._hotbarSlot,this._systems.classSystem.skillPoints,this._inventory.slots,this._sprites,this._systems.combat.comboCount,this._systems.combat.comboTier,this._currentBiome?.name??"Haven");{const _=(Fi[this._systems.classSystem.className]?.skills??[]).filter(k=>k!=="basic_attack"&&k!=="dodge_roll"),p=["Z","X"],g=36,y=4,S=_.length*g+(_.length-1)*y,b=(v.width-S)/2,w=v.height-110;for(let k=0;k<_.length;k++){const T=_[k],M=bs[T];if(!M)continue;const C=b+k*(g+y);e.fillStyle="rgba(20,15,10,0.75)",e.beginPath(),e.roundRect(C,w,g,g,5),e.fill();const P=this._systems.classSystem.getCooldown(T),R=M.cooldown;if(P>0){const F=P/R;e.fillStyle="rgba(0,0,0,0.6)",e.fillRect(C+2,w+2+(1-F)*(g-4),g-4,F*(g-4))}this._systems.classSystem.level<M.unlockLevel?(e.fillStyle="rgba(0,0,0,0.7)",e.fillRect(C+2,w+2,g-4,g-4),e.font="8px monospace",e.fillStyle="#ef4444",e.textAlign="center",e.fillText(`Lv${M.unlockLevel}`,C+g/2,w+g/2+3)):(e.font="16px sans-serif",e.textAlign="center",e.fillStyle=P>0?"rgba(255,255,255,0.4)":"#fff",e.fillText(M.icon,C+g/2,w+g/2+5)),P>0&&(e.font="bold 10px monospace",e.fillStyle="#f59e0b",e.textAlign="center",e.fillText(P.toFixed(1),C+g/2,w+g-4)),e.font="8px monospace",e.fillStyle="rgba(255,255,255,0.5)",e.textAlign="left",e.fillText(p[k]??`${k+1}`,C+3,w+9),e.strokeStyle=P>0?"rgba(255,255,255,0.1)":"rgba(212,160,48,0.5)",e.lineWidth=1,e.beginPath(),e.roundRect(C,w,g,g,5),e.stroke()}if(this._skillBuffs.size>0){let k=0;const T=b+S+10;for(const[M,C]of this._skillBuffs){const P=T+k*28,R=w+4;e.fillStyle="rgba(60,40,10,0.7)",e.beginPath(),e.roundRect(P,R,24,28,4),e.fill();const B={damage_boost:"",invulnerable:"",poison_blade:"",stealth:""};e.font="12px sans-serif",e.textAlign="center",e.fillStyle="#fff",e.fillText(B[M]??"?",P+12,R+13),e.font="7px monospace",e.fillStyle="#86efac",e.fillText(`${Math.ceil(C)}`,P+12,R+24),k++}}}const c=this._state.player.classId??"pilgrim";if(sg(e,c,c.charAt(0).toUpperCase()+c.slice(1)),tg(e,this._systems.corruption.globalCorruption,this._systems.corruption.purifiedPercent),this._systems.shadowWorld.isInShadow){const m="SHADOW REALM",_=v.width-10,p=80;e.font="bold 11px monospace",e.textAlign="right";const g=.6+Math.sin(performance.now()*.003)*.4;e.fillStyle=`rgba(168, 85, 247, ${g.toFixed(2)})`,e.fillText(m,_,p),this._systems.shadowWorld.phaseCooldown>0&&(e.font="9px monospace",e.fillStyle="#888",e.fillText(`Phase: ${Math.ceil(this._systems.shadowWorld.phaseCooldown)}s`,_,p+14)),e.textAlign="left"}{let m=this._systems.shadowWorld.isInShadow?100:80;const _=this._systems.corruption.getActiveRaids();for(const g of _){const y=this._player.x-g.targetX,S=this._player.y-g.targetY;if(y*y+S*S<500*500){const b=mt[g.factionId];b&&(e.font="bold 10px monospace",e.textAlign="right",e.fillStyle=b.color,e.fillText(`${b.icon} RAID: ${b.name}`,v.width-10,m),e.font="9px monospace",e.fillStyle="#aaa",e.fillText(`${g.enemyCount} enemies`,v.width-10,m+12),m+=28);break}}const p=this._systems.faction.getActiveWars();for(const g of p){const y=this._player.x-g.locationX,S=this._player.y-g.locationY;if(y*y+S*S<500*500){const b=mt[g.attackerFaction],w=mt[g.defenderFaction];e.font="bold 10px monospace",e.textAlign="right",e.fillStyle="#f59e0b",e.fillText(` WAR: ${b.name} vs ${w.name}`,v.width-10,m),g.playerIntervened?(e.font="9px monospace",e.fillStyle="#22c55e",e.fillText(`Sided with ${mt[g.playerSide]?.name??"unknown"}`,v.width-10,m+12)):(e.font="9px monospace",e.fillStyle="#fbbf24",e.fillText("Press J to intervene",v.width-10,m+12)),m+=28;break}}e.textAlign="left"}{const m=this._systems.temperature.state,_=m.currentZone,p=m.currentHazard;if(p!=="none"){const S={frostbite:"#4FC3F7",hypothermia:"#81D4FA",chill:"#B3E5FC",heat_fatigue:"#FFCC80",heatstroke:"#FF8A65",burning:"#E53935"},b={frostbite:"",hypothermia:"",chill:"",heat_fatigue:"",heatstroke:"",burning:""};e.font="9px monospace",e.fillStyle=S[p]??"#fff",e.textAlign="left",e.fillText(`${b[p]??""} ${_.toUpperCase()} ${Math.round(m.bodyTemp)}`,10,42)}}{const m=this._systems.cooking.activeBuffs;if(m.length>0){let p=this._systems.temperature.currentHazard!=="none"?56:42;e.font="8px monospace",e.textAlign="left";for(const g of m){const y=Object.values(Pt).find(S=>S.id===g.recipeId);y&&(e.fillStyle="rgba(251,191,36,0.8)",e.fillText(`${y.icon} ${y.name} (${Math.ceil(g.remaining)}s)`,10,p),p+=11)}}}{const m=this._systems.colony.settlements;for(const _ of m){const p=this._player.x-_.centerX,g=this._player.y-_.centerY;if(p*p+g*g<300*300){const S=v.height-130;e.font="bold 9px monospace",e.textAlign="left",e.fillStyle="#d4a030",e.fillText(` ${_.name} (Lv${_.level})`,10,S),e.font="8px monospace",e.fillStyle="#9ca3af",e.fillText(`Pop: ${_.population}/${_.maxPopulation}  Bldg: ${_.structures.length}  Def: ${_.defense}`,10,S+12);break}}}if(!this._showQuestPanel){const m=this._systems.story.getCurrentQuest();if(m){const _=this._systems.story.getProgress(),p=10,g=v.height-90;let y="",S=0,b=1;for(let w=0;w<m.objectives.length;w++){const k=m.objectives[w],T=_[w]??0;if(T<k.count){y=k.description,S=T,b=k.count;break}}y&&(e.fillStyle="rgba(0,0,0,0.55)",e.beginPath(),e.roundRect(p,g,180,36,5),e.fill(),e.font="8px monospace",e.textAlign="left",e.fillStyle="#fbbf24",e.fillText(m.name.substring(0,24),p+6,g+11),e.fillStyle="#bbb",e.fillText(y.substring(0,28),p+6,g+22),b>1&&(e.fillStyle="#222",e.fillRect(p+6,g+27,168,3),e.fillStyle="#a78bfa",e.fillRect(p+6,g+27,168*(S/b),3)))}}if(this._renderFrameSkip%30===0){const m=this._mapIcons;m.length=0;for(const _ of this._buildings)m.push({x:_.tileX*16,y:_.tileY*16,icon:_.def.icon,color:"#fcd34d"});for(const _ of this._npcs)_.isIndoors||m.push({x:_.x,y:_.y,icon:"",color:"#60a5fa"});if(this._systems.profession.hasBonus("hunter","titan_tracking"))for(const _ of this._systems.titan.getAllTitans())_.state!=="defeated"&&_.state!=="dormant"&&m.push({x:_.x,y:_.y,icon:"",color:"#ff4444"});for(const _ of this._systems.rift.rifts)_.active||m.push({x:_.worldX,y:_.worldY,icon:"",color:"#cc88ff"});this._minimap.setIcons(m)}if(s===se.ISOMETRIC){this._minimap.render(e,v.width,v.height,this._player.x,this._player.y,this._minimapBiomeCb,this._enemies,this._resources);const m=this._minimap.waypoints;if(m.length>0){let _=1/0,p=null;for(const g of m){const y=g.x-this._player.x,S=g.y-this._player.y,b=Math.sqrt(y*y+S*S);b<_&&(_=b,p=g)}if(p&&_>10){const g=p.x-this._player.x,y=p.y-this._player.y,S=Math.atan2(y,g),b=["E","SE","S","SW","W","NW","N","NE"],w=Math.round((S+Math.PI)/(Math.PI*2)*8)%8,k=b[w]??"N",T=Math.round(_/32);e.font="8px monospace",e.textAlign="right",e.fillStyle="#fbbf24",e.fillText(`Pin: ${T}t ${k}`,v.width-15,215)}}}if(s===se.TOP_DOWN&&this._currentDungeon){this._renderDungeonMinimap(e);const m=this._dungeonEnemies.filter(g=>g.alive).length,_=this._dungeonEnemies.length,p=_-m;e.save(),e.font="9px monospace",e.textAlign="right",e.fillStyle=m===0?"#4ade80":"#e5e7eb",e.fillText(m===0?"Floor Cleared!":`Enemies: ${p}/${_}`,v.width-15,110),e.restore()}this._showInventory&&this._renderInventoryPanel(e),this._showCrafting&&this._renderCraftingPanel(e),this._showEquipment&&this._renderEquipmentPanel(e),this._showShop&&this._activeShop&&this._renderShopPanel(e),this._showFarmUI&&this._renderFarmUI(e),this._showFishing&&this._renderFishingUI(e),this._showTechTree&&this._renderTechTreePanel(e),this._showMail&&this._renderMailPanel(e),this._showControls&&this._renderControlsHelp(e),this._showStorage&&this._activeContainer&&this._renderStoragePanel(e),this._showMinigame&&this._renderMinigameOverlay(e),this._systems.festival.activeFestival&&this._renderFestivalBanner(e),this._gamePaused&&!this._showSettings&&this._renderPauseOverlay(e),this._showSettings&&(e.fillStyle="rgba(0,0,0,0.7)",e.fillRect(0,0,v.width,v.height),this._systems.settings.renderSettingsPanel(e,v.width,v.height));const d=this._systems.mail.unreadCount;d>0&&!this._showMail&&(e.font="10px monospace",e.textAlign="left",e.fillStyle="#f59e0b",e.fillText(` ${d} unread`,10,v.height-30));const u=this._showInventory||this._showCrafting||this._showEquipment||this._showShop||this._showQuestPanel||this._showTechTree||this._showFishing||this._showFarmUI||this._showMail||this._showStorage||this._showMinigame||this._showSettings||this._gamePaused;if(this._systems.tutorial.isActive&&this._systems.tutorial.currentStep&&!u&&this._renderTutorial(e),this._systems.cutscene.isActive&&this._renderCutscene(e),this._ui.render(e,v.width,v.height,this._sprites),this._renderCombatHUD(e),this._systems.statusEffects.renderIcons(e,10,120),this._systems.achievement.renderPopup(e,v.width),this._renderClassInfo(e),Math.abs(this._camera.zoom-1)>.01){const m=`${Math.round(this._camera.zoom*100)}%`;e.font="9px monospace",e.textAlign="right",e.fillStyle="rgba(200,200,200,0.6)",e.fillText(`Zoom: ${m}  [Home reset]`,v.width-10,v.height-10)}this._playerDead&&this._renderDeathScreen(e),this._showDebug&&this._renderDebugInfo(e);const f=performance.now()-i;f>80&&this._safeFrameCount%60===0&&console.warn(`[Render] Total: ${f.toFixed(1)}ms frame=${this._safeFrameCount}`)}_lastBgCamX=-9999;_lastBgCamY=-9999;_getVignette(){if(this._vignetteCanvas)return this._vignetteCanvas;const e=document.createElement("canvas");e.width=v.width,e.height=v.height;const t=e.getContext("2d"),i=v.width/2,s=v.height/2,a=Math.max(i,s)*1.15,r=a*.55,n=t.createRadialGradient(i,s,r,i,s,a);return n.addColorStop(0,"rgba(8, 6, 20, 0)"),n.addColorStop(.5,"rgba(8, 6, 20, 0.25)"),n.addColorStop(.8,"rgba(8, 6, 20, 0.6)"),n.addColorStop(1,"rgba(8, 6, 20, 0.85)"),t.fillStyle=n,t.fillRect(0,0,v.width,v.height),this._vignetteCanvas=e,e}_renderIsometricWebGL(){const e=this._webgl,t=Math.round(this._camera.x)+this._camera.shakeX,i=Math.round(this._camera.y)+this._camera.shakeY,s=this._isoRenderer.worldToScreen(this._player.x,this._player.y),a=s.sx,r=s.sy;if(this._webglIso.render(t,i,v.width,v.height),this._webglEntities){const l=this._player.facing===2||this._player.facing===0?"Right":"Left",h=this._player.isMoving?"Run":"Idle",c=Math.floor(this._frameTimeMs/150)%6;this._webglEntities.updatePlayer(this._player.x,this._player.y,this._state.player.classId,l,h,c,this._player.hitFlash>0),this._webglEntities.updateEnemiesRaw(this._enemies,t,i,v.width,v.height),this._webglEntities.updateNPCsRaw(this._npcs,t,i,v.width,v.height),this._webglEntities.updateBuildingsRaw(this._buildings,this._systems.gameTime.isNight,t,i,v.width,v.height),this._webglEntities.updateResourcesRaw(this._resources,t,i,v.width,v.height),this._webglEntities.updateDropsRaw(this._worldDrops,this._frameTimeMs,t,i,v.width,v.height),this._webglEntities.updateTreesRaw(this._decorTrees,this._currentBiome?.id??"haven",this._frameTimeMs,t,i,v.width,v.height)}if(this._webglParticles){const l=this._particles.getActiveParticles();this._webglParticles.update(l,t,i)}if(this._webglLighting&&this._webglLighting.update(v.width,v.height,this._lighting.ambientLight,this._lighting.getLightsArray(),t,i,performance.now()/1e3),this._webglScreenFX){const l=this._systems.corruption._globalCorruption??0;this._webglScreenFX.updateCorruptionTint(l*.3),this._webglScreenFX.updateNight(this._systems.gameTime.darkness),this._webglScreenFX.updateLevelUpFlash(this._levelUpFlash),this._webglScreenFX.updateDamageFlash(this._damageFlash);const h=ls[this._comboMilestoneTier]??"#ffffff",c=parseInt(h.replace("#",""),16)||16777215;this._webglScreenFX.updateComboFlash(this._comboMilestoneFlash,c);const d=this._player.health/this._player.maxHealth;if(this._webglScreenFX.updateLowHealth(d),this._systems.shadowWorld.isInShadow){const u=.15+Math.sin(performance.now()*.001)*.03;this._webglScreenFX.updateCorruptionTint(Math.max(l*.3,u))}if(this._systems.shadowWorld.isTransitioning){const u=this._systems.shadowWorld.transitionProgress;this._webglScreenFX.updateDamageFlash(Math.sin(u*Math.PI)*.6)}}e.setCamera(a,r),e.setShake(this._camera.shakeX,this._camera.shakeY),e.applyCamera();const n=this._ctx;n&&n.drawImage(this._getVignette(),0,0)}_renderTopDownWebGL(){const e=this._webgl,t=this._webglDungeon,i=this._ctx;if(!i)return;const s=Date.now();if(!t.hasFloor&&this._currentDungeon&&(t.buildFloor({width:this._currentDungeon.width,height:this._currentDungeon.height,tiles:this._currentDungeon.tiles,theme:this._currentDungeon.theme,level:this._currentDungeon.level}),e.world.children.includes(t.container)||e.world.addChild(t.container),t.container.visible=!0,e.terrainLayer.visible=!1,e.groundLayer.visible=!1),this._currentDungeon){const h=this._state.player.classId,c=this._sprites.getCharacterSpritePath(h,"Down","Idle"),d=c?this._sprites.getSprite(c)??null:null;t.updateEntitySprite(this._player.eid,this._player.x,this._player.y,6724095,9,!0,d);for(const u of this._dungeonEnemies){if(!u.alive){t.removeEntitySprite(u.eid);continue}const f=u.def.color??"#ff4444",m=parseInt(f.replace("#",""),16)||16729156;let _=null;if(u.def.spriteType){const p=this._sprites.getEnemySpritePath(u.def.spriteType,"Down","Idle");_=this._sprites.getSprite(p)??null}_||(_=u.tileSpriteImg),t.updateEntitySprite(u.eid,u.x,u.y,m,8,!1,_)}}t.container.x=0,t.container.y=0,e.setCamera(this._player.x,this._player.y),e.setShake(this._camera.shakeX,this._camera.shakeY),e.applyCamera();const a=v.width/2-this._player.x,r=v.height/2-this._player.y,n=v.width/2+this._camera.shakeX,l=v.height/2+this._camera.shakeY;if(this._currentDungeon){for(const m of this._currentDungeon.rooms){const _=m.x*16+m.width*16/2+a,p=m.y*16+r+8;if(_>-50&&_<v.width+50&&p>-50&&p<v.height+50&&m.type!=="normal"&&m.type!=="entrance"){i.font="9px monospace",i.textAlign="center";const g={boss:"#ff4444",treasure:"#ffd700",rest:"#4ade80",shop:"#60a5fa",trap:"#ff8800",puzzle:"#a78bfa"};i.fillStyle=g[m.type]??"#aaa";const y={boss:"BOSS",treasure:"TREASURE",rest:"REST",shop:"SHOP",trap:"TRAP",puzzle:"PUZZLE"};i.fillText(y[m.type]??m.type.toUpperCase(),_,p)}}for(const m of this._dungeonEnemies){if(!m.alive)continue;const _=m.x+a,p=m.y+r;if(_<-30||_>v.width+30||p<-30||p>v.height+30)continue;const g=this._dungeonEnemyAttackCDs.get(m.eid)??0,y=this._player.x-m.x,S=this._player.y-m.y,b=Math.sqrt(y*y+S*S);if(g<=.4&&g>0&&b<50){const M=1-g/.4,C=8+M*14;i.save(),i.fillStyle=`rgba(255,30,30,${(.12*M).toFixed(2)})`,i.beginPath(),i.arc(_,p,C,0,Math.PI*2),i.fill();const P=.6+.4*Math.sin(performance.now()*.015);i.strokeStyle=`rgba(255,50,50,${(.7*M*P).toFixed(2)})`,i.lineWidth=2,i.setLineDash([3,3]),i.stroke(),i.setLineDash([]),M>.6&&(i.font=`bold ${Math.round(10+M*4)}px monospace`,i.fillStyle=`rgba(255,80,80,${M.toFixed(2)})`,i.textAlign="center",i.fillText("!",_,p-C-4)),i.restore()}const w=x.max[m.eid]??1,k=w>0?(x.current[m.eid]??0)/w:1;if(k<1&&k>0||this._systems.profession.hasBonus("hunter","enemy_hp_bars")){const P=p-20;i.fillStyle="rgba(0,0,0,0.8)",i.beginPath(),i.roundRect(_-32/2-1,P-1,34,6,2),i.fill();const R=k>.5?"#4ade80":k>.25?"#f59e0b":"#ef4444";i.fillStyle=R,i.beginPath(),i.roundRect(_-32/2,P,32*k,4,1),i.fill(),i.font="bold 7px monospace",i.textAlign="center";const B=m.def.xpReward/(this._player.level*10+10),F=B>2?"#ff4444":B>1.2?"#ff8844":B>.6?"#e5e7eb":"#888888";i.fillStyle=F;const W=B>2?" ":"";i.fillText(`${W}${m.def.name}`,_,P-4)}}const c=[Math.PI/2,-Math.PI/2,0,Math.PI];if(this._player.isAttacking&&this._player.attackTimer>0){const m=1-this._player.attackTimer/.25,p=(c[this._player.facing]??0)-.8,g=p+m*1.6,y=30+m*10;i.save(),i.strokeStyle=`rgba(200,220,255,${(.7*(1-m)).toFixed(2)})`,i.lineWidth=3,i.lineCap="round",i.beginPath(),i.arc(n,l,y,p,g),i.stroke(),i.strokeStyle=`rgba(100,180,255,${(.3*(1-m)).toFixed(2)})`,i.lineWidth=6,i.beginPath(),i.arc(n,l,y-2,p,g),i.stroke(),i.restore()}if(this._player.isDodging){const m=Math.max(.05,this._player.dodgeTimer/.25)*.3,_=c[this._player.facing]??0;for(let p=1;p<=3;p++){const g=n-Math.cos(_)*p*12,y=l-Math.sin(_)*p*12;i.globalAlpha=m/p,i.fillStyle="#88bbff",i.beginPath(),i.arc(g,y,8-p,0,Math.PI*2),i.fill()}i.globalAlpha=1}const d=`${v.width}:${v.height}`;(!this._gradDungeonVig||this._gradDungeonVigKey!==d)&&(this._gradDungeonVig=i.createRadialGradient(v.width/2,v.height/2,v.width*.25,v.width/2,v.height/2,v.width*.6),this._gradDungeonVig.addColorStop(0,"rgba(0,0,0,0)"),this._gradDungeonVig.addColorStop(.7,"rgba(0,0,0,0.3)"),this._gradDungeonVig.addColorStop(1,"rgba(0,0,0,0.65)"),this._gradDungeonVigKey=d),i.fillStyle=this._gradDungeonVig,i.fillRect(0,0,v.width,v.height);const u=80+Math.sin(s*.008)*8+Math.sin(s*.013)*4,f=`${n|0}:${l|0}:${u|0}`;(!this._gradTorch||this._gradTorchKey!==f)&&(this._gradTorch=i.createRadialGradient(n,l,0,n,l,u),this._gradTorch.addColorStop(0,"rgba(255,200,100,0.08)"),this._gradTorch.addColorStop(.5,"rgba(255,180,80,0.04)"),this._gradTorch.addColorStop(1,"rgba(255,150,50,0)"),this._gradTorchKey=f),i.fillStyle=this._gradTorch,i.beginPath(),i.arc(n,l,u,0,Math.PI*2),i.fill()}else i.fillStyle="#aaa",i.font="14px monospace",i.textAlign="center",i.fillText("Interior view  under construction",v.width/2,v.height/2);if(this._renderVFXSpritesTopDown(i),this._renderDamagePopupsTopDown(i),this._particles.render(i,this._camera.x-v.width/2,this._camera.y-v.height/2),i.fillStyle="rgba(0,0,0,0.65)",i.beginPath(),i.roundRect(4,v.height-30,280,24,6),i.fill(),i.fillStyle="rgba(255,255,255,0.85)",i.font="10px monospace",i.textAlign="left",i.fillText("[ESC] Exit   [E] Interact   [SPACE] Attack   [SHIFT] Dodge",10,v.height-14),this._player.dodgeCooldown>0){const h=this._player.dodgeCooldown/.8;i.fillStyle="rgba(0,0,0,0.6)",i.beginPath(),i.roundRect(290,v.height-30,50,24,6),i.fill(),i.fillStyle=`rgba(100,180,255,${(.5+h*.5).toFixed(2)})`,i.beginPath(),i.roundRect(292,v.height-28,46*(1-h),20,4),i.fill(),i.fillStyle="#fff",i.font="8px monospace",i.textAlign="center",i.fillText("DODGE",315,v.height-15)}if(this._currentDungeon){i.fillStyle="rgba(0,0,0,0.75)",i.beginPath(),i.roundRect(v.width/2-180/2,4,180,24,6),i.fill(),i.strokeStyle="rgba(196,181,253,0.3)",i.lineWidth=1,i.beginPath(),i.roundRect(v.width/2-180/2,4,180,24,6),i.stroke(),i.fillStyle="#c4b5fd",i.font="bold 11px monospace",i.textAlign="center";const c={cave:"Cave",ruins:"Ancient Ruins",crypt:"Crypt",mine:"Abandoned Mine",corruption_core:"Corruption Core",rift:"Void Rift",sewer:"Sewer"};i.fillText(`${c[this._currentDungeon.theme]??"Dungeon"} - Floor ${this._currentDungeon.level}`,v.width/2,20)}if(this._dungeonEnemies.length>0){let h=0;for(const c of this._dungeonEnemies)c.alive&&h++;i.fillStyle="rgba(0,0,0,0.65)",i.beginPath(),i.roundRect(v.width-100,4,94,22,6),i.fill(),i.fillStyle=h>0?"#f87171":"#4ade80",i.font="bold 10px monospace",i.textAlign="center",i.fillText(h>0?`Foes: ${h}`:"CLEARED",v.width-53,19)}}_renderIsometric(e,t){const i=Math.round(this._camera.x)+this._camera.shakeX,s=Math.round(this._camera.y)+this._camera.shakeY;t&&(this._lastBgCamX=i,this._lastBgCamY=s,t.fillStyle="#1a1a28",t.fillRect(0,0,v.width,v.height),this._isoRenderer.render(t,i,s,v.width,v.height),this._lighting.render(t,v.width,v.height,0,0)),e.clearRect(0,0,v.width,v.height);const a=this._drawables;a.length=0;const r=80,n=v.width/2,l=v.height/2,h=this._isoRenderer.worldToScreen(this._player.x,this._player.y),c=h.sy;a.push({depth:c,draw:()=>{if(this._player.invincible&&this._player.invincibleTimer>1.2&&Math.sin(this._frameTimeMs*.02)>0&&(e.globalAlpha=.4),this._player.draw(e,this._isoRenderer,this._loader,i,s),e.globalAlpha=1,this._attackArcTimer>0){const y=h.sx-i+n,S=h.sy-s+l-10,b=this._attackArcTimer/.2,w=35+(1-b)*15,k={physical:["#ffffcc","#ffdd44"],fire:["#ff8844","#ff4400"],ice:["#88ddff","#44aaff"],lightning:["#ffff66","#ffee00"],poison:["#88ff44","#44cc00"],void:["#cc88ff","#8844cc"],holy:["#ffffee","#ffe488"]},[T,M]=k[this._attackArcDmgType]??k.physical;e.save(),e.globalAlpha=b*.6,e.strokeStyle=T,e.lineWidth=3,e.shadowColor=M,e.shadowBlur=8,e.beginPath(),e.arc(y,S,w,this._attackArcAngle-.8,this._attackArcAngle+.8),e.stroke(),e.strokeStyle="#ffffff",e.lineWidth=1.5,e.beginPath(),e.arc(y,S,w-3,this._attackArcAngle-.6,this._attackArcAngle+.6),e.stroke(),e.restore()}}});const d=Date.now();for(const y of this._enemies){if(!y.alive)continue;const S=this._isoRenderer.worldToScreen(y.x,y.y),b=S.sy,w=S.sx-i+n,k=S.sy-s+l;if(w<-r||w>v.width+r||k<-r||k>v.height+r)continue;const T=y.isChasing;a.push({depth:b,draw:()=>{const M=Math.floor(y.x/L),C=Math.floor(y.y/L),P=this._systems.corruption.getCorruptionGlow(M,C);if(P&&(e.fillStyle=P.color+"25",e.beginPath(),e.arc(w,k-8,14,0,Math.PI*2),e.fill()),T){const R=.15+Math.sin(d*.008)*.08;e.strokeStyle=`rgba(255,60,60,${R.toFixed(2)})`,e.lineWidth=1.5,e.beginPath(),e.arc(w,k-4,16,0,Math.PI*2),e.stroke()}y.draw(e,this._isoRenderer,i,s)}})}for(const y of this._enemyAggroAlerts){const S=this._isoRenderer.worldToScreen(y.x,y.y),b=S.sx-i+n,w=S.sy-s+l;if(b<-50||b>v.width+50||w<-50||w>v.height+50)continue;const k=y.timer/.8,T=k>.7?1+(k-.7)*5:1,M=Math.min(1,k*3);a.push({depth:S.sy+1e3,draw:()=>{e.save(),e.globalAlpha=M,e.font=`bold ${Math.round(18*T)}px monospace`,e.textAlign="center",e.strokeStyle="#000",e.lineWidth=3,e.strokeText("!",b,w-10*T),e.fillStyle="#ff4444",e.fillText("!",b,w-10*T),e.restore()}})}for(const y of this._worldDrops){const S=this._isoRenderer.worldToScreen(y.x,y.y),b=S.sy,w=S.sx-i+n,k=S.sy-s+l;w<-r||w>v.width+r||k<-r||k>v.height+r||a.push({depth:b,draw:()=>{const T=Math.sin(this._frameTimeMs*.004+y.bobPhase)*3,M=k-8+T;if(y.timer<5){const ee=Math.sin(y.timer*8)>0?.4:1;e.globalAlpha=ee}const P=(y.gold>0?null:pe(y.itemId))?.rarity??"common",R=P==="rare"||P==="epic"||P==="legendary",B=P==="uncommon",F=R?.3:B?.2:.15,W=Math.sin(this._frameTimeMs*.003+y.bobPhase)*(R?.15:.05),X=F+W,$=R?12:B?10:8,H=R?rt[P]:void 0;let te;if(y.gold>0)te=`rgba(255,200,50,${X})`;else if(H){const ee=parseInt(H.slice(1,3),16),ue=parseInt(H.slice(3,5),16),be=parseInt(H.slice(5,7),16);te=`rgba(${ee},${ue},${be},${X})`}else te=`rgba(100,255,100,${X})`;if(e.fillStyle=te,e.beginPath(),e.ellipse(w,k+2,$,$*.4,0,0,Math.PI*2),e.fill(),R){const ee=H??"#ffd700",ue=parseInt(ee.slice(1,3),16),be=parseInt(ee.slice(3,5),16),Ee=parseInt(ee.slice(5,7),16),fe=.15+Math.sin(this._frameTimeMs*.003+y.bobPhase)*.08,ve=P==="legendary"?60:P==="epic"?45:30,ae=P==="legendary"?3:2,Me=e.createLinearGradient(w,k-ve,w,k);Me.addColorStop(0,`rgba(${ue},${be},${Ee},0)`),Me.addColorStop(.4,`rgba(${ue},${be},${Ee},${fe})`),Me.addColorStop(1,`rgba(${ue},${be},${Ee},${fe*2})`),e.fillStyle=Me,e.fillRect(w-ae/2,k-ve,ae,ve)}if(R){const ee=this._frameTimeMs*.004+y.bobPhase,ue=w+Math.cos(ee)*10,be=k-4+Math.sin(ee)*4,Ee=.5+Math.sin(this._frameTimeMs*.008)*.3;e.globalAlpha=Ee,e.fillStyle=H??"#ffd700",e.beginPath(),e.arc(ue,be,1.5,0,Math.PI*2),e.fill(),e.globalAlpha=y.timer<5&&Math.sin(y.timer*8)>0?.4:1}let K=!1;if(y.gold>0)e.font="12px serif",e.textAlign="center",e.fillText("",w,M+4),K=!0;else{const ee=this._sprites.getItemSprite(y.itemId);ee&&ee.naturalWidth&&(e.drawImage(ee,w-8,M-8,16,16),K=!0)}if(!K){const ee=pe(y.itemId);e.fillStyle=ee?rt[ee.rarity]:"#4ade80",e.fillRect(w-4,M-4,8,8),e.strokeStyle="#fff",e.lineWidth=.5,e.strokeRect(w-4,M-4,8,8)}e.globalAlpha=1}})}const u=new Set(this._systems.quest.getAvailableQuests().map(y=>y.def.giver)),f=new Set(this._systems.quest.getActiveQuests().filter(y=>y.objectives.every(S=>S.completed)).map(y=>y.def.giver));for(const y of this._npcs){if(y.isIndoors)continue;const S=this._isoRenderer.worldToScreen(y.x,y.y),b=S.sy,w=S.sx-i+n,k=S.sy-s+l;w<-r||w>v.width+r||k<-r||k>v.height+r||a.push({depth:b,draw:()=>{y.draw(e,this._isoRenderer,i,s,this._sprites);const T=u.has(y.def.id),M=f.has(y.def.id);if(T||M){const C=M?"?":"!",P=M?"#4ade80":"#fbbf24",R=Math.sin(Date.now()/400)*3;e.save(),e.font="bold 16px monospace",e.textAlign="center",e.fillStyle=P,e.shadowColor="#000",e.shadowBlur=4,e.fillText(C,w,k-40+R),e.shadowBlur=0,e.restore()}}})}const m=this._systems.gameTime.isNight;for(const y of this._buildings){const S=y.tileX*L+y.def.widthTiles*L/2,b=y.tileY*L+y.def.heightTiles*L/2,w=this._isoRenderer.worldToScreen(S,b),k=w.sy,T=w.sx-i+n,M=w.sy-s+l;T<-r*2||T>v.width+r*2||M<-r*3||M>v.height+r*2||a.push({depth:k-30,draw:()=>Bg(e,y,this._isoRenderer,i,s,m,this._sprites)})}for(const y of this._decorTrees){const S=this._isoRenderer.worldToScreen(y.x,y.y),b=S.sy,w=S.sx-i+n,k=S.sy-s+l;w<-r||w>v.width+r||k<-r||k>v.height+r||a.push({depth:b,draw:()=>{const T=y.scale,M=y.seed,C=this._currentBiome?.id??"haven",P=this._sprites.getTreeSprite(C,M);if(P&&P.naturalWidth){const R=100*T,B=R*(P.naturalWidth/P.naturalHeight),F=Math.sin(this._frameTimeMs*8e-4+y.x*.05)*1;e.fillStyle="rgba(0,0,0,0.1)",e.beginPath(),e.ellipse(w,k+3,B*.3,B*.08,0,0,Math.PI*2),e.fill(),e.save(),e.translate(w+F,k),e.globalAlpha=.85+M%15/100,e.drawImage(P,-B/2,-R+4,B,R),e.globalAlpha=1,e.restore()}else{const B=(15+M%100/100*12)*T;e.fillStyle="rgba(0,0,0,0.1)",e.beginPath(),e.ellipse(w,k+3,B*.6,B*.18,0,0,Math.PI*2),e.fill(),e.fillStyle="#5a3a1a",e.fillRect(w-2*T,k-20*T,4*T,22*T),e.fillStyle="#2a6a2a",e.beginPath(),e.arc(w,k-26*T,B*.7,0,Math.PI*2),e.fill()}}})}for(const y of this._resources){if(y.depleted)continue;const S=this._isoRenderer.worldToScreen(y.x,y.y),b=S.sy,w=S.sx-i+n,k=S.sy-s+l;if(w<-r||w>v.width+r||k<-r||k>v.height+r)continue;const T=Lr[y.type];a.push({depth:b,draw:()=>{const M=w,C=k,P=T?.size??10,R=sb[y.type]??y.type,B=this._sprites.getResourceSpritePath(R),F=B?this._sprites.getSprite(B):void 0;if(y.type==="tree"){const te=y.x*73+y.y*137&65535,K=this._currentBiome?.id??"haven",ee=this._sprites.getTreeSprite(K,te);if(ee&&ee.naturalWidth){const be=120*(.85+te%30/100),Ee=be*(ee.naturalWidth/ee.naturalHeight),fe=Math.sin(this._frameTimeMs*8e-4+y.x*.05)*1.2;e.fillStyle="rgba(0,0,0,0.15)",e.beginPath(),e.ellipse(M,C+4,Ee*.35,Ee*.1,0,0,Math.PI*2),e.fill(),e.save(),e.translate(M+fe,C),e.drawImage(ee,-Ee/2,-be+6,Ee,be),e.restore()}else e.fillStyle="rgba(0,0,0,0.15)",e.beginPath(),e.ellipse(M,C+3,16,5,0,0,Math.PI*2),e.fill(),e.fillStyle="#5a3a1a",e.fillRect(M-3,C-30,6,32),e.fillStyle="#2a6a2a",e.beginPath(),e.arc(M,C-38,16,0,Math.PI*2),e.fill()}else if(F&&F.naturalWidth){const K=F.naturalWidth<=32?P*2.6:P*2,ee=K*(F.naturalHeight/F.naturalWidth);e.fillStyle="rgba(0,0,0,0.2)",e.beginPath(),e.ellipse(M,C+2,K*.4,ee*.1,0,0,Math.PI*2),e.fill();const ue=Math.sin(this._frameTimeMs*.002+y.x*.1+y.y*.13)*1;e.drawImage(F,M-K/2,C-ee+4+ue,K,ee)}else{const te=T?.drop??R,K=this._sprites.getItemSprite(te);if(K&&K.naturalWidth){const ee=P*2,ue=P*2,be=Math.sin(this._frameTimeMs*.002+y.x*.09+y.y*.11)*1.2;e.fillStyle="rgba(0,0,0,0.2)",e.beginPath(),e.ellipse(M,C+2,ee*.4,ue*.12,0,0,Math.PI*2),e.fill(),e.drawImage(K,M-ee/2,C-ue+4+be,ee,ue)}else e.fillStyle=T?.color??"#666",e.beginPath(),e.arc(M,C-P/2,P,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(0,0,0,0.3)",e.lineWidth=1,e.stroke(),T&&(e.font=`${P}px serif`,e.textAlign="center",e.fillText(T.emoji,M,C-P/2+P*.35))}const W=this._player.x-y.x,X=this._player.y-y.y;if(Math.sqrt(W*W+X*X)<60){e.save(),e.globalAlpha=.3+.15*Math.sin(this._frameTimeMs*.004),e.strokeStyle="#fbbf24",e.lineWidth=2,e.beginPath(),e.ellipse(M,C-P*.3,P*1.2,P*.6,0,0,Math.PI*2),e.stroke(),e.restore(),e.font="bold 8px monospace",e.textAlign="center",e.fillStyle="rgba(0,0,0,0.6)";const te=C-P*1.6-6,K=e.measureText(`[E] ${y.type}`).width;e.beginPath(),e.roundRect(M-K/2-4,te-7,K+8,14,3),e.fill(),e.fillStyle="#fbbf24",e.fillText(`[E] ${y.type}`,M,te)}if(y.health<y.maxHealth){const ee=M-14,ue=C-P-6;e.fillStyle="rgba(20,20,20,0.7)",e.beginPath(),e.roundRect(ee-1,ue-1,30,5,2),e.fill(),e.fillStyle="#4ade80",e.fillRect(ee,ue,28*(y.health/y.maxHealth),3)}}})}for(let y=1;y<a.length;y++){const S=a[y];let b=y-1;for(;b>=0&&a[b].depth>S.depth;)a[b+1]=a[b],b--;a[b+1]=S}for(let y=0;y<a.length;y++)a[y].draw();if(this._nearestResource){const y=this._nearestResource,S=this._isoRenderer.worldToScreen(y.x,y.y),b=S.sx-i+v.width/2,w=S.sy-s+v.height/2,T=`[E] Gather ${{rock:"Stone",iron_ore:"Iron Ore",herb:"Herb",crystal:"Crystal",mushroom:"Mushroom"}[y.type]??y.type}`;e.font="bold 10px monospace",e.textAlign="center";const M=e.measureText(T).width;e.fillStyle="rgba(0,0,0,0.7)",e.beginPath(),e.roundRect(b-M/2-6,w-37,M+12,22,4),e.fill(),e.fillStyle="#a8e6a3",e.fillText(T,b,w-26);const C=y.health/y.maxHealth;if(C<1){const P=M+4;e.fillStyle="rgba(0,0,0,0.6)",e.fillRect(b-P/2,w-20,P,3),e.fillStyle=C>.5?"#4ade80":"#f59e0b",e.fillRect(b-P/2,w-20,P*C,3)}}this._attackSwingTimer>0&&this._renderAttackSwing(e,i,s),this._systems.combat.render(e,this._isoRenderer,i,s),this._renderVFXSprites(e,i,s),this._renderDamagePopups(e,i,s),this._particles.render(e,i,s),this._renderEnvParticles(e,i,s),this._systems.weather.render(e,v.width,v.height);const _=this._systems.corruption.getCorruptionAt(Math.floor(this._player.x/L),Math.floor(this._player.y/L));if(this._biomeAmbient.render(e,_),this._biomeBannerAlpha>0&&this._biomeAmbient.renderBiomeBanner(e,this._biomeBannerName,this._biomeBannerIcon,Math.min(1,this._biomeBannerAlpha),this._currentBiome?.dangerLevel??0,this._player.level),this._lighting.ambientLight<.95){const y=1-this._lighting.ambientLight;e.fillStyle=`rgba(8, 6, 20, ${(y*.5).toFixed(3)})`,e.fillRect(0,0,v.width,v.height)}const p=performance.now()*.001;for(const y of this._systems.rift.rifts){if(y.active)continue;const S=this._isoRenderer.worldToScreen(y.worldX,y.worldY),b=S.sx-i+v.width/2,w=S.sy-s+v.height/2;if(b<-40||b>v.width+40||w<-40||w>v.height+40)continue;const k=.5+.5*Math.sin(p*3),T=16+k*4;e.save(),e.globalAlpha=.3+k*.2,e.beginPath(),e.arc(b,w,T+8,0,Math.PI*2),e.fillStyle="#8800ff",e.fill(),e.globalAlpha=.9,e.beginPath(),e.arc(b,w,T,0,Math.PI*2),e.fillStyle="#1a0033",e.fill(),e.globalAlpha=.7;for(let M=0;M<6;M++){const C=p*2+M/6*Math.PI*2,P=T*.6,R=b+Math.cos(C)*P,B=w+Math.sin(C)*P*.6;e.fillStyle=M%2===0?"#cc44ff":"#6600cc",e.fillRect(R-1,B-1,3,3)}if(e.restore(),e.font="bold 8px monospace",e.textAlign="center",e.fillStyle="#cc88ff",e.fillText(`Rift Lv${y.maxDepthReached+1}`,b,w-T-6),this._nearRift&&this._nearRift.id===y.id){const M="[E] Enter Rift";e.font="bold 10px monospace",e.textAlign="center";const C=e.measureText(M).width;e.fillStyle="rgba(0,0,0,0.7)",e.beginPath(),e.roundRect(b-C/2-6,w-T-26,C+12,18,4),e.fill(),e.fillStyle="#cc88ff",e.fillText(M,b,w-T-13)}}const g=this._systems.titan.getAllTitans();for(const y of g){if(y.state==="defeated"||y.state==="dormant")continue;const S=this._isoRenderer.worldToScreen(y.x,y.y),b=S.sx-i+v.width/2,w=S.sy-s+v.height/2;if(b<-60||b>v.width+60||w<-60||w>v.height+60)continue;const k=performance.now()*.001,T=y.state==="enraged",M=y.state==="engaged",C=Math.sin(k*(T?4:1.5));e.save(),e.globalAlpha=.3,e.fillStyle="#000",e.beginPath(),e.ellipse(b,w+12,20,8,0,0,Math.PI*2),e.fill(),e.globalAlpha=.2+C*.1;const P=T?"#ff2200":M?"#ff8800":"#ff6600";e.beginPath(),e.arc(b,w-4,28+C*3,0,Math.PI*2),e.fillStyle=P,e.fill(),e.restore(),e.save();const R=32+C*2,B=22;e.fillStyle=T?"#8b0000":"#4a2800",e.beginPath(),e.moveTo(b,w-R),e.lineTo(b+B,w+4),e.lineTo(b+B*.6,w+10),e.lineTo(b-B*.6,w+10),e.lineTo(b-B,w+4),e.closePath(),e.fill(),e.strokeStyle=T?"#ff4444":"#886633",e.lineWidth=1.5,e.stroke();const F=w-R*.6;if(e.fillStyle=T?"#ff0000":"#ffaa00",e.globalAlpha=.8+C*.2,e.fillRect(b-5,F-1,3,3),e.fillRect(b+3,F-1,3,3),e.restore(),e.font="bold 10px monospace",e.textAlign="center",e.fillStyle=T?"#ff4444":"#ff8800",e.fillText(y.def.name,b,w-R-6),T||M){const W=y.health/y.def.maxHealth,X=44,$=w-R-14;e.fillStyle="#222",e.fillRect(b-X/2-1,$-1,X+2,6),e.fillStyle=W>.5?"#22cc44":W>.25?"#ffaa00":"#ff2200",e.fillRect(b-X/2,$,X*W,4)}}for(const y of this._systems.titan.footprints){const S=this._isoRenderer.worldToScreen(y.x,y.y),b=S.sx-i+v.width/2,w=S.sy-s+v.height/2;if(b<-10||b>v.width+10||w<-10||w>v.height+10)continue;const k=1-y.age/y.maxAge;e.globalAlpha=k*.3,e.fillStyle="#4a2800",e.beginPath(),e.ellipse(b,w,4,2.5,0,0,Math.PI*2),e.fill(),e.globalAlpha=1}if(this._buildMode){e.save(),e.globalAlpha=.15,e.strokeStyle="#88ff88",e.lineWidth=.5;const y=Math.floor(this._player.x/L),S=Math.floor(this._player.y/L);for(let F=y-6;F<=y+6;F++)for(let W=S-6;W<=S+6;W++){const X=this._isoRenderer.worldToScreen(F*L,W*L),$=X.sx-i+v.width/2,H=X.sy-s+v.height/2;e.beginPath(),e.moveTo($,H-L/4),e.lineTo($+L/2,H),e.lineTo($,H+L/4),e.lineTo($-L/2,H),e.closePath(),e.stroke()}e.restore();const b=It[Yt[this._buildSelectedType]],w=b.widthTiles,k=b.heightTiles;let T=!1;for(let F=0;F<w&&!T;F++)for(let W=0;W<k&&!T;W++){const X=Zi(this._buildCursorX+F,this._buildCursorY+W,Vt);(X.type===6||X.type===7)&&(T=!0)}if(!T)for(const F of this._systems.colony.settlements){for(const W of F.structures){const X=It[W.type];if(this._buildCursorX<W.tileX+X.widthTiles&&this._buildCursorX+w>W.tileX&&this._buildCursorY<W.tileY+X.heightTiles&&this._buildCursorY+k>W.tileY){T=!0;break}}if(T)break}e.save(),e.globalAlpha=.5,e.fillStyle=T?"#ff4444":"#44ff44";for(let F=0;F<w;F++)for(let W=0;W<k;W++){const X=this._isoRenderer.worldToScreen((this._buildCursorX+F)*L,(this._buildCursorY+W)*L),$=X.sx-i+v.width/2,H=X.sy-s+v.height/2;e.beginPath(),e.moveTo($,H-L/4),e.lineTo($+L/2,H),e.lineTo($,H+L/4),e.lineTo($-L/2,H),e.closePath(),e.fill()}e.restore();const M=Yt[this._buildSelectedType],C=It[M];this._cachedBuildType!==this._buildSelectedType&&(this._cachedBuildType=this._buildSelectedType,this._cachedBuildCostStr=C.buildCost.map(F=>`${F.count} ${F.itemId}`).join(", "));const P=this._cachedBuildCostStr,R=v.width/2;if(e.fillStyle="rgba(0,0,0,0.8)",e.beginPath(),e.roundRect(R-200,4,400,52,8),e.fill(),e.strokeStyle="rgba(68,255,68,0.5)",e.lineWidth=1,e.beginPath(),e.roundRect(R-200,4,400,52,8),e.stroke(),e.font="bold 11px monospace",e.textAlign="center",e.fillStyle="#44ff44",e.fillText("BUILD MODE",R,18),e.font="10px monospace",e.fillStyle="#fff",e.fillText(`${C.icon} ${C.name}`,R,32),e.font="8px monospace",e.fillStyle="#888",e.fillText("[][] cycle  [Enter] place  [B] exit",R,43),e.fillStyle="#bbbb55",e.fillText(`Cost: ${P}`,R,52),C.description){const F=R+210,W=160,X=[C.description];C.provides&&X.push(`Provides: ${C.provides}`),C.defenseBonus&&X.push(`Defense: +${C.defenseBonus}`),C.purificationRadius&&X.push(`Purify: ${C.purificationRadius} tiles`),C.storageCapacity&&X.push(`Storage: ${C.storageCapacity} slots`),C.housingCapacity&&X.push(`Housing: ${C.housingCapacity}`);const $=10+X.length*12;e.fillStyle="rgba(0,0,0,0.75)",e.beginPath(),e.roundRect(F,4,W,$,5),e.fill(),e.strokeStyle="rgba(68,255,68,0.25)",e.beginPath(),e.roundRect(F,4,W,$,5),e.stroke(),e.font="8px monospace",e.textAlign="left";for(let H=0;H<X.length;H++)e.fillStyle=H===0?"#ccc":"#88cc88",e.fillText(X[H].substring(0,24),F+6,14+H*12);e.textAlign="center"}const B=58;for(let F=0;F<Yt.length;F++){const W=R-(Yt.length-1)*8/2+F*8;e.fillStyle=F===this._buildSelectedType?"#44ff44":"#333",e.beginPath(),e.arc(W,B,2.5,0,Math.PI*2),e.fill()}}for(const y of this._buildings){const S=y.tileX*L+y.def.widthTiles*L/2,b=y.tileY*L+y.def.heightTiles*L/2,w=this._player.x-S,k=this._player.y-b;if(Math.sqrt(w*w+k*k)<60){const M=this._isoRenderer.worldToScreen(S,b),C=M.sx-i+v.width/2,P=M.sy-s+v.height/2,R=y.def.features?.includes("dungeon")??!1,B=y.def.features?.some(F=>["shop","rest","forge","potions","heal"].includes(F))??!1;if(R||B){const F=`[E] Enter ${y.def.name}`;let W=this._buildingFeatureCache.get(y.def.name);W===void 0&&(W=(y.def.features??[]).filter(te=>te!=="dungeon").map(te=>te.charAt(0).toUpperCase()+te.slice(1)).join(" / "),this._buildingFeatureCache.set(y.def.name,W)),e.font="bold 10px monospace",e.textAlign="center";const X=Math.max(e.measureText(F).width,W?e.measureText(W).width:0),$=W?30:18,H=P-42-$;e.fillStyle="rgba(0,0,0,0.8)",e.beginPath(),e.roundRect(C-X/2-8,H,X+16,$,5),e.fill(),e.strokeStyle=R?"rgba(168,85,247,0.3)":"rgba(251,191,36,0.3)",e.lineWidth=1,e.beginPath(),e.roundRect(C-X/2-8,H,X+16,$,5),e.stroke(),e.fillStyle=R?"#c084fc":"#fcd34d",e.fillText(F,C,H+13),W&&(e.font="8px monospace",e.fillStyle="#888",e.fillText(W,C,H+25))}}}if(!this._ui.dialog&&!this._showShop)for(const y of this._npcs){if(y.isIndoors)continue;const S=this._player.x-y.x,b=this._player.y-y.y;if(Math.sqrt(S*S+b*b)<50){const k=this._isoRenderer.worldToScreen(y.x,y.y),T=k.sx-i+v.width/2,M=k.sy-s+v.height/2,P=this._systems.relationship.getRelationship(y.def.id)?.affinity??0,R=P>=80?"Beloved":P>=60?"Friend":P>=40?"Trusted":P>=20?"Known":"Stranger",B=P>=80?"#f472b6":P>=60?"#4ade80":P>=40?"#60a5fa":P>=20?"#fbbf24":"#9ca3af",F=`[E] Talk to ${y.name}`;e.font="bold 10px monospace",e.textAlign="center";const W=Math.max(e.measureText(F).width,90),X=32,$=M-58;e.fillStyle="rgba(0,0,0,0.8)",e.beginPath(),e.roundRect(T-W/2-8,$,W+16,X,5),e.fill(),e.strokeStyle="rgba(96,165,250,0.3)",e.lineWidth=1,e.beginPath(),e.roundRect(T-W/2-8,$,W+16,X,5),e.stroke(),e.fillStyle="#93c5fd",e.fillText(F,T,$+13),e.font="8px monospace",e.fillStyle=B,e.fillText(`${R} (${P})`,T,$+25)}}this._renderOffscreenIndicators(e,i,s),this._showQuestPanel&&this._renderQuestPanel(e)}_renderOffscreenIndicators(e,t,i){let n=0;for(const l of this._enemies){if(!l.alive||!l.isChasing)continue;const h=this._isoRenderer.worldToScreen(l.x,l.y),c=h.sx-t+v.width/2,d=h.sy-i+v.height/2;if(c>=-10&&c<=v.width+10&&d>=-10&&d<=v.height+10)continue;if(++n>6)break;const u=Math.max(24,Math.min(v.width-24,c)),f=Math.max(84,Math.min(v.height-24-70,d)),m=Math.atan2(d-f,c-u),_=.6+.4*Math.sin(performance.now()*.005+n);e.save(),e.globalAlpha=_,e.translate(u,f),e.rotate(m),e.fillStyle="#ff4444",e.beginPath(),e.moveTo(8,0),e.lineTo(-8*.6,-8*.6),e.lineTo(-8*.3,0),e.lineTo(-8*.6,8*.6),e.closePath(),e.fill(),e.globalAlpha=_*.3,e.fillStyle="#ff0000",e.beginPath(),e.arc(0,0,10,0,Math.PI*2),e.fill(),e.restore(),e.save(),e.globalAlpha=_*.8,e.font="7px monospace",e.textAlign="center",e.fillStyle="#ff6666",e.fillText(l.def.name,u,f+8+8),e.restore()}}_renderTopDown(e,t){if(t&&(t.fillStyle="#0a0a1a",t.fillRect(0,0,v.width,v.height)),e.clearRect(0,0,v.width,v.height),this._currentDungeon){this._dungeonRenderer.render(e,this._currentDungeon,this._player.x,this._player.y,v.width,v.height);const s=v.width/2-this._player.x,a=v.height/2-this._player.y,r=Date.now(),n=[Math.PI/2,-Math.PI/2,0,Math.PI],l=16;for(const _ of this._currentDungeon.rooms){const p=_.x*l+_.width*l/2+s,g=_.y*l+a+8;if(p>-50&&p<v.width+50&&g>-50&&g<v.height+50&&_.type!=="normal"&&_.type!=="entrance"){e.font="9px monospace",e.textAlign="center";const y={boss:"#ff4444",treasure:"#ffd700",rest:"#4ade80",shop:"#60a5fa",trap:"#ff8800",puzzle:"#a78bfa"};e.fillStyle=y[_.type]??"#aaa";const S={boss:"BOSS",treasure:"TREASURE",rest:"REST",shop:"SHOP",trap:"TRAP",puzzle:"PUZZLE"};e.fillText(S[_.type]??_.type.toUpperCase(),p,g)}}for(const _ of this._dungeonEnemies){if(!_.alive)continue;const p=_.x+s,g=_.y+a;if(p<-30||p>v.width+30||g<-30||g>v.height+30)continue;const y=this._dungeonEnemyAttackCDs.get(_.eid)??0,S=this._player.x-_.x,b=this._player.y-_.y,w=Math.sqrt(S*S+b*b);if(y<=.4&&y>0&&w<50){const F=1-y/.4,W=8+F*14;e.save(),e.fillStyle=`rgba(255,30,30,${(.12*F).toFixed(2)})`,e.beginPath(),e.arc(p,g,W,0,Math.PI*2),e.fill();const X=.6+.4*Math.sin(performance.now()*.015);e.strokeStyle=`rgba(255,50,50,${(.7*F*X).toFixed(2)})`,e.lineWidth=2,e.setLineDash([3,3]),e.stroke(),e.setLineDash([]),F>.6&&(e.font=`bold ${Math.round(10+F*4)}px monospace`,e.fillStyle=`rgba(255,80,80,${F.toFixed(2)})`,e.textAlign="center",e.fillText("!",p,g-W-4)),e.restore()}e.fillStyle="rgba(0,0,0,0.35)",e.beginPath(),e.ellipse(p,g+10,10,4,0,0,Math.PI*2),e.fill();const k=_.hitFlash>0,T=_.def.color??"#f44";if(!k){const F=e.createRadialGradient(p,g,0,p,g,14);F.addColorStop(0,T+"40"),F.addColorStop(1,"transparent"),e.fillStyle=F,e.beginPath(),e.arc(p,g,14,0,Math.PI*2),e.fill()}e.fillStyle=k?"#ffffff":T,e.beginPath(),e.arc(p,g,8,0,Math.PI*2),e.fill(),e.fillStyle=k?"#ffffff":"rgba(255,255,255,0.25)",e.beginPath(),e.arc(p-2,g-3,3,0,Math.PI*2),e.fill(),e.strokeStyle=k?"#fff":"rgba(0,0,0,0.6)",e.lineWidth=1.5,e.beginPath(),e.arc(p,g,8,0,Math.PI*2),e.stroke();const M=Math.atan2(this._player.y-_.y,this._player.x-_.x),C=4;e.fillStyle=k?"#ff0":"#fff",e.beginPath(),e.arc(p+Math.cos(M-.3)*C,g+Math.sin(M-.3)*C,1.5,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(p+Math.cos(M+.3)*C,g+Math.sin(M+.3)*C,1.5,0,Math.PI*2),e.fill();const P=x.max[_.eid]??1,R=P>0?(x.current[_.eid]??0)/P:1;if(R<1&&R>0||this._systems.profession.hasBonus("hunter","enemy_hp_bars")){const X=g-20;e.fillStyle="rgba(0,0,0,0.8)",e.beginPath(),e.roundRect(p-32/2-1,X-1,34,6,2),e.fill();const $=R>.5?"#4ade80":R>.25?"#f59e0b":"#ef4444";e.fillStyle=$,e.beginPath(),e.roundRect(p-32/2,X,32*R,4,1),e.fill(),e.font="bold 7px monospace",e.fillStyle="rgba(255,255,255,0.85)",e.textAlign="center",e.fillText(_.def.name,p,X-4)}}const h=v.width/2,c=v.height/2;if(this._player.isDodging){const _=Math.max(.05,this._player.dodgeTimer/.25)*.3,p=n[this._player.facing]??0;for(let g=1;g<=3;g++){const y=h-Math.cos(p)*g*12,S=c-Math.sin(p)*g*12;e.globalAlpha=_/g,e.fillStyle="#88bbff",e.beginPath(),e.arc(y,S,8-g,0,Math.PI*2),e.fill()}e.globalAlpha=1}if(!ed(e,this._loader,this._player.appearance,{x:h-16,y:c-24,scale:.55,animation:this._player.animation,direction:this._player.facing,frame:this._player.animFrame})){e.fillStyle="rgba(0,0,0,0.3)",e.beginPath(),e.ellipse(h,c+10,10,4,0,0,Math.PI*2),e.fill(),this._player.isDodging&&(e.globalAlpha=.5+Math.sin(r*.03)*.3);const _=`${h|0}:${c|0}`;(!this._gradPlayerBody||this._gradPlayerBodyKey!==_)&&(this._gradPlayerBody=e.createRadialGradient(h-2,c-3,0,h,c,10),this._gradPlayerBody.addColorStop(0,"#6699ff"),this._gradPlayerBody.addColorStop(1,"#2255cc"),this._gradPlayerBodyKey=_),e.fillStyle=this._gradPlayerBody,e.beginPath(),e.arc(h,c,9,0,Math.PI*2),e.fill(),e.fillStyle="rgba(255,255,255,0.3)",e.beginPath(),e.arc(h-2,c-3,4,0,Math.PI*2),e.fill(),e.strokeStyle="#fff",e.lineWidth=1.5,e.beginPath(),e.arc(h,c,9,0,Math.PI*2),e.stroke();const p=n[this._player.facing]??0;e.strokeStyle="#ddeeff",e.lineWidth=2,e.beginPath(),e.moveTo(h+Math.cos(p)*10,c+Math.sin(p)*10),e.lineTo(h+Math.cos(p)*16,c+Math.sin(p)*16),e.stroke(),e.fillStyle="#fff",e.beginPath(),e.arc(h+Math.cos(p)*16,c+Math.sin(p)*16,2,0,Math.PI*2),e.fill(),e.globalAlpha=1}if(this._player.isAttacking&&this._player.attackTimer>0){const _=1-this._player.attackTimer/.25,g=(n[this._player.facing]??0)-.8,y=g+_*1.6,S=30+_*10;e.save(),e.strokeStyle=`rgba(200,220,255,${(.7*(1-_)).toFixed(2)})`,e.lineWidth=3,e.lineCap="round",e.beginPath(),e.arc(h,c,S,g,y),e.stroke(),e.strokeStyle=`rgba(100,180,255,${(.3*(1-_)).toFixed(2)})`,e.lineWidth=6,e.beginPath(),e.arc(h,c,S-2,g,y),e.stroke(),e.restore()}const u=`${v.width}:${v.height}`;(!this._gradDungeonVig||this._gradDungeonVigKey!==u)&&(this._gradDungeonVig=e.createRadialGradient(v.width/2,v.height/2,v.width*.25,v.width/2,v.height/2,v.width*.6),this._gradDungeonVig.addColorStop(0,"rgba(0,0,0,0)"),this._gradDungeonVig.addColorStop(.7,"rgba(0,0,0,0.3)"),this._gradDungeonVig.addColorStop(1,"rgba(0,0,0,0.65)"),this._gradDungeonVigKey=u),e.fillStyle=this._gradDungeonVig,e.fillRect(0,0,v.width,v.height);const f=80+Math.sin(r*.008)*8+Math.sin(r*.013)*4,m=`${h|0}:${c|0}:${f|0}`;(!this._gradTorch||this._gradTorchKey!==m)&&(this._gradTorch=e.createRadialGradient(h,c,0,h,c,f),this._gradTorch.addColorStop(0,"rgba(255,200,100,0.08)"),this._gradTorch.addColorStop(.5,"rgba(255,180,80,0.04)"),this._gradTorch.addColorStop(1,"rgba(255,150,50,0)"),this._gradTorchKey=m),e.fillStyle=this._gradTorch,e.beginPath(),e.arc(h,c,f,0,Math.PI*2),e.fill()}else this._interiorManager.isInInterior?(this._interiorManager.renderInterior(e,v.width,v.height,this._sprites),e.fillStyle="rgba(0,0,0,0.65)",e.beginPath(),e.roundRect(4,v.height-30,200,24,6),e.fill(),e.fillStyle="rgba(255,255,255,0.85)",e.font="10px monospace",e.textAlign="left",e.fillText("[ESC] Exit   [E] Interact",10,v.height-14)):(e.fillStyle="#aaa",e.font="14px monospace",e.textAlign="center",e.fillText("Unknown top-down view",v.width/2,v.height/2));this._renderVFXSpritesTopDown(e),this._renderDamagePopupsTopDown(e),this._particles.render(e,this._camera.x-v.width/2,this._camera.y-v.height/2);const i=this._getActiveRiftModifiers();if(i.includes("dark")){const s=e.createRadialGradient(v.width/2,v.height/2,40,v.width/2,v.height/2,v.height*.4);s.addColorStop(0,"rgba(0,0,0,0)"),s.addColorStop(.6,"rgba(0,0,0,0.5)"),s.addColorStop(1,"rgba(0,0,0,0.9)"),e.fillStyle=s,e.fillRect(0,0,v.width,v.height)}if(i.length>0){e.fillStyle="rgba(0,0,0,0.65)";const a=i.length*22+8;e.beginPath(),e.roundRect(4,34,a,20,4),e.fill(),e.font="12px serif",e.textAlign="left";for(let r=0;r<i.length;r++){const n=this._systems.rift.getModifierInfo(i[r]);e.fillStyle=n.color,e.fillText(n.icon,8+r*22,49)}}if(e.fillStyle="rgba(0,0,0,0.65)",e.beginPath(),e.roundRect(4,v.height-30,280,24,6),e.fill(),e.fillStyle="rgba(255,255,255,0.85)",e.font="10px monospace",e.textAlign="left",e.fillText("[ESC] Exit   [E] Interact   [SPACE] Attack   [SHIFT] Dodge",10,v.height-14),this._player.dodgeCooldown>0){const s=this._player.dodgeCooldown/.8;e.fillStyle="rgba(0,0,0,0.6)",e.beginPath(),e.roundRect(290,v.height-30,50,24,6),e.fill(),e.fillStyle=`rgba(100,180,255,${(.5+s*.5).toFixed(2)})`,e.beginPath(),e.roundRect(292,v.height-28,46*(1-s),20,4),e.fill(),e.fillStyle="#fff",e.font="8px monospace",e.textAlign="center",e.fillText("DODGE",315,v.height-15)}if(this._currentDungeon){e.fillStyle="rgba(0,0,0,0.75)",e.beginPath(),e.roundRect(v.width/2-180/2,4,180,24,6),e.fill(),e.strokeStyle="rgba(196,181,253,0.3)",e.lineWidth=1,e.beginPath(),e.roundRect(v.width/2-180/2,4,180,24,6),e.stroke(),e.fillStyle="#c4b5fd",e.font="bold 11px monospace",e.textAlign="center";const a={cave:"Cave",ruins:"Ancient Ruins",crypt:"Crypt",mine:"Abandoned Mine",corruption_core:"Corruption Core",rift:"Void Rift",sewer:"Sewer"};e.fillText(`${a[this._currentDungeon.theme]??"Dungeon"} - Floor ${this._currentDungeon.level}`,v.width/2,20)}if(this._dungeonEnemies.length>0){let s=0;for(const r of this._dungeonEnemies)r.alive&&s++;e.fillStyle="rgba(0,0,0,0.65)",e.beginPath(),e.roundRect(v.width-100,4,94,22,6),e.fill(),e.fillStyle=s>0?"#f87171":"#4ade80",e.font="bold 10px monospace",e.textAlign="center",e.fillText(s>0?`Foes: ${s}`:"CLEARED",v.width-53,19);const a=this._state.view.dungeonId;if(s===0&&a&&a.startsWith("rift_")){e.fillStyle="rgba(0,0,0,0.65)",e.beginPath(),e.roundRect(v.width/2-70,v.height/2-15,140,26,6),e.fill(),e.fillStyle="#c4b5fd",e.font="bold 11px monospace",e.textAlign="center";const r=.6+.4*Math.sin(Date.now()*.004);e.globalAlpha=r,e.fillText("[E] Next Floor",v.width/2,v.height/2+2),e.globalAlpha=1}}}_renderSideScrollWebGL(){const e=this._webgl,t=this._webglBossArena,i=this._ctx;if(!i)return;if(!t.built){const n=v.height*.75,l={rotwood:"forest",ashlands:"fire",drowned_depths:"water",bone_wastes:"bone",the_void:"void",edilas:"eden"},h=Js(this._player.x,this._player.y)?.id??"haven",c=l[h]??"forest";t.buildArena({width:v.width*1.5,height:v.height,floorY:n,theme:c,bossName:this._bossName??"Boss",biome:h}),e.world.children.includes(t.container)||e.world.addChild(t.container)}t.container.visible=!0,e.terrainLayer.visible=!1,e.groundLayer.visible=!1,this._webglDungeon&&(this._webglDungeon.container.visible=!1);const s=v.height*.75,a=this._player.facing===2||this._player.facing===0;if(t.updateEntitySprite("player",this._player.x,this._player.y,6724095,16,32,a),this._bossHealth>0){const n=this._bossX<this._player.x;t.updateEntitySprite("boss",this._bossX,s-80,16729156,32,48,n)}if(t.setCamera(this._player.x,v.width,v.height),t.container.x=0,t.container.y=0,e.setCamera(0,0),e.setShake(0,0),e.applyCamera(),this._renderSideScroll(i,null),this._damageFlash>0){const n=this._damageFlash/.2*.18,l=`${v.width}:${v.height}:${n*1e3|0}`;(!this._gradDmgVig||this._gradDmgVigKey!==l)&&(this._gradDmgVig=i.createRadialGradient(v.width/2,v.height/2,v.height*.3,v.width/2,v.height/2,v.height*.7),this._gradDmgVig.addColorStop(0,"rgba(200,20,20,0)"),this._gradDmgVig.addColorStop(1,`rgba(200,20,20,${(n*1.5).toFixed(3)})`),this._gradDmgVigKey=l),i.fillStyle=this._gradDmgVig,i.fillRect(0,0,v.width,v.height)}if(this._comboMilestoneFlash>0){const n=ls[this._comboMilestoneTier]??"#ffffff";i.globalAlpha=this._comboMilestoneFlash*.2,i.fillStyle=n,i.fillRect(0,0,v.width,v.height),i.globalAlpha=1}const r=this._player.health/this._player.maxHealth;if(r<.3&&r>0){const n=1-r/.3,l=.5+.5*Math.sin(performance.now()*.004),h=n*l*.25;i.fillStyle=`rgba(180, 0, 0, ${h.toFixed(2)})`,i.fillRect(0,0,v.width,v.height)}}_renderSideScroll(e,t){const s=this._currentBiome?.tileColors,a=this._systems.combatTiming,r=x.current[this._player.eid]??this._player.health,n=x.max[this._player.eid]??100,l=this._state.view.bossArenaId??"",h={bossId:l,bossSpriteType:T0(l),bossName:this._bossName,bossIcon:this._bossIcon,bossHealth:this._bossHealth,bossMaxHealth:this._bossMaxHealth,bossX:this._bossX,bossY:v.height*.75-80,bossVelX:this._bossVelX,bossPhase:this._bossPhase,bossHitFlash:this._bossHitFlash,bossAttackTelegraph:this._bossAttackTelegraph,playerX:this._player.x,playerY:this._player.y,playerVelY:this._sideScrollPlayerVelY,playerOnGround:this._sideScrollPlayerOnGround,playerHealth:r,playerMaxHealth:n,arenaWidth:v.width,arenaHeight:v.height,groundY:v.height*.75,biomeColors:{grass:s?.grass??"#336633",dirt:s?.dirt??"#664422",rock:s?.rock??"#555555",corruption:s?.corruption??"#440044"},screenShake:this._sideScrollScreenShake,attackCooldown:this._attackCooldown,comboCount:a.comboCount,isAttacking:a.isAttacking,time:Date.now()};this._sideScrollRenderer.render(e,t,h,0),this._renderVFXSpritesScreenSpace(e),this._renderDamagePopupsScreenSpace(e),this._particles.render(e,0,0)}_renderVFXSprites(e,t,i){if(this._vfxSprites.length===0)return;const s=v.width/2,a=v.height/2;e.save();for(const r of this._vfxSprites){if(r.frame>=r.totalFrames)continue;const n=this._isoRenderer.worldToScreen(r.x,r.y),l=n.sx-t+s,h=n.sy-i+a;if(l<-r.frameW||l>v.width+r.frameW||h<-r.frameH||h>v.height+r.frameH)continue;const c=r.frame*r.frameW,d=r.frameW*r.scale,u=r.frameH*r.scale;e.globalAlpha=r.alpha,r.rotation?(e.save(),e.translate(l,h),e.rotate(r.rotation),e.drawImage(r.sprite,c,0,r.frameW,r.frameH,-d/2,-u/2,d,u),e.restore()):e.drawImage(r.sprite,c,0,r.frameW,r.frameH,l-d/2,h-u/2,d,u)}e.globalAlpha=1,e.restore()}_renderVFXSpritesTopDown(e){if(this._vfxSprites.length===0)return;const t=this._camera.x-v.width/2,i=this._camera.y-v.height/2;e.save();for(const s of this._vfxSprites){if(s.frame>=s.totalFrames)continue;const a=s.x-t,r=s.y-i;if(a<-s.frameW||a>v.width+s.frameW||r<-s.frameH||r>v.height+s.frameH)continue;const n=s.frame*s.frameW,l=s.frameW*s.scale,h=s.frameH*s.scale;e.globalAlpha=s.alpha,s.rotation?(e.save(),e.translate(a,r),e.rotate(s.rotation),e.drawImage(s.sprite,n,0,s.frameW,s.frameH,-l/2,-h/2,l,h),e.restore()):e.drawImage(s.sprite,n,0,s.frameW,s.frameH,a-l/2,r-h/2,l,h)}e.globalAlpha=1,e.restore()}_renderVFXSpritesScreenSpace(e){if(this._vfxSprites.length!==0){e.save();for(const t of this._vfxSprites){if(t.frame>=t.totalFrames)continue;const i=t.frame*t.frameW,s=t.frameW*t.scale,a=t.frameH*t.scale;e.globalAlpha=t.alpha,t.rotation?(e.save(),e.translate(t.x,t.y),e.rotate(t.rotation),e.drawImage(t.sprite,i,0,t.frameW,t.frameH,-s/2,-a/2,s,a),e.restore()):e.drawImage(t.sprite,i,0,t.frameW,t.frameH,t.x-s/2,t.y-a/2,s,a)}e.globalAlpha=1,e.restore()}}_renderEnvParticles(e,t,i){if(this._envParticles.length===0)return;const s=v.width/2,a=v.height/2;e.save();for(const r of this._envParticles){const n=this._isoRenderer.worldToScreen(r.x,r.y),l=n.sx-t+s,h=n.sy-i+a;l<-10||l>v.width+10||h<-10||h>v.height+10||(e.globalAlpha=r.alpha,e.fillStyle=r.color,e.beginPath(),e.arc(l,h,r.size,0,Math.PI*2),e.fill())}e.globalAlpha=1,e.restore()}_renderDamagePopupsScreenSpace(e){if(this._damagePopups.length!==0){e.save(),e.textAlign="center",e.textBaseline="middle";for(const t of this._damagePopups){const i=t.timer/t.maxTimer,s=1-i,a=Math.min(1,i*2.5)*Math.min(1,i*1.5);let r;s<.15?r=s/.15*1.25:s<.3?r=1.25-(s-.15)/.15*.25:r=1;const n=t.startSize*r;if(e.globalAlpha=a,e.font=`bold ${Math.round(n)}px monospace`,e.strokeStyle="rgba(0,0,0,0.8)",e.lineWidth=Math.max(2,Math.round(n/6)),t.showCrit){const l=Math.sin(s*20)*(1-s)*.1;e.save(),e.translate(t.x,t.y-n*.7),e.rotate(l),e.font=`bold ${Math.round(n*.6)}px monospace`,e.fillStyle="#ffd700",e.strokeText("CRIT!",0,0),e.fillText("CRIT!",0,0),e.restore(),e.font=`bold ${Math.round(n)}px monospace`}e.strokeText(t.text,t.x,t.y),e.fillStyle=t.color,e.fillText(t.text,t.x,t.y)}e.restore()}}_renderDamagePopupsTopDown(e){if(this._damagePopups.length===0)return;const t=this._camera.x,i=this._camera.y;e.save(),e.textAlign="center",e.textBaseline="middle";for(const s of this._damagePopups){const a=s.timer/s.maxTimer,r=1-a,n=Math.min(1,a*2.5)*Math.min(1,a*1.5);let l;r<.15?l=r/.15*1.25:r<.3?l=1.25-(r-.15)/.15*.25:l=1;const h=s.startSize*l;e.globalAlpha=n;const c=s.x-t+v.width/2,d=s.y-i+v.height/2;if(e.font=`bold ${Math.round(h)}px monospace`,e.strokeStyle="rgba(0,0,0,0.8)",e.lineWidth=Math.max(2,Math.round(h/6)),s.showCrit){const u=Math.sin(r*20)*(1-r)*.1;e.save(),e.translate(c,d-h*.7),e.rotate(u),e.font=`bold ${Math.round(h*.6)}px monospace`,e.fillStyle="#ffd700",e.strokeText("CRIT!",0,0),e.fillText("CRIT!",0,0),e.restore(),e.font=`bold ${Math.round(h)}px monospace`}e.strokeText(s.text,c,d),e.fillStyle=s.color,e.fillText(s.text,c,d)}e.restore()}_renderDamagePopups(e,t,i){if(this._damagePopups.length!==0){e.save(),e.textAlign="center",e.textBaseline="middle";for(const s of this._damagePopups){const a=s.timer/s.maxTimer,r=1-a,n=Math.min(1,a*2.5)*Math.min(1,a*1.5);let l;r<.15?l=r/.15*1.25:r<.3?l=1.25-(r-.15)/.15*.25:l=1;const h=s.startSize*l;e.globalAlpha=n;const c=this._isoRenderer.worldToScreen(s.x,s.y),d=c.sx-t+v.width/2,u=c.sy-i+v.height/2;if(e.font=`bold ${Math.round(h)}px monospace`,e.strokeStyle="rgba(0,0,0,0.8)",e.lineWidth=Math.max(2,Math.round(h/6)),s.showCrit){const f=Math.sin(r*20)*(1-r)*.1;e.save(),e.translate(d,u-h*.7),e.rotate(f),e.font=`bold ${Math.round(h*.6)}px monospace`,e.fillStyle="#ffd700",e.strokeText("CRIT!",0,0),e.fillText("CRIT!",0,0),e.restore(),e.font=`bold ${Math.round(h)}px monospace`}e.strokeText(s.text,d,u),e.fillStyle=s.color,e.fillText(s.text,d,u)}e.restore()}}_renderAttackSwing(e,t,i){const s=this._isoRenderer.worldToScreen(this._player.x,this._player.y),a=s.sx-t,r=s.sy-i,n=this._player.facing,l=[Math.PI*.5,-Math.PI*.5,0,Math.PI][n]??0,h=Math.min(1,this._attackSwingTimer/.15),c=45,d=l-.8,u=l+.8;e.save(),e.globalAlpha=h*.7,e.strokeStyle="#fff",e.lineWidth=3,e.shadowColor="#ff8844",e.shadowBlur=10,e.beginPath(),e.arc(a,r-10,c,d,u),e.stroke(),e.strokeStyle="#ff8844",e.lineWidth=2,e.beginPath(),e.arc(a,r-10,c-5,d+.1,u-.1),e.stroke(),e.restore()}_renderCombatHUD(e){const t=v.width/2;e.textAlign="center";for(const h of this._xpNotifications){const c=Math.min(1,h.timer);e.globalAlpha=c,e.font=h.text.includes("LEVEL")?"bold 20px monospace":"bold 14px monospace",e.fillStyle=h.text.includes("LEVEL")?"#ffd700":"#4ade80",e.shadowColor="#000",e.shadowBlur=4,e.fillText(h.text,t,v.height*.35+h.y),e.shadowBlur=0}e.globalAlpha=1,e.textAlign="right",e.font="13px monospace";let i=v.height*.55;for(const h of this._lootNotifications){const c=Math.min(1,h.timer);e.globalAlpha=c,e.fillStyle=h.color,e.shadowColor="#000",e.shadowBlur=3,e.fillText(h.text,v.width-15,i),e.shadowBlur=0,i+=18}if(e.globalAlpha=1,this._dpsValue>0&&this._dpsTimer>0&&(e.textAlign="right",e.font="10px monospace",e.globalAlpha=Math.min(1,this._dpsTimer),e.fillStyle="#ff8844",e.shadowColor="#000",e.shadowBlur=2,e.fillText(`DPS: ${this._dpsValue}`,v.width-15,i+5),e.shadowBlur=0,e.globalAlpha=1),this._killStreak>=2){const h=Math.min(1,this._killStreakTimer/2);e.globalAlpha=h,e.textAlign="center",e.font="bold 16px monospace";const c=["#fff","#ff0","#f90","#f44","#f0f"];e.fillStyle=c[Math.min(this._killStreak-2,c.length-1)],e.shadowColor="#000",e.shadowBlur=4,e.fillText(` ${this._killStreak}x KILL STREAK`,t,130),e.shadowBlur=0,e.globalAlpha=1}if(this._attackCooldown>0){const h=this._attackCooldown/.45,c=60,d=5,u=t-c/2,f=v.height-50;e.fillStyle="rgba(0,0,0,0.5)",e.beginPath(),e.roundRect(u,f,c,d,2),e.fill();const m=Math.max(4,c*(1-h)),_=`${u}:${f}:${d}:${h*100|0}`;(!this._gradCdBar||this._gradCdBarKey!==_)&&(this._gradCdBar=e.createLinearGradient(u,f,u,f+d),this._gradCdBar.addColorStop(0,`hsl(${(1-h)*120}, 100%, 55%)`),this._gradCdBar.addColorStop(1,`hsl(${(1-h)*120}, 100%, 35%)`),this._gradCdBarKey=_),e.fillStyle=this._gradCdBar,e.beginPath(),e.roundRect(u,f,m,d,2),e.fill()}const s=200,a=7,r=t-s/2,n=68,l=this._player.xpToNext>0?this._player.xp/this._player.xpToNext:0;if(e.fillStyle="rgba(0,0,0,0.5)",e.beginPath(),e.roundRect(r,n,s,a,3),e.fill(),l>0){const h=Math.max(6,s*l),c=`${r}:${n}:${a}`;(!this._gradXpBar||this._gradXpBarKey!==c)&&(this._gradXpBar=e.createLinearGradient(r,n,r,n+a),this._gradXpBar.addColorStop(0,"#a78bfa"),this._gradXpBar.addColorStop(1,"#6d28d9"),this._gradXpBarKey=c),e.fillStyle=this._gradXpBar,e.beginPath(),e.roundRect(r,n,h,a,3),e.fill(),e.fillStyle="rgba(255,255,255,0.12)",e.beginPath(),e.roundRect(r,n,h,a/2,3),e.fill()}e.textAlign="center",e.font="10px monospace",e.fillStyle="#c4b5fd",e.fillText(`${this._player.xp}/${this._player.xpToNext} XP`,t,n+a+12),e.textAlign="left"}_renderInventoryPanel(e){const s=v.width/2-180,a=v.height/2-480/2;e.fillStyle="rgba(0, 0, 0, 0.65)",e.fillRect(0,0,v.width,v.height),e.fillStyle="rgba(12, 12, 18, 0.96)",e.beginPath(),e.roundRect(s,a,360,480,10),e.fill(),e.strokeStyle="rgba(212, 160, 48, 0.4)",e.lineWidth=2,e.stroke(),e.font="bold 15px monospace",e.fillStyle="#fff",e.textAlign="left",e.fillText("INVENTORY",s+16,a+24),e.font="12px monospace",e.fillStyle="#fcd34d",e.textAlign="right",e.fillText(` ${this._inventory.gold}`,s+360-16,a+24);const r=6,n=48,l=6,h=r*(n+l)-l,c=s+(360-h)/2,d=a+42,u=this._inventory.slots;for(let p=0;p<this._inventory.capacity;p++){const g=p%r,y=Math.floor(p/r),S=c+g*(n+l),b=d+y*(n+l),w=u[p],k=w&&w.count>0?pe(w.itemId):void 0,T=p===this._inventorySelectedSlot;if(T?e.fillStyle="rgba(70, 65, 95, 0.98)":k?e.fillStyle="rgba(38, 40, 55, 0.95)":e.fillStyle="rgba(28, 28, 40, 0.9)",e.beginPath(),e.roundRect(S,b,n,n,6),e.fill(),T?(e.strokeStyle="#d4a030",e.lineWidth=2.5,e.shadowColor="rgba(212, 160, 48, 0.6)",e.shadowBlur=8):k?(e.strokeStyle=rt[k.rarity]??"#444",e.lineWidth=1.5,e.shadowBlur=0):(e.strokeStyle="#2a2a3a",e.lineWidth=1,e.shadowBlur=0),e.beginPath(),e.roundRect(S,b,n,n,6),e.stroke(),e.shadowBlur=0,k&&w){const M=this._sprites.getItemSprite(w.itemId),C=6,P=n-C*2;M?e.drawImage(M,S+C,b+C,P,P):(e.font="22px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(k.icon,S+n/2,b+n/2),e.textBaseline="alphabetic");const R=w.count>1?`${w.count}`:"";if(R){e.font="bold 10px monospace";const B=Math.max(14,e.measureText(R).width+6),F=14,W=S+n-B-2,X=b+2;e.fillStyle="rgba(0, 0, 0, 0.7)",e.beginPath(),e.roundRect(W,X,B,F,3),e.fill(),e.fillStyle="#fff",e.textAlign="right",e.fillText(R,S+n-4,X+11)}w.favorite&&(e.font="10px sans-serif",e.textAlign="left",e.fillStyle="#f59e0b",e.fillText("",S+3,b+12))}}const f=d+Math.ceil(this._inventory.capacity/r)*(n+l)+8,m=a+480-f-28;e.fillStyle="rgba(18, 18, 28, 0.9)",e.beginPath(),e.roundRect(s+12,f,336,m,6),e.fill(),e.strokeStyle="rgba(80, 75, 100, 0.5)",e.lineWidth=1,e.stroke(),e.textAlign="left";const _=this._inventory.getSlot(this._inventorySelectedSlot);if(_){const p=pe(_.itemId);if(p){const g=s+20;let y=f+16;const S=this._sprites.getItemSprite(_.itemId);S?(e.drawImage(S,g-2,y-12,16,16),e.font="bold 12px monospace",e.fillStyle=rt[p.rarity]??"#fff",e.textAlign="left",e.fillText(p.name,g+18,y)):(e.font="bold 12px monospace",e.fillStyle=rt[p.rarity]??"#fff",e.textAlign="left",e.fillText(`${p.icon} ${p.name}`,g,y)),y+=14,e.font="9px monospace",e.fillStyle="#888",e.fillText(`${p.rarity.toUpperCase()} ${p.category}`,g,y),y+=14,e.font="9px monospace",e.fillStyle="#bbb";const b=p.description.split(" ");let w="";const k=320;for(const T of b){const M=w+T+" ";e.measureText(M).width>k&&w?(e.fillText(w.trim(),g,y),w=T+" ",y+=12):w=M}if(w.trim()&&(e.fillText(w.trim(),g,y),y+=12),p.stats){y+=2,e.font="9px monospace";const T=p.stats,M=[];T.damage&&M.push(`DMG ${T.damage}`),T.defense&&M.push(`DEF ${T.defense}`),T.health&&M.push(`HP +${T.health}`),T.stamina&&M.push(`STA +${T.stamina}`),T.speed&&M.push(`SPD +${T.speed}`),T.critChance&&M.push(`CRIT ${(T.critChance*100).toFixed(0)}%`),M.length>0&&(e.fillStyle="#7dd3fc",e.fillText(M.join("  "),g,y),y+=12)}if(_.affixes&&_.affixes.length>0){y+=2,e.font="9px monospace";for(const T of _.affixes){const C={damage:"DMG",defense:"DEF",health:"HP",stamina:"STA",speed:"SPD",critChance:"CRIT",critDamage:"CRIT DMG",purification:"PURIFY"}[T.stat]??T.stat,P=T.stat==="critChance"||T.stat==="critDamage"?`+${(T.value*100).toFixed(0)}%`:`+${Math.round(T.value)}`;e.fillStyle="#a78bfa",e.fillText(`${T.name}: ${C} ${P}`,g,y),y+=11}}if(p.stats&&(p.category==="weapon"||p.category==="armor"||p.category==="tool")){let T=null;p.category==="weapon"?T="weapon":p.category==="tool"?T="tool":p.armorSlot&&(T=p.armorSlot);const M=T?this._inventory.equipment[T]:null,C=M?pe(M.itemId):null;if(C?.stats||!C){y+=2,e.font="8px monospace",e.fillStyle="#888",e.fillText(C?`vs ${C.name}:`:"vs nothing equipped:",g,y),y+=10;const P=C?.stats??{},R=["damage","defense","health","stamina","speed","critChance"],B={damage:"DMG",defense:"DEF",health:"HP",stamina:"STA",speed:"SPD",critChance:"CRIT"};for(const F of R){const W=p.stats[F]??0,X=P[F]??0,$=W-X;if($===0&&W===0)continue;const H=B[F]??F,te=$>0?`+${F==="critChance"?($*100).toFixed(0)+"%":$}`:$<0?`${F==="critChance"?($*100).toFixed(0)+"%":$}`:"=";e.fillStyle=$>0?"#4ade80":$<0?"#ef4444":"#888",e.fillText(`  ${H}: ${te}`,g,y),y+=10}}}p.healAmount&&(e.fillStyle="#4ade80",e.fillText(`Heals ${p.healAmount} HP`,g,y),y+=12),e.fillStyle="#fcd34d",e.font="8px monospace",e.fillText(`Value: ${p.value}g`,g,y)}}else e.font="9px monospace",e.fillStyle="#555",e.textAlign="center",e.fillText("Select an item to view details",s+360/2,f+m/2+3);e.font="9px monospace",e.fillStyle="#555",e.textAlign="center",e.fillText("[I] Close  [S] Sort  [F] Fav  [Enter] Use/Equip  [R] Craft",s+360/2,a+480-8)}_renderCraftingPanel(e){const s=v.width/2-170,a=v.height/2-420/2;e.fillStyle="rgba(0,0,0,0.5)",e.fillRect(0,0,v.width,v.height),e.fillStyle="rgba(20, 20, 30, 0.95)",e.beginPath(),e.roundRect(s,a,340,420,8),e.fill(),e.strokeStyle="#886633",e.lineWidth=1,e.stroke(),e.font="bold 16px monospace",e.fillStyle="#fff",e.textAlign="center",e.fillText("CRAFTING",s+340/2,a+25);const r=[{key:"hand",label:" Hand"},{key:"workbench",label:" Bench"},{key:"forge",label:" Forge"},{key:"alchemy_table",label:" Alchemy"},{key:"cooking_fire",label:" Cook"},{key:"enchanting_table",label:" Enchant"}],n=340/r.length;for(let f=0;f<r.length;f++){const m=r[f],_=s+f*n,p=m.key===this._craftingStation;e.fillStyle=p?"rgba(80, 60, 20, 0.9)":"rgba(30, 30, 40, 0.9)",e.beginPath(),e.roundRect(_+1,a+35,n-2,18,3),e.fill(),p&&(e.fillStyle="#ffcc44",e.fillRect(_+4,a+51,n-8,2)),e.font="8px monospace",e.textAlign="center",e.fillStyle=p?"#ffcc44":"#777",e.fillText(m.label,_+n/2,a+48)}const l=this._systems.crafting.getAvailableRecipes(this._craftingStation),h=a+60,c=36,d=9;if(l.length===0)e.font="11px monospace",e.fillStyle="#666",e.textAlign="center",e.fillText("No recipes available",s+340/2,h+40);else{const f=Math.max(0,this._craftingScrollIdx);for(let m=0;m<d&&f+m<l.length;m++){const _=l[f+m],p=h+m*c,g=this._systems.crafting.canCraft(_.id,this._inventory),y=f+m===this._craftingScrollIdx;e.fillStyle=y?"rgba(60, 50, 20, 0.9)":"rgba(30, 30, 40, 0.6)",e.beginPath(),e.roundRect(s+8,p,324,c-2,4),e.fill(),y&&(e.strokeStyle="#ffcc44",e.lineWidth=1,e.beginPath(),e.roundRect(s+8,p,324,c-2,4),e.stroke());const S=pe(_.output.itemId),b=this._sprites.getItemSprite(_.output.itemId),w=22;b?e.drawImage(b,s+12,p+2,w,w):(e.font="14px serif",e.textAlign="center",e.fillText(S?.icon??_.icon,s+12+w/2,p+18));const k=g?S?rt[S.rarity]??"#fff":"#fff":"#555";e.font="bold 10px monospace",e.textAlign="left",e.fillStyle=k,e.fillText(_.name,s+14+w+4,p+14),e.font="8px monospace";let T=s+14+w+4;for(const M of _.materials){const C=this._inventory.countItem(M.itemId),P=C>=M.count,R=pe(M.itemId),B=this._sprites.getItemSprite(M.itemId);B?(e.drawImage(B,T,p+18,12,12),T+=14):R?.icon&&(e.font="10px sans-serif",e.textAlign="left",e.fillStyle="#ddd",e.fillText(R.icon,T,p+28),T+=12,e.font="8px monospace"),e.fillStyle=P?"#66bb6a":"#ef5350",e.textAlign="left";const F=R?.name??M.itemId.replace(/_/g," "),W=`${C}/${M.count} ${F}`;e.fillText(W,T,p+28),T+=e.measureText(W).width+8}e.textAlign="right",e.font="bold 9px monospace",e.fillStyle=g?"#44ff44":"#444",e.fillText(g?"CRAFT":"",s+340-14,p+16)}}const u=this._systems.crafting.activeCraft;if(u){const f=a+420-50,m=320;e.fillStyle="rgba(0,0,0,0.5)",e.beginPath(),e.roundRect(s+10,f,m,20,5),e.fill();const _=u.timer/u.recipe.craftTime;if(_>0){const p=Math.max(10,m*_),g=`${s}:${f}`;(!this._gradCraftBar||this._gradCraftBarKey!==g)&&(this._gradCraftBar=e.createLinearGradient(s+10,f,s+10,f+20),this._gradCraftBar.addColorStop(0,"#fbbf24"),this._gradCraftBar.addColorStop(1,"#d97706"),this._gradCraftBarKey=g),e.fillStyle=this._gradCraftBar,e.beginPath(),e.roundRect(s+10,f,p,20,5),e.fill(),e.fillStyle="rgba(255,255,255,0.12)",e.beginPath(),e.roundRect(s+10,f,p,10,5),e.fill()}e.font="10px monospace",e.textAlign="center",e.fillStyle="#1a1a1a",e.fillText(`Crafting ${u.recipe.name}...`,s+340/2,f+14),e.font="8px monospace",e.fillStyle="#fff8",e.textAlign="right",e.fillText(`${Math.ceil(_*100)}%`,s+340-14,f+14)}e.font="10px monospace",e.fillStyle="#666",e.textAlign="center",e.fillText("[R] Close   [] Select   [Enter] Craft   [1-5] Station",s+340/2,a+420-12)}_renderQuestPanel(e){const a=this._systems.story.getCurrentQuest(),r=this._systems.quest.getActiveQuests(),n=this._systems.quest.dailyContracts,l=a?170:40,h=r.length>0?24+r.length*20:0,c=24+Math.max(1,n.length)*28,d=Math.min(v.height-40,36+l+h+c+44),u=v.height/2-d/2;e.fillStyle="rgba(15, 12, 25, 0.92)",e.beginPath(),e.roundRect(20,u,300,d,8),e.fill(),e.strokeStyle="#5a4abc",e.lineWidth=1,e.stroke(),e.fillStyle="rgba(90, 74, 188, 0.3)",e.beginPath(),e.roundRect(21,u+1,298,28,[6,6,0,0]),e.fill(),e.font="bold 13px monospace",e.fillStyle="#c4b5fd",e.textAlign="center",e.fillText(" QUEST LOG",20+300/2,u+19);let f=u+42;if(a){const m=this._systems.story.getProgress();e.font="9px monospace",e.fillStyle="#888",e.textAlign="left",e.fillText(a.chapter.replace(/_/g," ").toUpperCase(),35,f),f+=16,e.font="bold 13px monospace",e.fillStyle="#fbbf24",e.fillText(a.name,35,f),f+=16;for(let _=0;_<a.objectives.length;_++){const p=a.objectives[_],g=m[_]??0,y=g>=p.count;e.font="10px monospace",e.fillStyle=y?"#4ade80":"#ccc",e.fillText(`${y?"":""} ${p.description}`,35,f),p.count>1&&(e.font="8px monospace",e.fillStyle="#888",e.fillText(`${g}/${p.count}`,270,f)),f+=16}if(a.reward){const _=a.reward;e.font="8px monospace",e.fillStyle="#777";const p=[];_.xp&&p.push(`${_.xp} XP`),_.gold&&p.push(`${_.gold}g`),p.length&&e.fillText(`Reward: ${p.join(", ")}`,35,f),f+=14}}else e.font="10px monospace",e.fillStyle="#888",e.textAlign="left",e.fillText("No active story quest.",35,f),f+=18;if(r.length>0){f+=4,e.strokeStyle="rgba(90,74,188,0.2)",e.lineWidth=1,e.beginPath(),e.moveTo(30,f-2),e.lineTo(310,f-2),e.stroke(),f+=10,e.font="bold 10px monospace",e.fillStyle="#60a5fa",e.textAlign="left",e.fillText("ACTIVE QUESTS",35,f),f+=16;for(const m of r.slice(0,5)){const _=m.objectives.every(y=>y.completed);e.font="9px monospace",e.fillStyle=_?"#4ade80":"#ccc",e.fillText(`${m.def.icon} ${m.def.title}`,35,f);const p=m.objectives.length,g=m.objectives.filter(y=>y.completed).length;e.font="8px monospace",e.fillStyle="#888",e.fillText(`${g}/${p}`,275,f),f+=18}r.length>5&&(e.font="8px monospace",e.fillStyle="#555",e.fillText(`+${r.length-5} more...`,35,f),f+=14)}if(f+=4,e.strokeStyle="rgba(90,74,188,0.2)",e.lineWidth=1,e.beginPath(),e.moveTo(30,f-2),e.lineTo(310,f-2),e.stroke(),f+=10,e.font="bold 10px monospace",e.fillStyle="#fbbf24",e.textAlign="left",e.fillText("DAILY CONTRACTS",35,f),f+=16,n.length===0)e.font="9px monospace",e.fillStyle="#555",e.fillText("No contracts today.",35,f);else for(const m of n){const _=m.objectives.every(w=>w.completed),p=m.status==="failed",g=m.status==="completed",y=g?"":p?"":_?"":m.def.icon,S=g?"#4ade80":p?"#ef4444":_?"#4ade80":"#e5e7eb";if(e.font="10px monospace",e.fillStyle=S,e.fillText(`${y} ${m.def.title}`,35,f),m.status==="active"&&!_){const w=m.objectives[0];e.font="8px monospace",e.fillStyle="#888",e.fillText(`${w.currentCount}/${w.targetCount}`,270,f)}e.font="8px monospace",e.fillStyle="#777";const b=m.def.rewards;e.fillText(`${b.xp??0} XP  ${b.gold??0}g`,47,f+11),f+=26}e.font="9px monospace",e.fillStyle="#555",e.textAlign="center",e.fillText(`${this._systems.story.getCompletedCount()} / ${this._systems.story.getTotalCount()} milestones`,20+300/2,u+d-26),e.font="10px monospace",e.fillStyle="#666",e.fillText("[Q] Close",20+300/2,u+d-10)}_tryInteractWithNPC(){let e=null,t=72;for(const p of this._npcs){if(p.isIndoors)continue;const g=this._player.x-p.x,y=this._player.y-p.y,S=Math.sqrt(g*g+y*y);S<t&&(e=p,t=S)}if(!e)return;this._talkingToNpc=e,this._dialogueStep=0,this._systems.audio.playSFX("menu_click"),this._progressStoryObjective(`Speak to ${e.def.name}`),this._progressStoryObjective(`Deliver to ${e.def.name}`),this._progressStoryObjective(`Talk to ${e.def.name}`),this._systems.quest.onTalk(e.def.id),this._checkQuestCompletion();const i=this._systems.relationship.talkTo(e.def.id);i.affinityGain>0&&this._ui.notify(`${e.def.name}: +${i.affinityGain} affinity`,"#f472b6");const s=this._systems.relationship.getRelationship(e.def.id);s&&s.level==="friendly"?this._systems.achievement.progress("friend_1"):s&&s.level==="best_friend"&&this._systems.achievement.progress("best_friend");const a=this._systems.story.getCurrentQuest(),r=a?.objectives.some(p=>p.description.toLowerCase().includes(e.def.name.toLowerCase())),n=mi.find(p=>p.ownerId===e.def.id),l=[];r&&l.push({text:"About the quest...",action:"quest"}),n&&l.push({text:`Browse ${n.name}`,action:"shop"});const h=this._systems.shop.getActiveMerchant(this._systems.gameTime.day);if(n&&h&&l.push({text:`${h.name} (Visitor)`,action:"traveling_merchant"}),e.def.canHeal&&this._player.health<this._player.maxHealth){const p=Math.max(5,Math.floor(this._player.level*3));l.push({text:`Heal me (${p}g)`,action:`heal_${p}`})}if(e.def.id==="garrett"){const g=this._systems.equipment.getAllEquipped().filter(y=>y.durability<y.maxDurability);if(g.length>0){const y=g.length*25;l.push({text:`Repair all gear (${y}g)`,action:`repair_${y}`})}}const c=this._inventory.getHotbarSlot(this._hotbarSlot);if(c){const p=pe(c.itemId);p&&l.push({text:`Give ${p.name} as gift`,action:`gift_${c.itemId}`})}if(s&&s.isRomanceable&&!s.romanceStarted&&s.affinity>=70&&l.push({text:"I have feelings for you...",action:"start_romance"}),e.def.id==="elder_miriam"){const p=this._systems.profession.activeProfession,g=p?`${p} (Lv.${this._systems.profession.getLevel(p)})`:"none";l.push({text:`Change profession (${g})`,action:"choose_profession"})}e.def.id==="harold"&&l.push({text:"Play dice (50g bet)",action:"dice_50"}),e.def.id==="marcus"&&l.push({text:"Archery practice",action:"archery"});const d=this._systems.colony.getNearestSettlement(this._player.x,this._player.y);if(d){const p=d.npcs.find(g=>g.id===e.def.id);p?l.push({text:`Assign role (${p.role})`,action:"assign_role"}):d.population<d.maxPopulation&&l.push({text:"Recruit to settlement",action:"recruit_npc"})}let u=!1;if(e.def.quests&&e.def.quests.length>0)for(const p of e.def.quests){const g=this._systems.quest.getQuest(p);if(g&&g.status==="available"){l.push({text:`Quest: ${g.def.title}`,action:`offer_quest_${p}`}),u=!0;break}}if(!u){for(const p of this._systems.quest.getAvailableQuests())if(p.def.giver===e.def.id){l.push({text:`Quest: ${p.def.title}`,action:`offer_quest_${p.def.id}`});break}}l.push({text:"Goodbye",action:"close"});let f=e.def.greeting;const m=this._systems.combat.killCount,_=this._systems.corruption.purifiedPercent;m>200&&Math.random()<.3?f=`I've heard tales of your prowess  ${m} foes vanquished! ${f}`:_>.1&&Math.random()<.3?f=`The purified lands speak of your work, Pilgrim. ${f}`:this._player.level>=10&&Math.random()<.2?f=`A level ${this._player.level} adventurer! You've grown strong. ${f}`:this._discoveredBiomes.size>=4&&Math.random()<.25&&(f=`Word travels  you've explored ${this._discoveredBiomes.size} regions! ${f}`),this._ui.showDialog(e.def.name,e.def.icon,f,l,p=>{const g=l[p];if(g)switch(g.action){case"quest":{if(a)for(let S=0;S<a.objectives.length;S++){const b=a.objectives[S];b.description.toLowerCase().includes(e.def.name.toLowerCase())&&(this._systems.story.progressObjective(S)?this._ui.notify(`Quest Complete: ${a.name}!`,"","#ffd700"):this._ui.notify(`Quest updated: ${b.description}`,"","#fbbf24",3))}const y=a?.dialogue.progress??"Thank you, pilgrim.";this._ui.showDialog(e.def.name,e.def.icon,y,[],void 0,e.def.id);break}case"shop":{n&&(this._activeShop=n,this._showShop=!0,this._shopMode="buy",this._shopSelectedIndex=0,this._shopScrollOffset=0,this._showInventory=!1);break}case"traveling_merchant":{const y=this._systems.shop.getActiveMerchant(this._systems.gameTime.day);y&&(this._activeShop=y,this._showShop=!0,this._shopMode="buy",this._shopSelectedIndex=0,this._shopScrollOffset=0,this._showInventory=!1);break}case"close":this._talkingToNpc=null;break;default:{if(g.action.startsWith("heal_")){const y=parseInt(g.action.split("_")[1],10);if(this._player.gold>=y){this._player.gold-=y;const S=this._player.maxHealth-this._player.health;x.current[this._player.eid]=x.max[this._player.eid]??100,this._spawnDamagePopup(this._player.x,this._player.y,S,!1,!0),this._ui.notify("Fully healed!","#4ade80"),this._systems.audio.playSFX("heal")}else this._ui.notify("Not enough gold!","#ef4444")}else if(g.action.startsWith("gift_")){const y=g.action.replace("gift_","");if(this._inventory.removeItem(y,1)){const S=this._systems.relationship.giveGift(e.def.id,y);this._ui.showDialog(e.def.name,e.def.icon,S.reaction,[{text:"Continue",action:"close"}],void 0,e.def.id);const b=S.affinityChange>0?"#f472b6":S.affinityChange<0?"#ef4444":"#9ca3af";S.affinityChange!==0&&this._ui.notify(`${S.affinityChange>0?"+":""}${S.affinityChange} affinity`,b),this._spawnVFX("sparkle_collect",this._player.x,this._player.y,.6,6,.06),this._systems.audio.playSFX("pickup"),this._systems.achievement.progress("first_gift")}}else if(g.action.startsWith("repair_")){const y=parseInt(g.action.split("_")[1],10);this._inventory.removeGold(y)?(this._systems.equipment.repairAll(),this._ui.notify("All gear repaired!","#44ff88"),this._systems.audio.playSFX("craft"),this._spawnVFX("sparkle_burst",this._player.x,this._player.y,.8,6,.06)):this._ui.notify("Not enough gold!","#ef4444")}else if(g.action.startsWith("offer_quest_")){const y=g.action.replace("offer_quest_","");this._systems.quest.acceptQuest(y)&&(this._ui.notify("New quest accepted!","#fbbf24"),this._systems.audio.playSFX("quest_complete"))}else if(g.action==="start_romance"){this._systems.relationship.startRomance(e.def.id)&&(this._ui.showDialog(e.def.name,e.def.icon,e.def.dialogues.romance?.[0]??"I... I feel the same way.",[{text:"Continue",action:"close"}],void 0,e.def.id),this._spawnVFX("sparkle_collect",this._player.x,this._player.y,1,12,.04),this._particles.emit(this._player.x,this._player.y,"#ff69b4",15,60,1),this._ui.notify(`Romance started with ${e.def.name}!`,"#ff69b4"),this._systems.audio.playSFX("level_up"),this._systems.achievement.progress("romance"));return}else if(g.action.startsWith("dice_")){const y=parseInt(g.action.split("_")[1],10);if(this._player.gold>=y){this._player.gold-=y,this._systems.minigame.dice.start(y,3),this._systems.minigame.startMinigame("dice");let S=0;const b=()=>{S++;const w=this._systems.minigame.dice.rollRound(),k=`Round ${S}: You ${w.playerTotal} vs ${w.opponentTotal}  ${w.won?"WIN!":"LOSS"}`,T=this._systems.minigame.dice.state;if(T==="won"){const M=y*2;this._player.gold+=M,this._systems.minigame.endMinigame(),this._ui.showDialog("Harold","",`${k}

You won ${M} gold!`,[{text:"Nice!",action:"close"}]),this._ui.notify(`Won ${M}g at dice!`,"#ffd700")}else T==="lost"?(this._systems.minigame.endMinigame(),this._ui.showDialog("Harold","",`${k}

Better luck next time!`,[{text:"Darn...",action:"close"}]),this._ui.notify(`Lost ${y}g at dice.`,"#ff4444")):this._ui.showDialog("Harold","",k,[{text:"Roll again",action:"next_roll"}],()=>{b()})};b();return}else this._ui.notify("Not enough gold!","#ff4444")}else if(g.action==="archery")this._systems.minigame.archery.start(.5),this._systems.minigame.startMinigame("archery"),this._showMinigame=!0,this._ui.notify("Archery: Press SPACE to shoot! 5 shots, 30+ to win.","#ffcc00");else if(g.action==="assign_role"){const S=["guard","crafter","explorer","trader","healer","engineer","farmer","idle"].map(b=>({text:b.charAt(0).toUpperCase()+b.slice(1),action:`set_role_${b}`}));this._ui.showDialog(e.def.name,e.def.icon,"What role should I take on?",S,b=>{const w=S[b];if(!w)return;const k=w.action.replace("set_role_",""),T=this._systems.colony.getNearestSettlement(this._player.x,this._player.y);T&&(T.assignRole(e.def.id,k),this._ui.notify(`${e.def.name} assigned as ${k}!`,"#44cc88")),this._talkingToNpc=null},e.def.id);return}else if(g.action==="recruit_npc"){const y=this._systems.colony.getNearestSettlement(this._player.x,this._player.y);y&&(y.addNPC(e.def.id,e.def.name,"idle"),this._ui.notify(`${e.def.name} joined the settlement!`,"#44ff88"),this._systems.audio.playSFX("quest_complete"))}else if(g.action==="choose_profession"){const S=["blacksmith","alchemist","farmer","hunter","miner","cook","enchanter","builder"].map(b=>{const w=$i[b],k=this._systems.profession.getLevel(b),T=this._systems.profession.activeProfession===b;return{text:`${w.icon} ${w.name}${k>0?` (Lv.${k})`:""}${T?" ":""}`,action:`set_prof_${b}`}});this._ui.showDialog("Elder Miriam","","Which trade do you wish to pursue? Profession bonuses grow as you gain experience.",S,b=>{const w=S[b];if(!w)return;const k=w.action.replace("set_prof_","");this._systems.profession.setProfession(k);const T=$i[k];this._ui.notify(`Profession set to ${T.name}!`,"#a78bfa"),this._systems.audio.playSFX("level_up"),this._talkingToNpc=null},e.def.id);return}this._talkingToNpc=null;break}}},e.def.id)}_handleDialogueInput(){const e=this._ui.dialog;if(e)if(e.choices.length>0){if(this._input.wasPressed("Space")&&!this._ui.isDialogFullyRevealed){this._ui.skipDialogReveal();return}if(this._ui.isDialogFullyRevealed){for(let t=0;t<e.choices.length;t++)if(this._input.wasPressed(`Digit${t+1}`)){this._ui.selectDialogChoice(t);return}this._input.wasPressed("ArrowUp")&&(this._dialogueChoiceIndex=Math.max(0,this._dialogueChoiceIndex-1)),this._input.wasPressed("ArrowDown")&&(this._dialogueChoiceIndex=Math.min(e.choices.length-1,this._dialogueChoiceIndex+1)),this._ui.setSelectedChoiceIndex(this._dialogueChoiceIndex),(this._input.wasPressed("Enter")||this._input.wasPressed("Space"))&&(this._ui.selectDialogChoice(this._dialogueChoiceIndex),this._dialogueChoiceIndex=0)}}else(this._input.wasPressed("Space")||this._input.wasPressed("Enter"))&&(this._ui.skipDialogReveal()||(this._ui.closeDialog(),this._talkingToNpc=null)),this._input.wasPressed("Escape")&&(this._ui.closeDialog(),this._talkingToNpc=null)}_getSellableSlots(){if(this._sellableDirty){this._cachedSellableSlots.length=0;for(const e of this._inventory.slots)e&&e.count>0&&!e.favorite&&this._cachedSellableSlots.push(e);this._sellableDirty=!1}return this._cachedSellableSlots}_handleShopInput(){if(!this._activeShop)return;const e=8,t=this._shopMode==="buy"?this._activeShop.items:this._getSellableSlots();if(this._shopSelectedIndex=Math.max(0,Math.min(this._shopSelectedIndex,Math.max(0,t.length-1))),(this._input.wasPressed("ArrowUp")||this._input.wasPressed("KeyW"))&&(this._shopSelectedIndex=Math.max(0,this._shopSelectedIndex-1)),(this._input.wasPressed("ArrowDown")||this._input.wasPressed("KeyS"))&&(this._shopSelectedIndex=Math.min(t.length-1,this._shopSelectedIndex+1)),this._shopSelectedIndex<this._shopScrollOffset?this._shopScrollOffset=this._shopSelectedIndex:this._shopSelectedIndex>=this._shopScrollOffset+e&&(this._shopScrollOffset=this._shopSelectedIndex-e+1),this._input.wasPressed("Tab")&&(this._shopMode=this._shopMode==="buy"?"sell":"buy",this._shopSelectedIndex=0,this._shopScrollOffset=0),this._input.wasPressed("Enter")||this._input.wasPressed("Space"))if(this._shopMode==="buy"){const i=this._activeShop.items[this._shopSelectedIndex];if(i){const s=this._systems.skills.getAdditiveModifier("shop_discount"),a=this._systems.shop.buyItem(this._activeShop,i.itemId,this._inventory,this._inventory.gold,s);if(a.success){this._inventory.removeGold(a.cost),this._player.gold=this._inventory.gold;const r=pe(i.itemId);this._ui.notify(`Bought ${r?.name??i.itemId} for ${a.cost}g`,"#4ade80")}else a.cost>0&&a.cost>this._inventory.gold?this._ui.notifyWarning("Not enough gold!"):a.cost===0?this._inventory.canAddItem(i.itemId,1)?this._ui.notifyWarning("Out of stock!"):this._ui.notifyWarning("Inventory full!"):this._ui.notifyWarning("Out of stock!")}}else{const i=this._getSellableSlots()[this._shopSelectedIndex];if(i){const s=this._systems.shop.sellItem(this._activeShop,i.itemId,this._inventory);if(s.success){const a=this._systems.skills.getAdditiveModifier("sell_bonus"),r=a>0?Math.floor(s.value*a):0;this._inventory.addGold(s.value+r),this._player.gold=this._inventory.gold;const n=pe(i.itemId);this._ui.notify(`Sold ${n?.name??i.itemId} for ${s.value+r}g`,"#fcd34d")}}}(this._input.wasPressed("Escape")||this._input.wasPressed("KeyE"))&&(this._showShop=!1,this._activeShop=null,this._talkingToNpc=null)}_renderShopPanel(e){if(!this._activeShop)return;const t=360,i=480,s=v.width/2-t/2,a=v.height/2-i/2;e.fillStyle="rgba(0,0,0,0.5)",e.fillRect(0,0,v.width,v.height),e.fillStyle="rgba(18, 15, 30, 0.96)",e.beginPath(),e.roundRect(s,a,t,i,8),e.fill(),e.strokeStyle="#d97706",e.lineWidth=2,e.stroke(),e.fillStyle="rgba(217, 119, 6, 0.15)",e.beginPath(),e.roundRect(s+2,a+2,t-4,30,[6,6,0,0]),e.fill(),e.font="bold 14px monospace",e.textAlign="center",e.fillStyle="#fbbf24",e.fillText(`${this._activeShop.icon} ${this._activeShop.name}`,s+t/2,a+22),e.font="bold 11px monospace",e.fillStyle="#fcd34d",e.textAlign="right",e.fillText(` ${this._inventory.gold} gold`,s+t-10,a+22);const r=a+38,n=t/2-10;e.fillStyle=this._shopMode==="buy"?"#d97706":"rgba(60,50,30,0.6)",e.beginPath(),e.roundRect(s+5,r,n,22,4),e.fill(),e.font="bold 10px monospace",e.textAlign="center",e.fillStyle=this._shopMode==="buy"?"#fff":"#888",e.fillText("BUY",s+5+n/2,r+15),e.fillStyle=this._shopMode==="sell"?"#d97706":"rgba(60,50,30,0.6)",e.beginPath(),e.roundRect(s+t/2+5,r,n,22,4),e.fill(),e.fillStyle=this._shopMode==="sell"?"#fff":"#888",e.fillText("SELL",s+t/2+5+n/2,r+15);const l=r+30,h=36,c=8;if(this._shopMode==="buy"){const d=this._activeShop.items;for(let u=0;u<Math.min(d.length,c);u++){const f=u+this._shopScrollOffset;if(f>=d.length)break;const m=d[f],_=pe(m.itemId),p=l+u*h,g=f===this._shopSelectedIndex;e.fillStyle=g?"rgba(217,119,6,0.2)":"rgba(30,25,40,0.6)",e.beginPath(),e.roundRect(s+5,p,t-10,h-2,3),e.fill(),g&&(e.strokeStyle="#d97706",e.lineWidth=1,e.stroke());const y=this._sprites.getItemSprite(m.itemId);y?e.drawImage(y,s+10,p+4,26,26):(e.font="16px serif",e.textAlign="left",e.fillText(_?.icon??"",s+12,p+23)),e.font="10px monospace";const S=_?.rarity??"common";e.fillStyle=rt[S]??"#9ca3af",e.textAlign="left",e.fillText(_?.name??m.itemId,s+40,p+15),e.font="8px monospace",e.fillStyle="#666",e.fillText(m.category,s+34,p+27);const b=Math.ceil(m.basePrice*this._activeShop.buyMarkup);e.font="bold 10px monospace",e.textAlign="right",e.fillStyle=this._inventory.gold>=b?"#fcd34d":"#ef4444",e.fillText(`${b}`,s+t-15,p+15),e.font="8px monospace",e.fillStyle="#888";const w=m.stock<0?"":`${Math.floor(m.stock)}`;e.fillText(`Stock: ${w}`,s+t-15,p+27)}}else{const d=this._getSellableSlots(),u=Math.max(0,this._shopScrollOffset);for(let f=0;f<c&&u+f<d.length;f++){const m=u+f,_=d[m],p=pe(_.itemId),g=l+f*h,y=m===this._shopSelectedIndex;e.fillStyle=y?"rgba(217,119,6,0.2)":"rgba(30,25,40,0.6)",e.beginPath(),e.roundRect(s+5,g,t-10,h-2,3),e.fill(),y&&(e.strokeStyle="#d97706",e.lineWidth=1,e.stroke());const S=this._sprites.getItemSprite(_.itemId);S?e.drawImage(S,s+10,g+4,26,26):(e.font="16px serif",e.textAlign="left",e.fillText(p?.icon??"",s+12,g+23)),e.font="10px monospace",e.textAlign="left",e.fillStyle=rt[p?.rarity??"common"]??"#9ca3af",e.fillText(`${p?.name??_.itemId} x${_.count}`,s+40,g+15);const w=this._activeShop.items.find(T=>T.itemId===_.itemId)?.basePrice??p?.value??10,k=Math.floor(w*this._activeShop.sellMarkdown);e.font="bold 10px monospace",e.textAlign="right",e.fillStyle="#fcd34d",e.fillText(`${k}`,s+t-15,g+20)}d.length===0&&(e.font="11px monospace",e.fillStyle="#666",e.textAlign="center",e.fillText("Nothing to sell",s+t/2,l+40))}if(this._shopMode==="buy"){const d=this._activeShop.items[this._shopSelectedIndex];if(d){const u=pe(d.itemId);if(u){const f=u.stats?100:50,m=a+i-f-10;e.fillStyle="rgba(40,35,55,0.9)",e.beginPath(),e.roundRect(s+5,m,t-10,f,3),e.fill();let _=m+14;if(e.font="9px monospace",e.fillStyle="#aaa",e.textAlign="left",e.fillText(u.description.slice(0,50),s+10,_),_+=12,u.stats){let p=this._itemStatStrCache.get(d.itemId);if(p===void 0&&(p=Object.entries(u.stats).filter(([,g])=>g!==0).map(([g,y])=>`${g}: ${y>0?"+":""}${y}`).join("  "),this._itemStatStrCache.set(d.itemId,p)),e.fillStyle="#7dd3fc",e.fillText(p,s+10,_),_+=14,u.category==="weapon"||u.category==="armor"||u.category==="tool"){let g=null;u.category==="weapon"?g="weapon":u.category==="tool"?g="tool":u.armorSlot&&(g=u.armorSlot);const y=g?this._inventory.equipment[g]:null,S=y?pe(y.itemId):null;e.font="8px monospace",e.fillStyle="#888",e.fillText(S?`vs ${S.name}:`:"vs nothing equipped:",s+10,_),_+=10;const b=S?.stats??{},w=["damage","defense","health","stamina","speed","critChance"],k={damage:"DMG",defense:"DEF",health:"HP",stamina:"STA",speed:"SPD",critChance:"CRIT"},T=[];for(const C of w){const P=u.stats[C]??0,R=b[C]??0,B=P-R;if(B===0&&P===0)continue;const F=k[C]??C,W=B>0?`+${C==="critChance"?(B*100).toFixed(0)+"%":B}`:B<0?`${C==="critChance"?(B*100).toFixed(0)+"%":B}`:"=",X=B>0?"#4ade80":B<0?"#ef4444":"#888";T.push(`${X}${F}:${W}`)}let M=s+10;for(const C of T){const P=C.match(/\x01(.*?)\x02(.*)/);P&&(e.fillStyle=P[1],e.fillText(P[2],M,_),M+=e.measureText(P[2]+"  ").width)}}}u.healAmount&&(e.fillStyle="#4ade80",e.font="9px monospace",e.textAlign="left",e.fillText(`Heals ${u.healAmount} HP`,s+10,_))}}}else{const u=this._getSellableSlots()[this._shopSelectedIndex];if(u){const f=pe(u.itemId);if(f){const m=a+i-60;e.fillStyle="rgba(40,35,55,0.9)",e.beginPath(),e.roundRect(s+5,m,t-10,40,3),e.fill();const _=this._sprites.getItemSprite(u.itemId);_?e.drawImage(_,s+10,m+8,20,20):(e.font="13px serif",e.textAlign="left",e.fillStyle="#ccc",e.fillText(f.icon,s+12,m+23)),e.font="9px monospace",e.fillStyle="#aaa",e.textAlign="left",e.fillText(`${f.name} x${u.count}`,s+34,m+14);const g=this._activeShop.items.find(S=>S.itemId===u.itemId)?.basePrice??f.value??10,y=Math.floor(g*this._activeShop.sellMarkdown);e.fillStyle="#fcd34d",e.fillText(`Sell value: ${y}`,s+34,m+28)}}}e.font="9px monospace",e.fillStyle="#555",e.textAlign="center",e.fillText("[] Navigate  [Space] Buy/Sell  [Tab] Switch  [Esc] Close",s+t/2,a+i-10)}_renderFarmUI(e){const t=["wheat","carrot","potato","tomato","corn","herb_crop"],i=["","","","","",""],a=40+t.length*28,r=v.width/2-220/2,n=v.height/2-a/2;e.fillStyle="rgba(15,20,10,0.92)",e.beginPath(),e.roundRect(r,n,220,a,8),e.fill(),e.strokeStyle="#66aa44",e.lineWidth=2,e.stroke(),e.font="bold 13px monospace",e.fillStyle="#88cc55",e.textAlign="center",e.fillText(" Select Seed",r+220/2,n+22),e.textAlign="left",e.font="12px monospace";for(let l=0;l<t.length;l++){const h=n+40+l*28,c=l===this._farmSelectedSeed;c&&(e.fillStyle="rgba(100,180,60,0.3)",e.beginPath(),e.roundRect(r+5,h-5,210,24,4),e.fill(),e.strokeStyle="rgba(100,180,60,0.5)",e.lineWidth=1,e.stroke());const d=t[l]+"_seed",u=this._inventory.countItem(d),f=u>=1;e.fillStyle=c?"#ccff88":f?"#aabbaa":"#555555",e.fillText(`${i[l]} ${t[l].replace(/_/g," ")}`,r+12,h+10),e.fillStyle=f?"#66aa44":"#663333",e.textAlign="right",e.fillText(`${u}`,r+220-12,h+10),e.textAlign="left"}e.font="9px monospace",e.fillStyle="#667766",e.textAlign="center",e.fillText(" select  ENTER plant  ESC close",r+220/2,n+a-6)}_renderFishingUI(e){const t=this._systems.fishing.state,i=this._systems.fishing.reelProgress,s=this._systems.fishing.tension,a=280,r=120,n=v.width/2-a/2,l=v.height-r-60;e.fillStyle="rgba(5,15,30,0.92)",e.beginPath(),e.roundRect(n,l,a,r,8),e.fill(),e.strokeStyle="#4488cc",e.lineWidth=2,e.stroke(),e.font="bold 13px monospace",e.fillStyle="#66bbee",e.textAlign="center",e.fillText(" Fishing",n+a/2,l+20);const h=t==="bite",c=h?Math.sin(performance.now()*.02)*3:0;e.font=h?"bold 13px monospace":"11px monospace";let d="",u="#aabbcc";switch(t){case"casting":d="Waiting for a bite...",u="#88aacc";break;case"bite":d="!! BITE !! Press SPACE!",u="#ffcc00";break;case"reeling":d="Hold SPACE to reel in!",u="#44dd88";break;case"caught":d="CAUGHT!",u="#44ff44";break;case"lost":d="Fish escaped...",u="#ff4444";break;default:d="...";break}e.fillStyle=u,e.fillText(d,n+a/2+c,l+42);const f=n+20,m=l+55,_=a-40,p=16;e.fillStyle="rgba(0,0,0,0.5)",e.beginPath(),e.roundRect(f,m,_,p,4),e.fill();const g=`${f}:${m}:${p}`;(!this._gradReelBar||this._gradReelBarKey!==g)&&(this._gradReelBar=e.createLinearGradient(f,m,f,m+p),this._gradReelBar.addColorStop(0,"#5599dd"),this._gradReelBar.addColorStop(1,"#2266aa"),this._gradReelBarKey=g),e.fillStyle=this._gradReelBar,e.beginPath(),e.roundRect(f,m,Math.max(8,_*i),p,4),e.fill(),e.fillStyle="rgba(255,255,255,0.12)",e.beginPath(),e.roundRect(f,m,Math.max(8,_*i),p/2,4),e.fill(),e.font="9px monospace",e.fillStyle="#ffffff",e.fillText(`Reel: ${Math.floor(i*100)}%`,n+a/2,m+12);const y=m+24;e.fillStyle="rgba(0,0,0,0.5)",e.beginPath(),e.roundRect(f,y,_,10,3),e.fill();const S=s>.8?"#ff3333":s>.5?"#ffaa33":"#44cc44",b=s>.8?"#aa1111":s>.5?"#bb7700":"#228822",w=`${f}:${y}:${S}`;(!this._gradTensBar||this._gradTensBarKey!==w)&&(this._gradTensBar=e.createLinearGradient(f,y,f,y+10),this._gradTensBar.addColorStop(0,S),this._gradTensBar.addColorStop(1,b),this._gradTensBarKey=w),e.fillStyle=this._gradTensBar,e.beginPath(),e.roundRect(f,y,Math.max(6,_*s),10,3),e.fill(),e.font="8px monospace",e.fillStyle="#aabbcc",e.fillText(`Tension: ${Math.floor(s*100)}%`,n+a/2,y+8),e.font="9px monospace",e.fillStyle="#556677",e.fillText("ESC to cancel",n+a/2,l+r-8)}_renderTechTreePanel(e){const i=this._systems.techTree.getAvailableTechs(),s=Math.min(400,50+i.length*36+40),a=v.width/2-340/2,r=v.height/2-s/2;e.fillStyle="rgba(10,10,25,0.94)",e.beginPath(),e.roundRect(a,r,340,s,8),e.fill(),e.strokeStyle="#6366f1",e.lineWidth=2,e.stroke(),e.font="bold 14px monospace",e.fillStyle="#a78bfa",e.textAlign="center",e.fillText(" Research",a+340/2,r+25);const n=this._systems.techTree.getResearchProgress(),l=this._systems.techTree.inProgress;if(l){e.font="10px monospace",e.fillStyle="#818cf8",e.fillText(`Researching: ${l.techId.replace(/_/g," ")}`,a+340/2,r+42);const c=a+20,d=300;e.fillStyle="rgba(0,0,0,0.5)",e.beginPath(),e.roundRect(c,r+48,d,8,3),e.fill(),e.fillStyle="#818cf8",e.beginPath(),e.roundRect(c,r+48,Math.max(6,d*n),8,3),e.fill(),e.font="7px monospace",e.fillStyle="#c7d2fe",e.fillText(`${Math.floor(n*100)}%`,a+340/2,r+54)}e.textAlign="left",e.font="11px monospace";const h=l?r+66:r+55;for(let c=0;c<i.length;c++){const d=i[c],u=h+c*44,f=c===this._techScrollIdx;f&&(e.fillStyle="rgba(99,102,241,0.2)",e.beginPath(),e.roundRect(a+5,u-4,330,40,4),e.fill());const m=this._systems.techTree.isResearched(d.id);if(e.fillStyle=m?"#22c55e":f?"#e0e7ff":"#94a3b8",e.fillText(`${d.icon} ${d.name}`,a+12,u+12),e.font="9px monospace",e.fillStyle="#64748b",e.fillText(d.description.substring(0,42),a+12,u+24),!m&&f){let p=a+12;e.font="8px monospace";for(const g of d.researchCost){const y=this._inventory.countItem(g.itemId),S=y>=g.count;e.fillStyle=S?"#66bb6a":"#ef5350";const b=`${y}/${g.count} ${g.itemId.replace(/_/g," ")}`;e.fillText(b,p,u+35),p+=e.measureText(b).width+8}}e.font="11px monospace";const _=["#6366f1","#818cf8","#a78bfa","#c084fc"];e.fillStyle=_[Math.min(d.tier-1,3)]??"#4f46e5",e.textAlign="right",e.fillText(`T${d.tier}`,a+340-12,u+12),e.textAlign="left"}i.length===0&&(e.fillStyle="#64748b",e.textAlign="center",e.fillText("All technologies researched!",a+340/2,h+20)),e.font="9px monospace",e.fillStyle="#475569",e.textAlign="center",e.fillText(" select  ENTER research  ESC close",a+340/2,r+s-8)}_renderTutorial(e){this._systems.tutorial.render(e,v.width,v.height)}_renderCutscene(e){this._systems.cutscene.render(e,v.width,v.height)}_renderClassInfo(e){const t=this._systems.classSystem,i=this._systems.profession,s=v.width-160;let a=90;e.save(),e.font="10px monospace",e.textAlign="right";const r=t.classDef;e.fillStyle="#a78bfa",e.fillText(`${r.icon} ${r.name} Lv.${t.level}`,s+145,a),a+=14;const n=t.xpToNext>0?t.xp/t.xpToNext:0,l=s+45,h=a-8;if(e.fillStyle="rgba(0,0,0,0.5)",e.beginPath(),e.roundRect(l,h,100,7,3),e.fill(),n>0){const c=Math.max(6,100*n),d=`${l}:${h}`;(!this._gradClassXp||this._gradClassXpKey!==d)&&(this._gradClassXp=e.createLinearGradient(l,h,l,h+7),this._gradClassXp.addColorStop(0,"#a78bfa"),this._gradClassXp.addColorStop(1,"#7c3aed"),this._gradClassXpKey=d),e.fillStyle=this._gradClassXp,e.beginPath(),e.roundRect(l,h,c,7,3),e.fill(),e.fillStyle="rgba(255,255,255,0.12)",e.beginPath(),e.roundRect(l,h,c,3.5,3),e.fill()}if(e.font="7px monospace",e.textAlign="right",e.fillStyle="#c4b5fd",e.fillText(`${t.xp}/${t.xpToNext}`,s+145,h+5),a+=14,t.skillPoints>0&&(e.fillStyle="#fbbf24",e.fillText(` ${t.skillPoints} skill pts`,s+145,a),a+=14),i.activeProfession){const c=i.getLevel(i.activeProfession);e.fillStyle="#34d399",e.fillText(`${i.activeProfession} Lv.${c}`,s+145,a)}e.restore()}_renderEquipmentPanel(e){const s=v.width-280-20,a=v.height/2-380/2;e.fillStyle="rgba(18, 15, 30, 0.95)",e.beginPath(),e.roundRect(s,a,280,380,8),e.fill(),e.strokeStyle="#6366f1",e.lineWidth=1,e.stroke(),e.fillStyle="rgba(99, 102, 241, 0.2)",e.beginPath(),e.roundRect(s+1,a+1,278,28,[6,6,0,0]),e.fill(),e.font="bold 13px monospace",e.fillStyle="#a5b4fc",e.textAlign="center",e.fillText(" EQUIPMENT",s+280/2,a+19);const r=[{label:"Helmet",key:"head",x:280/2,y:50},{label:"Amulet",key:"amulet",x:280/2+55,y:50},{label:"Weapon",key:"weapon",x:280/2-55,y:100},{label:"Chest",key:"chest",x:280/2,y:100},{label:"Cape",key:"cape",x:280/2+55,y:100},{label:"Gloves",key:"gloves",x:280/2-55,y:150},{label:"Legs",key:"legs",x:280/2,y:150},{label:"Ring",key:"ring",x:280/2+55,y:150},{label:"Boots",key:"boots",x:280/2,y:200},{label:"Tool",key:"tool",x:280/2-55,y:200}],n=this._inventory.equipment,l=36;for(const m of r){const _=s+m.x-l/2,p=a+m.y;e.fillStyle="rgba(40, 35, 60, 0.8)",e.beginPath(),e.roundRect(_,p,l,l,4),e.fill(),e.strokeStyle="#444",e.lineWidth=.5,e.stroke();const g=n[m.key];if(g){const y=pe(g.itemId);if(y){const S=rt[y.rarity]??"#9ca3af";e.strokeStyle=S,e.lineWidth=1.5,e.beginPath(),e.roundRect(_,p,l,l,4),e.stroke(),e.fillStyle=S+"15",e.fill(),e.font="18px serif",e.textAlign="center",e.fillText(y.icon,_+l/2,p+l/2+6);const b=this._systems.equipment.getEquipped(m.key);if(b&&b.maxDurability>0){const w=b.durability/b.maxDurability,k=w>.5?"#22c55e":w>.2?"#f59e0b":"#ef4444";e.fillStyle="rgba(0,0,0,0.6)",e.fillRect(_+2,p+l-4,l-4,3),e.fillStyle=k,e.fillRect(_+2,p+l-4,(l-4)*w,3)}}}else e.font="7px monospace",e.fillStyle="#555",e.textAlign="center",e.fillText(m.label,_+l/2,p+l/2+3)}const h=this._inventory.getEquipmentStats();let c=a+245;const d=16;e.fillStyle="rgba(40, 35, 55, 0.7)",e.beginPath(),e.roundRect(s+10,c-5,260,d*7+10,4),e.fill(),e.font="bold 9px monospace",e.fillStyle="#8b8baa",e.textAlign="left",e.fillText("STATS",s+18,c+=6),c+=4;const u=[{label:" Damage",value:h.damage,color:"#ef4444"},{label:" Defense",value:h.defense,color:"#3b82f6"},{label:" Health",value:h.health,color:"#f97316"},{label:" Stamina",value:h.stamina,color:"#22c55e"},{label:" Speed",value:h.speed,color:"#06b6d4"},{label:" Crit",value:+(h.critChance*100).toFixed(0),color:"#a855f7"}];e.font="10px monospace";for(const m of u)c+=d,e.fillStyle="#aaa",e.textAlign="left",e.fillText(m.label,s+18,c),e.fillStyle=m.value>0?m.color:"#555",e.textAlign="right",e.fillText(`${m.value>0?"+":""}${m.value}`,s+280-18,c);const f=this._systems.equipment.getAllLegendaryEffects();if(f.length>0){c+=d,e.font="bold 9px monospace",e.fillStyle="#fbbf24",e.textAlign="left",e.fillText("LEGENDARY EFFECTS",s+18,c),e.font="9px monospace";for(const m of f)c+=12,e.fillStyle="#ffd700",e.fillText(` ${m.name}`,s+18,c),c+=10,e.fillStyle="#888",e.fillText(m.description,s+24,c)}e.font="10px monospace",e.fillStyle="#555",e.textAlign="center",e.fillText("[C] Close",s+280/2,a+380-10)}_renderMailPanel(e){const t=Math.min(400,v.width-40),i=Math.min(350,v.height-60),s=(v.width-t)/2,a=(v.height-i)/2;e.fillStyle="rgba(15,15,30,0.95)",e.beginPath(),e.roundRect(s,a,t,i,10),e.fill(),e.strokeStyle="#f59e0b",e.lineWidth=2,e.stroke(),e.font="bold 14px monospace",e.textAlign="center",e.fillStyle="#fbbf24",e.fillText(` Mail (${this._systems.mail.unreadCount} unread)`,v.width/2,a+25);const r=this._systems.mail.inbox,n=22;let l=a+50;const h=Math.floor((i-90)/n),c=Math.max(0,this._mailScrollIdx-Math.floor(h/2)),d={quest:"",npc:"",event:"",reward:"",system:"",merchant:""};for(let u=c;u<Math.min(r.length,c+h);u++){const f=r[u],m=u===this._mailScrollIdx,_=f.read;m&&(e.fillStyle="rgba(245,158,11,0.18)",e.beginPath(),e.roundRect(s+8,l-12,t-16,n,3),e.fill());const p=d[f.category]??"",g=_?"  ":" ";e.font=`${_?"10px":"bold 10px"} monospace`,e.textAlign="left",e.fillStyle=_?"#555":"#fbbf24",e.fillText(g,s+14,l),e.fillStyle=_?"#777":"#e5e7eb";const y=f.attachments.length>0&&!f.claimed?" ":"";e.fillText(`${p} ${y}${f.from}: ${f.subject}`,s+28,l),e.font="8px monospace",e.fillStyle="#555",e.textAlign="right",e.fillText(`D${f.timestamp}`,s+t-14,l),e.textAlign="left",l+=n}if(r.length>0&&this._mailScrollIdx<r.length){const u=r[this._mailScrollIdx],f=a+i-72;e.fillStyle="rgba(0,0,0,0.3)",e.beginPath(),e.roundRect(s+10,f,t-20,48,4),e.fill(),e.font="9px monospace",e.fillStyle="#9ca3af",e.textAlign="left";const _=(u.body.length>90?u.body.substring(0,87)+"...":u.body).split(" ");let p="",g=f+12;for(const y of _){const S=p+y+" ";if(e.measureText(S).width>t-40){if(e.fillText(p.trim(),s+18,g),g+=12,p=y+" ",g>f+42)break}else p=S}p.trim()&&g<=f+42&&e.fillText(p.trim(),s+18,g)}r.length===0&&(e.font="11px monospace",e.fillStyle="#555",e.textAlign="center",e.fillText("No mail yet.",v.width/2,a+80)),e.font="9px monospace",e.fillStyle="#6b7280",e.textAlign="center",e.fillText(" Navigate    Enter Read/Claim    Esc Close",v.width/2,a+i-12)}_renderControlsHelp(e){const t=v.width,i=v.height;e.fillStyle="rgba(0,0,0,0.75)",e.fillRect(0,0,t,i);const s=340,a=440,r=(t-s)/2,n=(i-a)/2;e.fillStyle="#1a1a2e",e.strokeStyle="#ffd700",e.lineWidth=2,e.fillRect(r,n,s,a),e.strokeRect(r,n,s,a),e.font="bold 13px monospace",e.fillStyle="#ffd700",e.textAlign="center",e.fillText("CONTROLS",t/2,n+22);const l=[["WASD / Arrows","Move"],["E","Interact / Gather / Talk"],["Space","Attack / Confirm"],["Shift","Sprint"],["Ctrl","Dodge roll"],["V","Parry"],["Z / X","Class skills"],["1-5","Hotbar slots"],["F","Use hotbar item"],["G","Fish (near water)"],["I","Inventory"],["C","Character / Class info"],["R","Crafting"],["J","Quest log"],["B","Build mode (Arrows/Tab)"],["P","Skill tree"],["K","Crafting station select"],["M","Map / Minimap"],["N","Mail inbox"],["S (paused)","Settings"],["Tab","Deposit (storage)"],["Q/D/L","Stack/Deposit/Loot"],["U","Place waypoint (Shift+U remove)"],["Home","Reset zoom"],["Scroll","Zoom in/out"],["F5","Quick save"],["F9","Quick load"],["F3","Debug info"],["Esc","Close / Pause"],["F1","This help screen"]];e.font="10px monospace",e.textAlign="left";let h=n+42;for(const[c,d]of l){e.fillStyle="#2d2d4e";const u=e.measureText(c).width+8;e.fillRect(r+14,h-9,u,14),e.strokeStyle="#555",e.lineWidth=1,e.strokeRect(r+14,h-9,u,14),e.fillStyle="#e0e0e0",e.fillText(c,r+18,h+1),e.fillStyle="#9ca3af",e.fillText(d,r+28+u,h+1),h+=17}e.font="9px monospace",e.fillStyle="#6b7280",e.textAlign="center",e.fillText("Press F1 or Esc to close",t/2,n+a-10)}_renderStoragePanel(e){if(!this._activeContainer)return;const t=this._activeContainer,i=Math.min(350,v.width-40),s=Math.min(300,v.height-60),a=(v.width-i)/2,r=(v.height-s)/2;e.fillStyle="rgba(20,15,10,0.95)",e.beginPath(),e.roundRect(a,r,i,s,10),e.fill(),e.strokeStyle="#b45309",e.lineWidth=2,e.stroke(),e.font="bold 14px monospace",e.textAlign="center",e.fillStyle="#d97706",e.fillText(` ${t.name}`,v.width/2,r+25),e.font="10px monospace",e.fillStyle="#9ca3af",e.fillText(`${t.items.length} / ${t.capacity} slots`,v.width/2,r+42);const n=22;let l=r+62;for(let h=0;h<t.items.length;h++){const c=t.items[h],d=h===this._storageScrollIdx,u=pe(c.itemId);d&&(e.fillStyle="rgba(180,83,9,0.2)",e.beginPath(),e.roundRect(a+8,l-13,i-16,n,3),e.fill());const f=u?rt[u.rarity]??"#d1d5db":"#d1d5db";e.font="11px monospace",e.textAlign="left",e.fillStyle=d?"#fbbf24":f;const m=u?u.icon+" ":"";e.fillText(`${m}${c.itemId.replace(/_/g," ")}`,a+16,l),e.textAlign="right",e.fillStyle="#9ca3af",e.fillText(`${c.count}`,a+i-16,l),l+=n}t.items.length===0&&(e.font="11px monospace",e.fillStyle="#555",e.textAlign="center",e.fillText("Empty chest.",v.width/2,r+80)),e.font="9px monospace",e.fillStyle="#6b7280",e.textAlign="center",e.fillText(" Select    Enter Take    Tab Store    [Q]Stack [D]All [L]Loot    Esc",v.width/2,r+s-12)}_renderMinigameOverlay(e){if(this._systems.minigame.activeGame==="archery"){const d=this._systems.minigame.archery;if(d.state!=="playing")return;e.fillStyle="rgba(0,0,0,0.7)",e.fillRect(0,0,v.width,v.height);const u=v.width/2,f=v.height/2,m=120;e.font="bold 16px monospace",e.textAlign="center",e.fillStyle="#fbbf24",e.fillText(` Archery  Shots: ${d.shotsLeft}  Score: ${d.score}`,u,f-m-30);const _=["#374151","#4b5563","#22c55e","#f59e0b","#ef4444"];for(let y=4;y>=0;y--)e.fillStyle=_[y],e.beginPath(),e.arc(u,f,m*((y+1)/5),0,Math.PI*2),e.fill(),e.strokeStyle="#1f2937",e.lineWidth=1,e.stroke();e.fillStyle="#ffffff",e.beginPath(),e.arc(u,f,4,0,Math.PI*2),e.fill();const p=u+(d.aimX-.5)*m*2,g=f+(d.aimY-.5)*m*2;e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(p-12,g),e.lineTo(p+12,g),e.moveTo(p,g-12),e.lineTo(p,g+12),e.stroke(),e.beginPath(),e.arc(p,g,6,0,Math.PI*2),e.stroke(),e.font="10px monospace",e.fillStyle="#6b7280",e.fillText("SPACE to shoot    ESC to cancel",u,f+m+40),e.fillText("Score 30+ to win!",u,f+m+55);return}const i=this._systems.minigame.lockpick;if(i.state!=="playing")return;const s=300,a=40,r=(v.width-s)/2,n=v.height/2-a/2;e.fillStyle="rgba(0,0,0,0.7)",e.fillRect(0,0,v.width,v.height),e.font="bold 16px monospace",e.textAlign="center",e.fillStyle="#fbbf24",e.fillText(` Lockpicking  Pin ${i.currentPin+1}/${i.totalPins}`,v.width/2,n-30),e.fillStyle="rgba(30,30,40,0.95)",e.beginPath(),e.roundRect(r,n,s,a,6),e.fill(),e.strokeStyle="#555",e.lineWidth=2,e.beginPath(),e.roundRect(r,n,s,a,6),e.stroke();const l=r+i.targetZone*s,h=i.tolerance*s*2;e.fillStyle="rgba(34,197,94,0.4)",e.beginPath(),e.roundRect(l-h/2,n+2,h,a-4,4),e.fill();const c=r+i.cursor*s;e.strokeStyle="#ef4444",e.lineWidth=3,e.beginPath(),e.moveTo(c,n),e.lineTo(c,n+a),e.stroke(),e.font="11px monospace",e.fillStyle="#d1d5db",e.fillText(`Lockpicks: ${"".repeat(i.lockpicksLeft)}`,v.width/2,n+a+30),e.font="10px monospace",e.fillStyle="#6b7280",e.fillText("SPACE to pick    ESC to cancel",v.width/2,n+a+50)}_renderFestivalBanner(e){const t=this._systems.festival.activeFestival,i=250,s=32,a=(v.width-i)/2,r=v.height-95;e.fillStyle="rgba(251,191,36,0.15)",e.beginPath(),e.roundRect(a,r,i,s,6),e.fill(),e.strokeStyle="rgba(251,191,36,0.5)",e.lineWidth=1,e.stroke(),e.font="bold 11px monospace",e.textAlign="center",e.fillStyle="#fbbf24",e.fillText(`${t.icon} ${t.name}`,v.width/2,r+14);const n=this._systems.festival.getXPBonus(),l=this._systems.festival.getShopDiscount();e.font="9px monospace",e.fillStyle="#d97706";let h=[];n>0&&h.push(`+${Math.round(n*100)}% XP`),l>0&&h.push(`-${Math.round(l*100)}% shop`),e.fillText(h.join("    "),v.width/2,r+27),e.font="8px monospace",e.fillStyle="#b45309",e.fillText("[P] Participate",v.width/2,r-6)}_renderPauseOverlay(e){e.fillStyle="rgba(0,0,0,0.6)",e.fillRect(0,0,v.width,v.height);const t=240,i=this._systems.festival.activeEvents,s=170+(i.length>0?30+i.length*14:0),a=v.width/2,r=a-t/2,n=v.height/2-s/2;e.fillStyle="rgba(18, 15, 30, 0.92)",e.beginPath(),e.roundRect(r,n,t,s,10),e.fill(),e.strokeStyle="rgba(165, 180, 252, 0.3)",e.lineWidth=1,e.stroke(),e.font="bold 20px monospace",e.textAlign="center",e.fillStyle="#e5e7eb",e.fillText(" PAUSED",a,n+30),e.strokeStyle="rgba(255,255,255,0.08)",e.beginPath(),e.moveTo(r+20,n+42),e.lineTo(r+t-20,n+42),e.stroke();const l=[{key:"ESC",label:"Resume"},{key:"S",label:"Settings"},{key:"F5",label:"Quick Save"},{key:"F9",label:"Quick Load"}];let h=n+62;e.font="11px monospace";for(const c of l){e.fillStyle="rgba(99,102,241,0.25)";const d=e.measureText(c.key).width+10;e.beginPath(),e.roundRect(r+18,h-9,d,16,3),e.fill(),e.fillStyle="#a5b4fc",e.textAlign="left",e.fillText(c.key,r+23,h),e.fillStyle="#9ca3af",e.fillText(c.label,r+28+d,h),h+=22}if(h+=4,e.fillStyle="#555",e.font="10px monospace",e.textAlign="center",e.fillText(` ${this._systems.save.formatPlayTime()} played`,a,h),i.length>0){h+=20,e.font="bold 10px monospace",e.fillStyle="#a78bfa",e.fillText("Active Events",a,h),h+=14,e.font="10px monospace";for(const c of i)e.fillStyle="#9ca3af",e.fillText(`${c.def.icon} ${c.def.name} (${c.daysRemaining}d)`,a,h),h+=14}}_renderDebugInfo(e){const t=v.width-200;let i=10;const s=14;e.fillStyle="rgba(0,0,0,0.4)",e.beginPath(),e.roundRect(t-5,i-2,195,s*11+4,6),e.fill(),e.fillStyle="#aaa",e.font="11px monospace",e.fillText(`View: ${se[this._viewMode.mode]}`,t,i+=s),e.fillText(`Systems: ${this._systemManager.getActiveCount()}/${this._systemManager.totalRegistered}`,t,i+=s),e.fillText(`Time: ${this._systems.gameTime.timeString}`,t,i+=s),e.fillText(`Day: ${this._systems.gameTime.day} (${this._systems.gameTime.season})`,t,i+=s),e.fillText(`Corruption: ${(this._systems.corruption.globalCorruption*100).toFixed(0)}%`,t,i+=s),e.fillText(`Weather: ${this._systems.weather.current}`,t,i+=s),e.fillText(`Sprites: ${this._sprites.loadedCount}`,t,i+=s);let a=0;for(const r of this._enemies)r.alive&&a++;e.fillText(`Enemies: ${a}/${this._enemies.length}`,t,i+=s),e.fillText(`Kills: ${this._systems.combat.killCount}`,t,i+=s),e.fillText(`LV ${this._player.level} (${this._player.xp}/${this._player.xpToNext} XP)`,t,i+=s)}enterDungeon(e){this._viewMode.mode===se.ISOMETRIC&&(this._state.view.dungeonId=e,this._state.view.returnX=this._player.x,this._state.view.returnY=this._player.y,this._viewMode.startTransition(se.TOP_DOWN,"enter_dungeon",this._player.x,this._player.y))}enterInterior(e){this._viewMode.mode===se.ISOMETRIC&&(this._state.view.interiorId=e,this._state.view.returnX=this._player.x,this._state.view.returnY=this._player.y,this._viewMode.startTransition(se.TOP_DOWN,"enter_interior",this._player.x,this._player.y))}enterBossArena(e){this._state.view.bossArenaId=e,this._state.view.returnX=this._player.x,this._state.view.returnY=this._player.y,this._viewMode.startTransition(se.SIDE_SCROLL,"enter_boss_arena",this._player.x,this._player.y)}_respawnPlayer(){x.current[this._player.eid]=Math.floor((x.max[this._player.eid]??100)*.5),ke.current[this._player.eid]=ke.max[this._player.eid]??100,Qe.current[this._player.eid]=Math.floor((Qe.max[this._player.eid]??100)*.5),this._playerDead=!1,this._deathTimer=0,this._deathFadeAlpha=0,this._deathPenaltyApplied=!1,this._viewMode.mode===se.SIDE_SCROLL&&this._systems.titan.endBossPhase(!1),this._viewMode.mode!==se.ISOMETRIC&&this.exitToOverworld();const e=this._findNearestSafeZone();this._player.x=e.x,this._player.y=e.y,this._systems.statusEffects.removeAll(),this._systems.combat.clearStatusEffects(this._player.eid),this._systems.combat.resetCombo(),this._player.invincible=!0,this._player.invincibleTimer=5,this._ui.notify("You awaken at a safe haven...","#88ccff"),this._systems.audio.playSFX("heal"),this._spawnVFX("flower_ring",this._player.x,this._player.y,1.2,10,.07),this._spawnVFX("sun_ray",this._player.x,this._player.y-15,1,8,.08),this._particles.emit(this._player.x,this._player.y,"#88ccff",12,50,.6)}_findNearestSafeZone(){const e=this._player.x,t=this._player.y;let i=1/0,s={x:rs.startX,y:rs.startY};for(const a of this._buildings){const r=a.tileX*L+a.def.widthTiles*L/2,n=a.tileY*L+a.def.heightTiles*L/2,l=r-e,h=n-t,c=l*l+h*h;c<i&&(i=c,s={x:r,y:n+20})}return s}_renderDungeonMinimap(e){if(!this._currentDungeon)return;const i=this._currentDungeon.rooms;if(i.length===0)return;let s=1/0,a=1/0,r=-1/0,n=-1/0;for(const T of i)s=Math.min(s,T.x),a=Math.min(a,T.y),r=Math.max(r,T.x+T.width),n=Math.max(n,T.y+T.height);const l=r-s||1,h=n-a||1,c=120,d=90,u=v.width-c-10,f=10,m=(c-10)/l,_=(d-10)/h,p=Math.min(m,_);e.save(),e.fillStyle="rgba(0,0,0,0.7)",e.beginPath(),e.roundRect(u,f,c,d,6),e.fill(),e.strokeStyle="rgba(100,100,120,0.4)",e.lineWidth=1,e.stroke(),e.font="7px monospace",e.textAlign="center",e.fillStyle="#888",e.fillText(`Floor ${this._dungeonFloor}`,u+c/2,f+9);const g={entrance:"#4ade80",normal:"#555",boss:"#ff4444",treasure:"#ffd700",rest:"#22d3ee",shop:"#60a5fa",trap:"#ff8800",puzzle:"#a78bfa"};for(const T of i){const M=u+5+(T.x-s)*p,C=f+14+(T.y-a)*p,P=Math.max(3,T.width*p),R=Math.max(2,T.height*p);e.fillStyle=g[T.type]??"#555",e.globalAlpha=.6,e.fillRect(M,C,P,R),e.globalAlpha=1,e.strokeStyle=g[T.type]??"#666",e.lineWidth=.5,e.strokeRect(M,C,P,R)}const y=16,S=this._player.x/y,b=this._player.y/y,w=u+5+(S-s)*p,k=f+14+(b-a)*p;e.fillStyle="#fff",e.beginPath(),e.arc(w,k,2.5,0,Math.PI*2),e.fill(),e.fillStyle="#ff4444";for(const T of this._dungeonEnemies){if(!T.alive)continue;const M=u+5+(T.x/y-s)*p,C=f+14+(T.y/y-a)*p;M>=u&&M<=u+c&&C>=f&&C<=f+d&&e.fillRect(M-1,C-1,2,2)}e.restore()}_renderDeathScreen(e){const t=this._deathTimer,i=this._deathFadeAlpha,s=v.width/2,a=v.height/2;e.save();const r=`${v.width}:${v.height}:${i*100|0}`;if((!this._gradDeathVig||this._gradDeathVigKey!==r)&&(this._gradDeathVig=e.createRadialGradient(s,a,0,s,a,v.width*.6),this._gradDeathVig.addColorStop(0,`rgba(40, 0, 0, ${i*.5})`),this._gradDeathVig.addColorStop(.5,`rgba(60, 0, 0, ${i*.65})`),this._gradDeathVig.addColorStop(1,`rgba(10, 0, 0, ${i*.9})`),this._gradDeathVigKey=r),e.fillStyle=this._gradDeathVig,e.fillRect(0,0,v.width,v.height),e.restore(),t<.8)return;const n=Math.min(1,(t-.8)*1.5);e.globalAlpha=n,e.save(),e.shadowColor="#ff2222",e.shadowBlur=20+Math.sin(t*3)*8,e.font="48px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#ff4444",e.fillText("",s,a-55),e.restore();const l=1+Math.sin(t*2)*.05;e.save(),e.shadowColor="#cc0000",e.shadowBlur=15,e.font=`bold ${Math.round(28*l)}px monospace`,e.fillStyle="#cc2222",e.textAlign="center",e.fillText("YOU DIED",s,a-5),e.restore(),e.strokeStyle=`rgba(180,40,40,${n*.4})`,e.lineWidth=1,e.beginPath(),e.moveTo(s-100,a+10),e.lineTo(s+100,a+10),e.stroke(),e.font="11px monospace",e.textAlign="center",e.fillStyle="#aa6666";const h=this._systems.settings.get("deathPenalty"),c=h==="hardcore"?"Lost 25% gold & 15% XP":h==="normal"?"Lost 10% gold & 5% XP":h==="light"?"Lost 5% gold":"No penalty";if(e.fillText(c,s,a+30),t>1.5){const d=Math.min(1,(t-1.5)*2)*n;e.globalAlpha=d,e.font="10px monospace",e.fillStyle="#887777";const u=this._systems.combat,f=[`Lv ${this._player.level}    ${u.totalKills} kills    ${u.damageDealt} dmg dealt`,`Best combo: ${u.highestCombo}    ${u.damageTaken} dmg taken`];for(let m=0;m<f.length;m++)e.fillText(f[m],s,a+46+m*14);e.globalAlpha=n}if(t>3){const d=.5+.5*Math.sin(t*4);e.globalAlpha=n*d,e.font="12px monospace",e.fillStyle="#e5e7eb",e.fillStyle="rgba(255,255,255,0.12)",e.beginPath(),e.roundRect(s-140,a+78,280,24,6),e.fill(),e.fillStyle="#e5e7eb",e.textAlign="center",e.fillText("Press SPACE or ENTER to respawn",s,a+94)}e.globalAlpha=1}_applyNGPlusHealthScaling(e){const t=this._systems.endgame.modifiers?.enemyHealthMult??1;t!==1&&(x.max[e.eid]=Math.round(x.max[e.eid]*t),x.current[e.eid]=x.max[e.eid])}_getActiveRiftModifiers(){const e=this._state.view.dungeonId;if(!e||!e.startsWith("rift_"))return[];const t=parseInt(e.slice(5),10);if(isNaN(t))return[];const i=this._systems.rift.rifts.find(a=>a.id===t);return!i||!i.active?[]:i.floors[i.currentDepth-1]?.modifiers??[]}exitToOverworld(){const e=this._state.view.dungeonId;if(e&&e.startsWith("rift_")){const a=parseInt(e.slice(5),10);isNaN(a)||this._systems.rift.exitRift(a)}const t=this._state.view.returnX,i=this._state.view.returnY;this._state.view.dungeonId=null,this._state.view.interiorId=null,this._state.view.bossArenaId=null;const s=this._viewMode.mode===se.TOP_DOWN?"exit_dungeon":"exit_boss_arena";this._viewMode.startTransition(se.ISOMETRIC,s,t,i)}}const Ho="Sprites/Lucifer/Characters",oh=`/${Ho}/warrior/Foozle_2DC0009_Lucifer_Warrior_Pixel_Art/Down/Png/WarriorDownIdle.png`,nh=`/${Ho}/necromancer/Foozle_2DC0010_Lucifer_Necromancer_Pixel_Art/Down/Png/NecromancerDownIdle.png`,lh=`/${Ho}/sorceress/Foozle_2DC0011_Lucifer_Sorceress_Pixel_Art/Down/Png/SorceressDownIdle.png`,Et=[{id:"pilgrim",name:"Pilgrim",icon:"",color:"#818cf8",description:"A balanced wanderer. Jack of all trades, master of none.",playstyle:"Versatile  Adaptive Combat",stats:[{label:"STR",value:3},{label:"DEX",value:3},{label:"INT",value:3},{label:"VIT",value:3},{label:"LCK",value:3}],skills:["Purifying Light","Quick Step","Balanced Stance"],spriteUrl:nh,spriteFrameW:48},{id:"warrior",name:"Warrior",icon:"",color:"#ef4444",description:"A fearless frontline fighter. High damage, heavy armor.",playstyle:"Melee  Tank  High DPS",stats:[{label:"STR",value:5},{label:"DEX",value:2},{label:"INT",value:1},{label:"VIT",value:5},{label:"LCK",value:2}],skills:["Shield Bash","Whirlwind","War Cry"],spriteUrl:oh,spriteFrameW:48},{id:"ranger",name:"Ranger",icon:"",color:"#22c55e",description:"A nimble hunter. Excels at range and survival.",playstyle:"Ranged  Agile  Trapper",stats:[{label:"STR",value:2},{label:"DEX",value:5},{label:"INT",value:2},{label:"VIT",value:3},{label:"LCK",value:3}],skills:["Multi-Shot","Evasion Roll","Trap Mastery"],spriteUrl:lh,spriteFrameW:48},{id:"mage",name:"Mage",icon:"",color:"#a855f7",description:"A master of arcane arts. Devastating spells, fragile body.",playstyle:"Magic DPS  AoE  Glass Cannon",stats:[{label:"STR",value:1},{label:"DEX",value:2},{label:"INT",value:5},{label:"VIT",value:2},{label:"LCK",value:3}],skills:["Fireball","Frost Nova","Arcane Shield"],spriteUrl:lh,spriteFrameW:48},{id:"shadow",name:"Shadow",icon:"",color:"#64748b",description:"A stealthy assassin. Critical hits and poison.",playstyle:"Stealth  Burst Damage  Debuffs",stats:[{label:"STR",value:3},{label:"DEX",value:4},{label:"INT",value:2},{label:"VIT",value:2},{label:"LCK",value:5}],skills:["Backstab","Smoke Bomb","Poison Blade"],spriteUrl:nh,spriteFrameW:48},{id:"paladin",name:"Paladin",icon:"",color:"#f59e0b",description:"A holy knight. Heals allies, smites corruption.",playstyle:"Tank  Healer  Anti-Corruption",stats:[{label:"STR",value:4},{label:"DEX",value:1},{label:"INT",value:3},{label:"VIT",value:4},{label:"LCK",value:2}],skills:["Holy Strike","Lay on Hands","Consecrate"],spriteUrl:oh,spriteFrameW:48}];class ab{_input;_selected=0;_time=0;_confirmed=!1;_onSelect;_root=null;_cards=[];_detailPanel=null;_fadeOverlay=null;_confirmOverlay=null;constructor(e,t){this._input=e,this._onSelect=t}enter(e){this._selected=0,this._time=0,this._confirmed=!1;const t=document.createElement("div");t.id="charselect-scene",t.style.cssText=`
            position: absolute; inset: 0;
            background: linear-gradient(180deg, #0a0a15 0%, #0f0f25 40%, #1a1030 100%);
            font-family: 'Space Grotesk', monospace;
            display: flex; flex-direction: column; align-items: center;
            overflow: hidden; color: #fff;
        `,this._root=t;const i=document.createElement("div");i.id="class-bg-glow",i.style.cssText=`
            position: absolute; width: 500px; height: 500px;
            left: 50%; top: 40%; transform: translate(-50%, -50%);
            border-radius: 50%; pointer-events: none; z-index: 0;
            background: radial-gradient(circle, var(--glow-color, rgba(129,140,248,0.04)), transparent 70%);
            animation: classGlow 4s ease-in-out infinite alternate;
            transition: background 0.5s ease;
        `,t.appendChild(i);for(let _=0;_<30;_++){const p=document.createElement("div");p.style.cssText=`
                position: absolute;
                left: ${_*137.5%v.width}px;
                top: ${_*89.3%(v.height*.4)}px;
                width: 2px; height: 2px; background: #fff;
                border-radius: 50%; opacity: 0.3;
                animation: twinkle ${1.5+_%3*.5}s ease-in-out ${_*.2}s infinite alternate;
            `,t.appendChild(p)}const s=document.createElement("div");s.style.cssText=`
            margin-top: 32px; font-size: 24px; font-weight: bold;
            color: #e5e7eb; text-align: center; z-index: 2;
        `,s.textContent="Choose Your Class",t.appendChild(s);const a=document.createElement("div");a.style.cssText=`
            font-size: 11px; color: #6b7280; text-align: center;
            margin-top: 8px; z-index: 2;
        `,a.textContent="   to browse      ENTER to confirm",t.appendChild(a);const r=document.createElement("div");r.id="class-cards",r.style.cssText=`
            display: flex; gap: 15px; margin-top: 20px; z-index: 2;
            justify-content: center;
        `,this._cards=[];for(let _=0;_<Et.length;_++){const p=Et[_],g=document.createElement("div");if(g.id=`class-card-${p.id}`,g.dataset.index=String(_),g.style.cssText=`
                width: 80px; height: 100px;
                background: rgba(20,20,30,0.6);
                border: 1px solid #333; border-radius: 8px;
                display: flex; flex-direction: column; align-items: center;
                justify-content: center; gap: 6px;
                cursor: pointer; transition: all 0.25s ease;
                position: relative;
            `,p.spriteUrl){const S=document.createElement("div");S.className="class-sprite",p.spriteFrameW;const b=52;S.style.cssText=`
                    width: ${b}px; height: ${b}px;
                    background-image: url(${p.spriteUrl});
                    background-repeat: no-repeat;
                    background-position: 0 0;
                    background-size: auto ${b}px;
                    image-rendering: pixelated;
                    image-rendering: crisp-edges;
                `,g.appendChild(S)}else{const S=document.createElement("span");S.textContent=p.icon,S.style.fontSize="28px",g.appendChild(S)}const y=document.createElement("span");y.textContent=p.name,y.style.cssText="font-size: 10px; color: #888;",g.appendChild(y),g.addEventListener("mouseenter",()=>{this._confirmed||(this._selected=_,this._updateCards(),this._updateDetail())}),g.addEventListener("click",()=>{this._confirmed||(this._selected=_,this._confirmed=!0)}),r.appendChild(g),this._cards.push(g)}t.appendChild(r);const n=document.createElement("div");n.id="selection-arrow",n.style.cssText=`
            width: 0; height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid;
            margin-top: 6px; z-index: 2;
            transition: all 0.2s ease;
        `,t.appendChild(n);const l=document.createElement("div");l.id="class-detail",l.style.cssText=`
            width: min(500px, calc(100% - 40px));
            background: rgba(15,15,25,0.85);
            border-radius: 10px; padding: 20px;
            margin-top: 16px; z-index: 2;
            display: grid; grid-template-columns: 1fr 170px;
            gap: 20px; border: 1px solid;
        `,this._detailPanel=l,t.appendChild(l);const h=document.createElement("div");h.id="confirm-prompt",h.style.cssText=`
            font-size: 12px; text-align: center;
            margin-top: 16px; z-index: 2;
            animation: menuPulse 2s ease-in-out infinite;
        `,h.textContent="[ PRESS ENTER TO BEGIN ]",t.appendChild(h);const c=document.createElement("div");c.style.cssText=`
            position: absolute; inset: 0; background: #000;
            z-index: 20; pointer-events: none;
            animation: fadeOut 0.5s ease-out forwards;
        `,t.appendChild(c);const d=document.createElement("div");d.id="confirm-overlay",d.style.cssText=`
            position: absolute; inset: 0; background: #000;
            z-index: 15; opacity: 0; pointer-events: none;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 12px;
            transition: opacity 0.5s ease;
        `;const u=document.createElement("div");u.id="confirm-class-name",u.style.cssText=`
            font-size: 22px; font-weight: bold;
            animation: confirmReveal 0.8s ease-out forwards;
        `,d.appendChild(u);const f=document.createElement("div");f.textContent="The pilgrimage begins...",f.style.cssText=`
            font-size: 11px; color: #9ca3af; margin-top: 4px;
            animation: confirmSubReveal 0.6s ease-out 0.4s forwards;
            opacity: 0;
        `,d.appendChild(f),this._confirmOverlay=d,t.appendChild(d);const m=document.createElement("style");m.textContent=`
            @keyframes twinkle {
                0% { opacity: 0.15; } 100% { opacity: 0.5; }
            }
            @keyframes menuPulse {
                0%, 100% { opacity: 0.5; } 50% { opacity: 1; }
            }
            @keyframes fadeOut {
                0% { opacity: 1; } 100% { opacity: 0; }
            }
            @keyframes cardBounce {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-5px); }
            }
            @keyframes statFill {
                0% { width: 0%; }
            }
            @keyframes classGlow {
                0% { opacity: 0.02; transform: translate(-50%, -50%) scale(0.8); }
                100% { opacity: 0.08; transform: translate(-50%, -50%) scale(1.2); }
            }
            @keyframes confirmReveal {
                0% { opacity: 0; transform: scale(0.9); letter-spacing: 8px; }
                100% { opacity: 1; transform: scale(1); letter-spacing: 3px; }
            }
            @keyframes confirmSubReveal {
                0% { opacity: 0; transform: translateY(10px); }
                100% { opacity: 1; transform: translateY(0); }
            }
        `,t.appendChild(m),e.appendChild(t),this._updateCards(),this._updateDetail()}exit(){this._root?.remove(),this._root=null,this._cards=[],this._detailPanel=null,this._fadeOverlay=null,this._confirmOverlay=null}_updateCards(){const e=Et[this._selected],t=this._root?.querySelector("#class-bg-glow");t&&(t.style.background=`radial-gradient(circle, ${e.color}08, transparent 70%)`);for(let a=0;a<this._cards.length;a++){const r=this._cards[a],n=Et[a],l=a===this._selected;r.style.background=l?`${n.color}22`:"rgba(20,20,30,0.6)",r.style.borderColor=l?n.color:"#333",r.style.borderWidth=l?"2px":"1px",r.style.boxShadow=l?`0 0 15px ${n.color}44`:"none",r.style.animation=l?"cardBounce 1s ease-in-out infinite":"none";const h=r.querySelector("span:last-child");h&&(h.style.color=l?n.color:"#888",h.style.fontWeight=l?"bold":"normal")}const i=this._root?.querySelector("#selection-arrow");i&&(i.style.borderTopColor=e.color);const s=this._root?.querySelector("#confirm-prompt");s&&(s.style.color=e.color)}_updateDetail(){const e=Et[this._selected];if(!this._detailPanel)return;this._detailPanel.style.borderColor=`${e.color}44`;const t=e.spriteUrl?`<div style="width:36px;height:36px;display:inline-block;vertical-align:middle;margin-right:6px;
                background-image:url(${e.spriteUrl});background-repeat:no-repeat;background-position:0 0;
                background-size:auto 36px;image-rendering:pixelated;"></div>`:e.icon;this._detailPanel.innerHTML=`
            <div>
                <div style="font-size: 18px; font-weight: bold; color: ${e.color}; margin-bottom: 4px; display: flex; align-items: center;">
                    ${t} ${e.name}
                </div>
                <div style="font-size: 10px; color: #9ca3af; margin-bottom: 12px;">${e.playstyle}</div>
                <div style="font-size: 11px; color: #d1d5db; line-height: 1.5; margin-bottom: 12px;">
                    ${e.description}
                </div>
                <div style="font-size: 10px; color: #6b7280; margin-bottom: 6px;">STARTING SKILLS:</div>
                ${e.skills.map(i=>`<div style="font-size: 11px; color: #e5e7eb; margin-left: 10px;"> ${i}</div>`).join("")}
            </div>
            <div>
                <div style="font-size: 9px; color: #6b7280; margin-bottom: 8px;">STATS</div>
                ${e.stats.map((i,s)=>`
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 9px; color: #9ca3af; width: 28px;">${i.label}</span>
                        <div style="flex: 1; height: 8px; background: #1f1f2f; border-radius: 3px; position: relative; overflow: hidden;">
                            <div style="width: ${i.value/5*100}%; height: 100%; background: ${e.color}; border-radius: 3px; animation: statFill 0.4s ease-out ${s*.06}s both;"></div>
                            ${[1,2,3,4].map(a=>`<div style="position: absolute; top: 0; left: ${a*20}%; width: 1px; height: 100%; background: rgba(0,0,0,0.5);"></div>`).join("")}
                        </div>
                        <span style="font-size: 8px; color: ${e.color}; width: 14px; text-align: right;">${i.value}</span>
                    </div>
                `).join("")}
            </div>
        `}update(e){if(this._time+=e,this._confirmed){this._transitionOut(e);return}(this._input.wasPressed("ArrowLeft")||this._input.wasPressed("KeyA"))&&(this._selected=(this._selected-1+Et.length)%Et.length,this._updateCards(),this._updateDetail()),(this._input.wasPressed("ArrowRight")||this._input.wasPressed("KeyD"))&&(this._selected=(this._selected+1)%Et.length,this._updateCards(),this._updateDetail()),(this._input.wasPressed("Enter")||this._input.wasPressed("Space"))&&(this._confirmed=!0)}_confirmTimer=0;_selectFired=!1;_transitionOut(e){if(this._confirmTimer+=e,this._confirmOverlay){this._confirmOverlay.style.opacity=String(Math.min(1,this._confirmTimer*2));const t=Et[this._selected],i=this._confirmOverlay.querySelector("#confirm-class-name");i&&(i.textContent=`${t.icon}  ${t.name}`,i.style.color=t.color)}this._confirmTimer>=1.5/3&&!this._selectFired&&(this._selectFired=!0,this._onSelect(Et[this._selected].id))}render(){}}async function hh(){console.log(""),console.log("  EDILAS  The Living Pilgrimage      "),console.log("  TS strict + DOM renderer + bitecs   "),console.log("  All systems ported                  "),console.log("");const o=document.getElementById("game-container");if(!o)throw new Error("Missing #game-container element");const e=new Sp(o);await e.initPixi();async function t(a){console.log(`[Boot] Starting game as ${a}`),localStorage.setItem("edilas_last_class",a);const r=new Tp;await e.setScene(r),r.setProgress(10,"Generating world"),await ri(200);const n=new Ea(e.input,e.camera,e.loader,a,e.pixiApp);r.setProgress(25,"Initializing systems"),await ri(150),r.setProgress(40,"Loading terrain tiles"),await ri(200),r.setProgress(55,"Loading character sprites"),await ri(200),r.setProgress(70,"Setting up environment");try{await n.enter(e.container)}catch(l){console.error("[Boot] Failed to enter WorldScene:",l),r.setProgress(0,`Error: ${l instanceof Error?l.message:"Failed to load world"}`);return}r.setProgress(85,"Building settlements"),await ri(200),r.setProgress(95,"Preparing expedition"),await ri(200),r.setProgress(100,"Ready"),await ri(400),e.setSceneDirect(n),console.log(`[Boot] World scene active  Class: ${a}`),window.__EDILAS__={game:e,worldScene:n,get player(){return n._player},get enemies(){return n._enemies},get state(){return n._state},get npcs(){return n._npcs},get input(){return e.input}}}const i=new kp(e.input,async()=>{const a=new ab(e.input,async r=>{await t(r)});await e.setScene(a)},async()=>{const a=new Set(["pilgrim","warrior","ranger","mage","shadow","paladin"]),r=localStorage.getItem("edilas_last_class")??"pilgrim",n=a.has(r)?r:"pilgrim";console.log(`[Boot] Continuing game as ${n}`),await t(n)}),s=new URLSearchParams(window.location.search);if(s.has("autoplay")){const a=s.get("class")??"pilgrim";console.log(`[Boot] Autoplay  starting as ${a}`),e.start(),await t(a)}else await e.setScene(i),e.start()}function ri(o){return new Promise(e=>setTimeout(e,o))}let fa=!1;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{fa||(fa=!0,hh().catch(console.error))}):fa||(fa=!0,hh().catch(console.error));export{At as $,nc as A,Ts as B,wt as C,Kt as D,Xt as E,Ps as F,$a as G,kn as H,pa as I,bo as J,ac as K,Rt as L,_e as M,Qh as N,Kf as O,st as P,Zf as Q,Vr as R,wo as S,Z as T,wa as U,rm as V,im as W,Pd as X,lm as Y,ct as Z,Sh as _,Jh as a,Ih as a0,on as a1,_t as a2,ru as a3,ln as a4,Qa as a5,hn as a6,nu as a7,_h as a8,$e as a9,Mh as aa,dp as ab,lc as ac,Ie as ad,je as ae,df as af,of as ag,Ef as ah,Mf as ai,Qf as aj,Jf as ak,om as al,am,nm as an,Yh as b,Sf as c,ht as d,He as e,Ae as f,Ru as g,ma as h,ge as i,Ne as j,Tm as k,pm as l,Th as m,tp as n,Lh as o,Ze as p,xi as q,Hd as r,Ba as s,we as t,Gu as u,qo as v,pt as w,Da as x,bf as y,La as z};
//# sourceMappingURL=main-agxXVMaJ.js.map
