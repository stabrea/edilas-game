import{r as hr,g as ur}from"./phaser-0YPJO2g1.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();var mr=hr();const x=ur(mr),Pa=1280,Ra=720,qi=64,Bi=32,D=32,I=16,pr=3,Ct=120,gr=1.6,wt=100,vt=100,fr=8,yr=15,ge=48,Ke=36,br=300,_r=200,wr=.05,vr=1.5,xr=3e5,kr=1.5,Sr=50,Mr=80,Tr=120,Et=144e4,Cr=28,Ms=["Spring","Summer","Autumn","Winter"],Ir={haven:{max:200},rotwood:{max:500},ashlands:{max:800},drowned:{max:1100},bone:{max:1400},void:{max:1700}},Pr=4,Rr=.5,Ts=.02,ui={common:{color:16777215,mult:1,dropWeight:50,label:"Common"},uncommon:{color:65280,mult:1.15,dropWeight:25,label:"Uncommon"},rare:{color:35071,mult:1.35,dropWeight:15,label:"Rare"},epic:{color:11141375,mult:1.6,dropWeight:7,label:"Epic"},legendary:{color:16746496,mult:2,dropWeight:2.5,label:"Legendary"},mythic:{color:16711680,mult:2.5,dropWeight:.5,label:"Mythic"}},Cs=.001,Ar=.5,Dr=.8,Er=.95,qr=8,mi=["Camp","Village","Town","City","Capital"],Br=.08,Fr=.05,zr=5,Hr=.03,Or=5,Is=10,Lr=10,Gt=3,Wr=3e5;class Nr extends x.Scene{buttons=[];constructor(){super({key:"MainMenuScene"})}create(){const{width:e,height:t}=this.cameras.main;this.cameras.main.setBackgroundColor("#0c0f1a"),this.add.text(e/2,t*.25,"EDILAS",{fontFamily:'"Press Start 2P", monospace',fontSize:"48px",color:"#7dd3fc"}).setOrigin(.5),this.add.text(e/2,t*.25+50,"The Living Pilgrimage",{fontFamily:'"Press Start 2P", monospace',fontSize:"14px",color:"#ffb347"}).setOrigin(.5);const i=t*.55,s=48;this.createButton("New Game",e/2,i,()=>{this.cameras.main.fadeOut(300,0,0,0),this.time.delayedCall(350,()=>{this.scene.start("BootScene",{loadSlot:void 0})})}),this.createButton("Continue",e/2,i+s,()=>{let a,o=0;for(let n=0;n<Gt;n++){const l=localStorage.getItem(`edilas_save_${n}`);if(l)try{const d=JSON.parse(l).timestamp??0;d>o&&(o=d,a=n)}catch{}}if(a!==void 0)this.cameras.main.fadeOut(300,0,0,0),this.time.delayedCall(350,()=>{this.scene.start("BootScene",{loadSlot:a})});else{const n=this.buttons[1];n&&(n.setText("No save found!"),this.time.delayedCall(1500,()=>n.setText("Continue")))}}),this.createButton("Settings",e/2,i+s*2,()=>{const a=this.buttons[2];a&&(a.setText("Coming soon..."),this.time.delayedCall(1500,()=>a.setText("Settings")))}),this.add.text(8,t-20,"v0.4.0-alpha",{fontFamily:"monospace",fontSize:"10px",color:"#444444"})}createButton(e,t,i,s){const a=this.add.text(t,i,e,{fontFamily:'"Press Start 2P", monospace',fontSize:"16px",color:"#aaaaaa",padding:{x:16,y:8}}).setOrigin(.5).setInteractive({useHandCursor:!0});a.on("pointerover",()=>{a.setColor("#7dd3fc"),a.setScale(1.08)}),a.on("pointerout",()=>{a.setColor("#aaaaaa"),a.setScale(1)}),a.on("pointerdown",s),this.buttons.push(a)}}const Qr={name:"core",assets:[{key:"player",path:"assets/sprites/characters/player_base.png"},{key:"tile_grass",path:"assets/sprites/tilesets/isometric/isometric_grass_tile_dense.png"},{key:"tile_dirt",path:"assets/sprites/tilesets/isometric/isometric_dirt_soil_floor_base_tile.png"},{key:"tile_sand",path:"assets/sprites/tilesets/isometric/isometric_grass_tile_autumn_yellow.png"},{key:"tile_stone",path:"assets/sprites/tilesets/isometric/isometric_stone_block_gray_solid.png"},{key:"tile_water",path:"assets/sprites/tilesets/isometric/isometric_deep_water_tile_full.png"},{key:"tile_snow",path:"assets/sprites/tilesets/isometric/isometric_snow_tile_fresh_white.png"},{key:"tile_path",path:"assets/sprites/tilesets/isometric/isometric_cobblestone_floor_regular.png"},{key:"tile_lava",path:"assets/sprites/tilesets/isometric/isometric_stone_block_gray_cracked.png"},{key:"tile_void_tile",path:"assets/sprites/tilesets/isometric/isometric_stone_block_gray_mossy.png"},{key:"tile_ice",path:"assets/sprites/tilesets/isometric/isometric_ice_tile_frozen_solid.png"},{key:"tile_mud",path:"assets/sprites/tilesets/isometric/isometric_dirt_floor_with_pebbles.png"},{key:"tile_bone",path:"assets/sprites/tilesets/isometric/isometric_dead_grass_tile_withered.png"},{key:"tile_corruption",path:"assets/sprites/tilesets/isometric/isometric_dead_grass_tile_brown.png"},{key:"tile_wood_floor",path:"assets/sprites/tilesets/isometric/isometric_wooden_plank_floor_base.png"},{key:"obj_tree",path:"assets/sprites/trees/Tree01_0001.png"},{key:"obj_rock",path:"assets/sprites/objects/isometric_rock_large_gray.png"},{key:"obj_bush",path:"assets/sprites/objects/isometric_bush_medium_green.png"},{key:"obj_flower",path:"assets/sprites/objects/isometric_wildflower_yellow_petals.png"},{key:"obj_tallgrass",path:"assets/sprites/objects/isometric_tall_grass_tuft_medium.png"},{key:"obj_copper",path:"assets/sprites/objects/isometric_rock_medium_gray.png"},{key:"obj_iron",path:"assets/sprites/objects/isometric_rock_cluster_small.png"},{key:"obj_gold",path:"assets/sprites/objects/isometric_rock_cluster_large.png"},{key:"obj_cactus",path:"assets/sprites/objects/isometric_tree_stump_medium.png"},{key:"obj_deadtree",path:"assets/sprites/objects/isometric_tree_stump_large_mossy.png"},{key:"obj_mushroom",path:"assets/sprites/objects/isometric_mushroom_brown_single.png"},{key:"obj_crystal",path:"assets/sprites/objects/isometric_sparkle_effect_gold.png"},{key:"obj_bonespile",path:"assets/sprites/objects/isometric_fallen_log_horizontal.png"},{key:"obj_voidcrystal",path:"assets/sprites/objects/isometric_sparkle_effect_white.png"},{key:"obj_watersource",path:"assets/sprites/objects/isometric_shallow_water_tile_full.png"},{key:"obj_dungeon",path:"assets/sprites/objects/isometric_stone_block_gray_cracked.png"},{key:"obj_riftstone",path:"assets/sprites/objects/isometric_mushroom_white_glowing.png"},{key:"obj_city",path:"assets/sprites/buildings/house1.png"},{key:"building",path:"assets/sprites/buildings/house1.png"},{key:"building_castle",path:"assets/sprites/buildings/castle.png"},{key:"building_barracks",path:"assets/sprites/buildings/barracks.png"},{key:"building_stable",path:"assets/sprites/buildings/stable.png"},{key:"building_archery",path:"assets/sprites/buildings/archery_range.png"}]},Gr={name:"enemies_common",assets:[{key:"enemy_goblin_idle",path:"assets/sprites/enemies/Goblin/Idle.png",frameWidth:150,frameHeight:150},{key:"enemy_goblin_run",path:"assets/sprites/enemies/Goblin/Run.png",frameWidth:150,frameHeight:150},{key:"enemy_goblin_attack",path:"assets/sprites/enemies/Goblin/Attack.png",frameWidth:150,frameHeight:150},{key:"enemy_goblin_hit",path:"assets/sprites/enemies/Goblin/Take Hit.png",frameWidth:150,frameHeight:150},{key:"enemy_goblin_death",path:"assets/sprites/enemies/Goblin/Death.png",frameWidth:150,frameHeight:150},{key:"enemy_skeleton_idle",path:"assets/sprites/enemies/Skeleton/Idle.png",frameWidth:150,frameHeight:150},{key:"enemy_skeleton_walk",path:"assets/sprites/enemies/Skeleton/Walk.png",frameWidth:150,frameHeight:150},{key:"enemy_skeleton_attack",path:"assets/sprites/enemies/Skeleton/Attack.png",frameWidth:150,frameHeight:150},{key:"enemy_skeleton_hit",path:"assets/sprites/enemies/Skeleton/Take Hit.png",frameWidth:150,frameHeight:150},{key:"enemy_skeleton_death",path:"assets/sprites/enemies/Skeleton/Death.png",frameWidth:150,frameHeight:150},{key:"enemy_mushroom_idle",path:"assets/sprites/enemies/Mushroom/Idle.png",frameWidth:150,frameHeight:150},{key:"enemy_mushroom_run",path:"assets/sprites/enemies/Mushroom/Run.png",frameWidth:150,frameHeight:150},{key:"enemy_mushroom_attack",path:"assets/sprites/enemies/Mushroom/Attack.png",frameWidth:150,frameHeight:150},{key:"enemy_mushroom_hit",path:"assets/sprites/enemies/Mushroom/Take Hit.png",frameWidth:150,frameHeight:150},{key:"enemy_mushroom_death",path:"assets/sprites/enemies/Mushroom/Death.png",frameWidth:150,frameHeight:150},{key:"enemy_flyingeye_flight",path:"assets/sprites/enemies/Flying eye/Flight.png",frameWidth:150,frameHeight:150},{key:"enemy_flyingeye_attack",path:"assets/sprites/enemies/Flying eye/Attack.png",frameWidth:150,frameHeight:150},{key:"enemy_flyingeye_hit",path:"assets/sprites/enemies/Flying eye/Take Hit.png",frameWidth:150,frameHeight:150},{key:"enemy_flyingeye_death",path:"assets/sprites/enemies/Flying eye/Death.png",frameWidth:150,frameHeight:150}]},Ur={name:"boss_fire_demon",assets:[{key:"boss_fire_idle",path:"assets/sprites/bosses/fire_demon/Idle_Body_000.png"},{key:"boss_fire_attack",path:"assets/sprites/bosses/fire_demon/Attack_Punch_Body_000.png"},{key:"boss_fire_run",path:"assets/sprites/bosses/fire_demon/Run_Body_000.png"},{key:"boss_fire_death",path:"assets/sprites/bosses/fire_demon/Death_Body_000.png"},{key:"boss_fire_hit",path:"assets/sprites/bosses/fire_demon/Hit_Body_000.png"}]},$r={name:"boss_ice_demon",assets:[{key:"boss_ice_idle",path:"assets/sprites/bosses/ice_demon/Idle_Body_000.png"},{key:"boss_ice_attack",path:"assets/sprites/bosses/ice_demon/Attack_Punch_Body_000.png"},{key:"boss_ice_run",path:"assets/sprites/bosses/ice_demon/Run_Body_000.png"},{key:"boss_ice_death",path:"assets/sprites/bosses/ice_demon/Death_Body_000.png"},{key:"boss_ice_hit",path:"assets/sprites/bosses/ice_demon/Hit_Body_000.png"}]},jr={name:"boss_bird",assets:[{key:"boss_bird_idle",path:"assets/sprites/bosses/bird/Idle_Body_000.png"},{key:"boss_bird_attack",path:"assets/sprites/bosses/bird/Attack_Punch_Body_000.png"},{key:"boss_bird_run",path:"assets/sprites/bosses/bird/Run_Body_000.png"},{key:"boss_bird_death",path:"assets/sprites/bosses/bird/Death_Body_000.png"},{key:"boss_bird_hit",path:"assets/sprites/bosses/bird/Hit_Body_000.png"}]},Vr={name:"biome_haven",assets:[{key:"tile_grass_flowers",path:"assets/sprites/tilesets/isometric/isometric_grass_tile_mixed_flowers.png"},{key:"tile_grass_sparse",path:"assets/sprites/tilesets/isometric/isometric_grass_tile_sparse.png"},{key:"tile_grass_clover",path:"assets/sprites/tilesets/isometric/isometric_grass_tile_with_clover.png"},{key:"obj_flower_blue",path:"assets/sprites/objects/isometric_wildflower_blue_petals.png"},{key:"obj_flower_red",path:"assets/sprites/objects/isometric_wildflower_red_petals.png"},{key:"obj_flower_purple",path:"assets/sprites/objects/isometric_wildflower_purple_petals.png"},{key:"obj_bush_large",path:"assets/sprites/objects/isometric_bush_large_green.png"},{key:"obj_bush_small",path:"assets/sprites/objects/isometric_bush_small_green.png"}]},Yr={name:"biome_rotwood",assets:[{key:"tile_grass_autumn",path:"assets/sprites/tilesets/isometric/isometric_grass_tile_autumn_orange.png"},{key:"tile_grass_autumn_red",path:"assets/sprites/tilesets/isometric/isometric_grass_tile_autumn_red.png"},{key:"obj_mushroom_red",path:"assets/sprites/objects/isometric_mushroom_red_spotted_single.png"},{key:"obj_mushroom_cluster",path:"assets/sprites/objects/isometric_mushroom_red_spotted_cluster.png"},{key:"obj_fallen_log",path:"assets/sprites/objects/isometric_fallen_log_diagonal.png"},{key:"obj_tree_stump",path:"assets/sprites/objects/isometric_tree_stump_small.png"}]},Xr={name:"biome_ashlands",assets:[{key:"tile_dead_grass",path:"assets/sprites/tilesets/isometric/isometric_dead_grass_tile_brown.png"},{key:"tile_cobblestone_weathered",path:"assets/sprites/tilesets/isometric/isometric_cobblestone_floor_weathered.png"}]},Kr={name:"biome_drowned",assets:[{key:"tile_shallow_water",path:"assets/sprites/tilesets/isometric/isometric_shallow_water_tile_full.png"},{key:"tile_water_shore_n",path:"assets/sprites/tilesets/isometric/isometric_deep_water_tile_shore_north.png"},{key:"tile_water_shore_s",path:"assets/sprites/tilesets/isometric/isometric_deep_water_tile_shore_south.png"},{key:"tile_water_shore_e",path:"assets/sprites/tilesets/isometric/isometric_deep_water_tile_shore_east.png"},{key:"tile_water_shore_w",path:"assets/sprites/tilesets/isometric/isometric_deep_water_tile_shore_west.png"}]},Jr={name:"biome_ice",assets:[{key:"tile_ice_cracked",path:"assets/sprites/tilesets/isometric/isometric_ice_tile_frozen_cracked.png"},{key:"tile_ice_snow",path:"assets/sprites/tilesets/isometric/isometric_ice_tile_with_snow.png"},{key:"tile_snow_packed",path:"assets/sprites/tilesets/isometric/isometric_snow_tile_packed.png"},{key:"tile_snow_footprints",path:"assets/sprites/tilesets/isometric/isometric_snow_tile_with_footprints.png"}]},Zr={name:"dungeon",assets:[{key:"dungeon_floor",path:"assets/sprites/dungeon/evildungeon_0.png"},{key:"dungeon_fountain",path:"assets/sprites/dungeon/blood-fountain.png"},{key:"dungeon_demon",path:"assets/sprites/dungeon/demon-purple.png"},{key:"dungeon_drain",path:"assets/sprites/dungeon/drain-blood.png"},{key:"dungeon_pentagram",path:"assets/sprites/dungeon/pentagramm.png"},{key:"dungeon_spikes",path:"assets/sprites/dungeon/spikes_2.png"},{key:"dungeon_scythe",path:"assets/sprites/dungeon/swinging_scythe-correct.png"}]},eo={name:"food",assets:[{key:"food_apple",path:"assets/sprites/food/Apple.png"},{key:"food_bread",path:"assets/sprites/food/Bread.png"},{key:"food_cheese",path:"assets/sprites/food/Cheese.png"},{key:"food_chicken",path:"assets/sprites/food/ChickenLeg.png"},{key:"food_fish",path:"assets/sprites/food/Fish.png"},{key:"food_steak",path:"assets/sprites/food/Steak.png"},{key:"food_potato",path:"assets/sprites/food/Potato.png"},{key:"food_mushroom",path:"assets/sprites/food/Mushroom.png"},{key:"food_cookie",path:"assets/sprites/food/Cookie.png"},{key:"food_pie",path:"assets/sprites/food/PieApple.png"},{key:"food_beer",path:"assets/sprites/food/Beer.png"},{key:"food_wine",path:"assets/sprites/food/Wine.png"}]},to={name:"effects",assets:[{key:"fx_fire_swoosh",path:"assets/sprites/effects/fire_swoosh_attack_trail.png",frameWidth:128,frameHeight:128},{key:"fx_slash_cross",path:"assets/sprites/effects/slash_cross_hit_impact.png",frameWidth:128,frameHeight:128},{key:"fx_wind_slash",path:"assets/sprites/effects/wind_slash_quick_attack.png",frameWidth:128,frameHeight:128},{key:"fx_sparkle_burst",path:"assets/sprites/effects/sparkle_burst_collect_item.png",frameWidth:128,frameHeight:128},{key:"fx_smoke_poof",path:"assets/sprites/effects/smoke_poof_disappear_effect.png",frameWidth:128,frameHeight:128},{key:"fx_portal",path:"assets/sprites/effects/portal_ring_teleport_effect.png",frameWidth:128,frameHeight:128},{key:"fx_dust_puff",path:"assets/sprites/effects/dust_puff_small_impact.png",frameWidth:64,frameHeight:64}]},pi={core:Qr,enemies_common:Gr,boss_fire_demon:Ur,boss_ice_demon:$r,boss_bird:jr,biome_haven:Vr,biome_rotwood:Yr,biome_ashlands:Xr,biome_drowned:Kr,biome_ice:Jr,dungeon:Zr,food:eo,effects:to};class Ne{static instance;loadedPacks=new Set;loadingPacks=new Set;constructor(){}static getInstance(){return Ne.instance||(Ne.instance=new Ne),Ne.instance}isPackLoaded(e){return this.loadedPacks.has(e)}async loadPacks(e,t){const i=t.filter(s=>!this.loadedPacks.has(s)&&!this.loadingPacks.has(s)&&pi[s]);if(i.length!==0){for(const s of i){this.loadingPacks.add(s);const a=pi[s];for(const o of a.assets)this.queueAsset(e,o)}return new Promise(s=>{e.load.once("complete",()=>{for(const a of i)this.loadedPacks.add(a),this.loadingPacks.delete(a);s()}),e.load.start()})}}loadCorePack(e){if(this.loadedPacks.has("core"))return;this.loadingPacks.add("core");const t=pi.core;for(const i of t.assets)this.queueAsset(e,i);e.load.once("complete",()=>{this.loadedPacks.add("core"),this.loadingPacks.delete("core")})}queueAsset(e,t){t.frameWidth&&t.frameHeight?e.load.spritesheet(t.key,t.path,{frameWidth:t.frameWidth,frameHeight:t.frameHeight}):e.load.image(t.key,t.path)}reset(){this.loadedPacks.clear(),this.loadingPacks.clear()}}class io extends x.Scene{loadSlot;constructor(){super({key:"BootScene"})}init(e){this.loadSlot=e.loadSlot}preload(){const{width:e,height:t}=this.cameras.main,i=e/2-160,s=t/2,a=320,o=24;this.add.rectangle(e/2,s,a+4,o+4,3355443).setStrokeStyle(2,8246268);const l=this.add.rectangle(i+2,s,0,o,8246268);l.setOrigin(0,.5),this.add.text(e/2,s-60,"EDILAS",{fontFamily:'"Press Start 2P", monospace',fontSize:"32px",color:"#7dd3fc"}).setOrigin(.5),this.add.text(e/2,s-30,"The Living Pilgrimage",{fontFamily:'"Press Start 2P", monospace',fontSize:"12px",color:"#ffb347"}).setOrigin(.5);const h=this.add.text(e/2,s+30,"Loading...",{fontFamily:"monospace",fontSize:"14px",color:"#aaaaaa"});h.setOrigin(.5),this.load.on("progress",u=>{l.width=a*u,h.setText(`Loading... ${Math.round(u*100)}%`)}),this.load.on("complete",()=>{h.setText("Ready!")}),this.createPlaceholderAssets(),Ne.getInstance().loadCorePack(this)}create(){this.time.delayedCall(500,()=>{this.scene.start("OverworldScene",{loadSlot:this.loadSlot}),this.scene.launch("UIScene")})}createPlaceholderAssets(){const e=this.add.graphics();e.setVisible(!1),e.clear(),e.fillStyle(8246268),e.fillRect(0,0,16,16),e.generateTexture("player",16,16);const t={grass:4881471,dirt:9136404,sand:14401660,stone:8947848,water:2254506,snow:14540270,path:11176021,lava:16729088,void_tile:2228275,ice:11197951,mud:6706483,bone:13417369,corruption:4456550,wood_floor:10053171};for(const[s,a]of Object.entries(t))e.clear(),e.fillStyle(a),e.beginPath(),e.moveTo(32,0),e.lineTo(64,16),e.lineTo(32,32),e.lineTo(0,16),e.closePath(),e.fillPath(),e.lineStyle(1,0,.2),e.beginPath(),e.moveTo(32,0),e.lineTo(64,16),e.lineTo(32,32),e.lineTo(0,16),e.closePath(),e.strokePath(),e.generateTexture(`tile_${s}`,64,32);const i={obj_tree:{color:2263842,size:20},obj_rock:{color:7829367,size:14},obj_bush:{color:3385907,size:12},obj_flower:{color:16768324,size:8},obj_tallgrass:{color:6732646,size:10},obj_copper:{color:13399859,size:14},obj_iron:{color:10066329,size:14},obj_gold:{color:16763904,size:14},obj_cactus:{color:4500036,size:16},obj_deadtree:{color:8939076,size:18},obj_mushroom:{color:13395507,size:10},obj_crystal:{color:6737151,size:12},obj_bonespile:{color:14535850,size:12},obj_voidcrystal:{color:11158783,size:14},obj_watersource:{color:4491468,size:16},obj_dungeon:{color:4465254,size:18},obj_riftstone:{color:8930559,size:16},obj_city:{color:12294502,size:20}};for(const[s,{color:a,size:o}]of Object.entries(i))e.clear(),e.fillStyle(a),e.fillRect(0,0,o,o),e.generateTexture(s,o,o);e.clear(),e.fillStyle(16729156),e.fillRect(0,0,16,16),e.generateTexture("enemy",16,16),e.clear(),e.fillStyle(4521796),e.fillRect(0,0,16,16),e.generateTexture("npc",16,16),e.clear(),e.fillStyle(16763904),e.fillRect(0,0,12,12),e.generateTexture("item_drop",12,12),e.clear(),e.fillStyle(16777215),e.fillCircle(4,4,4),e.generateTexture("projectile",8,8),e.clear(),e.fillStyle(11158783),e.fillRect(0,0,32,32),e.lineStyle(2,16746751,1),e.strokeRect(0,0,32,32),e.generateTexture("boss",32,32),e.clear(),e.fillStyle(8939076),e.fillRect(0,0,24,24),e.lineStyle(1,13413e3,.6),e.strokeRect(0,0,24,24),e.generateTexture("building",24,24),e.clear(),e.fillStyle(13404194),e.fillRect(0,0,14,14),e.lineStyle(1,16763972,.8),e.strokeRect(0,0,14,14),e.generateTexture("chest",14,14),e.clear(),e.fillStyle(16777215),e.fillRect(0,0,4,4),e.generateTexture("particle",4,4),e.clear(),e.fillStyle(6693580),e.fillCircle(10,10,10),e.lineStyle(2,11167487,.8),e.strokeCircle(10,10,10),e.generateTexture("rift_portal",20,20),e.clear(),e.fillStyle(1114146,.5),e.fillRect(0,0,32,32),e.generateTexture("shadow_overlay",32,32),e.destroy()}}var it={ui8:"ui8",ui16:"ui16",ui32:"ui32",f32:"f32",eid:"eid"},Ps={i8:"Int8",ui8:"Uint8",ui8c:"Uint8Clamped",i16:"Int16",ui16:"Uint16",i32:"Int32",ui32:"Uint32",eid:"Uint32",f32:"Float32",f64:"Float64"},Qe={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},Rs={uint8:2**8,uint16:2**16},so=r=>e=>Math.ceil(e/r)*r,ao=so(4),ro=Symbol("storeRef"),Fi=Symbol("storeSize"),oo=Symbol("storeMaps"),Ge=Symbol("storeFlattened"),qt=Symbol("storeBase"),no=Symbol("storeType"),Aa=Symbol("storeArrayElementCounts"),Ut=Symbol("storeSubarrays"),Da=Symbol("subarrayCursors"),lo=Symbol("subarray"),zi=Symbol("parentArray"),Ea=Symbol("tagStore"),As=Symbol("indexType"),Ds=Symbol("indexBytes"),qa=Symbol("isEidType"),we={},co=(r,e)=>{if(ArrayBuffer.isView(r))r[e]=r.slice(0);else{const t=r[zi].slice(0);r[e]=r.map((i,s)=>{const{length:a}=r[s],o=a*s,n=o+a;return t.subarray(o,n)})}},ho=(r,e)=>{r[Ge]&&r[Ge].forEach(t=>{ArrayBuffer.isView(t)?t[e]=0:t[e].fill(0)})},uo=(r,e)=>{const t=e*Qe[r].BYTES_PER_ELEMENT,i=new ArrayBuffer(t),s=new Qe[r](i);return s[qa]=r===it.eid,s},mo=(r,e,t)=>{const i=r[Fi],s=Array(i).fill(0);s[no]=e,s[qa]=e===it.eid;const a=r[Da],o=t<=Rs.uint8?it.ui8:t<=Rs.uint16?it.ui16:it.ui32;if(!t)throw new Error("bitECS - Must define component array length");if(!Qe[e])throw new Error(`bitECS - Invalid component array property type ${e}`);if(!r[Ut][e]){const c=r[Aa][e],d=new Qe[e](ao(c*i));d[As]=Ps[o],d[Ds]=Qe[o].BYTES_PER_ELEMENT,r[Ut][e]=d}const n=a[e],l=n+i*t;a[e]=l,s[zi]=r[Ut][e].subarray(n,l);for(let c=0;c<i;c++){const d=t*c,h=d+t;s[c]=s[zi].subarray(d,h),s[c][As]=Ps[o],s[c][Ds]=Qe[o].BYTES_PER_ELEMENT,s[c][lo]=!0}return s},Es=r=>Array.isArray(r)&&typeof r[0]=="string"&&typeof r[1]=="number",po=(r,e)=>{const t=Symbol("store");if(!r||!Object.keys(r).length)return we[t]={[Fi]:e,[Ea]:!0,[qt]:()=>we[t]},we[t];r=JSON.parse(JSON.stringify(r));const i={},s=o=>{const n=Object.keys(o);for(const l of n)Es(o[l])?(i[o[l][0]]||(i[o[l][0]]=0),i[o[l][0]]+=o[l][1]):o[l]instanceof Object&&s(o[l])};s(r);const a={[Fi]:e,[oo]:{},[Ut]:{},[ro]:t,[Da]:Object.keys(Qe).reduce((o,n)=>({...o,[n]:0}),{}),[Ge]:[],[Aa]:i};if(r instanceof Object&&Object.keys(r).length){const o=(n,l)=>{if(typeof n[l]=="string")n[l]=uo(n[l],e),n[l][qt]=()=>we[t],a[Ge].push(n[l]);else if(Es(n[l])){const[c,d]=n[l];n[l]=mo(a,c,d),n[l][qt]=()=>we[t],a[Ge].push(n[l])}else n[l]instanceof Object&&(n[l]=Object.keys(n[l]).reduce(o,n[l]));return n};return we[t]=Object.assign(Object.keys(r).reduce(o,r),a),we[t][qt]=()=>we[t],we[t]}},mt=()=>{const r=[],e=[];r.sort=function(o){const n=Array.prototype.sort.call(this,o);for(let l=0;l<r.length;l++)e[r[l]]=l;return n};const t=o=>r[e[o]]===o;return{add:o=>{t(o)||(e[o]=r.push(o)-1)},remove:o=>{if(!t(o))return;const n=e[o],l=r.pop();l!==o&&(r[n]=l,e[l]=n)},has:t,sparse:e,dense:r,reset:()=>{r.length=0,e.length=0}}},Ae=Symbol("entityMasks"),li=Symbol("entityComponents"),je=Symbol("entitySparseSet"),xt=Symbol("entityArray"),go=1e5,Hi=0,Ba=go,os=()=>Ba,pt=[],fo=.01,yo=fo,bo=()=>Hi,_o=new Map,ci=r=>{const e=r[hs]?pt.length?pt.shift():Hi++:pt.length>Math.round(Ba*yo)?pt.shift():Hi++;if(e>r[ds])throw new Error("bitECS - max entities reached");return r[je].add(e),_o.set(e,r),r[ns].forEach(t=>{ls(r,t,e)&&cs(t,e)}),r[li].set(e,new Set),e},ii=(r,e)=>{if(r[je].has(e)){r[di].forEach(t=>{za(r,t,e)}),r[hs]||pt.push(e),r[je].remove(e),r[li].delete(e),r[Ha].delete(r[Li].get(e)),r[Li].delete(e);for(let t=0;t<r[Ae].length;t++)r[Ae][t][e]=0}},wo=Symbol("$modifier"),di=Symbol("queries"),ns=Symbol("notQueries"),vo=Symbol("queryAny"),xo=Symbol("queryAll"),ko=Symbol("queryNone"),si=Symbol("queryMap"),kt=Symbol("$dirtyQueries"),Fa=Symbol("queryComponents"),So=(r,e)=>{const t=[],i=[],s=[];e[Fa].forEach(A=>{if(typeof A=="function"&&A[wo]){const[G,Y]=A();r[ke].has(G)||Oi(r,G),Y==="not"&&i.push(G),Y==="changed"&&(s.push(G),t.push(G))}else r[ke].has(A)||Oi(r,A),t.push(A)});const a=A=>r[ke].get(A),o=t.concat(i).map(a),n=mt(),l=[],c=[],d=mt(),h=mt(),u=mt(),m=o.map(A=>A.generationId).reduce((A,G)=>(A.includes(G)||A.push(G),A),[]),g=(A,G)=>(A[G.generationId]||(A[G.generationId]=0),A[G.generationId]|=G.bitflag,A),y=t.map(a).reduce(g,{}),_=i.map(a).reduce(g,{}),w=o.reduce(g,{}),k=t.filter(A=>!A[Ea]).map(A=>Object.getOwnPropertySymbols(A).includes(Ge)?A[Ge]:[A]).reduce((A,G)=>A.concat(G),[]),H=Object.assign(n,{archetypes:l,changed:c,components:t,notComponents:i,changedComponents:s,allComponents:o,masks:y,notMasks:_,hasMasks:w,generations:m,flatProps:k,toRemove:d,entered:h,exited:u,shadows:[]});r[si].set(e,H),r[di].add(H),o.forEach(A=>{A.queries.add(H)}),i.length&&r[ns].add(H);for(let A=0;A<bo();A++){if(!r[je].has(A))continue;ls(r,H,A)&&cs(H,A)}},Mo=(r,e)=>{const t=Symbol(),i=r.flatProps[e];return co(i,t),r.shadows[e]=i[t],i[t]},To=(r,e)=>{e&&(r.changed=[]);const{flatProps:t,shadows:i}=r;for(let s=0;s<r.dense.length;s++){const a=r.dense[s];let o=!1;for(let n=0;n<t.length;n++){const l=t[n],c=i[n]||Mo(r,n);if(ArrayBuffer.isView(l[a])){for(let d=0;d<l[a].length;d++)if(l[a][d]!==c[a][d]){o=!0;break}c[a].set(l[a])}else l[a]!==c[a]&&(o=!0,c[a]=l[a])}o&&r.changed.push(a)}return r.changed},ne=(...r)=>{let e,t,i,s;if(Array.isArray(r[0])&&(e=r[0]),e===void 0||e[ke]!==void 0)return o=>o?o[xt]:e[xt];const a=function(o,n=!0){o[si].has(a)||So(o,a);const l=o[si].get(a);return Io(o),l.changedComponents.length?To(l,n):l.dense};return a[Fa]=e,a[vo]=t,a[xo]=i,a[ko]=s,a},ls=(r,e,t)=>{const{masks:i,notMasks:s,generations:a}=e;for(let o=0;o<a.length;o++){const n=a[o],l=i[n],c=s[n],d=r[Ae][n][t];if(c&&(d&c)!==0||l&&(d&l)!==l)return!1}return!0},cs=(r,e)=>{r.toRemove.remove(e),r.entered.add(e),r.add(e)},Co=r=>{for(let e=r.toRemove.dense.length-1;e>=0;e--){const t=r.toRemove.dense[e];r.toRemove.remove(t),r.remove(t)}},Io=r=>{r[kt].size&&(r[kt].forEach(Co),r[kt].clear())},za=(r,e,t)=>{!e.has(t)||e.toRemove.has(t)||(e.toRemove.add(t),r[kt].add(e),e.exited.add(t))},ke=Symbol("componentMap"),J=(r,e)=>{const t=po(r,os());return r&&Object.keys(r).length,t},Po=r=>{r[St]*=2,r[St]>=2**31&&(r[St]=1,r[Ae].push(new Uint32Array(r[ds])))},Oi=(r,e)=>{if(!e)throw new Error("bitECS - Cannot register null or undefined component");const t=new Set,i=new Set,s=new Set;r[di].forEach(a=>{a.allComponents.includes(e)&&t.add(a)}),r[ke].set(e,{generationId:r[Ae].length-1,bitflag:r[St],store:e,queries:t,notQueries:i,changedQueries:s}),Po(r)},U=(r,e,t)=>{const i=r[ke].get(e);if(!i)return!1;const{generationId:s,bitflag:a}=i;return(r[Ae][s][t]&a)===a},N=(r,e,t,i=!1)=>{if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!r[je].has(t))throw new Error("bitECS - entity does not exist in the world.");if(r[ke].has(e)||Oi(r,e),U(r,e,t))return;const s=r[ke].get(e),{generationId:a,bitflag:o,queries:n,notQueries:l}=s;r[Ae][a][t]|=o,n.forEach(c=>{c.toRemove.remove(t);const d=ls(r,c,t);d&&(c.exited.remove(t),cs(c,t)),d||(c.entered.remove(t),za(r,c,t))}),r[li].get(t).add(e),i&&ho(e,t)},ds=Symbol("size"),St=Symbol("bitflag"),Ro=Symbol("archetypes"),Ha=Symbol("localEntities"),Li=Symbol("localEntityLookup"),hs=Symbol("manualEntityRecycling"),Ao=(...r)=>{const e=typeof r[0]=="object"?r[0]:{},t=typeof r[0]=="number"?r[0]:typeof r[1]=="number"?r[1]:os();return Do(e,t),e},Do=(r,e=os())=>(r[ds]=e,r[xt]&&r[xt].forEach(t=>ii(r,t)),r[Ae]=[new Uint32Array(e)],r[li]=new Map,r[Ro]=[],r[je]=mt(),r[xt]=r[je].dense,r[St]=1,r[ke]=new Map,r[si]=new Map,r[di]=new Set,r[ns]=new Set,r[kt]=new Set,r[Ha]=new Map,r[Li]=new Map,r[hs]=!1,r),R=it;class Rt{seed;current;constructor(e=42069){this.seed=e,this.current=e}next(){return this.current=this.current*1103515245+12345&2147483647,this.current/2147483647}setSeed(e,t){this.current=(this.seed^e*73856093^t*19349663)>>>0,this.next(),this.next()}nextInt(e,t){return Math.floor(this.next()*(t-e+1))+e}nextFloat(e=0,t=1){return this.next()*(t-e)+e}pick(e){return e[Math.floor(this.next()*e.length)]}shuffle(e){for(let t=e.length-1;t>0;t--){const i=Math.floor(this.next()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e}weightedPick(e,t){const i=t.reduce((a,o)=>a+o,0);let s=this.next()*i;for(let a=0;a<e.length;a++)if(s-=t[a],s<=0)return e[a];return e[e.length-1]}reset(){this.current=this.seed}getSeed(){return this.seed}}class qs{perm;constructor(e=42069){const t=new Rt(e),i=Array.from({length:256},(s,a)=>a);t.shuffle(i),this.perm=[...i,...i]}fade(e){return e*e*e*(e*(e*6-15)+10)}lerp(e,t,i){return e+i*(t-e)}grad(e,t,i){const s=e&3,a=s<2?t:i,o=s<2?i:t;return(s&1?-a:a)+(s&2?-o:o)}noise2D(e,t){const i=Math.floor(e)&255,s=Math.floor(t)&255,a=e-Math.floor(e),o=t-Math.floor(t),n=this.fade(a),l=this.fade(o),c=this.perm[this.perm[i]+s],d=this.perm[this.perm[i]+s+1],h=this.perm[this.perm[i+1]+s],u=this.perm[this.perm[i+1]+s+1];return this.lerp(this.lerp(this.grad(c,a,o),this.grad(h,a-1,o),n),this.lerp(this.grad(d,a,o-1),this.grad(u,a-1,o-1),n),l)}fbm(e,t,i=4,s=2,a=.5){let o=0,n=1,l=1,c=0;for(let d=0;d<i;d++)o+=this.noise2D(e*n,t*n)*l,c+=l,l*=a,n*=s;return o/c}}var L=(r=>(r[r.Grass=0]="Grass",r[r.Dirt=1]="Dirt",r[r.Sand=2]="Sand",r[r.Stone=3]="Stone",r[r.Water=4]="Water",r[r.Snow=5]="Snow",r[r.Path=6]="Path",r[r.Tilled=7]="Tilled",r[r.Watered=8]="Watered",r[r.Lava=9]="Lava",r[r.VoidTile=10]="VoidTile",r[r.WoodFloor=11]="WoodFloor",r[r.Ice=12]="Ice",r[r.Mud=13]="Mud",r[r.Bone=14]="Bone",r[r.Corruption=15]="Corruption",r))(L||{}),z=(r=>(r[r.None=0]="None",r[r.Tree=1]="Tree",r[r.Rock=2]="Rock",r[r.Bush=3]="Bush",r[r.Flower=4]="Flower",r[r.TallGrass=5]="TallGrass",r[r.CopperNode=6]="CopperNode",r[r.IronNode=7]="IronNode",r[r.GoldNode=8]="GoldNode",r[r.Cactus=9]="Cactus",r[r.DeadTree=10]="DeadTree",r[r.Mushroom=11]="Mushroom",r[r.Crystal=12]="Crystal",r[r.BonesPile=13]="BonesPile",r[r.VoidCrystal=14]="VoidCrystal",r[r.Chest=15]="Chest",r[r.WaterSource=16]="WaterSource",r[r.DungeonEntrance=17]="DungeonEntrance",r[r.RiftStone=18]="RiftStone",r[r.CityMarker=19]="CityMarker",r))(z||{});const Bs={0:{solid:!1,walkSpeed:1,texture:"tile_grass",variants:4},1:{solid:!1,walkSpeed:1,texture:"tile_dirt",variants:3},2:{solid:!1,walkSpeed:.8,texture:"tile_sand",variants:3},3:{solid:!1,walkSpeed:1,texture:"tile_stone",variants:3},4:{solid:!0,walkSpeed:0,texture:"tile_water",variants:2},5:{solid:!1,walkSpeed:.7,texture:"tile_snow",variants:3},6:{solid:!1,walkSpeed:1.2,texture:"tile_path",variants:2},7:{solid:!1,walkSpeed:.9,texture:"tile_dirt",variants:1},8:{solid:!1,walkSpeed:.9,texture:"tile_dirt",variants:1},9:{solid:!0,walkSpeed:0,texture:"tile_lava",variants:2},10:{solid:!1,walkSpeed:.6,texture:"tile_void_tile",variants:2},11:{solid:!1,walkSpeed:1,texture:"tile_wood_floor",variants:1},12:{solid:!1,walkSpeed:1.3,texture:"tile_ice",variants:2},13:{solid:!1,walkSpeed:.5,texture:"tile_mud",variants:2},14:{solid:!1,walkSpeed:.9,texture:"tile_bone",variants:2},15:{solid:!1,walkSpeed:.7,texture:"tile_corruption",variants:2}},$t={0:{solid:!1,destructible:!1,interactable:!1,texture:"",hp:0,scale:1},1:{solid:!0,destructible:!0,interactable:!0,texture:"obj_tree",hp:20,scale:.12},2:{solid:!0,destructible:!0,interactable:!0,texture:"obj_rock",hp:30,scale:.5},3:{solid:!1,destructible:!0,interactable:!0,texture:"obj_bush",hp:5,scale:.5},4:{solid:!1,destructible:!0,interactable:!0,texture:"obj_flower",hp:1,scale:.7},5:{solid:!1,destructible:!0,interactable:!1,texture:"obj_tallgrass",hp:1,scale:.6},6:{solid:!0,destructible:!0,interactable:!0,texture:"obj_copper",hp:40,scale:.5},7:{solid:!0,destructible:!0,interactable:!0,texture:"obj_iron",hp:60,scale:.5},8:{solid:!0,destructible:!0,interactable:!0,texture:"obj_gold",hp:80,scale:.5},9:{solid:!0,destructible:!0,interactable:!1,texture:"obj_cactus",hp:15,scale:.5},10:{solid:!0,destructible:!0,interactable:!0,texture:"obj_deadtree",hp:10,scale:.12},11:{solid:!1,destructible:!0,interactable:!0,texture:"obj_mushroom",hp:1,scale:.7},12:{solid:!0,destructible:!0,interactable:!0,texture:"obj_crystal",hp:50,scale:.6},13:{solid:!1,destructible:!0,interactable:!0,texture:"obj_bonespile",hp:5,scale:.5},14:{solid:!0,destructible:!0,interactable:!0,texture:"obj_voidcrystal",hp:100,scale:.6},15:{solid:!0,destructible:!1,interactable:!0,texture:"chest",hp:0,scale:.8},16:{solid:!0,destructible:!1,interactable:!0,texture:"obj_watersource",hp:0,scale:.5},17:{solid:!0,destructible:!1,interactable:!0,texture:"obj_dungeon",hp:0,scale:.5},18:{solid:!0,destructible:!1,interactable:!0,texture:"obj_riftstone",hp:0,scale:.6},19:{solid:!1,destructible:!1,interactable:!0,texture:"obj_city",hp:0,scale:.15}},Eo={1:[{itemId:"wood",qty:[2,5]}],2:[{itemId:"stone",qty:[1,3]}],6:[{itemId:"copper_ore",qty:[1,3]}],7:[{itemId:"iron_ore",qty:[1,2]}],8:[{itemId:"gold_ore",qty:[1,2]}],3:[{itemId:"fiber",qty:[1,3]}],12:[{itemId:"crystal_shard",qty:[1,2]}],10:[{itemId:"wood",qty:[1,3]}],9:[{itemId:"cactus_fruit",qty:[1,2]}],11:[{itemId:"mushroom",qty:[1,1]}],13:[{itemId:"bone_fragment",qty:[1,3]}],14:[{itemId:"void_shard",qty:[1,2]}]};var Z=(r=>(r[r.Haven=0]="Haven",r[r.Rotwood=1]="Rotwood",r[r.Ashlands=2]="Ashlands",r[r.Drowned=3]="Drowned",r[r.BoneWastes=4]="BoneWastes",r[r.TheVoid=5]="TheVoid",r[r.Edilas=6]="Edilas",r))(Z||{});const us={0:{id:0,name:"Haven",primaryTile:L.Grass,secondaryTile:L.Dirt,accentTile:L.Path,difficultyMult:1,corruptionRate:1e-4},1:{id:1,name:"Rotwood",primaryTile:L.Grass,secondaryTile:L.Mud,accentTile:L.Dirt,difficultyMult:1.3,corruptionRate:5e-4},2:{id:2,name:"Ashlands",primaryTile:L.Stone,secondaryTile:L.Dirt,accentTile:L.Lava,difficultyMult:1.7,corruptionRate:8e-4},3:{id:3,name:"Drowned Depths",primaryTile:L.Stone,secondaryTile:L.Mud,accentTile:L.Water,difficultyMult:2,corruptionRate:.001},4:{id:4,name:"Bone Wastes",primaryTile:L.Sand,secondaryTile:L.Bone,accentTile:L.Stone,difficultyMult:2.5,corruptionRate:.0015},5:{id:5,name:"The Void",primaryTile:L.VoidTile,secondaryTile:L.Stone,accentTile:L.Corruption,difficultyMult:3,corruptionRate:.003},6:{id:6,name:"EDILAS",primaryTile:L.Corruption,secondaryTile:L.VoidTile,accentTile:L.Stone,difficultyMult:3.5,corruptionRate:.005}},qo={0:[[z.Tree,.15],[z.Bush,.06],[z.Flower,.08],[z.TallGrass,.1],[z.Rock,.02],[z.CopperNode,.005]],1:[[z.Tree,.25],[z.Bush,.08],[z.Mushroom,.06],[z.TallGrass,.05],[z.Rock,.02],[z.IronNode,.005]],2:[[z.Rock,.1],[z.DeadTree,.04],[z.CopperNode,.01],[z.IronNode,.008],[z.Crystal,.003]],3:[[z.Rock,.06],[z.Bush,.03],[z.Mushroom,.04],[z.Crystal,.005],[z.IronNode,.006]],4:[[z.BonesPile,.08],[z.Rock,.05],[z.DeadTree,.02],[z.Cactus,.04],[z.GoldNode,.003]],5:[[z.VoidCrystal,.04],[z.Rock,.03],[z.Crystal,.02]],6:[[z.VoidCrystal,.06],[z.Crystal,.04],[z.BonesPile,.03]]};class Bo{noise;detailNoise;constructor(e){this.noise=new qs(e),this.detailNoise=new qs(e+12345)}getBiome(e,t){const i=Math.sqrt(e*e+t*t),s=this.noise.fbm(e*.005,t*.005,3)*30,a=i+s,o=Ir;return a<o.haven.max?0:a<o.rotwood.max?1:a<o.ashlands.max?2:a<o.drowned.max?3:a<o.bone.max?4:a<o.void.max?5:6}getTile(e,t){const i=this.getBiome(e,t),s=us[i],a=this.noise.fbm(e*Ts,t*Ts,Pr,2,Rr),o=this.detailNoise.noise2D(e*.03,t*.03);return i===3&&o<-.4?L.Water:i===2&&o<-.5?L.Lava:a>.3?s.accentTile:a>-.1?s.primaryTile:s.secondaryTile}getObject(e,t,i){const s=this.getBiome(e,t),a=qo[s],o=i.next();let n=0;for(const[l,c]of a)if(n+=c,o<n)return l;return z.None}}class se{static worldToScreen(e,t,i=0){return{x:(e-t)*(qi/2),y:(e+t)*(Bi/2)-i*16}}static screenToWorld(e,t){const i=qi/2,s=Bi/2,a=(e/i+t/s)/2,o=(t/s-e/i)/2;return{tileX:Math.floor(a),tileY:Math.floor(o)}}static pixelToTile(e,t){return{tileX:Math.floor(e/D),tileY:Math.floor(t/D)}}static tileToPixel(e,t){return{x:e*D,y:t*D}}static tileHash(e,t,i){return((e*73856093^t*19349663)>>>0)%i}static getDepth(e,t,i=0){return(e+t)*10+i}static tileToChunk(e,t,i){return{cx:Math.floor(e/i),cy:Math.floor(t/i)}}}function ve(r,e){return`${r},${e}`}class Fo{scene;rng;biomeGen;chunks=new Map;chunkContainers=new Map;loadedChunks=new Set;lastCamCX=-9999;lastCamCY=-9999;constructor(e,t=42069){this.scene=e,this.rng=new Rt(t),this.biomeGen=new Bo(t)}generateChunk(e,t){const i=ve(e,t);if(this.chunks.has(i))return this.chunks.get(i);const s=[],a=[],o=[],n=e*I+I/2,l=t*I+I/2,c=this.biomeGen.getBiome(n,l);for(let h=0;h<I;h++){s[h]=[],a[h]=[],o[h]=[];for(let u=0;u<I;u++){const m=e*I+u,g=t*I+h;s[h][u]=this.biomeGen.getTile(m,g),this.rng.setSeed(m,g),Bs[s[h][u]].solid?a[h][u]=z.None:a[h][u]=this.biomeGen.getObject(m,g,this.rng),o[h][u]=0}}const d={cx:e,cy:t,tiles:s,objects:a,corruption:o,biome:c,dirty:!1};return this.chunks.set(i,d),d}renderChunk(e){const t=this.scene.add.container(0,0);for(let i=0;i<I;i++)for(let s=0;s<I;s++){const a=e.cx*I+s,o=e.cy*I+i,n=se.worldToScreen(a,o),l=e.tiles[i][s],c=Bs[l],d=this.scene.add.image(n.x,n.y,c.texture);d.setDepth(se.getDepth(a,o,0)),t.add(d);const h=e.objects[i][s];if(h!==z.None){const u=$t[h];if(u.texture){const m=this.scene.add.image(n.x,n.y,u.texture);m.setOrigin(.5,1),m.setScale(u.scale),m.setDepth(se.getDepth(a,o,1)),t.add(m)}}}return t}loadChunk(e,t){const i=ve(e,t);if(this.loadedChunks.has(i))return;const s=this.generateChunk(e,t),a=this.renderChunk(s);this.chunkContainers.set(i,a),this.loadedChunks.add(i)}unloadChunk(e,t){const i=ve(e,t),s=this.chunkContainers.get(i);s&&(s.destroy(!0),this.chunkContainers.delete(i)),this.loadedChunks.delete(i)}update(e,t){const i=e/(qi/2),s=t/(Bi/2),a=Math.floor(i/I),o=Math.floor(s/I);if(a===this.lastCamCX&&o===this.lastCamCY)return;this.lastCamCX=a,this.lastCamCY=o;const n=new Set,l=pr;for(let c=-l;c<=l;c++)for(let d=-l;d<=l;d++)n.add(ve(a+d,o+c));for(const c of this.loadedChunks)if(!n.has(c)){const[d,h]=c.split(",");this.unloadChunk(parseInt(d),parseInt(h))}for(const c of n)if(!this.loadedChunks.has(c)){const[d,h]=c.split(",");this.loadChunk(parseInt(d),parseInt(h))}}getChunkData(e,t){return this.generateChunk(e,t)}getTileAt(e,t){const{cx:i,cy:s}=se.tileToChunk(e,t,I),a=this.generateChunk(i,s),o=(e%I+I)%I,n=(t%I+I)%I;return a.tiles[n][o]}getBiomeAt(e,t){return this.biomeGen.getBiome(e,t)}getCorruptionAt(e,t){const{cx:i,cy:s}=se.tileToChunk(e,t,I),a=ve(i,s),o=this.chunks.get(a);if(!o)return 0;const n=(e%I+I)%I,l=(t%I+I)%I;return o.corruption[l][n]}getObjectAt(e,t){const{cx:i,cy:s}=se.tileToChunk(e,t,I),a=this.generateChunk(i,s),o=(e%I+I)%I,n=(t%I+I)%I;return a.objects[n][o]}setObjectAt(e,t,i){const{cx:s,cy:a}=se.tileToChunk(e,t,I),o=ve(s,a),n=this.chunks.get(o);if(!n)return;const l=(e%I+I)%I,c=(t%I+I)%I;n.objects[c][l]=i,n.dirty=!0}setTileAt(e,t,i){const{cx:s,cy:a}=se.tileToChunk(e,t,I),o=ve(s,a),n=this.chunks.get(o);if(!n)return;const l=(e%I+I)%I,c=(t%I+I)%I;n.tiles[c][l]=i,n.dirty=!0}rerenderChunk(e,t){const i=ve(e,t),s=this.chunkContainers.get(i);s&&(s.destroy(!0),this.chunkContainers.delete(i));const a=this.chunks.get(i);if(a&&this.loadedChunks.has(i)){const o=this.renderChunk(a);this.chunkContainers.set(i,o)}}rerenderChunkAt(e,t){const{cx:i,cy:s}=se.tileToChunk(e,t,I);this.rerenderChunk(i,s)}setCorruptionAt(e,t,i){const{cx:s,cy:a}=se.tileToChunk(e,t,I),o=ve(s,a),n=this.chunks.get(o);if(!n)return;const l=(e%I+I)%I,c=(t%I+I)%I;n.corruption[c][l]=Math.max(0,Math.min(1,i)),n.dirty=!0}getActiveChunkKeys(){return Array.from(this.loadedChunks)}destroy(){for(const e of this.chunkContainers.values())e.destroy(!0);this.chunkContainers.clear(),this.chunks.clear(),this.loadedChunks.clear()}}const f=J({x:R.f32,y:R.f32}),b=J({vx:R.f32,vy:R.f32}),V=J({textureId:R.ui16,frame:R.ui16,flipX:R.ui8,scaleX:R.f32,scaleY:R.f32,visible:R.ui8}),S=J({current:R.f32,max:R.f32}),W=J({current:R.f32,max:R.f32,regenRate:R.f32});var ae=(r=>(r[r.None=0]="None",r[r.Poison=1]="Poison",r[r.Burn=2]="Burn",r[r.Freeze=3]="Freeze",r[r.Bleed=4]="Bleed",r[r.Stun=5]="Stun",r))(ae||{});const T=J({damage:R.f32,defense:R.f32,critChance:R.f32,critMult:R.f32,attackSpeed:R.f32,attackCooldown:R.f32,weaponType:R.ui8,level:R.ui16,xp:R.ui32,synergyStatus:R.ui8,synergyMult:R.f32}),ot=J(),oe=J(),zo=J(),Oa=J(),Ho=J();J();const v=J({state:R.ui8,behavior:R.ui8,aggroRadius:R.f32,targetEid:R.eid,homeX:R.f32,homeY:R.f32,patrolRadius:R.f32,lastAttackTime:R.f32,telegraphTimer:R.f32,telegraphDuration:R.f32}),ee=J({radius:R.f32,solid:R.ui8}),Oo=J({weapon:R.ui16,shield:R.ui16,head:R.ui16,chest:R.ui16,legs:R.ui16,feet:R.ui16,hands:R.ui16,ring1:R.ui16,ring2:R.ui16,necklace:R.ui16}),Lo=J({slots:[R.ui16,36],counts:[R.ui8,36]}),Wo=J({exposure:R.f32,resistance:R.f32});J({id:R.ui8});J({itemId:R.ui16,quantity:R.ui8,rarity:R.ui8,despawnTimer:R.f32});J({ownerEid:R.eid,damage:R.f32,speed:R.f32,lifetime:R.f32,piercing:R.ui8});const _e=J({currentAnim:R.ui16,frameTimer:R.f32,frameIndex:R.ui8,loop:R.ui8});var p=(r=>(r[r.Unarmed=0]="Unarmed",r[r.Sword=1]="Sword",r[r.Axe=2]="Axe",r[r.Spear=3]="Spear",r[r.Bow=4]="Bow",r[r.Staff=5]="Staff",r[r.Dagger=6]="Dagger",r[r.Hammer=7]="Hammer",r))(p||{});const B=J({poison:R.f32,burn:R.f32,freeze:R.f32,bleed:R.f32,stun:R.f32,poisonDmg:R.f32,burnDmg:R.f32,bleedDmg:R.f32}),K=J({affix1:R.ui8,affix2:R.ui8,shieldHits:R.ui8,speedMult:R.f32,lootBonus:R.ui8});var C=(r=>(r[r.Wander=0]="Wander",r[r.Chase=1]="Chase",r[r.Swoop=2]="Swoop",r[r.Ranged=3]="Ranged",r[r.Ambush=4]="Ambush",r[r.Support=5]="Support",r[r.Phase=6]="Phase",r[r.Pack=7]="Pack",r[r.Stationary=8]="Stationary",r))(C||{}),M=(r=>(r[r.Idle=0]="Idle",r[r.Patrol=1]="Patrol",r[r.Chase=2]="Chase",r[r.Attack=3]="Attack",r[r.Flee=4]="Flee",r[r.Special=5]="Special",r[r.Dead=6]="Dead",r))(M||{});const E=Ao(),Wi=[],gi=new Map;function hi(r){if(gi.has(r))return gi.get(r);const e=Wi.length;return Wi.push(r),gi.set(r,e),e}function jt(r){return Wi[r]??"player"}function ms(r,e){const t=ci(E);return N(E,f,t),N(E,b,t),N(E,V,t),N(E,S,t),N(E,W,t),N(E,T,t),N(E,ot,t),N(E,ee,t),N(E,Oo,t),N(E,Lo,t),N(E,Wo,t),N(E,_e,t),N(E,B,t),f.x[t]=r,f.y[t]=e,V.textureId[t]=hi("player"),V.visible[t]=1,V.scaleX[t]=1,V.scaleY[t]=1,S.current[t]=wt,S.max[t]=wt,W.current[t]=vt,W.max[t]=vt,W.regenRate[t]=fr,T.damage[t]=10,T.defense[t]=5,T.critChance[t]=wr,T.critMult[t]=vr,T.attackSpeed[t]=1,T.level[t]=1,ee.radius[t]=8,ee.solid[t]=1,t}function Ve(r,e,t,i,s,a=120,o="enemy",n=C.Wander,l=[0,0]){const c=ci(E);return N(E,f,c),N(E,b,c),N(E,V,c),N(E,S,c),N(E,T,c),N(E,oe,c),N(E,v,c),N(E,ee,c),N(E,_e,c),N(E,B,c),N(E,K,c),f.x[c]=r,f.y[c]=e,V.textureId[c]=hi(o),V.visible[c]=1,V.scaleX[c]=1,V.scaleY[c]=1,S.current[c]=t,S.max[c]=t,T.damage[c]=i,T.defense[c]=s,T.critChance[c]=.03,T.critMult[c]=1.3,T.attackSpeed[c]=1,v.state[c]=M.Idle,v.behavior[c]=n,v.aggroRadius[c]=a,v.homeX[c]=r,v.homeY[c]=e,v.patrolRadius[c]=80,ee.radius[c]=8,ee.solid[c]=1,K.affix1[c]=l[0],K.affix2[c]=l[1],K.shieldHits[c]=0,K.speedMult[c]=1,K.lootBonus[c]=0,c}function No(r,e,t="npc"){const i=ci(E);return N(E,f,i),N(E,b,i),N(E,V,i),N(E,S,i),N(E,zo,i),N(E,v,i),N(E,ee,i),N(E,_e,i),f.x[i]=r,f.y[i]=e,V.textureId[i]=hi(t),V.visible[i]=1,V.scaleX[i]=1,V.scaleY[i]=1,S.current[i]=100,S.max[i]=100,v.state[i]=M.Idle,v.aggroRadius[i]=0,v.homeX[i]=r,v.homeY[i]=e,v.patrolRadius[i]=40,ee.radius[i]=8,ee.solid[i]=1,i}function La(r,e,t,i,s,a,o="projectile"){const n=ci(E);return N(E,f,n),N(E,b,n),N(E,V,n),N(E,Oa,n),N(E,ee,n),f.x[n]=r,f.y[n]=e,b.vx[n]=t,b.vy[n]=i,V.textureId[n]=hi(o),V.visible[n]=1,V.scaleX[n]=1,V.scaleY[n]=1,ee.radius[n]=4,ee.solid[n]=0,N(E,T,n),T.damage[n]=s,n}const Qo=ne([f,b]);function ps(r,e){const t=Qo(r);for(const i of t)f.x[i]+=b.vx[i]*e,f.y[i]+=b.vy[i]*e}const Go=ne([_e,V]);function Wa(r,e){const t=Go(r),i=.15;for(const s of t)_e.frameTimer[s]+=e,_e.frameTimer[s]>=i&&(_e.frameTimer[s]-=i,_e.frameIndex[s]=(_e.frameIndex[s]+1)%4,V.frame[s]=_e.frameIndex[s]),b.vx[s]<0?V.flipX[s]=1:b.vx[s]>0&&(V.flipX[s]=0)}const Uo=ne([f,b,v,oe]),$o=ne([f,ot]),jo=ne([f,S,oe]);function De(r){const e=.3+Math.random()*.5;v.telegraphTimer[r]=e,v.telegraphDuration[r]=e}function Ee(r,e){return v.telegraphTimer[r]<=0?!1:(v.telegraphTimer[r]-=e,v.telegraphTimer[r]<=0?(v.telegraphTimer[r]=0,!1):!0)}const Fs=new Map;function nt(r){let e=Fs.get(r);return e||(e={swoopPhase:0,swoopAngle:Math.random()*Math.PI*2,rangedCooldown:0,ambushRevealed:!1,phaseCooldown:3,packSpawned:!1,supportHealCooldown:0},Fs.set(r,e)),e}function Na(r,e,t=1){const i=Uo(r),s=$o(r);if(s.length===0)return;const a=s[0],o=f.x[a],n=f.y[a];for(const l of i){if(S.current[l]<=0){v.state[l]=M.Dead,b.vx[l]=0,b.vy[l]=0;continue}if(U(r,B,l)&&B.stun[l]>0){b.vx[l]=0,b.vy[l]=0;continue}const c=f.x[l],d=f.y[l],h=o-c,u=n-d,m=Math.sqrt(h*h+u*u),g=v.aggroRadius[l]*t,y=v.homeX[l],_=v.homeY[l],w=v.patrolRadius[l],k=Math.sqrt((c-y)**2+(d-_)**2),F=v.behavior[l],A=60*(U(r,K,l)?K.speedMult[l]:1);switch(F){case C.Chase:Yo(l,h,u,m,g,k,w,A,e);break;case C.Swoop:Xo(l,r,o,n,c,d,m,g,k,w,A,e);break;case C.Ranged:Ko(l,r,o,n,c,d,h,u,m,g,k,w,A,e);break;case C.Ambush:Jo(l,r,h,u,m,g,k,w,A,e);break;case C.Support:Zo(l,r,h,u,m,g,k,w,A,e);break;case C.Phase:en(l,r,o,n,h,u,m,g,k,w,A,e);break;case C.Pack:tn(l,r,o,n,h,u,m,g,k,w,A,e);break;case C.Stationary:sn(l,m,e);break;case C.Wander:default:Vo(l,r,h,u,m,g,y,_,k,w,A,e,a);break}}}function Vo(r,e,t,i,s,a,o,n,l,c,d,h,u){const m=f.x[r],g=f.y[r];switch(v.state[r]){case M.Idle:{if(b.vx[r]=0,b.vy[r]=0,s<a){v.state[r]=M.Chase,v.targetEid[r]=u;break}Math.random()<.005&&(v.state[r]=M.Patrol);break}case M.Patrol:{const y=Math.random()*Math.PI*2,_=o+Math.cos(y)*c*.5,w=n+Math.sin(y)*c*.5,k=_-m,F=w-g,H=Math.sqrt(k*k+F*F);H>4?(b.vx[r]=k/H*d*.5,b.vy[r]=F/H*d*.5):v.state[r]=M.Idle,s<a&&(v.state[r]=M.Chase,v.targetEid[r]=u),l>c&&(v.state[r]=M.Idle);break}case M.Chase:{s>2&&(b.vx[r]=t/s*d,b.vy[r]=i/s*d),s<20&&(v.state[r]=M.Attack,De(r)),(s>a*1.5||l>c*3)&&(v.state[r]=M.Idle,b.vx[r]=0,b.vy[r]=0);break}case M.Attack:{b.vx[r]=0,b.vy[r]=0,Ee(r,h)||(v.lastAttackTime[r]+=h),s>24&&(v.state[r]=M.Chase,v.telegraphTimer[r]=0),S.current[r]<S.max[r]*.15&&U(e,T,r)&&T.level[r]<10&&(v.state[r]=M.Flee,v.telegraphTimer[r]=0);break}case M.Flee:{s>0&&(b.vx[r]=-(t/s)*d*1.2,b.vy[r]=-(i/s)*d*1.2),s>a*2&&(v.state[r]=M.Idle);break}case M.Dead:{b.vx[r]=0,b.vy[r]=0;break}}}function Yo(r,e,t,i,s,a,o,n,l){const c=n*1.5;switch(v.state[r]){case M.Idle:case M.Patrol:{b.vx[r]=0,b.vy[r]=0,i<s&&(v.state[r]=M.Chase);break}case M.Chase:{i>2&&(b.vx[r]=e/i*c,b.vy[r]=t/i*c),i<20&&(v.state[r]=M.Attack,De(r)),a>o*5&&(v.state[r]=M.Idle,b.vx[r]=0,b.vy[r]=0);break}case M.Attack:{b.vx[r]=0,b.vy[r]=0,Ee(r,l)||(v.lastAttackTime[r]+=l),i>24&&(v.state[r]=M.Chase,v.telegraphTimer[r]=0);break}case M.Dead:{b.vx[r]=0,b.vy[r]=0;break}}}function Xo(r,e,t,i,s,a,o,n,l,c,d,h){const u=nt(r),m=n*.7;switch(v.state[r]){case M.Idle:case M.Patrol:{o<n*2?(v.state[r]=M.Chase,u.swoopPhase=0):(b.vx[r]=0,b.vy[r]=0);break}case M.Chase:{if(u.swoopPhase===0){u.swoopAngle+=h*1.5;const g=t+Math.cos(u.swoopAngle)*m,y=i+Math.sin(u.swoopAngle)*m,_=g-s,w=y-a,k=Math.sqrt(_*_+w*w);k>2&&(b.vx[r]=_/k*d,b.vy[r]=w/k*d),v.lastAttackTime[r]+=h,v.lastAttackTime[r]>2&&(u.swoopPhase=1,v.lastAttackTime[r]=0)}else if(u.swoopPhase===1){const g=d*3,y=t-s,_=i-a,w=Math.sqrt(y*y+_*_);w>2&&(b.vx[r]=y/w*g,b.vy[r]=_/w*g),o<20&&(v.state[r]=M.Attack,De(r),u.swoopPhase=2)}break}case M.Attack:{b.vx[r]=0,b.vy[r]=0,Ee(r,h)||(v.lastAttackTime[r]+=h),v.lastAttackTime[r]>.3&&(v.state[r]=M.Flee,v.lastAttackTime[r]=0,v.telegraphTimer[r]=0,u.swoopPhase=2);break}case M.Flee:{const g=t-s,y=i-a;o>0&&(b.vx[r]=-(g/o)*d*1.5,b.vy[r]=-(y/o)*d*1.5),o>m*.9&&(v.state[r]=M.Chase,u.swoopPhase=0),l>c*3&&(v.state[r]=M.Idle);break}case M.Dead:{b.vx[r]=0,b.vy[r]=0;break}}}function Ko(r,e,t,i,s,a,o,n,l,c,d,h,u,m){const g=nt(r),y=80,_=120;switch(v.state[r]){case M.Idle:case M.Patrol:{b.vx[r]=0,b.vy[r]=0,l<c&&(v.state[r]=M.Chase);break}case M.Chase:{l<y&&l>0?(b.vx[r]=-(o/l)*u,b.vy[r]=-(n/l)*u):l>_?(b.vx[r]=o/l*u,b.vy[r]=n/l*u):(b.vx[r]=0,b.vy[r]=0,v.state[r]=M.Attack,De(r)),(l>c*1.5||d>h*3)&&(v.state[r]=M.Idle,b.vx[r]=0,b.vy[r]=0);break}case M.Attack:{if(l<y&&l>0)b.vx[r]=-(o/l)*u*.6,b.vy[r]=-(n/l)*u*.6;else if(l>_){v.state[r]=M.Chase,v.telegraphTimer[r]=0;break}else b.vx[r]=0,b.vy[r]=0;if(Ee(r,m))break;if(g.rangedCooldown-=m,g.rangedCooldown<=0&&l>0){g.rangedCooldown=2;const w=200,k=o/l*w,F=n/l*w,H=U(e,T,r)?T.damage[r]:10;La(s,a,k,F,H,r,"projectile_enemy")}l>c*1.5&&(v.state[r]=M.Idle);break}case M.Flee:{l>0&&(b.vx[r]=-(o/l)*u*1.2,b.vy[r]=-(n/l)*u*1.2),l>c*2&&(v.state[r]=M.Idle);break}case M.Dead:{b.vx[r]=0,b.vy[r]=0;break}}}function Jo(r,e,t,i,s,a,o,n,l,c){const d=nt(r),h=a*.5;if(!d.ambushRevealed){U(e,V,r),b.vx[r]=0,b.vy[r]=0,s<h&&(d.ambushRevealed=!0,U(e,T,r)&&(T.damage[r]*=2),v.state[r]=M.Chase);return}switch(v.state[r]){case M.Chase:{const u=l*1.5;s>2&&(b.vx[r]=t/s*u,b.vy[r]=i/s*u),s<20&&(v.state[r]=M.Attack,De(r)),(s>a*2||o>n*3)&&(v.state[r]=M.Idle,b.vx[r]=0,b.vy[r]=0);break}case M.Attack:{b.vx[r]=0,b.vy[r]=0,Ee(r,c)||(v.lastAttackTime[r]+=c),v.lastAttackTime[r]>.5&&T.damage[r]>0,s>24&&(v.state[r]=M.Chase,v.telegraphTimer[r]=0),S.current[r]<S.max[r]*.2&&(v.state[r]=M.Flee,v.telegraphTimer[r]=0);break}case M.Flee:{s>0&&(b.vx[r]=-(t/s)*l*1.2,b.vy[r]=-(i/s)*l*1.2),s>a*2&&(v.state[r]=M.Idle);break}default:{s<a?v.state[r]=M.Chase:(b.vx[r]=0,b.vy[r]=0);break}}}function Zo(r,e,t,i,s,a,o,n,l,c,d){nt(r);const h=f.x[r],u=f.y[r],m=jo(e);let g=-1,y=1;for(const _ of m){if(_===r||S.current[_]<=0)continue;const w=f.x[_]-h,k=f.y[_]-u;if(Math.sqrt(w*w+k*k)>120)continue;const H=S.current[_]/S.max[_];H<y&&(y=H,g=_)}if(g>=0&&y<.95){const _=f.x[g]-h,w=f.y[g]-u,k=Math.sqrt(_*_+w*w);if(k>16)b.vx[r]=_/k*l,b.vy[r]=w/k*l;else{b.vx[r]=0,b.vy[r]=0;const F=S.max[g]*.05*c;S.current[g]=Math.min(S.max[g],S.current[g]+F)}v.state[r]=M.Special}else{switch(v.state[r]=M.Idle,v.state[r]){case M.Idle:{b.vx[r]=0,b.vy[r]=0,s<a&&(v.state[r]=M.Chase);break}}s<40&&s>0&&(b.vx[r]=-(t/s)*l,b.vy[r]=-(i/s)*l)}}function en(r,e,t,i,s,a,o,n,l,c,d,h){const u=nt(r);switch(v.state[r]){case M.Idle:case M.Patrol:{b.vx[r]=0,b.vy[r]=0,o<n&&(v.state[r]=M.Chase);break}case M.Chase:case M.Attack:{if(U(e,ee,r)&&(ee.solid[r]=0),u.phaseCooldown-=h,u.phaseCooldown<=0){u.phaseCooldown=3;const m=Math.random()*Math.PI*2,g=30+Math.random()*30;f.x[r]=t+Math.cos(m)*g,f.y[r]=i+Math.sin(m)*g}o>20?(b.vx[r]=s/o*d,b.vy[r]=a/o*d):(v.state[r]!==M.Attack&&(v.state[r]=M.Attack,De(r)),b.vx[r]=0,b.vy[r]=0,Ee(r,h)||(v.lastAttackTime[r]+=h)),o>n*2&&(v.state[r]=M.Idle,U(e,ee,r)&&(ee.solid[r]=1));break}case M.Dead:{b.vx[r]=0,b.vy[r]=0;break}}}function tn(r,e,t,i,s,a,o,n,l,c,d,h,u){const m=nt(r),g=f.x[r],y=f.y[r];switch(v.state[r]){case M.Idle:case M.Patrol:{if(b.vx[r]=0,b.vy[r]=0,o<n&&(v.state[r]=M.Chase,!m.packSpawned)){m.packSpawned=!0;const _=1+Math.floor(Math.random()*2);for(let w=0;w<_;w++){const k=Math.random()*Math.PI*2,F=30+Math.random()*40,H=g+Math.cos(k)*F,A=y+Math.sin(k)*F,G=Math.round(S.max[r]*.6),Y=Math.round(T.damage[r]*.6),te=Math.round(T.defense[r]*.5);Ve(H,A,G,Y,te,n,"enemy",C.Chase)}}break}case M.Chase:{const _=t+s/(o||1)*30,w=i+a/(o||1)*30,k=_-g,F=w-y,H=Math.sqrt(k*k+F*F);H>2&&(b.vx[r]=k/H*d,b.vy[r]=F/H*d),o<20&&(v.state[r]=M.Attack,De(r)),(o>n*2||l>c*3)&&(v.state[r]=M.Idle,b.vx[r]=0,b.vy[r]=0);break}case M.Attack:{b.vx[r]=0,b.vy[r]=0,Ee(r,h)||(v.lastAttackTime[r]+=h),o>24&&(v.state[r]=M.Chase,v.telegraphTimer[r]=0);break}case M.Flee:{o>0&&(b.vx[r]=-(s/o)*d*1.2,b.vy[r]=-(a/o)*d*1.2),o>n*2&&(v.state[r]=M.Idle);break}case M.Dead:{b.vx[r]=0,b.vy[r]=0;break}}}function sn(r,e,t){b.vx[r]=0,b.vy[r]=0,e<24?(v.state[r]!==M.Attack&&(v.state[r]=M.Attack,De(r)),Ee(r,t)||(v.lastAttackTime[r]+=t)):(v.state[r]=M.Idle,v.telegraphTimer[r]=0)}var ce=(r=>(r[r.None=0]="None",r[r.Frenzied=1]="Frenzied",r[r.Shielded=2]="Shielded",r[r.Venomous=3]="Venomous",r[r.Blazing=4]="Blazing",r[r.Teleporting=5]="Teleporting",r[r.Vampiric=6]="Vampiric",r[r.Thorned=7]="Thorned",r[r.Corrupting=8]="Corrupting",r[r.Volatile=9]="Volatile",r[r.Armored=10]="Armored",r[r.Swift=11]="Swift",r[r.Berserker=12]="Berserker",r))(ce||{});const ai={1:{id:1,name:"Frenzied",description:"Attacks 40% faster",hpMult:1,dmgMult:1,speedMult:1,defenseMult:1,specialEffect:"none",tint:16729156,lootRarityBonus:1},2:{id:2,name:"Shielded",description:"Absorbs first 3 hits",hpMult:1.2,dmgMult:1,speedMult:1,defenseMult:1.5,specialEffect:"shield",tint:4491519,lootRarityBonus:1},3:{id:3,name:"Venomous",description:"Attacks inflict poison",hpMult:1.1,dmgMult:.9,speedMult:1,defenseMult:1,specialEffect:"none",tint:4521796,lootRarityBonus:1},4:{id:4,name:"Blazing",description:"Attacks inflict burn",hpMult:1.1,dmgMult:.9,speedMult:1,defenseMult:1,specialEffect:"none",tint:16746496,lootRarityBonus:1},5:{id:5,name:"Teleporting",description:"Blinks behind target",hpMult:.9,dmgMult:1.2,speedMult:1,defenseMult:.8,specialEffect:"teleport",tint:13387007,lootRarityBonus:2},6:{id:6,name:"Vampiric",description:"Heals on hit",hpMult:1,dmgMult:1,speedMult:1,defenseMult:1,specialEffect:"life_steal",tint:16711782,lootRarityBonus:1},7:{id:7,name:"Thorned",description:"Reflects 20% damage",hpMult:1.3,dmgMult:.8,speedMult:1,defenseMult:1,specialEffect:"thorns",tint:8947780,lootRarityBonus:1},8:{id:8,name:"Corrupting",description:"Aura increases corruption",hpMult:1.2,dmgMult:1,speedMult:1,defenseMult:1,specialEffect:"corruption_aura",tint:10027212,lootRarityBonus:2},9:{id:9,name:"Volatile",description:"Explodes on death",hpMult:.8,dmgMult:1,speedMult:1.1,defenseMult:.8,specialEffect:"explode_on_death",tint:16763904,lootRarityBonus:1},10:{id:10,name:"Armored",description:"+50% HP, +50% defense",hpMult:1.5,dmgMult:1,speedMult:.9,defenseMult:1.5,specialEffect:"none",tint:8947848,lootRarityBonus:1},11:{id:11,name:"Swift",description:"+40% movement speed",hpMult:.9,dmgMult:1,speedMult:1.4,defenseMult:.9,specialEffect:"none",tint:52479,lootRarityBonus:1},12:{id:12,name:"Berserker",description:"+50% damage, -20% defense",hpMult:1,dmgMult:1.5,speedMult:1.1,defenseMult:.8,specialEffect:"none",tint:16720384,lootRarityBonus:2}},Bt=Object.keys(ai).map(Number);function an(r,e=.15){if(r.next()>e)return[0,0];const t=Bt[Math.floor(r.next()*Bt.length)];if(r.next()<.3){let i=Bt[Math.floor(r.next()*Bt.length)];return i===t&&(i=0),[t,i]}return[t,0]}const rn=ne([f,S,T,ee]),on=ne([f,S,B]),We=new Map;function nn(r,e){We.set(r,Math.max(We.get(r)??0,e))}let Ni=null;function ln(r){Ni=r}function cn(r){const e=b.vx[r],t=b.vy[r];if(Math.abs(e)<.01&&Math.abs(t)<.01)return zs.get(r)??0;const i=Math.atan2(t,e);return zs.set(r,i),i}const zs=new Map;function dn(r,e){const t=cn(e),i=f.x[r]-f.x[e],s=f.y[r]-f.y[e],a=Math.atan2(s,i),o=t+Math.PI;let n=a-o;for(;n>Math.PI;)n-=Math.PI*2;for(;n<-Math.PI;)n+=Math.PI*2;return Math.abs(n)<Math.PI/3}const Qi=[];let gt=!1;function hn(){gt=!0}function gs(){const r=[...Qi];return Qi.length=0,r}const Gi=[];function un(){const r=[...Gi];return Gi.length=0,r}let fi=!1,Ui=0;function Hs(r){Ui=r}const It=new Map,Os=2;function mn(r){for(const[e,t]of It)t.timer-=r,t.timer<=0&&It.delete(e)}function pn(r,e){let t=It.get(r);return t||(t={count:0,timer:Os,lastTargetEid:e},It.set(r,t)),t.count++,t.timer=Os,t.lastTargetEid=e,t.count}function gn(r,e){const t=on(r);for(const i of t)if(!(S.current[i]<=0)){if(B.poison[i]>0&&(B.poison[i]-=e,B.poisonDmg[i]>0&&(S.current[i]-=B.poisonDmg[i]*e),B.poison[i]<=0&&(B.poison[i]=0,B.poisonDmg[i]=0)),B.burn[i]>0){if(B.burn[i]-=e,B.burnDmg[i]>0&&(S.current[i]-=B.burnDmg[i]*e),Math.random()<.1*e)for(const s of t){if(s===i||B.burn[s]>0)continue;const a=f.x[s]-f.x[i],o=f.y[s]-f.y[i];if(Math.sqrt(a*a+o*o)<=40){B.burn[s]=B.burn[i]*.5,B.burnDmg[s]=B.burnDmg[i];break}}B.burn[i]<=0&&(B.burn[i]=0,B.burnDmg[i]=0)}B.freeze[i]>0&&(B.freeze[i]-=e,U(r,b,i)&&(b.vx[i]*=.5,b.vy[i]*=.5),B.freeze[i]<=0&&(B.freeze[i]=0,B.stun[i]<=0&&(B.stun[i]=.3))),B.bleed[i]>0&&(B.bleed[i]-=e,U(r,b,i)&&Math.abs(b.vx[i])+Math.abs(b.vy[i])>.1&&(S.current[i]-=B.bleedDmg[i]*e),B.bleed[i]<=0&&(B.bleed[i]=0,B.bleedDmg[i]=0)),B.stun[i]>0&&(B.stun[i]-=e,U(r,b,i)&&(b.vx[i]=0,b.vy[i]=0),B.stun[i]<=0&&(B.stun[i]=0))}}function fs(r,e){const t=rn(r);mn(e),gn(r,e);for(const[i,s]of We){const a=s-e*1e3;a<=0?We.delete(i):We.set(i,a)}for(let i=0;i<t.length;i++){const s=t[i];if(S.current[s]<=0||U(r,B,s)&&B.stun[s]>0||U(r,oe,s)&&U(r,v,s)&&v.telegraphTimer[s]>0)continue;if(T.attackCooldown[s]>0){T.attackCooldown[s]-=e;continue}const a=U(r,ot,s),o=U(r,oe,s);if(!(a&&!gt))for(let n=0;n<t.length;n++){if(i===n)continue;const l=t[n];if(S.current[l]<=0||We.has(l))continue;const c=U(r,ot,l),d=U(r,oe,l);if(!(a&&d)&&!(o&&c))continue;const h=f.x[l]-f.x[s],u=f.y[l]-f.y[s],m=Math.sqrt(h*h+u*u),g=ee.radius[s]+ee.radius[l]+16;if(m>g)continue;if(a&&d&&U(r,v,l)&&v.telegraphTimer[l]>0){v.telegraphTimer[l]=0,v.state[l]=M.Idle;let ie=.8;const X=Ui>=5;X&&(ie=1.5,fi=!0),Ui>=15&&(ie=2),U(r,B,l)&&(B.stun[l]=Math.max(B.stun[l],ie)),Gi.push({playerEid:s,enemyEid:l,x:f.x[l],y:f.y[l],isRiposte:X}),T.attackCooldown[s]=.15,gt=!1;break}let y=1;a&&fi&&(fi=!1,y=2);const _=a&&dn(s,l),w=_?1.5:1,k=Ni?Ni(s,l):1,H=a&&y>1||Math.random()<T.critChance[s],A=H?T.critMult[s]*y:1;let G=T.damage[s]*A*w*k;const Y=T.synergyStatus[s];Y!==ae.None&&U(r,B,l)&&(Y===ae.Poison&&B.poison[l]>0||Y===ae.Burn&&B.burn[l]>0||Y===ae.Freeze&&B.freeze[l]>0||Y===ae.Bleed&&B.bleed[l]>0||Y===ae.Stun&&B.stun[l]>0)&&(G*=T.synergyMult[s]);let te=Math.max(1,G-T.defense[l]);if(U(r,K,l)&&K.shieldHits[l]>0&&(K.shieldHits[l]--,te=Math.max(1,Math.round(te*.2))),S.current[l]-=te,T.attackCooldown[s]=1/T.attackSpeed[s],We.set(l,br),U(r,K,s)){const ie=K.affix1[s],X=K.affix2[s];(ie===ce.Vampiric||X===ce.Vampiric)&&(S.current[s]=Math.min(S.max[s],S.current[s]+te*.25)),(ie===ce.Venomous||X===ce.Venomous)&&U(r,B,l)&&(B.poison[l]=Math.max(B.poison[l],4),B.poisonDmg[l]=Math.max(B.poisonDmg[l],T.damage[s]*.15)),(ie===ce.Blazing||X===ce.Blazing)&&U(r,B,l)&&(B.burn[l]=Math.max(B.burn[l],3),B.burnDmg[l]=Math.max(B.burnDmg[l],T.damage[s]*.2))}if(U(r,K,l)){const ie=K.affix1[l],X=K.affix2[l];(ie===ce.Thorned||X===ce.Thorned)&&(S.current[s]-=Math.round(te*.2))}const de=pn(s,l);if(m>0){const ie=1+Math.min(te/20,1.5),X=1+Math.min(de*.1,.5),qe=_r*ie*X,re=h/m*qe,Ye=u/m*qe;b.vx[l]+=re,b.vy[l]+=Ye}if(Qi.push({targetEid:l,attackerEid:s,damage:te,isCrit:H,x:f.x[l],y:f.y[l],comboCount:de,isBackstab:_}),a){gt=!1;break}}}gt=!1}const fn=ne([f,b,Oa]),yn=ne([f,S,ee]),bn=3,Ft=new Map;function Qa(r,e){const t=fn(r),i=yn(r);for(const s of t){const a=(Ft.get(s)??0)+e;if(Ft.set(s,a),a>bn){Ft.delete(s),ii(r,s);continue}const o=f.x[s],n=f.y[s],l=T.damage[s];for(const c of i){if(c===s||S.current[c]<=0)continue;const d=!U(r,oe,s),h=U(r,oe,c),u=U(r,ot,c);if(d&&!h||!d&&!u)continue;const m=f.x[c]-o,g=f.y[c]-n,y=Math.sqrt(m*m+g*g),_=ee.radius[c]+6;if(y<_){S.current[c]-=l,Ft.delete(s),ii(r,s);break}}}}const _n=ne([f,oe]),wn={[Z.Haven]:1,[Z.Rotwood]:3,[Z.Ashlands]:4,[Z.Drowned]:3,[Z.BoneWastes]:5,[Z.TheVoid]:4,[Z.Edilas]:6},vn={[Z.Haven]:{hp:30,dmg:5,def:2},[Z.Rotwood]:{hp:60,dmg:10,def:5},[Z.Ashlands]:{hp:100,dmg:18,def:10},[Z.Drowned]:{hp:140,dmg:25,def:14},[Z.BoneWastes]:{hp:200,dmg:35,def:20},[Z.TheVoid]:{hp:280,dmg:48,def:28},[Z.Edilas]:{hp:400,dmg:65,def:38}},xn={Spring:{densityMult:1.15,hpMult:1,dmgMult:1},Summer:{densityMult:1.3,hpMult:1.1,dmgMult:1.1},Autumn:{densityMult:1,hpMult:1,dmgMult:1},Winter:{densityMult:.7,hpMult:1.3,dmgMult:1.3}},$i=new Set;function Ls(){$i.clear()}function kn(r,e,t,i,s="Autumn"){const a=new Rt(42069),o=Math.floor(e/32),n=Math.floor(t/32),l=Math.floor(o/I),c=Math.floor(n/I),d=xn[s];for(let m=-2;m<=2;m++)for(let g=-2;g<=2;g++){const y=l+g,_=c+m,w=`${y},${_}`;if($i.has(w))continue;$i.add(w);const k=y*I+I/2,F=_*I+I/2,H=i(k,F),A=wn[H],G=vn[H],Y=us[H];a.setSeed(y,_);const te=Math.round(A*d.densityMult),de=a.nextInt(0,te);for(let ie=0;ie<de;ie++){const X=y*I+a.nextInt(1,I-2),qe=_*I+a.nextInt(1,I-2),re=X*32,Ye=qe*32,P=Y.difficultyMult,Q=.1+H*.02,$=an(a,Q);let ye=1,vs=1,xs=1,ks=1,Ss=0;for(const dr of $){const Xe=ai[dr];Xe&&(ye*=Xe.hpMult,vs*=Xe.dmgMult,xs*=Xe.defenseMult,ks*=Xe.speedMult,Ss+=Xe.lootRarityBonus)}const Dt=Ve(re,Ye,Math.round(G.hp*P*d.hpMult*ye),Math.round(G.dmg*P*d.dmgMult*vs),Math.round(G.def*P*xs),120+H*10,"enemy",void 0,$);K.speedMult[Dt]=ks,K.lootBonus[Dt]=Ss,($[0]===ce.Shielded||$[1]===ce.Shielded)&&(K.shieldHits[Dt]=3),($[0]===ce.Frenzied||$[1]===ce.Frenzied)&&(T.attackSpeed[Dt]*=1.4)}}const h=_n(r),u=I*32*4;for(const m of h){if(S.current[m]<=0)continue;const g=f.x[m]-e,y=f.y[m]-t;g*g+y*y>u*u&&(S.current[m]=0)}}const ys=[{id:"forest_slime",name:"Forest Slime",biome:"haven",hp:25,damage:4,defense:1,speed:40,aggroRadius:80,attackSpeed:.8,weaponType:p.Unarmed,xpReward:10,texture:"enemy_slime",lootTable:[{itemId:"slime_gel",chance:.6,minQty:1,maxQty:2}],aiType:"melee",behavior:C.Wander},{id:"shambling_corpse",name:"Shambling Corpse",biome:"haven",hp:35,damage:6,defense:2,speed:30,aggroRadius:70,attackSpeed:.7,weaponType:p.Unarmed,xpReward:12,texture:"enemy_zombie",lootTable:[{itemId:"rotten_flesh",chance:.7,minQty:1,maxQty:2},{itemId:"bone_fragment",chance:.3,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Chase},{id:"crawler",name:"Crawler",biome:"haven",hp:18,damage:5,defense:1,speed:75,aggroRadius:60,attackSpeed:1.2,weaponType:p.Unarmed,xpReward:8,texture:"enemy_crawler",lootTable:[{itemId:"chitin",chance:.5,minQty:1,maxQty:2}],aiType:"swarm",behavior:C.Chase},{id:"plague_rat",name:"Plague Rat",biome:"haven",hp:15,damage:3,defense:1,speed:80,aggroRadius:50,attackSpeed:1.3,weaponType:p.Unarmed,xpReward:6,texture:"enemy_rat",lootTable:[{itemId:"rat_tail",chance:.5,minQty:1,maxQty:1},{itemId:"plague_sample",chance:.1,minQty:1,maxQty:1}],aiType:"swarm",behavior:C.Pack},{id:"lost_soul",name:"Lost Soul",biome:"haven",hp:20,damage:7,defense:0,speed:55,aggroRadius:90,attackSpeed:1,weaponType:p.Unarmed,xpReward:14,texture:"enemy_ghost",lootTable:[{itemId:"ectoplasm",chance:.4,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Phase},{id:"wild_boar",name:"Wild Boar",biome:"haven",hp:40,damage:8,defense:3,speed:70,aggroRadius:100,attackSpeed:1,weaponType:p.Unarmed,xpReward:20,texture:"enemy",lootTable:[{itemId:"raw_meat",chance:.8,minQty:1,maxQty:2},{itemId:"leather",chance:.4,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Chase},{id:"angry_bee",name:"Angry Bee",biome:"haven",hp:12,damage:3,defense:0,speed:90,aggroRadius:60,attackSpeed:1.5,weaponType:p.Unarmed,xpReward:8,texture:"enemy",lootTable:[{itemId:"honey",chance:.3,minQty:1,maxQty:1}],aiType:"swarm",behavior:C.Swoop},{id:"field_rat",name:"Field Rat",biome:"haven",hp:15,damage:3,defense:1,speed:80,aggroRadius:50,attackSpeed:1.2,weaponType:p.Unarmed,xpReward:5,texture:"enemy",lootTable:[{itemId:"rat_tail",chance:.5,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Wander},{id:"garden_spider",name:"Garden Spider",biome:"haven",hp:20,damage:5,defense:1,speed:65,aggroRadius:70,attackSpeed:1,weaponType:p.Unarmed,xpReward:12,texture:"enemy",lootTable:[{itemId:"spider_silk",chance:.5,minQty:1,maxQty:2}],aiType:"melee",behavior:C.Ambush},{id:"scarecrow_mimic",name:"Scarecrow Mimic",biome:"haven",hp:50,damage:10,defense:5,speed:30,aggroRadius:40,attackSpeed:.7,weaponType:p.Unarmed,xpReward:25,texture:"enemy",lootTable:[{itemId:"cloth",chance:.7,minQty:1,maxQty:3},{itemId:"straw",chance:.8,minQty:2,maxQty:4}],aiType:"tank",behavior:C.Ambush},{id:"wild_wolf",name:"Wild Wolf",biome:"haven",hp:35,damage:9,defense:2,speed:85,aggroRadius:120,attackSpeed:1.1,weaponType:p.Unarmed,xpReward:18,texture:"enemy",lootTable:[{itemId:"wolf_pelt",chance:.6,minQty:1,maxQty:1},{itemId:"fang",chance:.3,minQty:1,maxQty:2}],aiType:"melee",behavior:C.Pack},{id:"corpse_spider",name:"Corpse Spider",biome:"rotwood",hp:45,damage:11,defense:4,speed:70,aggroRadius:100,attackSpeed:1.2,weaponType:p.Unarmed,xpReward:28,texture:"enemy_spider",lootTable:[{itemId:"toxic_silk",chance:.5,minQty:1,maxQty:2},{itemId:"venom_sac",chance:.2,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Ambush},{id:"rotting_treant",name:"Rotting Treant",biome:"rotwood",hp:120,damage:18,defense:12,speed:25,aggroRadius:80,attackSpeed:.6,weaponType:p.Unarmed,xpReward:50,texture:"enemy_treant",lootTable:[{itemId:"dark_wood",chance:.8,minQty:2,maxQty:4},{itemId:"treant_heart",chance:.15,minQty:1,maxQty:1}],aiType:"tank",behavior:C.Stationary},{id:"will_o_wisp",name:"Will-o'-Wisp",biome:"rotwood",hp:22,damage:9,defense:0,speed:95,aggroRadius:110,attackSpeed:1.4,weaponType:p.Unarmed,xpReward:24,texture:"enemy_wisp",lootTable:[{itemId:"wisp_light",chance:.4,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Phase},{id:"spore_cloud",name:"Spore Cloud",biome:"rotwood",hp:40,damage:6,defense:2,speed:35,aggroRadius:60,attackSpeed:.8,weaponType:p.Unarmed,xpReward:26,texture:"enemy_spore",lootTable:[{itemId:"fungal_cap",chance:.7,minQty:1,maxQty:3},{itemId:"spore_sac",chance:.3,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Stationary},{id:"rot_spider",name:"Rot Spider",biome:"rotwood",hp:50,damage:12,defense:4,speed:65,aggroRadius:110,attackSpeed:1.2,weaponType:p.Unarmed,xpReward:30,texture:"enemy",lootTable:[{itemId:"toxic_silk",chance:.5,minQty:1,maxQty:2}],aiType:"melee",behavior:C.Ambush},{id:"fungal_crawler",name:"Fungal Crawler",biome:"rotwood",hp:45,damage:10,defense:6,speed:50,aggroRadius:90,attackSpeed:.9,weaponType:p.Unarmed,xpReward:28,texture:"enemy",lootTable:[{itemId:"fungal_cap",chance:.6,minQty:1,maxQty:3}],aiType:"tank",behavior:C.Wander},{id:"poison_moth",name:"Poison Moth",biome:"rotwood",hp:30,damage:8,defense:2,speed:85,aggroRadius:100,attackSpeed:1.3,weaponType:p.Unarmed,xpReward:22,texture:"enemy",lootTable:[{itemId:"moth_dust",chance:.4,minQty:1,maxQty:2}],aiType:"ranged",behavior:C.Swoop},{id:"spore_bat",name:"Spore Bat",biome:"rotwood",hp:25,damage:7,defense:2,speed:95,aggroRadius:100,attackSpeed:1.4,weaponType:p.Unarmed,xpReward:20,texture:"enemy",lootTable:[{itemId:"bat_wing",chance:.5,minQty:1,maxQty:2}],aiType:"swarm",behavior:C.Swoop},{id:"vine_strangler",name:"Vine Strangler",biome:"rotwood",hp:60,damage:14,defense:5,speed:0,aggroRadius:40,attackSpeed:.8,weaponType:p.Unarmed,xpReward:35,texture:"enemy",lootTable:[{itemId:"vine_rope",chance:.7,minQty:1,maxQty:3}],aiType:"melee",behavior:C.Stationary},{id:"mushroom_golem",name:"Mushroom Golem",biome:"rotwood",hp:90,damage:15,defense:10,speed:35,aggroRadius:70,attackSpeed:.7,weaponType:p.Unarmed,xpReward:45,texture:"enemy",lootTable:[{itemId:"golem_spore",chance:.6,minQty:1,maxQty:2}],aiType:"tank",behavior:C.Wander},{id:"corrupted_treant",name:"Corrupted Treant",biome:"rotwood",hp:120,damage:18,defense:12,speed:25,aggroRadius:80,attackSpeed:.6,weaponType:p.Unarmed,xpReward:50,texture:"enemy",lootTable:[{itemId:"dark_wood",chance:.8,minQty:2,maxQty:4},{itemId:"treant_heart",chance:.15,minQty:1,maxQty:1}],aiType:"tank",behavior:C.Stationary},{id:"fire_imp",name:"Fire Imp",biome:"ashlands",hp:70,damage:20,defense:8,speed:80,aggroRadius:130,attackSpeed:1.5,weaponType:p.Staff,xpReward:50,texture:"enemy_imp",lootTable:[{itemId:"fire_essence",chance:.5,minQty:1,maxQty:2}],aiType:"ranged",behavior:C.Ranged},{id:"magma_golem",name:"Magma Golem",biome:"ashlands",hp:200,damage:30,defense:20,speed:20,aggroRadius:100,attackSpeed:.5,weaponType:p.Hammer,xpReward:80,texture:"enemy_golem",lootTable:[{itemId:"magma_core",chance:.3,minQty:1,maxQty:1},{itemId:"volcanic_rock",chance:.7,minQty:2,maxQty:4}],aiType:"tank",behavior:C.Chase},{id:"flame_sprite",name:"Flame Sprite",biome:"ashlands",hp:45,damage:22,defense:3,speed:90,aggroRadius:120,attackSpeed:1.6,weaponType:p.Staff,xpReward:48,texture:"enemy_sprite",lootTable:[{itemId:"ember_shard",chance:.5,minQty:1,maxQty:3},{itemId:"fire_mote",chance:.2,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Ranged},{id:"ember_bat",name:"Ember Bat",biome:"ashlands",hp:35,damage:16,defense:4,speed:100,aggroRadius:110,attackSpeed:1.5,weaponType:p.Unarmed,xpReward:40,texture:"enemy_bat",lootTable:[{itemId:"bat_wing",chance:.5,minQty:1,maxQty:2},{itemId:"ember_shard",chance:.3,minQty:1,maxQty:1}],aiType:"swarm",behavior:C.Swoop},{id:"lava_golem",name:"Lava Golem",biome:"ashlands",hp:200,damage:30,defense:20,speed:20,aggroRadius:100,attackSpeed:.5,weaponType:p.Hammer,xpReward:80,texture:"enemy",lootTable:[{itemId:"magma_core",chance:.3,minQty:1,maxQty:1},{itemId:"volcanic_rock",chance:.7,minQty:2,maxQty:4}],aiType:"tank",behavior:C.Wander},{id:"ash_wraith",name:"Ash Wraith",biome:"ashlands",hp:60,damage:22,defense:5,speed:90,aggroRadius:120,attackSpeed:1.3,weaponType:p.Unarmed,xpReward:55,texture:"enemy",lootTable:[{itemId:"wraith_dust",chance:.5,minQty:1,maxQty:2}],aiType:"assassin",behavior:C.Phase},{id:"magma_beetle",name:"Magma Beetle",biome:"ashlands",hp:80,damage:18,defense:15,speed:45,aggroRadius:90,attackSpeed:1,weaponType:p.Unarmed,xpReward:45,texture:"enemy",lootTable:[{itemId:"beetle_shell",chance:.6,minQty:1,maxQty:2}],aiType:"tank",behavior:C.Wander},{id:"flame_serpent",name:"Flame Serpent",biome:"ashlands",hp:90,damage:25,defense:10,speed:75,aggroRadius:110,attackSpeed:1.2,weaponType:p.Unarmed,xpReward:60,texture:"enemy",lootTable:[{itemId:"serpent_fang",chance:.4,minQty:1,maxQty:2},{itemId:"fire_scale",chance:.3,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Chase},{id:"ember_elemental",name:"Ember Elemental",biome:"ashlands",hp:55,damage:28,defense:3,speed:70,aggroRadius:140,attackSpeed:1.6,weaponType:p.Staff,xpReward:65,texture:"enemy",lootTable:[{itemId:"ember_shard",chance:.5,minQty:1,maxQty:3}],aiType:"ranged",behavior:C.Ranged},{id:"obsidian_knight",name:"Obsidian Knight",biome:"ashlands",hp:150,damage:28,defense:18,speed:50,aggroRadius:100,attackSpeed:.8,weaponType:p.Sword,xpReward:70,texture:"enemy",lootTable:[{itemId:"obsidian_shard",chance:.5,minQty:1,maxQty:2}],aiType:"melee",behavior:C.Chase},{id:"marsh_lurker",name:"Marsh Lurker",biome:"drowned",hp:100,damage:26,defense:10,speed:55,aggroRadius:90,attackSpeed:1,weaponType:p.Unarmed,xpReward:65,texture:"enemy_lurker",lootTable:[{itemId:"swamp_hide",chance:.6,minQty:1,maxQty:2},{itemId:"marsh_moss",chance:.4,minQty:1,maxQty:3}],aiType:"melee",behavior:C.Ambush},{id:"poison_toad",name:"Poison Toad",biome:"drowned",hp:75,damage:18,defense:8,speed:45,aggroRadius:70,attackSpeed:.9,weaponType:p.Unarmed,xpReward:55,texture:"enemy_toad",lootTable:[{itemId:"toad_venom",chance:.5,minQty:1,maxQty:2},{itemId:"toad_skin",chance:.3,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Ranged},{id:"swamp_zombie",name:"Swamp Zombie",biome:"drowned",hp:130,damage:25,defense:14,speed:35,aggroRadius:80,attackSpeed:.7,weaponType:p.Unarmed,xpReward:60,texture:"enemy_zombie",lootTable:[{itemId:"waterlogged_bone",chance:.7,minQty:1,maxQty:3},{itemId:"rotten_flesh",chance:.5,minQty:1,maxQty:2}],aiType:"tank",behavior:C.Chase},{id:"drowned_wraith",name:"Drowned Wraith",biome:"drowned",hp:85,damage:30,defense:6,speed:70,aggroRadius:120,attackSpeed:1.2,weaponType:p.Unarmed,xpReward:72,texture:"enemy_wraith",lootTable:[{itemId:"wraith_dust",chance:.4,minQty:1,maxQty:2},{itemId:"drowned_relic",chance:.1,minQty:1,maxQty:1}],aiType:"assassin",behavior:C.Phase},{id:"drowned_ghoul",name:"Drowned Ghoul",biome:"drowned",hp:120,damage:28,defense:12,speed:50,aggroRadius:100,attackSpeed:.9,weaponType:p.Unarmed,xpReward:70,texture:"enemy",lootTable:[{itemId:"waterlogged_bone",chance:.6,minQty:1,maxQty:3}],aiType:"melee",behavior:C.Chase},{id:"acid_jellyfish",name:"Acid Jellyfish",biome:"drowned",hp:60,damage:20,defense:3,speed:40,aggroRadius:80,attackSpeed:1.2,weaponType:p.Unarmed,xpReward:55,texture:"enemy",lootTable:[{itemId:"acid_gland",chance:.4,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Ranged},{id:"coral_golem",name:"Coral Golem",biome:"drowned",hp:180,damage:32,defense:22,speed:25,aggroRadius:80,attackSpeed:.6,weaponType:p.Hammer,xpReward:85,texture:"enemy",lootTable:[{itemId:"coral_chunk",chance:.7,minQty:2,maxQty:4}],aiType:"tank",behavior:C.Stationary},{id:"deep_lurker",name:"Deep Lurker",biome:"drowned",hp:100,damage:35,defense:8,speed:80,aggroRadius:150,attackSpeed:1.5,weaponType:p.Dagger,xpReward:75,texture:"enemy",lootTable:[{itemId:"lurker_tooth",chance:.5,minQty:1,maxQty:2}],aiType:"assassin",behavior:C.Ambush},{id:"tide_witch",name:"Tide Witch",biome:"drowned",hp:80,damage:30,defense:10,speed:55,aggroRadius:130,attackSpeed:1,weaponType:p.Staff,xpReward:80,texture:"enemy",lootTable:[{itemId:"tide_crystal",chance:.3,minQty:1,maxQty:1}],aiType:"healer",behavior:C.Support},{id:"barnacle_brute",name:"Barnacle Brute",biome:"drowned",hp:160,damage:30,defense:20,speed:30,aggroRadius:90,attackSpeed:.7,weaponType:p.Hammer,xpReward:75,texture:"enemy",lootTable:[{itemId:"barnacle_plate",chance:.6,minQty:1,maxQty:3}],aiType:"tank",behavior:C.Wander},{id:"siren",name:"Siren",biome:"drowned",hp:70,damage:22,defense:6,speed:65,aggroRadius:160,attackSpeed:1.1,weaponType:p.Staff,xpReward:65,texture:"enemy",lootTable:[{itemId:"siren_tear",chance:.2,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Ranged},{id:"skeleton",name:"Skeleton",biome:"bone_wastes",hp:140,damage:32,defense:16,speed:60,aggroRadius:110,attackSpeed:1,weaponType:p.Sword,xpReward:85,texture:"enemy_skeleton",lootTable:[{itemId:"bone_fragment",chance:.8,minQty:1,maxQty:3},{itemId:"rusty_sword",chance:.1,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Wander},{id:"skeleton_archer",name:"Skeleton Archer",biome:"bone_wastes",hp:110,damage:38,defense:10,speed:50,aggroRadius:160,attackSpeed:1,weaponType:p.Bow,xpReward:90,texture:"enemy_skeleton_archer",lootTable:[{itemId:"ancient_arrow",chance:.5,minQty:2,maxQty:5},{itemId:"bone_bow",chance:.08,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Ranged},{id:"bone_knight",name:"Bone Knight",biome:"bone_wastes",hp:220,damage:40,defense:28,speed:45,aggroRadius:100,attackSpeed:.8,weaponType:p.Sword,xpReward:110,texture:"enemy_knight",lootTable:[{itemId:"bone_plate",chance:.5,minQty:1,maxQty:2},{itemId:"knight_shield",chance:.05,minQty:1,maxQty:1}],aiType:"tank",behavior:C.Chase},{id:"necromancer",name:"Necromancer",biome:"bone_wastes",hp:100,damage:45,defense:8,speed:40,aggroRadius:150,attackSpeed:.9,weaponType:p.Staff,xpReward:120,texture:"enemy_necromancer",lootTable:[{itemId:"dark_tome",chance:.2,minQty:1,maxQty:1},{itemId:"necrotic_essence",chance:.5,minQty:1,maxQty:2}],aiType:"ranged",behavior:C.Support},{id:"zombie",name:"Zombie",biome:"bone_wastes",hp:160,damage:30,defense:15,speed:30,aggroRadius:80,attackSpeed:.7,weaponType:p.Unarmed,xpReward:80,texture:"enemy_zombie",lootTable:[{itemId:"rotten_flesh",chance:.8,minQty:1,maxQty:3},{itemId:"bone_fragment",chance:.5,minQty:1,maxQty:2}],aiType:"tank",behavior:C.Chase},{id:"wraith",name:"Wraith",biome:"bone_wastes",hp:130,damage:42,defense:12,speed:75,aggroRadius:140,attackSpeed:1.2,weaponType:p.Unarmed,xpReward:100,texture:"enemy_wraith",lootTable:[{itemId:"wraith_dust",chance:.5,minQty:1,maxQty:2},{itemId:"soul_shard",chance:.15,minQty:1,maxQty:1}],aiType:"assassin",behavior:C.Phase},{id:"bone_warrior",name:"Bone Warrior",biome:"bone_wastes",hp:180,damage:38,defense:22,speed:60,aggroRadius:120,attackSpeed:1,weaponType:p.Sword,xpReward:100,texture:"enemy",lootTable:[{itemId:"bone_fragment",chance:.7,minQty:1,maxQty:3}],aiType:"melee",behavior:C.Chase},{id:"sand_scorpion",name:"Sand Scorpion",biome:"bone_wastes",hp:140,damage:35,defense:18,speed:70,aggroRadius:100,attackSpeed:1.2,weaponType:p.Unarmed,xpReward:90,texture:"enemy",lootTable:[{itemId:"scorpion_venom",chance:.4,minQty:1,maxQty:2}],aiType:"melee",behavior:C.Ambush},{id:"mirage_phantom",name:"Mirage Phantom",biome:"bone_wastes",hp:100,damage:40,defense:10,speed:90,aggroRadius:140,attackSpeed:1.4,weaponType:p.Unarmed,xpReward:95,texture:"enemy",lootTable:[{itemId:"mirage_dust",chance:.3,minQty:1,maxQty:1}],aiType:"assassin",behavior:C.Phase},{id:"dust_devil",name:"Dust Devil",biome:"bone_wastes",hp:80,damage:30,defense:5,speed:100,aggroRadius:120,attackSpeed:1.6,weaponType:p.Unarmed,xpReward:85,texture:"enemy",lootTable:[{itemId:"wind_essence",chance:.4,minQty:1,maxQty:2}],aiType:"swarm",behavior:C.Swoop},{id:"skeletal_archer",name:"Skeletal Archer",biome:"bone_wastes",hp:110,damage:42,defense:12,speed:50,aggroRadius:160,attackSpeed:1,weaponType:p.Bow,xpReward:100,texture:"enemy",lootTable:[{itemId:"ancient_arrow",chance:.5,minQty:2,maxQty:5}],aiType:"ranged",behavior:C.Ranged},{id:"mummy_guardian",name:"Mummy Guardian",biome:"bone_wastes",hp:220,damage:36,defense:25,speed:35,aggroRadius:80,attackSpeed:.7,weaponType:p.Unarmed,xpReward:110,texture:"enemy",lootTable:[{itemId:"ancient_bandage",chance:.6,minQty:1,maxQty:2},{itemId:"desert_relic",chance:.1,minQty:1,maxQty:1}],aiType:"tank",behavior:C.Wander},{id:"sand_worm",name:"Sand Worm",biome:"bone_wastes",hp:160,damage:45,defense:15,speed:75,aggroRadius:100,attackSpeed:.9,weaponType:p.Unarmed,xpReward:105,texture:"enemy",lootTable:[{itemId:"worm_segment",chance:.5,minQty:1,maxQty:3}],aiType:"melee",behavior:C.Ambush},{id:"void_crawler",name:"Void Crawler",biome:"the_void",hp:240,damage:48,defense:24,speed:65,aggroRadius:130,attackSpeed:1.1,weaponType:p.Unarmed,xpReward:140,texture:"enemy_void",lootTable:[{itemId:"void_chitin",chance:.5,minQty:1,maxQty:2},{itemId:"void_essence",chance:.2,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Pack},{id:"shadow_stalker",name:"Shadow Stalker",biome:"the_void",hp:190,damage:55,defense:18,speed:95,aggroRadius:170,attackSpeed:1.4,weaponType:p.Dagger,xpReward:155,texture:"enemy_shadow",lootTable:[{itemId:"shadow_essence",chance:.4,minQty:1,maxQty:2},{itemId:"shadow_blade",chance:.05,minQty:1,maxQty:1}],aiType:"assassin",behavior:C.Ambush},{id:"nightmare",name:"Nightmare",biome:"the_void",hp:280,damage:52,defense:22,speed:80,aggroRadius:150,attackSpeed:1.2,weaponType:p.Unarmed,xpReward:165,texture:"enemy_nightmare",lootTable:[{itemId:"nightmare_dust",chance:.5,minQty:1,maxQty:2},{itemId:"dream_shard",chance:.15,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Phase},{id:"phantom",name:"Phantom",biome:"the_void",hp:160,damage:50,defense:15,speed:85,aggroRadius:160,attackSpeed:1.3,weaponType:p.Staff,xpReward:150,texture:"enemy_phantom",lootTable:[{itemId:"phantom_essence",chance:.4,minQty:1,maxQty:2},{itemId:"spectral_cloth",chance:.2,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Phase},{id:"void_shade",name:"Void Shade",biome:"the_void",hp:250,damage:50,defense:25,speed:90,aggroRadius:150,attackSpeed:1.3,weaponType:p.Dagger,xpReward:150,texture:"enemy",lootTable:[{itemId:"void_essence",chance:.4,minQty:1,maxQty:2}],aiType:"assassin",behavior:C.Ambush},{id:"reality_tear",name:"Reality Tear",biome:"the_void",hp:150,damage:55,defense:15,speed:0,aggroRadius:100,attackSpeed:1.5,weaponType:p.Staff,xpReward:130,texture:"enemy",lootTable:[{itemId:"reality_shard",chance:.3,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Stationary},{id:"phase_stalker",name:"Phase Stalker",biome:"the_void",hp:200,damage:60,defense:20,speed:100,aggroRadius:180,attackSpeed:1.4,weaponType:p.Dagger,xpReward:160,texture:"enemy",lootTable:[{itemId:"phase_crystal",chance:.25,minQty:1,maxQty:1}],aiType:"assassin",behavior:C.Phase},{id:"echo_wraith",name:"Echo Wraith",biome:"the_void",hp:180,damage:45,defense:18,speed:75,aggroRadius:130,attackSpeed:1.1,weaponType:p.Staff,xpReward:140,texture:"enemy",lootTable:[{itemId:"echo_crystal",chance:.3,minQty:1,maxQty:2}],aiType:"ranged",behavior:C.Ranged},{id:"dimension_crawler",name:"Dimension Crawler",biome:"the_void",hp:300,damage:48,defense:30,speed:45,aggroRadius:100,attackSpeed:.8,weaponType:p.Unarmed,xpReward:170,texture:"enemy",lootTable:[{itemId:"dimension_fragment",chance:.3,minQty:1,maxQty:2}],aiType:"tank",behavior:C.Wander},{id:"void_sorcerer",name:"Void Sorcerer",biome:"the_void",hp:160,damage:58,defense:12,speed:60,aggroRadius:160,attackSpeed:1,weaponType:p.Staff,xpReward:155,texture:"enemy",lootTable:[{itemId:"void_crystal",chance:.2,minQty:1,maxQty:1}],aiType:"healer",behavior:C.Support},{id:"nightmare_hound",name:"Nightmare Hound",biome:"the_void",hp:220,damage:52,defense:22,speed:95,aggroRadius:140,attackSpeed:1.3,weaponType:p.Unarmed,xpReward:145,texture:"enemy",lootTable:[{itemId:"nightmare_dust",chance:.4,minQty:1,maxQty:2}],aiType:"melee",behavior:C.Pack},{id:"living_terrain",name:"Living Terrain",biome:"edilas",hp:400,damage:60,defense:35,speed:20,aggroRadius:60,attackSpeed:.6,weaponType:p.Unarmed,xpReward:200,texture:"enemy",lootTable:[{itemId:"living_stone",chance:.5,minQty:1,maxQty:2}],aiType:"tank",behavior:C.Stationary},{id:"corruption_avatar",name:"Corruption Avatar",biome:"edilas",hp:350,damage:70,defense:25,speed:70,aggroRadius:150,attackSpeed:1.2,weaponType:p.Staff,xpReward:250,texture:"enemy",lootTable:[{itemId:"corruption_crystal",chance:.4,minQty:1,maxQty:2}],aiType:"ranged",behavior:C.Ranged},{id:"world_serpent_spawn",name:"World Serpent Spawn",biome:"edilas",hp:280,damage:65,defense:28,speed:80,aggroRadius:120,attackSpeed:1.1,weaponType:p.Unarmed,xpReward:220,texture:"enemy",lootTable:[{itemId:"serpent_scale",chance:.3,minQty:1,maxQty:2}],aiType:"melee",behavior:C.Chase},{id:"edilas_guardian",name:"EDILAS Guardian",biome:"edilas",hp:500,damage:55,defense:40,speed:40,aggroRadius:100,attackSpeed:.8,weaponType:p.Hammer,xpReward:280,texture:"enemy",lootTable:[{itemId:"guardian_core",chance:.2,minQty:1,maxQty:1}],aiType:"tank",behavior:C.Wander},{id:"reality_anchor",name:"Reality Anchor",biome:"edilas",hp:200,damage:75,defense:15,speed:0,aggroRadius:80,attackSpeed:1.5,weaponType:p.Staff,xpReward:190,texture:"enemy",lootTable:[{itemId:"primordial_essence",chance:.15,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Stationary},{id:"alpha_wolf",name:"Alpha Wolf",biome:"haven",hp:80,damage:14,defense:5,speed:90,aggroRadius:150,attackSpeed:1.3,weaponType:p.Unarmed,xpReward:45,texture:"enemy_wolf_alpha",lootTable:[{itemId:"alpha_pelt",chance:.7,minQty:1,maxQty:1},{itemId:"fang",chance:.6,minQty:2,maxQty:3},{itemId:"wolf_trophy",chance:.15,minQty:1,maxQty:1}],aiType:"melee",behavior:C.Pack},{id:"goblin_chief",name:"Goblin Chief",biome:"rotwood",hp:150,damage:22,defense:12,speed:65,aggroRadius:130,attackSpeed:1.1,weaponType:p.Axe,xpReward:80,texture:"enemy_goblin_chief",lootTable:[{itemId:"goblin_crown",chance:.3,minQty:1,maxQty:1},{itemId:"gold_coins",chance:.8,minQty:5,maxQty:15}],aiType:"melee",behavior:C.Pack},{id:"skeleton_lord",name:"Skeleton Lord",biome:"bone_wastes",hp:300,damage:48,defense:30,speed:55,aggroRadius:140,attackSpeed:.9,weaponType:p.Sword,xpReward:160,texture:"enemy_skeleton_lord",lootTable:[{itemId:"dark_bone",chance:.6,minQty:2,maxQty:4},{itemId:"lords_blade",chance:.1,minQty:1,maxQty:1},{itemId:"soul_shard",chance:.4,minQty:1,maxQty:2}],aiType:"tank",behavior:C.Pack},{id:"banshee",name:"Banshee",biome:"haven",hp:55,damage:15,defense:2,speed:80,aggroRadius:140,attackSpeed:1.4,weaponType:p.Unarmed,xpReward:35,texture:"enemy_banshee",lootTable:[{itemId:"ectoplasm",chance:.5,minQty:1,maxQty:2},{itemId:"banshee_wail",chance:.15,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Phase,nightOnly:!0},{id:"flesh_golem",name:"Flesh Golem",biome:"rotwood",hp:200,damage:28,defense:18,speed:30,aggroRadius:90,attackSpeed:.6,weaponType:p.Unarmed,xpReward:65,texture:"enemy_flesh_golem",lootTable:[{itemId:"stitched_flesh",chance:.6,minQty:1,maxQty:3},{itemId:"golem_heart",chance:.1,minQty:1,maxQty:1}],aiType:"tank",behavior:C.Chase,nightOnly:!0},{id:"dark_mage",name:"Dark Mage",biome:"bone_wastes",hp:120,damage:50,defense:8,speed:55,aggroRadius:160,attackSpeed:1,weaponType:p.Staff,xpReward:130,texture:"enemy_dark_mage",lootTable:[{itemId:"dark_tome",chance:.3,minQty:1,maxQty:1},{itemId:"shadow_essence",chance:.5,minQty:1,maxQty:2},{itemId:"mage_robe",chance:.08,minQty:1,maxQty:1}],aiType:"ranged",behavior:C.Ranged,nightOnly:!0}],yi=new Map(ys.map(r=>[r.id,r])),ji=[{id:"blood_leech",name:"Blood Leech",description:"3% of damage dealt is healed as HP.",triggerType:"on_hit",chance:1,magnitude:.03,cooldown:0,visualEffect:"heal_red"},{id:"shadow_phase",name:"Shadow Phase",description:"10% chance to dodge attacks with brief invincibility.",triggerType:"on_damaged",chance:.1,magnitude:.5,duration:.3,cooldown:2,visualEffect:"shadow_dodge"},{id:"corruption_absorb",name:"Corruption Absorb",description:"Convert corruption damage to healing instead.",triggerType:"passive",chance:1,magnitude:1,cooldown:0,visualEffect:"corruption_heal"},{id:"titan_slayer",name:"Titan Slayer",description:"+25% damage to bosses and titans.",triggerType:"passive",chance:1,magnitude:.25,cooldown:0,visualEffect:"power_glow"},{id:"shadow_wisp",name:"Shadow Wisp",description:"Summon a damaging wisp on kill that attacks nearby enemies.",triggerType:"on_kill",chance:1,magnitude:50,duration:5,cooldown:3,visualEffect:"wisp_summon"},{id:"chain_lightning",name:"Chain Lightning",description:"15% chance for attacks to chain to 2 nearby enemies.",triggerType:"on_hit",chance:.15,magnitude:.5,cooldown:1,visualEffect:"lightning_chain"},{id:"soul_harvest",name:"Soul Harvest",description:"Gain 5% max HP for 30s on kill (stacks 5x).",triggerType:"on_kill",chance:1,magnitude:.05,duration:30,maxStacks:5,cooldown:0,visualEffect:"soul_absorb"},{id:"frost_nova",name:"Frost Nova",description:"8% chance to freeze enemies in AoE on hit.",triggerType:"on_hit",chance:.08,magnitude:48,duration:2,cooldown:5,visualEffect:"frost_explosion"},{id:"reality_tear",name:"Reality Tear",description:"Attacks ignore 30% of enemy defense.",triggerType:"passive",chance:1,magnitude:.3,cooldown:0,visualEffect:"void_slash"},{id:"void_anchor",name:"Void Anchor",description:"Slow enemies within radius by 25%.",triggerType:"passive",chance:1,magnitude:.25,cooldown:0,visualEffect:"void_aura"},{id:"temporal_echo",name:"Temporal Echo",description:"5% chance to instantly repeat the last attack.",triggerType:"on_hit",chance:.05,magnitude:1,cooldown:3,visualEffect:"time_echo"},{id:"phoenix_rebirth",name:"Phoenix Rebirth",description:"Once per 10 min, revive with 30% HP on death.",triggerType:"on_death",chance:1,magnitude:.3,cooldown:600,visualEffect:"phoenix_fire"}];new Map(ji.map(r=>[r.id,r]));const le=["common","uncommon","rare","epic","legendary","mythic"];class Sn{rollRarity(e=0,t=1,i=0){const s=[];let a=0;for(const h of le){let m=ui[h].dropWeight;const g=le.indexOf(h);g>=3?m*=1+e*.1+i:g<=1&&(m*=Math.max(.1,1-e*.05)),m*=t,s.push(m),a+=m}let o=Math.random()*a,n=0;for(let h=0;h<s.length;h++)if(o-=s[h],o<=0){n=h;break}const l=le[n],c=ui[l];let d=null;return n>=4&&(d=this.rollLegendaryEffect()),{tier:l,tierIndex:n,statMultiplier:c.mult,color:c.color,label:c.label,legendaryEffect:d}}rollLegendaryEffect(){const e=Math.floor(Math.random()*ji.length);return ji[e]}applyStatMultiplier(e,t){const i=1+Math.random()*.1;return Math.round(e*t.statMultiplier*i)}getRarityInfo(e){const t=ui[e];return{color:t.color,mult:t.mult,label:t.label}}getTierFromIndex(e){return le[Math.min(e,le.length-1)]}getTierIndex(e){return le.indexOf(e)}getSetBonus(e,t){if(t<3)return{critChance:0,damage:0,defense:0};const s=le.indexOf(e)*.02;return{critChance:s*t,damage:Math.round(s*t*5),defense:Math.round(s*t*3)}}canReforge(e){return le.indexOf(e)<le.length-1}getReforgeTier(e){const t=le.indexOf(e);return t>=le.length-1?null:le[t+1]}getReforgeChance(e,t=1){const i=le.indexOf(e);return Math.min(1,[.8,.6,.4,.25,.15,0][i]*t)}attemptReforge(e,t=1){const i=this.getReforgeChance(e,t);return Math.random()<i}getSellMultiplier(e){return{common:1,uncommon:1.5,rare:2.5,epic:5,legendary:10,mythic:25}[e]}}const Mn=ne([f,S,oe,T]),ri=[];function Ga(){const r=[...ri];return ri.length=0,r}const Ws=[{itemId:"gold_coin",weight:40,minQty:1,maxQty:5},{itemId:"health_potion",weight:15,minQty:1,maxQty:1},{itemId:"raw_material",weight:20,minQty:1,maxQty:3},{itemId:"weapon_scrap",weight:10,minQty:1,maxQty:1},{itemId:"armor_shard",weight:10,minQty:1,maxQty:1},{itemId:"rare_gem",weight:3,minQty:1,maxQty:1},{itemId:"skill_tome",weight:2,minQty:1,maxQty:1}],lt=new Rt(12345),Ns=new Sn,Ua=new Map;for(const r of ys)Ua.set(r.texture,r);function $a(r,e=0){const t=Mn(r);for(const i of t){if(S.current[i]>0)continue;const s=S.max[i],a=T.damage[i],o=Math.round(s*.3+a*.5),n=Math.round(o*.5),l=U(r,K,i)?K.lootBonus[i]:0,c=jt(V.textureId[i]),d=Ua.get(c);let h=!1;if(d&&d.lootTable.length>0){for(const u of d.lootTable)if(lt.next()<u.chance){const m=Math.min((d.xpReward??o)/30,5)+e+l,g=Ns.rollRarity(m);ri.push({x:f.x[i],y:f.y[i],itemId:u.itemId,quantity:lt.nextInt(u.minQty,u.maxQty),rarity:g.tierIndex,xpReward:h?0:o,goldReward:h?0:n,enemyType:c}),h=!0}}if(!h){const u=lt.nextInt(1,3),m=Ws.reduce((g,y)=>g+y.weight,0);for(let g=0;g<u;g++){let y=lt.next()*m;for(const _ of Ws)if(y-=_.weight,y<=0){const w=Math.min(o/30,5)+e+l,k=Ns.rollRarity(w);ri.push({x:f.x[i],y:f.y[i],itemId:_.itemId,quantity:lt.nextInt(_.minQty,_.maxQty),rarity:k.tierIndex,xpReward:g===0?o:0,goldReward:g===0?n:0,enemyType:c});break}}}ii(r,i)}}class Tn{eid;scene;sprite;cursors;wasd;keyJ;keySpace;facingX=0;facingY=1;dodging=!1;dodgeTimer=0;dodgeCooldown=0;dodgeDirX=0;dodgeDirY=0;invincibleTimer=0;speedBonus=0;staminaRegenMult=1;staminaDrainMult=1;constructor(e,t){this.eid=t,this.scene=e,this.sprite=e.add.image(f.x[t],f.y[t],"player"),this.sprite.setScale(.5),this.sprite.setOrigin(.5,.75),this.sprite.setDepth(5e3),this.cursors=e.input.keyboard.createCursorKeys(),this.wasd={W:e.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.W),A:e.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.A),S:e.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.S),D:e.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.D),E:e.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.E),SHIFT:e.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.SHIFT)},this.keyJ=e.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.J),this.keySpace=e.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.SPACE)}update(e){const t=this.eid;if(this.invincibleTimer>0&&(this.invincibleTimer-=e,this.sprite.setAlpha(Math.sin(this.invincibleTimer*20)>0?1:.4),this.invincibleTimer<=0&&(this.invincibleTimer=0,this.sprite.setAlpha(1))),this.dodgeCooldown>0&&(this.dodgeCooldown-=e),this.dodging){this.dodgeTimer-=e;const n=Ct*3;b.vx[t]=this.dodgeDirX*n,b.vy[t]=this.dodgeDirY*n,this.dodgeTimer<=0&&(this.dodging=!1),this.sprite.setPosition(f.x[t],f.y[t]);return}let i=0,s=0;if((this.cursors.left.isDown||this.wasd.A.isDown)&&(i-=1),(this.cursors.right.isDown||this.wasd.D.isDown)&&(i+=1),(this.cursors.up.isDown||this.wasd.W.isDown)&&(s-=1),(this.cursors.down.isDown||this.wasd.S.isDown)&&(s+=1),(i!==0||s!==0)&&(this.facingX=i,this.facingY=s),i!==0&&s!==0){const n=1/Math.SQRT2;i*=n,s*=n}let a=Ct+this.speedBonus;const o=this.wasd.SHIFT.isDown&&(i!==0||s!==0);o&&W.current[t]>0&&(a*=gr,W.current[t]=Math.max(0,W.current[t]-yr*e*this.staminaDrainMult)),o||(W.current[t]=Math.min(W.max[t],W.current[t]+W.regenRate[t]*e*this.staminaRegenMult)),b.vx[t]=i*a,b.vy[t]=s*a,this.sprite.setPosition(f.x[t],f.y[t]),this.sprite.setFlipX(i<0)}attack(){const e=this.eid;return T.attackCooldown[e]>0?null:(T.attackCooldown[e]=0,{facingX:this.facingX,facingY:this.facingY})}useTool(){const e=this.getPosition(),t=se.pixelToTile(e.x+this.facingX*48,e.y+this.facingY*48);return{tileX:t.tileX,tileY:t.tileY}}dodge(){const e=this.eid;if(this.dodging||this.dodgeCooldown>0||W.current[e]<20)return!1;let t=this.facingX,i=this.facingY;const s=(this.cursors.left.isDown||this.wasd.A.isDown?-1:0)+(this.cursors.right.isDown||this.wasd.D.isDown?1:0),a=(this.cursors.up.isDown||this.wasd.W.isDown?-1:0)+(this.cursors.down.isDown||this.wasd.S.isDown?1:0);(s!==0||a!==0)&&(t=s,i=a);const o=Math.sqrt(t*t+i*i);return o===0?!1:(this.dodgeDirX=t/o,this.dodgeDirY=i/o,W.current[e]-=20,this.dodging=!0,this.dodgeTimer=.2,this.dodgeCooldown=.6,this.setInvincible(.2),!0)}setInvincible(e){this.invincibleTimer=Math.max(this.invincibleTimer,e)}isInvincible(){return this.invincibleTimer>0}isAttackJustPressed(){return x.Input.Keyboard.JustDown(this.keyJ)||this.scene.input.activePointer.leftButtonDown()}isToolUseJustPressed(){return x.Input.Keyboard.JustDown(this.keySpace)}isDodgeJustPressed(){const e=this.cursors.left.isDown||this.wasd.A.isDown||this.cursors.right.isDown||this.wasd.D.isDown||this.cursors.up.isDown||this.wasd.W.isDown||this.cursors.down.isDown||this.wasd.S.isDown;return x.Input.Keyboard.JustDown(this.wasd.SHIFT)&&e}getFacing(){return{x:this.facingX,y:this.facingY}}isDodging(){return this.dodging}getSprite(){return this.sprite}getEid(){return this.eid}getPosition(){return{x:f.x[this.eid],y:f.y[this.eid]}}getHealth(){return{current:S.current[this.eid],max:S.max[this.eid]}}getStamina(){return{current:W.current[this.eid],max:W.max[this.eid]}}destroy(){this.sprite.destroy()}}const Cn=[{id:"hoe",name:"Hoe",description:"Tills soil for planting",category:"tool",sprite:"sprites/Items/Tools/item_tool_00015.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0,toolType:"hoe",tier:1,efficiency:1},{id:"watering_can",name:"Watering Can",description:"Waters crops to help them grow",category:"tool",sprite:"sprites/Items/Tools/item_tool_00025.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0,toolType:"watering_can",tier:1,efficiency:1},{id:"scythe",name:"Scythe",description:"Harvests grown crops",category:"tool",sprite:"sprites/Items/Tools/item_tool_00020.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0,toolType:"hoe",tier:1,efficiency:1},{id:"axe",name:"Axe",description:"Chops down trees",category:"tool",sprite:"sprites/Items/Tools/item_tool_00005.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0,toolType:"axe",tier:1,efficiency:1},{id:"pickaxe",name:"Pickaxe",description:"Breaks rocks and mines ore",category:"tool",sprite:"sprites/Items/Tools/item_tool_00010.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0,toolType:"pickaxe",tier:1,efficiency:1},{id:"fishing_rod",name:"Fishing Rod",description:"Used for fishing",category:"tool",sprite:"sprites/Items/Tools/item_tool_00030.png",maxStack:1,sellPrice:25,buyPrice:63,rarity:0,toolType:"fishing_rod",tier:1,efficiency:1},{id:"gold_hoe",name:"Gold Hoe",description:"A hoe made of pure gold. Tills a 3x3 area.",category:"tool",sprite:"sprites/items/tool/gold_hoe.png",maxStack:1,sellPrice:5e3,buyPrice:12500,rarity:1,toolType:"hoe",tier:3,efficiency:2},{id:"iridium_rod",name:"Iridium Rod",description:"The ultimate fishing rod. Can use bait and tackle.",category:"tool",sprite:"sprites/items/tool/iridium_rod.png",maxStack:1,sellPrice:7500,buyPrice:18750,rarity:1,toolType:"fishing_rod",tier:4,efficiency:3},{id:"lantern",name:"Lantern",description:"A dim lantern that pushes back the darkness. In these lands, even light feels like a prayer.",category:"tool",sprite:"sprites/items/tool/lantern.png",maxStack:1,sellPrice:150,buyPrice:375,rarity:0,toolType:"hoe",tier:1,efficiency:1},{id:"glow_lantern",name:"Glow Lantern",description:"Infused with captured spirits, it radiates an eerie luminescence that wards off creeping shadows.",category:"tool",sprite:"sprites/items/tool/glow_lantern.png",maxStack:1,sellPrice:500,buyPrice:1250,rarity:0,toolType:"hoe",tier:1,efficiency:1},{id:"spike_trap",name:"Spike Trap",description:"Cruel iron spikes concealed beneath loose earth. The unwary step once and never again.",category:"tool",sprite:"sprites/items/tool/spike_trap.png",maxStack:20,sellPrice:200,buyPrice:500,rarity:0,toolType:"hoe",tier:1,efficiency:1},{id:"snare_trap",name:"Snare Trap",description:"A cunning wire loop that entangles prey in a tightening embrace. Patience rewarded with suffering.",category:"tool",sprite:"sprites/items/tool/snare_trap.png",maxStack:20,sellPrice:120,buyPrice:300,rarity:0,toolType:"hoe",tier:1,efficiency:1},{id:"mega_bomb",name:"Mega Bomb",description:"A volatile sphere of compressed fury. Its detonation leaves nothing but ruin and silence.",category:"tool",sprite:"sprites/items/tool/mega_bomb.png",maxStack:10,sellPrice:300,buyPrice:750,rarity:0,toolType:"hoe",tier:1,efficiency:1},{id:"bobber",name:"Bobber",description:"A small float that signals when something below has taken interest. Watch it closely.",category:"tool",sprite:"sprites/items/tool/bobber.png",maxStack:20,sellPrice:25,buyPrice:63,rarity:0,toolType:"hoe",tier:1,efficiency:1},{id:"golden_watering_can",name:"Golden Watering Can",description:"A watering can of pure enchanted gold. Water flows endlessly from its spout without effort.",category:"tool",sprite:"sprites/items/tool/golden_watering_can.png",maxStack:1,sellPrice:5e3,buyPrice:12500,rarity:1,toolType:"watering_can",tier:3,efficiency:2},{id:"dressed_spinner",name:"Dressed Spinner",description:"A finely crafted fishing lure adorned with dark feathers. Fish strike it with reckless abandon.",category:"tool",sprite:"sprites/items/tool/dressed_spinner.png",maxStack:1,sellPrice:200,buyPrice:500,rarity:0,toolType:"hoe",tier:1,efficiency:1},{id:"forge_hammer",name:"Forge Hammer",description:"A master smith's hammer scarred by a thousand forgings. It shapes metal and destiny alike.",category:"tool",sprite:"sprites/items/tool/forge_hammer.png",maxStack:1,sellPrice:800,buyPrice:2e3,rarity:0,toolType:"hoe",tier:1,efficiency:1}],In=[{id:"parsnip_seeds",name:"Parsnip Seeds",description:"Plant in spring. Takes 4 days to grow.",category:"seed",sprite:"sprites/Items/Consumables/item_consumable_00001.png",maxStack:99,sellPrice:20,buyPrice:50,rarity:0,cropId:"parsnip",growthDays:4,seasons:["spring"]},{id:"potato_seeds",name:"Potato Seeds",description:"Plant in spring. Takes 6 days to grow.",category:"seed",sprite:"sprites/Items/Consumables/item_consumable_00002.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,cropId:"potato",growthDays:6,seasons:["spring"]},{id:"cauliflower_seeds",name:"Cauliflower Seeds",description:"Plant in spring. Takes 12 days to grow.",category:"seed",sprite:"sprites/Items/Consumables/item_consumable_00003.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,cropId:"cauliflower",growthDays:12,seasons:["spring"]},{id:"tomato_seeds",name:"Tomato Seeds",description:"Plant in summer. Takes 11 days, then produces every 4 days.",category:"seed",sprite:"sprites/items/seed/tomato_seeds.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,cropId:"tomato",growthDays:11,seasons:["summer"]},{id:"melon_seeds",name:"Melon Seeds",description:"Plant in summer. Takes 12 days to grow.",category:"seed",sprite:"sprites/items/seed/melon_seeds.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,cropId:"melon",growthDays:12,seasons:["summer"]},{id:"corn_seeds",name:"Corn Seeds",description:"Plant in summer or fall. Takes 14 days, then produces every 4 days.",category:"seed",sprite:"sprites/items/seed/corn_seeds.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,cropId:"corn",growthDays:14,seasons:["summer","fall"]},{id:"pumpkin_seeds",name:"Pumpkin Seeds",description:"Plant in fall. Takes 13 days to grow.",category:"seed",sprite:"sprites/items/seed/pumpkin_seeds.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,cropId:"pumpkin",growthDays:13,seasons:["fall"]},{id:"carrot_seeds",name:"Carrot Seeds",description:"Plant in spring or fall. Takes 3 days to grow.",category:"seed",sprite:"sprites/items/seed/carrot_seeds.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0,cropId:"carrot",growthDays:3,seasons:["spring","fall"]},{id:"wheat_seeds",name:"Wheat Seeds",description:"Plant in summer or fall. Takes 4 days to grow.",category:"seed",sprite:"sprites/items/seed/wheat_seeds.png",maxStack:99,sellPrice:35,buyPrice:88,rarity:0,cropId:"wheat",growthDays:4,seasons:["summer","fall"]},{id:"hot_pepper_seeds",name:"Hot Pepper Seeds",description:"Plant in summer. Takes 5 days, regrows every 3 days.",category:"seed",sprite:"sprites/items/seed/hot_pepper_seeds.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0,cropId:"hot_pepper",growthDays:5,seasons:["summer"]},{id:"hops_starter",name:"Hops Starter",description:"Plant in summer. Takes 11 days, regrows every 2 days.",category:"seed",sprite:"sprites/items/seed/hops_starter.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,cropId:"hops",growthDays:11,seasons:["summer"]},{id:"grape_starter",name:"Grape Starter",description:"Plant in fall. Takes 10 days, regrows every 3 days.",category:"seed",sprite:"sprites/items/seed/grape_starter.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,cropId:"grape",growthDays:10,seasons:["fall"]},{id:"blue_jazz_seeds",name:"Blue Jazz Seeds",description:"Plant in spring. A beautiful blue flower.",category:"seed",sprite:"sprites/items/seed/blue_jazz_seeds.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0,cropId:"blue_jazz",growthDays:7,seasons:["spring"]},{id:"ancient_seed_packet",name:"Ancient Seed Packet",description:"Seeds preserved in amber for millennia. Whatever grows from them has not walked this earth in ages.",category:"seed",sprite:"sprites/items/seed/ancient_seed_packet.png",maxStack:99,sellPrice:1e3,buyPrice:2500,rarity:2,cropId:"ancient_fruit",growthDays:28,seasons:["spring","summer","fall","winter"]},{id:"spring_seeds",name:"Spring Seeds",description:"A pouch of mixed spring seeds blessed by the grove. New life stirs within the husks.",category:"seed",sprite:"sprites/items/seed/spring_seeds.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,cropId:"parsnip",growthDays:4,seasons:["spring"]},{id:"summer_seeds",name:"Summer Seeds",description:"Seeds that thrive in scorching heat. They drink the sun like parched travelers drink water.",category:"seed",sprite:"sprites/items/seed/summer_seeds.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,cropId:"tomato",growthDays:6,seasons:["summer"]},{id:"fall_seeds",name:"Fall Seeds",description:"Harvest seeds that grow as the world dies around them. They flourish amid decay.",category:"seed",sprite:"sprites/items/seed/fall_seeds.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,cropId:"pumpkin",growthDays:8,seasons:["fall"]},{id:"winter_seeds",name:"Winter Seeds",description:"Frost-hardened seeds that defy the killing cold. Only the desperate dare plant these.",category:"seed",sprite:"sprites/items/seed/winter_seeds.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,cropId:"winter_root",growthDays:7,seasons:["winter"]},{id:"rare_seed",name:"Rare Seed",description:"A peculiar seed that pulses with dormant energy. What grows from it is anyone's dark guess.",category:"seed",sprite:"sprites/items/seed/rare_seed.png",maxStack:99,sellPrice:500,buyPrice:1250,rarity:2,cropId:"sweet_gem_berry",growthDays:24,seasons:["fall"]},{id:"ancient_seed",name:"Ancient Seed",description:"A seed preserved for eons in petrified amber. The crop it yields is forgotten by the living.",category:"seed",sprite:"sprites/items/seed/ancient_seed.png",maxStack:99,sellPrice:1e3,buyPrice:2500,rarity:2,cropId:"ancient_fruit",growthDays:28,seasons:["spring","summer","fall"]},{id:"coffee_bean",name:"Coffee Bean",description:"A precious bean from distant, fallen lands. Its brew banishes exhaustion and sharpens the mind.",category:"seed",sprite:"sprites/items/seed/coffee_bean.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,cropId:"coffee",growthDays:10,seasons:["spring","summer"]},{id:"mixed_seeds",name:"Mixed Seeds",description:"A handful of assorted seeds of unknown origin. Plant them and pray something edible grows.",category:"seed",sprite:"sprites/items/seed/mixed_seeds.png",maxStack:99,sellPrice:10,buyPrice:25,rarity:0,cropId:"parsnip",growthDays:5,seasons:["spring","summer","fall","winter"]}],Pn=[{id:"parsnip",name:"Parsnip",description:"A spring root vegetable.",category:"crop",sprite:"sprites/items/crop/parsnip.png",maxStack:99,sellPrice:35,buyPrice:88,rarity:0,seedId:"parsnip_seeds",quality:0},{id:"potato",name:"Potato",description:"A starchy tuber.",category:"crop",sprite:"sprites/Food/food_item_0045.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,seedId:"potato_seeds",quality:0},{id:"cauliflower",name:"Cauliflower",description:"A valuable spring vegetable.",category:"crop",sprite:"sprites/items/crop/cauliflower.png",maxStack:99,sellPrice:175,buyPrice:438,rarity:0,seedId:"cauliflower_seeds",quality:0},{id:"tomato",name:"Tomato",description:"A juicy red fruit.",category:"crop",sprite:"sprites/Food/food_item_0055.png",maxStack:99,sellPrice:75,buyPrice:188,rarity:0,seedId:"tomato_seeds",quality:0},{id:"melon",name:"Melon",description:"A sweet summer fruit.",category:"crop",sprite:"sprites/items/crop/melon.png",maxStack:99,sellPrice:250,buyPrice:625,rarity:0,seedId:"melon_seeds",quality:0},{id:"corn",name:"Corn",description:"Grows in summer and fall.",category:"crop",sprite:"sprites/items/crop/corn.png",maxStack:99,sellPrice:75,buyPrice:188,rarity:0,seedId:"corn_seeds",quality:0},{id:"pumpkin",name:"Pumpkin",description:"A valuable fall crop.",category:"crop",sprite:"sprites/Food/food_item_0050.png",maxStack:99,sellPrice:320,buyPrice:800,rarity:0,seedId:"pumpkin_seeds",quality:0},{id:"carrot",name:"Carrot",description:"A quick-growing root vegetable.",category:"crop",sprite:"sprites/Food/food_item_0035.png",maxStack:99,sellPrice:45,buyPrice:113,rarity:0,seedId:"carrot_seeds",quality:0},{id:"wheat",name:"Wheat",description:"Golden wheat. Can be milled into flour.",category:"crop",sprite:"sprites/items/crop/wheat.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,seedId:"wheat_seeds",quality:0},{id:"hot_pepper",name:"Hot Pepper",description:"A spicy pepper. Handle with care!",category:"crop",sprite:"sprites/items/crop/hot_pepper.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0,seedId:"hot_pepper_seeds",quality:0},{id:"hops",name:"Hops",description:"Bitter flowers used for brewing ale.",category:"crop",sprite:"sprites/items/crop/hops.png",maxStack:99,sellPrice:55,buyPrice:138,rarity:0,seedId:"hops_seeds",quality:0},{id:"grape",name:"Grape",description:"Sweet grapes for eating or winemaking.",category:"crop",sprite:"sprites/items/crop/grape.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,seedId:"grape_seeds",quality:0},{id:"blue_jazz",name:"Blue Jazz",description:"A beautiful blue flower. Said to bring luck.",category:"crop",sprite:"sprites/items/crop/blue_jazz.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,seedId:"blue_jazz_seeds",quality:0},{id:"ancient_fruit",name:"Ancient Fruit",description:"A fruit from a bygone era, pulsing with forgotten magic. Its juice is said to extend life itself.",category:"crop",sprite:"sprites/items/crop/ancient_fruit.png",maxStack:99,sellPrice:1500,buyPrice:3750,rarity:2,seedId:"ancient_fruit_seeds",quality:0},{id:"green_bean",name:"Green Bean",description:"A slender pod harvested from creeping vines. Sustenance wrested from blighted soil.",category:"crop",sprite:"sprites/items/crop/green_bean.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0,seedId:"green_bean_seeds",quality:0},{id:"blueberry",name:"Blueberry",description:"Tiny berries the color of bruised twilight. They burst with a bittersweet tang on the tongue.",category:"crop",sprite:"sprites/items/crop/blueberry.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,seedId:"blueberry_seeds",quality:0},{id:"eggplant",name:"Eggplant",description:"A glossy purple fruit that thrives in ashen fields. Its flesh absorbs the flavors of the earth.",category:"crop",sprite:"sprites/items/crop/eggplant.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,seedId:"eggplant_seeds",quality:0},{id:"yam",name:"Yam",description:"A starchy tuber pulled from the darkened earth. Keeps well through the harshest winters.",category:"crop",sprite:"sprites/items/crop/yam.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,seedId:"yam_seeds",quality:0},{id:"sweet_gem_berry",name:"Sweet Gem Berry",description:"A crystalline berry that glows with inner light. Its sweetness is almost supernaturally intense.",category:"crop",sprite:"sprites/items/crop/sweet_gem_berry.png",maxStack:99,sellPrice:3e3,buyPrice:7500,rarity:0,seedId:"sweet_gem_berry_seeds",quality:0}],Rn=[{id:"wood",name:"Wood",description:"Basic building material from trees.",category:"resource",sprite:"sprites/items/resource/wood.png",maxStack:999,sellPrice:5,buyPrice:13,rarity:0,gatherTool:"axe"},{id:"stone",name:"Stone",description:"Common stone from rocks.",category:"resource",sprite:"sprites/items/resource/stone.png",maxStack:999,sellPrice:5,buyPrice:13,rarity:0},{id:"fiber",name:"Fiber",description:"Plant fiber for crafting.",category:"resource",sprite:"sprites/items/resource/fiber.png",maxStack:999,sellPrice:3,buyPrice:8,rarity:0},{id:"sap",name:"Sap",description:"Sticky tree sap. Used in crafting.",category:"resource",sprite:"sprites/items/resource/sap.png",maxStack:999,sellPrice:2,buyPrice:5,rarity:0},{id:"coal",name:"Coal",description:"Fuel for furnaces.",category:"resource",sprite:"sprites/Items/Gems_Materials/item_gem_00001.png",maxStack:999,sellPrice:15,buyPrice:38,rarity:0},{id:"copper_ore",name:"Copper Ore",description:"Can be smelted into copper bars.",category:"resource",sprite:"sprites/items/resource/copper_ore.png",maxStack:999,sellPrice:5,buyPrice:13,rarity:0,gatherTool:"pickaxe"},{id:"iron_ore",name:"Iron Ore",description:"Can be smelted into iron bars.",category:"resource",sprite:"sprites/items/resource/iron_ore.png",maxStack:999,sellPrice:10,buyPrice:25,rarity:1,gatherTool:"pickaxe"},{id:"gold_ore",name:"Gold Ore",description:"Can be smelted into gold bars.",category:"resource",sprite:"sprites/items/resource/gold_ore.png",maxStack:999,sellPrice:25,buyPrice:63,rarity:1,gatherTool:"pickaxe"},{id:"fertilizer",name:"Basic Fertilizer",description:"Restores soil health by 30%. Apply to tilled soil to improve crop quality.",category:"resource",sprite:"sprites/items/resource/fertilizer.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0},{id:"quality_fertilizer",name:"Quality Fertilizer",description:"Restores soil health by 50%. Premium blend for maximum crop quality.",category:"resource",sprite:"sprites/items/resource/quality_fertilizer.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:1},{id:"copper_bar",name:"Copper Bar",description:"A refined copper bar. Used in crafting.",category:"resource",sprite:"sprites/items/resource/copper_bar.png",maxStack:999,sellPrice:60,buyPrice:150,rarity:0},{id:"iron_bar",name:"Iron Bar",description:"A refined iron bar. Used in crafting.",category:"resource",sprite:"sprites/items/resource/iron_bar.png",maxStack:999,sellPrice:120,buyPrice:300,rarity:1},{id:"gold_bar",name:"Gold Bar",description:"A refined gold bar. Used in crafting.",category:"resource",sprite:"sprites/items/resource/gold_bar.png",maxStack:999,sellPrice:250,buyPrice:625,rarity:1},{id:"wheat_flour",name:"Wheat Flour",description:"Ground wheat for baking.",category:"resource",sprite:"sprites/Food/food_item_0100.png",maxStack:99,sellPrice:20,buyPrice:50,rarity:0},{id:"sugar",name:"Sugar",description:"Sweetener for recipes.",category:"resource",sprite:"sprites/Food/food_item_0101.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0},{id:"red_mushroom",name:"Red Mushroom",description:"A red mushroom used in alchemy.",category:"resource",sprite:"sprites/items/resource/red_mushroom.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0},{id:"green_mushroom",name:"Green Mushroom",description:"A green mushroom used in alchemy.",category:"resource",sprite:"sprites/items/resource/green_mushroom.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0},{id:"hay",name:"Hay",description:"Feed for farm animals.",category:"resource",sprite:"sprites/items/resource/hay.png",maxStack:999,sellPrice:25,buyPrice:63,rarity:0},{id:"wool",name:"Wool",description:"Soft wool from sheep or rabbits.",category:"resource",sprite:"sprites/items/resource/wool.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0},{id:"butter",name:"Fresh Butter",description:"Creamy butter made from fresh milk.",category:"resource",sprite:"sprites/Food/food_item_0007.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0},{id:"cream",name:"Heavy Cream",description:"Rich cream for cooking and baking.",category:"resource",sprite:"sprites/items/resource/cream.png",maxStack:99,sellPrice:45,buyPrice:113,rarity:0},{id:"rope",name:"Rope",description:"Sturdy braided fiber. Used to descend into the deepest pits where sunlight has never reached.",category:"resource",sprite:"sprites/items/resource/rope.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0},{id:"rotted_wood",name:"Rotted Wood",description:"Crumbling timber softened by decay and corruption. Only useful as fuel or filler.",category:"resource",sprite:"sprites/items/resource/rotted_wood.png",maxStack:99,sellPrice:10,buyPrice:25,rarity:0,gatherTool:"axe"},{id:"flower",name:"Flower",description:"A delicate bloom clinging to life in blighted soil. Beauty persists even in damnation.",category:"resource",sprite:"sprites/items/resource/flower.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0},{id:"rare_herb",name:"Rare Herb",description:"A luminous plant found only in places where the veil between worlds grows thin.",category:"resource",sprite:"sprites/items/resource/rare_herb.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:2},{id:"wild_horseradish",name:"Wild Horseradish",description:"A pungent root torn from the cursed earth. Its bitter heat wards off the chill of death.",category:"resource",sprite:"sprites/items/resource/wild_horseradish.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0},{id:"daffodil",name:"Daffodil",description:"A pale bloom that grows where the veil between worlds is thin. Beautiful but unsettling.",category:"resource",sprite:"sprites/items/resource/daffodil.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0},{id:"leek",name:"Leek",description:"A hardy stalk found near abandoned graves. Its sharp flavor cuts through the fog of despair.",category:"resource",sprite:"sprites/items/resource/leek.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0},{id:"dandelion",name:"Dandelion",description:"A tenacious weed that thrives even in blighted soil. Some brew it into bitter tonics.",category:"resource",sprite:"sprites/items/resource/dandelion.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0},{id:"spice_berry",name:"Spice Berry",description:"A fiery red berry that burns the tongue. Prized by alchemists for its volatile essence.",category:"resource",sprite:"sprites/items/resource/spice_berry.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0},{id:"sweet_pea",name:"Sweet Pea",description:"A fragrant flower that masks the stench of decay. Survivors weave them into garlands of hope.",category:"resource",sprite:"sprites/items/resource/sweet_pea.png",maxStack:99,sellPrice:45,buyPrice:113,rarity:0},{id:"common_mushroom",name:"Common Mushroom",description:"A dull brown fungus found in damp hollows. Safe to eat, though it tastes of sorrow.",category:"resource",sprite:"sprites/items/resource/common_mushroom.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0},{id:"winter_root",name:"Winter Root",description:"A gnarled root frozen in permafrost. Radiates a faint, unnatural warmth when held.",category:"resource",sprite:"sprites/items/resource/winter_root.png",maxStack:99,sellPrice:70,buyPrice:175,rarity:0},{id:"crocus",name:"Crocus",description:"A delicate purple flower that blooms defiantly through frost and ash. A stubborn sign of life.",category:"resource",sprite:"sprites/items/resource/crocus.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0},{id:"purple_mushroom",name:"Purple Mushroom",description:"A rare violet fungus that pulses with eldritch light. Highly valued by occultists and herbalists.",category:"resource",sprite:"sprites/items/resource/purple_mushroom.png",maxStack:99,sellPrice:250,buyPrice:625,rarity:0},{id:"morel",name:"Morel",description:"A honeycomb-capped mushroom found near rotting stumps. Coveted by dark chefs for its earthy flavor.",category:"resource",sprite:"sprites/items/resource/morel.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:0,gatherTool:"pickaxe"},{id:"hardwood",name:"Hardwood",description:"Dense timber from ancient, gnarled trees. Strong enough to reinforce any barricade against the horde.",category:"resource",sprite:"sprites/items/resource/hardwood.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0,gatherTool:"axe"},{id:"maple_syrup",name:"Maple Syrup",description:"Thick amber sap tapped from withered maples. Sweet as sin in a world drained of all sweetness.",category:"resource",sprite:"sprites/items/resource/maple_syrup.png",maxStack:99,sellPrice:120,buyPrice:300,rarity:0},{id:"oak_resin",name:"Oak Resin",description:"Sticky resin bled from ancient oaks. Used to seal wounds and craft dark preservatives.",category:"resource",sprite:"sprites/items/resource/oak_resin.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0},{id:"pine_tar",name:"Pine Tar",description:"Dark, viscous tar distilled from cursed pines. Burns with an acrid, cleansing smoke.",category:"resource",sprite:"sprites/items/resource/pine_tar.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0},{id:"large_milk",name:"Large Milk",description:"A generous pail of rich milk from a well-tended beast. Rare comfort in dark times.",category:"resource",sprite:"sprites/items/resource/large_milk.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:0},{id:"large_egg",name:"Large Egg",description:"An oversized egg with a thick, mottled shell. Something seems to stir within.",category:"resource",sprite:"sprites/items/resource/large_egg.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0},{id:"large_goat_milk",name:"Large Goat Milk",description:"Pungent milk from a goat that grazes on cursed pastures. Surprisingly nourishing.",category:"resource",sprite:"sprites/items/resource/large_goat_milk.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0},{id:"quartz",name:"Quartz",description:"A cloudy crystal pried from cave walls. Hums faintly when the darkness draws near.",category:"resource",sprite:"sprites/items/resource/quartz.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0},{id:"earth_crystal",name:"Earth Crystal",description:"A jagged amber crystal born from tectonic fury. Warm to the touch, even in bitter cold.",category:"resource",sprite:"sprites/items/resource/earth_crystal.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:2},{id:"fire_quartz",name:"Fire Quartz",description:"A blazing red crystal that smolders with trapped heat. Burns the unwary who grip it too long.",category:"resource",sprite:"sprites/items/resource/fire_quartz.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0},{id:"speed_gro",name:"Speed-Gro",description:"Alchemical fertilizer that accelerates growth. The plants it feeds grow unnaturally fast.",category:"resource",sprite:"sprites/items/resource/speed_gro.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0},{id:"void_egg",name:"Void Egg",description:"A pitch-black egg that absorbs all light around it. Something writhes within its obsidian shell.",category:"resource",sprite:"sprites/items/resource/void_egg.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:2},{id:"pearl",name:"Pearl",description:"A lustrous sphere formed around a grain of suffering. The ocean's most beautiful wound.",category:"resource",sprite:"sprites/items/resource/pearl.png",maxStack:99,sellPrice:1500,buyPrice:3750,rarity:0},{id:"master_ore",name:"Master Ore",description:"An ore of legendary purity from the deepest abyssal mines. Forges sing when it melts.",category:"resource",sprite:"sprites/items/resource/master_ore.png",maxStack:99,sellPrice:500,buyPrice:1250,rarity:0,gatherTool:"pickaxe"},{id:"ancient_herb",name:"Ancient Herb",description:"A withered herb from a long-dead garden. Its medicinal properties defy the passage of ages.",category:"resource",sprite:"sprites/items/resource/ancient_herb.png",maxStack:99,sellPrice:250,buyPrice:625,rarity:2},{id:"diamond",name:"Diamond",description:"A flawless gemstone forged in the earth's crushing depths. Harder than any blade, colder than any heart.",category:"resource",sprite:"sprites/items/resource/diamond.png",maxStack:99,sellPrice:750,buyPrice:1875,rarity:0},{id:"ruby",name:"Ruby",description:"A blood-red gemstone that glows like a dying ember. Sought by warlords and sorcerers alike.",category:"resource",sprite:"sprites/items/resource/ruby.png",maxStack:99,sellPrice:500,buyPrice:1250,rarity:0}],An=[{id:"slime_gel",name:"Slime Gel",description:"Sticky gel from slimes. Used in crafting.",category:"material",sprite:"sprites/items/material/slime_gel.png",maxStack:99,sellPrice:15,buyPrice:38,rarity:0,tier:1},{id:"ice_crystal",name:"Ice Crystal",description:"A cold crystal from frozen creatures.",category:"material",sprite:"sprites/items/material/ice_crystal.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:2,tier:1},{id:"bat_wing",name:"Bat Wing",description:"A leathery wing from a cave bat.",category:"material",sprite:"sprites/items/material/bat_wing.png",maxStack:99,sellPrice:20,buyPrice:50,rarity:0,tier:1},{id:"bone",name:"Bone",description:"A bone from defeated skeletons.",category:"material",sprite:"sprites/items/material/bone.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0,tier:1},{id:"ectoplasm",name:"Ectoplasm",description:"Ghostly residue with magical properties.",category:"material",sprite:"sprites/items/material/ectoplasm.png",maxStack:99,sellPrice:75,buyPrice:188,rarity:0,tier:1},{id:"spirit_shard",name:"Spirit Shard",description:"A rare crystallized spirit fragment.",category:"material",sprite:"sprites/items/material/spirit_shard.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,tier:2},{id:"fur",name:"Beast Fur",description:"Thick fur from wild beasts.",category:"material",sprite:"sprites/items/material/fur.png",maxStack:99,sellPrice:35,buyPrice:88,rarity:0,tier:1},{id:"leather",name:"Leather",description:"Tanned animal hide. Used for crafting.",category:"material",sprite:"sprites/items/material/leather.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0,tier:1},{id:"tusk",name:"Wild Tusk",description:"A sturdy tusk from a wild boar.",category:"material",sprite:"sprites/items/material/tusk.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,tier:1},{id:"feather",name:"Feather",description:"A soft feather from wild birds.",category:"material",sprite:"sprites/items/material/feather.png",maxStack:99,sellPrice:15,buyPrice:38,rarity:0,tier:1},{id:"fang",name:"Sharp Fang",description:"A razor-sharp fang from a predator.",category:"material",sprite:"sprites/items/material/fang.png",maxStack:99,sellPrice:45,buyPrice:113,rarity:0,tier:1},{id:"spore",name:"Toxic Spore",description:"Poisonous spores from mutant fungi.",category:"material",sprite:"sprites/items/material/spore.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0,tier:1},{id:"magic_herb",name:"Magic Herb",description:"A rare herb with mystical properties.",category:"material",sprite:"sprites/items/material/magic_herb.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,tier:1},{id:"arrow",name:"Arrow",description:"Ammunition for bows.",category:"material",sprite:"sprites/items/material/arrow.png",maxStack:999,sellPrice:5,buyPrice:13,rarity:0,tier:1},{id:"slime_crown",name:"Slime Crown",description:"A gelatinous crown from the Slime King. Radiates a strange energy.",category:"material",sprite:"sprites/items/material/slime_crown.png",maxStack:1,sellPrice:2500,buyPrice:6250,rarity:0,tier:1},{id:"royal_jelly",name:"Royal Jelly",description:"Precious substance from the Slime King. Used in powerful elixirs.",category:"material",sprite:"sprites/items/material/royal_jelly.png",maxStack:99,sellPrice:500,buyPrice:1250,rarity:0,tier:1},{id:"prismatic_shard",name:"Prismatic Shard",description:"An extremely rare crystallized rainbow. Highly valuable.",category:"material",sprite:"sprites/items/material/prismatic_shard.png",maxStack:99,sellPrice:5e3,buyPrice:12500,rarity:4,tier:5},{id:"void_heart",name:"Void Heart",description:"The dark heart of the Shadow Lord. Pulses with shadowy energy.",category:"material",sprite:"sprites/items/material/void_heart.png",maxStack:1,sellPrice:3500,buyPrice:8750,rarity:2,tier:5},{id:"galaxy_soul",name:"Galaxy Soul",description:"A fragment of the cosmos itself. Required for legendary crafting.",category:"material",sprite:"sprites/items/material/galaxy_soul.png",maxStack:99,sellPrice:1e4,buyPrice:25e3,rarity:5,tier:5},{id:"frost_scale",name:"Frost Scale",description:"A scale from the Frost Wyrm. Eternally cold to the touch.",category:"material",sprite:"sprites/items/material/frost_scale.png",maxStack:99,sellPrice:750,buyPrice:1875,rarity:2,tier:3},{id:"frozen_heart",name:"Frozen Heart",description:"The icy core of the Frost Wyrm. Never melts.",category:"material",sprite:"sprites/items/material/frozen_heart.png",maxStack:1,sellPrice:5e3,buyPrice:12500,rarity:0,tier:1},{id:"wyrm_fang",name:"Wyrm Fang",description:"A massive fang from the Frost Wyrm. Sharp as ice.",category:"material",sprite:"sprites/items/material/wyrm_fang.png",maxStack:99,sellPrice:1200,buyPrice:3e3,rarity:2,tier:3},{id:"ancient_core",name:"Ancient Core",description:"The power source of the Ancient Golem. Hums with ancient magic.",category:"material",sprite:"sprites/items/material/ancient_core.png",maxStack:1,sellPrice:6e3,buyPrice:15e3,rarity:3,tier:3},{id:"golem_heart",name:"Golem Heart",description:"A stone heart that once beat with elemental power.",category:"material",sprite:"sprites/items/material/golem_heart.png",maxStack:1,sellPrice:4e3,buyPrice:1e4,rarity:0,tier:1},{id:"void_crown",name:"Void Crown",description:"The Void Empress's crown. Contains unfathomable power.",category:"material",sprite:"sprites/items/material/void_crown.png",maxStack:1,sellPrice:25e3,buyPrice:62500,rarity:3,tier:5},{id:"wooden_arrow",name:"Wooden Arrow",description:"Basic arrow. Gets the job done.",category:"material",sprite:"sprites/items/material/wooden_arrow.png",maxStack:999,sellPrice:2,buyPrice:5,rarity:0,tier:1},{id:"iron_arrow",name:"Iron Arrow",description:"Stronger arrow with an iron tip.",category:"material",sprite:"sprites/items/material/iron_arrow.png",maxStack:999,sellPrice:5,buyPrice:13,rarity:1,tier:1},{id:"steel_arrow",name:"Steel Arrow",description:"High quality arrows with steel tips.",category:"material",sprite:"sprites/items/material/steel_arrow.png",maxStack:999,sellPrice:10,buyPrice:25,rarity:1,tier:2},{id:"explosive_arrow",name:"Explosive Arrow",description:"Explodes on impact dealing area damage.",category:"material",sprite:"sprites/items/material/explosive_arrow.png",maxStack:50,sellPrice:50,buyPrice:125,rarity:0,tier:1},{id:"poison_arrow",name:"Poison Arrow",description:"Coated in venom. Poisons enemies.",category:"material",sprite:"sprites/items/material/poison_arrow.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0,tier:1},{id:"master_scepter",name:"Master Scepter",description:"A symbol of mastery over all skills. Grants bonus XP.",category:"material",sprite:"sprites/items/material/master_scepter.png",maxStack:1,sellPrice:1e5,buyPrice:25e4,rarity:0,tier:1},{id:"vine",name:"Vine",description:"A flexible vine from the Corrupted Grove.",category:"material",sprite:"sprites/items/material/vine.png",maxStack:999,sellPrice:5,buyPrice:13,rarity:0,tier:1},{id:"ancient_bark",name:"Ancient Bark",description:"Petrified bark from the oldest trees.",category:"material",sprite:"sprites/items/material/ancient_bark.png",maxStack:99,sellPrice:75,buyPrice:188,rarity:2,tier:3},{id:"living_sap",name:"Living Sap",description:"Magical sap that glows with life energy.",category:"material",sprite:"sprites/items/material/living_sap.png",maxStack:99,sellPrice:120,buyPrice:300,rarity:0,tier:1},{id:"forest_heart",name:"Forest Heart",description:"The crystallized essence of the forest itself.",category:"material",sprite:"sprites/items/material/forest_heart.png",maxStack:10,sellPrice:500,buyPrice:1250,rarity:0,tier:1},{id:"treant_heart",name:"Treant Heart",description:"The magical core of an Ancient Treant.",category:"material",sprite:"sprites/items/material/treant_heart.png",maxStack:10,sellPrice:1e3,buyPrice:2500,rarity:0,tier:1},{id:"natures_blessing",name:"Nature's Blessing",description:"A rare gift from the forest spirits.",category:"material",sprite:"sprites/items/material/natures_blessing.png",maxStack:5,sellPrice:2500,buyPrice:6250,rarity:0,tier:2},{id:"spider_silk",name:"Spider Silk",description:"Incredibly strong silk from giant spiders.",category:"material",sprite:"sprites/items/material/spider_silk.png",maxStack:99,sellPrice:45,buyPrice:113,rarity:0,tier:1},{id:"venom_gland",name:"Venom Gland",description:"Contains potent spider venom.",category:"material",sprite:"sprites/items/material/venom_gland.png",maxStack:50,sellPrice:100,buyPrice:250,rarity:0,tier:1},{id:"queen_fang",name:"Queen Fang",description:"A massive fang from the Spider Queen.",category:"material",sprite:"sprites/items/material/queen_fang.png",maxStack:10,sellPrice:750,buyPrice:1875,rarity:0,tier:1},{id:"swamp_moss",name:"Swamp Moss",description:"Slimy moss from the marsh.",category:"material",sprite:"sprites/items/material/swamp_moss.png",maxStack:999,sellPrice:4,buyPrice:10,rarity:0,tier:1},{id:"toxin_gland",name:"Toxin Gland",description:"A gland filled with marsh toxins.",category:"material",sprite:"sprites/items/material/toxin_gland.png",maxStack:99,sellPrice:35,buyPrice:88,rarity:0,tier:1},{id:"murky_water",name:"Murky Water",description:"Brackish water from the marsh depths.",category:"material",sprite:"sprites/items/material/murky_water.png",maxStack:99,sellPrice:10,buyPrice:25,rarity:0,tier:1},{id:"venom_sac",name:"Venom Sac",description:"A sac of concentrated marsh venom.",category:"material",sprite:"sprites/items/material/venom_sac.png",maxStack:50,sellPrice:85,buyPrice:213,rarity:0,tier:1},{id:"bog_essence",name:"Bog Essence",description:"The distilled essence of the blighted marsh.",category:"material",sprite:"sprites/items/material/bog_essence.png",maxStack:50,sellPrice:150,buyPrice:375,rarity:0,tier:1},{id:"marsh_eye",name:"Marsh Eye",description:"An eye from the Swamp Horror. It still watches.",category:"material",sprite:"sprites/items/material/marsh_eye.png",maxStack:10,sellPrice:600,buyPrice:1500,rarity:0,tier:1},{id:"horror_tentacle",name:"Horror Tentacle",description:"A severed tentacle from the Swamp Horror.",category:"material",sprite:"sprites/items/material/horror_tentacle.png",maxStack:20,sellPrice:350,buyPrice:875,rarity:0,tier:1},{id:"blighted_heart",name:"Blighted Heart",description:"The corrupted heart of the marsh.",category:"material",sprite:"sprites/items/material/blighted_heart.png",maxStack:5,sellPrice:1200,buyPrice:3e3,rarity:0,tier:1},{id:"lurker_scale",name:"Lurker Scale",description:"Tough scales from a Marsh Lurker.",category:"material",sprite:"sprites/items/material/lurker_scale.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,tier:1},{id:"swamp_fang",name:"Swamp Fang",description:"A razor-sharp fang from the marsh.",category:"material",sprite:"sprites/items/material/swamp_fang.png",maxStack:50,sellPrice:120,buyPrice:300,rarity:0,tier:1},{id:"fire_ore",name:"Fire Ore",description:"Ore infused with volcanic heat.",category:"material",sprite:"sprites/items/material/fire_ore.png",maxStack:999,sellPrice:25,buyPrice:63,rarity:0,tier:1},{id:"obsidian",name:"Obsidian",description:"Volcanic glass, extremely sharp.",category:"material",sprite:"sprites/items/material/obsidian.png",maxStack:999,sellPrice:40,buyPrice:100,rarity:2,tier:1},{id:"ash",name:"Volcanic Ash",description:"Fine ash from volcanic eruptions.",category:"material",sprite:"sprites/items/material/ash.png",maxStack:999,sellPrice:5,buyPrice:13,rarity:2,tier:1},{id:"magma_core",name:"Magma Core",description:"A core of solidified magma. Still warm.",category:"material",sprite:"sprites/items/material/magma_core.png",maxStack:50,sellPrice:200,buyPrice:500,rarity:0,tier:1},{id:"fire_crystal",name:"Fire Crystal",description:"A crystal formed from pure fire essence.",category:"material",sprite:"sprites/items/material/fire_crystal.png",maxStack:50,sellPrice:300,buyPrice:750,rarity:2,tier:2},{id:"flame_core",name:"Flame Core",description:"The burning heart of the volcano.",category:"material",sprite:"sprites/items/material/flame_core.png",maxStack:10,sellPrice:800,buyPrice:2e3,rarity:0,tier:1},{id:"molten_heart",name:"Molten Heart",description:"The heart of the Molten Guardian. Never cools.",category:"material",sprite:"sprites/items/material/molten_heart.png",maxStack:5,sellPrice:1500,buyPrice:3750,rarity:0,tier:1},{id:"infernal_essence",name:"Infernal Essence",description:"Pure volcanic energy in crystallized form.",category:"material",sprite:"sprites/items/material/infernal_essence.png",maxStack:10,sellPrice:2e3,buyPrice:5e3,rarity:2,tier:3},{id:"imp_crown",name:"Imp Crown",description:"The crown of the Fire Imp King.",category:"material",sprite:"sprites/items/material/imp_crown.png",maxStack:5,sellPrice:500,buyPrice:1250,rarity:0,tier:1},{id:"frozen_tear",name:"Frozen Tear",description:"A tear frozen for eternity.",category:"material",sprite:"sprites/items/material/frozen_tear.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,tier:1},{id:"snow_essence",name:"Snow Essence",description:"The pure essence of winter.",category:"material",sprite:"sprites/items/material/snow_essence.png",maxStack:99,sellPrice:35,buyPrice:88,rarity:0,tier:1},{id:"permafrost",name:"Permafrost",description:"Ice that never melts, even in fire.",category:"material",sprite:"sprites/items/material/permafrost.png",maxStack:50,sellPrice:150,buyPrice:375,rarity:2,tier:3},{id:"glacial_shard",name:"Glacial Shard",description:"A shard from an ancient glacier.",category:"material",sprite:"sprites/items/material/glacial_shard.png",maxStack:50,sellPrice:200,buyPrice:500,rarity:2,tier:1},{id:"frost_shard",name:"Frost Shard",description:"A shard of crystallized frost magic.",category:"material",sprite:"sprites/items/material/frost_shard.png",maxStack:20,sellPrice:400,buyPrice:1e3,rarity:2,tier:3},{id:"wyrm_scale",name:"Wyrm Scale",description:"A scale from the mighty Frost Wyrm.",category:"material",sprite:"sprites/items/material/wyrm_scale.png",maxStack:20,sellPrice:600,buyPrice:1500,rarity:2,tier:3},{id:"heart_of_winter",name:"Heart of Winter",description:"The frozen heart of the ice realm.",category:"material",sprite:"sprites/items/material/heart_of_winter.png",maxStack:5,sellPrice:2e3,buyPrice:5e3,rarity:0,tier:1},{id:"grave_dust",name:"Grave Dust",description:"Dust from ancient graves.",category:"material",sprite:"sprites/items/material/grave_dust.png",maxStack:999,sellPrice:12,buyPrice:30,rarity:0,tier:1},{id:"soul_fragment",name:"Soul Fragment",description:"A piece of a departed soul.",category:"material",sprite:"sprites/items/material/soul_fragment.png",maxStack:50,sellPrice:150,buyPrice:375,rarity:0,tier:1},{id:"spirit_essence",name:"Spirit Essence",description:"The distilled essence of spirits.",category:"material",sprite:"sprites/items/material/spirit_essence.png",maxStack:50,sellPrice:200,buyPrice:500,rarity:0,tier:2},{id:"cursed_relic",name:"Cursed Relic",description:"An ancient relic bearing a dark curse.",category:"material",sprite:"sprites/items/material/cursed_relic.png",maxStack:20,sellPrice:300,buyPrice:750,rarity:0,tier:2},{id:"lich_phylactery",name:"Lich Phylactery",description:"The vessel of the Lich King's soul.",category:"material",sprite:"sprites/items/material/lich_phylactery.png",maxStack:5,sellPrice:3e3,buyPrice:7500,rarity:0,tier:3},{id:"death_crown",name:"Death Crown",description:"The crown of the Lich King.",category:"material",sprite:"sprites/items/material/death_crown.png",maxStack:1,sellPrice:5e3,buyPrice:12500,rarity:0,tier:3},{id:"cursed_bone",name:"Cursed Bone",description:"A bone infused with dark magic.",category:"material",sprite:"sprites/items/material/cursed_bone.png",maxStack:50,sellPrice:80,buyPrice:200,rarity:0,tier:1},{id:"bone_crown",name:"Bone Crown",description:"Crown of the Bone Lord.",category:"material",sprite:"sprites/items/material/bone_crown.png",maxStack:5,sellPrice:400,buyPrice:1e3,rarity:0,tier:1},{id:"spectral_binding",name:"Spectral Binding",description:"Chains that bind spirits to this world.",category:"material",sprite:"sprites/items/material/spectral_binding.png",maxStack:20,sellPrice:350,buyPrice:875,rarity:0,tier:1},{id:"guardian_sigil",name:"Guardian Sigil",description:"A sigil dropped by biome guardians. Proves your worth.",category:"material",sprite:"sprites/items/material/guardian_sigil.png",maxStack:10,sellPrice:1e3,buyPrice:2500,rarity:0,tier:1},{id:"void_essence",name:"Void Essence",description:"Pure darkness given form. The stuff of nightmares.",category:"material",sprite:"sprites/items/material/void_essence.png",maxStack:50,sellPrice:500,buyPrice:1250,rarity:2,tier:5},{id:"starlight_fragment",name:"Starlight Fragment",description:"A piece of captured starlight. Glows softly in darkness.",category:"material",sprite:"sprites/items/material/starlight_fragment.png",maxStack:99,sellPrice:250,buyPrice:625,rarity:0,tier:1},{id:"ancient_coin",name:"Ancient Coin",description:"Currency from a forgotten civilization.",category:"material",sprite:"sprites/items/material/ancient_coin.png",maxStack:999,sellPrice:100,buyPrice:250,rarity:2,tier:3},{id:"steel_bar",name:"Steel Bar",description:"Carbon-hardened iron refined through hellish heat. The backbone of weapons that endure.",category:"material",sprite:"sprites/items/material/steel_bar.png",maxStack:99,sellPrice:250,buyPrice:625,rarity:1,tier:2},{id:"ornate_bar",name:"Ornate Bar",description:"An alloy of gold and arcane metals, etched with sigils that pulse faintly in the dark.",category:"material",sprite:"sprites/items/material/ornate_bar.png",maxStack:99,sellPrice:500,buyPrice:1250,rarity:0,tier:2},{id:"void_ingot",name:"Void Ingot",description:"A bar of solidified nothingness. It absorbs light and warmth from everything it touches.",category:"material",sprite:"sprites/items/material/void_ingot.png",maxStack:99,sellPrice:1500,buyPrice:3750,rarity:2,tier:5},{id:"frost_alloy",name:"Frost Alloy",description:"A blue-white metal that never warms. Forged from glacial ore in the breath of a dying winter.",category:"material",sprite:"sprites/items/material/frost_alloy.png",maxStack:99,sellPrice:1200,buyPrice:3e3,rarity:2,tier:3},{id:"refined_quartz",name:"Refined Quartz",description:"Purified crystal humming with latent energy. The foundation of enchantments and ruin alike.",category:"material",sprite:"sprites/items/material/refined_quartz.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,tier:1},{id:"golem_core_shard",name:"Golem Core Shard",description:"A fragment of the animating heart of a golem. It still trembles with the echo of false life.",category:"material",sprite:"sprites/items/material/golem_core_shard.png",maxStack:99,sellPrice:2e3,buyPrice:5e3,rarity:0,tier:4},{id:"rotten_flesh",name:"Rotten Flesh",description:"Putrid strips of decaying meat. The stench clings to everything it touches.",category:"material",sprite:"sprites/items/material/rotten_flesh.png",maxStack:99,sellPrice:15,buyPrice:38,rarity:0,tier:1},{id:"sinew",name:"Sinew",description:"Tough fibers torn from the tendons of fallen beasts. Useful for binding and bowstrings.",category:"material",sprite:"sprites/items/material/sinew.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0,tier:1},{id:"claw",name:"Claw",description:"A curved talon still stained with old blood. Sharp enough to score iron.",category:"material",sprite:"sprites/items/material/claw.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0,tier:1},{id:"diseased_flesh",name:"Diseased Flesh",description:"Blackened tissue riddled with pestilence. Alchemists prize its toxic properties.",category:"material",sprite:"sprites/items/material/diseased_flesh.png",maxStack:99,sellPrice:10,buyPrice:25,rarity:0,tier:1},{id:"rat_tail",name:"Rat Tail",description:"A wiry tail severed from the vermin that infest the ruins. Proof of a minor extermination.",category:"material",sprite:"sprites/items/material/rat_tail.png",maxStack:99,sellPrice:20,buyPrice:50,rarity:0,tier:1},{id:"antler",name:"Antler",description:"A branching horn from a corrupted stag. The bone is unnaturally warm to the touch.",category:"material",sprite:"sprites/items/material/antler.png",maxStack:99,sellPrice:45,buyPrice:113,rarity:0,tier:1},{id:"bile",name:"Bile",description:"Acrid digestive fluid harvested from aberrant stomachs. It dissolves most containers over time.",category:"material",sprite:"sprites/items/material/bile.png",maxStack:99,sellPrice:35,buyPrice:88,rarity:0,tier:1},{id:"corrupted_flesh",name:"Corrupted Flesh",description:"Tissue warped by dark magic into something no longer recognizable as mortal remains.",category:"material",sprite:"sprites/items/material/corrupted_flesh.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0,tier:1},{id:"lens",name:"Lens",description:"A crystalline eye pried from a construct of the deep. It still seems to watch you.",category:"material",sprite:"sprites/items/material/lens.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,tier:1},{id:"cursed_bark",name:"Cursed Bark",description:"Stripped from trees that grow where the damned were buried. It weeps black sap in moonlight.",category:"material",sprite:"sprites/items/material/cursed_bark.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0,tier:1},{id:"dark_sap",name:"Dark Sap",description:"Viscous black resin that oozes from blighted wood. Burns with a sickly violet flame.",category:"material",sprite:"sprites/items/material/dark_sap.png",maxStack:99,sellPrice:35,buyPrice:88,rarity:0,tier:1},{id:"banshee_tear",name:"Banshee Tear",description:"A single frozen tear shed by a wailing spirit. It hums with sorrow that never ends.",category:"material",sprite:"sprites/items/material/banshee_tear.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,tier:1},{id:"stitched_flesh",name:"Stitched Flesh",description:"Patches of skin crudely sewn together from multiple bodies. A necromancer's patchwork.",category:"material",sprite:"sprites/items/material/stitched_flesh.png",maxStack:99,sellPrice:55,buyPrice:138,rarity:0,tier:1},{id:"corrupted_heart",name:"Corrupted Heart",description:"A blackened organ that still beats with a slow, dreadful rhythm. Dark power courses through it.",category:"material",sprite:"sprites/items/material/corrupted_heart.png",maxStack:99,sellPrice:120,buyPrice:300,rarity:0,tier:1},{id:"demon_heart",name:"Demon Heart",description:"Ripped from a creature of the abyss. It burns to hold and whispers terrible promises.",category:"material",sprite:"sprites/items/material/demon_heart.png",maxStack:99,sellPrice:500,buyPrice:1250,rarity:0,tier:1},{id:"phoenix_feather",name:"Phoenix Feather",description:"A plume of undying flame. It crumbles to ash and reforms endlessly in your hands.",category:"material",sprite:"sprites/items/material/phoenix_feather.png",maxStack:99,sellPrice:800,buyPrice:2e3,rarity:3,tier:4},{id:"wind_essence",name:"Wind Essence",description:"Captured gale force bound in a fragile shell. Release it and the storm answers.",category:"material",sprite:"sprites/items/material/wind_essence.png",maxStack:99,sellPrice:300,buyPrice:750,rarity:0,tier:1},{id:"talon",name:"Talon",description:"A razor-sharp talon from a predator of the skies. It could rend steel with ease.",category:"material",sprite:"sprites/items/material/talon.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,tier:1},{id:"dragon_scale",name:"Dragon Scale",description:"An iridescent scale shed by a dragon. Harder than steel and warm to the touch.",category:"material",sprite:"sprites/items/material/dragon_scale.png",maxStack:99,sellPrice:800,buyPrice:2e3,rarity:3,tier:4},{id:"dragon_heart",name:"Dragon Heart",description:"The still-smoldering heart of a slain dragon. Its fire will never fully die.",category:"material",sprite:"sprites/items/material/dragon_heart.png",maxStack:99,sellPrice:2e3,buyPrice:5e3,rarity:3,tier:4},{id:"cloth",name:"Cloth",description:"Woven fabric spun from beast fibers. Essential for bandages and reinforced garments.",category:"material",sprite:"sprites/items/material/cloth.png",maxStack:99,sellPrice:300,buyPrice:750,rarity:0,tier:1},{id:"solar_essence",name:"Solar Essence",description:"A fragment of captured sunlight. Searing to the undead and invaluable for enchantments.",category:"material",sprite:"sprites/items/material/solar_essence.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,tier:1}],Dn=[{id:"fried_egg",name:"Fried Egg",description:"A simple fried egg. Quick breakfast.",category:"food",sprite:"sprites/items/food/fried_egg.png",maxStack:99,sellPrice:35,buyPrice:88,rarity:0,healAmount:25,staminaRestore:15},{id:"vegetable_soup",name:"Vegetable Soup",description:"A hearty soup. Grants regen for 30s.",category:"food",sprite:"sprites/items/food/vegetable_soup.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,healAmount:50,staminaRestore:30,buffType:"regen",buffDuration:30,buffMagnitude:3,foodCategory:"balanced",dietDuration:300,dietHpBonus:25,dietStaminaBonus:20},{id:"fish_dinner",name:"Fish Dinner",description:"A satisfying dinner. +5 defense for 45s.",category:"food",sprite:"sprites/items/food/fish_dinner.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,healAmount:60,staminaRestore:40,buffType:"defense",buffDuration:45,buffMagnitude:5,foodCategory:"hearty",dietDuration:300,dietHpBonus:30,dietStaminaBonus:10},{id:"farmers_lunch",name:"Farmer's Lunch",description:"Boosts movement speed by 20 for 60s.",category:"food",sprite:"sprites/items/food/farmers_lunch.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:0,healAmount:80,staminaRestore:60,buffType:"speed",buffDuration:60,buffMagnitude:20,foodCategory:"balanced",dietDuration:300,dietHpBonus:30,dietStaminaBonus:25},{id:"miners_treat",name:"Miner's Treat",description:"Boosts attack by 8 for 45s.",category:"food",sprite:"sprites/items/food/miners_treat.png",maxStack:99,sellPrice:120,buyPrice:300,rarity:0,healAmount:70,staminaRestore:50,buffType:"strength",buffDuration:45,buffMagnitude:8,foodCategory:"energizing",dietDuration:270,dietHpBonus:15,dietStaminaBonus:30},{id:"lucky_lunch",name:"Lucky Lunch",description:"Regen 5 HP/s for 30s after eating.",category:"food",sprite:"sprites/items/food/lucky_lunch.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,healAmount:50,staminaRestore:30,buffType:"regen",buffDuration:30,buffMagnitude:5},{id:"pumpkin_pie",name:"Pumpkin Pie",description:"Seasonal treat. +10 defense for 60s.",category:"food",sprite:"sprites/items/food/pumpkin_pie.png",maxStack:99,sellPrice:250,buyPrice:625,rarity:0,healAmount:100,staminaRestore:50,buffType:"defense",buffDuration:60,buffMagnitude:10,foodCategory:"balanced",dietDuration:300,dietHpBonus:35,dietStaminaBonus:20},{id:"eel",name:"Eel",description:"A slippery eel. Prized in cooking.",category:"food",sprite:"sprites/items/food/eel.png",maxStack:99,sellPrice:85,buyPrice:213,rarity:0,healAmount:20,staminaRestore:10},{id:"sea_cucumber",name:"Sea Cucumber",description:"A strange ocean creature. Lucky ingredient.",category:"food",sprite:"sprites/items/food/sea_cucumber.png",maxStack:99,sellPrice:75,buyPrice:188,rarity:0,healAmount:15,staminaRestore:8},{id:"tortilla",name:"Tortilla",description:"A flatbread made from corn.",category:"food",sprite:"sprites/items/food/tortilla.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0,healAmount:15,staminaRestore:5},{id:"honey",name:"Honey",description:"Sweet honey. Regen 2 HP/s for 20s.",category:"food",sprite:"sprites/items/food/honey.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,healAmount:20,staminaRestore:25,buffType:"regen",buffDuration:20,buffMagnitude:2},{id:"bread",name:"Bread",description:"Simple but filling. Restores some health.",category:"food",sprite:"sprites/Food/food_item_0010.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,healAmount:30,staminaRestore:20},{id:"apple",name:"Apple",description:"A crisp fruit. Slightly refreshing.",category:"food",sprite:"sprites/Food/food_item_0020.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0,healAmount:15,staminaRestore:10},{id:"fish",name:"Fish",description:"Fresh caught fish. Provides some nourishment.",category:"food",sprite:"sprites/Food/food_item_0030.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0,healAmount:20,staminaRestore:12},{id:"sardine",name:"Sardine",description:"A small ocean fish.",category:"food",sprite:"sprites/items/food/sardine.png",maxStack:99,sellPrice:15,buyPrice:38,rarity:0,healAmount:10,staminaRestore:5},{id:"carp",name:"Carp",description:"A common freshwater fish.",category:"food",sprite:"sprites/items/food/carp.png",maxStack:99,sellPrice:20,buyPrice:50,rarity:0,healAmount:12,staminaRestore:6},{id:"sunfish",name:"Sunfish",description:"A colorful pond fish.",category:"food",sprite:"sprites/items/food/sunfish.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0,healAmount:14,staminaRestore:7},{id:"catfish",name:"Catfish",description:"A whiskered bottom-feeder.",category:"food",sprite:"sprites/items/food/catfish.png",maxStack:99,sellPrice:75,buyPrice:188,rarity:0,healAmount:25,staminaRestore:15},{id:"bass",name:"Largemouth Bass",description:"A prized sport fish.",category:"food",sprite:"sprites/items/food/bass.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,healAmount:30,staminaRestore:20},{id:"salmon",name:"Salmon",description:"A delicious pink-fleshed fish.",category:"food",sprite:"sprites/Food/food_item_0031.png",maxStack:99,sellPrice:120,buyPrice:300,rarity:0,healAmount:35,staminaRestore:25},{id:"sturgeon",name:"Sturgeon",description:"An ancient, valuable fish.",category:"food",sprite:"sprites/items/food/sturgeon.png",maxStack:99,sellPrice:250,buyPrice:625,rarity:1,healAmount:40,staminaRestore:30},{id:"octopus",name:"Octopus",description:"A clever eight-armed sea creature.",category:"food",sprite:"sprites/items/food/octopus.png",maxStack:99,sellPrice:300,buyPrice:750,rarity:1,healAmount:35,staminaRestore:25},{id:"crab_legs",name:"Crab Legs",description:"A legendary delicacy from the deep. Grants powerful regeneration and stat boosts.",category:"food",sprite:"sprites/items/food/crab_legs.png",maxStack:16,sellPrice:500,buyPrice:1250,rarity:0,healAmount:80,staminaRestore:100,foodCategory:"special",dietDuration:360,dietHpBonus:40,dietStaminaBonus:50},{id:"raw_meat",name:"Raw Meat",description:"Fresh meat from wild animals. Cook it for better nutrition.",category:"food",sprite:"sprites/Food/food_item_0040.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0,healAmount:10,staminaRestore:5},{id:"cooked_meat",name:"Cooked Meat",description:"Well-cooked meat. Filling and nutritious.",category:"food",sprite:"sprites/items/food/cooked_meat.png",maxStack:99,sellPrice:75,buyPrice:188,rarity:0,healAmount:40,staminaRestore:25,foodCategory:"hearty",dietDuration:240,dietHpBonus:25,dietStaminaBonus:5},{id:"acorn",name:"Acorn",description:"A small nut gathered by forest creatures.",category:"food",sprite:"sprites/items/food/acorn.png",maxStack:99,sellPrice:10,buyPrice:25,rarity:0,healAmount:5,staminaRestore:3},{id:"venison",name:"Venison",description:"Premium meat from deer. Highly valued.",category:"food",sprite:"sprites/items/food/venison.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,healAmount:30,staminaRestore:20},{id:"rabbit_meat",name:"Rabbit Meat",description:"Tender meat from wild rabbits.",category:"food",sprite:"sprites/items/food/rabbit_meat.png",maxStack:99,sellPrice:35,buyPrice:88,rarity:0,healAmount:15,staminaRestore:10},{id:"boar_meat",name:"Boar Meat",description:"Hearty meat from wild boar. Great for stews.",category:"food",sprite:"sprites/items/food/boar_meat.png",maxStack:99,sellPrice:55,buyPrice:138,rarity:0,healAmount:25,staminaRestore:15},{id:"mushroom",name:"Mushroom",description:"A common edible mushroom.",category:"food",sprite:"sprites/items/food/mushroom.png",maxStack:99,sellPrice:20,buyPrice:50,rarity:0,healAmount:10,staminaRestore:5},{id:"stardrop",name:"Stardrop",description:"A mysterious fruit that permanently increases your maximum energy.",category:"food",sprite:"sprites/items/food/stardrop.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0,healAmount:0,staminaRestore:0},{id:"egg",name:"Egg",description:"A fresh chicken egg.",category:"food",sprite:"sprites/Food/food_item_0005.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,healAmount:15,staminaRestore:15},{id:"duck_egg",name:"Duck Egg",description:"A large duck egg.",category:"food",sprite:"sprites/items/food/duck_egg.png",maxStack:99,sellPrice:75,buyPrice:188,rarity:0,healAmount:20,staminaRestore:20},{id:"milk",name:"Milk",description:"Fresh cow milk.",category:"food",sprite:"sprites/Food/food_item_0006.png",maxStack:99,sellPrice:125,buyPrice:313,rarity:0,healAmount:25,staminaRestore:25},{id:"goat_milk",name:"Goat Milk",description:"Fresh goat milk.",category:"food",sprite:"sprites/items/food/goat_milk.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:0,healAmount:30,staminaRestore:30},{id:"truffle",name:"Truffle",description:"A rare delicacy found by pigs.",category:"food",sprite:"sprites/items/food/truffle.png",maxStack:99,sellPrice:500,buyPrice:1250,rarity:0,healAmount:50,staminaRestore:50},{id:"veggie_soup",name:"Veggie Soup",description:"Warm and healthy.",category:"food",sprite:"sprites/items/food/veggie_soup.png",maxStack:99,sellPrice:120,buyPrice:300,rarity:0,healAmount:40,staminaRestore:30},{id:"fish_stew",name:"Fish Stew",description:"Rich and savory stew.",category:"food",sprite:"sprites/items/food/fish_stew.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:0,healAmount:50,staminaRestore:40,foodCategory:"balanced",dietDuration:300,dietHpBonus:25,dietStaminaBonus:20},{id:"farmers_feast",name:"Farmers Feast",description:"The ultimate meal for a hard day.",category:"food",sprite:"sprites/items/food/farmers_feast.png",maxStack:99,sellPrice:400,buyPrice:1e3,rarity:0,healAmount:100,staminaRestore:100,foodCategory:"hearty",dietDuration:360,dietHpBonus:60,dietStaminaBonus:30},{id:"grilled_corn",name:"Grilled Corn",description:"Charred corn on the cob. Simple and tasty.",category:"food",sprite:"sprites/items/food/grilled_corn.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0,healAmount:20,staminaRestore:10},{id:"tomato_sauce",name:"Tomato Sauce",description:"Rich tomato sauce. Great base for recipes.",category:"food",sprite:"sprites/items/food/tomato_sauce.png",maxStack:99,sellPrice:55,buyPrice:138,rarity:0,healAmount:30,staminaRestore:15},{id:"fruit_salad",name:"Fruit Salad",description:"Fresh mixed fruits. Light and refreshing.",category:"food",sprite:"sprites/items/food/fruit_salad.png",maxStack:99,sellPrice:90,buyPrice:225,rarity:0,healAmount:35,staminaRestore:50,foodCategory:"energizing",dietDuration:240,dietHpBonus:10,dietStaminaBonus:35},{id:"spicy_eel",name:"Spicy Eel",description:"Eel with a kick. Boosts speed and luck.",category:"food",sprite:"sprites/items/food/spicy_eel.png",maxStack:99,sellPrice:175,buyPrice:438,rarity:0,healAmount:45,staminaRestore:30},{id:"roasted_venison",name:"Roasted Venison",description:"Perfectly roasted deer meat. A tavern favorite.",category:"food",sprite:"sprites/items/food/roasted_venison.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,healAmount:70,staminaRestore:45,foodCategory:"hearty",dietDuration:300,dietHpBonus:35,dietStaminaBonus:10},{id:"meat_stew",name:"Hearty Meat Stew",description:"A rich stew with chunks of tender meat and vegetables.",category:"food",sprite:"sprites/items/food/meat_stew.png",maxStack:99,sellPrice:180,buyPrice:450,rarity:0,healAmount:80,staminaRestore:50,foodCategory:"hearty",dietDuration:300,dietHpBonus:40,dietStaminaBonus:10},{id:"rabbit_pie",name:"Rabbit Pie",description:"A savory pie with rabbit meat filling. Comforting.",category:"food",sprite:"sprites/items/food/rabbit_pie.png",maxStack:99,sellPrice:220,buyPrice:550,rarity:0,healAmount:75,staminaRestore:55,foodCategory:"balanced",dietDuration:300,dietHpBonus:30,dietStaminaBonus:25},{id:"grilled_boar",name:"Grilled Wild Boar",description:"Smoky grilled boar meat. Filling and delicious.",category:"food",sprite:"sprites/items/food/grilled_boar.png",maxStack:99,sellPrice:175,buyPrice:438,rarity:0,healAmount:65,staminaRestore:40,foodCategory:"hearty",dietDuration:240,dietHpBonus:30,dietStaminaBonus:10},{id:"honey_glazed_ham",name:"Honey Glazed Ham",description:"Sweet and savory ham with a honey glaze.",category:"food",sprite:"sprites/items/food/honey_glazed_ham.png",maxStack:99,sellPrice:250,buyPrice:625,rarity:0,healAmount:85,staminaRestore:60,foodCategory:"hearty",dietDuration:300,dietHpBonus:40,dietStaminaBonus:15},{id:"hunters_platter",name:"Hunter's Platter",description:"An assortment of grilled wild meats. Premium tavern fare.",category:"food",sprite:"sprites/items/food/hunters_platter.png",maxStack:99,sellPrice:350,buyPrice:875,rarity:0,healAmount:100,staminaRestore:80,foodCategory:"hearty",dietDuration:360,dietHpBonus:50,dietStaminaBonus:20},{id:"mushroom_risotto",name:"Mushroom Risotto",description:"Creamy risotto with wild forest mushrooms.",category:"food",sprite:"sprites/items/food/mushroom_risotto.png",maxStack:99,sellPrice:160,buyPrice:400,rarity:0,healAmount:55,staminaRestore:35,foodCategory:"balanced",dietDuration:270,dietHpBonus:25,dietStaminaBonus:20},{id:"baked_potato",name:"Loaded Baked Potato",description:"A fluffy baked potato with all the toppings.",category:"food",sprite:"sprites/items/food/baked_potato.png",maxStack:99,sellPrice:90,buyPrice:225,rarity:0,healAmount:45,staminaRestore:25},{id:"corn_chowder",name:"Corn Chowder",description:"Creamy corn soup. Warming and delicious.",category:"food",sprite:"sprites/items/food/corn_chowder.png",maxStack:99,sellPrice:110,buyPrice:275,rarity:0,healAmount:50,staminaRestore:30},{id:"tomato_soup",name:"Tomato Soup",description:"Classic tomato soup with herbs.",category:"food",sprite:"sprites/items/food/tomato_soup.png",maxStack:99,sellPrice:85,buyPrice:213,rarity:0,healAmount:35,staminaRestore:20},{id:"grilled_fish",name:"Grilled Fish",description:"Simply grilled fish with lemon.",category:"food",sprite:"sprites/items/food/grilled_fish.png",maxStack:99,sellPrice:95,buyPrice:238,rarity:0,healAmount:45,staminaRestore:30},{id:"stuffed_peppers",name:"Stuffed Peppers",description:"Peppers stuffed with rice and meat.",category:"food",sprite:"sprites/items/food/stuffed_peppers.png",maxStack:99,sellPrice:140,buyPrice:350,rarity:0,healAmount:55,staminaRestore:35},{id:"ale",name:"Ale",description:"A refreshing mug of ale. Boosts courage.",category:"food",sprite:"sprites/items/food/ale.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,healAmount:5,staminaRestore:20},{id:"mead",name:"Honey Mead",description:"Sweet honey wine. Traditional and warming.",category:"food",sprite:"sprites/items/food/mead.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,healAmount:10,staminaRestore:30},{id:"wine",name:"Red Wine",description:"Fine wine aged in oak barrels.",category:"food",sprite:"sprites/Food/food_item_0090.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:0,healAmount:5,staminaRestore:25},{id:"cider",name:"Apple Cider",description:"Fresh pressed apple cider.",category:"food",sprite:"sprites/items/food/cider.png",maxStack:99,sellPrice:75,buyPrice:188,rarity:0,healAmount:15,staminaRestore:25},{id:"hot_cocoa",name:"Hot Cocoa",description:"Rich hot chocolate. Perfect for cold nights.",category:"food",sprite:"sprites/items/food/hot_cocoa.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,healAmount:20,staminaRestore:35},{id:"herbal_tea",name:"Herbal Tea",description:"Soothing tea made from wild herbs.",category:"food",sprite:"sprites/items/food/herbal_tea.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,healAmount:5,staminaRestore:40,foodCategory:"energizing",dietDuration:240,dietHpBonus:5,dietStaminaBonus:30},{id:"aged_ale",name:"Aged Ale",description:"Ale aged for 3 days. Smooth and complex.",category:"food",sprite:"sprites/items/food/aged_ale.png",maxStack:99,sellPrice:125,buyPrice:313,rarity:0,healAmount:10,staminaRestore:40},{id:"fine_wine",name:"Fine Wine",description:"Premium aged wine with deep flavors.",category:"food",sprite:"sprites/items/food/fine_wine.png",maxStack:99,sellPrice:450,buyPrice:1125,rarity:0,healAmount:10,staminaRestore:50},{id:"vintage_mead",name:"Vintage Mead",description:"Rare mead aged to perfection. A true delicacy.",category:"food",sprite:"sprites/items/food/vintage_mead.png",maxStack:99,sellPrice:400,buyPrice:1e3,rarity:0,healAmount:15,staminaRestore:60},{id:"special_cider",name:"Spiced Cider",description:"Cider infused with warming spices.",category:"food",sprite:"sprites/items/food/special_cider.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:0,healAmount:25,staminaRestore:45},{id:"fruit_tart",name:"Fruit Tart",description:"A delicate pastry with fresh fruits.",category:"food",sprite:"sprites/items/food/fruit_tart.png",maxStack:99,sellPrice:130,buyPrice:325,rarity:0,healAmount:40,staminaRestore:30},{id:"berry_pie",name:"Berry Pie",description:"Sweet pie filled with mixed berries.",category:"food",sprite:"sprites/items/food/berry_pie.png",maxStack:99,sellPrice:145,buyPrice:363,rarity:0,healAmount:50,staminaRestore:35},{id:"honey_cake",name:"Honey Cake",description:"Moist cake sweetened with pure honey.",category:"food",sprite:"sprites/items/food/honey_cake.png",maxStack:99,sellPrice:175,buyPrice:438,rarity:0,healAmount:45,staminaRestore:40},{id:"cheese_wheel",name:"Aged Cheese",description:"Properly aged cheese. Rich flavor.",category:"food",sprite:"sprites/items/food/cheese_wheel.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,healAmount:35,staminaRestore:20},{id:"adventurers_meal",name:"Adventurer's Meal",description:"A hearty meal that prepares you for anything.",category:"food",sprite:"sprites/items/food/adventurers_meal.png",maxStack:99,sellPrice:300,buyPrice:750,rarity:0,healAmount:90,staminaRestore:70,foodCategory:"balanced",dietDuration:360,dietHpBonus:45,dietStaminaBonus:20},{id:"miners_special",name:"Miner's Special",description:"Energy-rich meal for long mining sessions.",category:"food",sprite:"sprites/items/food/miners_special.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,healAmount:75,staminaRestore:100,foodCategory:"energizing",dietDuration:300,dietHpBonus:15,dietStaminaBonus:50},{id:"fishermans_breakfast",name:"Fisherman's Breakfast",description:"Start your fishing day right.",category:"food",sprite:"sprites/items/food/fishermans_breakfast.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:0,healAmount:60,staminaRestore:50,foodCategory:"energizing",dietDuration:300,dietHpBonus:15,dietStaminaBonus:30},{id:"cooked_fish",name:"Cooked Fish",description:"Charred over an open flame until the flesh falls from the bone. Simple sustenance in dark times.",category:"food",sprite:"sprites/items/food/cooked_fish.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,healAmount:40,staminaRestore:25,foodCategory:"balanced",dietDuration:240,dietHpBonus:20,dietStaminaBonus:15},{id:"healing_salve",name:"Healing Salve",description:"A thick paste of herbs and rendered fat. It stings like fire but knits flesh together.",category:"food",sprite:"sprites/items/food/healing_salve.png",maxStack:20,sellPrice:80,buyPrice:200,rarity:0,healAmount:50,staminaRestore:0},{id:"ancient_wine_gold",name:"Ancient Wine (Gold)",description:"A bottle of wine aged for centuries in a sealed crypt. Its taste carries memories of a forgotten age.",category:"food",sprite:"sprites/items/food/ancient_wine_gold.png",maxStack:99,sellPrice:2e3,buyPrice:5e3,rarity:2,healAmount:30,staminaRestore:80,foodCategory:"special",dietDuration:300,dietHpBonus:20,dietStaminaBonus:40},{id:"wild_plum",name:"Wild Plum",description:"A dark-skinned fruit with tart flesh. One of few sweet things left in this forsaken land.",category:"food",sprite:"sprites/items/food/wild_plum.png",maxStack:99,sellPrice:40,buyPrice:100,rarity:0,healAmount:20,staminaRestore:10},{id:"hazelnut",name:"Hazelnut",description:"A hard-shelled nut gathered from skeletal autumn trees. Cracks like tiny bones between your teeth.",category:"food",sprite:"sprites/items/food/hazelnut.png",maxStack:99,sellPrice:45,buyPrice:113,rarity:0,healAmount:15,staminaRestore:10},{id:"blackberry",name:"Blackberry",description:"Dark as dried blood, these thorny berries grow along forgotten paths through cursed brambles.",category:"food",sprite:"sprites/items/food/blackberry.png",maxStack:99,sellPrice:25,buyPrice:63,rarity:0,healAmount:15,staminaRestore:10},{id:"crystal_fruit",name:"Crystal Fruit",description:"A translucent fruit that grows on crystallized branches. It hums with trapped arcane energy.",category:"food",sprite:"sprites/items/food/crystal_fruit.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:2,healAmount:25,staminaRestore:20},{id:"snow_yam",name:"Snow Yam",description:"A pale tuber buried beneath cursed snowdrifts. Its flesh stays cold even when cooked.",category:"food",sprite:"sprites/items/food/snow_yam.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,healAmount:25,staminaRestore:0},{id:"cactus_fruit",name:"Cactus Fruit",description:"A spiny desert fruit filled with bitter juice. Quenches thirst in the wasteland sun.",category:"food",sprite:"sprites/items/food/cactus_fruit.png",maxStack:99,sellPrice:120,buyPrice:300,rarity:0,healAmount:35,staminaRestore:15},{id:"cave_carrot",name:"Cave Carrot",description:"An orange root pulled from lightless caverns. Glows faintly in the dark with bioluminescence.",category:"food",sprite:"sprites/items/food/cave_carrot.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,healAmount:25,staminaRestore:0},{id:"cheese",name:"Cheese",description:"A wheel of cow's milk cheese, aged to perfection. Sustains even in the darkest times.",category:"food",sprite:"sprites/items/food/cheese.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,healAmount:35,staminaRestore:25},{id:"goat_cheese",name:"Goat Cheese",description:"Aged cheese with a sharp, tangy bite. A delicacy traded among desperate survivors.",category:"food",sprite:"sprites/items/food/goat_cheese.png",maxStack:99,sellPrice:250,buyPrice:625,rarity:0,healAmount:30,staminaRestore:20},{id:"truffle_oil",name:"Truffle Oil",description:"A luxurious oil pressed from rare underground truffles. Its aroma pierces even the foulest miasma.",category:"food",sprite:"sprites/items/food/truffle_oil.png",maxStack:99,sellPrice:500,buyPrice:1250,rarity:0,healAmount:15,staminaRestore:30},{id:"jelly",name:"Jelly",description:"Preserved fruit spread that wobbles like something alive. Tastes of forgotten orchards.",category:"food",sprite:"sprites/items/food/jelly.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,healAmount:25,staminaRestore:15},{id:"apricot",name:"Apricot",description:"A golden fruit with velvety skin. Its sweetness is a fleeting mercy in the wasteland.",category:"food",sprite:"sprites/items/food/apricot.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,healAmount:15,staminaRestore:10},{id:"orange",name:"Orange",description:"A vibrant citrus fruit that defies the gloom. Its juice stings cracked lips but restores vigor.",category:"food",sprite:"sprites/items/food/orange.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,healAmount:20,staminaRestore:15},{id:"peach",name:"Peach",description:"A blushing fruit with tender flesh. A rare indulgence salvaged from abandoned orchards.",category:"food",sprite:"sprites/items/food/peach.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,healAmount:20,staminaRestore:15},{id:"pomegranate",name:"Pomegranate",description:"A blood-red fruit filled with jewel-like seeds. Said to bind the souls of those who eat them.",category:"food",sprite:"sprites/items/food/pomegranate.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,healAmount:25,staminaRestore:20},{id:"cherry",name:"Cherry",description:"A small, crimson fruit as red as fresh blood. Tart and dangerously addictive.",category:"food",sprite:"sprites/items/food/cherry.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,healAmount:15,staminaRestore:10},{id:"autumn_bounty",name:"Autumn Bounty",description:"A feast cobbled from the last harvest. Rich flavors mask the dread of the coming winter.",category:"food",sprite:"sprites/items/food/autumn_bounty.png",maxStack:99,sellPrice:300,buyPrice:750,rarity:0,healAmount:50,staminaRestore:40},{id:"warp_totem_beach",name:"Warp Totem: Beach",description:"A carved totem that tears open a rift to the shore. The salt air tastes of freedom.",category:"food",sprite:"sprites/items/food/warp_totem_beach.png",maxStack:20,sellPrice:150,buyPrice:375,rarity:0,healAmount:0,staminaRestore:30},{id:"dish_o_the_sea",name:"Dish o' The Sea",description:"A hearty seafood stew made from the ocean's bounty. Warms the soul against the abyss.",category:"food",sprite:"sprites/items/food/dish_o_the_sea.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,healAmount:45,staminaRestore:35},{id:"chocolate_cake",name:"Chocolate Cake",description:"A decadent cake baked from hoarded cocoa. A taste of the old world's indulgence.",category:"food",sprite:"sprites/items/food/chocolate_cake.png",maxStack:99,sellPrice:250,buyPrice:625,rarity:0,healAmount:40,staminaRestore:50},{id:"coffee",name:"Coffee",description:"A strong, dark brew that clears the fog of exhaustion. Essential for long nights in hostile territory.",category:"food",sprite:"sprites/items/food/coffee.png",maxStack:99,sellPrice:150,buyPrice:375,rarity:0,healAmount:5,staminaRestore:50},{id:"stardrop_tea",name:"Stardrop Tea",description:"A shimmering brew distilled from fallen starlight. One sip and your soul expands beyond mortal limits.",category:"food",sprite:"sprites/items/food/stardrop_tea.png",maxStack:99,sellPrice:5e3,buyPrice:12500,rarity:0,healAmount:30,staminaRestore:100},{id:"magic_rock_candy",name:"Magic Rock Candy",description:"Crystallized sugar infused with raw arcane force. Your veins glow as the magic courses through.",category:"food",sprite:"sprites/items/food/magic_rock_candy.png",maxStack:99,sellPrice:3e3,buyPrice:7500,rarity:0,healAmount:20,staminaRestore:80},{id:"golden_pumpkin",name:"Golden Pumpkin",description:"A pumpkin plated in pure gold. Whether cursed treasure or sacred relic, none can say.",category:"food",sprite:"sprites/items/food/golden_pumpkin.png",maxStack:99,sellPrice:2e3,buyPrice:5e3,rarity:1,healAmount:50,staminaRestore:60},{id:"haven_blessing",name:"Haven Blessing",description:"A consecrated elixir from the last standing temple. Mends flesh and spirit alike.",category:"food",sprite:"sprites/items/food/haven_blessing.png",maxStack:99,sellPrice:300,buyPrice:750,rarity:0,healAmount:50,staminaRestore:50,foodCategory:"special",dietDuration:300,dietHpBonus:30,dietStaminaBonus:30},{id:"druids_blessing",name:"Druid's Blessing",description:"A poultice brewed by the last druids. Nature's final gift to a dying, forsaken world.",category:"food",sprite:"sprites/items/food/druids_blessing.png",maxStack:99,sellPrice:350,buyPrice:875,rarity:0,healAmount:40,staminaRestore:60},{id:"holy_water",name:"Holy Water",description:"Blessed water that sears the unholy. A single vial can turn the tide against the darkness.",category:"food",sprite:"sprites/items/food/holy_water.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,healAmount:60,staminaRestore:0},{id:"cherry_blossom",name:"Cherry Blossom",description:"A fragile pink petal from a tree that blooms once a year. Its beauty is painfully brief.",category:"food",sprite:"sprites/items/food/cherry_blossom.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,healAmount:10,staminaRestore:15},{id:"coconut",name:"Coconut",description:"A hard-shelled tropical fruit washed ashore from warmer, unblighted shores far away.",category:"food",sprite:"sprites/items/food/coconut.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,healAmount:20,staminaRestore:15},{id:"maple_syrup_gold",name:"Golden Maple Syrup",description:"A rare amber syrup aged in enchanted barrels. Each drop is liquid gold and liquid hope.",category:"food",sprite:"sprites/items/food/maple_syrup_gold.png",maxStack:99,sellPrice:500,buyPrice:1250,rarity:1,healAmount:20,staminaRestore:30},{id:"birthday_cake",name:"Birthday Cake",description:"A lovingly baked cake. Celebrating survival is the greatest act of defiance against the dark.",category:"food",sprite:"sprites/items/food/birthday_cake.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,healAmount:50,staminaRestore:50},{id:"cookie",name:"Cookie",description:"A small, crumbly biscuit baked from precious flour. Simple comfort in an uncomforting world.",category:"food",sprite:"sprites/items/food/cookie.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0,healAmount:15,staminaRestore:20}],En=[{id:"sword",name:"Rusty Sword",description:"A basic sword for combat",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00001.png",maxStack:1,sellPrice:50,buyPrice:125,rarity:0,weaponType:p.Sword,damage:10,attackSpeed:1,critChance:.05,critMult:1.5,range:1},{id:"dagger",name:"Dagger",description:"A small but quick blade. Fast attacks compensate for lower damage.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00010.png",maxStack:1,sellPrice:35,buyPrice:88,rarity:0,weaponType:p.Sword,damage:8,attackSpeed:1.5,critChance:.05,critMult:1.5,range:1},{id:"shadow_blade",name:"Shadow Blade",description:"A blade forged from pure darkness. Strikes deal bonus shadow damage.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00050.png",maxStack:1,sellPrice:8e3,buyPrice:2e4,rarity:0,weaponType:p.Sword,damage:45,attackSpeed:1.3,critChance:.05,critMult:1.5,range:1},{id:"empress_staff",name:"Empress Staff",description:"The staff of the Void Empress. Reality bends around its strikes.",category:"weapon",sprite:"sprites/items/weapon/empress_staff.png",maxStack:1,sellPrice:5e4,buyPrice:125e3,rarity:0,weaponType:p.Staff,damage:75,attackSpeed:1,critChance:.05,critMult:1.5,range:1},{id:"galaxy_sword",name:"Galaxy Sword",description:"A legendary blade forged from stardust and prismatic shards.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00100.png",maxStack:1,sellPrice:35e3,buyPrice:87500,rarity:5,weaponType:p.Sword,damage:60,attackSpeed:1.2,critChance:.05,critMult:1.5,range:1},{id:"battle_axe",name:"Battle Axe",description:"A heavy axe designed for combat. Slow but devastating.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00020.png",maxStack:1,sellPrice:75,buyPrice:188,rarity:0,weaponType:p.Axe,damage:15,attackSpeed:.7,critChance:.05,critMult:1.5,range:1},{id:"iron_spear",name:"Iron Spear",description:"A long spear with excellent reach. Keep enemies at bay.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00030.png",maxStack:1,sellPrice:60,buyPrice:150,rarity:1,weaponType:p.Spear,damage:12,attackSpeed:.9,critChance:.05,critMult:1.5,range:1.5},{id:"hunting_bow",name:"Hunting Bow",description:"A sturdy bow for ranged combat. Requires arrows.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00040.png",maxStack:1,sellPrice:100,buyPrice:250,rarity:0,weaponType:p.Bow,damage:8,attackSpeed:.8,critChance:.05,critMult:1.5,range:3},{id:"oak_staff",name:"Oak Staff",description:"A magical staff carved from ancient oak. Channels arcane power.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00060.png",maxStack:1,sellPrice:80,buyPrice:200,rarity:0,weaponType:p.Staff,damage:10,attackSpeed:1.1,critChance:.05,critMult:1.5,range:1},{id:"iron_sword",name:"Iron Sword",description:"A well-forged iron blade. Reliable and sharp.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00002.png",maxStack:1,sellPrice:150,buyPrice:375,rarity:1,weaponType:p.Sword,damage:15,attackSpeed:1,critChance:.05,critMult:1.5,range:1},{id:"steel_sword",name:"Steel Sword",description:"A finely crafted steel blade. Superior durability.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00003.png",maxStack:1,sellPrice:400,buyPrice:1e3,rarity:1,weaponType:p.Sword,damage:22,attackSpeed:1,critChance:.05,critMult:1.5,range:1},{id:"obsidian_blade",name:"Obsidian Blade",description:"A blade of volcanic glass. Razor sharp but brittle.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00004.png",maxStack:1,sellPrice:800,buyPrice:2e3,rarity:2,weaponType:p.Sword,damage:30,attackSpeed:1.1,critChance:.15,critMult:1.5,range:1},{id:"frost_edge",name:"Frost Edge",description:"A blade forged from eternal ice. +75% damage to frozen targets.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00005.png",maxStack:1,sellPrice:1500,buyPrice:3750,rarity:2,weaponType:p.Sword,damage:35,attackSpeed:.95,critChance:.05,critMult:1.5,range:1,bonusVsStatus:"freeze",synergyMult:1.75},{id:"infernal_blade",name:"Infernal Blade",description:"A blade wreathed in flames. +60% damage to burning targets.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00006.png",maxStack:1,sellPrice:2e3,buyPrice:5e3,rarity:2,weaponType:p.Sword,damage:38,attackSpeed:1,critChance:.05,critMult:1.5,range:1,bonusVsStatus:"burn",synergyMult:1.6},{id:"soul_reaper",name:"Soul Reaper",description:"A cursed blade that feeds on souls. Heals on kill.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00007.png",maxStack:1,sellPrice:5e3,buyPrice:12500,rarity:3,weaponType:p.Sword,damage:45,attackSpeed:1,critChance:.05,critMult:1.5,range:1},{id:"iron_battle_axe",name:"Iron Battle Axe",description:"A heavy iron axe. Slow but powerful.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00021.png",maxStack:1,sellPrice:200,buyPrice:500,rarity:1,weaponType:p.Axe,damage:20,attackSpeed:.7,critChance:.05,critMult:1.5,range:1},{id:"steel_greataxe",name:"Steel Greataxe",description:"A massive two-handed axe. Devastating cleaves.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00022.png",maxStack:1,sellPrice:500,buyPrice:1250,rarity:1,weaponType:p.Axe,damage:28,attackSpeed:.65,critChance:.05,critMult:1.5,range:1},{id:"berserker_axe",name:"Berserker Axe",description:"An axe that grows stronger as you take damage.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00023.png",maxStack:1,sellPrice:1200,buyPrice:3e3,rarity:2,weaponType:p.Axe,damage:35,attackSpeed:.7,critChance:.05,critMult:1.5,range:1},{id:"volcanic_cleaver",name:"Volcanic Cleaver",description:"An axe forged in magma. Ignites enemies on critical hits.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00024.png",maxStack:1,sellPrice:2500,buyPrice:6250,rarity:2,weaponType:p.Axe,damage:42,attackSpeed:.65,critChance:.2,critMult:1.5,range:1},{id:"executioners_axe",name:"Executioner's Axe",description:"Deals massive damage. +100% damage to bleeding targets.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00025.png",maxStack:1,sellPrice:6e3,buyPrice:15e3,rarity:3,weaponType:p.Axe,damage:50,attackSpeed:.6,critChance:.05,critMult:1.5,range:1,bonusVsStatus:"bleed",synergyMult:2},{id:"wooden_spear",name:"Wooden Spear",description:"A simple wooden spear. Good reach for beginners.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00031.png",maxStack:1,sellPrice:40,buyPrice:100,rarity:0,weaponType:p.Spear,damage:8,attackSpeed:.9,critChance:.05,critMult:1.5,range:1.5},{id:"steel_lance",name:"Steel Lance",description:"A long steel lance. Excellent reach.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00032.png",maxStack:1,sellPrice:350,buyPrice:875,rarity:1,weaponType:p.Spear,damage:18,attackSpeed:.85,critChance:.05,critMult:1.5,range:1.8},{id:"serpent_spear",name:"Serpent Spear",description:"A poisoned spear. +80% damage to poisoned targets.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00033.png",maxStack:1,sellPrice:900,buyPrice:2250,rarity:2,weaponType:p.Spear,damage:22,attackSpeed:.9,critChance:.05,critMult:1.5,range:1.6,bonusVsStatus:"poison",synergyMult:1.8},{id:"glacial_pike",name:"Glacial Pike",description:"An ice-tipped pike. +70% damage to frozen targets.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00034.png",maxStack:1,sellPrice:1800,buyPrice:4500,rarity:2,weaponType:p.Spear,damage:28,attackSpeed:.85,critChance:.05,critMult:1.5,range:2,bonusVsStatus:"freeze",synergyMult:1.7},{id:"dragonslayer_lance",name:"Dragonslayer Lance",description:"A legendary lance made for slaying dragons.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00035.png",maxStack:1,sellPrice:7e3,buyPrice:17500,rarity:4,weaponType:p.Spear,damage:40,attackSpeed:.8,critChance:.05,critMult:1.5,range:2.2},{id:"short_bow",name:"Short Bow",description:"A small bow. Quick to draw but low range.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00041.png",maxStack:1,sellPrice:60,buyPrice:150,rarity:0,weaponType:p.Bow,damage:6,attackSpeed:1,critChance:.05,critMult:1.5,range:2.5},{id:"longbow",name:"Longbow",description:"A powerful longbow with excellent range.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00042.png",maxStack:1,sellPrice:300,buyPrice:750,rarity:0,weaponType:p.Bow,damage:12,attackSpeed:.75,critChance:.05,critMult:1.5,range:4},{id:"composite_bow",name:"Composite Bow",description:"A bow made of layered materials. Powerful and accurate.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00043.png",maxStack:1,sellPrice:750,buyPrice:1875,rarity:1,weaponType:p.Bow,damage:16,attackSpeed:.8,critChance:.1,critMult:1.5,range:3.5},{id:"elven_bow",name:"Elven Bow",description:"A graceful bow of elven make. Swift and deadly.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00044.png",maxStack:1,sellPrice:2e3,buyPrice:5e3,rarity:2,weaponType:p.Bow,damage:20,attackSpeed:.9,critChance:.15,critMult:1.5,range:4.5},{id:"phoenix_bow",name:"Phoenix Bow",description:"A bow blessed by fire. +65% damage to burning targets.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00045.png",maxStack:1,sellPrice:5500,buyPrice:13750,rarity:3,weaponType:p.Bow,damage:25,attackSpeed:.85,critChance:.05,critMult:1.5,range:4,bonusVsStatus:"burn",synergyMult:1.65},{id:"apprentice_staff",name:"Apprentice Staff",description:"A simple staff for those learning magic.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00061.png",maxStack:1,sellPrice:50,buyPrice:125,rarity:0,weaponType:p.Staff,damage:7,attackSpeed:1.2,critChance:.05,critMult:1.5,range:1},{id:"crystal_staff",name:"Crystal Staff",description:"A staff topped with a focusing crystal.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00062.png",maxStack:1,sellPrice:400,buyPrice:1e3,rarity:2,weaponType:p.Staff,damage:15,attackSpeed:1.1,critChance:.05,critMult:1.5,range:1},{id:"staff_of_frost",name:"Staff of Frost",description:"Channels ice magic. +70% damage to frozen targets.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00063.png",maxStack:1,sellPrice:1200,buyPrice:3e3,rarity:2,weaponType:p.Staff,damage:20,attackSpeed:1,critChance:.05,critMult:1.5,range:1,bonusVsStatus:"freeze",synergyMult:1.7},{id:"staff_of_flames",name:"Staff of Flames",description:"Burns with eternal fire. Ignites foes.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00064.png",maxStack:1,sellPrice:1500,buyPrice:3750,rarity:0,weaponType:p.Staff,damage:25,attackSpeed:1,critChance:.05,critMult:1.5,range:1},{id:"necromancers_rod",name:"Necromancer's Rod",description:"Drains life from enemies to heal the wielder.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00065.png",maxStack:1,sellPrice:3500,buyPrice:8750,rarity:3,weaponType:p.Staff,damage:30,attackSpeed:.95,critChance:.05,critMult:1.5,range:1},{id:"archmage_staff",name:"Archmage Staff",description:"The pinnacle of magical weaponry.",category:"weapon",sprite:"sprites/Items/Weapons/item_weapon_00066.png",maxStack:1,sellPrice:8e3,buyPrice:2e4,rarity:3,weaponType:p.Staff,damage:40,attackSpeed:1.1,critChance:.2,critMult:1.5,range:1},{id:"gold_sword",name:"Gold Sword",description:"A gilded blade that gleams with cursed opulence. Its edge hungers for blood more than glory.",category:"weapon",sprite:"sprites/items/weapon/gold_sword.png",maxStack:1,sellPrice:800,buyPrice:2e3,rarity:1,weaponType:p.Sword,damage:28,attackSpeed:1,critChance:.05,critMult:1.5,range:1},{id:"bone_club",name:"Bone Club",description:"A brutal cudgel. +50% damage to stunned targets.",category:"weapon",sprite:"sprites/items/weapon/bone_club.png",maxStack:1,sellPrice:350,buyPrice:875,rarity:0,weaponType:p.Hammer,damage:18,attackSpeed:.8,critChance:.05,critMult:1.5,range:1,bonusVsStatus:"stun",synergyMult:1.5},{id:"void_dagger",name:"Void Dagger",description:"A sliver of nothingness given form. It cuts not flesh but the threads of existence itself.",category:"weapon",sprite:"sprites/items/weapon/void_dagger.png",maxStack:1,sellPrice:2500,buyPrice:6250,rarity:2,weaponType:p.Dagger,damage:45,attackSpeed:1.8,critChance:.05,critMult:1.5,range:1},{id:"frost_spear",name:"Frost Spear",description:"Forged in the heart of an eternal blizzard. Frost creeps along its shaft, freezing the air around it.",category:"weapon",sprite:"sprites/items/weapon/frost_spear.png",maxStack:1,sellPrice:1800,buyPrice:4500,rarity:2,weaponType:p.Spear,damage:35,attackSpeed:.9,critChance:.05,critMult:1.5,range:1.5},{id:"iron_arrows",name:"Iron Arrows",description:"Arrows tipped with cold iron. They punch through hide and bone with merciless precision.",category:"weapon",sprite:"sprites/items/weapon/iron_arrows.png",maxStack:99,sellPrice:15,buyPrice:38,rarity:1,weaponType:p.Bow,damage:8,attackSpeed:1,critChance:.05,critMult:1.5,range:1},{id:"fire_arrows",name:"Fire Arrows",description:"Arrows wreathed in alchemical flame. They leave trails of cinder and screaming in their wake.",category:"weapon",sprite:"sprites/items/weapon/fire_arrows.png",maxStack:99,sellPrice:30,buyPrice:75,rarity:0,weaponType:p.Bow,damage:12,attackSpeed:1,critChance:.05,critMult:1.5,range:1},{id:"magic_staff",name:"Magic Staff",description:"A gnarled staff crackling with arcane force. Each strike channels raw magical devastation.",category:"weapon",sprite:"sprites/items/weapon/magic_staff.png",maxStack:1,sellPrice:1500,buyPrice:3750,rarity:0,weaponType:p.Staff,damage:30,attackSpeed:1,critChance:.05,critMult:1.5,range:1},{id:"legendary_sword",name:"Legendary Sword",description:"A blade spoken of only in whispers. It was forged in dragonfire and quenched in the tears of a god.",category:"weapon",sprite:"sprites/items/weapon/legendary_sword.png",maxStack:1,sellPrice:5e3,buyPrice:12500,rarity:4,weaponType:p.Sword,damage:55,attackSpeed:1.2,critChance:.05,critMult:1.5,range:1},{id:"neptune_trident",name:"Neptune's Trident",description:"The three-pronged spear of an ocean deity. Tidal fury surges through its coral-encrusted shaft.",category:"weapon",sprite:"sprites/items/weapon/neptune_trident.png",maxStack:1,sellPrice:8e3,buyPrice:2e4,rarity:3,weaponType:p.Spear,damage:50,attackSpeed:1,critChance:.05,critMult:1.5,range:1.5},{id:"infinity_blade",name:"Infinity Blade",description:"A weapon that exists outside time. Its edge is the boundary between what is and what will never be.",category:"weapon",sprite:"sprites/items/weapon/infinity_blade.png",maxStack:1,sellPrice:15e3,buyPrice:37500,rarity:5,weaponType:p.Sword,damage:75,attackSpeed:1.3,critChance:.05,critMult:1.5,range:1},{id:"dragonbane_sword",name:"Dragonbane Sword",description:"A blade tempered in dragon blood and blessed by dragonslayers of old. Wyrms recoil at its presence.",category:"weapon",sprite:"sprites/items/weapon/dragonbane_sword.png",maxStack:1,sellPrice:6e3,buyPrice:15e3,rarity:4,weaponType:p.Sword,damage:60,attackSpeed:1.1,critChance:.05,critMult:1.5,range:1},{id:"veteran_blade",name:"Veteran Blade",description:"A battle-worn sword carried through a hundred sieges. Its edge remembers every kill.",category:"weapon",sprite:"sprites/items/weapon/veteran_blade.png",maxStack:1,sellPrice:1200,buyPrice:3e3,rarity:0,weaponType:p.Sword,damage:35,attackSpeed:1,critChance:.05,critMult:1.5,range:1}],qn=[{id:"leather_armor",name:"Leather Armor",description:"Basic protection made of tanned leather.",category:"armor",sprite:"sprites/items/armor/leather_armor.png",maxStack:1,sellPrice:100,buyPrice:250,rarity:0,slot:"chest",defense:5,hp:0,stamina:0},{id:"chainmail",name:"Chainmail Armor",description:"Interlocking metal rings provide good protection.",category:"armor",sprite:"sprites/items/armor/chainmail.png",maxStack:1,sellPrice:500,buyPrice:1250,rarity:0,slot:"chest",defense:12,hp:0,stamina:0},{id:"plate_armor",name:"Plate Armor",description:"Heavy steel plates. Maximum protection.",category:"armor",sprite:"sprites/items/armor/plate_armor.png",maxStack:1,sellPrice:1500,buyPrice:3750,rarity:0,slot:"chest",defense:25,hp:0,stamina:0},{id:"shadow_cloak",name:"Shadow Cloak",description:"A cloak woven from shadows. Light protection but enhances stealth.",category:"armor",sprite:"sprites/items/armor/shadow_cloak.png",maxStack:1,sellPrice:2e3,buyPrice:5e3,rarity:0,slot:"chest",defense:8,hp:0,stamina:0},{id:"dragon_scale_armor",name:"Dragon Scale Armor",description:"Armor made from dragon scales. Fire resistant.",category:"armor",sprite:"sprites/items/armor/dragon_scale_armor.png",maxStack:1,sellPrice:1e4,buyPrice:25e3,rarity:3,slot:"chest",defense:35,hp:0,stamina:0},{id:"leather_cap",name:"Leather Cap",description:"A simple leather cap.",category:"armor",sprite:"sprites/items/armor/leather_cap.png",maxStack:1,sellPrice:50,buyPrice:125,rarity:0,slot:"head",defense:2,hp:0,stamina:0},{id:"iron_helm",name:"Iron Helm",description:"A sturdy iron helmet.",category:"armor",sprite:"sprites/items/armor/iron_helm.png",maxStack:1,sellPrice:300,buyPrice:750,rarity:1,slot:"head",defense:6,hp:0,stamina:0},{id:"crown_of_thorns",name:"Crown of Thorns",description:"A painful crown that reflects damage to attackers.",category:"armor",sprite:"sprites/items/armor/crown_of_thorns.png",maxStack:1,sellPrice:3e3,buyPrice:7500,rarity:0,slot:"head",defense:4,hp:0,stamina:0},{id:"iron_ring",name:"Iron Ring",description:"A simple iron ring. +2 defense. (1 notch)",category:"armor",sprite:"sprites/items/accessory/iron_ring.png",maxStack:1,sellPrice:100,buyPrice:250,rarity:0,slot:"ring",defense:2,hp:0,stamina:0,notchCost:1},{id:"ruby_ring",name:"Ruby Ring",description:"A ring set with a ruby. +5 damage but 2 defense. (1 notch)",category:"armor",sprite:"sprites/items/accessory/ruby_ring.png",maxStack:1,sellPrice:500,buyPrice:1250,rarity:0,slot:"ring",defense:0,hp:0,stamina:0,damage:5,notchCost:1,tradeoff:"-2 defense",tradeoffStat:"defense",tradeoffAmount:2},{id:"sapphire_ring",name:"Sapphire Ring",description:"A ring set with sapphire. +20 stamina. (1 notch)",category:"armor",sprite:"sprites/items/accessory/sapphire_ring.png",maxStack:1,sellPrice:500,buyPrice:1250,rarity:0,slot:"ring",defense:0,hp:0,stamina:20,notchCost:1},{id:"ring_of_vitality",name:"Ring of Vitality",description:"+25 HP but 10 stamina. (2 notches)",category:"armor",sprite:"sprites/items/accessory/ring_of_vitality.png",maxStack:1,sellPrice:1e3,buyPrice:2500,rarity:0,slot:"ring",defense:0,hp:25,stamina:0,notchCost:2,tradeoff:"-10 stamina",tradeoffStat:"stamina",tradeoffAmount:10},{id:"ring_of_hunger",name:"Ring of Hunger",description:"+3 damage, +0.05 attack speed. Costs life force. (2 notches)",category:"armor",sprite:"sprites/items/accessory/ring_of_hunger.png",maxStack:1,sellPrice:800,buyPrice:2e3,rarity:0,slot:"ring",defense:0,hp:0,stamina:0,damage:3,attackSpeed:.05,notchCost:2,tradeoff:"-15 hp",tradeoffStat:"hp",tradeoffAmount:15},{id:"lucky_pendant",name:"Lucky Pendant",description:"+8% crit chance. (2 notches)",category:"armor",sprite:"sprites/items/accessory/lucky_pendant.png",maxStack:1,sellPrice:750,buyPrice:1875,rarity:0,slot:"necklace",defense:0,hp:0,stamina:0,critChance:.08,notchCost:2},{id:"amulet_of_protection",name:"Amulet of Protection",description:"+8 defense, +15 HP. (2 notches)",category:"armor",sprite:"sprites/items/accessory/amulet_of_protection.png",maxStack:1,sellPrice:1500,buyPrice:3750,rarity:0,slot:"necklace",defense:8,hp:15,stamina:0,notchCost:2},{id:"vampiric_pendant",name:"Vampiric Pendant",description:"+8 damage, +0.3 crit mult but 5 defense. (3 notches)",category:"armor",sprite:"sprites/items/accessory/vampiric_pendant.png",maxStack:1,sellPrice:3e3,buyPrice:7500,rarity:0,slot:"necklace",defense:0,hp:0,stamina:0,damage:8,critMult:.3,notchCost:3,tradeoff:"-5 defense",tradeoffStat:"defense",tradeoffAmount:5},{id:"iron_armor",name:"Iron Armor",description:"Hammered iron plates scored with warding runes. The metal groans under the weight of old curses.",category:"armor",sprite:"sprites/items/armor/iron_armor.png",maxStack:1,sellPrice:600,buyPrice:1500,rarity:1,slot:"chest",defense:12,hp:0,stamina:0},{id:"bone_shield",name:"Bone Shield",description:"A shield woven from the ribcage of a nameless beast. It rattles with each blow it absorbs.",category:"armor",sprite:"sprites/items/armor/bone_shield.png",maxStack:1,sellPrice:450,buyPrice:1125,rarity:0,slot:"shield",defense:8,hp:0,stamina:0},{id:"wyrm_plate",name:"Wyrm Plate",description:"Scales of a slain wyrm hammered into unyielding plate. It smells of brimstone and ancient wrath.",category:"armor",sprite:"sprites/items/armor/wyrm_plate.png",maxStack:1,sellPrice:5e3,buyPrice:12500,rarity:2,slot:"chest",defense:25,hp:0,stamina:0},{id:"nightvision_goggles",name:"Nightvision Goggles",description:"Enchanted lenses that pierce the veil of darkness. The shadows have nowhere left to hide.",category:"armor",sprite:"sprites/items/equipment/nightvision_goggles.png",maxStack:1,sellPrice:1e3,buyPrice:2500,rarity:0,slot:"head",defense:0,hp:0,stamina:0},{id:"void_amulet",name:"Void Amulet",description:"+12 damage, +0.1 crit chance but 8 defense, 20 HP. The void hungers. (3 notches)",category:"armor",sprite:"sprites/items/accessory/void_amulet.png",maxStack:1,sellPrice:3e3,buyPrice:7500,rarity:2,slot:"necklace",defense:0,hp:0,stamina:0,damage:12,critChance:.1,notchCost:3,tradeoff:"-8 defense, -20 hp",tradeoffStat:"defense",tradeoffAmount:8},{id:"void_talisman",name:"Void Talisman",description:"+6 defense, +30 stamina. Shadows ward you. (2 notches)",category:"armor",sprite:"sprites/items/accessory/void_talisman.png",maxStack:1,sellPrice:2500,buyPrice:6250,rarity:2,slot:"necklace",defense:6,hp:0,stamina:30,notchCost:2},{id:"dragon_armor",name:"Dragon Armor",description:"Forged from the scales of an elder dragon. It radiates heat and ancient malice.",category:"armor",sprite:"sprites/items/armor/dragon_armor.png",maxStack:1,sellPrice:1e4,buyPrice:25e3,rarity:3,slot:"chest",defense:40,hp:0,stamina:0},{id:"prismatic_ring",name:"Prismatic Ring",description:"+10 damage, +0.15 crit, +0.5 crit mult. The ultimate ring. (3 notches)",category:"armor",sprite:"sprites/items/accessory/prismatic_ring.png",maxStack:1,sellPrice:5e3,buyPrice:12500,rarity:4,slot:"ring",defense:3,hp:15,stamina:10,damage:10,critChance:.15,critMult:.5,notchCost:3},{id:"celestial_orb",name:"Celestial Orb",description:"+15 damage, +50 HP, +0.2 crit, +0.1 atk spd. A dying star's blessing. (3 notches)",category:"armor",sprite:"sprites/items/accessory/celestial_orb.png",maxStack:1,sellPrice:8e3,buyPrice:2e4,rarity:5,slot:"necklace",defense:5,hp:50,stamina:25,damage:15,critChance:.2,attackSpeed:.1,notchCost:3},{id:"straw_hat",name:"Straw Hat",description:"A simple hat woven from dried grass. It offers little protection but shields you from the blinding sun.",category:"armor",sprite:"sprites/items/equipment/straw_hat.png",maxStack:1,sellPrice:200,buyPrice:500,rarity:0,slot:"head",defense:0,hp:0,stamina:0},{id:"sailor_cap",name:"Sailor Cap",description:"A weathered cap from a mariner who sailed waters best left uncharted. Salt-stained and faded.",category:"armor",sprite:"sprites/items/equipment/sailor_cap.png",maxStack:1,sellPrice:200,buyPrice:500,rarity:0,slot:"head",defense:0,hp:0,stamina:0},{id:"small_magnet_ring",name:"Small Magnet Ring",description:"+0.1 attack speed, +10 stamina. Items gravitate toward you. (1 notch)",category:"armor",sprite:"sprites/items/accessory/small_magnet_ring.png",maxStack:1,sellPrice:400,buyPrice:1e3,rarity:0,slot:"ring",defense:0,hp:0,stamina:10,attackSpeed:.1,notchCost:1},{id:"pearl_necklace",name:"Pearl Necklace",description:"+4 defense, +20 HP, +15 stamina. Sea spirits protect you. (2 notches)",category:"armor",sprite:"sprites/items/accessory/pearl_necklace.png",maxStack:1,sellPrice:2e3,buyPrice:5e3,rarity:0,slot:"necklace",defense:4,hp:20,stamina:15,notchCost:2}],ja=[{id:"pufferfish",name:"Pufferfish",description:"Handle with care - can be toxic!",category:"fish",sprite:"sprites/items/food/pufferfish.png",maxStack:99,sellPrice:200,buyPrice:500,rarity:0,difficulty:40,minSize:10,maxSize:25,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"legend",name:"The Legend",description:"A mythical fish of immense power.",category:"fish",sprite:"sprites/items/food/legend.png",maxStack:99,sellPrice:5e3,buyPrice:12500,rarity:4,difficulty:100,minSize:250,maxSize:625,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"crimsonfish",name:"Crimsonfish",description:"A fiery red legendary fish.",category:"fish",sprite:"sprites/items/food/crimsonfish.png",maxStack:99,sellPrice:4500,buyPrice:11250,rarity:2,difficulty:100,minSize:225,maxSize:563,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"glacierfish",name:"Glacierfish",description:"An icy blue legendary fish.",category:"fish",sprite:"sprites/items/food/glacierfish.png",maxStack:99,sellPrice:4e3,buyPrice:1e4,rarity:2,difficulty:100,minSize:200,maxSize:500,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"angler",name:"Angler",description:"A legendary fish of impossible size. Its bioluminescent lure glows with an otherworldly light.",category:"fish",sprite:"sprites/items/food/angler.png",maxStack:1,sellPrice:1500,buyPrice:3750,rarity:0,difficulty:80,minSize:75,maxSize:188,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"mutant_carp",name:"Mutant Carp",description:"A grotesque fish warped by toxic waters. Extra eyes stare blankly from its malformed body.",category:"fish",sprite:"sprites/items/food/mutant_carp.png",maxStack:1,sellPrice:1e3,buyPrice:2500,rarity:0,difficulty:60,minSize:50,maxSize:125,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"largemouth_bass",name:"Largemouth Bass",description:"A thick-bodied fish pulled from murky, stagnant waters. Best not eaten raw.",category:"fish",sprite:"sprites/items/food/largemouth_bass.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,difficulty:25,minSize:5,maxSize:13,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"shad",name:"Shad",description:"A silvery river fish that swims against cursed currents. Bony but abundant.",category:"fish",sprite:"sprites/items/food/shad.png",maxStack:99,sellPrice:45,buyPrice:113,rarity:0,difficulty:15,minSize:5,maxSize:13,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"tiger_trout",name:"Tiger Trout",description:"A rare hybrid with striking stripes. Born of unnatural waters, it fights like a demon on the line.",category:"fish",sprite:"sprites/items/food/tiger_trout.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,difficulty:25,minSize:5,maxSize:13,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"bullhead",name:"Bullhead",description:"A bottom-dwelling fish with a flat head and venomous spines. Handle with extreme care.",category:"fish",sprite:"sprites/items/food/bullhead.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0,difficulty:15,minSize:5,maxSize:13,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"tuna",name:"Tuna",description:"A powerful ocean fish that roams the deep. Its dense flesh is rich with dark iron.",category:"fish",sprite:"sprites/items/food/tuna.png",maxStack:99,sellPrice:120,buyPrice:300,rarity:0,difficulty:40,minSize:6,maxSize:15,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"red_snapper",name:"Red Snapper",description:"A crimson fish with sharp teeth. Caught in blood-warm shallows near volcanic vents.",category:"fish",sprite:"sprites/items/food/red_snapper.png",maxStack:99,sellPrice:80,buyPrice:200,rarity:0,difficulty:25,minSize:5,maxSize:13,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"tilapia",name:"Tilapia",description:"A hardy fish that survives in the most polluted waters. Tastes like mud and regret.",category:"fish",sprite:"sprites/items/food/tilapia.png",maxStack:99,sellPrice:60,buyPrice:150,rarity:0,difficulty:25,minSize:5,maxSize:13,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"ghostfish",name:"Ghostfish",description:"A translucent fish that glows with spectral light. Found in underground lakes of the dead.",category:"fish",sprite:"sprites/items/food/ghostfish.png",maxStack:99,sellPrice:75,buyPrice:188,rarity:0,difficulty:25,minSize:5,maxSize:13,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"sandfish",name:"Sandfish",description:"A burrowing desert fish that swims through sand like water. Its scales are like coarse glass.",category:"fish",sprite:"sprites/items/food/sandfish.png",maxStack:99,sellPrice:90,buyPrice:225,rarity:0,difficulty:25,minSize:5,maxSize:13,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"woodskip",name:"Woodskip",description:"A secretive forest fish found only in enchanted pools. Its flesh tastes of pine and sorrow.",category:"fish",sprite:"sprites/items/food/woodskip.png",maxStack:99,sellPrice:65,buyPrice:163,rarity:0,difficulty:25,minSize:5,maxSize:13,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]},{id:"exotic_fish",name:"Exotic Fish",description:"A bizarre fish from waters beyond the known world. Its scales shimmer with impossible colors.",category:"fish",sprite:"sprites/items/food/exotic_fish.png",maxStack:99,sellPrice:400,buyPrice:1e3,rarity:0,difficulty:60,minSize:20,maxSize:50,seasons:["spring","summer","fall","winter"],timeOfDay:["morning","afternoon","evening"],locations:["river","ocean"]}],Bn=[{id:"health_potion",name:"Health Potion",description:"Restores 50 health instantly.",category:"potion",sprite:"sprites/items/food/health_potion.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,effectType:"heal",effectDuration:0,effectMagnitude:50},{id:"stamina_potion",name:"Stamina Potion",description:"Restores 75 stamina instantly.",category:"potion",sprite:"sprites/items/food/stamina_potion.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0,effectType:"stamina",effectDuration:0,effectMagnitude:75},{id:"greater_health_potion",name:"Greater Health Potion",description:"A deep crimson draught brewed from bloodroot and grave moss. Mends even grievous wounds.",category:"potion",sprite:"sprites/items/food/greater_health_potion.png",maxStack:20,sellPrice:300,buyPrice:750,rarity:0,effectType:"heal",effectDuration:0,effectMagnitude:100},{id:"greater_stamina_potion",name:"Greater Stamina Potion",description:"A vivid green elixir that floods the body with desperate vitality. The crash comes later.",category:"potion",sprite:"sprites/items/food/greater_stamina_potion.png",maxStack:20,sellPrice:300,buyPrice:750,rarity:0,effectType:"stamina",effectDuration:0,effectMagnitude:120},{id:"frost_resistance_potion",name:"Frost Resistance Potion",description:"A shimmering blue tonic that coats the veins in warmth. The cold becomes a distant memory.",category:"potion",sprite:"sprites/items/food/frost_resistance_potion.png",maxStack:20,sellPrice:250,buyPrice:625,rarity:2,effectType:"frost_resistance",effectDuration:300,effectMagnitude:1},{id:"venom_antidote",name:"Venom Antidote",description:"A bitter concoction that burns the poison from your blood. The cure is almost worse than the bite.",category:"potion",sprite:"sprites/items/food/venom_antidote.png",maxStack:20,sellPrice:200,buyPrice:500,rarity:0,effectType:"cure_poison",effectDuration:0,effectMagnitude:1},{id:"berserker_elixir",name:"Berserker Elixir",description:"Distilled rage in a bottle. Your muscles scream and your vision narrows to nothing but the kill.",category:"potion",sprite:"sprites/items/food/berserker_elixir.png",maxStack:20,sellPrice:400,buyPrice:1e3,rarity:2,effectType:"damage_boost",effectDuration:180,effectMagnitude:1.5},{id:"ironhide_tonic",name:"Ironhide Tonic",description:"A metallic brew that hardens the skin to the consistency of boiled leather. Every movement aches.",category:"potion",sprite:"sprites/items/food/ironhide_tonic.png",maxStack:20,sellPrice:350,buyPrice:875,rarity:1,effectType:"defense_boost",effectDuration:180,effectMagnitude:1.5},{id:"nightsight_potion",name:"Nightsight Potion",description:"Brewed from the eyes of cave-dwelling creatures. The darkness opens up like a wound.",category:"potion",sprite:"sprites/items/food/nightsight_potion.png",maxStack:20,sellPrice:200,buyPrice:500,rarity:0,effectType:"night_vision",effectDuration:300,effectMagnitude:1},{id:"swiftness_potion",name:"Swiftness Potion",description:"A pale silver liquid that quickens the blood. The world slows while you become a blur.",category:"potion",sprite:"sprites/items/food/swiftness_potion.png",maxStack:20,sellPrice:250,buyPrice:625,rarity:0,effectType:"speed_boost",effectDuration:180,effectMagnitude:1.5},{id:"spirit_ward",name:"Spirit Ward",description:"Holy water blessed by a forgotten saint. It sears the ethereal and mends the living.",category:"potion",sprite:"sprites/items/food/spirit_ward.png",maxStack:20,sellPrice:500,buyPrice:1250,rarity:0,effectType:"spirit_ward",effectDuration:300,effectMagnitude:1},{id:"prismatic_elixir",name:"Prismatic Elixir",description:"A swirling rainbow draught that tastes of starlight and madness. Every cell in your body ignites.",category:"potion",sprite:"sprites/items/food/prismatic_elixir.png",maxStack:20,sellPrice:2e3,buyPrice:5e3,rarity:4,effectType:"all_stats",effectDuration:300,effectMagnitude:1.5},{id:"galaxy_tincture",name:"Galaxy Tincture",description:"Liquid cosmos distilled from the void between stars. To drink it is to be unmade and reborn.",category:"potion",sprite:"sprites/items/food/galaxy_tincture.png",maxStack:20,sellPrice:5e3,buyPrice:12500,rarity:5,effectType:"all_stats",effectDuration:600,effectMagnitude:2}],Fn=[{id:"seal_of_earth",name:"Seal of Earth",description:"An ancient seal inscribed with earth runes. One of three seals your grandmother placed to contain the corruption. It pulses with dormant power.",category:"quest",sprite:"sprites/items/misc/seal_of_earth.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0},{id:"seal_of_water",name:"Seal of Water",description:"An ancient seal inscribed with water runes. One of three seals your grandmother placed to contain the corruption. It shimmers with ancient magic.",category:"quest",sprite:"sprites/items/misc/seal_of_water.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0},{id:"seal_of_spirit",name:"Seal of Spirit",description:"An ancient seal inscribed with spirit runes. The final seal your grandmother placed. It glows with ethereal light, yearning to fulfill its purpose.",category:"quest",sprite:"sprites/items/misc/seal_of_spirit.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0},{id:"edilas_key",name:"EDILAS Key",description:"A golden key forged from the five biome artifacts. Opens the path to EDILAS.",category:"quest",sprite:"sprites/items/material/edilas_key.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:4},{id:"journal_fragment",name:"Journal Fragment",description:"A torn page from a traveler's journal. The ink is smeared with blood and rainwater.",category:"quest",sprite:"sprites/items/misc/journal_fragment.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0},{id:"journal_entry",name:"Journal Entry",description:"A complete journal page detailing horrors witnessed in the depths. The handwriting grows frantic.",category:"quest",sprite:"sprites/items/misc/journal_entry.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0},{id:"ancient_tablet",name:"Ancient Tablet",description:"A stone slab inscribed with a language predating all known civilizations. It hums when touched.",category:"quest",sprite:"sprites/items/misc/ancient_tablet.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:2},{id:"dragon_mount",name:"Dragon Mount",description:"A bond token signifying the allegiance of a dragon. The skies belong to you now.",category:"quest",sprite:"sprites/items/misc/dragon_mount.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:3},{id:"wedding_ring_recipe",name:"Wedding Ring Recipe",description:"Schematics for forging a wedding band. Even in ruin, love persists as defiance against the dark.",category:"quest",sprite:"sprites/items/misc/wedding_ring_recipe.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0},{id:"bounty_map",name:"Bounty Map",description:"A tattered map marked with blood-red X's. Each marks a target worth killing for coin.",category:"quest",sprite:"sprites/items/misc/bounty_map.png",maxStack:1,sellPrice:0,buyPrice:0,rarity:0},{id:"relic_fragment",name:"Relic Fragment",description:"A broken shard of an ancient relic. Alone it is worthless, but together they hold great power.",category:"quest",sprite:"sprites/items/misc/relic_fragment.png",maxStack:99,sellPrice:0,buyPrice:0,rarity:0}],zn=[{id:"torch",name:"Torch",description:"A light source that illuminates dark areas.",category:"misc",sprite:"sprites/items/misc/torch.png",maxStack:99,sellPrice:5,buyPrice:13,rarity:0},{id:"chest",name:"Chest",description:"Storage for your items. Holds 36 slots.",category:"misc",sprite:"sprites/items/misc/chest.png",maxStack:1,sellPrice:100,buyPrice:250,rarity:0},{id:"scarecrow",name:"Scarecrow",description:"Protects crops from crows in an 8-tile radius.",category:"misc",sprite:"sprites/items/misc/scarecrow.png",maxStack:1,sellPrice:75,buyPrice:188,rarity:0},{id:"sprinkler",name:"Basic Sprinkler",description:"Waters 4 adjacent tiles every morning.",category:"misc",sprite:"sprites/items/misc/sprinkler.png",maxStack:1,sellPrice:150,buyPrice:375,rarity:0},{id:"quality_sprinkler",name:"Quality Sprinkler",description:"Waters 8 tiles in a 3x3 area every morning.",category:"misc",sprite:"sprites/items/misc/quality_sprinkler.png",maxStack:1,sellPrice:450,buyPrice:1125,rarity:1},{id:"iridium_sprinkler",name:"Iridium Sprinkler",description:"Waters 24 tiles in a 5x5 area every morning.",category:"misc",sprite:"sprites/items/misc/iridium_sprinkler.png",maxStack:1,sellPrice:1e3,buyPrice:2500,rarity:1},{id:"bomb",name:"Bomb",description:"Explodes and breaks rocks in an area.",category:"misc",sprite:"sprites/items/misc/bomb.png",maxStack:99,sellPrice:50,buyPrice:125,rarity:0},{id:"gold_coin",name:"Gold Coin",description:"Currency",category:"misc",sprite:"sprites/items/misc/gold_coin.png",maxStack:9999,sellPrice:1,buyPrice:3,rarity:1},{id:"golden_statue",name:"Golden Statue",description:"A solid gold statue commemorating your wealth.",category:"misc",sprite:"sprites/items/misc/golden_statue.png",maxStack:1,sellPrice:1e6,buyPrice:25e5,rarity:1},{id:"tusk_trophy",name:"Tusk Trophy",description:"A massive tusk ripped from the maw of a slain beast. Proof of a hunt survived.",category:"misc",sprite:"sprites/items/misc/tusk_trophy.png",maxStack:1,sellPrice:750,buyPrice:1875,rarity:0},{id:"bait",name:"Bait",description:"Squirming morsels that lure creatures from the murky depths. What rises may not be a fish.",category:"misc",sprite:"sprites/items/tool/bait.png",maxStack:99,sellPrice:5,buyPrice:13,rarity:0},{id:"battle_standard",name:"Battle Standard",description:"A tattered war banner stained with the blood of a hundred battles. It rallies the spirit.",category:"misc",sprite:"sprites/items/misc/battle_standard.png",maxStack:1,sellPrice:500,buyPrice:1250,rarity:0},{id:"master_bait",name:"Master Bait",description:"Alchemically perfected bait that no creature of the deep can resist. Guaranteed to attract legends.",category:"misc",sprite:"sprites/items/tool/master_bait.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0},{id:"charcoal_kiln",name:"Charcoal Kiln",description:"A smoldering kiln that converts wood into charcoal. Black smoke rises like lost prayers.",category:"misc",sprite:"sprites/items/misc/charcoal_kiln.png",maxStack:1,sellPrice:500,buyPrice:1250,rarity:0},{id:"bee_house",name:"Bee House",description:"A wooden hive for dark bees. Their honey is tinged with brimstone but commands a high price.",category:"misc",sprite:"sprites/items/misc/bee_house.png",maxStack:1,sellPrice:400,buyPrice:1e3,rarity:0},{id:"preserves_jar",name:"Preserves Jar",description:"A sealed jar for preserving fruits and vegetables. Keeps food edible through the longest sieges.",category:"misc",sprite:"sprites/items/misc/preserves_jar.png",maxStack:1,sellPrice:500,buyPrice:1250,rarity:0},{id:"cheese_press",name:"Cheese Press",description:"A heavy press that transforms milk into cheese. The curds form slowly, like clotting blood.",category:"misc",sprite:"sprites/items/misc/cheese_press.png",maxStack:1,sellPrice:600,buyPrice:1500,rarity:0},{id:"keg",name:"Keg",description:"A barrel for fermenting beverages. In dark times, strong drink is the last comfort of the living.",category:"misc",sprite:"sprites/items/misc/keg.png",maxStack:1,sellPrice:800,buyPrice:2e3,rarity:0},{id:"furnace",name:"Furnace",description:"A stone smelter that devours ore and spits out ingots. Its flames never truly die out.",category:"misc",sprite:"sprites/items/misc/furnace.png",maxStack:1,sellPrice:300,buyPrice:750,rarity:0},{id:"omni_geode",name:"Omni Geode",description:"A mysterious geode that could contain any mineral. Crack it open and tempt fate.",category:"misc",sprite:"sprites/items/misc/omni_geode.png",maxStack:99,sellPrice:100,buyPrice:250,rarity:0},{id:"lightning_rod",name:"Lightning Rod",description:"A tall iron rod that draws lightning from cursed storms. Harnesses raw, volatile power.",category:"misc",sprite:"sprites/items/misc/lightning_rod.png",maxStack:1,sellPrice:400,buyPrice:1e3,rarity:0},{id:"crystalarium",name:"Crystalarium",description:"An arcane device that replicates gems from nothing. Its workings defy mortal understanding.",category:"misc",sprite:"sprites/items/misc/crystalarium.png",maxStack:1,sellPrice:2e3,buyPrice:5e3,rarity:2},{id:"auto_petter",name:"Auto-Petter",description:"A mechanical device that soothes livestock with rhythmic strokes. Eerie but effective.",category:"misc",sprite:"sprites/items/misc/auto_petter.png",maxStack:1,sellPrice:3e3,buyPrice:7500,rarity:0},{id:"rarecrow_1",name:"Rarecrow",description:"A sinister scarecrow fashioned from bones and rags. Crows dare not approach its grim domain.",category:"misc",sprite:"sprites/items/misc/rarecrow_1.png",maxStack:1,sellPrice:500,buyPrice:1250,rarity:2},{id:"treasure_chest",name:"Treasure Chest",description:"An ornate chest salvaged from a sunken vessel. Its contents whisper promises of forgotten wealth.",category:"misc",sprite:"sprites/items/misc/treasure_chest.png",maxStack:1,sellPrice:2e3,buyPrice:5e3,rarity:0},{id:"ancient_artifact",name:"Ancient Artifact",description:"A mysterious relic from a civilization lost to the first cataclysm. It hums with dormant power.",category:"misc",sprite:"sprites/items/misc/ancient_artifact.png",maxStack:1,sellPrice:1e3,buyPrice:2500,rarity:2},{id:"campfire",name:"Campfire",description:"A portable camp. Place it to create a rest point and respawn checkpoint. Resting restores HP but respawns enemies.",category:"misc",sprite:"sprites/items/misc/campfire.png",maxStack:5,sellPrice:50,buyPrice:125,rarity:0},{id:"spirit_ember",name:"Spirit Ember",description:"A rare ember from a defeated boss. Use at a campfire (SHIFT+E) to kindle it, granting resting buffs. Kindle 3 unlocks fast travel.",category:"misc",sprite:"sprites/items/misc/spirit_ember.png",maxStack:10,sellPrice:500,buyPrice:1250,rarity:3}],Hn=[...Cn,...In,...Pn,...Rn,...An,...Dn,...En,...qn,...ja,...Bn,...Fn,...zn],j=new Map(Hn.map(r=>[r.id,r]));class On{elapsedMs=0;totalDays=0;paused=!1;timeScale=1;onDayChange=[];onSeasonChange=[];onHourChange=[];lastHour=-1;lastDay=-1;lastSeason="Spring";constructor(e=1){this.totalDays=e-1,this.elapsedMs=0}update(e){if(this.paused)return;for(this.elapsedMs+=e*this.timeScale;this.elapsedMs>=Et;)this.elapsedMs-=Et,this.totalDays++;const t=this.getDate();if(t.hour!==this.lastHour){this.lastHour=t.hour;for(const i of this.onHourChange)i(t.hour)}if(t.day!==this.lastDay){this.lastDay=t.day;for(const i of this.onDayChange)i()}if(t.season!==this.lastSeason){this.lastSeason=t.season;for(const i of this.onSeasonChange)i(t.season)}}getDate(){const e=Cr,t=e*Ms.length,i=Math.floor(this.totalDays/t)+1,s=this.totalDays%t,a=Math.floor(s/e),o=s%e+1,l=this.elapsedMs/Et*24*60,c=Math.floor(l/60),d=Math.floor(l%60);return{day:o,season:Ms[a],year:i,hour:c,minute:d}}getDayProgress(){return this.elapsedMs/Et}getLightLevel(){const e=this.getDayProgress();return e<.2?.15:e<.3?.15+(e-.2)*8.5:e<.75?1:e<.85?1-(e-.75)*8.5:.15}getTimeString(){const e=this.getDate(),t=String(e.hour).padStart(2,"0"),i=String(e.minute).padStart(2,"0");return`${t}:${i}`}getDateString(){const e=this.getDate();return`${e.season} ${e.day}, Year ${e.year}`}setPaused(e){this.paused=e}setTimeScale(e){this.timeScale=Math.max(0,e)}onDay(e){this.onDayChange.push(e)}onSeason(e){this.onSeasonChange.push(e)}onHour(e){this.onHourChange.push(e)}serialize(){return{elapsedMs:this.elapsedMs,totalDays:this.totalDays}}deserialize(e){this.elapsedMs=e.elapsedMs,this.totalDays=e.totalDays}}const Je="edilas_save_",Ln=1;class Wn{autoSaveTimer=0;registeredSavers=new Map;registeredLoaders=new Map;register(e,t,i){this.registeredSavers.set(e,t),this.registeredLoaders.set(e,i)}save(e,t,i="OverworldScene",s={}){if(e<1||e>Gt)return!1;const a={version:Ln,timestamp:Date.now(),slot:e,player:t,currentScene:i,sceneData:s,inventory:null,equipment:null,time:null,quests:null,skills:null,chapters:null,corruption:null,settlements:null,custom:{}};for(const[o,n]of this.registeredSavers)o in a?a[o]=n():a.custom[o]=n();try{const o=JSON.stringify(a);return localStorage.setItem(Je+e,o),!0}catch{return console.error(`Failed to save to slot ${e}`),!1}}load(e){if(e<1||e>Gt)return null;try{const t=localStorage.getItem(Je+e);if(!t)return null;const i=JSON.parse(t);for(const[s,a]of this.registeredLoaders){const o=s in i?i[s]:i.custom[s];o!=null&&a(o)}return i}catch{return console.error(`Failed to load slot ${e}`),null}}deleteSave(e){localStorage.removeItem(Je+e)}getSaveSlotInfo(){const e=[];for(let t=1;t<=Gt;t++)try{const i=localStorage.getItem(Je+t);if(i){const s=JSON.parse(i);e.push({slot:t,timestamp:s.timestamp,playerLevel:s.player.level})}}catch{}return e}exportSave(e){const t=localStorage.getItem(Je+e);if(!t)return;const i=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(i),a=document.createElement("a");a.href=s,a.download=`edilas_save_slot${e}.json`,a.click(),URL.revokeObjectURL(s)}async importSave(e,t){try{const i=await e.text(),s=JSON.parse(i);return s.version==null||s.player==null?!1:(s.slot=t,localStorage.setItem(Je+t,JSON.stringify(s)),!0)}catch{return!1}}updateAutoSave(e,t){this.autoSaveTimer+=e,this.autoSaveTimer>=Wr&&(this.autoSaveTimer=0,this.save(1,t))}}class Nn{slots;maxStacks=new Map;gold=0;constructor(){this.slots=Array.from({length:Ke},()=>({itemId:"",quantity:0}))}getGold(){return this.gold}addGold(e){this.gold+=Math.max(0,Math.floor(e))}removeGold(e){const t=Math.max(0,Math.floor(e));return this.gold<t?!1:(this.gold-=t,!0)}getSlots(){return this.slots}addItem(e,t=1,i=99){this.maxStacks.set(e,i);let s=t;for(const a of this.slots){if(s<=0)break;if(a.itemId===e&&a.quantity<i){const o=Math.min(s,i-a.quantity);a.quantity+=o,s-=o}}for(const a of this.slots){if(s<=0)break;if(a.itemId===""){const o=Math.min(s,i);a.itemId=e,a.quantity=o,s-=o}}return s}removeItem(e,t=1){let i=t;for(const s of this.slots){if(i<=0)break;if(s.itemId===e){const a=Math.min(i,s.quantity);s.quantity-=a,i-=a,s.quantity<=0&&(s.itemId="",s.quantity=0)}}return t-i}removeRandomItem(){const e=this.slots.filter(s=>s.itemId!==""&&!s.itemId.includes("axe")&&!s.itemId.includes("pickaxe")&&!s.itemId.includes("hoe")&&!s.itemId.includes("watering_can")&&!s.itemId.includes("fishing_rod"));if(e.length===0)return null;const t=e[Math.floor(Math.random()*e.length)],i=t.itemId;return t.quantity--,t.quantity<=0&&(t.itemId="",t.quantity=0),i}hasItem(e,t=1){let i=0;for(const s of this.slots)s.itemId===e&&(i+=s.quantity);return i>=t}countItem(e){let t=0;for(const i of this.slots)i.itemId===e&&(t+=i.quantity);return t}swapSlots(e,t){e<0||e>=Ke||t<0||t>=Ke||([this.slots[e],this.slots[t]]=[this.slots[t],this.slots[e]])}splitStack(e,t){const i=this.slots[e],s=this.slots[t];if(!i||!s||i.quantity<=1)return;const a=Math.floor(i.quantity/2);if(s.itemId===""||s.itemId===i.itemId){const o=this.maxStacks.get(i.itemId)??99,n=s.itemId===""?a:Math.min(a,o-s.quantity);s.itemId=i.itemId,s.quantity+=n,i.quantity-=n,i.quantity<=0&&(i.itemId="",i.quantity=0)}}autoSort(){const e=this.slots.filter(i=>i.itemId!=="");e.sort((i,s)=>i.itemId.localeCompare(s.itemId));const t=[];for(const i of e){const s=this.maxStacks.get(i.itemId)??99,a=t[t.length-1];if(a&&a.itemId===i.itemId&&a.quantity<s){const o=Math.min(i.quantity,s-a.quantity);a.quantity+=o,i.quantity-=o}i.quantity>0&&t.push({...i})}for(let i=0;i<Ke;i++)i<t.length?this.slots[i]=t[i]:this.slots[i]={itemId:"",quantity:0}}useItem(e){const t=this.slots[e];if(!t||t.itemId===""||t.quantity<=0)return null;const i=j.get(t.itemId);return!i||i.category!=="food"&&i.category!=="potion"?null:(t.quantity-=1,t.quantity<=0&&(t.itemId="",t.quantity=0),i)}getSlot(e){return this.slots[e]??null}getAllSlots(){return this.slots}isFull(){return this.slots.every(e=>e.itemId!=="")}serialize(){return{slots:this.slots.map(e=>({...e})),gold:this.gold}}deserialize(e){if(Array.isArray(e))for(let t=0;t<Ke&&t<e.length;t++)this.slots[t]={...e[t]};else{if(e.slots)for(let t=0;t<Ke&&t<e.slots.length;t++)this.slots[t]={...e.slots[t]};this.gold=e.gold??0}}}const Qs={damage:0,defense:0,hp:0,stamina:0,critChance:0,critMult:0,attackSpeed:0},Gs=["ring1","ring2","necklace"];class Qn{equipped=new Map;cachedStats={...Qs};cachedSetBonuses=new Map;equipChangeCbs=[];maxNotches=5;slotNotchCosts=new Map;slotTradeoffs=new Map;constructor(){const e=["weapon","shield","head","chest","legs","feet","hands","ring1","ring2","necklace"];for(const t of e)this.equipped.set(t,null)}getMaxNotches(){return this.maxNotches}addNotches(e){this.maxNotches+=e}setMaxNotches(e){this.maxNotches=e}getUsedNotches(){let e=0;for(const t of this.slotNotchCosts.values())e+=t;return e}getAvailableNotches(){return this.maxNotches-this.getUsedNotches()}canEquipAccessory(e,t){if(!Gs.includes(t))return!0;const i=this.slotNotchCosts.get(t)??0;return this.getUsedNotches()-i+e<=this.maxNotches}equip(e,t=0,i){if(Gs.includes(e.slot)&&!this.canEquipAccessory(t,e.slot))return null;const s=this.equipped.get(e.slot)??null;return this.equipped.set(e.slot,e),t>0?this.slotNotchCosts.set(e.slot,t):this.slotNotchCosts.delete(e.slot),i?this.slotTradeoffs.set(e.slot,i):this.slotTradeoffs.delete(e.slot),this.recalculate(),s}unequip(e){const t=this.equipped.get(e)??null;return this.equipped.set(e,null),this.slotNotchCosts.delete(e),this.slotTradeoffs.delete(e),this.recalculate(),t}getEquipped(e){return this.equipped.get(e)??null}getTotalStats(){return{...this.cachedStats}}getSetBonuses(){return new Map(this.cachedSetBonuses)}recalculate(){const e={...Qs};this.cachedSetBonuses.clear();for(const t of this.equipped.values())t&&(e.damage+=t.stats.damage,e.defense+=t.stats.defense,e.hp+=t.stats.hp,e.stamina+=t.stats.stamina,e.critChance+=t.stats.critChance,e.critMult+=t.stats.critMult,e.attackSpeed+=t.stats.attackSpeed,t.setId&&this.cachedSetBonuses.set(t.setId,(this.cachedSetBonuses.get(t.setId)??0)+1));for(const t of this.slotTradeoffs.values()){const i=t.stat;i in e&&(e[i]-=t.amount)}this.cachedStats=e;for(const t of this.equipChangeCbs)t(e)}onEquipChange(e){this.equipChangeCbs.push(e)}serialize(){const e={};for(const[s,a]of this.equipped)e[s]=a?{...a,stats:{...a.stats}}:null;const t={};for(const[s,a]of this.slotNotchCosts)t[s]=a;const i={};for(const[s,a]of this.slotTradeoffs)i[s]={...a};return{equipped:e,maxNotches:this.maxNotches,notchCosts:t,tradeoffs:i}}deserialize(e){const t="equipped"in e?e.equipped:e;for(const[i,s]of Object.entries(t))this.equipped.set(i,s);if("maxNotches"in e&&e.maxNotches&&(this.maxNotches=e.maxNotches),"notchCosts"in e&&e.notchCosts)for(const[i,s]of Object.entries(e.notchCosts))this.slotNotchCosts.set(i,s);if("tradeoffs"in e&&e.tradeoffs)for(const[i,s]of Object.entries(e.tradeoffs))this.slotTradeoffs.set(i,s);this.recalculate()}}const Mt=[{id:"welcome_quest",name:"Welcome to Town",description:"Meet the mayor and learn about the town.",type:"main",giver:"mayor",prerequisites:[],objectives:[{type:"talk",target:"mayor",count:1,description:"Talk to Mayor Thomas"},{type:"talk",target:"shopkeeper",count:1,description:"Visit the General Store"},{type:"talk",target:"innkeeper",count:1,description:"Check in at the Tavern"}],rewards:{xp:50,gold:100,items:[{itemId:"parsnip_seeds",quantity:20}]},dialogue:{offer:"Welcome, newcomer! I am Mayor Thomas. Let me introduce you to the townsfolk.",inProgress:"Have you met everyone yet? Visit the General Store and the Tavern.",complete:"Wonderful! You are already fitting in. Here, take these seeds to get started."},level:1,chapter:1,repeatable:!1},{id:"first_harvest",name:"First Harvest",description:"Plant and harvest your first crop.",type:"main",giver:"mayor",prerequisites:["welcome_quest"],objectives:[{type:"farm",target:"till_soil",count:5,description:"Till 5 plots of soil"},{type:"farm",target:"plant_seeds",count:5,description:"Plant 5 seeds"},{type:"collect",target:"any_crop",count:5,description:"Harvest 5 crops"}],rewards:{xp:100,gold:200,items:[{itemId:"cauliflower_seeds",quantity:10}]},dialogue:{offer:"Every guardian must know how to work the land. Try planting some crops!",inProgress:"Till the soil, plant seeds, and wait for them to grow.",complete:"A fine harvest! You have a natural talent for farming."},level:1,chapter:1,repeatable:!1},{id:"guardian_path_1",name:"The Guardian's Path: Chapter 1",description:"Restore the farmhouse and begin your journey as the new guardian.",type:"main",giver:"mayor",prerequisites:[],objectives:[{type:"talk",target:"mayor",count:1,description:"Meet Mayor Harold"},{type:"farm",target:"plant_seeds",count:5,description:"Plant 5 Spring seeds"},{type:"talk",target:"shopkeeper",count:1,description:"Visit Martha at the store"}],rewards:{xp:100,gold:500,items:[{itemId:"cauliflower_seeds",quantity:10}]},dialogue:{offer:"Your grandmother left this farm to you. It needs work, but the land is good.",inProgress:"Plant some seeds and visit Martha for supplies.",complete:"The farm is coming back to life. Your grandmother would be proud."},level:1,chapter:1,repeatable:!1},{id:"guardian_path_2",name:"The Guardian's Path: Chapter 2",description:"Find Grandmother's hidden journal and explore the mines.",type:"main",giver:"mayor",prerequisites:["guardian_path_1"],objectives:[{type:"reach",target:"mine_floor_20",count:1,description:"Reach Mine Floor 20"},{type:"collect",target:"journal_fragment",count:1,description:"Find Grandmother's Journal Fragment"}],rewards:{xp:250,gold:1e3,items:[{itemId:"gold_ore",quantity:5}]},dialogue:{offer:"Your grandmother hid something deep in the mines. You must find it.",inProgress:"Keep exploring the mines. The journal is somewhere past floor 20.",complete:"This journal... it speaks of ancient secrets. We must learn more."},level:5,chapter:1,repeatable:!1},{id:"dungeon_intro",name:"Danger Below",description:"The old mines have been overrun with monsters. Clear the first floor.",type:"main",giver:"adventurer",prerequisites:["first_harvest"],objectives:[{type:"kill",target:"slime",count:10,description:"Defeat 10 Slimes"},{type:"reach",target:"dungeon_floor_5",count:1,description:"Reach Floor 5 of the Mines"}],rewards:{xp:200,gold:500,items:[{itemId:"sword",quantity:1}]},dialogue:{offer:"The mines are infested. We need someone brave enough to clear them out.",inProgress:"Keep pushing deeper. The slimes get tougher below.",complete:"Impressive work! You handle a blade well. Take this sword."},level:3,chapter:1,repeatable:!1},{id:"grandmothers_secret",name:"Grandmother's Secret",description:"Search for clues about your grandmother's past.",type:"main",giver:"mayor",prerequisites:["welcome_quest"],objectives:[{type:"collect",target:"journal_entry",count:3,description:"Find 3 Journal Entries"},{type:"talk",target:"wizard",count:1,description:"Speak with the Wizard"}],rewards:{xp:200,gold:500,items:[]},dialogue:{offer:"Your grandmother was no ordinary farmer. Look for her journal entries.",inProgress:"Search the farmhouse and talk to old friends of hers.",complete:"The wizard may know more about what she was hiding."},level:3,chapter:2,repeatable:!1},{id:"curse_investigation",name:"The Curse of Willowbrook",description:"The wizard speaks of an ancient curse. Investigate the mines.",type:"main",giver:"wizard",prerequisites:["grandmothers_secret"],objectives:[{type:"reach",target:"mine_floor_25",count:1,description:"Reach Mine Floor 25"},{type:"talk",target:"ancient_spirit",count:1,description:"Find the Ancient Spirit"}],rewards:{xp:400,gold:1e3,items:[]},dialogue:{offer:"An ancient curse binds this valley. The answers lie deep in the mines.",inProgress:"Descend to floor 25. The spirit awaits those who are worthy.",complete:"The spirit has spoken. The community center is the key to breaking the curse."},level:8,chapter:2,repeatable:!1},{id:"community_restoration",name:"Restoring the Heart",description:"The spirit says the community center is key. Help restore it.",type:"main",giver:"mayor",prerequisites:["curse_investigation"],objectives:[{type:"collect",target:"community_bundle",count:1,description:"Complete a Community Center Bundle"},{type:"talk",target:"mayor",count:1,description:"Report to the Mayor"}],rewards:{xp:500,gold:2e3,items:[]},dialogue:{offer:"The community center has fallen into disrepair. Help us restore it.",inProgress:"Gather the items needed for the bundles.",complete:"The center glows with renewed energy. The curse weakens!"},level:10,chapter:2,repeatable:!1},{id:"darkness_awakens",name:"The Darkness Awakens",description:"Strange creatures have been spotted outside Haven. Investigate the threat.",type:"main",giver:"adventurer",prerequisites:[],objectives:[{type:"explore",target:"wilderness_500m",count:1,description:"Venture 500m from Haven"},{type:"kill",target:"any",count:5,description:"Defeat 5 creatures in the wild"},{type:"survive",target:"night_outside",count:1,description:"Survive one night outside Haven"}],rewards:{xp:150,gold:300,items:[{itemId:"torch",quantity:10}]},dialogue:{offer:"Something stirs beyond the walls. We need someone to investigate.",inProgress:"Venture out, fight what you find, and survive the night.",complete:"You survived. But what you saw out there... it is only the beginning."},level:5,chapter:3,repeatable:!1},{id:"whispers_in_dark",name:"Whispers in the Dark",description:"The wizard senses an ancient evil stirring. The old stories speak of EDILAS...",type:"main",giver:"wizard",prerequisites:["darkness_awakens"],objectives:[{type:"talk",target:"wizard",count:1,description:"Consult the Wizard about EDILAS"},{type:"collect",target:"ancient_tablet",count:1,description:"Find an Ancient Tablet"},{type:"reach",target:"deep_mines_floor_30",count:1,description:"Explore the Deep Mines (Floor 30)"}],rewards:{xp:300,gold:750,items:[{itemId:"lantern",quantity:1}]},dialogue:{offer:"I sense a great disturbance. The name EDILAS appears in the ancient texts...",inProgress:"Find the tablet. It holds the key to understanding what is coming.",complete:"EDILAS... it is not just a legend. The darkness is real, and it is waking."},level:10,chapter:3,repeatable:!1},{id:"corrupted_grove_quest",name:"The Corrupted Grove",description:"A forest has been twisted by dark magic. Clear the corruption at its heart.",type:"main",giver:"wizard",prerequisites:["whispers_in_dark"],objectives:[{type:"explore",target:"corrupted_grove",count:1,description:"Enter the Corrupted Grove"},{type:"reach",target:"grove_floor_20",count:1,description:"Reach Grove Floor 20"},{type:"kill",target:"ancient_treant",count:1,description:"Defeat the Ancient Treant"}],rewards:{xp:500,gold:2e3,items:[{itemId:"forest_heart",quantity:1}]},dialogue:{offer:"The Corrupted Grove festers with dark energy. You must cleanse it.",inProgress:"Push deeper into the grove. The Treant guards the heart.",complete:"The Forest Heart pulses with cleansed energy. One artifact secured."},level:15,chapter:4,repeatable:!1},{id:"blighted_marsh_quest",name:"Depths of the Marsh",description:"A swamp creature blocks the path. Its poison must be purged.",type:"main",giver:"wizard",prerequisites:["corrupted_grove_quest"],objectives:[{type:"explore",target:"blighted_marsh",count:1,description:"Enter the Blighted Marsh"},{type:"reach",target:"marsh_floor_25",count:1,description:"Reach Marsh Floor 25"},{type:"kill",target:"swamp_horror",count:1,description:"Defeat the Swamp Horror"}],rewards:{xp:600,gold:2500,items:[{itemId:"marsh_eye",quantity:1}]},dialogue:{offer:"The Blighted Marsh poisons everything it touches. End the Horror within.",inProgress:"Wade through the mire. The Swamp Horror lurks at the depths.",complete:"The Marsh Eye is yours. Two artifacts collected."},level:20,chapter:4,repeatable:!1},{id:"scorched_wastes_quest",name:"Trial by Fire",description:"The volcanic caverns hold ancient power. Face the guardian within.",type:"main",giver:"wizard",prerequisites:["blighted_marsh_quest"],objectives:[{type:"explore",target:"scorched_wastes",count:1,description:"Enter the Scorched Wastes"},{type:"reach",target:"wastes_floor_30",count:1,description:"Reach Wastes Floor 30"},{type:"kill",target:"molten_guardian",count:1,description:"Defeat the Molten Guardian"}],rewards:{xp:750,gold:3e3,items:[{itemId:"flame_core",quantity:1}]},dialogue:{offer:"Fire and brimstone guard the third artifact. Are you ready?",inProgress:"The heat intensifies as you descend. The Molten Guardian awaits.",complete:"The Flame Core burns with purified fire. Three artifacts secured."},level:25,chapter:4,repeatable:!1},{id:"frozen_depths_quest",name:"Heart of Winter",description:"An ancient dragon slumbers in eternal ice. Wake it and prove your worth.",type:"main",giver:"wizard",prerequisites:["scorched_wastes_quest"],objectives:[{type:"explore",target:"frozen_depths",count:1,description:"Enter the Frozen Depths"},{type:"reach",target:"depths_floor_40",count:1,description:"Reach Depths Floor 40"},{type:"kill",target:"frost_wyrm",count:1,description:"Defeat the Frost Wyrm"}],rewards:{xp:1e3,gold:4e3,items:[{itemId:"frost_shard",quantity:1}]},dialogue:{offer:"The Frost Wyrm sleeps in ice older than the valley. Disturb it at your peril.",inProgress:"The cold bites deeper with every step. The Wyrm stirs.",complete:"The Frost Shard gleams with frozen power. Four artifacts in hand."},level:30,chapter:4,repeatable:!1},{id:"haunted_ruins_quest",name:"The Lich's Domain",description:"The final trial awaits. Face the master of death itself.",type:"main",giver:"wizard",prerequisites:["frozen_depths_quest"],objectives:[{type:"explore",target:"haunted_ruins",count:1,description:"Enter the Haunted Ruins"},{type:"reach",target:"ruins_floor_50",count:1,description:"Reach Ruins Floor 50"},{type:"kill",target:"lich_king",count:1,description:"Defeat the Lich King"}],rewards:{xp:1500,gold:5e3,items:[{itemId:"soul_fragment",quantity:1}]},dialogue:{offer:"The Lich King rules the dead. Only by conquering death can you claim the final artifact.",inProgress:"The ruins whisper with lost souls. Press onward.",complete:"The Soul Fragment is yours. All five artifacts are assembled!"},level:35,chapter:4,repeatable:!1},{id:"path_to_edilas",name:"The Path to Paradise",description:"With all five artifacts collected, the path to EDILAS reveals itself.",type:"main",giver:"wizard",prerequisites:["haunted_ruins_quest"],objectives:[{type:"collect",target:"forest_heart",count:1,description:"Possess the Forest Heart"},{type:"collect",target:"marsh_eye",count:1,description:"Possess the Marsh Eye"},{type:"collect",target:"flame_core",count:1,description:"Possess the Flame Core"},{type:"collect",target:"frost_shard",count:1,description:"Possess the Frost Shard"},{type:"collect",target:"soul_fragment",count:1,description:"Possess the Soul Fragment"},{type:"explore",target:"sanctuary",count:1,description:"Find the hidden Sanctuary"}],rewards:{xp:5e3,gold:1e4,items:[{itemId:"edilas_key",quantity:1}]},dialogue:{offer:"The five artifacts resonate together. They point to a hidden sanctuary.",inProgress:"Gather all artifacts and seek the Sanctuary beyond the known world.",complete:"The EDILAS Key materializes before you. The path is open."},level:40,chapter:5,repeatable:!1},{id:"edilas_ascension",name:"EDILAS: Ascension",description:"The final journey. Reach EDILAS and claim your destiny.",type:"main",giver:"wizard",prerequisites:["path_to_edilas"],objectives:[{type:"collect",target:"edilas_key",count:1,description:"Use the EDILAS Key at the Sanctuary"},{type:"reach",target:"edilas",count:1,description:"Enter EDILAS"}],rewards:{xp:0,gold:0,items:[],unlocks:["game_completion"]},dialogue:{offer:"This is it. The gate to EDILAS awaits. Are you ready for your destiny?",inProgress:"Use the key at the Sanctuary. EDILAS calls to you.",complete:"You have arrived. EDILAS is real, and it is more beautiful than any legend told."},level:50,chapter:5,repeatable:!1},{id:"lily_flowers",name:"Flowers for Lily",description:"Lily mentioned she loves flowers. Bring her some!",type:"side",giver:"farmer_girl",prerequisites:[],objectives:[{type:"deliver",target:"flower",count:5,description:"Give Lily 5 Flowers"}],rewards:{xp:75,gold:150,items:[]},dialogue:{offer:"Oh, I just adore flowers! Could you bring me some from the meadow?",inProgress:"Any luck finding flowers? The meadow should be full of them.",complete:"These are gorgeous! Thank you so much!"},level:1,repeatable:!1},{id:"blacksmith_ore",name:"Rare Ore Request",description:"Garrett needs gold ore for a special project.",type:"side",giver:"blacksmith",prerequisites:[],objectives:[{type:"deliver",target:"gold_ore",count:20,description:"Bring 20 Gold Ore to Garrett"}],rewards:{xp:100,gold:500,items:[{itemId:"iron_bar",quantity:10}]},dialogue:{offer:"I'm working on something special, but I need gold ore. Can you get me 20?",inProgress:"Still need that gold ore. The deeper mines have plenty.",complete:"Perfect quality! Here, take these iron bars as thanks."},level:5,repeatable:!1},{id:"doctor_herbs",name:"Medical Supplies",description:"Dr. Elena needs herbs for her remedies.",type:"side",giver:"doctor",prerequisites:[],objectives:[{type:"deliver",target:"magic_herb",count:5,description:"Bring 5 Magic Herbs to Elena"},{type:"deliver",target:"red_mushroom",count:10,description:"Bring 10 Red Mushrooms"}],rewards:{xp:150,gold:400,items:[{itemId:"health_potion",quantity:5}]},dialogue:{offer:"My supplies are running low. I need magic herbs and red mushrooms for medicine.",inProgress:"I still need those herbs and mushrooms. Check the forest and caves.",complete:"These are perfect! Take some health potions for your trouble."},level:3,repeatable:!1},{id:"innkeeper_feast",name:"The Grand Feast",description:"The innkeeper is planning a feast and needs fresh ingredients.",type:"side",giver:"innkeeper",prerequisites:[],objectives:[{type:"deliver",target:"potato",count:10,description:"Deliver 10 Potatoes"},{type:"deliver",target:"corn",count:10,description:"Deliver 10 Corn"},{type:"deliver",target:"fish",count:5,description:"Deliver 5 Fresh Fish"}],rewards:{xp:120,gold:350,items:[{itemId:"cooked_feast",quantity:3}]},dialogue:{offer:"We're hosting a feast! I need potatoes, corn, and fresh fish. Can you help?",inProgress:"Still gathering ingredients? The feast won't cook itself!",complete:"Everything looks wonderful! Here, have some of the feast yourself."},level:4,repeatable:!1},{id:"wizard_apprentice",name:"The Wizard's Test",description:"The wizard wants to test your aptitude for magic.",type:"side",giver:"wizard",prerequisites:["grandmothers_secret"],objectives:[{type:"collect",target:"crystal_shard",count:10,description:"Collect 10 Crystal Shards"},{type:"craft",target:"arcane_focus",count:1,description:"Craft an Arcane Focus"},{type:"talk",target:"wizard",count:1,description:"Return to the Wizard"}],rewards:{xp:300,gold:800,items:[{itemId:"spellbook",quantity:1}]},dialogue:{offer:"I see potential in you. Gather crystal shards and craft an arcane focus to prove it.",inProgress:"Crystal shards can be found in the mines. The crafting recipe is in your journal.",complete:"Impressive! You have the gift. Take this spellbook and study well."},level:8,repeatable:!1},{id:"find_ironhold",name:"The Mining Fortress",description:"Rumors speak of a fortress carved into the mountains. Find Ironhold.",type:"side",giver:"blacksmith",prerequisites:[],objectives:[{type:"explore",target:"wilderness_2000m",count:1,description:"Travel far from Haven"},{type:"explore",target:"ironhold",count:1,description:"Discover Ironhold"}],rewards:{xp:400,gold:1e3,items:[]},dialogue:{offer:"There's an old mining fortress in the mountains. If you find it, the ores there are legendary.",inProgress:"Keep heading toward the mountains. Ironhold is out there somewhere.",complete:"You found Ironhold! The dwarven forge still burns. This changes everything."},level:10,repeatable:!1},{id:"find_verdant_rest",name:"Sanctuary in the Forest",description:"Herbalists speak of a hidden grove where healing plants grow.",type:"side",giver:"doctor",prerequisites:[],objectives:[{type:"collect",target:"rare_herb",count:10,description:"Gather 10 Rare Herbs"},{type:"explore",target:"verdant_rest",count:1,description:"Discover Verdant Rest"}],rewards:{xp:400,gold:1e3,items:[{itemId:"healing_salve",quantity:5}]},dialogue:{offer:"Ancient texts describe a grove of miraculous healing plants. Find it for me.",inProgress:"Follow the rare herbs. They grow more densely near Verdant Rest.",complete:"Verdant Rest! The healing energies here are extraordinary."},level:10,repeatable:!1},{id:"find_grimwatch",name:"The Warrior's Outpost",description:"Veterans speak of a military outpost on the frontier. Seek Grimwatch.",type:"side",giver:"adventurer",prerequisites:["darkness_awakens"],objectives:[{type:"kill",target:"any",count:50,description:"Prove your combat skills (50 kills)"},{type:"explore",target:"grimwatch",count:1,description:"Discover Grimwatch"}],rewards:{xp:500,gold:1500,items:[{itemId:"battle_standard",quantity:1}]},dialogue:{offer:"Grimwatch is where the real warriors train. Prove yourself first, then find it.",inProgress:"You need more combat experience before Grimwatch will accept you.",complete:"Welcome to Grimwatch, warrior. You have earned your place here."},level:15,repeatable:!1},{id:"slime_king_hunt",name:"The Slime King",description:"A massive slime has been spotted in the mines. End its reign!",type:"side",giver:"adventurer",prerequisites:["dungeon_intro"],objectives:[{type:"reach",target:"mine_floor_20",count:1,description:"Reach Mine Floor 20"},{type:"kill",target:"slime_king",count:1,description:"Defeat the Slime King"}],rewards:{xp:500,gold:2e3,items:[{itemId:"slime_crown",quantity:1}]},dialogue:{offer:"A Slime King lurks on floor 20. Big reward for anyone who takes it down.",inProgress:"The Slime King is deep in the mines. Be prepared.",complete:"The Slime King is no more! This crown is your trophy."},level:10,repeatable:!1},{id:"shadow_lord_hunt",name:"Shadow in the Deep",description:"A dark presence lurks in the depths. Only the brave dare face it.",type:"side",giver:"wizard",prerequisites:["slime_king_hunt"],objectives:[{type:"reach",target:"mine_floor_50",count:1,description:"Reach Mine Floor 50"},{type:"kill",target:"shadow_lord",count:1,description:"Defeat the Shadow Lord"}],rewards:{xp:1e3,gold:5e3,items:[{itemId:"shadow_blade",quantity:1}]},dialogue:{offer:"A Shadow Lord commands the deep mines. It must be destroyed.",inProgress:"The shadows grow thicker as you descend. The lord waits at floor 50.",complete:"The Shadow Lord is banished! This blade was forged from its essence."},level:20,repeatable:!1},{id:"frost_wyrm_hunt",name:"The Frozen Terror",description:"An ancient dragon sleeps in the icy depths. Wake it at your peril.",type:"side",giver:"wizard",prerequisites:["shadow_lord_hunt"],objectives:[{type:"reach",target:"mine_floor_80",count:1,description:"Reach Mine Floor 80"},{type:"kill",target:"frost_wyrm",count:1,description:"Defeat the Frost Wyrm"}],rewards:{xp:1500,gold:7500,items:[{itemId:"frozen_heart",quantity:1}]},dialogue:{offer:"An ancient wyrm sleeps in the deepest ice. Only a true warrior can face it.",inProgress:"Floor 80 is treacherous. Bring fire resistance gear.",complete:"Incredible! The Frozen Heart still beats with the wyrm's power."},level:30,repeatable:!1},{id:"wolf_pack",name:"Wolf Pack",description:"A pack of wolves has been spotted near the mines.",type:"side",giver:"adventurer",prerequisites:[],objectives:[{type:"kill",target:"wolf",count:10,description:"Defeat 10 Wolves"},{type:"collect",target:"fang",count:5,description:"Collect 5 Fangs"}],rewards:{xp:200,gold:400,items:[{itemId:"fur",quantity:5}]},dialogue:{offer:"Wolves are threatening travelers on the mountain path. Deal with them.",inProgress:"The wolves roam near the mine entrance. Be careful in packs.",complete:"The paths are safe again. Keep the fur as a reward."},level:5,repeatable:!1},{id:"ghost_hunter",name:"Ghost Hunter",description:"Restless spirits haunt the deeper mines.",type:"side",giver:"wizard",prerequisites:[],objectives:[{type:"kill",target:"ghost",count:15,description:"Banish 15 Ghosts"},{type:"collect",target:"ectoplasm",count:5,description:"Collect 5 Ectoplasm"}],rewards:{xp:300,gold:600,items:[{itemId:"spirit_shard",quantity:2}]},dialogue:{offer:"Spirits wander the mines, unable to rest. Banish them and bring me ectoplasm.",inProgress:"Ghosts dwell below floor 15. Use enchanted weapons if you can.",complete:"The spirits are at peace. These shards hold residual energy."},level:8,repeatable:!1},{id:"wizard_artifact",name:"Ancient Knowledge",description:"The wizard seeks an ancient artifact from the depths.",type:"side",giver:"wizard",prerequisites:[],objectives:[{type:"collect",target:"ancient_artifact",count:1,description:"Find the Ancient Artifact"}],rewards:{xp:500,gold:1e3,items:[{itemId:"magic_staff",quantity:1}]},dialogue:{offer:"An artifact of immense power lies hidden. I need it for my research.",inProgress:"The artifact is somewhere in the mines. Look for glowing runes.",complete:"At last! This staff channels the artifact's power. Take it, you have earned it."},level:8,repeatable:!1},{id:"fishing_lesson",name:"Gone Fishing",description:"Learn to fish and catch your first fish.",type:"side",giver:"innkeeper",prerequisites:[],objectives:[{type:"collect",target:"fishing_rod",count:1,description:"Get a Fishing Rod"},{type:"fish",target:"any_fish",count:3,description:"Catch 3 fish"}],rewards:{xp:50,gold:100,items:[]},dialogue:{offer:"There's good fishing by the river. Get yourself a rod and try your luck!",inProgress:"Cast your line in the river. Patience is key.",complete:"Not bad for a beginner! Fishing is a great way to relax and earn coin."},level:1,repeatable:!1},{id:"master_the_blade",name:"Master the Blade",description:"Reach mastery with a sword and learn the ancient techniques.",type:"side",giver:"adventurer",prerequisites:[],objectives:[{type:"kill",target:"any",count:200,description:"Defeat 200 enemies with a sword"}],rewards:{xp:500,gold:2e3,items:[{itemId:"legendary_sword",quantity:1}]},dialogue:{offer:"A true swordsman has defeated hundreds. Prove your blade mastery.",inProgress:"Keep fighting. A master needs experience above all.",complete:"You have mastered the blade. This legendary sword is yours by right."},level:15,repeatable:!1},{id:"night_hunter",name:"Night Hunter",description:"The darkness holds stronger prey. Hunt the nightmare creatures.",type:"side",giver:"adventurer",prerequisites:[],objectives:[{type:"kill",target:"nightmare_enemy",count:20,description:"Defeat 20 nightmare enemies (night-buffed)"},{type:"survive",target:"nights_outside",count:5,description:"Survive 5 nights outside Haven"}],rewards:{xp:400,gold:1500,items:[{itemId:"nightvision_goggles",quantity:1}]},dialogue:{offer:"Nighttime creatures are far more dangerous. Think you can handle them?",inProgress:"The night holds terrors. Keep fighting after dark.",complete:"A true night hunter! These goggles will help you see in the dark."},level:12,repeatable:!1},{id:"master_angler",name:"Master Angler",description:"Catch one of every common fish species.",type:"side",giver:"innkeeper",prerequisites:["fishing_lesson"],objectives:[{type:"fish",target:"bass",count:1,description:"Catch a Bass"},{type:"fish",target:"trout",count:1,description:"Catch a Trout"},{type:"fish",target:"salmon",count:1,description:"Catch a Salmon"},{type:"fish",target:"catfish",count:1,description:"Catch a Catfish"},{type:"fish",target:"pike",count:1,description:"Catch a Pike"}],rewards:{xp:300,gold:800,items:[{itemId:"iridium_rod",quantity:1}]},dialogue:{offer:"Think you can catch every fish in these waters? I'll reward a true angler.",inProgress:"Different fish appear in different seasons and locations.",complete:"You've caught them all! You're a master angler. Take this iridium rod."},level:5,repeatable:!1},{id:"farm_expansion",name:"Growing Ambitions",description:"Expand your farm and grow a variety of crops.",type:"side",giver:"mayor",prerequisites:["first_harvest"],objectives:[{type:"farm",target:"till_soil",count:30,description:"Till 30 plots of soil"},{type:"farm",target:"plant_seeds",count:30,description:"Plant 30 different seeds"},{type:"collect",target:"any_crop",count:50,description:"Harvest 50 total crops"}],rewards:{xp:250,gold:600,items:[{itemId:"sprinkler",quantity:3}]},dialogue:{offer:"Your farm could be so much more! Expand your fields and grow more crops.",inProgress:"Keep planting and harvesting. The farm is growing!",complete:"Look at this farm! These sprinklers will help you manage it all."},level:5,repeatable:!1},{id:"apprentice_chef",name:"Apprentice Chef",description:"Learn to cook and prepare basic recipes.",type:"side",giver:"innkeeper",prerequisites:[],objectives:[{type:"cook",target:"fried_egg",count:3,description:"Cook 3 Fried Eggs"},{type:"cook",target:"vegetable_soup",count:2,description:"Cook 2 Vegetable Soups"},{type:"cook",target:"bread",count:3,description:"Bake 3 Loaves of Bread"}],rewards:{xp:150,gold:300,items:[{itemId:"recipe_book",quantity:1}]},dialogue:{offer:"Every adventurer should know how to cook! Let me teach you the basics.",inProgress:"Use the kitchen in the tavern to practice your cooking.",complete:"Delicious! This recipe book has more advanced dishes for you."},level:2,repeatable:!1},{id:"mining_fundamentals",name:"Strike the Earth",description:"Learn the basics of mining and ore processing.",type:"side",giver:"blacksmith",prerequisites:[],objectives:[{type:"mine",target:"copper_ore",count:20,description:"Mine 20 Copper Ore"},{type:"mine",target:"iron_ore",count:10,description:"Mine 10 Iron Ore"},{type:"craft",target:"copper_bar",count:5,description:"Smelt 5 Copper Bars"}],rewards:{xp:150,gold:300,items:[{itemId:"steel_pickaxe",quantity:1}]},dialogue:{offer:"The mines are full of ore, but you need to know what to look for.",inProgress:"Copper is common on early floors. Iron appears deeper.",complete:"Good work! This steel pickaxe will serve you well in the deeper mines."},level:3,repeatable:!1},{id:"town_cleanup",name:"Town Cleanup",description:"Help keep the town clean by gathering debris.",type:"side",giver:"mayor",prerequisites:[],objectives:[{type:"collect",target:"fiber",count:20,description:"Collect 20 Fiber"},{type:"collect",target:"wood",count:10,description:"Collect 10 Wood"}],rewards:{xp:30,gold:150,items:[]},dialogue:{offer:"The town square is covered in debris. Help us clean it up!",inProgress:"Gather the fiber and wood scattered around town.",complete:"The town looks much better! Thank you for your help."},level:1,repeatable:!0},{id:"slime_extermination",name:"Slime Problem",description:"The slimes are multiplying too fast. Thin their numbers.",type:"side",giver:"adventurer",prerequisites:[],objectives:[{type:"kill",target:"slime",count:25,description:"Defeat 25 Slimes"},{type:"collect",target:"slime_gel",count:10,description:"Collect 10 Slime Gel"}],rewards:{xp:150,gold:300,items:[]},dialogue:{offer:"Slimes are everywhere again. Time to thin the herd.",inProgress:"Keep slaying slimes. They drop gel when defeated.",complete:"That should keep the population down... for now."},level:3,repeatable:!0},{id:"daily_farming",name:"Farming Contract",description:"Deliver fresh produce to the tavern.",type:"daily",giver:"innkeeper",prerequisites:[],objectives:[{type:"deliver",target:"any_crop",count:10,description:"Deliver 10 fresh crops"}],rewards:{xp:50,gold:200,items:[]},dialogue:{offer:"The tavern needs fresh produce today. Bring what you've got!",inProgress:"I still need those crops. Any variety will do.",complete:"Fresh from the farm! The patrons will love this."},level:1,repeatable:!0},{id:"daily_mining",name:"Mining Contract",description:"Deliver ore to the blacksmith.",type:"daily",giver:"blacksmith",prerequisites:[],objectives:[{type:"deliver",target:"any_ore",count:15,description:"Deliver 15 ore of any type"}],rewards:{xp:45,gold:225,items:[]},dialogue:{offer:"Running low on materials. Bring me whatever ore you can find.",inProgress:"I need more ore. The mines are full of it.",complete:"Good quality ore! I'll put it to good use."},level:3,repeatable:!0},{id:"daily_slaying",name:"Monster Bounty",description:"Thin out the monster population.",type:"daily",giver:"adventurer",prerequisites:[],objectives:[{type:"kill",target:"any",count:15,description:"Slay 15 monsters"}],rewards:{xp:80,gold:150,items:[]},dialogue:{offer:"Monsters are getting bold again. Go show them who is boss.",inProgress:"More monsters to slay. Check the mines and wilderness.",complete:"Nice work! That should keep them at bay for today."},level:3,repeatable:!0},{id:"daily_foraging",name:"Foraging Run",description:"Gather wild items from the forest.",type:"daily",giver:"doctor",prerequisites:[],objectives:[{type:"collect",target:"wild_herb",count:8,description:"Gather 8 wild herbs"},{type:"collect",target:"wild_berry",count:5,description:"Gather 5 wild berries"}],rewards:{xp:40,gold:120,items:[]},dialogue:{offer:"I need fresh herbs and berries for today's medicines.",inProgress:"Check the forest paths for herbs and berry bushes.",complete:"Fresh and potent! These will make excellent remedies."},level:1,repeatable:!0},{id:"daily_fishing",name:"Fresh Catch",description:"The tavern needs fresh fish for tonight's menu.",type:"daily",giver:"innkeeper",prerequisites:["fishing_lesson"],objectives:[{type:"fish",target:"any_fish",count:5,description:"Catch 5 fish"}],rewards:{xp:40,gold:150,items:[]},dialogue:{offer:"Tonight's special is fish stew! Bring me 5 fresh catches.",inProgress:"I'm counting on those fish! Try the river or the lake.",complete:"Beautiful catches! The stew will be fantastic tonight."},level:2,repeatable:!0},{id:"weekly_deep_dive",name:"Deep Dive",description:"Explore the deepest reaches of the mines this week.",type:"weekly",giver:"adventurer",prerequisites:["dungeon_intro"],objectives:[{type:"kill",target:"any",count:100,description:"Defeat 100 monsters in the mines"},{type:"mine",target:"any_ore",count:50,description:"Mine 50 ore"},{type:"reach",target:"mine_floor_new",count:1,description:"Reach a new personal best floor"}],rewards:{xp:500,gold:1500,items:[{itemId:"rare_gem",quantity:2}]},dialogue:{offer:"This week's challenge: push deeper than ever into the mines.",inProgress:"Keep mining and fighting. The depths await.",complete:"A record-breaking week! These rare gems are your bonus."},level:5,repeatable:!0},{id:"weekly_harvest_festival",name:"Harvest Festival Prep",description:"Grow and deliver a large quantity of crops for the weekly market.",type:"weekly",giver:"mayor",prerequisites:["first_harvest"],objectives:[{type:"collect",target:"any_crop",count:100,description:"Harvest 100 crops"},{type:"deliver",target:"any_crop",count:50,description:"Deliver 50 crops to the market"}],rewards:{xp:400,gold:2e3,items:[{itemId:"quality_fertilizer",quantity:10}]},dialogue:{offer:"The weekly market needs a big harvest! Can you contribute?",inProgress:"Keep farming! The market needs a hundred crops harvested.",complete:"What a harvest! The market was a huge success."},level:3,repeatable:!0},{id:"weekly_trade_route",name:"Trade Route",description:"Establish trade by delivering goods between settlements.",type:"weekly",giver:"shopkeeper",prerequisites:["find_ironhold"],objectives:[{type:"deliver",target:"trade_goods",count:20,description:"Deliver 20 trade goods to Ironhold"},{type:"collect",target:"ironhold_goods",count:20,description:"Bring back 20 Ironhold goods"}],rewards:{xp:350,gold:1800,items:[{itemId:"merchant_badge",quantity:1}]},dialogue:{offer:"Trade between Haven and Ironhold would benefit everyone. Will you be our courier?",inProgress:"Deliver goods to Ironhold and bring back their wares.",complete:"The trade route is established! Commerce flows between our towns."},level:10,repeatable:!0},{id:"bounty_skeleton_horde",name:"Skeleton Horde",description:"A horde of skeletons threatens the lower mines. Eliminate them.",type:"bounty",giver:"adventurer",prerequisites:["dungeon_intro"],objectives:[{type:"kill",target:"skeleton",count:30,description:"Destroy 30 Skeletons"},{type:"collect",target:"bone_fragment",count:15,description:"Collect 15 Bone Fragments"}],rewards:{xp:250,gold:500,items:[]},dialogue:{offer:"BOUNTY: Skeleton horde in the mines. 500 gold reward.",inProgress:"Skeletons rattle in the dark. Keep breaking them apart.",complete:"Bounty fulfilled. The bones are quiet again."},level:7,repeatable:!0},{id:"bounty_bat_infestation",name:"Bat Infestation",description:"Giant bats have overrun the upper mine levels.",type:"bounty",giver:"adventurer",prerequisites:[],objectives:[{type:"kill",target:"bat",count:20,description:"Exterminate 20 Bats"},{type:"collect",target:"bat_wing",count:10,description:"Collect 10 Bat Wings"}],rewards:{xp:100,gold:250,items:[]},dialogue:{offer:"BOUNTY: Bat infestation in the mines. 250 gold reward.",inProgress:"The bats swarm in the upper levels. Bring a good weapon.",complete:"Bounty fulfilled. The skies underground are clear."},level:3,repeatable:!0},{id:"bounty_goblin_raiders",name:"Goblin Raiders",description:"Goblins have been raiding supply caravans. Stop them.",type:"bounty",giver:"adventurer",prerequisites:["dungeon_intro"],objectives:[{type:"kill",target:"goblin",count:20,description:"Defeat 20 Goblins"},{type:"collect",target:"stolen_goods",count:5,description:"Recover 5 Stolen Goods"}],rewards:{xp:200,gold:450,items:[{itemId:"goblin_trophy",quantity:1}]},dialogue:{offer:"BOUNTY: Goblin raiders on the trade routes. 450 gold reward.",inProgress:"The goblins camp near the mountain pass. They hoard stolen goods.",complete:"Bounty fulfilled. The trade routes are safe once more."},level:8,repeatable:!0},{id:"bounty_spider_nest",name:"Spider Nest",description:"A giant spider has built a nest in the caves. Destroy it.",type:"bounty",giver:"adventurer",prerequisites:[],objectives:[{type:"kill",target:"spider",count:15,description:"Kill 15 Spiders"},{type:"kill",target:"spider_queen",count:1,description:"Destroy the Spider Queen"}],rewards:{xp:300,gold:600,items:[{itemId:"spider_silk",quantity:10}]},dialogue:{offer:"BOUNTY: Spider nest in the eastern caves. 600 gold reward.",inProgress:"Follow the webs deeper. The queen lurks at the center.",complete:"Bounty fulfilled. The nest is destroyed. Keep the silk."},level:10,repeatable:!0},{id:"bounty_undead_uprising",name:"Undead Uprising",description:"The dead are rising in the cemetery. Put them back to rest.",type:"bounty",giver:"wizard",prerequisites:["ghost_hunter"],objectives:[{type:"kill",target:"zombie",count:25,description:"Destroy 25 Zombies"},{type:"kill",target:"skeleton_warrior",count:10,description:"Defeat 10 Skeleton Warriors"},{type:"collect",target:"cursed_bone",count:5,description:"Collect 5 Cursed Bones"}],rewards:{xp:400,gold:800,items:[{itemId:"holy_water",quantity:5}]},dialogue:{offer:"BOUNTY: Undead uprising at the old cemetery. 800 gold reward.",inProgress:"The undead grow restless at night. Strike during the day if you can.",complete:"Bounty fulfilled. The dead rest once more. Take this holy water."},level:12,repeatable:!0},{id:"legend_of_the_void",name:"Legend of the Void",description:"Uncover the secrets of the void dimension and defeat the Shadow Lord.",type:"legendary",giver:"wizard",prerequisites:[],objectives:[{type:"collect",target:"void_essence",count:50,description:"Collect 50 Void Essence from shadow creatures"},{type:"explore",target:"void_portal",count:1,description:"Locate the hidden void portal in the deepest mines"},{type:"kill",target:"shadow_lord_void",count:1,description:"Challenge and defeat the Shadow Lord in his domain"}],rewards:{xp:5e3,gold:13e3,items:[{itemId:"void_amulet",quantity:1},{itemId:"galaxy_sword",quantity:1},{itemId:"void_crown",quantity:1},{itemId:"void_talisman",quantity:1}],unlocks:["void_dimension_access"]},dialogue:{offer:"The void calls to those who dare listen. Gather void essence and find the portal.",inProgress:"The Shadow Lord awaits in the void. Prepare yourself thoroughly.",complete:"You have conquered the void itself. The title of Voidwalker is yours."},level:40,repeatable:!1},{id:"the_ancient_fruit",name:"The Ancient Fruit",description:"Discover the legendary ancient fruit and unlock its secrets.",type:"legendary",giver:"wizard",prerequisites:[],objectives:[{type:"collect",target:"ancient_seed",count:1,description:"Discover an Ancient Seed artifact"},{type:"farm",target:"ancient_fruit",count:1,description:"Successfully grow and harvest an ancient fruit"},{type:"craft",target:"ancient_wine_gold",count:1,description:"Brew ancient fruit wine and age it to gold quality"}],rewards:{xp:3e3,gold:6500,items:[{itemId:"ancient_seed_packet",quantity:5},{itemId:"golden_watering_can",quantity:1}],unlocks:["ancient_greenhouse"]},dialogue:{offer:"Legends tell of an ancient fruit with miraculous properties. Find its seed.",inProgress:"Grow the ancient fruit and brew wine from it. Patience is required.",complete:"Master Vintner! You have unlocked the secrets of the ancient fruit."},level:25,repeatable:!1},{id:"king_of_the_sea",name:"King of the Sea",description:"Become the greatest fisher and catch all legendary fish.",type:"legendary",giver:"innkeeper",prerequisites:["fishing_lesson"],objectives:[{type:"fish",target:"legend",count:1,description:'Catch the legendary fish known as "Legend"'},{type:"fish",target:"glacierfish",count:1,description:"Brave the frozen waters and catch the Glacierfish"},{type:"fish",target:"crimsonfish",count:1,description:"Catch the elusive Crimsonfish from the summer seas"},{type:"fish",target:"angler",count:1,description:"Find and catch the Angler in its hidden location"},{type:"fish",target:"mutant_carp",count:1,description:"Catch the mysterious Mutant Carp from the sewers"}],rewards:{xp:5e3,gold:12500,items:[{itemId:"neptune_trident",quantity:1},{itemId:"master_bait",quantity:100}],unlocks:["ocean_temple"]},dialogue:{offer:"Five legendary fish swim in these waters. Catch them all and earn the title.",inProgress:"Each legendary fish has its own territory and season. Study the waters.",complete:"All five legendary fish! You are the undisputed King of the Sea!"},level:30,repeatable:!1},{id:"dragon_slayer",name:"Dragon Slayer",description:"Prepare yourself and slay the ancient dragon.",type:"legendary",giver:"adventurer",prerequisites:["frost_wyrm_hunt"],objectives:[{type:"craft",target:"dragonbane_sword",count:1,description:"Forge the legendary dragon-slaying sword Dragonbane"},{type:"collect",target:"dragon_scale",count:20,description:"Collect 20 dragon scales to craft protective armor"},{type:"kill",target:"ancient_dragon",count:1,description:"Enter the dragon's lair and defeat the ancient beast"}],rewards:{xp:1e4,gold:58e3,items:[{itemId:"dragon_armor",quantity:1},{itemId:"dragon_heart",quantity:1},{itemId:"dragon_mount",quantity:1},{itemId:"prismatic_shard",quantity:5}],unlocks:["dragon_lair_home"]},dialogue:{offer:"The ancient dragon stirs. Forge Dragonbane, gather scales, and face the beast.",inProgress:"You are not yet ready. Forge the sword. Craft the armor. Then fight.",complete:"Dragon Slayer! The beast is fallen and its lair is yours."},level:45,repeatable:!1},{id:"legend_community_restoration",name:"Community Restoration",description:"Restore the community center and bring prosperity to the valley.",type:"legendary",giver:"mayor",prerequisites:["community_restoration"],objectives:[{type:"collect",target:"crafts_room_bundle",count:1,description:"Complete the Crafts Room bundles"},{type:"collect",target:"pantry_bundle",count:1,description:"Complete the Pantry bundles"},{type:"collect",target:"fish_tank_bundle",count:1,description:"Complete the Fish Tank bundles"},{type:"collect",target:"boiler_room_bundle",count:1,description:"Complete the Boiler Room bundles"},{type:"collect",target:"bulletin_board_bundle",count:1,description:"Complete the Bulletin Board bundles"},{type:"collect",target:"vault_bundle",count:1,description:"Complete the Vault donation"}],rewards:{xp:5e3,gold:7e3,items:[{itemId:"stardrop",quantity:1}],unlocks:["movie_theater","bus_repair"]},dialogue:{offer:"The community center has six rooms to restore. Each requires special bundles.",inProgress:"Keep gathering items for the bundles. Every room matters.",complete:"Valley Hero! The community center shines with renewed purpose!"},level:20,repeatable:!1},{id:"the_lost_shipment",name:"The Lost Shipment",description:"A supply shipment went missing on the road to Haven. Find it.",type:"side",giver:"shopkeeper",prerequisites:[],objectives:[{type:"explore",target:"east_road",count:1,description:"Search the East Road"},{type:"collect",target:"lost_crate",count:3,description:"Recover 3 Lost Supply Crates"},{type:"deliver",target:"lost_crate",count:3,description:"Return crates to the General Store"}],rewards:{xp:100,gold:300,items:[{itemId:"supply_voucher",quantity:1}]},dialogue:{offer:"My last shipment never arrived! Something must have happened on the East Road.",inProgress:"The crates should be somewhere along the East Road. Watch for bandits.",complete:"My supplies! You saved my business. Take this voucher for a discount."},level:3,repeatable:!1},{id:"ancient_library",name:"The Ancient Library",description:"The wizard has discovered clues to a hidden library of forbidden knowledge.",type:"side",giver:"wizard",prerequisites:["wizard_artifact"],objectives:[{type:"collect",target:"library_key_fragment",count:3,description:"Find 3 Library Key Fragments"},{type:"explore",target:"ancient_library",count:1,description:"Discover the Ancient Library"},{type:"collect",target:"forbidden_tome",count:1,description:"Retrieve the Forbidden Tome"}],rewards:{xp:500,gold:1200,items:[{itemId:"enchantment_scroll",quantity:3}]},dialogue:{offer:"I have found references to a hidden library. Help me find the key fragments.",inProgress:"The key fragments are scattered across the dungeons. Keep searching.",complete:"The Forbidden Tome! This knowledge was thought lost forever."},level:15,repeatable:!1},{id:"haunted_mine_mystery",name:"The Haunted Mine",description:"Strange sounds echo from an abandoned mine shaft. Investigate.",type:"side",giver:"blacksmith",prerequisites:["dungeon_intro"],objectives:[{type:"explore",target:"abandoned_shaft",count:1,description:"Enter the Abandoned Mine Shaft"},{type:"collect",target:"miners_journal",count:1,description:"Find the old miner's journal"},{type:"kill",target:"mine_wraith",count:1,description:"Defeat the Mine Wraith"}],rewards:{xp:350,gold:700,items:[{itemId:"spectral_pickaxe",quantity:1}]},dialogue:{offer:"An old mine shaft has been making strange noises. My grandfather worked there.",inProgress:"The shaft is dangerous. Look for the journal to understand what happened.",complete:"The wraith was the old foreman... rest easy now. This pickaxe was his."},level:10,repeatable:!1},{id:"mayors_request",name:"The Mayor's Special Request",description:"The mayor needs rare items for an important diplomatic meeting.",type:"side",giver:"mayor",prerequisites:["welcome_quest"],objectives:[{type:"collect",target:"gold_bar",count:5,description:"Obtain 5 Gold Bars"},{type:"collect",target:"diamond",count:1,description:"Find a Diamond"},{type:"cook",target:"gourmet_meal",count:1,description:"Prepare a Gourmet Meal"}],rewards:{xp:300,gold:1500,items:[{itemId:"mayors_medallion",quantity:1}]},dialogue:{offer:"I have an important diplomatic meeting. I need gold, a diamond, and fine food.",inProgress:"Those items are not easy to obtain, but I have faith in you.",complete:"Magnificent! The meeting will be a success. Accept this medallion."},level:12,repeatable:!1}],Ze=new Map(Mt.map(r=>[r.id,r]));class Gn{questStates=new Map;objectiveProgress=new Map;dailyResetTimer=0;weeklyResetTimer=0;questCompleteCallbacks=[];objectiveUpdateCallbacks=[];canAccept(e){const t=Ze.get(e);if(!t)return!1;const i=this.questStates.get(e);if(i==="active"||i==="complete"||i==="turned_in"||i==="failed"&&!t.repeatable)return!1;for(const s of t.prerequisites){const a=this.questStates.get(s);if(a!=="complete"&&a!=="turned_in")return!1}return!0}acceptQuest(e){if(!this.canAccept(e))return!1;const t=Ze.get(e);return this.questStates.set(e,"active"),this.objectiveProgress.set(e,t.objectives.map(()=>0)),!0}updateObjective(e,t,i=1){for(const[s,a]of this.questStates){if(a!=="active")continue;const o=Ze.get(s);if(!o)continue;const n=this.objectiveProgress.get(s);if(!n)continue;let l=!1;for(let c=0;c<o.objectives.length;c++){const d=o.objectives[c];if(d.type===e&&d.target===t){const h=n[c];if(n[c]=Math.min(n[c]+i,d.count),n[c]!==h){l=!0;for(const u of this.objectiveUpdateCallbacks)u(s,c,n[c],d.count)}}}l&&this.allObjectivesMet(o,n)&&this.completeQuest(s)}}completeQuest(e){if(this.questStates.get(e)!=="active")return null;const i=Ze.get(e);if(!i)return null;this.questStates.set(e,"complete");for(const s of this.questCompleteCallbacks)s(e,i.rewards);return i.rewards}failQuest(e){this.questStates.get(e)==="active"&&(this.questStates.set(e,"failed"),this.objectiveProgress.delete(e))}turnInQuest(e){return this.questStates.get(e)!=="complete"?!1:(this.questStates.set(e,"turned_in"),this.objectiveProgress.delete(e),!0)}getActiveQuests(){const e=[];for(const[t,i]of this.questStates){if(i!=="active")continue;const s=Ze.get(t),a=this.objectiveProgress.get(t);s&&a&&e.push({quest:s,progress:[...a],status:i})}return e}getAvailableQuests(e){const t=[];for(const i of Mt){const s=this.questStates.get(i.id);if(s==="active"||s==="complete"||s==="turned_in"||s==="failed"&&!i.repeatable)continue;let a=!0;for(const o of i.prerequisites){const n=this.questStates.get(o),l=e?.has(o)??!1;if(n!=="complete"&&n!=="turned_in"&&!l){a=!1;break}}a&&t.push(i)}return t}getQuestStatus(e){return this.questStates.get(e)??"available"}getObjectiveProgress(e){const t=this.objectiveProgress.get(e);return t?[...t]:null}isComplete(e){const t=this.questStates.get(e);return t==="complete"||t==="turned_in"}resetDailies(){for(const e of Mt){if(e.type!=="daily")continue;const t=this.questStates.get(e.id);(t==="complete"||t==="turned_in"||t==="failed")&&(this.questStates.set(e.id,"available"),this.objectiveProgress.delete(e.id))}}resetWeeklies(){for(const e of Mt){if(e.type!=="weekly")continue;const t=this.questStates.get(e.id);(t==="complete"||t==="turned_in"||t==="failed")&&(this.questStates.set(e.id,"available"),this.objectiveProgress.delete(e.id))}}getDailyResetTimer(){return this.dailyResetTimer}getWeeklyResetTimer(){return this.weeklyResetTimer}getQuestDef(e){return Ze.get(e)??null}setDailyResetTimer(e){this.dailyResetTimer=e}setWeeklyResetTimer(e){this.weeklyResetTimer=e}onQuestComplete(e){this.questCompleteCallbacks.push(e)}onObjectiveUpdate(e){this.objectiveUpdateCallbacks.push(e)}serialize(){const e={};for(const[i,s]of this.questStates)e[i]=s;const t={};for(const[i,s]of this.objectiveProgress)t[i]=[...s];return{states:e,progress:t,dailyResetTimer:this.dailyResetTimer,weeklyResetTimer:this.weeklyResetTimer}}deserialize(e){if(this.questStates.clear(),this.objectiveProgress.clear(),e.states)for(const[t,i]of Object.entries(e.states))this.questStates.set(t,i);if(e.progress)for(const[t,i]of Object.entries(e.progress))this.objectiveProgress.set(t,[...i]);this.dailyResetTimer=e.dailyResetTimer??0,this.weeklyResetTimer=e.weeklyResetTimer??0}allObjectivesMet(e,t){for(let i=0;i<e.objectives.length;i++)if(t[i]<e.objectives[i].count)return!1;return!0}}const Vt=[{id:"farming",name:"Farming",description:"Plant and harvest crops more efficiently.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:[{id:"green_thumb",name:"Green Thumb",description:"+10% crop quality chance",level:2},{id:"efficient_watering",name:"Efficient Watering",description:"Watering uses 25% less stamina",level:4},{id:"speed_grow",name:"Speed Grow",description:"10% faster crop growth",level:6},{id:"double_harvest",name:"Double Harvest",description:"15% chance for double harvest",level:8},{id:"master_farmer",name:"Master Farmer",description:"All farming bonuses doubled",level:10}]},{id:"mining",name:"Mining",description:"Mine ore and break rocks faster.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:[{id:"prospector",name:"Prospector",description:"+20% ore find chance",level:2},{id:"efficient_mining",name:"Efficient Mining",description:"Mining uses 25% less stamina",level:4},{id:"gem_finder",name:"Gem Finder",description:"+30% gem find chance",level:6},{id:"excavator",name:"Excavator",description:"Break rocks in fewer hits",level:8},{id:"master_miner",name:"Master Miner",description:"Chance to find rare ores",level:10}]},{id:"combat",name:"Combat",description:"Deal more damage and take less.",maxLevel:10,xpPerLevel:[100,250,500,1e3,2e3,3500,5500,8e3,12e3,2e4],perks:[{id:"fighter",name:"Fighter",description:"+10% attack damage",level:2},{id:"defender",name:"Defender",description:"-15% damage taken",level:4},{id:"critical",name:"Critical Strike",description:"+10% crit chance for 2x damage",level:6},{id:"vampire",name:"Vampiric",description:"5% life steal on attacks",level:8},{id:"warrior",name:"Warrior",description:"All combat bonuses doubled",level:10}]},{id:"foraging",name:"Foraging",description:"Find more items while foraging.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:[{id:"gatherer",name:"Gatherer",description:"+25% forage amount",level:2},{id:"botanist",name:"Botanist",description:"All foraged items are best quality",level:4},{id:"tracker",name:"Tracker",description:"Foragables are highlighted",level:6},{id:"lumberjack",name:"Lumberjack",description:"+50% wood from trees",level:8},{id:"nature_friend",name:"Nature Friend",description:"Animals are friendly",level:10}]},{id:"fishing",name:"Fishing",description:"Catch fish more easily and find treasures.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:[{id:"fisher",name:"Fisher",description:"Fish bite faster",level:2},{id:"treasure_hunter",name:"Treasure Hunter",description:"+20% treasure chance",level:4},{id:"angler",name:"Angler",description:"Fish sell for 25% more",level:6},{id:"master_bait",name:"Master Bait",description:"Double bait effectiveness",level:8},{id:"legendary_fisher",name:"Legendary Fisher",description:"Can catch legendary fish",level:10}]},{id:"cooking",name:"Cooking",description:"Cook better dishes with more effects.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:[{id:"chef",name:"Chef",description:"+20% food healing",level:2},{id:"seasoned",name:"Seasoned",description:"Food buffs last 30% longer",level:4},{id:"gourmet",name:"Gourmet",description:"Cooked food sells for 50% more",level:6},{id:"efficiency",name:"Efficiency",description:"20% chance to not consume ingredients",level:8},{id:"master_chef",name:"Master Chef",description:"Unlock legendary recipes",level:10}]},{id:"crafting",name:"Crafting",description:"Create better items and equipment.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:[{id:"apprentice",name:"Apprentice",description:"+10% crafting speed",level:2},{id:"resourceful",name:"Resourceful",description:"15% chance to save materials",level:4},{id:"quality_craft",name:"Quality Craft",description:"+20% chance for higher quality output",level:6},{id:"innovator",name:"Innovator",description:"Discover hidden recipes when experimenting",level:8},{id:"master_crafter",name:"Master Crafter",description:"Can craft mythic-tier equipment",level:10}]},{id:"social",name:"Social",description:"Build relationships and negotiate better.",maxLevel:10,xpPerLevel:[50,125,250,500,1e3,1750,2750,4e3,6e3,1e4],perks:[{id:"friendly",name:"Friendly",description:"+20% friendship gain from gifts",level:2},{id:"haggler",name:"Haggler",description:"10% discount at all shops",level:4},{id:"diplomat",name:"Diplomat",description:"Access to faction-exclusive quests",level:6},{id:"leader",name:"Leader",description:"Settlement NPCs +25% productivity",level:8},{id:"beloved",name:"Beloved",description:"All NPCs start at 2 hearts",level:10}]},{id:"exploration",name:"Exploration",description:"Discover the world and survive its dangers.",maxLevel:10,xpPerLevel:[75,175,350,700,1400,2450,3850,5600,8400,14e3],perks:[{id:"pathfinder",name:"Pathfinder",description:"+10% movement speed on paths",level:2},{id:"cartographer",name:"Cartographer",description:"Reveal minimap in larger radius",level:4},{id:"survivalist",name:"Survivalist",description:"50% less damage from biome hazards",level:6},{id:"treasure_sense",name:"Treasure Sense",description:"Nearby chests glow through walls",level:8},{id:"world_walker",name:"World Walker",description:"Immune to corruption slow effect",level:10}]}],bi=new Map(Vt.map(r=>[r.id,r]));class Un{skillXP=new Map;skillLevels=new Map;levelUpCallbacks=[];constructor(){for(const e of Vt)this.skillXP.set(e.id,0),this.skillLevels.set(e.id,0)}addXP(e,t){const i=bi.get(e);if(!i||t<=0)return;const s=this.skillLevels.get(e)??0,a=(this.skillXP.get(e)??0)+t;this.skillXP.set(e,a);const o=this.computeLevel(i,a);this.skillLevels.set(e,o);for(let n=s+1;n<=o;n++)for(const l of this.levelUpCallbacks)l(e,n)}getLevel(e){return this.skillLevels.get(e)??0}getXP(e){const t=bi.get(e),i=this.skillXP.get(e)??0,s=this.skillLevels.get(e)??0;if(!t)return{current:0,required:0,total:0};let a=0;for(let l=0;l<s;l++)a+=t.xpPerLevel[l]??0;const o=i-a,n=s<t.maxLevel?t.xpPerLevel[s]??0:0;return{current:o,required:n,total:i}}getUnlockedPerks(e){const t=bi.get(e);if(!t)return[];const i=this.getLevel(e);return t.perks.filter(s=>s.level<=i)}hasPerk(e){for(const t of Vt){const i=this.getLevel(t.id);for(const s of t.perks)if(s.id===e&&s.level<=i)return!0}return!1}getAllSkills(){return Vt.map(e=>{const t=this.getLevel(e.id),i=this.skillXP.get(e.id)??0,s=t<e.maxLevel?e.xpPerLevel[t]??0:0;return{id:e.id,name:e.name,level:t,xp:i,nextLevelXp:s}})}onLevelUp(e){this.levelUpCallbacks.push(e)}serialize(){const e={},t={};for(const[i,s]of this.skillXP)e[i]=s;for(const[i,s]of this.skillLevels)t[i]=s;return{xp:e,levels:t}}deserialize(e){if(e.xp)for(const[t,i]of Object.entries(e.xp))this.skillXP.set(t,i);if(e.levels)for(const[t,i]of Object.entries(e.levels))this.skillLevels.set(t,i)}computeLevel(e,t){let i=t;for(let s=0;s<e.maxLevel;s++){const a=e.xpPerLevel[s]??0;if(i<a)return s;i-=a}return e.maxLevel}}const At=[{id:"mayor",name:"Mayor Thomas",title:"Mayor of Willowbrook",description:"The friendly and formal leader of Willowbrook. He cares deeply about the town and its people, always looking for ways to improve community life.",texture:"npc_mayor",birthday:{season:"spring",day:11},schedule:{spring:[{hour:6,location:"mayor_house",x:-80,y:-120,activity:"home"},{hour:8,location:"town_hall",x:80,y:-80,activity:"work"},{hour:12,location:"tavern",x:0,y:80,activity:"lunch"},{hour:13,location:"town_hall",x:80,y:-80,activity:"work"},{hour:18,location:"town_square",x:0,y:0,activity:"socialize"},{hour:22,location:"mayor_house",x:-80,y:-120,activity:"sleep"}],summer:[{hour:6,location:"mayor_house",x:-80,y:-120,activity:"home"},{hour:8,location:"town_hall",x:80,y:-80,activity:"work"},{hour:12,location:"tavern",x:0,y:80,activity:"lunch"},{hour:13,location:"town_hall",x:80,y:-80,activity:"work"},{hour:17,location:"beach",x:0,y:200,activity:"walk"},{hour:19,location:"town_square",x:0,y:0,activity:"socialize"},{hour:22,location:"mayor_house",x:-80,y:-120,activity:"sleep"}],fall:[{hour:6,location:"mayor_house",x:-80,y:-120,activity:"home"},{hour:8,location:"town_hall",x:80,y:-80,activity:"work"},{hour:12,location:"tavern",x:0,y:80,activity:"lunch"},{hour:13,location:"town_hall",x:80,y:-80,activity:"work"},{hour:18,location:"town_square",x:0,y:0,activity:"socialize"},{hour:22,location:"mayor_house",x:-80,y:-120,activity:"sleep"}],winter:[{hour:7,location:"mayor_house",x:-80,y:-120,activity:"home"},{hour:9,location:"town_hall",x:80,y:-80,activity:"work"},{hour:12,location:"tavern",x:0,y:80,activity:"lunch"},{hour:13,location:"town_hall",x:80,y:-80,activity:"work"},{hour:17,location:"town_hall",x:80,y:-80,activity:"reading"},{hour:20,location:"mayor_house",x:-80,y:-120,activity:"home"},{hour:22,location:"mayor_house",x:-80,y:-120,activity:"sleep"}],rainy:[{hour:6,location:"mayor_house",x:-80,y:-120,activity:"home"},{hour:8,location:"town_hall",x:80,y:-80,activity:"work"},{hour:22,location:"mayor_house",x:-80,y:-120,activity:"sleep"}]},gifts:{loved:["truffle","ancient_fruit","prismatic_shard"],liked:["coffee","formal_wear","gold_ore","wine"],disliked:["trash","slime","weeds"],hated:["void_egg","rotten_food"]},dialogue:{greeting:"Welcome to our humble town! Ah, our newest farmer! How are the crops?",friendship:{0:["Welcome to our humble town!","Good day! The town prospers with your help."],2:["Ah, our newest farmer! How are the crops?","Your grandmother was a remarkable woman. She saved this town more times than most know.","There's something... off about Willowbrook lately. Can't quite put my finger on it."],4:["You've become such an important part of our community!","The old community center holds memories of better times. If only we could restore it..."],6:["I'm so glad you chose to settle here.","Word is you've been delving deep into the mines. Found anything unusual?","The town feels... lighter somehow. Like a weight is slowly lifting."],8:["You've done something incredible. I can feel hope returning to Willowbrook.","The three seals... just like in the old legends. Your grandmother would be so proud."],10:["The curse is lifted! You've saved us all! Willowbrook will never forget what you've done.","I... I can see the colors more vividly now. The darkness that hung over us is gone."]},birthday:"It's my birthday! How kind of you to remember. A toast to another year serving Willowbrook!",festival:{egg_hunt:"The egg hunt is a Willowbrook tradition! May the best egg hunter win!",luau:"This summer heat is intense! Stay hydrated, farmer.",harvest:"Harvest time! I love seeing the town so productive.",winter_star:"The Feast of the Winter Star will be magical this year! Bundle up!"}},questIds:["welcome_quest","town_cleanup"],homeCity:"willowbrook"},{id:"shopkeeper",name:"Martha",title:"General Store Owner",description:"Cheerful and business-minded, Martha runs the general store with a warm smile. She stocks everything a farmer could need.",texture:"npc_shopkeeper",birthday:{season:"summer",day:18},schedule:{spring:[{hour:6,location:"shop_house",x:-160,y:40,activity:"home"},{hour:8,location:"general_store",x:-120,y:40,activity:"work"},{hour:20,location:"tavern",x:0,y:80,activity:"socialize"},{hour:22,location:"shop_house",x:-160,y:40,activity:"sleep"}],summer:[{hour:6,location:"shop_house",x:-160,y:40,activity:"home"},{hour:8,location:"general_store",x:-120,y:40,activity:"work"},{hour:19,location:"town_square",x:0,y:0,activity:"walk"},{hour:21,location:"shop_house",x:-160,y:40,activity:"home"},{hour:22,location:"shop_house",x:-160,y:40,activity:"sleep"}],fall:[{hour:6,location:"shop_house",x:-160,y:40,activity:"home"},{hour:8,location:"general_store",x:-120,y:40,activity:"work"},{hour:20,location:"tavern",x:0,y:80,activity:"socialize"},{hour:22,location:"shop_house",x:-160,y:40,activity:"sleep"}],winter:[{hour:7,location:"shop_house",x:-160,y:40,activity:"home"},{hour:9,location:"general_store",x:-120,y:40,activity:"work"},{hour:18,location:"shop_house",x:-160,y:40,activity:"home"},{hour:22,location:"shop_house",x:-160,y:40,activity:"sleep"}],rainy:[{hour:6,location:"shop_house",x:-160,y:40,activity:"home"},{hour:8,location:"general_store",x:-120,y:40,activity:"work"},{hour:20,location:"shop_house",x:-160,y:40,activity:"home"},{hour:22,location:"shop_house",x:-160,y:40,activity:"sleep"}]},gifts:{loved:["diamond","pink_cake","fairy_rose"],liked:["flowers","gems","cooked_food","honey"],disliked:["weeds","raw_fish","clay"],hated:["slime","bug_meat"]},dialogue:{greeting:"Welcome to my shop! Take a look around!",friendship:{0:["Welcome to my shop! Take a look around!","Hello there! Need any supplies?"],2:["Good to see you! What can I get for you today?","Your grandmother used to come here every week. Always knew exactly what she needed.","Business has been slow lately. Something's been keeping folks at home."],4:["You remind me of your grandmother - that same determined look in your eyes.","The old-timers whisper about a curse. I don't know what to believe anymore.","Had a few customers mention seeing strange lights in the mines. You know anything about that?"],6:["My grandmother's grandmother used to tell stories about magical seals. Never thought they were real!","More customers lately! People seem happier, more willing to come out."],8:["Sales are up! Everyone's celebrating! Thank you for everything you've done!","The whole town owes you a debt we can never repay."],10:["You're like family to me now. Anything you need, just ask."]},birthday:"Oh! You remembered my birthday? That's so sweet! Come in, everything's half off today!",festival:{egg_hunt:"Spring seeds are selling fast! Better stock up!",luau:"Summer goods are in! Cold drinks selling well.",harvest:"Got some harvest supplies you might need!",winter_star:"Hot cocoa mix is my winter bestseller!"}},shop:{items:["parsnip_seeds","potato_seeds","cauliflower_seeds","bean_seeds","melon_seeds","tomato_seeds","blueberry_seeds","corn_seeds","pumpkin_seeds","yam_seeds","cranberry_seeds","eggplant_seeds","wheat_seeds","rice_seeds","sugar_cane_seeds","fertilizer","speed_gro","quality_fertilizer","hay","animal_treats","backpack_upgrade"],priceMultiplier:1},questIds:[],homeCity:"willowbrook"},{id:"blacksmith",name:"Garrett",title:"Master Blacksmith",description:"Gruff but kind, Garrett has been forging tools and weapons in Willowbrook for decades. His craftsmanship is unmatched.",texture:"npc_blacksmith",birthday:{season:"winter",day:5},schedule:{spring:[{hour:6,location:"blacksmith_house",x:160,y:80,activity:"home"},{hour:7,location:"blacksmith",x:120,y:40,activity:"work"},{hour:18,location:"tavern",x:0,y:80,activity:"socialize"},{hour:21,location:"blacksmith_house",x:160,y:80,activity:"sleep"}],summer:[{hour:6,location:"blacksmith_house",x:160,y:80,activity:"home"},{hour:7,location:"blacksmith",x:120,y:40,activity:"work"},{hour:18,location:"tavern",x:0,y:80,activity:"socialize"},{hour:21,location:"blacksmith_house",x:160,y:80,activity:"sleep"}],fall:[{hour:6,location:"blacksmith_house",x:160,y:80,activity:"home"},{hour:7,location:"blacksmith",x:120,y:40,activity:"work"},{hour:18,location:"tavern",x:0,y:80,activity:"socialize"},{hour:21,location:"blacksmith_house",x:160,y:80,activity:"sleep"}],winter:[{hour:7,location:"blacksmith_house",x:160,y:80,activity:"home"},{hour:8,location:"blacksmith",x:120,y:40,activity:"work"},{hour:17,location:"tavern",x:0,y:80,activity:"socialize"},{hour:20,location:"blacksmith_house",x:160,y:80,activity:"sleep"}],rainy:[{hour:6,location:"blacksmith_house",x:160,y:80,activity:"home"},{hour:7,location:"blacksmith",x:120,y:40,activity:"work"},{hour:20,location:"blacksmith_house",x:160,y:80,activity:"sleep"}]},gifts:{loved:["iridium_bar","gold_bar","prismatic_shard"],liked:["ores","gems","beer","copper_bar","iron_bar"],disliked:["flowers","sweets","fish"],hated:["joja_cola","hay"]},dialogue:{greeting:"*grunts* Oh, it's you. Need something forged?",friendship:{0:["*grunts* Oh, it's you. Need something forged?","The forge is hot today. Good for metalwork."],2:["Brought me any ores? I can make something useful.","Your grandmother commissioned special tools from me once. Said they were for 'protection.'","Something's wrong with the metal lately. It fights me. Cursed, maybe."],4:["Heard you've been mining deep. If you find unusual ores, bring 'em to me.","The forge is burning brighter today. First time in years. Odd.","Bah. The forge hasn't burned as bright since... well, for a long time."],6:["Three seals of ancient power... I forged replicas of those once, for your grandmother.","My hammer sings true again! Whatever you did, it's working."],8:["The curse is broken! Now THIS is how a forge should burn!","I can create masterworks again! Come back anytime - you've earned the best I can make."],10:["You're the finest person I know. And I don't say that to anyone."]},birthday:"Bah, another year older. ...Fine, you can have a discount today. Don't tell anyone.",festival:{egg_hunt:"Good time to upgrade tools for planting.",luau:"The forge is extra hot today... just like outside.",harvest:"Harvest tools need sharpening? I'm your man.",winter_star:"Cold metal is harder to work. Prices go up."}},shop:{items:["copper_bar","iron_bar","gold_bar","pickaxe_upgrade","axe_upgrade","hoe_upgrade","watering_can_upgrade","sword_basic","sword_steel","sword_gold"],priceMultiplier:1},questIds:[],homeCity:"willowbrook"},{id:"farmer_girl",name:"Lily",title:"Flower Farmer",description:"Shy and nature-loving, Lily tends her family flower farm at the edge of town. She has a deep connection with plants and animals alike.",texture:"npc_farmer_girl",birthday:{season:"spring",day:24},schedule:{spring:[{hour:6,location:"lily_farm",x:-200,y:-80,activity:"home"},{hour:8,location:"lily_fields",x:-240,y:-40,activity:"farming"},{hour:12,location:"lily_farm",x:-200,y:-80,activity:"lunch"},{hour:13,location:"lily_fields",x:-240,y:-40,activity:"farming"},{hour:17,location:"forest_path",x:-280,y:0,activity:"walk"},{hour:19,location:"lily_farm",x:-200,y:-80,activity:"home"},{hour:22,location:"lily_farm",x:-200,y:-80,activity:"sleep"}],summer:[{hour:6,location:"lily_farm",x:-200,y:-80,activity:"home"},{hour:7,location:"lily_fields",x:-240,y:-40,activity:"farming"},{hour:12,location:"lily_farm",x:-200,y:-80,activity:"lunch"},{hour:13,location:"lily_fields",x:-240,y:-40,activity:"farming"},{hour:16,location:"beach",x:0,y:200,activity:"swimming"},{hour:19,location:"lily_farm",x:-200,y:-80,activity:"home"},{hour:22,location:"lily_farm",x:-200,y:-80,activity:"sleep"}],fall:[{hour:6,location:"lily_farm",x:-200,y:-80,activity:"home"},{hour:8,location:"lily_fields",x:-240,y:-40,activity:"farming"},{hour:12,location:"lily_farm",x:-200,y:-80,activity:"lunch"},{hour:13,location:"lily_fields",x:-240,y:-40,activity:"farming"},{hour:17,location:"forest_path",x:-280,y:0,activity:"walk"},{hour:19,location:"lily_farm",x:-200,y:-80,activity:"home"},{hour:22,location:"lily_farm",x:-200,y:-80,activity:"sleep"}],winter:[{hour:8,location:"lily_farm",x:-200,y:-80,activity:"home"},{hour:10,location:"general_store",x:-120,y:40,activity:"shopping"},{hour:12,location:"lily_farm",x:-200,y:-80,activity:"home"},{hour:14,location:"tavern",x:0,y:80,activity:"socialize"},{hour:17,location:"lily_farm",x:-200,y:-80,activity:"home"},{hour:22,location:"lily_farm",x:-200,y:-80,activity:"sleep"}],rainy:[{hour:6,location:"lily_farm",x:-200,y:-80,activity:"home"},{hour:22,location:"lily_farm",x:-200,y:-80,activity:"sleep"}]},gifts:{loved:["sunflower","fairy_rose","sweet_pea","poppy"],liked:["flowers","vegetables","honey","salad"],disliked:["weapons","monster_parts","slime"],hated:["void_egg","bug_meat","coal"]},dialogue:{greeting:"Oh! H-hello there...",friendship:{0:["Oh! H-hello there...","The flowers are beautiful today, don't you think?"],2:["I love the smell of fresh soil...","The flowers... they've been wilting faster than they should. Like they're scared.","I sometimes see shadows in the corner of my eye. It's probably nothing..."],4:["I feel like I can really talk to you...","Your grandmother's garden was always so beautiful. She had a gift.","The flowers are perking up! They can sense something changing, I think."],6:["You make me feel less shy somehow.","I had a dream about you... you were holding something glowing. Three somethings.","Everything is blooming! Even out of season! It's like magic!"],8:["W-when you're around, my heart beats faster...","I feel... lighter. Like a cloud has lifted from my heart."],10:["I... I think about you a lot.","The world is so beautiful now! Thank you for bringing the light back!","I want to plant a garden in your grandmother's memory. Would you help me?"]},birthday:"It's my birthday! The spring flowers always bloom brightest on this day... or maybe that's just how I feel!",festival:{egg_hunt:"The spring flowers are blooming! They're so pretty...",luau:"The sunflowers are taller than me now!",harvest:"I made a flower crown from autumn leaves!",winter_star:"Hot cocoa by the fireplace is the best..."}},questIds:["lily_flower_field","lily_confession"],homeCity:"willowbrook"},{id:"innkeeper",name:"Harold",title:"Owner of the Rusty Tankard",description:"Jolly and welcoming, Harold runs the town tavern. He cooks, serves drinks, rents rooms, and always has a story to share.",texture:"npc_innkeeper",birthday:{season:"fall",day:8},schedule:{spring:[{hour:6,location:"inn_kitchen",x:-40,y:120,activity:"cooking"},{hour:10,location:"tavern",x:0,y:80,activity:"work"},{hour:0,location:"tavern",x:0,y:80,activity:"cleaning"},{hour:2,location:"inn_room",x:40,y:120,activity:"sleep"}],summer:[{hour:6,location:"inn_kitchen",x:-40,y:120,activity:"cooking"},{hour:10,location:"tavern",x:0,y:80,activity:"work"},{hour:0,location:"tavern",x:0,y:80,activity:"cleaning"},{hour:2,location:"inn_room",x:40,y:120,activity:"sleep"}],fall:[{hour:6,location:"inn_kitchen",x:-40,y:120,activity:"cooking"},{hour:10,location:"tavern",x:0,y:80,activity:"work"},{hour:0,location:"tavern",x:0,y:80,activity:"cleaning"},{hour:2,location:"inn_room",x:40,y:120,activity:"sleep"}],winter:[{hour:7,location:"inn_kitchen",x:-40,y:120,activity:"cooking"},{hour:10,location:"tavern",x:0,y:80,activity:"work"},{hour:0,location:"tavern",x:0,y:80,activity:"cleaning"},{hour:2,location:"inn_room",x:40,y:120,activity:"sleep"}],rainy:[{hour:6,location:"inn_kitchen",x:-40,y:120,activity:"cooking"},{hour:10,location:"tavern",x:0,y:80,activity:"work"},{hour:0,location:"tavern",x:0,y:80,activity:"cleaning"},{hour:2,location:"inn_room",x:40,y:120,activity:"sleep"}]},gifts:{loved:["truffle_oil","aged_wine","roasted_venison"],liked:["beer","wine","cooked_food"],disliked:["raw_meat","slime"],hated:["rotten_food","void_egg"]},dialogue:{greeting:"Welcome to the Rusty Tankard! Pull up a chair!",friendship:{0:["Welcome to the Rusty Tankard! Pull up a chair!","What'll it be? Food, drink, or a room for the night?"],2:["Ahaha! Good to see a friendly face!","Folk don't travel much these days. Bad omens on the roads, they say.","Your grandmother used to sit right there, telling stories. Miss her terribly."],4:["The ale's been tasting off. Or maybe it's just the gloom affecting my taste buds.","More travelers passing through! First time in months!","You've got a look about you - like someone on a quest. What're you chasing?"],6:["The inn is filling up again! People want to visit Willowbrook!","Whatever you're doing, keep doing it. The town needs more of that hope."],8:["Drinks are on the house! We're celebrating for a week straight!","You're a hero! Your tale will be told in this tavern for generations!"],10:["You're family here. The Rusty Tankard is your home away from home, always."]},birthday:"My birthday? Well then, let me cook up something special! Everyone eats free tonight!",festival:{egg_hunt:"Spring travelers are starting to arrive!",luau:"Summer tourists keep me busy! Come have a cold one!",harvest:"Harvest feast menu is ready! You'll love it!",winter_star:"Nothing beats my winter stew on a cold day!"}},shop:{items:["beer","wine","cider","coffee","hot_cocoa","bread","meat_stew","fish_stew","salad","room_rental"],priceMultiplier:1},questIds:[],homeCity:"willowbrook"},{id:"wizard",name:"Eldric",title:"Arcane Scholar",description:"Mysterious and eccentric, Eldric dwells in his tower studying ancient magic. He knows more about the curse on Willowbrook than anyone alive.",texture:"npc_wizard",birthday:{season:"winter",day:17},schedule:{spring:[{hour:0,location:"wizard_tower",x:200,y:-160,activity:"research"},{hour:6,location:"wizard_tower",x:200,y:-160,activity:"sleep"},{hour:12,location:"wizard_tower",x:200,y:-160,activity:"experiments"},{hour:18,location:"forest_shrine",x:280,y:-200,activity:"ritual"}],summer:[{hour:0,location:"wizard_tower",x:200,y:-160,activity:"research"},{hour:6,location:"wizard_tower",x:200,y:-160,activity:"sleep"},{hour:12,location:"wizard_tower",x:200,y:-160,activity:"experiments"},{hour:18,location:"forest_shrine",x:280,y:-200,activity:"ritual"}],fall:[{hour:0,location:"wizard_tower",x:200,y:-160,activity:"research"},{hour:6,location:"wizard_tower",x:200,y:-160,activity:"sleep"},{hour:12,location:"wizard_tower",x:200,y:-160,activity:"experiments"},{hour:16,location:"forest_shrine",x:280,y:-200,activity:"ritual"}],winter:[{hour:0,location:"wizard_tower",x:200,y:-160,activity:"research"},{hour:8,location:"wizard_tower",x:200,y:-160,activity:"sleep"},{hour:14,location:"wizard_tower",x:200,y:-160,activity:"experiments"},{hour:20,location:"wizard_tower",x:200,y:-160,activity:"meditation"}],rainy:[{hour:0,location:"wizard_tower",x:200,y:-160,activity:"research"},{hour:6,location:"wizard_tower",x:200,y:-160,activity:"sleep"},{hour:12,location:"wizard_tower",x:200,y:-160,activity:"scrying"},{hour:18,location:"wizard_tower",x:200,y:-160,activity:"experiments"}]},gifts:{loved:["void_essence","ancient_fruit","prismatic_shard"],liked:["purple_mushroom","solar_essence","fire_quartz"],disliked:["common_items","hay","clay"],hated:["joja_cola","trash"]},dialogue:{greeting:"The stars speak of interesting times...",friendship:{0:["The stars speak of interesting times...","Ah, the one touched by destiny. I've been expecting you."],2:["Reality is but a thin veil, young one.","The magical ley lines beneath Willowbrook are corrupted. It grows worse each day.","Your grandmother understood things most mortals cannot comprehend. As do you, I suspect."],4:["Three seals were placed long ago to contain the darkness. They're weakening.","The seal's power resonates within you. Your grandmother chose her heir wisely.","Each seal you recover, the curse weakens. Continue your quest."],6:["All three seals! The ritual can now be completed. Come to the community center when ready.","The power within you is immense. Handle it with care, and with love."],8:["It is done. The balance is restored. Your grandmother can finally rest.","You have exceeded all expectations. The spirits of Willowbrook thank you."],10:["You are perhaps the most remarkable being I have encountered in centuries of study."]},birthday:"My birthday? Time is an illusion, but... I appreciate the sentiment. The stars aligned for this day.",festival:{egg_hunt:"The vernal equinox amplifies magical energies...",luau:"The summer solstice approaches. Power builds.",harvest:"The autumnal equinox brings balance to magic.",winter_star:"The winter solstice. A time for reflection and prophecy."}},questIds:["wizard_artifact","prismatic_quest"],homeCity:"willowbrook"},{id:"adventurer",name:"Marcus",title:"Adventurer",description:"Brave and boastful, Marcus is always seeking the next dungeon to conquer. Beneath the bravado, he has a heart of gold and a story behind every scar.",texture:"npc_adventurer",birthday:{season:"summer",day:2},schedule:{spring:[{hour:6,location:"adventurer_guild",x:160,y:-40,activity:"training"},{hour:10,location:"dungeon_entrance",x:240,y:80,activity:"exploring"},{hour:18,location:"tavern",x:0,y:80,activity:"drinking"},{hour:23,location:"adventurer_guild",x:160,y:-40,activity:"sleep"}],summer:[{hour:6,location:"adventurer_guild",x:160,y:-40,activity:"training"},{hour:9,location:"dungeon_entrance",x:240,y:80,activity:"exploring"},{hour:17,location:"beach",x:0,y:200,activity:"relaxing"},{hour:19,location:"tavern",x:0,y:80,activity:"drinking"},{hour:23,location:"adventurer_guild",x:160,y:-40,activity:"sleep"}],fall:[{hour:6,location:"adventurer_guild",x:160,y:-40,activity:"training"},{hour:10,location:"dungeon_entrance",x:240,y:80,activity:"exploring"},{hour:18,location:"tavern",x:0,y:80,activity:"drinking"},{hour:23,location:"adventurer_guild",x:160,y:-40,activity:"sleep"}],winter:[{hour:7,location:"adventurer_guild",x:160,y:-40,activity:"training"},{hour:10,location:"dungeon_entrance",x:240,y:80,activity:"exploring"},{hour:16,location:"tavern",x:0,y:80,activity:"drinking"},{hour:22,location:"adventurer_guild",x:160,y:-40,activity:"sleep"}],rainy:[{hour:6,location:"adventurer_guild",x:160,y:-40,activity:"training"},{hour:10,location:"dungeon_entrance",x:240,y:80,activity:"exploring"},{hour:18,location:"tavern",x:0,y:80,activity:"drinking"},{hour:23,location:"adventurer_guild",x:160,y:-40,activity:"sleep"}]},gifts:{loved:["dragon_tooth","lava_katana","prismatic_shard"],liked:["weapons","monster_parts","beer"],disliked:["flowers","cute_things","sweets"],hated:["fairy_rose","poppy"]},dialogue:{greeting:"Ho there, fellow warrior! Ready for adventure?",friendship:{0:["Ho there, fellow warrior! Ready for adventure?","The dungeons won't clear themselves!"],2:["I've slain twenty slimes today. A new record!","The monsters in the mines are getting stronger. Something's riling them up.","Ever feel like you're being watched? Started happening more lately."],4:["Your grandmother was tough! She could swing a sword with the best of us.","The monsters are calming down! Fewer of them too. What'd you do?","Found any treasure down there? I've been finding weird glowing rocks."],6:["The dungeons are safer now! Whatever you did, it helped!","You're the real adventurer here. I'm just playing at it compared to you.","Want to delve into the dungeons together sometime?"],8:["Best day of my life! The curse is gone! Let's go dungeon diving to celebrate!","You're a legend now! Mind if I tell people we're friends?"],10:["I... I've never met anyone like you. You make me want to be braver. For real, not just for show."]},birthday:"My birthday? Time for the tavern to break out the good stuff! Come celebrate with me!",festival:{egg_hunt:"Egg hunts? Not exactly dungeon crawling, but I'll play along!",luau:"Summer's perfect for beach training! ...And maybe some relaxation.",harvest:"Fall means the deep dungeons open up. Best season for treasure!",winter_star:"Winter quests are the toughest. I love it!"}},questIds:["marcus_dungeon","marcus_scar_story"],homeCity:"willowbrook"},{id:"doctor",name:"Dr. Elena",title:"Town Physician",description:"Caring and professional, Dr. Elena treats the ailments of Willowbrook. She struggles to explain the mysterious illness affecting the town, and suspects something beyond medicine is at work.",texture:"npc_doctor",birthday:{season:"fall",day:21},schedule:{spring:[{hour:6,location:"clinic_house",x:-120,y:-80,activity:"home"},{hour:8,location:"clinic",x:-80,y:-40,activity:"work"},{hour:18,location:"beach",x:0,y:200,activity:"walk"},{hour:20,location:"clinic_house",x:-120,y:-80,activity:"reading"},{hour:22,location:"clinic_house",x:-120,y:-80,activity:"sleep"}],summer:[{hour:6,location:"clinic_house",x:-120,y:-80,activity:"home"},{hour:8,location:"clinic",x:-80,y:-40,activity:"work"},{hour:17,location:"beach",x:0,y:200,activity:"walk"},{hour:20,location:"clinic_house",x:-120,y:-80,activity:"reading"},{hour:22,location:"clinic_house",x:-120,y:-80,activity:"sleep"}],fall:[{hour:6,location:"clinic_house",x:-120,y:-80,activity:"home"},{hour:8,location:"clinic",x:-80,y:-40,activity:"work"},{hour:18,location:"forest_path",x:-280,y:0,activity:"walk"},{hour:20,location:"clinic_house",x:-120,y:-80,activity:"reading"},{hour:22,location:"clinic_house",x:-120,y:-80,activity:"sleep"}],winter:[{hour:7,location:"clinic_house",x:-120,y:-80,activity:"home"},{hour:8,location:"clinic",x:-80,y:-40,activity:"work"},{hour:18,location:"clinic_house",x:-120,y:-80,activity:"reading"},{hour:22,location:"clinic_house",x:-120,y:-80,activity:"sleep"}],rainy:[{hour:6,location:"clinic_house",x:-120,y:-80,activity:"home"},{hour:8,location:"clinic",x:-80,y:-40,activity:"work"},{hour:18,location:"clinic_house",x:-120,y:-80,activity:"reading"},{hour:22,location:"clinic_house",x:-120,y:-80,activity:"sleep"}]},gifts:{loved:["life_elixir","rainbow_shell","fairy_rose"],liked:["medicine","flowers","coffee"],disliked:["alcohol","junk_food","beer"],hated:["void_egg","rotten_food"]},dialogue:{greeting:"How are you feeling today? Any aches or pains?",friendship:{0:["How are you feeling today? Any aches or pains?","Remember to take care of yourself out there."],2:["An apple a day... well, you know the rest.","I've been seeing more patients lately. Fatigue, malaise... nothing I can explain medically.","Your grandmother was in perfect health until the end. It was like she just... let go."],4:["Something is affecting the town's wellbeing. It's not physical - it's something else.","Fewer patients this week! Whatever you're doing, it's helping.","The town's collective health is improving. Most intriguing."],6:["Remarkable! Everyone is reporting feeling better. The change is measurable.","You've cured something I couldn't even diagnose. Extraordinary."],8:["The curse was real, and you cured it. I owe you an apology for my skepticism.","As a woman of science, I struggle to explain what happened. But I believe."],10:["You've opened my eyes to a world beyond what I thought possible. Thank you... for everything."]},birthday:"My birthday already? I suppose even doctors need a day off. Thank you for remembering.",festival:{egg_hunt:"Don't forget to stretch before the egg hunt! Pulled muscles are no joke.",luau:"Stay hydrated in this heat! I mean it!",harvest:"The harvest is wonderful for nutrition. Eat those fresh vegetables!",winter_star:"Cold and flu season. Please wash your hands, everyone."}},questIds:[],homeCity:"willowbrook"},{id:"pet_seller",name:"Penny",title:"Pet Shop Owner",description:"Warm and animal-loving, Penny runs the pet shop. Every creature in her care is treated like family, and she can match any farmer with the perfect companion.",texture:"npc_pet_seller",birthday:{season:"spring",day:7},schedule:{spring:[{hour:6,location:"pet_shop_house",x:-200,y:-80,activity:"home"},{hour:9,location:"pet_shop",x:-160,y:-40,activity:"work"},{hour:18,location:"forest_path",x:-280,y:0,activity:"walk_pets"},{hour:20,location:"tavern",x:0,y:80,activity:"socialize"},{hour:22,location:"pet_shop_house",x:-200,y:-80,activity:"sleep"}],summer:[{hour:6,location:"pet_shop_house",x:-200,y:-80,activity:"home"},{hour:9,location:"pet_shop",x:-160,y:-40,activity:"work"},{hour:17,location:"beach",x:0,y:200,activity:"walk_pets"},{hour:20,location:"pet_shop_house",x:-200,y:-80,activity:"home"},{hour:22,location:"pet_shop_house",x:-200,y:-80,activity:"sleep"}],fall:[{hour:6,location:"pet_shop_house",x:-200,y:-80,activity:"home"},{hour:9,location:"pet_shop",x:-160,y:-40,activity:"work"},{hour:18,location:"forest_path",x:-280,y:0,activity:"walk_pets"},{hour:20,location:"tavern",x:0,y:80,activity:"socialize"},{hour:22,location:"pet_shop_house",x:-200,y:-80,activity:"sleep"}],winter:[{hour:7,location:"pet_shop_house",x:-200,y:-80,activity:"home"},{hour:9,location:"pet_shop",x:-160,y:-40,activity:"work"},{hour:17,location:"pet_shop_house",x:-200,y:-80,activity:"home"},{hour:22,location:"pet_shop_house",x:-200,y:-80,activity:"sleep"}],rainy:[{hour:6,location:"pet_shop_house",x:-200,y:-80,activity:"home"},{hour:9,location:"pet_shop",x:-160,y:-40,activity:"work"},{hour:18,location:"pet_shop_house",x:-200,y:-80,activity:"home"},{hour:22,location:"pet_shop_house",x:-200,y:-80,activity:"sleep"}]},gifts:{loved:["rabbit_foot","duck_feather","golden_pumpkin"],liked:["hay","flowers","milk","animal_treats"],disliked:["monster_parts","weapons","bomb"],hated:["void_egg","slime"]},dialogue:{greeting:"Welcome to Penny's Pet Paradise!",friendship:{0:["Welcome to Penny's Pet Paradise!","All my little friends are looking for homes!"],2:["Looking for a companion? I have just the pet for you!","The animals have been restless lately. They sense something is wrong."],4:["My critters are calmer now. Whatever changed, they can feel it too.","You have a gentle aura. The animals trust you."],6:["The barn cats are purring again! First time in months!","Thank you for making the world a better place for my little friends."],8:["The animals are celebrating too! I can hear them singing!"],10:["You're the kindest soul in Willowbrook. The animals and I are lucky to know you."]},birthday:"It's my birthday! The puppies made me a card. Well, they chewed on a card. Close enough!",festival:{egg_hunt:"The chicks are extra fluffy this spring! Come see!",luau:"The pets love summer! Especially the ducks.",harvest:"Harvest means plenty of treats for everyone - pets included!",winter_star:"I'm knitting tiny sweaters for all the puppies!"}},shop:{items:["cat","dog","chicken","cow","goat","duck","rabbit","sheep","hay","animal_treats","pet_bed","pet_toy"],priceMultiplier:1},questIds:[],homeCity:"willowbrook"},{id:"fisherman",name:"Old Silas",title:"Master Angler",description:"A weathered old fisherman who has spent his entire life on the waters near Willowbrook. He knows every fish, every current, and every secret the river holds.",texture:"npc_fisherman",birthday:{season:"summer",day:14},schedule:{spring:[{hour:4,location:"fisherman_hut",x:40,y:180,activity:"home"},{hour:5,location:"beach",x:0,y:200,activity:"fishing"},{hour:12,location:"fisherman_hut",x:40,y:180,activity:"lunch"},{hour:13,location:"river_bend",x:-60,y:160,activity:"fishing"},{hour:18,location:"tavern",x:0,y:80,activity:"drinking"},{hour:21,location:"fisherman_hut",x:40,y:180,activity:"sleep"}],summer:[{hour:4,location:"fisherman_hut",x:40,y:180,activity:"home"},{hour:5,location:"beach",x:0,y:200,activity:"fishing"},{hour:11,location:"fisherman_hut",x:40,y:180,activity:"lunch"},{hour:13,location:"beach",x:0,y:200,activity:"fishing"},{hour:19,location:"tavern",x:0,y:80,activity:"drinking"},{hour:22,location:"fisherman_hut",x:40,y:180,activity:"sleep"}],fall:[{hour:5,location:"fisherman_hut",x:40,y:180,activity:"home"},{hour:6,location:"river_bend",x:-60,y:160,activity:"fishing"},{hour:12,location:"fisherman_hut",x:40,y:180,activity:"lunch"},{hour:13,location:"beach",x:0,y:200,activity:"fishing"},{hour:17,location:"tavern",x:0,y:80,activity:"drinking"},{hour:21,location:"fisherman_hut",x:40,y:180,activity:"sleep"}],winter:[{hour:7,location:"fisherman_hut",x:40,y:180,activity:"home"},{hour:9,location:"river_bend",x:-60,y:160,activity:"ice_fishing"},{hour:14,location:"tavern",x:0,y:80,activity:"drinking"},{hour:18,location:"fisherman_hut",x:40,y:180,activity:"mending_nets"},{hour:21,location:"fisherman_hut",x:40,y:180,activity:"sleep"}],rainy:[{hour:4,location:"fisherman_hut",x:40,y:180,activity:"home"},{hour:5,location:"beach",x:0,y:200,activity:"fishing"},{hour:18,location:"tavern",x:0,y:80,activity:"drinking"},{hour:21,location:"fisherman_hut",x:40,y:180,activity:"sleep"}]},gifts:{loved:["legend_fish","iridium_fishing_rod","ocean_stone"],liked:["fish","bait","crab_pot","cider","beer"],disliked:["gems","flowers","sweets"],hated:["joja_cola","trash"]},dialogue:{greeting:"The fish are bitin' today. You here to learn, or just watchin'?",friendship:{0:["The fish are bitin' today. You here to learn, or just watchin'?","Cast your line with patience. The river rewards those who wait."],2:["Your grandma used to fish here, y'know. Had a gift for it.","The fish have been scarce. Water feels... wrong. Tainted, maybe.","Been fishin' these waters sixty years. Never seen 'em this troubled."],4:["Fish are comin' back! Water's clearer than it's been in years.","You got your grandma's touch with nature. She'd be right proud."],6:["The legendary fish are stirrin'! Haven't seen that in decades!","Whatever you done, the river thanks you. And so do I."],8:["The waters sing again! The curse is truly broken!","I caught three legend fish this week. That hasn't happened since I was a boy."],10:["You're the finest soul this river has ever known. Fish with me anytime, partner."]},birthday:"Another year, another thousand fish. Pour me an ale and let's swap stories.",festival:{egg_hunt:"Spring run is startin'! Best fishin' of the year!",luau:"Summer's when the big ones come close to shore.",harvest:"Fall salmon run. Nothin' like it.",winter_star:"Ice fishin' builds character. Bundle up and drop a line."}},shop:{items:["fishing_rod_basic","fishing_rod_fiberglass","fishing_rod_iridium","bait","wild_bait","magnet_bait","crab_pot","tackle_spinner","tackle_trap"],priceMultiplier:1},questIds:["legendary_catch","river_mystery"],homeCity:"willowbrook"},{id:"librarian",name:"Rosalind",title:"Town Librarian",description:"Quiet and scholarly, Rosalind manages the Willowbrook library and museum. She is an expert on local history and the ancient legends surrounding the town.",texture:"npc_librarian",birthday:{season:"fall",day:3},schedule:{spring:[{hour:7,location:"library_house",x:-100,y:-160,activity:"home"},{hour:9,location:"library",x:-60,y:-120,activity:"work"},{hour:12,location:"town_square",x:0,y:0,activity:"reading_outside"},{hour:13,location:"library",x:-60,y:-120,activity:"work"},{hour:18,location:"forest_path",x:-280,y:0,activity:"walk"},{hour:20,location:"library_house",x:-100,y:-160,activity:"reading"},{hour:23,location:"library_house",x:-100,y:-160,activity:"sleep"}],summer:[{hour:7,location:"library_house",x:-100,y:-160,activity:"home"},{hour:9,location:"library",x:-60,y:-120,activity:"work"},{hour:12,location:"beach",x:0,y:200,activity:"reading_outside"},{hour:14,location:"library",x:-60,y:-120,activity:"work"},{hour:18,location:"library_house",x:-100,y:-160,activity:"reading"},{hour:23,location:"library_house",x:-100,y:-160,activity:"sleep"}],fall:[{hour:7,location:"library_house",x:-100,y:-160,activity:"home"},{hour:9,location:"library",x:-60,y:-120,activity:"work"},{hour:18,location:"tavern",x:0,y:80,activity:"socialize"},{hour:20,location:"library_house",x:-100,y:-160,activity:"reading"},{hour:23,location:"library_house",x:-100,y:-160,activity:"sleep"}],winter:[{hour:8,location:"library_house",x:-100,y:-160,activity:"home"},{hour:10,location:"library",x:-60,y:-120,activity:"work"},{hour:17,location:"library_house",x:-100,y:-160,activity:"reading"},{hour:23,location:"library_house",x:-100,y:-160,activity:"sleep"}],rainy:[{hour:7,location:"library_house",x:-100,y:-160,activity:"home"},{hour:9,location:"library",x:-60,y:-120,activity:"work"},{hour:20,location:"library_house",x:-100,y:-160,activity:"reading"},{hour:23,location:"library_house",x:-100,y:-160,activity:"sleep"}]},gifts:{loved:["ancient_scroll","rare_book","prismatic_shard"],liked:["coffee","pumpkin_soup","honey","ancient_fruit"],disliked:["weapons","monster_parts","beer"],hated:["slime","trash","bug_meat"]},dialogue:{greeting:"Shh... oh, it's you. Welcome to the library.",friendship:{0:["Shh... oh, it's you. Welcome to the library.","Please be careful with the books. Some are irreplaceable."],2:["Have you read 'The Founding of Willowbrook'? Fascinating history.","The oldest texts mention three ancient seals. I've been researching them.","Your grandmother donated several rare volumes to our collection."],4:["I found references to the curse in a 300-year-old journal. It's real.","The seals are mentioned in the Codex Luminara. An ancient protective magic.","You're making the legends come true. It's extraordinary to witness."],6:["I've documented everything. Future generations must know this story.","The ancient texts predicted someone like you. The 'Heir of Light.'"],8:["The curse is broken! I can write the final chapter of the chronicle!","History will remember you. I'll make sure of it."],10:["You've given me the greatest story I'll ever have the privilege to tell."]},birthday:"My birthday? I was hoping for a quiet day with a good book. But your company is even better.",festival:{egg_hunt:"Spring is when the earliest settlers first arrived in Willowbrook, you know.",luau:"I'm reading about ancient summer solstice rituals. Fascinating stuff.",harvest:"The harvest festival dates back to Willowbrook's founding. Three hundred years of tradition!",winter_star:"The Winter Star legend predates Willowbrook itself. Such rich lore."}},questIds:["lost_library_books","ancient_codex"],homeCity:"willowbrook"},{id:"carpenter",name:"Hank",title:"Master Carpenter",description:"Sturdy and reliable, Hank builds and repairs everything in Willowbrook. From barns to bridges, if it is made of wood, Hank built it.",texture:"npc_carpenter",birthday:{season:"spring",day:18},schedule:{spring:[{hour:6,location:"carpenter_house",x:100,y:-120,activity:"home"},{hour:7,location:"carpenter_shop",x:140,y:-100,activity:"work"},{hour:12,location:"town_square",x:0,y:0,activity:"lunch"},{hour:13,location:"carpenter_shop",x:140,y:-100,activity:"work"},{hour:18,location:"tavern",x:0,y:80,activity:"socialize"},{hour:21,location:"carpenter_house",x:100,y:-120,activity:"sleep"}],summer:[{hour:6,location:"carpenter_house",x:100,y:-120,activity:"home"},{hour:7,location:"carpenter_shop",x:140,y:-100,activity:"work"},{hour:12,location:"town_square",x:0,y:0,activity:"lunch"},{hour:13,location:"forest_path",x:-280,y:0,activity:"lumber"},{hour:16,location:"carpenter_shop",x:140,y:-100,activity:"work"},{hour:19,location:"tavern",x:0,y:80,activity:"socialize"},{hour:22,location:"carpenter_house",x:100,y:-120,activity:"sleep"}],fall:[{hour:6,location:"carpenter_house",x:100,y:-120,activity:"home"},{hour:7,location:"carpenter_shop",x:140,y:-100,activity:"work"},{hour:12,location:"town_square",x:0,y:0,activity:"lunch"},{hour:13,location:"carpenter_shop",x:140,y:-100,activity:"work"},{hour:18,location:"tavern",x:0,y:80,activity:"socialize"},{hour:21,location:"carpenter_house",x:100,y:-120,activity:"sleep"}],winter:[{hour:7,location:"carpenter_house",x:100,y:-120,activity:"home"},{hour:8,location:"carpenter_shop",x:140,y:-100,activity:"work"},{hour:12,location:"tavern",x:0,y:80,activity:"lunch"},{hour:13,location:"carpenter_shop",x:140,y:-100,activity:"work"},{hour:17,location:"tavern",x:0,y:80,activity:"socialize"},{hour:20,location:"carpenter_house",x:100,y:-120,activity:"sleep"}],rainy:[{hour:6,location:"carpenter_house",x:100,y:-120,activity:"home"},{hour:8,location:"carpenter_shop",x:140,y:-100,activity:"work"},{hour:18,location:"carpenter_house",x:100,y:-120,activity:"home"},{hour:21,location:"carpenter_house",x:100,y:-120,activity:"sleep"}]},gifts:{loved:["hardwood","oak_resin","maple_syrup"],liked:["wood","stone","beer","cooked_food"],disliked:["flowers","gems","sweets"],hated:["trash","slime"]},dialogue:{greeting:"Need somethin' built? I'm your man. Measure twice, cut once!",friendship:{0:["Need somethin' built? I'm your man. Measure twice, cut once!","Good timber makes good buildings. And good buildings make a good town."],2:["Built your grandmother's barn, I did. Finest work I ever done.","The wood's been warping strangely. Like it's... resisting the saw.","Used to be I could build a shed in a day. Lately everything takes longer."],4:["The wood is cooperating again! Cuts clean, joints true.","Your grandmother asked me to reinforce the community center once. Said it needed to last 'forever.'"],6:["I can feel the difference in every plank. The curse was in the very trees.","Building's a joy again. Thank you for that."],8:["The town looks better than it has in decades! And it's all thanks to you!","Let me build you something special. On the house. You've earned it."],10:["You're the backbone of this town, just like your grandmother was. I'm honored to know you."]},birthday:"My birthday! The missus baked a cake. Want a slice? Careful, it's as sturdy as my furniture.",festival:{egg_hunt:"Spring's the best time for building. Fresh lumber, dry days.",luau:"Summer heat warps wood if you're not careful. Stay in the shade!",harvest:"Fall's when I stock up on hardwood for winter projects.",winter_star:"Indoor projects all winter. Come see my latest creations!"}},shop:{items:["barn_blueprint","coop_blueprint","silo_blueprint","shed_blueprint","stable_blueprint","well_blueprint","fence_wood","fence_stone","fence_iron","wood","hardwood","stone"],priceMultiplier:1},questIds:["barn_raising","bridge_repair"],homeCity:"willowbrook"},{id:"miner",name:"Dustin",title:"Mine Foreman",description:"Tough and practical, Dustin leads the mining operations near Willowbrook. He has delved deeper than anyone and knows the mountain's secrets.",texture:"npc_miner",birthday:{season:"winter",day:22},schedule:{spring:[{hour:5,location:"miner_cabin",x:200,y:60,activity:"home"},{hour:6,location:"dungeon_entrance",x:240,y:80,activity:"mining"},{hour:14,location:"tavern",x:0,y:80,activity:"lunch"},{hour:15,location:"dungeon_entrance",x:240,y:80,activity:"mining"},{hour:19,location:"tavern",x:0,y:80,activity:"drinking"},{hour:22,location:"miner_cabin",x:200,y:60,activity:"sleep"}],summer:[{hour:5,location:"miner_cabin",x:200,y:60,activity:"home"},{hour:6,location:"dungeon_entrance",x:240,y:80,activity:"mining"},{hour:14,location:"tavern",x:0,y:80,activity:"lunch"},{hour:15,location:"dungeon_entrance",x:240,y:80,activity:"mining"},{hour:19,location:"tavern",x:0,y:80,activity:"drinking"},{hour:22,location:"miner_cabin",x:200,y:60,activity:"sleep"}],fall:[{hour:5,location:"miner_cabin",x:200,y:60,activity:"home"},{hour:6,location:"dungeon_entrance",x:240,y:80,activity:"mining"},{hour:14,location:"tavern",x:0,y:80,activity:"lunch"},{hour:15,location:"dungeon_entrance",x:240,y:80,activity:"mining"},{hour:18,location:"blacksmith",x:120,y:40,activity:"trading"},{hour:19,location:"tavern",x:0,y:80,activity:"drinking"},{hour:22,location:"miner_cabin",x:200,y:60,activity:"sleep"}],winter:[{hour:6,location:"miner_cabin",x:200,y:60,activity:"home"},{hour:7,location:"dungeon_entrance",x:240,y:80,activity:"mining"},{hour:13,location:"tavern",x:0,y:80,activity:"lunch"},{hour:14,location:"dungeon_entrance",x:240,y:80,activity:"mining"},{hour:17,location:"tavern",x:0,y:80,activity:"drinking"},{hour:21,location:"miner_cabin",x:200,y:60,activity:"sleep"}],rainy:[{hour:5,location:"miner_cabin",x:200,y:60,activity:"home"},{hour:6,location:"dungeon_entrance",x:240,y:80,activity:"mining"},{hour:19,location:"tavern",x:0,y:80,activity:"drinking"},{hour:22,location:"miner_cabin",x:200,y:60,activity:"sleep"}]},gifts:{loved:["diamond","prismatic_shard","gold_ore"],liked:["ores","gems","beer","meat_stew","baked_potato"],disliked:["flowers","fish","sweets"],hated:["fairy_rose","poppy"]},dialogue:{greeting:"Watch your step around the mines. It ain't a playground down there.",friendship:{0:["Watch your step around the mines. It ain't a playground down there.","Ore don't mine itself. You here to work or chat?"],2:["Deeper levels got somethin' strange. Glowing rocks, whispering walls.","The mountain groans at night. Like it's in pain.","Your grandma went into the mines once. Came back with the strangest look on her face."],4:["Found a vein of ore that practically jumps out of the rock now. Never seen the like.","The whispers stopped. Mountain's at peace for the first time in years."],6:["New caverns are opening up! The mountain's revealing its treasures!","Whatever you did down there... the mountain remembers. And it's grateful."],8:["Best mining season in my whole career! The curse was choking the veins!","You freed the mountain itself. I'll never forget that."],10:["You're welcome in the deepest shafts anytime. You've earned the mountain's trust."]},birthday:"My birthday? Found a diamond yesterday. That's gift enough. ...But I won't say no to a drink.",festival:{egg_hunt:"Spring thaw opens up new tunnels. Good season for exploring.",luau:"The heat makes deep mining almost pleasant. Cool down there.",harvest:"Fall's when the rare ores surface. Keep your eyes peeled.",winter_star:"Frozen ground makes for tricky mining. But the gems shine brighter."}},questIds:["deep_mine_expedition","rare_gem_hunt"],homeCity:"willowbrook"},{id:"musician",name:"Melody",title:"Traveling Bard",description:"A free-spirited musician who settled in Willowbrook after falling in love with the town. She plays at the tavern and writes songs about the people she meets.",texture:"npc_musician",birthday:{season:"summer",day:25},schedule:{spring:[{hour:9,location:"musician_cottage",x:-40,y:-160,activity:"home"},{hour:11,location:"town_square",x:0,y:0,activity:"busking"},{hour:14,location:"forest_path",x:-280,y:0,activity:"composing"},{hour:17,location:"tavern",x:0,y:80,activity:"performing"},{hour:23,location:"musician_cottage",x:-40,y:-160,activity:"sleep"}],summer:[{hour:9,location:"musician_cottage",x:-40,y:-160,activity:"home"},{hour:11,location:"beach",x:0,y:200,activity:"busking"},{hour:14,location:"town_square",x:0,y:0,activity:"composing"},{hour:17,location:"tavern",x:0,y:80,activity:"performing"},{hour:23,location:"musician_cottage",x:-40,y:-160,activity:"sleep"}],fall:[{hour:9,location:"musician_cottage",x:-40,y:-160,activity:"home"},{hour:11,location:"town_square",x:0,y:0,activity:"busking"},{hour:14,location:"forest_path",x:-280,y:0,activity:"composing"},{hour:17,location:"tavern",x:0,y:80,activity:"performing"},{hour:23,location:"musician_cottage",x:-40,y:-160,activity:"sleep"}],winter:[{hour:10,location:"musician_cottage",x:-40,y:-160,activity:"home"},{hour:12,location:"tavern",x:0,y:80,activity:"performing"},{hour:15,location:"library",x:-60,y:-120,activity:"reading"},{hour:17,location:"tavern",x:0,y:80,activity:"performing"},{hour:23,location:"musician_cottage",x:-40,y:-160,activity:"sleep"}],rainy:[{hour:9,location:"musician_cottage",x:-40,y:-160,activity:"composing"},{hour:14,location:"tavern",x:0,y:80,activity:"performing"},{hour:23,location:"musician_cottage",x:-40,y:-160,activity:"sleep"}]},gifts:{loved:["flute_block","drum_block","prismatic_shard"],liked:["flowers","coffee","wine","honey"],disliked:["ores","monster_parts","coal"],hated:["slime","trash","void_egg"]},dialogue:{greeting:"La la la~ Oh! Hello there! Didn't see you sneaking up!",friendship:{0:["La la la~ Oh! Hello there! Didn't see you sneaking up!","I'm writing a song about Willowbrook. Still working on the chorus."],2:["Every person in this town has a melody. I'm trying to learn them all.","My songs used to ring clear, but lately the notes feel... muffled. Like something's dampening the music.","Your grandmother loved my lullabies. She said they kept the shadows at bay."],4:["Listen! Can you hear it? The music is coming back to Willowbrook!","I'm writing a ballad about a farmer who saves a cursed town. Totally fictional, of course.","The birds are singing harmonies again! They stopped months ago."],6:["The Ballad of the Sealed Light! It's my masterpiece, and it's about YOU!","Music has power, you know. Real power. You've proven that."],8:["The whole world is singing! Can you feel it? The curse is GONE!","I wrote you a song. It's... personal. I hope you like it."],10:["You're my muse. Every note I play, I play for you."]},birthday:"My birthday! Time for a concert! I'm dedicating tonight's performance to... well, you'll see!",festival:{egg_hunt:"Spring inspires the happiest melodies!",luau:"Summer nights are made for music under the stars.",harvest:"Fall harmonies are my favorite. Rich and warm, like the season.",winter_star:"Winter carols by the fire. There's nothing better."}},questIds:["lost_sheet_music","melody_concert"],homeCity:"willowbrook"},{id:"rancher",name:"Clara",title:"Ranch Owner",description:"No-nonsense and hardworking, Clara runs the largest ranch near Willowbrook. She raises cattle, horses, and produces the finest dairy products in the region.",texture:"npc_rancher",birthday:{season:"fall",day:14},schedule:{spring:[{hour:5,location:"ranch_house",x:-240,y:80,activity:"home"},{hour:6,location:"ranch_pasture",x:-280,y:120,activity:"tending_animals"},{hour:10,location:"ranch_barn",x:-260,y:100,activity:"milking"},{hour:12,location:"ranch_house",x:-240,y:80,activity:"lunch"},{hour:13,location:"ranch_pasture",x:-280,y:120,activity:"tending_animals"},{hour:17,location:"general_store",x:-120,y:40,activity:"selling"},{hour:19,location:"ranch_house",x:-240,y:80,activity:"home"},{hour:21,location:"ranch_house",x:-240,y:80,activity:"sleep"}],summer:[{hour:5,location:"ranch_house",x:-240,y:80,activity:"home"},{hour:6,location:"ranch_pasture",x:-280,y:120,activity:"tending_animals"},{hour:10,location:"ranch_barn",x:-260,y:100,activity:"milking"},{hour:12,location:"ranch_house",x:-240,y:80,activity:"lunch"},{hour:13,location:"ranch_pasture",x:-280,y:120,activity:"tending_animals"},{hour:16,location:"beach",x:0,y:200,activity:"cooling_off"},{hour:18,location:"tavern",x:0,y:80,activity:"socialize"},{hour:21,location:"ranch_house",x:-240,y:80,activity:"sleep"}],fall:[{hour:5,location:"ranch_house",x:-240,y:80,activity:"home"},{hour:6,location:"ranch_pasture",x:-280,y:120,activity:"tending_animals"},{hour:10,location:"ranch_barn",x:-260,y:100,activity:"milking"},{hour:12,location:"ranch_house",x:-240,y:80,activity:"lunch"},{hour:13,location:"ranch_pasture",x:-280,y:120,activity:"tending_animals"},{hour:17,location:"general_store",x:-120,y:40,activity:"selling"},{hour:19,location:"tavern",x:0,y:80,activity:"socialize"},{hour:21,location:"ranch_house",x:-240,y:80,activity:"sleep"}],winter:[{hour:6,location:"ranch_house",x:-240,y:80,activity:"home"},{hour:7,location:"ranch_barn",x:-260,y:100,activity:"tending_animals"},{hour:12,location:"ranch_house",x:-240,y:80,activity:"lunch"},{hour:13,location:"ranch_barn",x:-260,y:100,activity:"tending_animals"},{hour:16,location:"general_store",x:-120,y:40,activity:"selling"},{hour:18,location:"ranch_house",x:-240,y:80,activity:"home"},{hour:21,location:"ranch_house",x:-240,y:80,activity:"sleep"}],rainy:[{hour:5,location:"ranch_house",x:-240,y:80,activity:"home"},{hour:6,location:"ranch_barn",x:-260,y:100,activity:"tending_animals"},{hour:12,location:"ranch_house",x:-240,y:80,activity:"lunch"},{hour:13,location:"ranch_barn",x:-260,y:100,activity:"tending_animals"},{hour:18,location:"ranch_house",x:-240,y:80,activity:"home"},{hour:21,location:"ranch_house",x:-240,y:80,activity:"sleep"}]},gifts:{loved:["large_milk","truffle","golden_pumpkin"],liked:["milk","cheese","wool","hay","animal_treats"],disliked:["fish","gems","void_essence"],hated:["void_egg","slime","bug_meat"]},dialogue:{greeting:"Mornin'. Cows don't milk themselves, so make it quick.",friendship:{0:["Mornin'. Cows don't milk themselves, so make it quick.","A ranch runs on hard work and early mornings. You look like you understand that."],2:["Your grandmother kept the finest chickens in the county. Bet you didn't know that.","Animals have been spooked lately. Won't go near the east pasture.","Milk production's down. The cattle sense something wrong with the land."],4:["The animals are calming down. Whatever was scaring them seems to be fading.","My best cow just had twins! First time in years. Good omen."],6:["Milk's richer, eggs are bigger, wool's softer. The land is healing!","You've got a rancher's heart. The animals trust you."],8:["Best yields in a generation! The curse was starving the whole land!","The horses are galloping free again. They know the danger has passed."],10:["You saved my ranch, my animals, and my livelihood. You're always welcome here."]},birthday:"My birthday? The cows don't care about birthdays. ...But a nice cheese wheel would be appreciated.",festival:{egg_hunt:"Spring calving season. Busiest time of year!",luau:"Gotta keep the animals hydrated in this heat.",harvest:"Fall means stocking up feed for winter. No time to waste.",winter_star:"Winter's hard on the animals. Extra hay, extra care."}},shop:{items:["milk","large_milk","cheese","goat_cheese","wool","egg","duck_egg","hay","animal_treats"],priceMultiplier:1},questIds:["lost_calf","ranch_expansion"],homeCity:"willowbrook"}],Ue=new Map(At.map(r=>[r.id,r])),$n={loved:80,liked:45,neutral:20,disliked:-20,hated:-40},jn=8,Va=250,Ya=10,Vn=Ya*Va;class Yn{friendship=new Map;giftedToday=new Set;birthdayMultiplierActive=new Map;heartUpCallbacks=[];constructor(){for(const e of At)this.friendship.set(e.id,0),this.birthdayMultiplierActive.set(e.id,!1)}giveGift(e,t){const i=Ue.get(e);if(!i||this.giftedToday.has(e))return null;const s=this.getReaction(i,t);let a=$n[s];return this.birthdayMultiplierActive.get(e)&&(a*=jn),this.addFriendship(e,a),this.giftedToday.add(e),{points:a,reaction:s}}getHearts(e){const t=this.friendship.get(e)??0;return Math.min(Ya,Math.floor(t/Va))}getFriendshipPoints(e){return this.friendship.get(e)??0}addFriendship(e,t){if(!Ue.has(e))return;const i=this.getHearts(e),s=this.friendship.get(e)??0,a=Math.max(0,Math.min(Vn,s+t));this.friendship.set(e,a);const o=this.getHearts(e);for(let n=i+1;n<=o;n++)for(const l of this.heartUpCallbacks)l(e,n)}getUnlockedDialogue(e){const t=Ue.get(e);if(!t)return[];const i=this.getHearts(e),s=[],a=Object.keys(t.dialogue.friendship).map(Number).sort((o,n)=>o-n);for(const o of a)if(o<=i){const n=t.dialogue.friendship[o];n&&s.push(...n)}return s}hasGiftedToday(e){return this.giftedToday.has(e)}resetDailyGifts(){this.giftedToday.clear()}setBirthdayActive(e,t){this.birthdayMultiplierActive.set(e,t)}isBirthdayActive(e){return this.birthdayMultiplierActive.get(e)??!1}onHeartUp(e){this.heartUpCallbacks.push(e)}serialize(){const e={};for(const[i,s]of this.friendship)e[i]=s;const t={};for(const[i,s]of this.birthdayMultiplierActive)t[i]=s;return{friendship:e,giftedToday:Array.from(this.giftedToday),birthdayActive:t}}deserialize(e){if(e.friendship)for(const[t,i]of Object.entries(e.friendship))this.friendship.set(t,i);if(e.giftedToday&&(this.giftedToday=new Set(e.giftedToday)),e.birthdayActive)for(const[t,i]of Object.entries(e.birthdayActive))this.birthdayMultiplierActive.set(t,i)}getReaction(e,t){return e.gifts.loved.includes(t)?"loved":e.gifts.liked.includes(t)?"liked":e.gifts.hated.includes(t)?"hated":e.gifts.disliked.includes(t)?"disliked":"neutral"}}const Xn=[{id:"torch",name:"Torch",category:"crafting",station:"none",ingredients:[{itemId:"wood",quantity:1},{itemId:"coal",quantity:1}],output:{itemId:"torch",quantity:4},craftTime:3,xpReward:5,discoverable:!1},{id:"campfire",name:"Campfire",category:"crafting",station:"none",ingredients:[{itemId:"wood",quantity:10},{itemId:"stone",quantity:5}],output:{itemId:"campfire",quantity:1},craftTime:4,xpReward:8,discoverable:!1},{id:"chest",name:"Chest",category:"crafting",station:"none",ingredients:[{itemId:"wood",quantity:50}],output:{itemId:"chest",quantity:1},craftTime:5,xpReward:10,discoverable:!1},{id:"scarecrow",name:"Scarecrow",category:"crafting",station:"none",ingredients:[{itemId:"wood",quantity:50},{itemId:"fiber",quantity:20},{itemId:"coal",quantity:1}],output:{itemId:"scarecrow",quantity:1},craftTime:5,xpReward:15,discoverable:!1},{id:"sprinkler",name:"Basic Sprinkler",category:"crafting",station:"none",ingredients:[{itemId:"copper_bar",quantity:1},{itemId:"iron_bar",quantity:1}],output:{itemId:"sprinkler",quantity:1},craftTime:5,skillRequired:"farming",levelRequired:2,xpReward:25,discoverable:!0},{id:"quality_sprinkler",name:"Quality Sprinkler",category:"crafting",station:"none",ingredients:[{itemId:"iron_bar",quantity:2},{itemId:"gold_bar",quantity:1}],output:{itemId:"quality_sprinkler",quantity:1},craftTime:5,skillRequired:"farming",levelRequired:6,xpReward:50,discoverable:!0},{id:"iridium_sprinkler",name:"Iridium Sprinkler",category:"crafting",station:"none",ingredients:[{itemId:"gold_bar",quantity:3},{itemId:"prismatic_shard",quantity:1}],output:{itemId:"iridium_sprinkler",quantity:1},craftTime:10,skillRequired:"farming",levelRequired:9,xpReward:100,discoverable:!0},{id:"fertilizer",name:"Basic Fertilizer",category:"crafting",station:"none",ingredients:[{itemId:"fiber",quantity:5},{itemId:"sap",quantity:2}],output:{itemId:"fertilizer",quantity:2},craftTime:3,skillRequired:"farming",levelRequired:1,xpReward:5,discoverable:!1},{id:"quality_fertilizer",name:"Quality Fertilizer",category:"crafting",station:"none",ingredients:[{itemId:"fertilizer",quantity:2},{itemId:"fish",quantity:1}],output:{itemId:"quality_fertilizer",quantity:2},craftTime:5,skillRequired:"farming",levelRequired:4,xpReward:15,discoverable:!0},{id:"copper_bar",name:"Copper Bar",category:"smithing",station:"furnace",ingredients:[{itemId:"copper_ore",quantity:5},{itemId:"coal",quantity:1}],output:{itemId:"copper_bar",quantity:1},craftTime:30,xpReward:10,discoverable:!1},{id:"iron_bar",name:"Iron Bar",category:"smithing",station:"furnace",ingredients:[{itemId:"iron_ore",quantity:5},{itemId:"coal",quantity:1}],output:{itemId:"iron_bar",quantity:1},craftTime:45,xpReward:15,discoverable:!1},{id:"gold_bar",name:"Gold Bar",category:"smithing",station:"furnace",ingredients:[{itemId:"gold_ore",quantity:5},{itemId:"coal",quantity:1}],output:{itemId:"gold_bar",quantity:1},craftTime:60,xpReward:20,discoverable:!1},{id:"steel_bar",name:"Steel Bar",category:"smithing",station:"furnace",ingredients:[{itemId:"iron_bar",quantity:2},{itemId:"coal",quantity:3}],output:{itemId:"steel_bar",quantity:1},craftTime:60,skillRequired:"mining",levelRequired:4,xpReward:30,discoverable:!0},{id:"ornate_bar",name:"Ornate Alloy Bar",category:"smithing",station:"furnace",ingredients:[{itemId:"gold_bar",quantity:2},{itemId:"copper_bar",quantity:1},{itemId:"coal",quantity:2}],output:{itemId:"ornate_bar",quantity:1},craftTime:75,skillRequired:"mining",levelRequired:5,xpReward:35,discoverable:!0},{id:"void_ingot",name:"Void Ingot",category:"smithing",station:"furnace",ingredients:[{itemId:"void_heart",quantity:1},{itemId:"iron_bar",quantity:3},{itemId:"coal",quantity:5}],output:{itemId:"void_ingot",quantity:1},craftTime:90,skillRequired:"mining",levelRequired:7,xpReward:60,discoverable:!0},{id:"frost_alloy",name:"Frostforged Alloy",category:"smithing",station:"furnace",ingredients:[{itemId:"frozen_heart",quantity:1},{itemId:"ice_crystal",quantity:5},{itemId:"iron_bar",quantity:2},{itemId:"coal",quantity:3}],output:{itemId:"frost_alloy",quantity:1},craftTime:90,skillRequired:"mining",levelRequired:6,xpReward:55,discoverable:!0},{id:"refined_quartz",name:"Refined Quartz",category:"smithing",station:"furnace",ingredients:[{itemId:"stone",quantity:10},{itemId:"coal",quantity:2}],output:{itemId:"refined_quartz",quantity:1},craftTime:45,skillRequired:"mining",levelRequired:2,xpReward:15,discoverable:!0},{id:"golem_core_shard",name:"Golem Core Fragment",category:"smithing",station:"furnace",ingredients:[{itemId:"golem_heart",quantity:1},{itemId:"gold_bar",quantity:2},{itemId:"coal",quantity:4}],output:{itemId:"golem_core_shard",quantity:3},craftTime:120,skillRequired:"mining",levelRequired:8,xpReward:75,discoverable:!0},{id:"iron_sword",name:"Iron Blade",category:"crafting",station:"none",ingredients:[{itemId:"iron_bar",quantity:5},{itemId:"wood",quantity:10},{itemId:"leather",quantity:2}],output:{itemId:"iron_sword",quantity:1},craftTime:10,skillRequired:"combat",levelRequired:2,xpReward:30,discoverable:!0},{id:"gold_sword",name:"Gilded Longsword",category:"crafting",station:"none",ingredients:[{itemId:"gold_bar",quantity:5},{itemId:"iron_bar",quantity:2},{itemId:"leather",quantity:3}],output:{itemId:"gold_sword",quantity:1},craftTime:10,skillRequired:"combat",levelRequired:5,xpReward:60,discoverable:!0},{id:"bone_club",name:"Bone Club",category:"crafting",station:"none",ingredients:[{itemId:"bone",quantity:10},{itemId:"slime_gel",quantity:3},{itemId:"fiber",quantity:5}],output:{itemId:"bone_club",quantity:1},craftTime:5,skillRequired:"combat",levelRequired:1,xpReward:20,discoverable:!0},{id:"void_dagger",name:"Void Dagger",category:"crafting",station:"none",ingredients:[{itemId:"void_heart",quantity:1},{itemId:"iron_bar",quantity:3},{itemId:"bone",quantity:5},{itemId:"ectoplasm",quantity:3}],output:{itemId:"void_dagger",quantity:1},craftTime:10,skillRequired:"combat",levelRequired:8,xpReward:100,discoverable:!0},{id:"frost_spear",name:"Frost Spear",category:"crafting",station:"none",ingredients:[{itemId:"frost_scale",quantity:2},{itemId:"ice_crystal",quantity:5},{itemId:"iron_bar",quantity:3},{itemId:"wood",quantity:15}],output:{itemId:"frost_spear",quantity:1},craftTime:10,skillRequired:"combat",levelRequired:6,xpReward:80,discoverable:!0},{id:"iron_arrows",name:"Iron Arrows",category:"crafting",station:"none",ingredients:[{itemId:"iron_bar",quantity:1},{itemId:"wood",quantity:5},{itemId:"feather",quantity:3}],output:{itemId:"iron_arrows",quantity:15},craftTime:5,skillRequired:"combat",levelRequired:1,xpReward:10,discoverable:!1},{id:"fire_arrows",name:"Fire Arrows",category:"crafting",station:"none",ingredients:[{itemId:"arrow",quantity:10},{itemId:"coal",quantity:3},{itemId:"sap",quantity:2}],output:{itemId:"fire_arrows",quantity:10},craftTime:5,skillRequired:"combat",levelRequired:3,xpReward:20,discoverable:!0},{id:"leather_armor",name:"Leather Armor",category:"crafting",station:"none",ingredients:[{itemId:"leather",quantity:8},{itemId:"fiber",quantity:10},{itemId:"copper_bar",quantity:2}],output:{itemId:"leather_armor",quantity:1},craftTime:10,skillRequired:"combat",levelRequired:1,xpReward:25,discoverable:!1},{id:"iron_armor",name:"Iron Chainmail",category:"crafting",station:"none",ingredients:[{itemId:"iron_bar",quantity:10},{itemId:"leather",quantity:5},{itemId:"copper_bar",quantity:3}],output:{itemId:"iron_armor",quantity:1},craftTime:10,skillRequired:"combat",levelRequired:4,xpReward:50,discoverable:!0},{id:"bone_shield",name:"Bone Shield",category:"crafting",station:"none",ingredients:[{itemId:"bone",quantity:15},{itemId:"leather",quantity:4},{itemId:"iron_bar",quantity:2}],output:{itemId:"bone_shield",quantity:1},craftTime:10,skillRequired:"combat",levelRequired:3,xpReward:35,discoverable:!0},{id:"wyrm_plate",name:"Wyrmscale Plate",category:"crafting",station:"none",ingredients:[{itemId:"frost_scale",quantity:5},{itemId:"wyrm_fang",quantity:2},{itemId:"gold_bar",quantity:5},{itemId:"leather",quantity:6}],output:{itemId:"wyrm_plate",quantity:1},craftTime:10,skillRequired:"combat",levelRequired:9,xpReward:120,discoverable:!0},{id:"lantern",name:"Iron Lantern",category:"crafting",station:"none",ingredients:[{itemId:"iron_bar",quantity:2},{itemId:"coal",quantity:3},{itemId:"fiber",quantity:2}],output:{itemId:"lantern",quantity:1},craftTime:5,xpReward:15,discoverable:!1},{id:"glow_lantern",name:"Spectral Lantern",category:"crafting",station:"none",ingredients:[{itemId:"ectoplasm",quantity:5},{itemId:"gold_bar",quantity:1},{itemId:"spirit_shard",quantity:2}],output:{itemId:"glow_lantern",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:5,xpReward:40,discoverable:!0},{id:"spike_trap",name:"Spike Trap",category:"crafting",station:"none",ingredients:[{itemId:"iron_bar",quantity:3},{itemId:"wood",quantity:10},{itemId:"stone",quantity:5}],output:{itemId:"spike_trap",quantity:2},craftTime:5,skillRequired:"combat",levelRequired:2,xpReward:20,discoverable:!0},{id:"snare_trap",name:"Snare Trap",category:"crafting",station:"none",ingredients:[{itemId:"fiber",quantity:15},{itemId:"wood",quantity:5},{itemId:"copper_bar",quantity:1}],output:{itemId:"snare_trap",quantity:3},craftTime:3,xpReward:10,discoverable:!1},{id:"bomb",name:"Bomb",category:"crafting",station:"none",ingredients:[{itemId:"coal",quantity:4},{itemId:"copper_ore",quantity:4}],output:{itemId:"bomb",quantity:1},craftTime:5,xpReward:15,discoverable:!1},{id:"mega_bomb",name:"Volatile Charge",category:"crafting",station:"none",ingredients:[{itemId:"iron_ore",quantity:8},{itemId:"coal",quantity:6},{itemId:"slime_gel",quantity:3}],output:{itemId:"mega_bomb",quantity:1},craftTime:5,skillRequired:"mining",levelRequired:4,xpReward:30,discoverable:!0},{id:"rope",name:"Braided Rope",category:"crafting",station:"none",ingredients:[{itemId:"fiber",quantity:10},{itemId:"wool",quantity:1}],output:{itemId:"rope",quantity:3},craftTime:3,xpReward:8,discoverable:!1},{id:"tusk_trophy",name:"Tusk Trophy",category:"crafting",station:"none",ingredients:[{itemId:"tusk",quantity:3},{itemId:"wood",quantity:20},{itemId:"gold_bar",quantity:1}],output:{itemId:"tusk_trophy",quantity:1},craftTime:5,xpReward:25,discoverable:!0},{id:"health_potion",name:"Health Potion",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"red_mushroom",quantity:3},{itemId:"honey",quantity:1}],output:{itemId:"health_potion",quantity:1},craftTime:5,xpReward:20,discoverable:!1},{id:"stamina_potion",name:"Stamina Potion",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"green_mushroom",quantity:3},{itemId:"honey",quantity:1}],output:{itemId:"stamina_potion",quantity:1},craftTime:5,xpReward:20,discoverable:!1},{id:"greater_health_potion",name:"Greater Health Potion",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"red_mushroom",quantity:5},{itemId:"honey",quantity:2},{itemId:"magic_herb",quantity:1}],output:{itemId:"greater_health_potion",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:4,xpReward:40,discoverable:!0},{id:"greater_stamina_potion",name:"Greater Stamina Potion",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"green_mushroom",quantity:5},{itemId:"honey",quantity:2},{itemId:"magic_herb",quantity:1}],output:{itemId:"greater_stamina_potion",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:4,xpReward:40,discoverable:!0},{id:"frost_resistance_potion",name:"Frost Resistance Draught",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"ice_crystal",quantity:3},{itemId:"hot_pepper",quantity:2},{itemId:"honey",quantity:1}],output:{itemId:"frost_resistance_potion",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:3,xpReward:35,discoverable:!0},{id:"venom_antidote",name:"Venom Antidote",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"green_mushroom",quantity:2},{itemId:"fang",quantity:2},{itemId:"honey",quantity:1}],output:{itemId:"venom_antidote",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:3,xpReward:30,discoverable:!0},{id:"berserker_elixir",name:"Berserker Elixir",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"red_mushroom",quantity:3},{itemId:"bat_wing",quantity:3},{itemId:"hot_pepper",quantity:2}],output:{itemId:"berserker_elixir",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:5,xpReward:45,discoverable:!0},{id:"ironhide_tonic",name:"Ironhide Tonic",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"iron_bar",quantity:1},{itemId:"mushroom",quantity:3},{itemId:"slime_gel",quantity:2},{itemId:"honey",quantity:1}],output:{itemId:"ironhide_tonic",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:4,xpReward:40,discoverable:!0},{id:"nightsight_potion",name:"Nightsight Potion",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"bat_wing",quantity:4},{itemId:"ectoplasm",quantity:2},{itemId:"magic_herb",quantity:1}],output:{itemId:"nightsight_potion",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:3,xpReward:35,discoverable:!0},{id:"swiftness_potion",name:"Swiftness Potion",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"spore",quantity:3},{itemId:"green_mushroom",quantity:2},{itemId:"sugar",quantity:2}],output:{itemId:"swiftness_potion",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:2,xpReward:30,discoverable:!0},{id:"spirit_ward",name:"Spirit Ward",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"spirit_shard",quantity:3},{itemId:"ectoplasm",quantity:3},{itemId:"magic_herb",quantity:2}],output:{itemId:"spirit_ward",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:6,xpReward:50,discoverable:!0},{id:"prismatic_elixir",name:"Prismatic Elixir",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"prismatic_shard",quantity:1},{itemId:"royal_jelly",quantity:1},{itemId:"magic_herb",quantity:3},{itemId:"honey",quantity:2}],output:{itemId:"prismatic_elixir",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:9,xpReward:100,discoverable:!0},{id:"galaxy_tincture",name:"Galaxy Tincture",category:"alchemy",station:"alchemy_table",ingredients:[{itemId:"galaxy_soul",quantity:1},{itemId:"void_heart",quantity:1},{itemId:"magic_herb",quantity:5}],output:{itemId:"galaxy_tincture",quantity:1},craftTime:10,skillRequired:"foraging",levelRequired:10,xpReward:150,discoverable:!0}],Yt=[{id:"fried_egg",name:"Fried Egg",category:"cooking",station:"kitchen",ingredients:[{itemId:"egg",quantity:1}],output:{itemId:"fried_egg",quantity:1},craftTime:3,xpReward:5,discoverable:!1},{id:"vegetable_soup",name:"Vegetable Soup",category:"cooking",station:"kitchen",ingredients:[{itemId:"potato",quantity:1},{itemId:"carrot",quantity:1},{itemId:"parsnip",quantity:1}],output:{itemId:"vegetable_soup",quantity:1},craftTime:5,xpReward:15,discoverable:!1},{id:"grilled_corn",name:"Grilled Corn",category:"cooking",station:"campfire",ingredients:[{itemId:"corn",quantity:1}],output:{itemId:"grilled_corn",quantity:1},craftTime:3,xpReward:5,discoverable:!1},{id:"tomato_sauce",name:"Tomato Sauce",category:"cooking",station:"kitchen",ingredients:[{itemId:"tomato",quantity:3}],output:{itemId:"tomato_sauce",quantity:1},craftTime:4,xpReward:10,discoverable:!1},{id:"baked_potato",name:"Loaded Baked Potato",category:"cooking",station:"kitchen",ingredients:[{itemId:"potato",quantity:1},{itemId:"milk",quantity:1}],output:{itemId:"baked_potato",quantity:1},craftTime:4,xpReward:5,discoverable:!1},{id:"roasted_cauliflower",name:"Roasted Cauliflower",category:"cooking",station:"campfire",ingredients:[{itemId:"cauliflower",quantity:2},{itemId:"honey",quantity:1}],output:{itemId:"roasted_cauliflower",quantity:1},craftTime:4,xpReward:5,discoverable:!1},{id:"fish_dinner",name:"Fish Dinner",category:"cooking",station:"kitchen",ingredients:[{itemId:"fish",quantity:1},{itemId:"potato",quantity:1}],output:{itemId:"fish_dinner",quantity:1},craftTime:5,xpReward:20,discoverable:!1},{id:"fish_stew",name:"Fish Stew",category:"cooking",station:"kitchen",ingredients:[{itemId:"fish",quantity:2},{itemId:"potato",quantity:1}],output:{itemId:"fish_stew",quantity:1},craftTime:6,xpReward:15,discoverable:!1},{id:"grilled_fish",name:"Grilled Fish",category:"cooking",station:"campfire",ingredients:[{itemId:"fish",quantity:1}],output:{itemId:"grilled_fish",quantity:1},craftTime:3,xpReward:5,discoverable:!1},{id:"grilled_salmon",name:"Grilled Salmon",category:"cooking",station:"campfire",ingredients:[{itemId:"salmon",quantity:1},{itemId:"hot_pepper",quantity:1}],output:{itemId:"grilled_salmon",quantity:1},craftTime:5,xpReward:10,discoverable:!1},{id:"spicy_eel",name:"Spicy Eel",category:"cooking",station:"kitchen",ingredients:[{itemId:"eel",quantity:1},{itemId:"hot_pepper",quantity:1}],output:{itemId:"spicy_eel",quantity:1},craftTime:6,xpReward:20,discoverable:!0},{id:"charred_octopus",name:"Charred Octopus",category:"cooking",station:"kitchen",ingredients:[{itemId:"octopus",quantity:1},{itemId:"hot_pepper",quantity:1},{itemId:"tomato",quantity:1}],output:{itemId:"charred_octopus",quantity:1},craftTime:7,xpReward:20,discoverable:!0},{id:"fishermans_breakfast",name:"Fisherman's Breakfast",category:"cooking",station:"kitchen",ingredients:[{itemId:"fish",quantity:1},{itemId:"egg",quantity:2},{itemId:"potato",quantity:1}],output:{itemId:"fishermans_breakfast",quantity:1},craftTime:5,xpReward:10,discoverable:!1},{id:"seafood_chowder",name:"Seafood Chowder",category:"cooking",station:"kitchen",ingredients:[{itemId:"salmon",quantity:1},{itemId:"potato",quantity:1},{itemId:"milk",quantity:1}],output:{itemId:"seafood_chowder",quantity:1},craftTime:8,xpReward:15,discoverable:!0},{id:"bass_fillet",name:"Seared Bass Fillet",category:"cooking",station:"kitchen",ingredients:[{itemId:"bass",quantity:1},{itemId:"tomato",quantity:1}],output:{itemId:"bass_fillet",quantity:1},craftTime:4,xpReward:10,discoverable:!1},{id:"catfish_wrap",name:"Catfish Wrap",category:"cooking",station:"kitchen",ingredients:[{itemId:"catfish",quantity:1},{itemId:"tortilla",quantity:1},{itemId:"hot_pepper",quantity:1}],output:{itemId:"catfish_wrap",quantity:1},craftTime:4,xpReward:10,discoverable:!1},{id:"sturgeon_feast",name:"Sturgeon Feast",category:"cooking",station:"kitchen",ingredients:[{itemId:"sturgeon",quantity:1},{itemId:"potato",quantity:2},{itemId:"tomato",quantity:1},{itemId:"honey",quantity:1}],output:{itemId:"sturgeon_feast",quantity:1},craftTime:12,xpReward:50,discoverable:!0},{id:"pufferfish_sake",name:"Pufferfish Sake",category:"cooking",station:"kitchen",ingredients:[{itemId:"pufferfish",quantity:1},{itemId:"wheat",quantity:3}],output:{itemId:"pufferfish_sake",quantity:1},craftTime:8,xpReward:25,discoverable:!0},{id:"cooked_meat",name:"Cooked Meat",category:"cooking",station:"campfire",ingredients:[{itemId:"raw_meat",quantity:1}],output:{itemId:"cooked_meat",quantity:1},craftTime:3,xpReward:5,discoverable:!1},{id:"roasted_venison",name:"Roasted Venison",category:"cooking",station:"kitchen",ingredients:[{itemId:"venison",quantity:1},{itemId:"honey",quantity:1}],output:{itemId:"roasted_venison",quantity:1},craftTime:7,xpReward:15,discoverable:!1},{id:"grilled_boar",name:"Grilled Wild Boar",category:"cooking",station:"campfire",ingredients:[{itemId:"boar_meat",quantity:1}],output:{itemId:"grilled_boar",quantity:1},craftTime:5,xpReward:10,discoverable:!1},{id:"rabbit_pie",name:"Rabbit Pie",category:"cooking",station:"kitchen",ingredients:[{itemId:"rabbit_meat",quantity:2},{itemId:"potato",quantity:1},{itemId:"carrot",quantity:1}],output:{itemId:"rabbit_pie",quantity:1},craftTime:9,xpReward:20,discoverable:!0},{id:"meat_stew",name:"Hearty Meat Stew",category:"cooking",station:"kitchen",ingredients:[{itemId:"raw_meat",quantity:2},{itemId:"potato",quantity:1},{itemId:"carrot",quantity:1}],output:{itemId:"meat_stew",quantity:1},craftTime:8,xpReward:15,discoverable:!1},{id:"hunters_platter",name:"Hunter's Platter",category:"cooking",station:"kitchen",ingredients:[{itemId:"venison",quantity:1},{itemId:"boar_meat",quantity:1},{itemId:"rabbit_meat",quantity:1}],output:{itemId:"hunters_platter",quantity:1},craftTime:12,xpReward:50,discoverable:!0},{id:"honey_glazed_ham",name:"Honey Glazed Ham",category:"cooking",station:"kitchen",ingredients:[{itemId:"boar_meat",quantity:2},{itemId:"honey",quantity:2}],output:{itemId:"honey_glazed_ham",quantity:1},craftTime:10,xpReward:20,discoverable:!0},{id:"peppered_venison",name:"Peppered Venison Steak",category:"cooking",station:"kitchen",ingredients:[{itemId:"venison",quantity:1},{itemId:"hot_pepper",quantity:2}],output:{itemId:"peppered_venison",quantity:1},craftTime:6,xpReward:15,discoverable:!0},{id:"tomato_soup",name:"Tomato Soup",category:"cooking",station:"kitchen",ingredients:[{itemId:"tomato",quantity:3}],output:{itemId:"tomato_soup",quantity:1},craftTime:4,xpReward:5,discoverable:!1},{id:"corn_chowder",name:"Corn Chowder",category:"cooking",station:"kitchen",ingredients:[{itemId:"corn",quantity:2},{itemId:"potato",quantity:1},{itemId:"milk",quantity:1}],output:{itemId:"corn_chowder",quantity:1},craftTime:6,xpReward:10,discoverable:!1},{id:"mushroom_risotto",name:"Mushroom Risotto",category:"cooking",station:"kitchen",ingredients:[{itemId:"mushroom",quantity:3},{itemId:"milk",quantity:1}],output:{itemId:"mushroom_risotto",quantity:1},craftTime:7,xpReward:15,discoverable:!0},{id:"dark_mushroom_broth",name:"Dark Mushroom Broth",category:"cooking",station:"kitchen",ingredients:[{itemId:"red_mushroom",quantity:2},{itemId:"green_mushroom",quantity:2},{itemId:"mushroom",quantity:1}],output:{itemId:"dark_mushroom_broth",quantity:1},craftTime:6,xpReward:15,discoverable:!0},{id:"pumpkin_stew",name:"Pumpkin Stew",category:"cooking",station:"kitchen",ingredients:[{itemId:"pumpkin",quantity:1},{itemId:"potato",quantity:1},{itemId:"milk",quantity:1}],output:{itemId:"pumpkin_stew",quantity:1},craftTime:7,xpReward:10,discoverable:!1},{id:"bone_marrow_soup",name:"Bone Marrow Soup",category:"cooking",station:"kitchen",ingredients:[{itemId:"bone",quantity:3},{itemId:"carrot",quantity:1},{itemId:"potato",quantity:1}],output:{itemId:"bone_marrow_soup",quantity:1},craftTime:9,xpReward:10,discoverable:!0},{id:"hunters_stew",name:"Hunter's Stew",category:"cooking",station:"kitchen",ingredients:[{itemId:"venison",quantity:1},{itemId:"mushroom",quantity:2},{itemId:"carrot",quantity:1},{itemId:"potato",quantity:1}],output:{itemId:"hunters_stew",quantity:1},craftTime:10,xpReward:20,discoverable:!0},{id:"fruit_salad",name:"Fruit Salad",category:"cooking",station:"none",ingredients:[{itemId:"apple",quantity:2},{itemId:"melon",quantity:1}],output:{itemId:"fruit_salad",quantity:1},craftTime:2,xpReward:5,discoverable:!1},{id:"pumpkin_pie",name:"Pumpkin Pie",category:"cooking",station:"kitchen",ingredients:[{itemId:"pumpkin",quantity:1},{itemId:"wheat",quantity:2},{itemId:"egg",quantity:1}],output:{itemId:"pumpkin_pie",quantity:1},craftTime:8,xpReward:20,discoverable:!0},{id:"honey_cake",name:"Honey Cake",category:"cooking",station:"kitchen",ingredients:[{itemId:"honey",quantity:2},{itemId:"egg",quantity:2},{itemId:"wheat_flour",quantity:1}],output:{itemId:"honey_cake",quantity:1},craftTime:8,xpReward:15,discoverable:!0},{id:"fruit_tart",name:"Fruit Tart",category:"cooking",station:"kitchen",ingredients:[{itemId:"apple",quantity:2},{itemId:"wheat_flour",quantity:1},{itemId:"sugar",quantity:1}],output:{itemId:"fruit_tart",quantity:1},craftTime:6,xpReward:10,discoverable:!1},{id:"dark_bread",name:"Dark Rye Bread",category:"cooking",station:"kitchen",ingredients:[{itemId:"wheat_flour",quantity:2},{itemId:"honey",quantity:1}],output:{itemId:"dark_bread",quantity:2},craftTime:5,xpReward:10,discoverable:!1},{id:"melon_sorbet",name:"Melon Sorbet",category:"cooking",station:"kitchen",ingredients:[{itemId:"melon",quantity:2},{itemId:"sugar",quantity:2}],output:{itemId:"melon_sorbet",quantity:1},craftTime:4,xpReward:10,discoverable:!1},{id:"goat_cheese_tart",name:"Goat Cheese Tart",category:"cooking",station:"kitchen",ingredients:[{itemId:"goat_milk",quantity:2},{itemId:"wheat_flour",quantity:1},{itemId:"egg",quantity:1}],output:{itemId:"goat_cheese_tart",quantity:1},craftTime:7,xpReward:15,discoverable:!0},{id:"truffle_pastry",name:"Truffle Pastry",category:"cooking",station:"kitchen",ingredients:[{itemId:"truffle",quantity:1},{itemId:"wheat_flour",quantity:1},{itemId:"egg",quantity:1},{itemId:"sugar",quantity:1}],output:{itemId:"truffle_pastry",quantity:1},craftTime:8,xpReward:20,discoverable:!0},{id:"stuffed_pumpkin",name:"Stuffed Pumpkin",category:"cooking",station:"kitchen",ingredients:[{itemId:"pumpkin",quantity:1},{itemId:"raw_meat",quantity:1},{itemId:"corn",quantity:1},{itemId:"mushroom",quantity:1}],output:{itemId:"stuffed_pumpkin",quantity:1},craftTime:10,xpReward:20,discoverable:!0},{id:"royal_jelly_cake",name:"Royal Jelly Cake",category:"cooking",station:"kitchen",ingredients:[{itemId:"royal_jelly",quantity:1},{itemId:"wheat_flour",quantity:2},{itemId:"egg",quantity:2},{itemId:"sugar",quantity:2}],output:{itemId:"royal_jelly_cake",quantity:1},craftTime:12,xpReward:50,discoverable:!0},{id:"ale",name:"Ale",category:"cooking",station:"kitchen",ingredients:[{itemId:"wheat",quantity:5},{itemId:"hops",quantity:2}],output:{itemId:"ale",quantity:2},craftTime:5,xpReward:10,discoverable:!1},{id:"wine",name:"Red Wine",category:"cooking",station:"kitchen",ingredients:[{itemId:"grape",quantity:5}],output:{itemId:"wine",quantity:1},craftTime:6,xpReward:15,discoverable:!0},{id:"mead",name:"Honey Mead",category:"cooking",station:"kitchen",ingredients:[{itemId:"honey",quantity:3}],output:{itemId:"mead",quantity:1},craftTime:5,xpReward:10,discoverable:!1},{id:"cider",name:"Apple Cider",category:"cooking",station:"kitchen",ingredients:[{itemId:"apple",quantity:3}],output:{itemId:"cider",quantity:1},craftTime:4,xpReward:5,discoverable:!1},{id:"herbal_tea",name:"Herbal Tea",category:"cooking",station:"kitchen",ingredients:[{itemId:"magic_herb",quantity:1}],output:{itemId:"herbal_tea",quantity:1},craftTime:2,xpReward:5,discoverable:!1},{id:"spiced_cider",name:"Spiced Cider",category:"cooking",station:"kitchen",ingredients:[{itemId:"apple",quantity:3},{itemId:"hot_pepper",quantity:1},{itemId:"sugar",quantity:1}],output:{itemId:"spiced_cider",quantity:1},craftTime:5,xpReward:10,discoverable:!0},{id:"midnight_brew",name:"Midnight Brew",category:"cooking",station:"kitchen",ingredients:[{itemId:"magic_herb",quantity:2},{itemId:"mushroom",quantity:2},{itemId:"honey",quantity:1}],output:{itemId:"midnight_brew",quantity:1},craftTime:6,xpReward:15,discoverable:!0},{id:"farmers_lunch",name:"Farmer's Lunch",category:"cooking",station:"kitchen",ingredients:[{itemId:"parsnip",quantity:1},{itemId:"potato",quantity:1},{itemId:"bread",quantity:1}],output:{itemId:"farmers_lunch",quantity:1},craftTime:5,xpReward:30,discoverable:!1},{id:"miners_treat",name:"Miner's Treat",category:"cooking",station:"kitchen",ingredients:[{itemId:"carrot",quantity:2},{itemId:"bread",quantity:1}],output:{itemId:"miners_treat",quantity:1},craftTime:5,xpReward:25,discoverable:!1},{id:"lucky_lunch",name:"Lucky Lunch",category:"cooking",station:"kitchen",ingredients:[{itemId:"sea_cucumber",quantity:1},{itemId:"tortilla",quantity:1},{itemId:"blue_jazz",quantity:1}],output:{itemId:"lucky_lunch",quantity:1},craftTime:10,xpReward:35,discoverable:!0},{id:"farmers_feast",name:"Farmer's Feast",category:"cooking",station:"kitchen",ingredients:[{itemId:"pumpkin",quantity:1},{itemId:"corn",quantity:2},{itemId:"potato",quantity:2},{itemId:"cauliflower",quantity:1}],output:{itemId:"farmers_feast",quantity:1},craftTime:12,xpReward:50,discoverable:!0},{id:"adventurers_meal",name:"Adventurer's Meal",category:"cooking",station:"kitchen",ingredients:[{itemId:"raw_meat",quantity:2},{itemId:"potato",quantity:2},{itemId:"carrot",quantity:1},{itemId:"bread",quantity:1}],output:{itemId:"adventurers_meal",quantity:1},craftTime:10,xpReward:20,discoverable:!0},{id:"miners_special",name:"Miner's Special",category:"cooking",station:"kitchen",ingredients:[{itemId:"raw_meat",quantity:1},{itemId:"potato",quantity:2},{itemId:"mushroom",quantity:2}],output:{itemId:"miners_special",quantity:1},craftTime:8,xpReward:15,discoverable:!0},{id:"war_rations",name:"War Rations",category:"cooking",station:"kitchen",ingredients:[{itemId:"raw_meat",quantity:2},{itemId:"bread",quantity:2},{itemId:"carrot",quantity:2}],output:{itemId:"war_rations",quantity:2},craftTime:7,xpReward:15,discoverable:!0},{id:"slime_jelly_toast",name:"Slime Jelly Toast",category:"cooking",station:"kitchen",ingredients:[{itemId:"slime_gel",quantity:3},{itemId:"sugar",quantity:1},{itemId:"bread",quantity:1}],output:{itemId:"slime_jelly_toast",quantity:1},craftTime:3,xpReward:10,discoverable:!0},{id:"harvest_casserole",name:"Harvest Casserole",category:"cooking",station:"kitchen",ingredients:[{itemId:"pumpkin",quantity:1},{itemId:"corn",quantity:1},{itemId:"potato",quantity:1},{itemId:"parsnip",quantity:1},{itemId:"egg",quantity:1}],output:{itemId:"harvest_casserole",quantity:1},craftTime:11,xpReward:20,discoverable:!0}],Xa=[...Xn,...Yt],He=new Map;Xa.forEach(r=>He.set(r.id,r));class Kn{discoveredRecipes=new Set;craftQueue=[];craftCompleteCallbacks=[];init(){for(const e of Xa)e.discoverable||this.discoveredRecipes.add(e.id)}discoverRecipe(e){return this.discoveredRecipes.has(e)||!He.get(e)?!1:(this.discoveredRecipes.add(e),!0)}isRecipeDiscovered(e){return this.discoveredRecipes.has(e)}canCraft(e,t,i){const s=He.get(e);if(!s||!this.discoveredRecipes.has(e)||s.station!=="none"&&i!==void 0&&s.station!==i)return!1;for(const a of s.ingredients)if(!t.hasItem(a.itemId,a.quantity))return!1;return!0}craft(e,t,i=1){const s=He.get(e);if(!s)return!1;for(const a of s.ingredients)if(!t.hasItem(a.itemId,a.quantity*i))return!1;if(!this.discoveredRecipes.has(e))return!1;for(const a of s.ingredients)t.removeItem(a.itemId,a.quantity*i);if(s.craftTime<=0){t.addItem(s.output.itemId,s.output.quantity*i);for(const a of this.craftCompleteCallbacks)a(e,s.output.itemId,s.output.quantity*i);return!0}for(let a=0;a<i;a++)this.craftQueue.push({recipeId:e,timer:0,totalTime:s.craftTime});return!0}update(e,t){if(this.craftQueue.length===0)return;const i=this.craftQueue[0];if(i.timer+=e,i.timer>=i.totalTime){const s=He.get(i.recipeId);if(s){t.addItem(s.output.itemId,s.output.quantity);for(const a of this.craftCompleteCallbacks)a(i.recipeId,s.output.itemId,s.output.quantity)}this.craftQueue.shift()}}getAvailableRecipes(e,t){const i=[];for(const s of this.discoveredRecipes)if(this.canCraft(s,e,t)){const a=He.get(s);a&&i.push(a)}return i}getDiscoveredRecipes(){const e=[];for(const t of this.discoveredRecipes){const i=He.get(t);i&&e.push(i)}return e}isCrafting(){return this.craftQueue.length>0}getCraftProgress(){if(this.craftQueue.length===0)return null;const e=this.craftQueue[0];return{recipeId:e.recipeId,progress:e.totalTime>0?Math.min(e.timer/e.totalTime,1):1}}getQueueLength(){return this.craftQueue.length}cancelCraft(){this.craftQueue.length>0&&this.craftQueue.shift()}cancelAll(){this.craftQueue.length=0}onCraftComplete(e){this.craftCompleteCallbacks.push(e)}serialize(){return{discoveredRecipes:[...this.discoveredRecipes],craftQueue:this.craftQueue.map(e=>({...e}))}}deserialize(e){if(this.discoveredRecipes.clear(),this.craftQueue.length=0,e.discoveredRecipes)for(const t of e.discoveredRecipes)this.discoveredRecipes.add(t);if(e.craftQueue)for(const t of e.craftQueue)this.craftQueue.push({...t})}}class Jn{plots=new Map;onHarvestCbs=[];key(e,t){return`${e},${t}`}tillSoil(e,t){const i=this.key(e,t);return this.plots.has(i)?!1:(this.plots.set(i,{x:e,y:t,state:"tilled",seedId:null,cropId:null,growthProgress:0,growthDays:0,quality:0,wateredToday:!1,daysWithoutWater:0,hasScarecrow:!1}),!0)}plantSeed(e,t,i,s){const a=this.key(e,t),o=this.plots.get(a);if(!o||o.state!=="tilled")return!1;const n=j.get(i);if(!n||n.category!=="seed")return!1;const l=n;return l.seasons.includes(s.toLowerCase())?(o.state="planted",o.seedId=i,o.cropId=l.cropId,o.growthProgress=0,o.growthDays=l.growthDays,o.quality=0,!0):!1}waterPlot(e,t){const i=this.key(e,t),s=this.plots.get(i);return!s||s.state==="empty"||s.state==="ready"?!1:(s.wateredToday=!0,s.state==="planted"&&(s.state="growing"),!0)}advanceDay(e){for(const t of this.plots.values()){if(t.state==="tilled"||t.state==="empty"||t.state==="ready"){t.wateredToday=!1;continue}if(t.seedId){const i=j.get(t.seedId);if(i&&!i.seasons.includes(e.toLowerCase())){t.state="tilled",t.seedId=null,t.cropId=null,t.growthProgress=0,t.wateredToday=!1;continue}}t.wateredToday?(t.growthProgress++,t.daysWithoutWater=0,t.quality<3&&Math.random()<.05&&t.quality++,t.growthProgress>=t.growthDays&&(t.state="ready")):(t.daysWithoutWater++,t.daysWithoutWater>3&&(t.state="tilled",t.seedId=null,t.cropId=null,t.growthProgress=0,t.daysWithoutWater=0)),t.wateredToday=!1}}harvest(e,t){const i=this.key(e,t),s=this.plots.get(i);if(!s||s.state!=="ready"||!s.cropId)return null;const a={itemId:s.cropId,quantity:1,quality:s.quality};for(const o of this.onHarvestCbs)o(s.cropId,s.quality,e,t);return s.state="tilled",s.seedId=null,s.cropId=null,s.growthProgress=0,s.growthDays=0,s.quality=0,s.daysWithoutWater=0,a}getPlot(e,t){return this.plots.get(this.key(e,t))??null}getAllPlots(){return Array.from(this.plots.values())}placeScarecrow(e,t,i){for(const s of this.plots.values()){const a=s.x-e,o=s.y-t;Math.sqrt(a*a+o*o)<=i&&(s.hasScarecrow=!0)}}waterAllCrops(){for(const e of this.plots.values())(e.state==="planted"||e.state==="growing"||e.state==="watered")&&(e.wateredToday=!0,e.state==="planted"&&(e.state="growing"))}removePlot(e,t){this.plots.delete(this.key(e,t))}onHarvest(e){this.onHarvestCbs.push(e)}serialize(){return Array.from(this.plots.values())}deserialize(e){this.plots.clear();for(const t of e)this.plots.set(this.key(t.x,t.y),{...t})}}class Zn{session=null;totalCatches=0;fishCaught=new Map;onCatchCbs=[];onFailCbs=[];getAvailableFish(e,t,i){const s=e.toLowerCase(),a=t.toLowerCase(),o=i.toLowerCase();return ja.filter(n=>{const l=n.seasons.length===0||n.seasons.some(h=>h.toLowerCase()===s),c=n.timeOfDay.length===0||n.timeOfDay.some(h=>h.toLowerCase()===a),d=n.locations.length===0||n.locations.some(h=>h.toLowerCase()===o);return l&&c&&d})}startFishing(e,t,i,s){if(this.session?.active)return!1;const a=this.getAvailableFish(e,t,i);if(a.length===0)return!1;const o=a.map(h=>Math.max(1,100-h.difficulty)),n=o.reduce((h,u)=>h+u,0);let l=Math.random()*n,c=a[0];for(let h=0;h<a.length;h++)if(l-=o[h],l<=0){c=a[h];break}const d=c.minSize+Math.random()*(c.maxSize-c.minSize);return this.session={active:!0,fishId:c.id,difficulty:c.difficulty,progress:30,barPosition:50,fishPosition:50,fishSpeed:1+c.difficulty*.02,timer:30,size:Math.round(d*10)/10,baitBonus:s?1.5:1},!0}update(e){if(!this.session?.active)return;const t=this.session;t.timer-=e,t.fishPosition=Math.sin(t.timer*t.fishSpeed)*35+50+Math.sin(t.timer*t.fishSpeed*2.7)*10,t.fishPosition=Math.max(5,Math.min(95,t.fishPosition)),Math.abs(t.barPosition-t.fishPosition)<=15?t.progress+=e*40*t.baitBonus:t.progress-=e*25,t.progress=Math.max(0,Math.min(100,t.progress)),t.progress>=100?this.catchFish():(t.progress<=0||t.timer<=0)&&this.failFishing()}moveBar(e){this.session?.active&&(this.session.barPosition=Math.max(0,Math.min(100,this.session.barPosition+e)))}isActive(){return this.session?.active??!1}getSession(){return this.session}cancelFishing(){this.session&&(this.session.active=!1,this.session=null)}getTotalCatches(){return this.totalCatches}getFishCount(e){return this.fishCaught.get(e)??0}catchFish(){if(!this.session?.fishId)return;const e=this.session.fishId,t=this.session.size;this.totalCatches++,this.fishCaught.set(e,(this.fishCaught.get(e)??0)+1);for(const i of this.onCatchCbs)i(e,t);this.session.active=!1,this.session=null}failFishing(){for(const e of this.onFailCbs)e();this.session&&(this.session.active=!1,this.session=null)}onCatch(e){this.onCatchCbs.push(e)}onFail(e){this.onFailCbs.push(e)}serialize(){return{totalCatches:this.totalCatches,fishCaught:Object.fromEntries(this.fishCaught)}}deserialize(e){this.totalCatches=e.totalCatches,this.fishCaught=new Map(Object.entries(e.fishCaught))}}class el{activeBuffs=[];totalCooked=0;onCookCbs=[];getAvailableRecipes(e){return Yt.filter(t=>t.ingredients.every(i=>e.hasItem(i.itemId,i.quantity)))}getAllRecipes(){return Yt}cook(e,t){const i=Yt.find(o=>o.id===e);if(!i||!i.ingredients.every(o=>t.hasItem(o.itemId,o.quantity)))return!1;for(const o of i.ingredients)t.removeItem(o.itemId,o.quantity);const a=j.get(i.output.itemId)?.maxStack??99;t.addItem(i.output.itemId,i.output.quantity,a),this.totalCooked++;for(const o of this.onCookCbs)o(e);return!0}eatFood(e){const t=j.get(e);if(!t||t.category!=="food")return null;const i=t;let s=null;if(i.buffType&&i.buffDuration&&i.buffMagnitude){s={type:i.buffType,magnitude:i.buffMagnitude,duration:i.buffDuration,source:e};const a=this.activeBuffs.findIndex(o=>o.type===i.buffType);a>=0?this.activeBuffs[a]=s:this.activeBuffs.push(s)}return{healAmount:i.healAmount,staminaRestore:i.staminaRestore,buff:s}}update(e){for(let t=this.activeBuffs.length-1;t>=0;t--)this.activeBuffs[t].duration-=e,this.activeBuffs[t].duration<=0&&this.activeBuffs.splice(t,1)}getActiveBuffs(){return this.activeBuffs}hasBuff(e){return this.activeBuffs.some(t=>t.type===e)}getBuffMagnitude(e){return this.activeBuffs.find(t=>t.type===e)?.magnitude??0}getTotalCooked(){return this.totalCooked}onCook(e){this.onCookCbs.push(e)}serialize(){return{totalCooked:this.totalCooked,activeBuffs:this.activeBuffs.map(e=>({...e}))}}deserialize(e){this.totalCooked=e.totalCooked,this.activeBuffs=e.activeBuffs.map(t=>({...t}))}}const tl={[p.Sword]:{5:"Riposte",10:"Blade Dance",15:"Parry Master",20:"Sword Saint"},[p.Axe]:{5:"Cleave",10:"Rending Blow",15:"Berserker",20:"Axe Lord"},[p.Spear]:{5:"Thrust",10:"Sweep",15:"Phalanx",20:"Dragoon"},[p.Bow]:{5:"Steady Aim",10:"Multishot",15:"Eagle Eye",20:"Marksman"},[p.Staff]:{5:"Mana Shield",10:"Spell Echo",15:"Arcane Mastery",20:"Archmage"},[p.Dagger]:{5:"Backstab",10:"Poison Coat",15:"Shadow Walk",20:"Assassin"},[p.Hammer]:{5:"Stagger",10:"Earthquake",15:"Fortress",20:"Titan"}},Us=20,il=[5,10,15,20],sl=[p.Sword,p.Axe,p.Spear,p.Bow,p.Staff,p.Dagger,p.Hammer];class al{masteryXP=new Map;masteryLevels=new Map;masteryUpCallbacks=[];constructor(){for(const e of sl)this.masteryXP.set(e,0),this.masteryLevels.set(e,0)}addXP(e,t){if(e===p.Unarmed||t<=0||!this.masteryXP.has(e))return;const i=this.masteryLevels.get(e)??0,s=(this.masteryXP.get(e)??0)+t;this.masteryXP.set(e,s);const a=this.computeLevel(s);this.masteryLevels.set(e,a);for(let o=i+1;o<=a;o++)for(const n of this.masteryUpCallbacks)n(e,o)}getLevel(e){return this.masteryLevels.get(e)??0}getXP(e){const t=this.masteryXP.get(e)??0,i=this.getLevel(e),s=this.xpForLevel(i),a=t-s,o=i<Us?this.xpForLevel(i+1)-s:0;return{current:a,required:o}}getDamageBonus(e){return this.getLevel(e)*.02}getSpeedBonus(e){return this.getLevel(e)*.01}getMilestoneUnlocks(e){const t=this.getLevel(e),i=tl[e];if(!i)return[];const s=[];for(const a of il)a<=t&&i[a]&&s.push(i[a]);return s}onMasteryUp(e){this.masteryUpCallbacks.push(e)}serialize(){const e={},t={};for(const[i,s]of this.masteryXP)e[i]=s;for(const[i,s]of this.masteryLevels)t[i]=s;return{xp:e,levels:t}}deserialize(e){if(e.xp)for(const[t,i]of Object.entries(e.xp))this.masteryXP.set(Number(t),i);if(e.levels)for(const[t,i]of Object.entries(e.levels))this.masteryLevels.set(Number(t),i)}xpForLevel(e){return 100*e*e}computeLevel(e){let t=0;for(;t<Us&&e>=this.xpForLevel(t+1);)t++;return t}}const Ce=[{id:1,name:"Awakening",biome:"haven",description:"You awaken in Haven with no memory. The village elder teaches you the basics of survival. But something dark stirs at the edge of the meadows...",requiredObjectives:[{type:"talk",target:"elder_mira",count:1,description:"Speak with Elder Mira"},{type:"craft",target:"workbench",count:1,description:"Craft your first tool"},{type:"farm",target:"any_crop",count:5,description:"Grow 5 crops"},{type:"kill",target:"forest_slime",count:10,description:"Clear 10 slimes from the fields"},{type:"explore",target:"haven_dungeon",count:1,description:"Discover the Overgrown Cellar"},{type:"kill",target:"harvest_horror",count:1,description:"Defeat the Harvest Horror"}],optionalObjectives:[{type:"fish",target:"any_fish",count:5,description:"Catch 5 fish"},{type:"collect",target:"wild_berries",count:20,description:"Gather 20 wild berries"},{type:"talk",target:"all_haven_npcs",count:5,description:"Meet all Haven villagers"}],gateBoss:"harvest_horror",unlocks:["rotwood_access","crafting_stations","quest_board"],cutsceneIds:["intro_awakening","elder_tutorial","corruption_revealed"]},{id:2,name:"The Rot Spreads",biome:"rotwood",description:"The corruption in Rotwood grows stronger. Fungi and spores choke the forest. You must find the source and perform your first purification.",requiredObjectives:[{type:"explore",target:"rotwood_entrance",count:1,description:"Enter the Rotwood"},{type:"kill",target:"rotwood_enemies",count:25,description:"Slay 25 corrupted creatures"},{type:"collect",target:"purification_reagent",count:3,description:"Gather 3 purification reagents"},{type:"craft",target:"purification_charm",count:1,description:"Craft a Purification Charm"},{type:"explore",target:"fungal_depths",count:1,description:"Reach the Fungal Depths dungeon"},{type:"kill",target:"blight_mother",count:1,description:"Defeat the Blight Mother"}],optionalObjectives:[{type:"collect",target:"mushroom_cluster",count:30,description:"Harvest 30 mushroom clusters"},{type:"kill",target:"corrupted_treant",count:5,description:"Fell 5 Corrupted Treants"}],gateBoss:"blight_mother",unlocks:["ashlands_access","purification_system","corruption_meter"],cutsceneIds:["rotwood_entry","first_purification","blight_mother_reveal"]},{id:3,name:"Forged in Fire",biome:"ashlands",description:"The Ashlands burn with volcanic fury. Here you learn to build settlements and forge powerful equipment from the land's fiery resources.",requiredObjectives:[{type:"explore",target:"ashlands_entrance",count:1,description:"Enter the Ashlands"},{type:"craft",target:"fire_resistant_armor",count:1,description:"Forge fire-resistant armor"},{type:"reach",target:"settlement_site_1",count:1,description:"Discover a settlement site"},{type:"craft",target:"settlement_town_hall",count:1,description:"Build a Town Hall"},{type:"explore",target:"volcanic_forge_dungeon",count:1,description:"Clear the Volcanic Forge dungeon"},{type:"kill",target:"stone_titan",count:1,description:"Defeat the Stone Titan"}],optionalObjectives:[{type:"craft",target:"obsidian_weapon",count:1,description:"Forge an obsidian weapon"},{type:"mine",target:"fire_crystal",count:10,description:"Mine 10 fire crystals"}],gateBoss:"stone_titan",unlocks:["drowned_access","settlement_system","advanced_crafting"],cutsceneIds:["ashlands_entry","settlement_tutorial","stone_titan_awakens"]},{id:4,name:"Depths Below",biome:"drowned",description:"Flooded ruins hide ancient secrets. The Rift system activates, opening portals to infinite challenges. Something massive lurks in the deep.",requiredObjectives:[{type:"explore",target:"drowned_entrance",count:1,description:"Enter the Drowned Depths"},{type:"collect",target:"breathing_apparatus",count:1,description:"Craft underwater breathing gear"},{type:"explore",target:"rift_portal",count:1,description:"Discover the first Rift Portal"},{type:"reach",target:"rift_floor_5",count:1,description:"Reach Rift floor 5"},{type:"explore",target:"sunken_temple",count:1,description:"Clear the Sunken Temple dungeon"},{type:"kill",target:"kraken",count:1,description:"Defeat the Kraken"}],optionalObjectives:[{type:"fish",target:"deep_fish",count:10,description:"Catch 10 deep-sea fish"},{type:"reach",target:"rift_floor_10",count:1,description:"Reach Rift floor 10"}],gateBoss:"kraken",unlocks:["bone_wastes_access","rift_system","underwater_exploration"],cutsceneIds:["drowned_entry","rift_discovery","kraken_emerges"]},{id:5,name:"Valley of Bones",biome:"bone_wastes",description:"The desert hides a war between factions vying for control. Massive titans roam the wastes. Choose your allegiances carefully.",requiredObjectives:[{type:"explore",target:"bone_wastes_entrance",count:1,description:"Enter the Bone Wastes"},{type:"talk",target:"faction_leader",count:1,description:"Meet a faction leader"},{type:"kill",target:"faction_outpost",count:3,description:"Clear 3 enemy faction outposts"},{type:"explore",target:"titan_trail",count:1,description:"Find a Titan's trail"},{type:"explore",target:"bone_crypt",count:1,description:"Clear the Bone Crypt dungeon"},{type:"kill",target:"sand_wyrm",count:1,description:"Defeat the Sand Wyrm"}],optionalObjectives:[{type:"kill",target:"titan_any",count:1,description:"Defeat a roaming Titan"},{type:"collect",target:"ancient_bone",count:50,description:"Collect 50 ancient bones"}],gateBoss:"sand_wyrm",unlocks:["void_access","faction_system","titan_hunting"],cutsceneIds:["bone_wastes_entry","faction_war_begins","sand_wyrm_burrows"]},{id:6,name:"Beyond Reality",biome:"the_void",description:"Reality unravels. The Shadow World opens, allowing dimension-shifting between two versions of the world. The truth about EDILAS begins to emerge.",requiredObjectives:[{type:"explore",target:"void_entrance",count:1,description:"Enter The Void"},{type:"explore",target:"rift_stone",count:1,description:"Activate a Rift Stone to enter the Shadow World"},{type:"collect",target:"shadow_resource",count:10,description:"Gather 10 shadow-exclusive resources"},{type:"kill",target:"shadow_enemies",count:20,description:"Slay 20 shadow creatures"},{type:"explore",target:"reality_breach",count:1,description:"Clear the Reality Breach dungeon"},{type:"kill",target:"void_weaver",count:1,description:"Defeat the Void Weaver"}],optionalObjectives:[{type:"reach",target:"rift_floor_25",count:1,description:"Reach Rift floor 25"},{type:"kill",target:"cross_dimensional_boss",count:1,description:"Defeat a cross-dimensional boss"}],gateBoss:"void_weaver",unlocks:["edilas_access","shadow_world","dimension_shifting"],cutsceneIds:["void_entry","shadow_world_reveal","void_weaver_truth"]},{id:7,name:"The Living Pilgrimage",biome:"edilas",description:"The final confrontation. EDILAS itself is alive  the source of corruption, and the key to salvation. Your pilgrimage ends here.",requiredObjectives:[{type:"explore",target:"edilas_heart",count:1,description:"Reach the Heart of EDILAS"},{type:"collect",target:"primordial_essence",count:5,description:"Gather 5 Primordial Essences"},{type:"kill",target:"corruption_avatar",count:3,description:"Destroy 3 Corruption Avatars"},{type:"explore",target:"world_core",count:1,description:"Enter the World Core dungeon"},{type:"kill",target:"world_serpent",count:1,description:"Defeat the World Serpent"}],optionalObjectives:[{type:"reach",target:"rift_floor_50",count:1,description:"Reach Rift floor 50"},{type:"kill",target:"all_titans",count:5,description:"Defeat all 5 Titans"},{type:"reach",target:"max_corruption_purified",count:1,description:"Purify all corruption in Haven"}],gateBoss:"world_serpent",unlocks:["new_game_plus","endless_mode","mythic_crafting"],cutsceneIds:["edilas_revelation","world_serpent_awakens","ending_pilgrimage_complete"]}];new Map(Ce.map(r=>[r.id,r]));class rl{currentChapter=1;chapterProgress=new Map;unlockedBiomes=new Set(["haven"]);unlockedFeatures=new Set;defeatedBosses=new Set;onChapterCompleteCbs=[];onBiomeUnlockCbs=[];onCutsceneCbs=[];constructor(){this.initChapter(1)}initChapter(e){const t=Ce.find(i=>i.id===e);!t||this.chapterProgress.has(e)||this.chapterProgress.set(e,{chapterId:e,requiredProgress:new Array(t.requiredObjectives.length).fill(0),optionalProgress:new Array(t.optionalObjectives.length).fill(0),completed:!1,bossDefeated:!1})}getCurrentChapter(){return this.currentChapter}getChapterDef(e){return Ce.find(t=>t.id===e)??null}getProgress(e){return this.chapterProgress.get(e)??null}updateObjective(e,t,i){const s=Ce.find(o=>o.id===this.currentChapter),a=this.chapterProgress.get(this.currentChapter);if(!(!s||!a)){for(let o=0;o<s.requiredObjectives.length;o++){const n=s.requiredObjectives[o];n.type===e&&(n.target===t||n.target.startsWith("any"))&&(a.requiredProgress[o]=Math.min(a.requiredProgress[o]+i,n.count))}for(let o=0;o<s.optionalObjectives.length;o++){const n=s.optionalObjectives[o];n.type===e&&(n.target===t||n.target.startsWith("any")||n.target.startsWith("all"))&&(a.optionalProgress[o]=Math.min(a.optionalProgress[o]+i,n.count))}this.checkChapterCompletion()}}defeatBoss(e){this.defeatedBosses.add(e);const t=Ce.find(s=>s.id===this.currentChapter),i=this.chapterProgress.get(this.currentChapter);!t||!i||(t.gateBoss===e&&(i.bossDefeated=!0,this.updateObjective("kill",e,1)),this.checkChapterCompletion())}checkChapterCompletion(){const e=Ce.find(s=>s.id===this.currentChapter),t=this.chapterProgress.get(this.currentChapter);if(!e||!t||t.completed)return;if(e.requiredObjectives.every((s,a)=>t.requiredProgress[a]>=s.count)&&t.bossDefeated){t.completed=!0;for(const a of e.unlocks)if(this.unlockedFeatures.add(a),a.endsWith("_access")){const o=a.replace("_access","");this.unlockedBiomes.add(o);for(const n of this.onBiomeUnlockCbs)n(o)}for(const a of this.onChapterCompleteCbs)a(this.currentChapter);const s=this.currentChapter+1;Ce.find(a=>a.id===s)&&(this.currentChapter=s,this.initChapter(s))}}triggerCutscene(e){for(const t of this.onCutsceneCbs)t(e)}isBiomeUnlocked(e){return this.unlockedBiomes.has(e)}isFeatureUnlocked(e){return this.unlockedFeatures.has(e)}isBossDefeated(e){return this.defeatedBosses.has(e)}getUnlockedBiomes(){return Array.from(this.unlockedBiomes)}getCompletionPercent(e){const t=Ce.find(o=>o.id===e),i=this.chapterProgress.get(e);if(!t||!i||t.requiredObjectives.length===0)return 0;let s=0,a=0;for(let o=0;o<t.requiredObjectives.length;o++)s+=t.requiredObjectives[o].count,a+=i.requiredProgress[o];return Math.min(1,a/s)}onChapterComplete(e){this.onChapterCompleteCbs.push(e)}onBiomeUnlock(e){this.onBiomeUnlockCbs.push(e)}onCutscene(e){this.onCutsceneCbs.push(e)}serialize(){const e={};for(const[t,i]of this.chapterProgress)e[t]={...i,requiredProgress:[...i.requiredProgress],optionalProgress:[...i.optionalProgress]};return{currentChapter:this.currentChapter,chapterProgress:e,unlockedBiomes:Array.from(this.unlockedBiomes),unlockedFeatures:Array.from(this.unlockedFeatures),defeatedBosses:Array.from(this.defeatedBosses)}}deserialize(e){this.currentChapter=e.currentChapter,this.chapterProgress.clear();for(const[t,i]of Object.entries(e.chapterProgress))this.chapterProgress.set(Number(t),{...i});this.unlockedBiomes=new Set(e.unlockedBiomes),this.unlockedFeatures=new Set(e.unlockedFeatures),this.defeatedBosses=new Set(e.defeatedBosses)}}class me{chunks=new Map;shadowWorld=!1;onCorruptionSpreadCallbacks=[];static key(e,t){return`${e},${t}`}static tileToChunk(e,t){const i=Math.floor(e/I),s=Math.floor(t/I),a=(e%I+I)%I,o=(t%I+I)%I;return{cx:i,cy:s,lx:a,ly:o}}ensureChunk(e,t){const i=me.key(e,t);let s=this.chunks.get(i);return s||(s=new Float32Array(I*I),this.chunks.set(i,s)),s}static idx(e,t){return t*I+e}getCorruption(e,t){const{cx:i,cy:s,lx:a,ly:o}=me.tileToChunk(e,t),n=this.chunks.get(me.key(i,s));return n?n[me.idx(a,o)]:0}setCorruption(e,t,i){const{cx:s,cy:a,lx:o,ly:n}=me.tileToChunk(e,t),l=this.ensureChunk(s,a);l[me.idx(o,n)]=Math.max(0,Math.min(1,i))}purifyTile(e,t,i){const s=this.getCorruption(e,t);this.setCorruption(e,t,s-i)}purifyChunk(e,t){const i=me.key(e,t),s=this.chunks.get(i);s&&s.fill(0)}spreadCorruption(e){const t=this.shadowWorld?Cs*2:Cs;for(const i of e){const s=this.chunks.get(i);if(!s)continue;const a=new Float32Array(s);let o=!1;for(let n=0;n<I;n++)for(let l=0;l<I;l++){const c=me.idx(l,n),d=a[c];if(d<=0)continue;const h=d*t,u=[[l-1,n],[l+1,n],[l,n-1],[l,n+1]];for(const[m,g]of u){if(m<0||m>=I||g<0||g>=I)continue;const y=me.idx(m,g);s[y]<1&&(s[y]=Math.min(1,s[y]+h),o=!0)}}if(o)for(const n of this.onCorruptionSpreadCallbacks)n(i)}}getPlayerEffects(e,t){const i=this.getCorruption(e,t);return{slowStamina:i>=Ar,takeDamage:i>=Dr,spawnShadow:i>=Er}}isShadowWorld(){return this.shadowWorld}setShadowWorld(e){this.shadowWorld=e}getChunkCorruption(e,t){const i=this.chunks.get(me.key(e,t));if(!i)return 0;let s=0;for(let a=0;a<i.length;a++)s+=i[a];return s/i.length}getCorruptedChunks(){const e=[];for(const[t,i]of this.chunks)for(let s=0;s<i.length;s++)if(i[s]>0){e.push(t);break}return e}onCorruptionSpread(e){this.onCorruptionSpreadCallbacks.push(e)}curseRemaining=0;cursed=!1;applyCurse(e){this.curseRemaining=e,this.cursed=!0}tickCurse(e){this.cursed&&(this.curseRemaining-=e,this.curseRemaining<=0&&(this.curseRemaining=0,this.cursed=!1))}isCursed(){return this.cursed}getCurseRemaining(){return this.curseRemaining}getPlayerEffectsWithCurse(e,t){return this.cursed?{slowStamina:!0,takeDamage:!0,spawnShadow:!0}:this.getPlayerEffects(e,t)}serialize(){const e={};for(const[t,i]of this.chunks){let s=!1;for(let a=0;a<i.length;a++)if(i[a]>0){s=!0;break}s&&(e[t]=Array.from(i))}return{chunks:e,shadowWorld:this.shadowWorld}}deserialize(e){if(this.chunks.clear(),this.shadowWorld=e.shadowWorld??!1,e.chunks)for(const[t,i]of Object.entries(e.chunks)){const s=new Float32Array(I*I);for(let a=0;a<i.length&&a<s.length;a++)s[a]=i[a];this.chunks.set(t,s)}}}const Vi=[{id:"darkness",name:"Darkness",severity:"minor",description:"Reduced vision radius  enemies lurk just outside sight.",effects:{playerVisionMult:.5},visualEffect:"fog_overlay",minFloor:1},{id:"haste",name:"Haste",severity:"minor",description:"Enemies move 20% faster.",effects:{enemySpeedMult:1.2},visualEffect:"speed_trails",minFloor:1},{id:"armored",name:"Armored",severity:"minor",description:"Enemies have 30% more defense.",effects:{enemyDefenseMult:1.3},visualEffect:"shield_glow",minFloor:2},{id:"thorns",name:"Thorns",severity:"minor",description:"Enemies reflect 5% of damage taken back to the attacker.",effects:{specialMechanic:"damage_reflect_5"},visualEffect:"thorn_aura",minFloor:3},{id:"regen",name:"Regenerating",severity:"minor",description:"Enemies regenerate 1% HP every 5 seconds.",effects:{specialMechanic:"enemy_regen_1_5"},visualEffect:"heal_pulse",minFloor:3},{id:"swarm",name:"Swarm",severity:"minor",description:"50% more enemies, but each has 30% less HP.",effects:{enemyCountMult:1.5,enemyHpMult:.7},visualEffect:"swarm_particles",minFloor:2},{id:"labyrinth",name:"Labyrinth",severity:"minor",description:"More rooms and dead ends. Good luck finding the exit.",effects:{specialMechanic:"extra_rooms_deadends"},visualEffect:"maze_overlay",minFloor:1},{id:"volcanic",name:"Volcanic",severity:"major",description:"Lava tiles randomly appear and deal damage.",effects:{environmentalDamage:15,environmentalInterval:3,specialMechanic:"lava_tiles_spawn"},visualEffect:"lava_cracks",minFloor:5},{id:"frozen",name:"Frozen",severity:"major",description:"Ice physics  slippery movement and frozen enemies shatter on death.",effects:{specialMechanic:"ice_physics",playerSpeedMult:.8},visualEffect:"frost_overlay",minFloor:5},{id:"toxic",name:"Toxic",severity:"major",description:"Poison fog patches deal damage over time.",effects:{environmentalDamage:8,environmentalInterval:2,specialMechanic:"poison_fog_patches"},visualEffect:"toxic_fog",minFloor:6},{id:"gravity_shift",name:"Gravity Shift",severity:"major",description:"Random gravity reversal zones pull you toward the ceiling.",effects:{specialMechanic:"gravity_zones"},visualEffect:"gravity_distortion",minFloor:8},{id:"mirror",name:"Mirror",severity:"major",description:"Enemies copy your equipped weapon abilities.",effects:{specialMechanic:"enemy_copy_abilities"},visualEffect:"mirror_shimmer",minFloor:10},{id:"nightfall",name:"Nightfall",severity:"major",description:"No minimap, limited light. Only a small circle of visibility.",effects:{playerVisionMult:.25,specialMechanic:"no_minimap"},visualEffect:"deep_darkness",minFloor:7},{id:"temporal",name:"Temporal",severity:"major",description:"Random speed zones  some speed you up, others slow you to a crawl.",effects:{specialMechanic:"time_zones"},visualEffect:"time_distortion",minFloor:8},{id:"void_rift",name:"Void Rift",severity:"extreme",description:"Random teleportation  portals whisk you to unknown locations on the floor.",effects:{specialMechanic:"random_teleport"},visualEffect:"void_portals",minFloor:15},{id:"corruption_surge",name:"Corruption Surge",severity:"extreme",description:"Corruption rapidly spreads from enemies  purify or be consumed.",effects:{specialMechanic:"rapid_corruption",environmentalDamage:10,environmentalInterval:2},visualEffect:"corruption_wave",minFloor:20},{id:"boss_rush",name:"Boss Rush",severity:"extreme",description:"A mini-boss spawns every 3 rooms instead of every 5 floors.",effects:{specialMechanic:"frequent_bosses"},visualEffect:"boss_aura",minFloor:15},{id:"permadeath",name:"Permadeath",severity:"extreme",description:"One life. No respawns. Death means starting over from the checkpoint.",effects:{specialMechanic:"no_respawn"},visualEffect:"death_aura",minFloor:25}];new Map(Vi.map(r=>[r.id,r]));const Ie=[{id:"darkness",name:"Darkness",description:"Reduced vision radius.",severity:"minor",statMultipliers:{enemyHp:1,enemyDmg:1,enemySpeed:1}},{id:"haste",name:"Haste",description:"Enemies move 20% faster.",severity:"minor",statMultipliers:{enemyHp:1,enemyDmg:1,enemySpeed:1.2}},{id:"armored",name:"Armored",description:"Enemies have 30% more HP.",severity:"minor",statMultipliers:{enemyHp:1.3,enemyDmg:1,enemySpeed:1}},{id:"thorns",name:"Thorns",description:"Enemies reflect damage back to attackers.",severity:"minor",statMultipliers:{enemyHp:1,enemyDmg:1.1,enemySpeed:1}},{id:"regen",name:"Regen",description:"Enemies regenerate health over time.",severity:"minor",statMultipliers:{enemyHp:1.15,enemyDmg:1,enemySpeed:1}},{id:"swarm",name:"Swarm",description:"50% more enemies with less HP each.",severity:"minor",statMultipliers:{enemyHp:.7,enemyDmg:1,enemySpeed:1}},{id:"labyrinth",name:"Labyrinth",description:"More rooms and dead ends.",severity:"minor",statMultipliers:{enemyHp:1,enemyDmg:1,enemySpeed:1}}],Xt=[{id:"volcanic",name:"Volcanic",description:"Lava tiles spawn and deal damage.",severity:"major",statMultipliers:{enemyHp:1.2,enemyDmg:1.2,enemySpeed:1}},{id:"frozen",name:"Frozen",description:"Ice physics and slower movement.",severity:"major",statMultipliers:{enemyHp:1,enemyDmg:1,enemySpeed:.8}},{id:"toxic",name:"Toxic",description:"Poison fog patches deal damage over time.",severity:"major",statMultipliers:{enemyHp:1.1,enemyDmg:1.15,enemySpeed:1}},{id:"gravity_shift",name:"Gravity Shift",description:"Random gravity reversal zones.",severity:"major",statMultipliers:{enemyHp:1,enemyDmg:1,enemySpeed:1.1}},{id:"mirror",name:"Mirror",description:"Enemies copy your weapon abilities.",severity:"major",statMultipliers:{enemyHp:1,enemyDmg:1.3,enemySpeed:1}},{id:"nightfall",name:"Nightfall",description:"No minimap, extremely limited visibility.",severity:"major",statMultipliers:{enemyHp:1,enemyDmg:1.1,enemySpeed:1.1}},{id:"temporal",name:"Temporal",description:"Random speed zones alter movement speed.",severity:"major",statMultipliers:{enemyHp:1,enemyDmg:1,enemySpeed:1.2}}],Ka=[{id:"void_rift",name:"Void Rift",description:"Random teleportation portals.",severity:"extreme",statMultipliers:{enemyHp:1.3,enemyDmg:1.3,enemySpeed:1.2}},{id:"corruption_surge",name:"Corruption Surge",description:"Corruption rapidly spreads from enemies.",severity:"extreme",statMultipliers:{enemyHp:1.5,enemyDmg:1.2,enemySpeed:1}},{id:"boss_rush",name:"Boss Rush",description:"Mini-bosses spawn far more frequently.",severity:"extreme",statMultipliers:{enemyHp:1.2,enemyDmg:1.5,enemySpeed:1.1}},{id:"permadeath",name:"Permadeath",description:"One life. Death resets to last checkpoint.",severity:"extreme",statMultipliers:{enemyHp:1,enemyDmg:1,enemySpeed:1}}],ol=[...Ie,...Xt,...Ka],$s=new Map(ol.map(r=>[r.id,r])),nl=5,_i=100;class ll{currentFloor=null;highestFloor=0;riftCrystals=0;checkpoint=0;riftInstabilities=new Map;riftCheckpoints=new Map;floorCompleteCallbacks=[];eliteWaveCallbacks=[];getScaling(e){return{hpMult:1+e*Br,dmgMult:1+e*Fr,speedMult:1+Math.floor(e/zr)*Hr}}rollModifiers(e){const t=[],i=a=>{const o=Vi.filter(n=>n.severity===a&&n.minFloor<=e);return o.length===0?null:o[Math.floor(Math.random()*o.length)].id},s=i("minor");if(s&&t.push(s),e>=5){const a=Math.min(.8,(e-4)*.05);if(Math.random()<a){const o=i("major");o&&t.push(o)}}if(e>=15){const a=Math.min(.5,(e-14)*.02);if(Math.random()<a){const o=i("extreme");o&&t.push(o)}}return t}generateFloor(e){const t=this.getScaling(e),i=this.rollModifiers(e);let s=t.hpMult,a=t.dmgMult,o=t.speedMult;for(const n of i){const l=Vi.find(c=>c.id===n);l&&(l.effects.enemyHpMult!==void 0&&(s*=l.effects.enemyHpMult),l.effects.enemyDamageMult!==void 0&&(a*=l.effects.enemyDamageMult),l.effects.enemySpeedMult!==void 0&&(o*=l.effects.enemySpeedMult))}return{floor:e,modifiers:i,enemyHpMult:s,enemyDmgMult:a,enemySpeedMult:o,instability:0,isMiniboss:e>0&&e%Or===0&&e%Is!==0,isBoss:e>0&&e%Is===0,isCheckpoint:e>0&&e%Lr===0}}startRift(){const e=this.checkpoint>0?this.checkpoint:1;this.currentFloor=this.generateFloor(e)}advanceFloor(){if(this.currentFloor){const t=this.currentFloor.floor;let i=1;this.currentFloor.isBoss?i+=5:this.currentFloor.isMiniboss&&(i+=2),this.addCrystals(i);for(const s of this.floorCompleteCallbacks)s(t,i)}const e=(this.currentFloor?.floor??0)+1;return this.currentFloor=this.generateFloor(e),e>this.highestFloor&&(this.highestFloor=e),this.currentFloor.isCheckpoint&&(this.checkpoint=e),this.currentFloor}getCurrentFloor(){return this.currentFloor}getHighestFloor(){return this.highestFloor}setCheckpoint(e){this.checkpoint=e}getCheckpoint(){return this.checkpoint}getRiftCrystals(){return this.riftCrystals}addCrystals(e){this.riftCrystals+=Math.max(0,e)}spendCrystals(e){return e<0||this.riftCrystals<e?!1:(this.riftCrystals-=e,!0)}updateInstability(e){if(!this.currentFloor)return;const t=.01*(1+this.currentFloor.floor*.005);this.currentFloor.instability=Math.min(1,this.currentFloor.instability+t*e)}isInstabilityFull(){return this.currentFloor!==null&&this.currentFloor.instability>=1}onFloorComplete(e){this.floorCompleteCallbacks.push(e)}onEliteWave(e){this.eliteWaveCallbacks.push(e)}getFloorModifiers(e){const t=[],i=e*2654435761>>>0,s=n=>((i+n*1013904223)*1664525+1013904223>>>0&2147483647)/2147483647,a=(n,l)=>{const c=Math.floor(s(l)*n.length);return n[c].id},o=(n,l)=>{const c=Ie.filter(h=>!n.includes(h.id));if(c.length===0)return Ie[0].id;const d=Math.floor(s(l)*c.length);return c[d].id};if(e>=1&&e<=5)t.push(a(Ie,0));else if(e>=6&&e<=10){const n=a(Ie,0);t.push(n),t.push(o([n],1))}else if(e>=11&&e<=20)t.push(a(Ie,0)),t.push(a(Xt,1));else if(e>=21&&e<=50){const n=a(Ie,0);t.push(n),t.push(o([n],1)),t.push(a(Xt,2))}else e>=51&&(t.push(a(Ie,0)),t.push(a(Xt,1)),t.push(a(Ka,2)));return t}getFloorModifierDef(e){return $s.get(e)??null}getFloorModifierMultipliers(e){const t=this.getFloorModifiers(e);let i=1,s=1,a=1;for(const o of t){const n=$s.get(o);n&&(i*=n.statMultipliers.enemyHp,s*=n.statMultipliers.enemyDmg,a*=n.statMultipliers.enemySpeed)}return{enemyHp:i,enemyDmg:s,enemySpeed:a}}getInstability(e){return this.riftInstabilities.get(e)??0}updateRiftInstability(e,t,i){const s=this.riftInstabilities.get(e)??0,a=nl*t,o=Math.min(_i,s+a*i);if(this.riftInstabilities.set(e,o),s<_i&&o>=_i)for(const n of this.eliteWaveCallbacks)n(e)}resetInstability(e){this.riftInstabilities.set(e,0)}addRiftCrystals(e){this.addCrystals(e)}spendRiftCrystals(e){return this.spendCrystals(e)}setRiftCheckpoint(e,t){t>0&&t%10===0&&this.riftCheckpoints.set(e,t)}getRiftCheckpoint(e){return this.riftCheckpoints.get(e)??0}serialize(){const e={};for(const[i,s]of this.riftInstabilities)e[i]={instability:s,checkpoint:this.riftCheckpoints.get(i)??0};const t={};for(const[i,s]of this.riftCheckpoints)t[i]=s;return{currentFloor:this.currentFloor?{...this.currentFloor}:null,highestFloor:this.highestFloor,riftCrystals:this.riftCrystals,checkpoint:this.checkpoint,riftInstances:e,riftCheckpoints:t}}deserialize(e){if(this.currentFloor=e.currentFloor?{...e.currentFloor}:null,this.highestFloor=e.highestFloor??0,this.riftCrystals=e.riftCrystals??0,this.checkpoint=e.checkpoint??0,this.riftInstabilities.clear(),this.riftCheckpoints.clear(),e.riftInstances)for(const[t,i]of Object.entries(e.riftInstances))this.riftInstabilities.set(t,i.instability??0),i.checkpoint>0&&this.riftCheckpoints.set(t,i.checkpoint);if(e.riftCheckpoints)for(const[t,i]of Object.entries(e.riftCheckpoints))this.riftCheckpoints.has(t)||this.riftCheckpoints.set(t,i)}}const cl=[{id:"haven_camp",name:"Haven Camp",biome:"haven",x:50,y:50,maxBuildings:20,gridWidth:10,gridHeight:10,description:"Your first settlement in the peaceful meadows of Haven."},{id:"forest_haven",name:"Forest Haven",biome:"rotwood",x:350,y:150,maxBuildings:18,gridWidth:9,gridHeight:9,description:"A clearing in the Rotwood, protected by ancient trees."},{id:"mountain_hold",name:"Mountain Hold",biome:"ashlands",x:650,y:300,maxBuildings:16,gridWidth:8,gridHeight:8,description:"A fortified position on a volcanic plateau."},{id:"desert_outpost",name:"Desert Outpost",biome:"bone_wastes",x:1200,y:500,maxBuildings:15,gridWidth:8,gridHeight:8,description:"An oasis in the Bone Wastes, sheltered from sandstorms."},{id:"snow_fortress",name:"Snow Fortress",biome:"haven",x:-100,y:-300,maxBuildings:14,gridWidth:7,gridHeight:7,description:"A frozen stronghold in the northern reaches."},{id:"coastal_port",name:"Coastal Port",biome:"drowned",x:900,y:800,maxBuildings:18,gridWidth:9,gridHeight:9,description:"A port town built on stilts above the acidic waters."},{id:"swamp_camp",name:"Swamp Camp",biome:"rotwood",x:400,y:-200,maxBuildings:12,gridWidth:6,gridHeight:6,description:"A makeshift camp in the marshes, surrounded by mist."},{id:"volcanic_forge",name:"Volcanic Forge",biome:"ashlands",x:700,y:100,maxBuildings:14,gridWidth:7,gridHeight:7,description:"Built around a natural lava forge, ideal for smelting."}],dl=[{id:"farm",name:"Farm",category:"production",maxTier:3,description:"Grows crops automatically.",tiers:[{cost:[{itemId:"wood",quantity:20},{itemId:"stone",quantity:10}],goldCost:100,buildTimeMinutes:10,production:{itemId:"wheat",quantity:2,intervalMinutes:30},capacity:1},{cost:[{itemId:"wood",quantity:50},{itemId:"iron_bar",quantity:5}],goldCost:500,buildTimeMinutes:30,production:{itemId:"wheat",quantity:5,intervalMinutes:25},capacity:2},{cost:[{itemId:"hardwood",quantity:30},{itemId:"gold_bar",quantity:3}],goldCost:2e3,buildTimeMinutes:60,production:{itemId:"wheat",quantity:10,intervalMinutes:20},capacity:3}]},{id:"mine",name:"Mine",category:"production",maxTier:3,description:"Extracts ore automatically.",tiers:[{cost:[{itemId:"wood",quantity:30},{itemId:"stone",quantity:30}],goldCost:200,buildTimeMinutes:15,production:{itemId:"copper_ore",quantity:2,intervalMinutes:40},capacity:1},{cost:[{itemId:"iron_bar",quantity:10},{itemId:"stone",quantity:50}],goldCost:800,buildTimeMinutes:40,production:{itemId:"iron_ore",quantity:3,intervalMinutes:35},capacity:2},{cost:[{itemId:"gold_bar",quantity:5},{itemId:"obsidian",quantity:10}],goldCost:3e3,buildTimeMinutes:90,production:{itemId:"gold_ore",quantity:2,intervalMinutes:30},capacity:3}]},{id:"lumber_mill",name:"Lumber Mill",category:"production",maxTier:3,description:"Produces wood automatically.",tiers:[{cost:[{itemId:"wood",quantity:40},{itemId:"stone",quantity:15}],goldCost:150,buildTimeMinutes:10,production:{itemId:"wood",quantity:3,intervalMinutes:25},capacity:1},{cost:[{itemId:"iron_bar",quantity:8},{itemId:"wood",quantity:60}],goldCost:600,buildTimeMinutes:30,production:{itemId:"hardwood",quantity:2,intervalMinutes:30},capacity:2},{cost:[{itemId:"gold_bar",quantity:3},{itemId:"hardwood",quantity:40}],goldCost:2500,buildTimeMinutes:60,production:{itemId:"hardwood",quantity:5,intervalMinutes:25},capacity:3}]},{id:"workshop",name:"Workshop",category:"production",maxTier:3,description:"Crafts basic items automatically.",tiers:[{cost:[{itemId:"wood",quantity:25},{itemId:"stone",quantity:20}],goldCost:200,buildTimeMinutes:15,capacity:1},{cost:[{itemId:"iron_bar",quantity:10},{itemId:"wood",quantity:40}],goldCost:800,buildTimeMinutes:40,capacity:2},{cost:[{itemId:"gold_bar",quantity:5},{itemId:"hardwood",quantity:30}],goldCost:3e3,buildTimeMinutes:90,capacity:3}]},{id:"forge",name:"Forge",category:"production",maxTier:3,description:"Smelts ore and forges equipment.",tiers:[{cost:[{itemId:"stone",quantity:40},{itemId:"copper_ore",quantity:10}],goldCost:300,buildTimeMinutes:20,capacity:1},{cost:[{itemId:"iron_bar",quantity:15},{itemId:"fire_crystal",quantity:3}],goldCost:1200,buildTimeMinutes:50,capacity:2},{cost:[{itemId:"obsidian",quantity:20},{itemId:"magma_iron",quantity:10}],goldCost:5e3,buildTimeMinutes:120,capacity:3}]},{id:"alchemy_lab",name:"Alchemy Lab",category:"production",maxTier:3,description:"Brews potions and elixirs.",tiers:[{cost:[{itemId:"wood",quantity:20},{itemId:"stone",quantity:25}],goldCost:250,buildTimeMinutes:15,capacity:1},{cost:[{itemId:"iron_bar",quantity:8},{itemId:"crystal",quantity:5}],goldCost:1e3,buildTimeMinutes:45,capacity:2},{cost:[{itemId:"void_essence",quantity:5},{itemId:"gold_bar",quantity:8}],goldCost:4e3,buildTimeMinutes:100,capacity:3}]},{id:"kitchen",name:"Kitchen",category:"production",maxTier:3,description:"Cooks food automatically.",tiers:[{cost:[{itemId:"wood",quantity:30},{itemId:"stone",quantity:15}],goldCost:150,buildTimeMinutes:10,capacity:1},{cost:[{itemId:"iron_bar",quantity:5},{itemId:"wood",quantity:40}],goldCost:600,buildTimeMinutes:30,capacity:2},{cost:[{itemId:"gold_bar",quantity:3},{itemId:"hardwood",quantity:20}],goldCost:2e3,buildTimeMinutes:60,capacity:3}]},{id:"fishing_dock",name:"Fishing Dock",category:"production",maxTier:3,description:"Catches fish automatically.",tiers:[{cost:[{itemId:"wood",quantity:35},{itemId:"fiber",quantity:20}],goldCost:200,buildTimeMinutes:12,production:{itemId:"raw_fish",quantity:1,intervalMinutes:20},capacity:1},{cost:[{itemId:"hardwood",quantity:20},{itemId:"iron_bar",quantity:5}],goldCost:700,buildTimeMinutes:35,production:{itemId:"raw_fish",quantity:3,intervalMinutes:18},capacity:2},{cost:[{itemId:"hardwood",quantity:40},{itemId:"gold_bar",quantity:3}],goldCost:2500,buildTimeMinutes:70,production:{itemId:"raw_fish",quantity:5,intervalMinutes:15},capacity:3}]},{id:"wall",name:"Wall",category:"defense",maxTier:3,description:"Perimeter defense.",tiers:[{cost:[{itemId:"wood",quantity:15}],goldCost:50,buildTimeMinutes:5,defense:10},{cost:[{itemId:"stone",quantity:30}],goldCost:200,buildTimeMinutes:15,defense:30},{cost:[{itemId:"iron_bar",quantity:10}],goldCost:800,buildTimeMinutes:30,defense:60}]},{id:"guard_tower",name:"Guard Tower",category:"defense",maxTier:3,description:"Ranged defense position.",tiers:[{cost:[{itemId:"wood",quantity:25},{itemId:"stone",quantity:15}],goldCost:150,buildTimeMinutes:10,defense:20,capacity:1},{cost:[{itemId:"stone",quantity:40},{itemId:"iron_bar",quantity:5}],goldCost:500,buildTimeMinutes:25,defense:50,capacity:2},{cost:[{itemId:"iron_bar",quantity:15},{itemId:"gold_bar",quantity:2}],goldCost:1500,buildTimeMinutes:50,defense:100,capacity:3}]},{id:"ballista",name:"Ballista",category:"defense",maxTier:3,description:"Heavy siege defense weapon.",tiers:[{cost:[{itemId:"wood",quantity:40},{itemId:"iron_bar",quantity:8}],goldCost:400,buildTimeMinutes:20,defense:40},{cost:[{itemId:"iron_bar",quantity:20},{itemId:"hardwood",quantity:30}],goldCost:1200,buildTimeMinutes:45,defense:80},{cost:[{itemId:"obsidian",quantity:15},{itemId:"gold_bar",quantity:5}],goldCost:4e3,buildTimeMinutes:90,defense:150}]},{id:"barracks",name:"Barracks",category:"defense",maxTier:3,description:"Houses garrison soldiers.",tiers:[{cost:[{itemId:"wood",quantity:30},{itemId:"stone",quantity:20}],goldCost:200,buildTimeMinutes:15,defense:15,capacity:2},{cost:[{itemId:"stone",quantity:50},{itemId:"iron_bar",quantity:10}],goldCost:800,buildTimeMinutes:40,defense:35,capacity:4},{cost:[{itemId:"iron_bar",quantity:20},{itemId:"gold_bar",quantity:5}],goldCost:3e3,buildTimeMinutes:80,defense:70,capacity:8}]},{id:"town_hall",name:"Town Hall",category:"civic",maxTier:3,description:"Settlement center. Required for all other buildings.",tiers:[{cost:[{itemId:"wood",quantity:50},{itemId:"stone",quantity:30}],goldCost:500,buildTimeMinutes:30,capacity:5},{cost:[{itemId:"hardwood",quantity:40},{itemId:"iron_bar",quantity:15}],goldCost:2e3,buildTimeMinutes:60,capacity:10},{cost:[{itemId:"gold_bar",quantity:10},{itemId:"obsidian",quantity:20}],goldCost:8e3,buildTimeMinutes:120,capacity:20}]},{id:"market",name:"Market",category:"civic",maxTier:3,description:"Trade goods between settlements.",tiers:[{cost:[{itemId:"wood",quantity:35},{itemId:"stone",quantity:20}],goldCost:300,buildTimeMinutes:15},{cost:[{itemId:"hardwood",quantity:25},{itemId:"iron_bar",quantity:8}],goldCost:1e3,buildTimeMinutes:40},{cost:[{itemId:"gold_bar",quantity:5},{itemId:"hardwood",quantity:40}],goldCost:4e3,buildTimeMinutes:80}]},{id:"inn",name:"Inn",category:"civic",maxTier:3,description:"Rest point and NPC happiness boost.",tiers:[{cost:[{itemId:"wood",quantity:30},{itemId:"fiber",quantity:15}],goldCost:200,buildTimeMinutes:12},{cost:[{itemId:"hardwood",quantity:20},{itemId:"iron_bar",quantity:5}],goldCost:700,buildTimeMinutes:30},{cost:[{itemId:"gold_bar",quantity:3},{itemId:"hardwood",quantity:30}],goldCost:2500,buildTimeMinutes:60}]},{id:"library",name:"Library",category:"civic",maxTier:3,description:"Boosts XP gain for all settlers.",tiers:[{cost:[{itemId:"wood",quantity:25},{itemId:"stone",quantity:25}],goldCost:300,buildTimeMinutes:15},{cost:[{itemId:"hardwood",quantity:30},{itemId:"iron_bar",quantity:8}],goldCost:1200,buildTimeMinutes:40},{cost:[{itemId:"gold_bar",quantity:8},{itemId:"echo_crystal",quantity:3}],goldCost:5e3,buildTimeMinutes:90}]},{id:"temple",name:"Temple",category:"civic",maxTier:3,description:"Provides purification and corruption resistance.",tiers:[{cost:[{itemId:"stone",quantity:40},{itemId:"wood",quantity:20}],goldCost:400,buildTimeMinutes:20},{cost:[{itemId:"stone",quantity:80},{itemId:"gold_bar",quantity:3}],goldCost:1500,buildTimeMinutes:50},{cost:[{itemId:"void_essence",quantity:5},{itemId:"gold_bar",quantity:10}],goldCost:6e3,buildTimeMinutes:120}]},{id:"warehouse",name:"Warehouse",category:"civic",maxTier:3,description:"Stores surplus resources.",tiers:[{cost:[{itemId:"wood",quantity:40},{itemId:"stone",quantity:10}],goldCost:100,buildTimeMinutes:8,capacity:100},{cost:[{itemId:"hardwood",quantity:30},{itemId:"iron_bar",quantity:5}],goldCost:400,buildTimeMinutes:20,capacity:300},{cost:[{itemId:"iron_bar",quantity:15},{itemId:"hardwood",quantity:50}],goldCost:1500,buildTimeMinutes:50,capacity:800}]}],wi=new Map(cl.map(r=>[r.id,r])),xe=new Map(dl.map(r=>[r.id,r])),vi={production:["farm","mine","lumber_mill","workshop","forge","alchemy_lab","kitchen","fishing_dock"],defense:["wall","guard_tower","ballista","barracks"],civic:["town_hall","market","inn","library","temple","warehouse"]},oi={farm:[{resources:{wood:20,stone:10},gold:100,buildTimeMinutes:10},{resources:{wood:50,iron_bar:5},gold:500,buildTimeMinutes:30},{resources:{hardwood:30,gold_bar:3},gold:2e3,buildTimeMinutes:60}],mine:[{resources:{wood:30,stone:30},gold:200,buildTimeMinutes:15},{resources:{iron_bar:10,stone:50},gold:800,buildTimeMinutes:40},{resources:{gold_bar:5,obsidian:10},gold:3e3,buildTimeMinutes:90}],lumber_mill:[{resources:{wood:40,stone:15},gold:150,buildTimeMinutes:10},{resources:{iron_bar:8,wood:60},gold:600,buildTimeMinutes:30},{resources:{gold_bar:3,hardwood:40},gold:2500,buildTimeMinutes:60}],workshop:[{resources:{wood:25,stone:20},gold:200,buildTimeMinutes:15},{resources:{iron_bar:10,wood:40},gold:800,buildTimeMinutes:40},{resources:{gold_bar:5,hardwood:30},gold:3e3,buildTimeMinutes:90}],forge:[{resources:{stone:40,copper_ore:10},gold:300,buildTimeMinutes:20},{resources:{iron_bar:15,fire_crystal:3},gold:1200,buildTimeMinutes:50},{resources:{obsidian:20,magma_iron:10},gold:5e3,buildTimeMinutes:120}],alchemy_lab:[{resources:{wood:20,stone:25},gold:250,buildTimeMinutes:15},{resources:{iron_bar:8,crystal:5},gold:1e3,buildTimeMinutes:45},{resources:{void_essence:5,gold_bar:8},gold:4e3,buildTimeMinutes:100}],kitchen:[{resources:{wood:30,stone:15},gold:150,buildTimeMinutes:10},{resources:{iron_bar:5,wood:40},gold:600,buildTimeMinutes:30},{resources:{gold_bar:3,hardwood:20},gold:2e3,buildTimeMinutes:60}],fishing_dock:[{resources:{wood:35,fiber:20},gold:200,buildTimeMinutes:12},{resources:{hardwood:20,iron_bar:5},gold:700,buildTimeMinutes:35},{resources:{hardwood:40,gold_bar:3},gold:2500,buildTimeMinutes:70}],wall:[{resources:{wood:15},gold:50,buildTimeMinutes:5},{resources:{stone:30},gold:200,buildTimeMinutes:15},{resources:{iron_bar:10},gold:800,buildTimeMinutes:30}],guard_tower:[{resources:{wood:25,stone:15},gold:150,buildTimeMinutes:10},{resources:{stone:40,iron_bar:5},gold:500,buildTimeMinutes:25},{resources:{iron_bar:15,gold_bar:2},gold:1500,buildTimeMinutes:50}],ballista:[{resources:{wood:40,iron_bar:8},gold:400,buildTimeMinutes:20},{resources:{iron_bar:20,hardwood:30},gold:1200,buildTimeMinutes:45},{resources:{obsidian:15,gold_bar:5},gold:4e3,buildTimeMinutes:90}],barracks:[{resources:{wood:30,stone:20},gold:200,buildTimeMinutes:15},{resources:{stone:50,iron_bar:10},gold:800,buildTimeMinutes:40},{resources:{iron_bar:20,gold_bar:5},gold:3e3,buildTimeMinutes:80}],town_hall:[{resources:{wood:50,stone:30},gold:500,buildTimeMinutes:30},{resources:{hardwood:40,iron_bar:15},gold:2e3,buildTimeMinutes:60},{resources:{gold_bar:10,obsidian:20},gold:8e3,buildTimeMinutes:120}],market:[{resources:{wood:35,stone:20},gold:300,buildTimeMinutes:15},{resources:{hardwood:25,iron_bar:8},gold:1e3,buildTimeMinutes:40},{resources:{gold_bar:5,hardwood:40},gold:4e3,buildTimeMinutes:80}],inn:[{resources:{wood:30,fiber:15},gold:200,buildTimeMinutes:12},{resources:{hardwood:20,iron_bar:5},gold:700,buildTimeMinutes:30},{resources:{gold_bar:3,hardwood:30},gold:2500,buildTimeMinutes:60}],library:[{resources:{wood:25,stone:25},gold:300,buildTimeMinutes:15},{resources:{hardwood:30,iron_bar:8},gold:1200,buildTimeMinutes:40},{resources:{gold_bar:8,echo_crystal:3},gold:5e3,buildTimeMinutes:90}],temple:[{resources:{stone:40,wood:20},gold:400,buildTimeMinutes:20},{resources:{stone:80,gold_bar:3},gold:1500,buildTimeMinutes:50},{resources:{void_essence:5,gold_bar:10},gold:6e3,buildTimeMinutes:120}],warehouse:[{resources:{wood:40,stone:10},gold:100,buildTimeMinutes:8},{resources:{hardwood:30,iron_bar:5},gold:400,buildTimeMinutes:20},{resources:{iron_bar:15,hardwood:50},gold:1500,buildTimeMinutes:50}]},hl=[{min:1,max:3,label:"Camp"},{min:4,max:7,label:"Village"},{min:8,max:12,label:"Town"},{min:13,max:16,label:"City"},{min:17,max:18,label:"Capital"}];class ul{settlements=new Map;raidCallbacks=[];buildingCompleteCallbacks=[];foundSettlement(e,t){if(this.settlements.size>=qr||!wi.get(e))return!1;for(const o of this.settlements.values())if(o.siteId===e)return!1;const s=`settlement_${e}_${Date.now()}`,a={id:s,siteId:e,name:t,tier:0,buildings:[],assignedNpcs:[],morale:50,resources:{},lastRaidTime:0,recruitedNpcs:[],tradeRoutes:[],availableWorkers:5,corruptionProximity:0};return this.settlements.set(s,a),!0}placeBuilding(e,t,i,s){const a=this.settlements.get(e);if(!a)return!1;const o=wi.get(a.siteId);if(!o)return!1;const n=xe.get(t);if(!n||a.buildings.length>=o.maxBuildings||i<0||i>=o.gridWidth||s<0||s>=o.gridHeight||a.buildings.some(d=>d.position.x===i&&d.position.y===s))return!1;const c=n.tiers[0];return!c||!this.hasResources(a,c.cost,c.goldCost)?!1:(this.deductResources(a,c.cost,c.goldCost),a.buildings.push({typeId:t,tier:0,position:{x:i,y:s},assignedNpcId:null,buildTimeRemaining:c.buildTimeMinutes,workersAssigned:0,productionRate:1}),!0)}upgradeBuilding(e,t){const i=this.settlements.get(e);if(!i)return!1;const s=i.buildings[t];if(!s)return!1;const a=xe.get(s.typeId);if(!a)return!1;const o=s.tier+1;if(o>=a.maxTier||s.buildTimeRemaining>0)return!1;const n=a.tiers[o];return!n||!this.hasResources(i,n.cost,n.goldCost)?!1:(this.deductResources(i,n.cost,n.goldCost),s.tier=o,s.buildTimeRemaining=n.buildTimeMinutes,!0)}assignNPC(e,t,i){const s=this.settlements.get(e);if(!s)return!1;const a=s.buildings[i];if(!a)return!1;const o=xe.get(a.typeId);if(!o)return!1;const n=o.tiers[a.tier];return!n||n.capacity===void 0||n.capacity<=0||s.assignedNpcs.includes(t)||a.assignedNpcId!==null?!1:(a.assignedNpcId=t,s.assignedNpcs.push(t),!0)}unassignNPC(e,t){const i=this.settlements.get(e);if(!i)return;for(const a of i.buildings)if(a.assignedNpcId===t){a.assignedNpcId=null;break}const s=i.assignedNpcs.indexOf(t);s>=0&&i.assignedNpcs.splice(s,1)}advanceDay(e){const t=this.settlements.get(e);if(!t)return;const i=24;for(let s=0;s<t.buildings.length;s++){const a=t.buildings[s];if(a.buildTimeRemaining>0&&(a.buildTimeRemaining=Math.max(0,a.buildTimeRemaining-i),a.buildTimeRemaining===0))for(const o of this.buildingCompleteCallbacks)o(e,s)}for(const s of t.buildings){if(s.buildTimeRemaining>0)continue;const a=xe.get(s.typeId);if(!a)continue;const o=a.tiers[s.tier];if(!o||!o.production)continue;const n=o.production,l=Math.max(1,Math.floor(n.quantity*(i/n.intervalMinutes))),c=s.assignedNpcId?1.5:1,d=Math.floor(l*c),h=t.resources[n.itemId]??0;t.resources[n.itemId]=h+d}t.morale=this.calculateMorale(t),t.tier>=1}calculateMorale(e){let t=50;for(const i of e.buildings){if(i.buildTimeRemaining>0)continue;const s=xe.get(i.typeId);s&&s.category==="civic"&&(t+=5),s&&s.category==="production"&&(t+=2)}return t+=e.assignedNpcs.length*3,t-=e.tier*5,Math.max(0,Math.min(100,t))}canUpgradeTier(e){const t=this.settlements.get(e);if(!t||t.tier>=mi.length-1)return!1;const i=(t.tier+1)*3;return!(t.buildings.filter(a=>a.buildTimeRemaining<=0).length<i||t.morale<40)}upgradeTier(e){if(!this.canUpgradeTier(e))return!1;const t=this.settlements.get(e);return t.tier++,!0}getSettlement(e){return this.settlements.get(e)??null}getAllSettlements(){return Array.from(this.settlements.values())}getSettlementTierName(e){return e<0||e>=mi.length?"Unknown":mi[e]}getProductionOutput(e){const t=this.settlements.get(e);if(!t)return[];const i=new Map,s=24;for(const a of t.buildings){if(a.buildTimeRemaining>0)continue;const o=xe.get(a.typeId);if(!o)continue;const n=o.tiers[a.tier];if(!n||!n.production)continue;const l=n.production,c=Math.max(1,Math.floor(l.quantity*(s/l.intervalMinutes))),d=a.assignedNpcId?1.5:1,h=Math.floor(c*d),u=i.get(l.itemId)??0;i.set(l.itemId,u+h)}return Array.from(i.entries()).map(([a,o])=>({itemId:a,quantity:o}))}getDefenseRating(e){const t=this.settlements.get(e);if(!t)return 0;let i=0;for(const s of t.buildings){if(s.buildTimeRemaining>0)continue;const a=xe.get(s.typeId);if(!a)continue;const o=a.tiers[s.tier];o&&o.defense&&(i+=o.defense)}return i}triggerRaid(e,t){if(this.settlements.get(e))for(const s of this.raidCallbacks)s(e,t)}onRaid(e){this.raidCallbacks.push(e)}onBuildingComplete(e){this.buildingCompleteCallbacks.push(e)}buildBuilding(e,t){const i=this.settlements.get(e);if(!i)return!1;const s=wi.get(i.siteId);if(!s)return!1;const a=oi[t];if(!a||a.length===0||i.buildings.length>=s.maxBuildings)return!1;const o=a[0],n=Object.entries(o.resources).map(([h,u])=>({itemId:h,quantity:u}));if(!this.hasResources(i,n,o.gold))return!1;let l=!1,c=0,d=0;for(let h=0;h<s.gridHeight&&!l;h++)for(let u=0;u<s.gridWidth&&!l;u++)i.buildings.some(g=>g.position.x===u&&g.position.y===h)||(c=u,d=h,l=!0);return l?(this.deductResources(i,n,o.gold),i.buildings.push({typeId:t,tier:1,position:{x:c,y:d},assignedNpcId:null,buildTimeRemaining:o.buildTimeMinutes,workersAssigned:0,productionRate:1}),!0):!1}upgradeBuildingExpanded(e,t){const i=this.settlements.get(e);if(!i)return!1;const s=i.buildings[t];if(!s||s.buildTimeRemaining>0||s.tier>=3)return!1;const a=oi[s.typeId];if(!a)return!1;const o=a[s.tier];if(!o)return!1;const n=Object.entries(o.resources).map(([l,c])=>({itemId:l,quantity:c}));return this.hasResources(i,n,o.gold)?(this.deductResources(i,n,o.gold),s.tier++,s.buildTimeRemaining=o.buildTimeMinutes,!0):!1}assignWorker(e,t){const i=this.settlements.get(e);if(!i)return!1;const s=i.buildings[t];return!s||i.availableWorkers<=0||s.workersAssigned>=s.tier?!1:(i.availableWorkers--,s.workersAssigned++,s.productionRate=1+s.workersAssigned*.1,!0)}removeWorker(e,t){const i=this.settlements.get(e);if(!i)return!1;const s=i.buildings[t];return!s||s.workersAssigned<=0?!1:(s.workersAssigned--,i.availableWorkers++,s.productionRate=1+s.workersAssigned*.1,!0)}getProduction(e){const t=this.settlements.get(e);if(!t)return{};const i={},s=24;for(const a of t.buildings){if(a.buildTimeRemaining>0)continue;const o=xe.get(a.typeId);if(!o)continue;const n=Math.min(a.tier,o.tiers.length-1),l=o.tiers[n];if(!l||!l.production)continue;const c=l.production,d=Math.max(1,Math.floor(c.quantity*(s/c.intervalMinutes))),h=a.assignedNpcId?1.5:1,u=Math.floor(d*h*a.productionRate),m=i[c.itemId]??0;i[c.itemId]=m+u}return i}getSettlementTier(e){const t=this.settlements.get(e);if(!t)return"Camp";const i=t.buildings.filter(s=>s.buildTimeRemaining<=0).length;for(const s of hl)if(i>=s.min&&i<=s.max)return s.label;return i===0?"Camp":"Capital"}recruitNPC(e,t){const i=this.settlements.get(e);return!i||i.recruitedNpcs.includes(t)?!1:(i.recruitedNpcs.push(t),!0)}getRecruitedNPCs(e){const t=this.settlements.get(e);return t?[...t.recruitedNpcs]:[]}getMorale(e){const t=this.settlements.get(e);if(!t)return 0;let i=50;const s=new Set;let a=!1;for(const n of t.buildings){if(n.buildTimeRemaining>0)continue;const l=xe.get(n.typeId);l&&(s.add(n.typeId),l.category==="civic"&&(i+=5),l.category==="production"&&(i+=2),l.category==="defense"&&(i+=3),(n.typeId==="farm"||n.typeId==="kitchen"||n.typeId==="fishing_dock")&&(a=!0))}i+=t.assignedNpcs.length*3,i+=s.size*2,a&&(i+=5);const o=this.getDefenseRating(e);return o>0&&(i+=Math.min(10,Math.floor(o/10))),i-=t.tier*5,i-=Math.floor(t.corruptionProximity*20),Math.max(0,Math.min(100,i))}setCorruptionProximity(e,t){const i=this.settlements.get(e);i&&(i.corruptionProximity=Math.max(0,Math.min(1,t)))}triggerRaidExpanded(e,t){const i=this.settlements.get(e);if(!i)return{success:!1,defenseRating:0,raidPower:t,damageDealt:0,buildingsDestroyed:0,moraleChange:0};const s=this.getDefenseRating(e),a=s>=t;let o=0,n=0,l=0;if(a)l=10;else{const c=t-s;if(o=c,n=Math.min(3,Math.floor(c/50)),n>0){const h=i.buildings.map((u,m)=>({building:u,index:m})).filter(u=>u.building.buildTimeRemaining<=0).sort((u,m)=>u.building.tier-m.building.tier).slice(0,n).map(u=>u.index);h.sort((u,m)=>m-u);for(const u of h){const m=i.buildings[u];m.assignedNpcId&&this.unassignNPC(e,m.assignedNpcId),i.buildings.splice(u,1)}}l=-(10+n*5)}i.morale=Math.max(0,Math.min(100,i.morale+l));for(const c of this.raidCallbacks)c(e,t);return{success:a,defenseRating:s,raidPower:t,damageDealt:o,buildingsDestroyed:n,moraleChange:l}}establishTradeRoute(e,t){const i=this.settlements.get(e),s=this.settlements.get(t);if(!i||!s||e===t||i.tradeRoutes.includes(t))return!1;const a=i.buildings.some(n=>n.typeId==="market"&&n.buildTimeRemaining<=0),o=s.buildings.some(n=>n.typeId==="market"&&n.buildTimeRemaining<=0);return!a||!o?!1:(i.tradeRoutes.push(t),s.tradeRoutes.push(e),!0)}removeTradeRoute(e,t){const i=this.settlements.get(e),s=this.settlements.get(t);if(!i||!s)return!1;const a=i.tradeRoutes.indexOf(t),o=s.tradeRoutes.indexOf(e);return a<0?!1:(i.tradeRoutes.splice(a,1),o>=0&&s.tradeRoutes.splice(o,1),!0)}getTradeRoutes(e){const t=this.settlements.get(e);return t?[...t.tradeRoutes]:[]}getAllTradeRoutes(){const e=new Set,t=[];for(const i of this.settlements.values())for(const s of i.tradeRoutes){const a=[i.id,s].sort().join("|");e.has(a)||(e.add(a),t.push({fromId:i.id,toId:s}))}return t}hasResources(e,t,i){for(const a of t)if((e.resources[a.itemId]??0)<a.quantity)return!1;return!((e.resources.gold??0)<i)}deductResources(e,t,i){for(const a of t){const o=e.resources[a.itemId]??0;e.resources[a.itemId]=o-a.quantity}const s=e.resources.gold??0;e.resources.gold=s-i}serialize(){const e=[];for(const t of this.settlements.values())e.push({...t,buildings:t.buildings.map(i=>({...i,position:{...i.position},workersAssigned:i.workersAssigned??0,productionRate:i.productionRate??1})),assignedNpcs:[...t.assignedNpcs],resources:{...t.resources},recruitedNpcs:[...t.recruitedNpcs??[]],tradeRoutes:[...t.tradeRoutes??[]],availableWorkers:t.availableWorkers??5,corruptionProximity:t.corruptionProximity??0});return{settlements:e}}deserialize(e){if(this.settlements.clear(),e.settlements)for(const t of e.settlements)this.settlements.set(t.id,{...t,buildings:t.buildings.map(i=>({...i,position:{...i.position},workersAssigned:i.workersAssigned??0,productionRate:i.productionRate??1})),assignedNpcs:[...t.assignedNpcs],resources:{...t.resources},recruitedNpcs:[...t.recruitedNpcs??[]],tradeRoutes:[...t.tradeRoutes??[]],availableWorkers:t.availableWorkers??5,corruptionProximity:t.corruptionProximity??0})}}const Oe=[{id:"rotwood_cult",name:"Rotwood Cult",biome:"rotwood",description:'Fungal druids who worship the corruption as a gift. They spread spores and poison to "enlighten" the world.',color:4500002,enemyTypes:["cult_druid","spore_warrior","fungal_beast","poison_archer"],tactics:["poison_cloud","spore_trap","fungal_minion_summon","terrain_corruption"],leaderId:"archdruid_mycelium",leaderName:"Archdruid Mycelium",territory:{centerX:350,centerY:200,radius:150},hostility:.6},{id:"ashlands_legion",name:"Ashlands Legion",biome:"ashlands",description:"Fire warriors who forge weapons in volcanic heat. They believe strength through fire purifies weakness.",color:16729088,enemyTypes:["legion_soldier","fire_mage","siege_engineer","flame_berserker"],tactics:["fire_barrage","siege_weapon","shield_wall","scorched_earth"],leaderId:"warlord_ignatius",leaderName:"Warlord Ignatius",territory:{centerX:650,centerY:400,radius:180},hostility:.7},{id:"drowned_court",name:"Drowned Court",biome:"drowned",description:"Aquatic sorcerers from sunken civilizations. They command tides and seek to flood the surface world.",color:35020,enemyTypes:["court_sorcerer","tide_guardian","water_elemental","siren"],tactics:["flooding","whirlpool_trap","water_barrier","siren_call"],leaderId:"queen_abyssia",leaderName:"Queen Abyssia",territory:{centerX:950,centerY:900,radius:160},hostility:.5},{id:"bone_covenant",name:"Bone Covenant",biome:"bone_wastes",description:"An undead army led by necromancers. They raise the bones of fallen titans to bolster their numbers endlessly.",color:13417352,enemyTypes:["skeleton_soldier","necromancer","bone_golem","death_knight"],tactics:["undead_swarm","necromancy_revive","bone_cage","death_curse"],leaderId:"lich_king_osteros",leaderName:"Lich King Osteros",territory:{centerX:1250,centerY:600,radius:200},hostility:.8},{id:"void_collective",name:"Void Collective",biome:"the_void",description:"Reality-bending elites who have merged with the void. Unpredictable and terrifyingly powerful.",color:8913100,enemyTypes:["void_acolyte","reality_bender","phase_assassin","void_titan"],tactics:["dimension_swap","reality_tear","phase_shift","mind_break"],leaderId:"the_architect",leaderName:"The Architect",territory:{centerX:1550,centerY:300,radius:170},hostility:.9}],Se=new Map(Oe.map(r=>[r.id,r]));class Re{influence=new Map;leaders=new Map;resistances=new Map;playerBehavior=new Map;factionEventCallbacks=[];constructor(){for(const e of Oe)this.leaders.set(e.id,{alive:!0,respawnTimer:0})}static chunkKey(e,t){return`${e},${t}`}static parseChunkKey(e){const[t,i]=e.split(",").map(Number);return{cx:t,cy:i}}ensureFaction(e){let t=this.influence.get(e);return t||(t=new Map,this.influence.set(e,t)),t}getInfluence(e,t,i){const s=this.influence.get(e);return s?s.get(Re.chunkKey(t,i))??0:0}setInfluence(e,t,i,s){const a=this.ensureFaction(e),o=Re.chunkKey(t,i),n=Math.max(0,Math.min(100,s));n<=0?a.delete(o):a.set(o,n)}getDominantFaction(e,t){let i=null,s=0;for(const[a,o]of this.influence){const n=o.get(Re.chunkKey(e,t))??0;n>s&&(s=n,i=a)}return i}expandTerritory(e){const t=this.leaders.get(e);if(!t||!t.alive)return;const i=this.influence.get(e);if(!i)return;const s=new Map;for(const[a,o]of i){if(o<20)continue;const{cx:n,cy:l}=Re.parseChunkKey(a),c=[[n-1,l],[n+1,l],[n,l-1],[n,l+1]];for(const[d,h]of c){const u=Re.chunkKey(d,h),m=i.get(u)??0;if(m<100){const g=Math.min(5,o*.1),y=s.get(u)??m;s.set(u,Math.min(100,y+g))}}}for(const[a,o]of s)i.set(a,o)}reduceInfluence(e,t,i,s){const a=this.influence.get(e);if(!a)return;const o=Re.chunkKey(t,i),n=a.get(o)??0,l=Math.max(0,n-s);l<=0?a.delete(o):a.set(o,l)}isLeaderAlive(e){return this.leaders.get(e)?.alive??!1}killLeader(e){const t=this.leaders.get(e);!t||!t.alive||(t.alive=!1,t.respawnTimer=14,this.emitEvent({type:"leader_killed",factionId:e,details:`The leader of ${Se.get(e)?.name??e} has been slain!`}))}respawnLeader(e){const t=this.leaders.get(e);t&&(t.alive=!0,t.respawnTimer=0,this.emitEvent({type:"leader_respawn",factionId:e,details:`The leader of ${Se.get(e)?.name??e} has returned!`}))}getActiveFactions(){const e=[];for(const[t,i]of this.influence)i.size>0&&e.push(t);return e}getTerritoryCount(e){const t=this.influence.get(e);if(!t)return 0;let i=0;for(const s of t.values())s>50&&i++;return i}advanceWeek(){for(const[t,i]of this.leaders)!i.alive&&i.respawnTimer>0&&(i.respawnTimer=Math.max(0,i.respawnTimer-7),i.respawnTimer<=0&&this.respawnLeader(t));for(const t of Oe)this.expandTerritory(t.id);const e=new Set;for(const t of this.influence.values())for(const i of t.keys())e.add(i);for(const t of e){const i=[];for(const[a,o]of this.influence){const n=o.get(t);n!==void 0&&n>0&&i.push({factionId:a,value:n})}if(i.length<2)continue;i.sort((a,o)=>o.value-a.value);const s=i[0];for(let a=1;a<i.length;a++){const o=i[a],n=Math.min(o.value,(s.value-o.value)*.2),l=this.influence.get(o.factionId),c=o.value-n;c<=0?l.delete(t):l.set(t,c)}}}onFactionEvent(e){this.factionEventCallbacks.push(e)}emitEvent(e){for(const t of this.factionEventCallbacks)t(e)}setFactionInfluence(e,t,i){const s=this.ensureFaction(t),a=Math.max(0,Math.min(100,i));a<=0?s.delete(e):s.set(e,a)}getFactionInfluence(e){const t={};for(const[i,s]of this.influence){const a=s.get(e);a!==void 0&&a>0&&(t[i]=a)}return t}getDominantFactionByKey(e){let t=null,i=0;for(const[s,a]of this.influence){const o=a.get(e)??0;o>i&&(i=o,t=s)}return t}recordPlayerBehavior(e){const t=this.playerBehavior.get(e)??0;this.playerBehavior.set(e,t+1)}updateFactionResistances(){let e=0;for(const t of this.playerBehavior.values())e+=t;if(e!==0)for(const[t,i]of this.playerBehavior){const s=i/e;if(s<.3)continue;const a=Math.min(.05,s*.1);for(const o of Oe){const n=this.ensureResistances(o.id),l=n.get(t)??0;n.set(t,Math.min(1,l+a))}}}getFactionResistance(e,t){const i=this.resistances.get(e);return i?i.get(t)??0:0}getAllFactionResistances(e){const t=this.resistances.get(e);if(!t)return{};const i={};for(const[s,a]of t)i[s]=a;return i}ensureResistances(e){let t=this.resistances.get(e);return t||(t=new Map,this.resistances.set(e,t)),t}simulateFactionConflict(e,t){const i=this.calculateFactionPower(e),s=this.calculateFactionPower(t),a=i*(.8+Math.random()*.4),o=s*(.8+Math.random()*.4),n=a>=o?e:t,l=n===e?t:e,c=Math.floor(Math.abs(a-o)*.5)+5,d=this.influence.get(l),h=this.ensureFaction(n);if(d){const u=[];for(const m of d.keys())h.has(m)&&u.push(m);for(const m of u){const g=d.get(m)??0,y=h.get(m)??0,_=Math.max(0,g-c),w=Math.min(100,y+Math.floor(c*.5));_<=0?d.delete(m):d.set(m,_),h.set(m,w)}}return this.emitEvent({type:"faction_conflict",factionId:n,details:`${Se.get(n)?.name??n} defeated ${Se.get(l)?.name??l} in territorial conflict!`}),{winner:n,loser:l,influenceShift:c}}calculateFactionPower(e){let t=0;t+=this.getTerritoryCount(e)*10,this.isLeaderAlive(e)&&(t+=50);const i=this.influence.get(e);if(i)for(const s of i.values())t+=s*.1;return t}generateWeeklyEvent(){const e=this.getActiveFactions(),t=["push","war","siege"],i=t[Math.floor(Math.random()*t.length)];let s;if(e.length>=2&&(i==="war"||i==="siege")){const o=Math.floor(Math.random()*e.length);let n=Math.floor(Math.random()*(e.length-1));n>=o&&n++,s=[e[o],e[n]]}else e.length>=1?s=[e[Math.floor(Math.random()*e.length)]]:s=[Oe[0].id];let a="0,0";if(s.length>=2){const o=this.influence.get(s[0]),n=this.influence.get(s[1]);if(o&&n){for(const l of o.keys())if(n.has(l)){a=l;break}}}else{const o=this.influence.get(s[0]);if(o&&o.size>0){const n=Array.from(o.keys());a=n[Math.floor(Math.random()*n.length)]}}return this.emitEvent({type:`weekly_${i}`,factionId:s[0],details:`Weekly event: ${i} involving ${s.map(o=>Se.get(o)?.name??o).join(" vs ")} at ${a}`}),{type:i,factions:s,location:a}}getFactionLeader(e){const t=Se.get(e);if(!t)return null;const i=this.leaders.get(e);return i?{factionId:e,name:t.leaderName,alive:i.alive,respawnDaysRemaining:i.respawnTimer}:null}defeatFactionLeader(e){const t=this.leaders.get(e);return!t||!t.alive?!1:(t.alive=!1,t.respawnTimer=7,this.emitEvent({type:"leader_defeated",factionId:e,details:`${Se.get(e)?.leaderName??"The leader"} of ${Se.get(e)?.name??e} has been defeated! They will return in 7 days.`}),!0)}getAllFactionLeaders(){const e=[];for(const t of Oe){const i=this.getFactionLeader(t.id);i&&e.push(i)}return e}serialize(){const e={};for(const[a,o]of this.influence){const n={};for(const[l,c]of o)n[l]=c;e[a]=n}const t={};for(const[a,o]of this.leaders)t[a]={...o};const i={};for(const[a,o]of this.resistances){const n={};for(const[l,c]of o)n[l]=c;i[a]=n}const s={};for(const[a,o]of this.playerBehavior)s[a]=o;return{influence:e,leaders:t,resistances:i,playerBehavior:s}}deserialize(e){if(this.influence.clear(),this.leaders.clear(),this.resistances.clear(),this.playerBehavior.clear(),e.influence)for(const[t,i]of Object.entries(e.influence)){const s=new Map;for(const[a,o]of Object.entries(i))s.set(a,o);this.influence.set(t,s)}if(e.leaders)for(const[t,i]of Object.entries(e.leaders))this.leaders.set(t,{...i});for(const t of Oe)this.leaders.has(t.id)||this.leaders.set(t.id,{alive:!0,respawnTimer:0});if(e.resistances)for(const[t,i]of Object.entries(e.resistances)){const s=new Map;for(const[a,o]of Object.entries(i))s.set(a,o);this.resistances.set(t,s)}if(e.playerBehavior)for(const[t,i]of Object.entries(e.playerBehavior))this.playerBehavior.set(t,i)}}const Yi=[{id:"mossback_behemoth",name:"Mossback Behemoth",title:"The Forest Shaper",biome:"rotwood",hp:15e3,damage:120,defense:80,phases:[{hpThreshold:1,abilities:["tree_throw","vine_slam","root_cage"],speed:30,damageMult:1,description:"Hurls trees and slams with massive vines"},{hpThreshold:.6,abilities:["tree_throw","vine_slam","root_cage","forest_regeneration"],speed:35,damageMult:1.3,description:"Begins regenerating health from nearby trees"},{hpThreshold:.3,abilities:["tree_throw","vine_slam","root_cage","forest_regeneration","nature_wrath"],speed:40,damageMult:1.8,description:"Enters a frenzy, the entire forest attacks"}],patrolPath:[{x:250,y:100},{x:400,y:200},{x:350,y:350},{x:200,y:250}],preparationItems:[{itemId:"fire_trap",quantity:5,description:"Burn away regenerating roots"},{itemId:"anti_regen_poison",quantity:3,description:"Stop forest regeneration phase"}],drops:[{itemId:"titan_heartwood",chance:1,minQty:1,maxQty:1},{itemId:"behemoth_bark",chance:1,minQty:3,maxQty:5},{itemId:"ancient_seed",chance:.5,minQty:1,maxQty:1}],uniqueAbilityUnlock:"natures_grasp",respawnDays:7,statScalePerKill:.1,xpReward:5e3},{id:"magma_colossus",name:"Magma Colossus",title:"The Mountain Walker",biome:"ashlands",hp:2e4,damage:150,defense:120,phases:[{hpThreshold:1,abilities:["lava_trail","magma_fist","eruption"],speed:20,damageMult:1,description:"Leaves lava in its wake, punches with molten fists"},{hpThreshold:.5,abilities:["lava_trail","magma_fist","eruption","terrain_melt"],speed:25,damageMult:1.5,description:"Melts the terrain around it, creating lava pools"},{hpThreshold:.2,abilities:["lava_trail","magma_fist","eruption","terrain_melt","volcanic_explosion"],speed:30,damageMult:2,description:"Triggers volcanic explosions across the battlefield"}],patrolPath:[{x:550,y:200},{x:700,y:350},{x:750,y:500},{x:600,y:400}],preparationItems:[{itemId:"frost_bomb",quantity:5,description:"Cool and harden lava trails"},{itemId:"fire_resistance_potion",quantity:3,description:"Survive volcanic explosions"}],drops:[{itemId:"titan_magma_core",chance:1,minQty:1,maxQty:1},{itemId:"colossus_plate",chance:1,minQty:2,maxQty:4},{itemId:"eternal_ember",chance:.3,minQty:1,maxQty:1}],uniqueAbilityUnlock:"molten_armor",respawnDays:7,statScalePerKill:.1,xpReward:7e3},{id:"leviathan",name:"Leviathan",title:"The Deep Terror",biome:"drowned",hp:18e3,damage:140,defense:90,phases:[{hpThreshold:1,abilities:["tidal_wave","tentacle_slam","whirlpool"],speed:35,damageMult:1,description:"Controls the water, creating waves and whirlpools"},{hpThreshold:.5,abilities:["tidal_wave","tentacle_slam","whirlpool","swallow_attack"],speed:40,damageMult:1.4,description:"Attempts to swallow the player whole"},{hpThreshold:.2,abilities:["tidal_wave","tentacle_slam","whirlpool","swallow_attack","tsunami"],speed:45,damageMult:1.8,description:"Summons a massive tsunami that reshapes the coast"}],patrolPath:[{x:850,y:700},{x:1e3,y:850},{x:950,y:1e3},{x:800,y:900}],preparationItems:[{itemId:"lightning_harpoon",quantity:4,description:"Electrify the water around the Leviathan"},{itemId:"breathing_apparatus",quantity:1,description:"Survive being swallowed"}],drops:[{itemId:"titan_pearl",chance:1,minQty:1,maxQty:1},{itemId:"leviathan_scale",chance:1,minQty:3,maxQty:6},{itemId:"abyssal_trident_fragment",chance:.4,minQty:1,maxQty:1}],uniqueAbilityUnlock:"tidal_force",respawnDays:7,statScalePerKill:.1,xpReward:6e3},{id:"bone_emperor",name:"Bone Emperor",title:"The Undying Sovereign",biome:"bone_wastes",hp:22e3,damage:130,defense:100,phases:[{hpThreshold:1,abilities:["army_summon","bone_cage","death_beam"],speed:25,damageMult:1,description:"Raises armies of skeletons and imprisons foes in bone cages"},{hpThreshold:.5,abilities:["army_summon","bone_cage","death_beam","sandstorm"],speed:30,damageMult:1.3,description:"Conjures a sandstorm that blinds and damages"},{hpThreshold:.2,abilities:["army_summon","bone_cage","death_beam","sandstorm","titan_resurrection"],speed:35,damageMult:2,description:"Resurrects fallen titan bones as weapons"}],patrolPath:[{x:1100,y:400},{x:1300,y:550},{x:1350,y:700},{x:1150,y:600}],preparationItems:[{itemId:"holy_water",quantity:5,description:"Destroy summoned undead instantly"},{itemId:"binding_rune",quantity:3,description:"Prevent titan resurrection phase"}],drops:[{itemId:"titan_crown_shard",chance:1,minQty:1,maxQty:1},{itemId:"emperor_bone",chance:1,minQty:3,maxQty:5},{itemId:"necromancer_staff_fragment",chance:.35,minQty:1,maxQty:1}],uniqueAbilityUnlock:"death_sovereign",respawnDays:7,statScalePerKill:.1,xpReward:8e3},{id:"void_hydra",name:"Void Hydra",title:"The Reality Shatterer",biome:"the_void",hp:25e3,damage:180,defense:110,phases:[{hpThreshold:1,abilities:["portal_breath","head_slam","dimension_tear"],speed:30,damageMult:1,description:"Multi-headed attacks through portals from multiple dimensions"},{hpThreshold:.5,abilities:["portal_breath","head_slam","dimension_tear","head_regeneration"],speed:35,damageMult:1.5,description:"Cut off heads grow back stronger  must kill all at once"},{hpThreshold:.2,abilities:["portal_breath","head_slam","dimension_tear","head_regeneration","reality_shatter"],speed:40,damageMult:2.5,description:"Shatters reality itself, creating a chaotic arena"}],patrolPath:[{x:1450,y:200},{x:1600,y:350},{x:1650,y:150},{x:1500,y:300}],preparationItems:[{itemId:"reality_anchor",quantity:3,description:"Stabilize reality during the final phase"},{itemId:"void_bane",quantity:5,description:"Prevent head regeneration temporarily"}],drops:[{itemId:"titan_void_heart",chance:1,minQty:1,maxQty:1},{itemId:"hydra_fang",chance:1,minQty:4,maxQty:7},{itemId:"dimension_key",chance:.25,minQty:1,maxQty:1}],uniqueAbilityUnlock:"void_step",respawnDays:7,statScalePerKill:.1,xpReward:1e4}],zt=new Map(Yi.map(r=>[r.id,r])),ml=3,pl=.7,gl=.1,fl=15;class yl{titans=new Map;onTitanDefeatedCallbacks=[];onTitanSpottedCallbacks=[];constructor(){for(const e of Yi){const t=e.patrolPath[0]??{x:0,y:0};this.titans.set(e.id,{id:e.id,alive:!0,currentX:t.x,currentY:t.y,patrolIndex:0,killCount:0,respawnTimer:0,weakened:!1,trapsSet:0})}}update(e){for(const t of this.titans.values()){if(!t.alive)continue;const i=zt.get(t.id);if(!i||i.patrolPath.length<2)continue;const s=i.patrolPath[t.patrolIndex],a=s.x-t.currentX,o=s.y-t.currentY,n=Math.sqrt(a*a+o*o);if(n<2)t.patrolIndex=(t.patrolIndex+1)%i.patrolPath.length;else{const l=fl*e,c=Math.min(1,l/n);t.currentX+=a*c,t.currentY+=o*c}}}advanceDay(){for(const e of this.titans.values())!e.alive&&e.respawnTimer>0&&(e.respawnTimer--,e.respawnTimer<=0&&this.respawnTitan(e.id))}getTitanState(e){return this.titans.get(e)??null}getAllTitans(){return Array.from(this.titans.values())}getVisibleTitans(e,t,i){const s=[],a=i*i;for(const o of this.titans.values()){if(!o.alive)continue;const n=o.currentX-e,l=o.currentY-t;if(n*n+l*l<=a){s.push(o);for(const c of this.onTitanSpottedCallbacks)c(o.id)}}return s}setTrap(e){const t=this.titans.get(e);!t||!t.alive||(t.trapsSet++,t.trapsSet>=ml&&(t.weakened=!0))}isWeakened(e){return this.titans.get(e)?.weakened??!1}defeatTitan(e){const t=this.titans.get(e);if(!t||!t.alive)return;const i=zt.get(e);t.alive=!1,t.killCount++,t.respawnTimer=i?.respawnDays??7,t.weakened=!1,t.trapsSet=0;for(const s of this.onTitanDefeatedCallbacks)s(e,t.killCount)}respawnTitan(e){const t=this.titans.get(e);if(!t)return;const s=zt.get(e)?.patrolPath[0]??{x:0,y:0};t.alive=!0,t.currentX=s.x,t.currentY=s.y,t.patrolIndex=0,t.respawnTimer=0,t.weakened=!1,t.trapsSet=0}getScaledStats(e){const t=this.titans.get(e),i=zt.get(e);if(!t||!i)return{hp:0,damage:0,defense:0};const s=i.statScalePerKill??gl,a=1+t.killCount*s,o=t.weakened?pl:1;return{hp:Math.round(i.hp*a*o),damage:Math.round(i.damage*a*o),defense:Math.round(i.defense*a*o)}}onTitanDefeated(e){this.onTitanDefeatedCallbacks.push(e)}onTitanSpotted(e){this.onTitanSpottedCallbacks.push(e)}serialize(){const e=[];for(const t of this.titans.values())e.push({...t});return{titans:e}}deserialize(e){if(this.titans.clear(),e.titans)for(const t of e.titans)this.titans.set(t.id,{...t});for(const t of Yi)if(!this.titans.has(t.id)){const i=t.patrolPath[0]??{x:0,y:0};this.titans.set(t.id,{id:t.id,alive:!0,currentX:i.x,currentY:i.y,patrolIndex:0,killCount:0,respawnTimer:0,weakened:!1,trapsSet:0})}}}const Xi=[{id:"haven",name:"Haven",description:"Peaceful meadows and gentle hills. A safe tutorial zone where the pilgrimage begins.",distanceRange:[0,200],palette:{grass:"#4a7c3f",dirt:"#8b6914",stone:"#888888",water:"#2266aa",accent:"#7dd3fc"},enemyTypes:["forest_slime","wild_boar","angry_bee","field_rat"],levelRange:[1,5],resources:["wood","stone","copper_ore","fiber","wild_berries"],hazards:[],weather:{clear:40,cloudy:25,rain:20,fog:10,storm:5},temperature:{base:20,variance:5},music:"haven_theme",gateBoss:"harvest_horror",difficultyMultiplier:1,corruptionRate:1e-4},{id:"rotwood",name:"Rotwood",description:"Dense corrupted forest choked with fungi and poison fog. The corruption first took root here.",distanceRange:[200,500],palette:{grass:"#2d4a2d",dirt:"#4a3520",stone:"#555544",water:"#336644",accent:"#88cc44"},enemyTypes:["rot_spider","fungal_crawler","poison_moth","corrupted_treant","spore_bat"],levelRange:[5,12],resources:["dark_wood","iron_ore","mushroom_cluster","spider_silk","toxic_sap"],hazards:[{type:"poison_fog",damage:2,interval:3}],weather:{cloudy:30,rain:25,fog:25,spore_cloud:15,storm:5},temperature:{base:15,variance:3},music:"rotwood_theme",gateBoss:"blight_mother",difficultyMultiplier:1.3,corruptionRate:5e-4},{id:"ashlands",name:"Ashlands",description:"Volcanic wasteland of lava rivers and ember rain. Heat distorts the air, and the ground cracks beneath your feet.",distanceRange:[500,800],palette:{grass:"#5a3a2a",dirt:"#3a2010",stone:"#555555",water:"#ff4400",accent:"#ff8844"},enemyTypes:["fire_imp","lava_golem","ash_wraith","magma_beetle","flame_serpent"],levelRange:[12,20],resources:["obsidian","fire_crystal","volcanic_ash","magma_iron","ember_dust"],hazards:[{type:"ember_rain",damage:3,interval:5},{type:"lava",damage:15,interval:1}],weather:{clear:20,cloudy:15,ember_rain:35,storm:15,fog:15},temperature:{base:45,variance:10},music:"ashlands_theme",gateBoss:"stone_titan",difficultyMultiplier:1.7,corruptionRate:8e-4},{id:"drowned",name:"Drowned Depths",description:"Flooded ruins submerged in acid water, lit by bioluminescent growths. Ancient civilizations rest below.",distanceRange:[800,1100],palette:{grass:"#2a4a5a",dirt:"#1a3040",stone:"#3a5060",water:"#00cc88",accent:"#44ffcc"},enemyTypes:["drowned_ghoul","acid_jellyfish","coral_golem","deep_lurker","tide_witch"],levelRange:[20,28],resources:["abyssal_pearl","coral_chunk","bioluminescent_algae","waterlogged_wood","deep_iron"],hazards:[{type:"acid_water",damage:5,interval:2},{type:"flooding",damage:0,interval:30}],weather:{rain:35,storm:20,acid_rain:20,fog:15,cloudy:10},temperature:{base:10,variance:3},music:"drowned_theme",gateBoss:"kraken",difficultyMultiplier:2,corruptionRate:.001},{id:"bone_wastes",name:"Bone Wastes",description:"Skeletal desert where sandstorms rage and mirages deceive. The bones of titans litter the landscape.",distanceRange:[1100,1400],palette:{grass:"#dbc07c",dirt:"#aa9060",stone:"#ccbbaa",water:"#887744",accent:"#ffe4b5"},enemyTypes:["bone_warrior","sand_scorpion","mirage_phantom","dust_devil","skeletal_archer"],levelRange:[28,36],resources:["ancient_bone","gold_ore","desert_crystal","sun_stone","titan_bone_fragment"],hazards:[{type:"sandstorm",damage:4,interval:3},{type:"heat",damage:2,interval:5}],weather:{clear:25,sandstorm:35,cloudy:15,fog:10,storm:15},temperature:{base:40,variance:15},music:"bone_wastes_theme",gateBoss:"sand_wyrm",difficultyMultiplier:2.5,corruptionRate:.0015},{id:"the_void",name:"The Void",description:"Reality breaks down here. Floating islands, gravity shifts, and things that should not exist. The barrier between worlds is thin.",distanceRange:[1400,1700],palette:{grass:"#220033",dirt:"#110022",stone:"#332244",water:"#6600cc",accent:"#cc44ff"},enemyTypes:["void_shade","reality_tear","phase_stalker","echo_wraith","dimension_crawler"],levelRange:[36,44],resources:["void_essence","reality_shard","echo_crystal","nightmare_dust","phantom_silk"],hazards:[{type:"void_tear",damage:8,interval:4},{type:"gravity_shift",damage:0,interval:10}],weather:{void_storm:40,fog:20,clear:15,storm:15,cloudy:10},temperature:{base:-10,variance:30},music:"void_theme",gateBoss:"void_weaver",difficultyMultiplier:3,corruptionRate:.003},{id:"edilas",name:"EDILAS",description:"The living land itself. Terrain reacts to the player, the ground breathes, and the corruption source pulses at its heart.",distanceRange:[1700,1/0],palette:{grass:"#1a0022",dirt:"#0a0011",stone:"#221133",water:"#8800ff",accent:"#ff00ff"},enemyTypes:["living_terrain","corruption_avatar","world_serpent_spawn","edilas_guardian","reality_anchor"],levelRange:[44,50],resources:["edilas_heartstone","living_metal","corruption_crystal","world_thread","primordial_essence"],hazards:[{type:"corruption_surge",damage:10,interval:3},{type:"terrain_shift",damage:5,interval:8}],weather:{void_storm:50,corruption_storm:30,fog:10,clear:10},temperature:{base:0,variance:50},music:"edilas_theme",gateBoss:"world_serpent",difficultyMultiplier:3.5,corruptionRate:.005}],js=new Map(Xi.map(r=>[r.id,r])),et=300,Vs=1800,xi=30,bl=new Set(["rain","storm","acid_rain"]),Ys={clear:1,cloudy:.9,rain:.7,storm:.5,fog:.3,sandstorm:.2,acid_rain:.6,ember_rain:.6,spore_cloud:.4,void_storm:.15,corruption_storm:.25},_l={clear:0,cloudy:-2,rain:-5,storm:-8,fog:-3,sandstorm:5,acid_rain:-4,ember_rain:10,spore_cloud:0,void_storm:-15,corruption_storm:-10};class wl{state={type:"clear",intensity:.5,duration:et,elapsed:0,transitioning:!1,nextType:null};transitionElapsed=0;weatherChangeCallbacks=[];update(e,t){if(this.state.elapsed+=e,this.state.transitioning&&this.state.nextType!==null){this.transitionElapsed+=e;const i=xi/2;if(this.transitionElapsed<i?this.state.intensity=Math.max(0,1-this.transitionElapsed/i):this.state.intensity=Math.min(1,(this.transitionElapsed-i)/i),this.transitionElapsed>=xi){const s=this.state.type;this.state.type=this.state.nextType,this.state.nextType=null,this.state.transitioning=!1,this.state.elapsed=0,this.state.intensity=.5+Math.random()*.5,this.state.duration=et+Math.random()*(Vs-et),this.transitionElapsed=0;for(const a of this.weatherChangeCallbacks)a(s,this.state.type)}}else if(this.state.elapsed>=this.state.duration){const i=this.pickWeather(t);i!==this.state.type?(this.state.transitioning=!0,this.state.nextType=i,this.transitionElapsed=0):(this.state.elapsed=0,this.state.duration=et+Math.random()*(Vs-et))}}pickWeather(e){const t=js.get(e);if(!t||!t.weather)return"clear";const i=Object.keys(t.weather),s=Object.values(t.weather),a=s.reduce((n,l)=>n+l,0);if(a<=0)return"clear";let o=Math.random()*a;for(let n=0;n<i.length;n++)if(o-=s[n],o<=0)return i[n];return i[i.length-1]}getCurrentWeather(){return{...this.state}}getWeatherType(){return this.state.type}isRaining(){return bl.has(this.state.type)}getVisibility(){const e=Ys[this.state.type]??1;if(this.state.transitioning&&this.state.nextType!==null){const t=Ys[this.state.nextType]??1,i=this.transitionElapsed/xi;return e+(t-e)*i}return e}getTemperature(e){const i=js.get(e)?.temperature.base??20,s=_l[this.state.type]??0;return i+s}forceWeather(e,t){const i=this.state.type;if(this.state.type=e,this.state.intensity=.8,this.state.duration=t,this.state.elapsed=0,this.state.transitioning=!1,this.state.nextType=null,this.transitionElapsed=0,i!==e)for(const s of this.weatherChangeCallbacks)s(i,e)}onWeatherChange(e){this.weatherChangeCallbacks.push(e)}serialize(){return{type:this.state.type,intensity:this.state.intensity,duration:this.state.duration,elapsed:this.state.elapsed,transitioning:this.state.transitioning,nextType:this.state.nextType,transitionElapsed:this.transitionElapsed}}deserialize(e){this.state.type=e.type??"clear",this.state.intensity=e.intensity??.5,this.state.duration=e.duration??et,this.state.elapsed=e.elapsed??0,this.state.transitioning=e.transitioning??!1,this.state.nextType=e.nextType??null,this.transitionElapsed=e.transitionElapsed??0}}const vl={haven:"music_haven",rotwood:"music_rotwood",ashlands:"music_ashlands",drowned:"music_drowned",bone:"music_bone_wastes",void:"music_void",edilas:"music_edilas"},xl={haven:"ambient_forest",rotwood:"ambient_spores",ashlands:"ambient_lava",drowned:"ambient_water",bone:"ambient_wind",void:"ambient_void",edilas:"ambient_celestial"},q={SWORD_SWING:"sfx_sword_swing",AXE_SWING:"sfx_axe_swing",BOW_SHOOT:"sfx_bow_shoot",HAMMER_SMASH:"sfx_hammer_smash",ENEMY_HIT:"sfx_enemy_hit",PLAYER_HIT:"sfx_player_hit",ITEM_PICKUP:"sfx_item_pickup",GOLD_PICKUP:"sfx_gold_pickup",LEVEL_UP:"sfx_level_up",DOOR_OPEN:"sfx_door_open",CHEST_OPEN:"sfx_chest_open",BOSS_INTRO:"sfx_boss_intro",CRIT_HIT:"sfx_crit_hit"};class bs{scene;currentMusic=null;currentMusicKey="";currentAmbient=null;currentAmbientKey="";musicVolume=.5;sfxVolume=.7;ambientVolume=.3;masterVolume=1;muted=!1;crossfading=!1;crossfadeTarget=null;crossfadeProgress=0;crossfadeDuration=2e3;constructor(e){this.scene=e}playMusic(e,t=!0){if(!(e===this.currentMusicKey||this.muted))if(this.currentMusic){this.crossfading=!0,this.crossfadeTarget=e,this.crossfadeProgress=0;try{const i=this.scene.sound.add(e,{volume:0,loop:t});i.play(),this.scene.tweens.add({targets:this.currentMusic,volume:0,duration:this.crossfadeDuration,onComplete:()=>{this.currentMusic?.destroy(),this.currentMusic=i,this.currentMusicKey=e,this.crossfading=!1}}),this.scene.tweens.add({targets:i,volume:this.musicVolume*this.masterVolume,duration:this.crossfadeDuration})}catch{this.currentMusicKey=e}}else try{this.currentMusic=this.scene.sound.add(e,{volume:this.musicVolume*this.masterVolume,loop:t}),this.currentMusic.play(),this.currentMusicKey=e}catch{this.currentMusicKey=e}}playAmbient(e){if(!(e===this.currentAmbientKey||this.muted)){this.currentAmbient&&this.currentAmbient.destroy();try{this.currentAmbient=this.scene.sound.add(e,{volume:this.ambientVolume*this.masterVolume,loop:!0}),this.currentAmbient.play(),this.currentAmbientKey=e}catch{this.currentAmbientKey=e}}}playSFX(e,t=1){if(!this.muted)try{this.scene.sound.play(e,{volume:this.sfxVolume*this.masterVolume*t})}catch{}}stopAll(){this.currentMusic?.destroy(),this.currentMusic=null,this.currentMusicKey="",this.currentAmbient?.destroy(),this.currentAmbient=null,this.currentAmbientKey=""}stopMusic(){this.currentMusic?.destroy(),this.currentMusic=null,this.currentMusicKey=""}duckMusic(e=.15,t=500){this.currentMusic&&this.scene.tweens.add({targets:this.currentMusic,volume:e*this.masterVolume,duration:t})}unduckMusic(e=500){this.currentMusic&&this.scene.tweens.add({targets:this.currentMusic,volume:this.musicVolume*this.masterVolume,duration:e})}swellMusic(e=.9,t=1e3){this.currentMusic&&this.scene.tweens.add({targets:this.currentMusic,volume:e*this.masterVolume,duration:t,yoyo:!0,hold:500})}setMusicVolume(e){this.musicVolume=Math.max(0,Math.min(1,e)),this.currentMusic&&"volume"in this.currentMusic&&this.currentMusic.setVolume(this.musicVolume*this.masterVolume)}setSFXVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e))}setAmbientVolume(e){this.ambientVolume=Math.max(0,Math.min(1,e)),this.currentAmbient&&"volume"in this.currentAmbient&&this.currentAmbient.setVolume(this.ambientVolume*this.masterVolume)}setMasterVolume(e){this.masterVolume=Math.max(0,Math.min(1,e))}setMuted(e){this.muted=e,e?this.scene.sound.setMute(!0):this.scene.sound.setMute(!1)}isMuted(){return this.muted}getMusicVolume(){return this.musicVolume}getSFXVolume(){return this.sfxVolume}getAmbientVolume(){return this.ambientVolume}getMasterVolume(){return this.masterVolume}getCurrentMusicKey(){return this.currentMusicKey}setBiomeAudio(e){const t=vl[e];t&&this.playMusic(t);const i=xl[e];i&&this.playAmbient(i)}playCombatMusic(){this.duckMusic(.1),this.playSFX(q.BOSS_INTRO,.6)}stopCombatMusic(){this.unduckMusic()}serialize(){return{musicVolume:this.musicVolume,sfxVolume:this.sfxVolume,ambientVolume:this.ambientVolume,masterVolume:this.masterVolume,muted:this.muted}}deserialize(e){this.musicVolume=e.musicVolume,this.sfxVolume=e.sfxVolume,this.ambientVolume=e.ambientVolume,this.masterVolume=e.masterVolume,this.muted=e.muted}}const Me=[{hour:0,tint:657966,alpha:.65},{hour:4,tint:657966,alpha:.55},{hour:5,tint:1708096,alpha:.4},{hour:6,tint:16755268,alpha:.2},{hour:8,tint:16777215,alpha:0},{hour:12,tint:16777215,alpha:0},{hour:16,tint:16777215,alpha:0},{hour:18,tint:16746564,alpha:.15},{hour:19,tint:13386786,alpha:.25},{hour:20,tint:1708096,alpha:.4},{hour:22,tint:657966,alpha:.55},{hour:24,tint:657966,alpha:.65}],Xs={haven:{tint:0,alpha:0},rotwood:{tint:8704,alpha:.1},ashlands:{tint:3342336,alpha:.12},drowned:{tint:8755,alpha:.15},bone:{tint:1118464,alpha:.08},void:{tint:1114146,alpha:.2},edilas:{tint:4386,alpha:.1}},kl=120,Ks=.92,Ht=[{name:"Radiant",threshold:75,enemyDmgMult:1,enemyHpMult:1,lootRarityBonus:0,corruptionRate:.5,revealMult:1},{name:"Dim",threshold:50,enemyDmgMult:1.15,enemyHpMult:1.1,lootRarityBonus:1,corruptionRate:1,revealMult:.75},{name:"Dark",threshold:25,enemyDmgMult:1.3,enemyHpMult:1.2,lootRarityBonus:2,corruptionRate:1.5,revealMult:.5},{name:"Pitch Black",threshold:0,enemyDmgMult:1.5,enemyHpMult:1.3,lootRarityBonus:3,corruptionRate:2,revealMult:.3}];class Ja{scene;tintOverlay=null;biomeOverlay=null;dungeonOverlay=null;lightGraphics=null;pointLights=new Map;currentTint=16777215;currentAlpha=0;currentBiome="haven";isDungeon=!1;fuel=100;fuelBurnRate=2;currentLightTier=Ht[0];constructor(e){this.scene=e}init(e=!1){this.isDungeon=e;const{width:t,height:i}=this.scene.cameras.main;this.tintOverlay=this.scene.add.rectangle(t/2,i/2,t,i,0,0).setScrollFactor(0).setDepth(7e3).setBlendMode(x.BlendModes.MULTIPLY),this.biomeOverlay=this.scene.add.rectangle(t/2,i/2,t,i,0,0).setScrollFactor(0).setDepth(7001).setBlendMode(x.BlendModes.ADD),this.lightGraphics=this.scene.add.graphics().setDepth(7002).setBlendMode(x.BlendModes.ADD),e&&(this.dungeonOverlay=this.scene.add.graphics().setDepth(7500))}update(e,t,i,s){this.currentBiome=t,this.isDungeon?this.updateDungeonDarkness(i,s):(this.updateDayNightTint(e),this.updateBiomeAmbient(t)),this.renderPointLights(i,s)}updateDayNightTint(e){if(!this.tintOverlay)return;let t=Me[0],i=Me[Me.length-1];for(let d=0;d<Me.length-1;d++)if(e>=Me[d].hour&&e<Me[d+1].hour){t=Me[d],i=Me[d+1];break}const s=i.hour-t.hour,a=s>0?(e-t.hour)/s:0,o=Math.round((t.tint>>16&255)+((i.tint>>16&255)-(t.tint>>16&255))*a),n=Math.round((t.tint>>8&255)+((i.tint>>8&255)-(t.tint>>8&255))*a),l=Math.round((t.tint&255)+((i.tint&255)-(t.tint&255))*a),c=t.alpha+(i.alpha-t.alpha)*a;this.currentTint=o<<16|n<<8|l,this.currentAlpha=c,this.tintOverlay.setFillStyle(this.currentTint,this.currentAlpha)}updateBiomeAmbient(e){if(!this.biomeOverlay)return;const t=Xs[e]??Xs.haven;this.biomeOverlay.setFillStyle(t.tint,t.alpha)}updateDungeonDarkness(e,t){if(!this.dungeonOverlay)return;const i=this.scene.cameras.main;this.dungeonOverlay.clear(),this.dungeonOverlay.fillStyle(0,Ks),this.dungeonOverlay.fillRect(i.scrollX-100,i.scrollY-100,i.width/i.zoom+200,i.height/i.zoom+200);const s=kl*this.currentLightTier.revealMult;this.dungeonOverlay.fillStyle(0,0);for(let a=s;a>0;a-=4){const o=Ks*(a/s);this.dungeonOverlay.fillStyle(0,o),this.dungeonOverlay.fillCircle(e,t,a)}this.dungeonOverlay.fillStyle(0,0),this.dungeonOverlay.fillCircle(e,t,s*.4)}addLight(e,t,i,s=80,a=16755268,o=.5,n=!0){this.pointLights.set(e,{id:e,x:t,y:i,radius:s,color:a,intensity:o,flicker:n})}removeLight(e){this.pointLights.delete(e)}clearLights(){this.pointLights.clear()}renderPointLights(e,t){if(!this.lightGraphics)return;this.lightGraphics.clear();const i=600;for(const s of this.pointLights.values()){const a=s.x-e,o=s.y-t;if(a*a+o*o>i*i)continue;let n=s.intensity;s.flicker&&(n*=.9+Math.random()*.2);const l=6;for(let c=l;c>=1;c--){const d=c/l,h=s.color>>16&255,u=s.color>>8&255,m=s.color&255,g=Math.round(h*d),y=Math.round(u*d),_=Math.round(m*d),w=g<<16|y<<8|_;this.lightGraphics.fillStyle(w,n*d*.15),this.lightGraphics.fillCircle(s.x,s.y,s.radius*d)}}}updateFuel(e){!this.isDungeon||this.fuel<=0||(this.fuel=Math.max(0,this.fuel-this.fuelBurnRate/60*e),this.recalcLightTier())}addFuel(e){this.fuel=Math.min(100,this.fuel+e),this.recalcLightTier()}getFuel(){return this.fuel}setFuelBurnRate(e){this.fuelBurnRate=e}getLightTier(){return this.currentLightTier}recalcLightTier(){for(const e of Ht)if(this.fuel>=e.threshold){this.currentLightTier=e;return}this.currentLightTier=Ht[Ht.length-1]}getCurrentTint(){return this.currentTint}getDarknessAlpha(){return this.currentAlpha}isNight(){return this.currentAlpha>.3}destroy(){this.tintOverlay?.destroy(),this.biomeOverlay?.destroy(),this.dungeonOverlay?.destroy(),this.lightGraphics?.destroy(),this.pointLights.clear()}}const Sl={blood:(r,e)=>({x:r,y:e,count:6,color:[13369344,8912896,6684672],size:{min:2,max:4},speed:{min:40,max:120},angle:{min:0,max:360},life:{min:.3,max:.6},gravity:200,fadeOut:!0,shrink:!0}),sparks:(r,e)=>({x:r,y:e,count:8,color:[16777215,16772744,16763972],size:{min:1,max:3},speed:{min:80,max:200},angle:{min:0,max:360},life:{min:.1,max:.3},gravity:0,fadeOut:!0,shrink:!1}),critFlash:(r,e)=>({x:r,y:e,count:12,color:[16755200,16768256,16777215],size:{min:2,max:5},speed:{min:100,max:250},angle:{min:0,max:360},life:{min:.2,max:.5},gravity:-50,fadeOut:!0,shrink:!0}),harvest:(r,e)=>({x:r,y:e,count:10,color:[4521796,8978312,11206570],size:{min:1,max:3},speed:{min:20,max:60},angle:{min:220,max:320},life:{min:.5,max:1},gravity:-30,fadeOut:!0,shrink:!1}),goldPickup:(r,e)=>({x:r,y:e,count:8,color:[16763904,16768324,16772744],size:{min:1,max:3},speed:{min:30,max:80},angle:{min:240,max:300},life:{min:.3,max:.7},gravity:-60,fadeOut:!0,shrink:!1}),levelUp:(r,e)=>({x:r,y:e,count:30,color:[16768256,16777215,4513279,16729343],size:{min:2,max:5},speed:{min:80,max:200},angle:{min:0,max:360},life:{min:.5,max:1.5},gravity:-40,fadeOut:!0,shrink:!0}),corruption:(r,e)=>({x:r,y:e,count:4,color:[4456550,3342421,2228292],size:{min:3,max:6},speed:{min:5,max:20},angle:{min:240,max:300},life:{min:1,max:2},gravity:-15,fadeOut:!0,shrink:!1}),poison:(r,e)=>({x:r,y:e,count:3,color:[52224,39168,4521796],size:{min:1,max:3},speed:{min:10,max:30},angle:{min:240,max:300},life:{min:.4,max:.8},gravity:-40,fadeOut:!0,shrink:!1}),burn:(r,e)=>({x:r,y:e,count:4,color:[16729088,16737792,16755200],size:{min:2,max:4},speed:{min:15,max:40},angle:{min:240,max:300},life:{min:.3,max:.6},gravity:-80,fadeOut:!0,shrink:!0}),freeze:(r,e)=>({x:r,y:e,count:6,color:[8965375,11197951,16777215],size:{min:1,max:3},speed:{min:10,max:30},angle:{min:0,max:360},life:{min:.5,max:1},gravity:20,fadeOut:!0,shrink:!1})};function Ml(r,e,t){switch(r){case"rain":return{x:0,y:-10,count:1,color:6719692,size:{min:1,max:2},speed:{min:300,max:400},angle:{min:250,max:260},life:{min:.8,max:1.2},gravity:100,fadeOut:!1,shrink:!1};case"storm":return{x:0,y:-10,count:1,color:[5601211,4482730],size:{min:1,max:3},speed:{min:400,max:600},angle:{min:240,max:255},life:{min:.6,max:1},gravity:150,fadeOut:!1,shrink:!1};case"snow":return{x:0,y:-10,count:1,color:[16777215,15658751,14540270],size:{min:2,max:4},speed:{min:20,max:60},angle:{min:250,max:290},life:{min:2,max:4},gravity:30,fadeOut:!0,shrink:!1};case"sandstorm":return{x:0,y:0,count:1,color:[13412966,12294485,11176004],size:{min:2,max:5},speed:{min:200,max:400},angle:{min:170,max:190},life:{min:.5,max:1.5},gravity:20,fadeOut:!0,shrink:!1};case"ember_rain":return{x:0,y:-10,count:1,color:[16729088,16737792,16755200],size:{min:2,max:4},speed:{min:40,max:100},angle:{min:250,max:290},life:{min:1,max:2},gravity:50,fadeOut:!0,shrink:!0};case"spore_cloud":return{x:0,y:0,count:1,color:[8965120,11197730,13430340],size:{min:3,max:6},speed:{min:5,max:20},angle:{min:0,max:360},life:{min:2,max:4},gravity:-10,fadeOut:!0,shrink:!1};case"acid_rain":return{x:0,y:-10,count:1,color:[4508740,6741316,8973892],size:{min:1,max:2},speed:{min:280,max:380},angle:{min:252,max:262},life:{min:.8,max:1.2},gravity:100,fadeOut:!1,shrink:!1};case"void_storm":return{x:0,y:0,count:1,color:[6684876,8913151,11158783],size:{min:2,max:5},speed:{min:100,max:300},angle:{min:0,max:360},life:{min:.3,max:.8},gravity:0,fadeOut:!0,shrink:!0};default:return null}}class _s{scene;graphics;particles=[];continuousEmitters=new Map;MAX_PARTICLES=500;constructor(e){this.scene=e,this.graphics=e.add.graphics().setDepth(6500)}emit(e,t,i){const s=Sl[e](t,i);this.emitFromConfig(s)}emitFromConfig(e){for(let t=0;t<e.count&&!(this.particles.length>=this.MAX_PARTICLES);t++){const i=x.Math.FloatBetween(e.angle.min,e.angle.max)*Math.PI/180,s=x.Math.FloatBetween(e.speed.min,e.speed.max),a=x.Math.FloatBetween(e.life.min,e.life.max),o=x.Math.FloatBetween(e.size.min,e.size.max);let n;Array.isArray(e.color)?n=e.color[Math.floor(Math.random()*e.color.length)]:n=e.color,this.particles.push({x:e.x+(Math.random()-.5)*8,y:e.y+(Math.random()-.5)*8,vx:Math.cos(i)*s,vy:Math.sin(i)*s,life:a,maxLife:a,color:n,size:o,gravity:e.gravity,fadeOut:e.fadeOut,shrink:e.shrink})}}startEmitter(e,t,i){this.continuousEmitters.set(e,{id:e,config:t,rate:i,accumulator:0,active:!0})}stopEmitter(e){this.continuousEmitters.delete(e)}setWeatherParticles(e){this.stopEmitter("weather");const t=this.scene.cameras.main,i=Ml(e,t.width,t.height);if(i){const s=e==="storm"?80:e==="rain"?40:15;this.startEmitter("weather",i,s)}}update(e,t,i,s,a){for(const o of this.continuousEmitters.values())if(o.active)for(o.accumulator+=e*o.rate;o.accumulator>=1;){o.accumulator-=1;const n={...o.config};o.id==="weather"&&(n.x=t+Math.random()*s,n.y=i+(n.y<0?n.y:Math.random()*a));const l={...n,count:1};this.emitFromConfig(l)}this.graphics.clear();for(let o=this.particles.length-1;o>=0;o--){const n=this.particles[o];if(n.life-=e,n.life<=0){this.particles.splice(o,1);continue}n.vy+=n.gravity*e,n.x+=n.vx*e,n.y+=n.vy*e;const l=n.life/n.maxLife;let c=1,d=n.size;n.fadeOut&&(c=l),n.shrink&&(d=n.size*l);const h=50;n.x<t-h||n.x>t+s+h||n.y<i-h||n.y>i+a+h||(this.graphics.fillStyle(n.color,c),d<=2?this.graphics.fillRect(n.x-d/2,n.y-d/2,d,d):this.graphics.fillCircle(n.x,n.y,d/2))}}getParticleCount(){return this.particles.length}destroy(){this.graphics.destroy(),this.particles=[],this.continuousEmitters.clear()}}const ki=.1,Js=.3,Tl=.6,Cl=.9,Il=3342404,Pl=4456550,Rl=2228275,Al=1114129,Zs=.4;class Dl{scene;graphics;corruptionManager;particleManager;particleTimer=0;pulsePhase=0;constructor(e,t,i=null){this.scene=e,this.corruptionManager=t,this.particleManager=i,this.graphics=e.add.graphics().setDepth(2e3)}update(e,t,i,s,a){this.graphics.clear(),this.pulsePhase+=e*2;const o=Math.floor(t/D)-1,n=Math.floor(i/D)-1,l=Math.ceil((t+s)/D)+1,c=Math.ceil((i+a)/D)+1;let d=[];for(let h=n;h<=c;h++)for(let u=o;u<=l;u++){const m=this.corruptionManager.getCorruption(u,h);if(m<ki)continue;const g=u*D,y=h*D;if(m>=Cl){const _=.7+Math.sin(this.pulsePhase*1.5)*.1;this.graphics.fillStyle(Al,_),this.graphics.fillRect(g,y,D,D),this.graphics.fillStyle(6684876,.3),this.graphics.fillRect(g+D/2-1,y,2,D),this.graphics.fillRect(g,y+D/2-1,D,2),d.push({x:g+D/2,y:y+D/2})}else if(m>=Tl){const _=.45+Math.sin(this.pulsePhase+u*.3)*.1;this.graphics.fillStyle(Rl,_),this.graphics.fillRect(g,y,D,D),this.graphics.fillStyle(4456550,.2),this.graphics.fillRect(g,y,D,2),this.graphics.fillRect(g,y,2,D),d.push({x:g+D/2,y:y+D/2})}else if(m>=Js){const _=.2+Math.sin(this.pulsePhase*.8+h*.5)*.05;this.graphics.fillStyle(Pl,_),this.graphics.fillRect(g,y,D,D)}else{const _=.08+(m-ki)/(Js-ki)*.1;this.graphics.fillStyle(Il,_),this.graphics.fillRect(g,y,D,D)}}if(this.particleManager&&d.length>0&&(this.particleTimer+=e,this.particleTimer>=Zs)){this.particleTimer-=Zs;const h=d[Math.floor(Math.random()*d.length)];this.particleManager.emit("corruption",h.x,h.y)}}destroy(){this.graphics.destroy()}}const ft=[{id:"egg_festival",name:"Egg Festival",season:"Spring",day:13,description:"A beloved spring tradition! Compete in an egg hunt across the town, collecting as many hidden eggs as you can before the timer runs out.",activities:[{id:"egg_hunt",name:"Egg Hunt",description:"Find and collect hidden eggs scattered around town before the timer runs out."},{id:"egg_decorating",name:"Egg Decorating",description:"Decorate eggs at the painting station for bonus prizes."}],rewards:[{itemId:"straw_hat",quantity:1},{gold:500}]},{id:"flower_dance",name:"Flower Dance",season:"Spring",day:24,description:"An elegant ceremony where townsfolk pair up to dance among the spring blossoms. A strong relationship is required to be chosen as a dance partner.",activities:[{id:"partner_selection",name:"Dance Partner Selection",description:"Ask an NPC to be your dance partner. Requires at least 4 hearts of friendship."},{id:"flower_dance_performance",name:"Flower Dance",description:"Perform the traditional flower dance with your partner."}],rewards:[{itemId:"flower_crown",quantity:1},{gold:300}]},{id:"luau",name:"Luau",season:"Summer",day:11,description:"The whole town gathers for a grand potluck feast on the beach. Contribute an ingredient to the communal pot  the quality of your contribution determines the outcome!",activities:[{id:"potluck_contribution",name:"Potluck Contribution",description:"Add an ingredient to the communal pot. Higher-quality items yield a better feast."},{id:"beach_games",name:"Beach Games",description:"Participate in beach activities while the feast cooks."}],rewards:[{itemId:"luau_lei",quantity:1},{gold:750}]},{id:"moonlight_jellies",name:"Moonlight Jellies",season:"Summer",day:28,description:"On the last night of summer, the townsfolk gather at the beach to watch the rare moonlight jellies drift along the shore. A contemplative, magical event.",activities:[{id:"watch_jellies",name:"Watch the Jellies",description:"Gather at the docks and watch the bioluminescent jellies pass through the bay."},{id:"special_dialogue",name:"Starlit Conversations",description:"Share special dialogue with NPCs under the moonlit sky."}],rewards:[{itemId:"moonlight_jelly_charm",quantity:1},{gold:200}]},{id:"harvest_fair",name:"Harvest Fair",season:"Autumn",day:16,description:"The annual celebration of the harvest! Set up a grange display to be judged on the quality and variety of your crops, artisan goods, and foraged items.",activities:[{id:"grange_display",name:"Grange Display",description:"Arrange up to 9 items in your display case. Judged on quality, variety, and rarity."},{id:"fair_games",name:"Fair Games",description:"Play carnival mini-games to earn star tokens for prizes."}],rewards:[{itemId:"stardrop",quantity:1},{gold:1e3}]},{id:"spirits_eve",name:"Spirit's Eve",season:"Autumn",day:27,description:"A spooky celebration at the town square! Brave the haunted maze and discover its secrets for rare rewards.",activities:[{id:"haunted_maze",name:"Haunted Maze",description:"Navigate the haunted maze to find the golden pumpkin hidden at its center."},{id:"costume_contest",name:"Costume Contest",description:"Show off your spookiest outfit for a chance at prizes."}],rewards:[{itemId:"golden_pumpkin",quantity:1},{gold:500}]},{id:"ice_festival",name:"Ice Festival",season:"Winter",day:8,description:"Bundle up and head to the frozen lake for the annual ice fishing competition! Catch the most (or the rarest) fish to claim victory.",activities:[{id:"ice_fishing_competition",name:"Ice Fishing Competition",description:"Compete against the townsfolk to catch the most valuable fish through the ice."},{id:"ice_sculpting",name:"Ice Sculpting",description:"Admire the ice sculptures or try your hand at carving one."}],rewards:[{itemId:"ice_rod",quantity:1},{gold:600}]},{id:"feast_of_winter_star",name:"Feast of the Winter Star",season:"Winter",day:25,description:"The most heartwarming festival of the year! The whole town gathers for a grand feast and secret gift exchange. Each person is assigned a secret santa.",activities:[{id:"secret_santa",name:"Secret Gift Exchange",description:"Give a gift to your assigned townsfolk and receive one in return."},{id:"winter_feast",name:"Winter Feast",description:"Enjoy the grand communal feast with all the townsfolk."}],rewards:[{itemId:"winter_star_ornament",quantity:1},{gold:800}]}],Si=new Map(ft.map(r=>[r.id,r]));class El{states=new Map;currentYear=1;onFestivalStartCallbacks=[];onFestivalCompleteCallbacks=[];constructor(){this.resetStates()}resetStates(){this.states.clear();for(const e of ft)this.states.set(e.id,{attended:!1,completed:!1})}checkFestival(e,t){for(const i of ft)if(i.season===e&&i.day===t)return i;return null}getFestival(e){return Si.get(e)??null}getAllFestivals(){return[...ft]}getFestivalsBySeason(e){return ft.filter(t=>t.season===e)}hasAttended(e){return this.states.get(e)?.attended??!1}hasCompleted(e){return this.states.get(e)?.completed??!1}getAttendedFestivals(){const e=[];for(const[t,i]of this.states)i.attended&&e.push(t);return e}getCompletedFestivals(){const e=[];for(const[t,i]of this.states)i.completed&&e.push(t);return e}startFestival(e){const t=Si.get(e);if(!t)return!1;const i=this.states.get(e);if(!i||i.attended)return!1;i.attended=!0;for(const s of this.onFestivalStartCallbacks)s(t);return!0}completeFestival(e){const t=Si.get(e);if(!t)return null;const i=this.states.get(e);if(!i||!i.attended||i.completed)return null;i.completed=!0;for(const s of this.onFestivalCompleteCallbacks)s(t,t.rewards);return[...t.rewards]}advanceYear(e){this.currentYear=e,this.resetStates()}getCurrentYear(){return this.currentYear}onFestivalStart(e){this.onFestivalStartCallbacks.push(e)}onFestivalComplete(e){this.onFestivalCompleteCallbacks.push(e)}serialize(){const e={};for(const[t,i]of this.states)e[t]={...i};return{year:this.currentYear,states:e}}deserialize(e){if(this.currentYear=e?.year??1,this.resetStates(),e?.states)for(const[t,i]of Object.entries(e.states))this.states.has(t)&&this.states.set(t,{attended:i?.attended??!1,completed:i?.completed??!1})}}const ql=[{stage:"Stranger",minPoints:0},{stage:"Acquaintance",minPoints:50},{stage:"Friend",minPoints:100},{stage:"CloseFriend",minPoints:200},{stage:"Dating",minPoints:300},{stage:"Engaged",minPoints:400},{stage:"Married",minPoints:500}],ea=[2,4,6,8,10],Bl=250,Fl=8,zl={loved:80,liked:45,neutral:20,disliked:-20,hated:-40};class Hl{romanceStates=new Map;heartEventCallbacks=[];stageChangeCallbacks=[];constructor(){for(const e of At)this.romanceStates.set(e.id,{bouquetUsed:!1,pendantUsed:!1,married:!1,heartEventsSeen:new Set})}getStage(e,t){const i=this.romanceStates.get(e);if(i?.married)return"Married";if(i?.pendantUsed&&t>=400)return"Engaged";if(i?.bouquetUsed&&t>=300)return"Dating";let s="Stranger";for(const{stage:a,minPoints:o}of ql)a==="Dating"||a==="Engaged"||a==="Married"||t>=o&&(s=a);return s}getStageName(e,t){return this.getStage(e,t)}canDateNPC(e,t){const i=this.romanceStates.get(e);return!i||i.bouquetUsed||i.married?!1:t>=200}useBouquet(e,t){if(!this.canDateNPC(e,t))return!1;const i=this.romanceStates.get(e);if(!i)return!1;i.bouquetUsed=!0;for(const s of this.stageChangeCallbacks)s(e,"Dating");return!0}canProposeNPC(e,t){const i=this.romanceStates.get(e);return!i||!i.bouquetUsed||i.pendantUsed||i.married?!1:t>=300}usePendant(e,t){if(!this.canProposeNPC(e,t))return!1;const i=this.romanceStates.get(e);if(!i)return!1;i.pendantUsed=!0;for(const s of this.stageChangeCallbacks)s(e,"Engaged");return!0}marry(e,t){const i=this.romanceStates.get(e);if(!i||!i.pendantUsed||i.married||t<400)return!1;i.married=!0;for(const s of this.stageChangeCallbacks)s(e,"Married");return!0}isMarried(e){return this.romanceStates.get(e)?.married??!1}isDating(e){const t=this.romanceStates.get(e);return t?.bouquetUsed===!0&&!t?.married}getSpouse(){for(const[e,t]of this.romanceStates)if(t.married)return e;return null}getHeartEvents(e){const t=this.romanceStates.get(e);return t?Array.from(t.heartEventsSeen).sort((i,s)=>i-s):[]}markHeartEventSeen(e,t){const i=this.romanceStates.get(e);if(i&&ea.includes(t)&&!i.heartEventsSeen.has(t)){i.heartEventsSeen.add(t);for(const s of this.heartEventCallbacks)s(e,t)}}getAvailableHeartEvents(e,t){const i=this.romanceStates.get(e);if(!i)return[];const s=Math.floor(t/Bl),a=[];for(const o of ea)s>=o&&!i.heartEventsSeen.has(o)&&a.push(o);return a}hasSeenHeartEvent(e,t){return this.romanceStates.get(e)?.heartEventsSeen.has(t)??!1}getGiftPreference(e,t){const i=Ue.get(e);return i?i.gifts.loved.includes(t)?"loved":i.gifts.liked.includes(t)?"liked":i.gifts.hated.includes(t)?"hated":i.gifts.disliked.includes(t)?"disliked":"neutral":"neutral"}calculateGiftPoints(e,t,i=!1){const s=this.getGiftPreference(e,t);let a=zl[s];return i&&(a*=Fl),a}getGiftPreferences(e){return Ue.get(e)?.gifts??null}onHeartEvent(e){this.heartEventCallbacks.push(e)}onStageChange(e){this.stageChangeCallbacks.push(e)}serialize(){const e={};for(const[t,i]of this.romanceStates)e[t]={bouquetUsed:i.bouquetUsed,pendantUsed:i.pendantUsed,married:i.married,heartEventsSeen:Array.from(i.heartEventsSeen)};return{romanceStates:e}}deserialize(e){if(e?.romanceStates)for(const[t,i]of Object.entries(e.romanceStates)){let s=this.romanceStates.get(t);s||(s={bouquetUsed:!1,pendantUsed:!1,married:!1,heartEventsSeen:new Set},this.romanceStates.set(t,s)),s.bouquetUsed=i?.bouquetUsed??!1,s.pendantUsed=i?.pendantUsed??!1,s.married=i?.married??!1,s.heartEventsSeen=new Set(i?.heartEventsSeen??[])}}}const Za=[{id:"farmer",name:"Farmer",description:"Master the land and its bounty. Farmers earn more from crops and gain farming XP faster. Specializations unlock advanced growing techniques.",bonuses:{incomeMultiplier:1.2,xpMultiplier:1.15},xpPerLevel:[100,200,350,550,800,1100,1500,2e3,2600,3500],specializations:[{id:"rancher",name:"Rancher",description:"Animal products sell for 20% more. Animals have higher quality produce.",level:5,bonuses:{incomeMultiplier:1.2,xpMultiplier:1.1}},{id:"artisan",name:"Artisan",description:"Artisan goods (wine, cheese, preserves) sell for 40% more.",level:5,bonuses:{incomeMultiplier:1.4,xpMultiplier:1}},{id:"agriculturist",name:"Agriculturist",description:"Crops grow 10% faster. Rare seed yields doubled.",level:10,bonuses:{incomeMultiplier:1.1,xpMultiplier:1.2}},{id:"shepherd",name:"Shepherd",description:"Animals befriend faster. Wool and milk quality always gold-star.",level:10,bonuses:{incomeMultiplier:1.15,xpMultiplier:1.15}}]},{id:"fisher",name:"Fisher",description:"Rule the waters. Fishers catch rarer fish and earn more from their hauls. Specializations unlock legendary techniques.",bonuses:{incomeMultiplier:1.25,xpMultiplier:1.15},xpPerLevel:[80,180,320,500,750,1050,1400,1900,2500,3300],specializations:[{id:"angler",name:"Angler",description:"Fish sell for 50% more. Rare fish appear more frequently.",level:5,bonuses:{incomeMultiplier:1.5,xpMultiplier:1}},{id:"trapper",name:"Trapper",description:"Crab pots no longer require bait. Trap yield doubled.",level:5,bonuses:{incomeMultiplier:1.1,xpMultiplier:1.2}},{id:"pirate",name:"Pirate",description:"Chance to find treasure chests doubled while fishing.",level:10,bonuses:{incomeMultiplier:1.3,xpMultiplier:1.1}},{id:"mariner",name:"Mariner",description:"Crab pots never catch junk. Legendary fish easier to reel in.",level:10,bonuses:{incomeMultiplier:1.2,xpMultiplier:1.15}}]},{id:"tavern_keep",name:"TavernKeep",description:"Serve the community. TavernKeeps earn more from cooked meals and drinks, and gain social XP faster through conversations.",bonuses:{incomeMultiplier:1.15,xpMultiplier:1.2},xpPerLevel:[90,190,330,520,770,1080,1450,1950,2550,3400],specializations:[{id:"brewmaster",name:"Brewmaster",description:"Beverages sell for 35% more. New exclusive drink recipes unlocked.",level:5,bonuses:{incomeMultiplier:1.35,xpMultiplier:1.05}},{id:"host",name:"Host",description:"Friendship gained from talking is doubled. NPCs visit the tavern more often.",level:5,bonuses:{incomeMultiplier:1.1,xpMultiplier:1.25}},{id:"entertainer",name:"Entertainer",description:"Festival rewards doubled. Special festival dialogue options.",level:10,bonuses:{incomeMultiplier:1.2,xpMultiplier:1.2}},{id:"restaurateur",name:"Restaurateur",description:"All food items sell for 30% more. Tavern generates passive daily income.",level:10,bonuses:{incomeMultiplier:1.3,xpMultiplier:1.1}}]},{id:"chef",name:"Chef",description:"Culinary mastery at its finest. Chefs craft higher-quality food with better buffs and sell cooked dishes for premium prices.",bonuses:{incomeMultiplier:1.2,xpMultiplier:1.15},xpPerLevel:[100,200,350,550,800,1100,1500,2e3,2600,3500],specializations:[{id:"gourmet",name:"Gourmet",description:"Cooked dishes always have +1 quality star. Buff durations extended 25%.",level:5,bonuses:{incomeMultiplier:1.25,xpMultiplier:1.1}},{id:"baker",name:"Baker",description:"Baked goods heal 50% more. New exclusive pastry recipes unlocked.",level:5,bonuses:{incomeMultiplier:1.15,xpMultiplier:1.15}},{id:"master_chef",name:"Master Chef",description:"All cooking requires 1 fewer ingredient (min 1). Legendary recipe unlocked.",level:10,bonuses:{incomeMultiplier:1.3,xpMultiplier:1.15}},{id:"alchemist_chef",name:"Alchemist Chef",description:"Food can grant potion-like buffs. New fusion recipes unlocked.",level:10,bonuses:{incomeMultiplier:1.2,xpMultiplier:1.2}}]},{id:"adventurer",name:"Adventurer",description:"Seek glory in the dungeons. Adventurers deal more damage, find better loot, and gain combat XP faster.",bonuses:{incomeMultiplier:1.15,xpMultiplier:1.2},xpPerLevel:[120,250,400,600,900,1250,1700,2200,2900,3800],specializations:[{id:"warrior",name:"Warrior",description:"Melee damage +15%. Block chance +10%.",level:5,bonuses:{incomeMultiplier:1.1,xpMultiplier:1.15}},{id:"scout",name:"Scout",description:"Move 10% faster in dungeons. Trap detection range doubled.",level:5,bonuses:{incomeMultiplier:1.15,xpMultiplier:1.1}},{id:"champion",name:"Champion",description:"Critical hit chance +20%. Boss loot quality improved.",level:10,bonuses:{incomeMultiplier:1.25,xpMultiplier:1.15}},{id:"treasure_hunter",name:"Treasure Hunter",description:"Rare loot drop rate doubled. Secret rooms always revealed.",level:10,bonuses:{incomeMultiplier:1.35,xpMultiplier:1.1}}]}],Ot=new Map(Za.map(r=>[r.id,r]));class Ol{selectedCareerId=null;careerXP=0;careerLevel=0;selectedSpecializationIds=new Set;levelUpCallbacks=[];specializationCallbacks=[];selectCareer(e){return this.selectedCareerId!==null||!Ot.has(e)?!1:(this.selectedCareerId=e,this.careerXP=0,this.careerLevel=1,!0)}getCareer(){return this.selectedCareerId?Ot.get(this.selectedCareerId)??null:null}getCareerId(){return this.selectedCareerId}hasCareer(){return this.selectedCareerId!==null}addCareerXP(e){if(!this.selectedCareerId||e<=0)return;const t=Ot.get(this.selectedCareerId);if(!t)return;const i=this.careerLevel;this.careerXP+=e;const s=this.computeLevel(t);this.careerLevel=s;for(let a=i+1;a<=s;a++)for(const o of this.levelUpCallbacks)o(a)}getCareerLevel(){return this.careerLevel}getCareerXP(){if(!this.selectedCareerId)return{current:0,required:0,total:0};const e=Ot.get(this.selectedCareerId);if(!e)return{current:0,required:0,total:0};let t=0;for(let a=0;a<this.careerLevel-1&&a<e.xpPerLevel.length;a++)t+=e.xpPerLevel[a];const i=this.careerXP-t,s=this.careerLevel<=e.xpPerLevel.length?e.xpPerLevel[this.careerLevel-1]??0:0;return{current:Math.max(0,i),required:s,total:this.careerXP}}getAvailableSpecializations(){const e=this.getCareer();return e?e.specializations.filter(t=>t.level<=this.careerLevel&&!this.selectedSpecializationIds.has(t.id)):[]}selectSpecialization(e){const t=this.getCareer();if(!t)return!1;const i=t.specializations.find(a=>a.id===e);if(!i||i.level>this.careerLevel||t.specializations.some(a=>a.level===i.level&&this.selectedSpecializationIds.has(a.id)))return!1;this.selectedSpecializationIds.add(e);for(const a of this.specializationCallbacks)a(e);return!0}getSelectedSpecializations(){const e=this.getCareer();return e?e.specializations.filter(t=>this.selectedSpecializationIds.has(t.id)):[]}hasSpecialization(e){return this.selectedSpecializationIds.has(e)}getEffectiveIncomeMultiplier(){const e=this.getCareer();if(!e)return 1;let t=e.bonuses.incomeMultiplier;for(const i of this.getSelectedSpecializations())t*=i.bonuses.incomeMultiplier;return t}getEffectiveXPMultiplier(){const e=this.getCareer();if(!e)return 1;let t=e.bonuses.xpMultiplier;for(const i of this.getSelectedSpecializations())t*=i.bonuses.xpMultiplier;return t}onLevelUp(e){this.levelUpCallbacks.push(e)}onSpecialization(e){this.specializationCallbacks.push(e)}serialize(){return{selectedCareerId:this.selectedCareerId,careerXP:this.careerXP,careerLevel:this.careerLevel,selectedSpecializationIds:Array.from(this.selectedSpecializationIds)}}deserialize(e){this.selectedCareerId=e?.selectedCareerId??null,this.careerXP=e?.careerXP??0,this.careerLevel=e?.careerLevel??0,this.selectedSpecializationIds=new Set(e?.selectedSpecializationIds??[])}computeLevel(e){let t=this.careerXP;for(let i=0;i<e.xpPerLevel.length;i++){if(t<e.xpPerLevel[i])return i+1;t-=e.xpPerLevel[i]}return e.xpPerLevel.length+1>10?10:e.xpPerLevel.length+1}}const Pe=[{id:"crops_harvested",name:"Green Thumb",description:"Harvest crops from your farm.",category:"Farming",tiers:{bronze:50,silver:250,gold:1e3}},{id:"gold_star_crops",name:"Quality Farmer",description:"Harvest gold-star quality crops.",category:"Farming",tiers:{bronze:10,silver:50,gold:200}},{id:"seeds_planted",name:"Sower of Fields",description:"Plant seeds on your farm.",category:"Farming",tiers:{bronze:100,silver:500,gold:2e3}},{id:"animals_raised",name:"Animal Whisperer",description:"Raise farm animals to maximum happiness.",category:"Farming",tiers:{bronze:5,silver:15,gold:50}},{id:"artisan_goods_crafted",name:"Artisan Master",description:"Craft artisan goods (wine, cheese, preserves, etc.).",category:"Farming",tiers:{bronze:25,silver:100,gold:500}},{id:"total_gold_earned_farming",name:"Harvest Tycoon",description:"Earn gold from selling farm products.",category:"Farming",tiers:{bronze:5e3,silver:5e4,gold:5e5}},{id:"fish_caught",name:"Angler",description:"Catch fish from various bodies of water.",category:"Fishing",tiers:{bronze:25,silver:100,gold:500}},{id:"unique_fish_caught",name:"Ichthyologist",description:"Catch different species of fish.",category:"Fishing",tiers:{bronze:10,silver:25,gold:50}},{id:"legendary_fish_caught",name:"Legend of the Lake",description:"Catch legendary fish.",category:"Fishing",tiers:{bronze:1,silver:3,gold:5}},{id:"perfect_catches",name:"Perfect Cast",description:"Achieve perfect catches (fish never leaves the bar).",category:"Fishing",tiers:{bronze:10,silver:50,gold:200}},{id:"crab_pot_harvests",name:"Trap Master",description:"Harvest items from crab pots.",category:"Fishing",tiers:{bronze:25,silver:100,gold:500}},{id:"total_gold_earned_fishing",name:"Master Angler",description:"Earn gold from selling fish and seafood.",category:"Fishing",tiers:{bronze:2500,silver:25e3,gold:25e4}},{id:"enemies_defeated",name:"Monster Slayer",description:"Defeat enemies in combat.",category:"Combat",tiers:{bronze:50,silver:250,gold:1e3}},{id:"bosses_defeated",name:"Boss Hunter",description:"Defeat boss monsters.",category:"Combat",tiers:{bronze:3,silver:10,gold:25}},{id:"dungeon_floors_cleared",name:"Dungeon Delver",description:"Clear dungeon floors.",category:"Combat",tiers:{bronze:25,silver:100,gold:500}},{id:"critical_hits",name:"Precision Strike",description:"Land critical hits on enemies.",category:"Combat",tiers:{bronze:50,silver:250,gold:1e3}},{id:"rift_waves_survived",name:"Rift Walker",description:"Survive waves in the Rift.",category:"Combat",tiers:{bronze:10,silver:50,gold:200}},{id:"damage_dealt_total",name:"Wrath Incarnate",description:"Deal total damage to enemies.",category:"Combat",tiers:{bronze:1e4,silver:1e5,gold:1e6}},{id:"npcs_befriended",name:"Friendly Neighbor",description:"Reach 5+ hearts with different NPCs.",category:"Social",tiers:{bronze:3,silver:8,gold:15}},{id:"gifts_given",name:"Generous Soul",description:"Give gifts to NPCs.",category:"Social",tiers:{bronze:25,silver:100,gold:500}},{id:"heart_events_seen",name:"Storyteller",description:"Witness heart events with NPCs.",category:"Social",tiers:{bronze:5,silver:15,gold:40}},{id:"festivals_attended",name:"Life of the Party",description:"Attend seasonal festivals.",category:"Social",tiers:{bronze:4,silver:16,gold:40}},{id:"quests_completed",name:"Helpful Hand",description:"Complete quests for townsfolk.",category:"Social",tiers:{bronze:10,silver:30,gold:100}},{id:"npc_max_hearts",name:"Beloved",description:"Reach maximum hearts (10) with NPCs.",category:"Social",tiers:{bronze:1,silver:5,gold:10}},{id:"biomes_discovered",name:"Trailblazer",description:"Discover different biomes.",category:"Exploration",tiers:{bronze:2,silver:5,gold:7}},{id:"chunks_explored",name:"Cartographer",description:"Explore map chunks.",category:"Exploration",tiers:{bronze:50,silver:200,gold:1e3}},{id:"items_collected",name:"Collector",description:"Collect unique items.",category:"Exploration",tiers:{bronze:50,silver:150,gold:400}},{id:"treasure_chests_opened",name:"Fortune Seeker",description:"Open treasure chests found in the world.",category:"Exploration",tiers:{bronze:10,silver:50,gold:200}},{id:"corruption_purified",name:"Purifier",description:"Purify corrupted tiles.",category:"Exploration",tiers:{bronze:100,silver:500,gold:2e3}},{id:"secrets_found",name:"Secret Keeper",description:"Discover hidden secrets and locations.",category:"Exploration",tiers:{bronze:5,silver:15,gold:50}}],Mi=new Map(Pe.map(r=>[r.id,r]));class Ll{progress=new Map;onUnlockCallbacks=[];constructor(){for(const e of Pe)this.progress.set(e.id,0)}trackProgress(e,t=1){const i=Mi.get(e);if(!i||t<=0)return;const s=this.progress.get(e)??0,a=this.computeTier(i,s),o=s+t;this.progress.set(e,o);const n=this.computeTier(i,o);if(n!==a){const l=["none","bronze","silver","gold"],c=l.indexOf(a),d=l.indexOf(n);for(let h=c+1;h<=d;h++){const u=l[h];if(u!=="none")for(const m of this.onUnlockCallbacks)m(e,u)}}}setProgress(e,t){const i=Mi.get(e);if(!i)return;const s=this.progress.get(e)??0;if(t<=s)return;const a=this.computeTier(i,s);this.progress.set(e,t);const o=this.computeTier(i,t);if(o!==a){const n=["none","bronze","silver","gold"],l=n.indexOf(a),c=n.indexOf(o);for(let d=l+1;d<=c;d++){const h=n[d];if(h!=="none")for(const u of this.onUnlockCallbacks)u(e,h)}}}getAchievementProgress(e){const t=Mi.get(e);if(!t)return null;const i=this.progress.get(e)??0,s=this.computeTier(t,i);return{id:t.id,name:t.name,description:t.description,category:t.category,currentValue:i,tier:s,tiers:{...t.tiers}}}getUnlocked(){const e=[];for(const t of Pe){const i=this.progress.get(t.id)??0,s=this.computeTier(t,i);s!=="none"&&e.push({id:t.id,name:t.name,description:t.description,category:t.category,currentValue:i,tier:s,tiers:{...t.tiers}})}return e}getByCategory(e){return Pe.filter(t=>t.category===e).map(t=>{const i=this.progress.get(t.id)??0;return{id:t.id,name:t.name,description:t.description,category:t.category,currentValue:i,tier:this.computeTier(t,i),tiers:{...t.tiers}}})}getAllAchievements(){return Pe.map(e=>{const t=this.progress.get(e.id)??0;return{id:e.id,name:e.name,description:e.description,category:e.category,currentValue:t,tier:this.computeTier(e,t),tiers:{...e.tiers}}})}getGoldCount(){let e=0;for(const t of Pe)(this.progress.get(t.id)??0)>=t.tiers.gold&&e++;return e}getCompletionPercentage(){let e=0,t=0;for(const i of Pe){e+=3;const s=this.progress.get(i.id)??0;s>=i.tiers.bronze&&t++,s>=i.tiers.silver&&t++,s>=i.tiers.gold&&t++}return e>0?t/e*100:0}onAchievementUnlock(e){this.onUnlockCallbacks.push(e)}serialize(){const e={};for(const[t,i]of this.progress)i>0&&(e[t]=i);return{progress:e}}deserialize(e){for(const t of Pe)this.progress.set(t.id,0);if(e?.progress)for(const[t,i]of Object.entries(e.progress))this.progress.has(t)&&this.progress.set(t,i??0)}computeTier(e,t){return t>=e.tiers.gold?"gold":t>=e.tiers.silver?"silver":t>=e.tiers.bronze?"bronze":"none"}}class Wl{inbox=[];nextMailId=1;onMailReceivedCallbacks=[];addMail(e){const t={id:e.id??`mail_${this.nextMailId++}`,senderId:e.senderId,subject:e.subject,body:e.body,attachments:e.attachments??[],sentDay:e.sentDay,readAt:null,attachmentsClaimed:!1};e.id,this.inbox.unshift(t);for(const i of this.onMailReceivedCallbacks)i(t);return t}sendRelationshipMilestoneMail(e,t,i,s){return this.addMail({senderId:e,subject:`From ${t}`,body:`Dear Farmer,

I just wanted to say thank you for being such a wonderful friend. Here's a small token of my appreciation.

With ${i>=8?"love":"warm regards"},
${t}`,attachments:[{gold:i*100}],sentDay:s})}sendStoryEventMail(e,t,i,s){return this.addMail({senderId:"system",subject:e,body:t,attachments:i,sentDay:s})}sendBirthdayMail(e,t,i){return this.addMail({senderId:e,subject:`${t}'s Birthday`,body:`It's ${t}'s birthday today! Don't forget to stop by and say happy birthday. A thoughtful gift would mean the world to them.`,attachments:[],sentDay:i})}sendFestivalAnnouncementMail(e,t,i,s){return this.addMail({senderId:"system",subject:`Festival Announcement: ${e}`,body:`The ${e} is coming up on ${t} ${i}! Head to the town square to join in the festivities. Don't miss out on the fun and prizes!`,attachments:[],sentDay:s})}getUnread(){return this.inbox.filter(e=>e.readAt===null)}getUnreadCount(){return this.inbox.filter(e=>e.readAt===null).length}markRead(e,t){const i=this.inbox.find(s=>s.id===e);return!i||i.readAt!==null?!1:(i.readAt=t,!0)}claimAttachments(e){const t=this.inbox.find(i=>i.id===e);return!t||t.attachmentsClaimed||t.attachments.length===0?null:(t.attachmentsClaimed=!0,[...t.attachments])}hasUnclaimedAttachments(e){const t=this.inbox.find(i=>i.id===e);return t?!t.attachmentsClaimed&&t.attachments.length>0:!1}getAllMail(){return[...this.inbox]}getMail(e){return this.inbox.find(t=>t.id===e)??null}getMailFromSender(e){return this.inbox.filter(t=>t.senderId===e)}getMailCount(){return this.inbox.length}deleteMail(e){const t=this.inbox.findIndex(i=>i.id===e);return t===-1?!1:(this.inbox.splice(t,1),!0)}onMailReceived(e){this.onMailReceivedCallbacks.push(e)}serialize(){return{inbox:this.inbox.map(e=>({...e,attachments:[...e.attachments]})),nextMailId:this.nextMailId}}deserialize(e){if(this.inbox=[],this.nextMailId=e?.nextMailId??1,e?.inbox)for(const t of e.inbox)this.inbox.push({id:t.id??`mail_${this.nextMailId++}`,senderId:t.senderId??"system",subject:t.subject??"",body:t.body??"",attachments:t.attachments??[],sentDay:t.sentDay??0,readAt:t.readAt??null,attachmentsClaimed:t.attachmentsClaimed??!1})}}const Lt=36;class Nl{containers=new Map;nextStorageId=1;onStorageChangedCallbacks=[];createStorage(e,t,i,s="Chest"){const a=`storage_${this.nextStorageId++}`,o={id:a,x:e,y:t,sceneId:i,slots:Array.from({length:Lt},()=>({itemId:"",quantity:0})),label:s};return this.containers.set(a,o),a}removeStorage(e){return this.containers.delete(e)}getStorage(e){const t=this.containers.get(e);return t?{...t,slots:t.slots.map(i=>({...i}))}:null}getAllStorages(e){const t=[];for(const i of this.containers.values())i.sceneId===e&&t.push({...i,slots:i.slots.map(s=>({...s}))});return t}getAllStorageIds(){return Array.from(this.containers.keys())}setLabel(e,t){const i=this.containers.get(e);return i?(i.label=t,!0):!1}addItemToStorage(e,t,i,s=99){const a=this.containers.get(e);if(!a||i<=0)return i;let o=i;for(const n of a.slots){if(o<=0)break;if(n.itemId===t&&n.quantity<s){const l=Math.min(o,s-n.quantity);n.quantity+=l,o-=l}}for(const n of a.slots){if(o<=0)break;if(n.itemId===""){const l=Math.min(o,s);n.itemId=t,n.quantity=l,o-=l}}return this.emitStorageChanged(e),o}removeItemFromStorage(e,t,i){const s=this.containers.get(e);if(!s||i<=0)return 0;let a=i;for(const o of s.slots){if(a<=0)break;if(o.itemId===t){const n=Math.min(a,o.quantity);o.quantity-=n,a-=n,o.quantity<=0&&(o.itemId="",o.quantity=0)}}return this.emitStorageChanged(e),i-a}hasItem(e,t,i=1){const s=this.containers.get(e);if(!s)return!1;let a=0;for(const o of s.slots)o.itemId===t&&(a+=o.quantity);return a>=i}countItem(e,t){const i=this.containers.get(e);if(!i)return 0;let s=0;for(const a of i.slots)a.itemId===t&&(s+=a.quantity);return s}getItems(e){const t=this.containers.get(e);return t?t.slots.filter(i=>i.itemId!=="").map(i=>({...i})):[]}isFull(e){const t=this.containers.get(e);return t?t.slots.every(i=>i.itemId!==""):!0}getEmptySlotCount(e){const t=this.containers.get(e);return t?t.slots.filter(i=>i.itemId==="").length:0}swapSlots(e,t,i){const s=this.containers.get(e);if(!s||t<0||t>=Lt||i<0||i>=Lt)return!1;const a=s.slots[t];return s.slots[t]=s.slots[i],s.slots[i]=a,this.emitStorageChanged(e),!0}updateSlots(e,t){const i=this.containers.get(e);if(!i)return!1;for(let s=0;s<i.slots.length&&s<t.length;s++)i.slots[s].itemId=t[s].itemId,i.slots[s].quantity=t[s].quantity;return this.emitStorageChanged(e),!0}onStorageChanged(e){this.onStorageChangedCallbacks.push(e)}emitStorageChanged(e){for(const t of this.onStorageChangedCallbacks)t(e)}serialize(){const e={};for(const[t,i]of this.containers)e[t]={id:i.id,x:i.x,y:i.y,sceneId:i.sceneId,slots:i.slots.map(s=>({...s})),label:i.label};return{containers:e,nextStorageId:this.nextStorageId}}deserialize(e){if(this.containers.clear(),this.nextStorageId=e?.nextStorageId??1,e?.containers)for(const[t,i]of Object.entries(e.containers)){const s=Array.from({length:Lt},(a,o)=>{const n=i.slots?.[o];return{itemId:n?.itemId??"",quantity:n?.quantity??0}});this.containers.set(t,{id:i.id??t,x:i.x??0,y:i.y??0,sceneId:i.sceneId??"",slots:s,label:i.label??"Chest"})}}}const ta={haven:20,rotwood:18,ashlands:45,drowned:15,bone_wastes:35,the_void:5,edilas:22},ia={Spring:0,Summer:10,Autumn:-5,Winter:-15},sa={clear:2,cloudy:0,rain:-3,storm:-5,snow:-10,fog:-2,sandstorm:5,acid_rain:-3,ember_rain:8,spore_cloud:0,void_storm:-12,corruption_storm:-8},aa=[{startHour:5,endHour:7,modifier:-2,label:"dawn"},{startHour:7,endHour:18,modifier:0,label:"day"},{startHour:18,endHour:22,modifier:-2,label:"dusk"}],Ql=-5,ra=10,oa=35,Gl=.5,Ul=2;class $l{lastTemperature=20;coldExposureTime=0;heatExposureTime=0;comfortChangeCallbacks=[];lastComfort={comfortable:!0,tooHot:!1,tooCold:!1};getTemperature(e,t,i,s){const a=ta[e]??20,o=ia[t]??0,n=sa[i]??0,l=this.getTimeModifier(s);return a+o+n+l}update(e,t,i,s,a){this.lastTemperature=this.getTemperature(e,t,i,s);const o=this.getPlayerComfort(this.lastTemperature);if(o.tooCold?(this.coldExposureTime+=a,this.heatExposureTime=Math.max(0,this.heatExposureTime-a)):o.tooHot?(this.heatExposureTime+=a,this.coldExposureTime=Math.max(0,this.coldExposureTime-a)):(this.coldExposureTime=Math.max(0,this.coldExposureTime-a*2),this.heatExposureTime=Math.max(0,this.heatExposureTime-a*2)),o.comfortable!==this.lastComfort.comfortable||o.tooHot!==this.lastComfort.tooHot||o.tooCold!==this.lastComfort.tooCold){this.lastComfort={...o};for(const n of this.comfortChangeCallbacks)n(o)}}getPlayerComfort(e){return{comfortable:e>=ra&&e<=oa,tooHot:e>oa,tooCold:e<ra}}getTemperatureEffects(){const e=this.getPlayerComfort(this.lastTemperature);return{staminaRegenMultiplier:e.tooCold?Gl:1,staminaDrainMultiplier:e.tooHot?Ul:1}}getLastTemperature(){return this.lastTemperature}getLastComfort(){return{...this.lastComfort}}getColdExposureTime(){return this.coldExposureTime}getHeatExposureTime(){return this.heatExposureTime}getBiomeBaseTemp(e){return ta[e]??20}getSeasonModifier(e){return ia[e]??0}getWeatherModifier(e){return sa[e]??0}getTimePeriod(e){for(const t of aa)if(e>=t.startHour&&e<t.endHour)return t.label;return"night"}getTemperatureString(e){return`${Math.round(e)}C`}onComfortChange(e){this.comfortChangeCallbacks.push(e)}serialize(){return{lastTemperature:this.lastTemperature,coldExposureTime:this.coldExposureTime,heatExposureTime:this.heatExposureTime}}deserialize(e){this.lastTemperature=e?.lastTemperature??20,this.coldExposureTime=e?.coldExposureTime??0,this.heatExposureTime=e?.heatExposureTime??0}getTimeModifier(e){for(const t of aa)if(e>=t.startHour&&e<t.endHour)return t.modifier;return Ql}}const jl=["void_essence","shadow_silk","corruption_crystal","dark_iron","phantom_wood","abyssal_pearl","nightmare_dust","echo_shard"],na=5e3,Vl=6e4,Yl=1.5;class Xl{inShadowWorld=!1;channeling=!1;channelStartTime=0;lastExitTime=0;currentTime=0;shadowInventory=new Map;enterCallbacks=[];exitCallbacks=[];update(e){if(this.currentTime=e,this.channeling&&this.currentTime-this.channelStartTime>=na){this.channeling=!1,this.inShadowWorld=!0;for(const t of this.enterCallbacks)t()}}enterShadowWorld(){return this.inShadowWorld||this.channeling||this.getCooldownRemaining()>0?!1:(this.channeling=!0,this.channelStartTime=this.currentTime,!0)}exitShadowWorld(){if(!this.inShadowWorld)return!1;this.inShadowWorld=!1,this.lastExitTime=this.currentTime;for(const e of this.exitCallbacks)e();return!0}cancelChannel(){return this.channeling?(this.channeling=!1,this.channelStartTime=0,!0):!1}isInShadowWorld(){return this.inShadowWorld}isChanneling(){return this.channeling}getChannelRemaining(){if(!this.channeling)return 0;const e=this.currentTime-this.channelStartTime;return Math.max(0,(na-e)/1e3)}getCooldownRemaining(){if(this.lastExitTime===0)return 0;const e=this.currentTime-this.lastExitTime;return Math.max(0,(Vl-e)/1e3)}getShadowStatMultiplier(){return this.inShadowWorld?Yl:1}isShadowResource(e){return jl.includes(e)}addShadowResource(e,t){if(!this.isShadowResource(e)||t<=0)return!1;const i=this.shadowInventory.get(e)??0;return this.shadowInventory.set(e,i+t),!0}getShadowResource(e){return this.shadowInventory.get(e)??0}getAllShadowResources(){const e={};for(const[t,i]of this.shadowInventory)e[t]=i;return e}onEnter(e){this.enterCallbacks.push(e)}onExit(e){this.exitCallbacks.push(e)}serialize(){const e={};for(const[t,i]of this.shadowInventory)e[t]=i;return{inShadowWorld:this.inShadowWorld,channeling:this.channeling,channelStartTime:this.channelStartTime,lastExitTime:this.lastExitTime,shadowInventory:e}}deserialize(e){if(this.inShadowWorld=e.inShadowWorld??!1,this.channeling=e.channeling??!1,this.channelStartTime=e.channelStartTime??0,this.lastExitTime=e.lastExitTime??0,this.shadowInventory.clear(),e.shadowInventory)for(const[t,i]of Object.entries(e.shadowInventory))this.shadowInventory.set(t,i)}}const Kl=12,Wt=10,ct=[0,100,300,600,1e3,1500,2100,2800,3600,4500],Jl=50,la={1:{shopTier:1,npcName:"Merchant",service:"basic_shop"},2:{shopTier:1,npcName:"Blacksmith",service:"repair"},3:{shopTier:2,npcName:"Alchemist",service:"potions"},4:{shopTier:2,npcName:"Enchanter",service:"enchanting"},5:{shopTier:3,npcName:"Master Craftsman",service:"advanced_crafting"},6:{shopTier:3,npcName:"Banker",service:"banking"},7:{shopTier:4,npcName:"Lorekeeper",service:"quest_board"},8:{shopTier:4,npcName:"War Marshal",service:"mercenaries"},9:{shopTier:5,npcName:"Archmage",service:"teleportation"},10:{shopTier:5,npcName:"Grand Steward",service:"passive_income"}};class Zl{cities=new Map;levelUpCallbacks=[];registerCity(e){return this.cities.has(e)||this.cities.size>=Kl?!1:(this.cities.set(e,{xp:0}),!0)}addCityXP(e,t){const i=this.cities.get(e);if(!i||t<=0)return!1;const s=this.getLevelFromXP(i.xp);i.xp+=t;const a=this.getLevelFromXP(i.xp);if(a>s)for(let o=s+1;o<=a;o++)for(const n of this.levelUpCallbacks)n(e,o);return!0}getCityLevel(e){const t=this.cities.get(e);return t?this.getLevelFromXP(t.xp):1}getCityXPProgress(e){const t=this.cities.get(e);if(!t)return{current:0,needed:ct[1],level:1};const i=this.getLevelFromXP(t.xp),s=ct[i-1]??0,a=i<Wt?ct[i]??s:s;return{current:t.xp-s,needed:i<Wt?a-s:0,level:i}}getCityUnlocks(e){return la[e]??null}getAllUnlocksForCity(e){const t=this.getCityLevel(e),i=[];for(let s=1;s<=t;s++){const a=la[s];a&&i.push(a)}return i}getPassiveIncome(e){return this.getCityLevel(e)<Wt?0:Jl}getTotalPassiveIncome(){let e=0;for(const t of this.cities.keys())e+=this.getPassiveIncome(t);return e}getAllCityIds(){return Array.from(this.cities.keys())}hasCity(e){return this.cities.has(e)}onCityLevelUp(e){this.levelUpCallbacks.push(e)}getLevelFromXP(e){let t=1;for(let i=1;i<ct.length&&e>=ct[i];i++)t=i+1;return Math.min(t,Wt)}serialize(){const e={};for(const[t,i]of this.cities)e[t]={...i};return{cities:e}}deserialize(e){if(this.cities.clear(),e.cities)for(const[t,i]of Object.entries(e.cities))this.cities.set(t,{xp:i.xp??0})}}const Ti=5,ec={0:1,1:1.5,2:2,3:3,4:4,5:5},ca=new Set(["gold","items","skills","relationships","achievements","titles"]),tc=[{id:"galaxy_soul",name:"Galaxy Soul",description:"A crystallized fragment of the cosmos, pulsing with infinite energy.",unlockedAtCycle:1},{id:"prismatic_ring",name:"Prismatic Ring",description:"A ring that refracts light into all colors, granting elemental mastery.",unlockedAtCycle:2},{id:"infinity_blade",name:"Infinity Blade",description:"A weapon forged beyond the boundaries of time, its edge never dulls.",unlockedAtCycle:3},{id:"celestial_orb",name:"Celestial Orb",description:"An orb containing a trapped star, radiating immense power.",unlockedAtCycle:4},{id:"void_amulet",name:"Void Amulet",description:"An amulet from the space between worlds, granting passage through the void.",unlockedAtCycle:5}];class ic{cycle=0;carryoverOptions=new Set;newGamePlusStartCallbacks=[];constructor(){}startNewGamePlus(e){if(this.cycle>=Ti)return!1;this.cycle++,this.carryoverOptions=new Set([...e].filter(t=>ca.has(t)));for(const t of this.newGamePlusStartCallbacks)t(this.cycle,this.carryoverOptions);return!0}getDifficultyMultiplier(){return ec[this.cycle]??1}getCycle(){return this.cycle}isNewGamePlus(){return this.cycle>0}getCarryoverOptions(){return new Set(this.carryoverOptions)}hasCarryover(e){return this.carryoverOptions.has(e)}getExclusiveItems(){return tc.filter(e=>e.unlockedAtCycle<=this.cycle)}getValidCarryoverOptions(){return Array.from(ca)}getMaxCycle(){return Ti}onNewGamePlusStart(e){this.newGamePlusStartCallbacks.push(e)}serialize(){return{cycle:this.cycle,carryoverOptions:Array.from(this.carryoverOptions)}}deserialize(e){this.cycle=Math.min(Math.max(e.cycle??0,0),Ti),this.carryoverOptions=new Set(e.carryoverOptions??[])}}const tt=[{id:"discoverAllCities",name:"World Explorer",description:"Discover all 12 cities across the world of EDILAS.",required:12},{id:"maxLevelCities",name:"City Builder",description:"Raise at least 3 cities to their maximum level (10).",required:3},{id:"masterWeapon",name:"Weapon Master",description:"Master at least 1 weapon type by reaching mastery level 20.",required:1},{id:"defeatGateBosses",name:"Gate Breaker",description:"Defeat all 7 gate bosses guarding the regions of EDILAS.",required:7},{id:"collectAncientSeals",name:"Seal Collector",description:"Collect all 3 ancient seals from dungeon seal floors (50, 75, and 100).",required:3}],da=new Map(tt.map(r=>[r.id,r]));class sc{requirements=new Map;portalUnlocked=!1;portalUnlockCallbacks=[];constructor(){for(const e of tt)this.requirements.set(e.id,{current:0})}checkRequirement(e,t){if(!da.get(e))return;const s=this.requirements.get(e);if(s&&(s.current=Math.max(s.current,t),!this.portalUnlocked&&this.allRequirementsMet())){this.portalUnlocked=!0;for(const a of this.portalUnlockCallbacks)a()}}isPortalUnlocked(){return this.portalUnlocked}getRequirements(){return tt.map(e=>{const i=this.requirements.get(e.id)?.current??0;return{id:e.id,name:e.name,description:e.description,current:Math.min(i,e.required),required:e.required,completed:i>=e.required}})}getRequirement(e){const t=da.get(e);if(!t)return null;const s=this.requirements.get(e)?.current??0;return{id:t.id,name:t.name,description:t.description,current:Math.min(s,t.required),required:t.required,completed:s>=t.required}}getCompletedCount(){let e=0;for(const t of tt){const i=this.requirements.get(t.id);i&&i.current>=t.required&&e++}return e}getTotalCount(){return tt.length}onPortalUnlock(e){this.portalUnlockCallbacks.push(e)}serialize(){const e={};for(const[t,i]of this.requirements)e[t]={current:i.current};return{requirements:e,portalUnlocked:this.portalUnlocked}}deserialize(e){if(this.portalUnlocked=e.portalUnlocked??!1,e.requirements)for(const[t,i]of Object.entries(e.requirements))this.requirements.has(t)&&this.requirements.set(t,{current:i.current??0})}allRequirementsMet(){for(const e of tt){const t=this.requirements.get(e.id);if(!t||t.current<e.required)return!1}return!0}}const Kt=[{key:"first_tool_use",title:"Using Tools",body:"Equip a tool from your inventory and use it on the world. Different tools work on different objects  try your axe on trees and your pickaxe on rocks.",dismissable:!0},{key:"first_crop",title:"Planting Crops",body:"Till the soil with your hoe, plant a seed, and water it daily. Crops take several days to grow  check back often!",dismissable:!0},{key:"first_combat",title:"Combat Basics",body:"Attack enemies with your equipped weapon. Watch your health bar and dodge incoming attacks. Use potions to heal when needed.",dismissable:!0},{key:"first_npc",title:"Meeting NPCs",body:"Talk to NPCs to learn about the world, accept quests, and build relationships. Give gifts to increase your friendship level.",dismissable:!0},{key:"first_dungeon",title:"Entering Dungeons",body:"Dungeons are dangerous multi-floor challenges. Prepare with food, potions, and upgraded gear before descending deeper.",dismissable:!0},{key:"first_crafting",title:"Crafting Items",body:"Visit a crafting station to combine materials into new items. Recipes unlock as you discover new materials and level up your skills.",dismissable:!0},{key:"first_fishing",title:"Fishing",body:"Cast your line into water and wait for a bite. Time your catch carefully  rarer fish are harder to reel in.",dismissable:!0},{key:"first_cooking",title:"Cooking Meals",body:"Use a kitchen to cook meals from ingredients. Cooked food restores more health and energy than raw ingredients.",dismissable:!0},{key:"first_quest",title:"Your First Quest",body:"Check the quest log to see your objectives. Complete all objectives to earn rewards like gold, items, and experience.",dismissable:!0},{key:"first_boss",title:"Boss Encounter",body:"Bosses are powerful enemies with unique attack patterns. Study their moves, dodge carefully, and strike when they are vulnerable.",dismissable:!1}],ha=new Map(Kt.map(r=>[r.key,r]));class ac{shownTips=new Set;tipShowCallbacks=[];constructor(){}showTip(e){if(this.shownTips.has(e))return!1;const t=ha.get(e);if(!t)return!1;this.shownTips.add(e);for(const i of this.tipShowCallbacks)i(t);return!0}hasSeen(e){return this.shownTips.has(e)}dismiss(e){this.shownTips.add(e)}getAllTips(){return[...Kt]}getTip(e){return ha.get(e)??null}getShownCount(){return this.shownTips.size}getTotalCount(){return Kt.length}getUnseenTips(){return Kt.filter(e=>!this.shownTips.has(e.key)).map(e=>e.key)}onTipShow(e){this.tipShowCallbacks.push(e)}serialize(){return{shownTips:Array.from(this.shownTips)}}deserialize(e){this.shownTips=new Set(e.shownTips??[])}}const er=[{id:"player_home",name:"Your Home",width:12,height:10,exits:[{x:6,y:9,targetScene:"overworld",targetX:50,targetY:52}]},{id:"general_store",name:"General Store",width:14,height:10,exits:[{x:7,y:9,targetScene:"overworld",targetX:45,targetY:40}]},{id:"blacksmith",name:"Blacksmith",width:12,height:12,exits:[{x:6,y:11,targetScene:"overworld",targetX:55,targetY:40}]},{id:"tavern",name:"Tavern",width:16,height:12,exits:[{x:8,y:11,targetScene:"overworld",targetX:60,targetY:45}]},{id:"inn",name:"Inn",width:14,height:14,exits:[{x:7,y:13,targetScene:"overworld",targetX:65,targetY:45}]},{id:"library",name:"Library",width:16,height:10,exits:[{x:8,y:9,targetScene:"overworld",targetX:40,targetY:50}]},{id:"temple",name:"Temple",width:18,height:14,exits:[{x:9,y:13,targetScene:"overworld",targetX:50,targetY:35}]},{id:"mayor_house",name:"Mayor's House",width:14,height:12,exits:[{x:7,y:11,targetScene:"overworld",targetX:48,targetY:38}]},{id:"farmer_house",name:"Farmer's House",width:10,height:8,exits:[{x:5,y:7,targetScene:"overworld",targetX:35,targetY:55}]},{id:"fisher_house",name:"Fisher's House",width:10,height:8,exits:[{x:5,y:7,targetScene:"overworld",targetX:70,targetY:60}]},{id:"wizard_tower",name:"Wizard's Tower",width:10,height:16,exits:[{x:5,y:15,targetScene:"overworld",targetX:30,targetY:30}]},{id:"guard_barracks",name:"Guard Barracks",width:16,height:10,exits:[{x:8,y:9,targetScene:"overworld",targetX:55,targetY:35}]}],Ci=new Map(er.map(r=>[r.id,r]));class rc{currentInterior=null;enterCallbacks=[];exitCallbacks=[];constructor(){}enterInterior(e){const t=Ci.get(e);if(!t)return!1;this.currentInterior=e;for(const i of this.enterCallbacks)i(e,t);return!0}exitInterior(){if(this.currentInterior===null)return!1;const e=this.currentInterior;this.currentInterior=null;for(const t of this.exitCallbacks)t(e);return!0}getCurrentInterior(){return this.currentInterior}isInInterior(){return this.currentInterior!==null}getInteriorDef(e){return Ci.get(e)??null}getAllInteriors(){return[...er]}getCurrentInteriorDef(){return this.currentInterior===null?null:Ci.get(this.currentInterior)??null}onEnterInterior(e){this.enterCallbacks.push(e)}onExitInterior(e){this.exitCallbacks.push(e)}serialize(){return{currentInterior:this.currentInterior}}deserialize(e){this.currentInterior=e.currentInterior??null}}const yt=[{id:"legend_of_the_void",name:"Legend of the Void",description:"Unravel the mystery of the Void and defeat the Shadow Lord who dwells within.",stages:[{id:"gather_void_essence",name:"Gather Void Essence",description:"Collect 50 Void Essence from corrupted enemies.",required:50},{id:"find_void_portal",name:"Find the Void Portal",description:"Locate the hidden Void Portal in the depths of the world.",required:1},{id:"defeat_shadow_lord",name:"Defeat the Shadow Lord",description:"Confront and defeat the Shadow Lord within the Void.",required:1}],reward:{items:[],title:"Voidwalker"}},{id:"dragon_slayer",name:"Dragon Slayer",description:"Forge the legendary Dragonbane and slay the Ancient Dragon terrorizing the realm.",stages:[{id:"forge_dragonbane",name:"Forge Dragonbane",description:"Forge the legendary Dragonbane sword from ancient materials.",required:1},{id:"collect_dragon_scales",name:"Collect Dragon Scales",description:"Collect 20 Dragon Scales from lesser dragons.",required:20},{id:"slay_ancient_dragon",name:"Slay the Ancient Dragon",description:"Defeat the Ancient Dragon in its mountain lair.",required:1}],reward:{items:["dragon_mount"],title:"Dragon Slayer"}},{id:"king_of_the_sea",name:"King of the Sea",description:"Catch every legendary fish to prove your mastery of the ocean.",stages:[{id:"catch_legend",name:"Catch the Legend",description:"Catch the mythical Legend fish.",required:1},{id:"catch_glacierfish",name:"Catch the Glacierfish",description:"Catch the elusive Glacierfish in frozen waters.",required:1},{id:"catch_crimsonfish",name:"Catch the Crimsonfish",description:"Catch the Crimsonfish in the volcanic sea.",required:1},{id:"catch_angler",name:"Catch the Angler",description:"Catch the Angler in the deepest ocean trench.",required:1},{id:"catch_mutant_carp",name:"Catch the Mutant Carp",description:"Catch the Mutant Carp in the toxic swamp.",required:1}],reward:{items:["neptunes_trident"],title:"King of the Sea"}},{id:"the_ancient_fruit",name:"The Ancient Fruit",description:"Rediscover the lost Ancient Fruit and create the most prized wine in the world.",stages:[{id:"find_ancient_seed",name:"Find the Ancient Seed",description:"Discover an Ancient Seed buried deep in the ruins.",required:1},{id:"grow_ancient_fruit",name:"Grow the Ancient Fruit",description:"Grow the Ancient Fruit to full maturity.",required:1},{id:"craft_ancient_wine_gold",name:"Craft Gold Ancient Wine",description:"Age the Ancient Fruit into gold-quality Ancient Wine.",required:1}],reward:{items:["ancient_greenhouse"],title:"Ancient Cultivator"}},{id:"world_purifier",name:"World Purifier",description:"Cleanse every corrupted region and restore EDILAS to its former glory.",stages:[{id:"purify_haven",name:"Purify Haven",description:"Cleanse the corruption from Haven.",required:1},{id:"purify_rotwood",name:"Purify Rotwood",description:"Cleanse the corruption from Rotwood Forest.",required:1},{id:"purify_ashlands",name:"Purify the Ashlands",description:"Cleanse the corruption from the Ashlands.",required:1},{id:"purify_drowned",name:"Purify the Drowned Coast",description:"Cleanse the corruption from the Drowned Coast.",required:1},{id:"purify_bone_wastes",name:"Purify the Bone Wastes",description:"Cleanse the corruption from the Bone Wastes.",required:1},{id:"purify_the_void",name:"Purify the Void",description:"Cleanse the corruption from the Void.",required:1},{id:"purify_edilas",name:"Purify EDILAS",description:"Perform the final purification ritual to heal the world.",required:1}],reward:{items:["world_healing_aura"],title:"Guardian"}}],Nt=new Map(yt.map(r=>[r.id,r]));class oc{progress=new Map;questCompleteCallbacks=[];stageCompleteCallbacks=[];constructor(){for(const e of yt)this.progress.set(e.id,{currentStageIndex:0,stageProgress:0,started:!1,completed:!1})}startQuest(e){if(!Nt.get(e))return!1;const i=this.progress.get(e);return!i||i.started?!1:(i.started=!0,i.currentStageIndex=0,i.stageProgress=0,!0)}advanceStage(e,t,i=1){const s=Nt.get(e);if(!s)return!1;const a=this.progress.get(e);if(!a||!a.started||a.completed)return!1;const o=s.stages[a.currentStageIndex];if(!o||o.id!==t)return!1;if(a.stageProgress=Math.min(a.stageProgress+i,o.required),a.stageProgress>=o.required){const n=a.currentStageIndex,l=o.id;for(const c of this.stageCompleteCallbacks)c(e,l,n);if(a.currentStageIndex+1>=s.stages.length){a.completed=!0;for(const c of this.questCompleteCallbacks)c(e,s.reward)}else a.currentStageIndex++,a.stageProgress=0}return!0}isQuestComplete(e){return this.progress.get(e)?.completed??!1}getQuestProgress(e){const t=Nt.get(e);if(!t)return null;const i=this.progress.get(e);return i?{quest:t,currentStageIndex:i.currentStageIndex,stageProgress:i.stageProgress,started:i.started,completed:i.completed}:null}getActiveQuests(){const e=[];for(const t of yt){const i=this.progress.get(t.id);i&&i.started&&!i.completed&&e.push(t)}return e}getCompletedQuests(){const e=[];for(const t of yt){const i=this.progress.get(t.id);i&&i.completed&&e.push(t)}return e}getAllQuests(){return[...yt]}getQuestDef(e){return Nt.get(e)??null}onQuestComplete(e){this.questCompleteCallbacks.push(e)}onStageComplete(e){this.stageCompleteCallbacks.push(e)}serialize(){const e={};for(const[t,i]of this.progress)e[t]={...i};return{progress:e}}deserialize(e){if(e.progress)for(const[t,i]of Object.entries(e.progress))this.progress.has(t)&&this.progress.set(t,{currentStageIndex:i.currentStageIndex??0,stageProgress:i.stageProgress??0,started:i.started??!1,completed:i.completed??!1})}}class nc{abilities=new Map;hotbar=[null,null,null,null];cooldowns=new Map;unlockedAbilities=new Set;lastUsedAbility=null;comboTimer=0;COMBO_WINDOW=1.5;constructor(){for(const e of lc)this.abilities.set(e.id,e)}unlock(e){this.unlockedAbilities.add(e)}setHotbar(e,t){e>=0&&e<4&&(this.hotbar[e]=t)}getHotbar(){return this.hotbar}useAbility(e,t){const i=this.abilities.get(e);return!i||!this.unlockedAbilities.has(e)||(this.cooldowns.get(e)??0)>0||t<i.staminaCost?null:(i.comboChain&&this.lastUsedAbility===i.comboChain&&this.comboTimer>0?this.cooldowns.set(e,i.cooldown*.5):this.cooldowns.set(e,i.cooldown),this.lastUsedAbility=e,this.comboTimer=this.COMBO_WINDOW,i)}update(e){for(const[t,i]of this.cooldowns){const s=i-e;s<=0?this.cooldowns.delete(t):this.cooldowns.set(t,s)}this.comboTimer>0&&(this.comboTimer-=e,this.comboTimer<=0&&(this.lastUsedAbility=null))}getAbility(e){return this.abilities.get(e)}getAbilitiesForWeapon(e){return[...this.abilities.values()].filter(t=>t.weaponType===e)}getCooldown(e){return this.cooldowns.get(e)??0}isUnlocked(e){return this.unlockedAbilities.has(e)}serialize(){return{unlocked:[...this.unlockedAbilities],hotbar:[...this.hotbar]}}deserialize(e){this.unlockedAbilities=new Set(e.unlocked),this.hotbar=[...e.hotbar]}}const lc=[{id:"whirlwind_slash",name:"Whirlwind Slash",weaponType:p.Sword,cooldown:6,staminaCost:20,damageMult:1.5,aoeRadius:48,description:"Spin attack hitting all nearby enemies"},{id:"rising_cut",name:"Rising Cut",weaponType:p.Sword,cooldown:4,staminaCost:12,damageMult:1.8,aoeRadius:0,comboChain:"whirlwind_slash",description:"Upward slash that launches enemies"},{id:"parry_counter",name:"Parry Counter",weaponType:p.Sword,cooldown:8,staminaCost:15,damageMult:2.5,aoeRadius:0,description:"Counter next attack for massive damage"},{id:"judgment_cut",name:"Judgment Cut",weaponType:p.Sword,cooldown:12,staminaCost:30,damageMult:3,aoeRadius:32,description:"Precise dimensional slash"},{id:"blade_storm",name:"Blade Storm",weaponType:p.Sword,cooldown:20,staminaCost:45,damageMult:2,aoeRadius:64,statusEffect:"bleed",statusDuration:5,statusChance:.5,description:"Flurry of slashes creating a storm of blades"},{id:"mighty_cleave",name:"Mighty Cleave",weaponType:p.Axe,cooldown:5,staminaCost:18,damageMult:2,aoeRadius:32,description:"Powerful overhead chop"},{id:"rending_strike",name:"Rending Strike",weaponType:p.Axe,cooldown:7,staminaCost:22,damageMult:1.6,aoeRadius:0,statusEffect:"bleed",statusDuration:6,statusChance:.8,description:"Tearing strike that causes bleeding"},{id:"berserker_rage",name:"Berserker Rage",weaponType:p.Axe,cooldown:25,staminaCost:35,damageMult:1,aoeRadius:0,description:"+50% damage and speed for 8 seconds"},{id:"executioner_blow",name:"Executioner's Blow",weaponType:p.Axe,cooldown:15,staminaCost:40,damageMult:4,aoeRadius:0,description:"Massive damage to enemies below 30% HP"},{id:"piercing_thrust",name:"Piercing Thrust",weaponType:p.Spear,cooldown:3,staminaCost:10,damageMult:1.8,aoeRadius:0,description:"Long-range piercing attack"},{id:"cyclone_spin",name:"Cyclone Spin",weaponType:p.Spear,cooldown:8,staminaCost:25,damageMult:1.4,aoeRadius:56,description:"Spinning spear attack hitting all around"},{id:"pinning_strike",name:"Pinning Strike",weaponType:p.Spear,cooldown:10,staminaCost:20,damageMult:1.5,aoeRadius:0,statusEffect:"stun",statusDuration:2,statusChance:1,description:"Pin enemy in place"},{id:"sky_piercer",name:"Sky Piercer",weaponType:p.Spear,cooldown:18,staminaCost:35,damageMult:3.5,aoeRadius:24,description:"Leap into the air and slam down"},{id:"power_shot",name:"Power Shot",weaponType:p.Bow,cooldown:4,staminaCost:12,damageMult:2.2,aoeRadius:0,description:"Charged shot with extra damage"},{id:"arrow_rain",name:"Arrow Rain",weaponType:p.Bow,cooldown:12,staminaCost:30,damageMult:1,aoeRadius:80,description:"Rain of arrows in a wide area"},{id:"frost_arrow",name:"Frost Arrow",weaponType:p.Bow,cooldown:8,staminaCost:18,damageMult:1.5,aoeRadius:0,statusEffect:"freeze",statusDuration:3,statusChance:.7,description:"Freezing arrow that slows enemies"},{id:"deadeye",name:"Deadeye",weaponType:p.Bow,cooldown:15,staminaCost:25,damageMult:5,aoeRadius:0,description:"Perfect shot  guaranteed critical hit"},{id:"arcane_bolt",name:"Arcane Bolt",weaponType:p.Staff,cooldown:2,staminaCost:8,damageMult:1.4,aoeRadius:0,description:"Fast magic projectile"},{id:"chain_lightning",name:"Chain Lightning",weaponType:p.Staff,cooldown:8,staminaCost:22,damageMult:1.2,aoeRadius:48,description:"Lightning that chains between enemies"},{id:"arcane_barrier",name:"Arcane Barrier",weaponType:p.Staff,cooldown:15,staminaCost:30,damageMult:0,aoeRadius:0,description:"Shield that absorbs 50% damage for 6s"},{id:"meteor_strike",name:"Meteor Strike",weaponType:p.Staff,cooldown:20,staminaCost:45,damageMult:3.5,aoeRadius:72,statusEffect:"burn",statusDuration:4,statusChance:1,description:"Call down a meteor on target area"},{id:"time_warp",name:"Time Warp",weaponType:p.Staff,cooldown:30,staminaCost:50,damageMult:0,aoeRadius:96,description:"Slow all enemies in area by 60% for 5s"},{id:"shadow_step",name:"Shadow Step",weaponType:p.Dagger,cooldown:5,staminaCost:15,damageMult:2,aoeRadius:0,description:"Teleport behind target and backstab"},{id:"fan_of_knives",name:"Fan of Knives",weaponType:p.Dagger,cooldown:7,staminaCost:20,damageMult:1.2,aoeRadius:56,description:"Throw knives in a cone"},{id:"poison_blade",name:"Poison Blade",weaponType:p.Dagger,cooldown:10,staminaCost:18,damageMult:1.3,aoeRadius:0,statusEffect:"poison",statusDuration:8,statusChance:1,description:"Coat blade in poison for 3 attacks"},{id:"death_mark",name:"Death Mark",weaponType:p.Dagger,cooldown:20,staminaCost:35,damageMult:1,aoeRadius:0,description:"Mark target  all damage +40% for 6s"},{id:"ground_pound",name:"Ground Pound",weaponType:p.Hammer,cooldown:6,staminaCost:22,damageMult:1.8,aoeRadius:48,statusEffect:"stun",statusDuration:1.5,statusChance:.6,description:"Slam ground, stunning nearby enemies"},{id:"shockwave",name:"Shockwave",weaponType:p.Hammer,cooldown:10,staminaCost:28,damageMult:1.5,aoeRadius:72,description:"Send shockwave in a line"},{id:"fortify",name:"Fortify",weaponType:p.Hammer,cooldown:18,staminaCost:20,damageMult:0,aoeRadius:0,description:"+50% defense for 8 seconds"},{id:"titans_grip",name:"Titan's Grip",weaponType:p.Hammer,cooldown:22,staminaCost:45,damageMult:5,aoeRadius:32,statusEffect:"stun",statusDuration:3,statusChance:1,description:"Massive overhead smash"}];class cc{steps=[];currentStepIndex=-1;playing=!1;cutsceneStartCallbacks=[];cutsceneEndCallbacks=[];stepChangeCallbacks=[];constructor(){}playCutscene(e){if(e.length===0)return;this.steps=[...e],this.currentStepIndex=0,this.playing=!0;for(const i of this.cutsceneStartCallbacks)i(this.steps);const t=this.steps[0];for(const i of this.stepChangeCallbacks)i(t,0)}advance(){if(!this.playing)return;if(this.currentStepIndex++,this.currentStepIndex>=this.steps.length){this.endCutscene();return}const e=this.steps[this.currentStepIndex];for(const t of this.stepChangeCallbacks)t(e,this.currentStepIndex)}skip(){this.playing&&this.endCutscene()}isPlaying(){return this.playing}getCurrentStep(){return!this.playing||this.currentStepIndex<0||this.currentStepIndex>=this.steps.length?null:this.steps[this.currentStepIndex]}getCurrentStepIndex(){return this.playing?this.currentStepIndex:-1}getTotalSteps(){return this.steps.length}onCutsceneStart(e){this.cutsceneStartCallbacks.push(e)}onCutsceneEnd(e){this.cutsceneEndCallbacks.push(e)}onStepChange(e){this.stepChangeCallbacks.push(e)}endCutscene(){this.playing=!1,this.currentStepIndex=-1,this.steps=[];for(const e of this.cutsceneEndCallbacks)e()}}const Jt=[{id:"haven_01",title:"A Warden's Journal",codexCategory:"haven",text:"Day 347. The corruption stopped at the river. We built walls, lit fires, and told ourselves it was enough. But at night, you can hear the trees on the far bank whispering in tongues no living mouth should shape.",biome:"haven",source:"ground",rarity:0},{id:"haven_02",title:"Carved Prayer Stone",codexCategory:"haven",text:"To whoever reads this after we are gone: Haven was not always a refuge. Before the corruption, it was simply a crossroads. We made it holy by refusing to let it fall.",biome:"haven",source:"farming",rarity:0},{id:"haven_03",title:"Merchant's Lament",codexCategory:"haven",text:"The caravans stopped coming three seasons ago. Now we trade in hope and fear, and both are in dwindling supply. I saw a child yesterday who had never tasted sugar.",biome:"haven",source:"ground",rarity:0},{id:"haven_04",title:"The First Campfire",codexCategory:"haven",text:"They say the first campfire was lit by a traveler who refused to sleep in darkness. She burned everything she had  books, clothes, a painting of her daughter  just to keep the flame alive until dawn.",biome:"haven",source:"chest",rarity:1},{id:"haven_05",title:"Faded Map Fragment",codexCategory:"haven",text:'This torn map shows roads that no longer exist, connecting cities that no longer stand. Someone has drawn a single star over Haven with the word "STILL" in desperate handwriting.',biome:"haven",source:"fishing",rarity:1},{id:"rotwood_01",title:"Druid's Final Entry",codexCategory:"corruption",text:"The trees are not dying. They are changing. I pressed my ear to the eldest oak and heard a heartbeat  slow, alien, impossibly deep. The forest is not being consumed. It is being replaced.",biome:"rotwood",source:"ground",rarity:0},{id:"rotwood_02",title:"Hunter's Warning",codexCategory:"corruption",text:"Do not drink the water. Do not eat the fruit. Do not sleep beneath the canopy. The corruption enters through trust  it mimics the familiar until you forget what was real.",biome:"rotwood",source:"enemy_drop",rarity:0},{id:"rotwood_03",title:"Spore Analysis Notes",codexCategory:"corruption",text:"The spores are not random. They form patterns  spirals, fractals, mathematical precision no natural growth should achieve. Whatever drives the corruption has intelligence. And patience.",biome:"rotwood",source:"ground",rarity:1},{id:"rotwood_04",title:"Bark Inscription",codexCategory:"corruption",text:'Cut into the corrupted bark in an unknown script. When translated by the last linguist in Haven, it read simply: "WE WERE HERE BEFORE YOUR SUN."',biome:"rotwood",source:"chest",rarity:2},{id:"rotwood_05",title:"Ranger's Bones",codexCategory:"haven",text:"Found clutching a locket with two portraits inside  a woman and child. The ranger's armor bears Haven's crest. They came to scout the forest's edge. They never reported back.",biome:"rotwood",source:"dungeon",rarity:1},{id:"ash_01",title:"Blacksmith's Testament",codexCategory:"titans",text:"The mountain did not erupt. It was pushed open from inside. I watched the Ash Titan rise from the caldera, a thing of ember and fury older than language. The forges I spent my life tending were toys beside its fire.",biome:"ashlands",source:"ground",rarity:0},{id:"ash_02",title:"Scorched Battle Standard",codexCategory:"titans",text:"An entire regiment marched against the Titan. Three hundred souls with blessed weapons and songs of courage. The ash fields are their grave. Not one returned.",biome:"ashlands",source:"enemy_drop",rarity:0},{id:"ash_03",title:"Volcanic Glass Tablet",codexCategory:"corruption",text:"The corruption and the fire are not allies. They compete for the same territory  our world. The Ashlands burn because two apocalypses collided, and we are caught between them.",biome:"ashlands",source:"ground",rarity:1},{id:"ash_04",title:"Obsidian Mirror Shard",codexCategory:"shadow_world",text:"When you look into volcanic glass at midnight, you see another world layered over ours  buildings where there are ruins, people where there are bones. The Shadow World remembers what we have lost.",biome:"ashlands",source:"dungeon",rarity:2},{id:"ash_05",title:"Phoenix Feather Scroll",codexCategory:"titans",text:"The Titan is not mindless. It grieves. I saw it stand motionless for three days over a pool of cooled magma, and when it left, the pool had crystallized into the shape of a woman holding a child.",biome:"ashlands",source:"chest",rarity:2},{id:"drowned_01",title:"Sailor's Logbook",codexCategory:"corruption",text:"The sea did not rise. The land sank. In a single night, the coastline retreated inland by ten leagues. From the new shore, we could see the rooftops of our homes beneath the waves, lights still burning.",biome:"drowned",source:"fishing",rarity:0},{id:"drowned_02",title:"Barnacled Shield",codexCategory:"factions",text:"The Tide Guard defended the harbors until the water claimed them. Their final act was to chain the harbor gates shut so the things swimming up from the deep could not follow the survivors inland.",biome:"drowned",source:"enemy_drop",rarity:0},{id:"drowned_03",title:"Deep Sea Specimen",codexCategory:"corruption",text:"This creature has no eyes, no mouth, and no brain  yet it moves with purpose. Dissection reveals its body is a single continuous cell. It should not be alive. It should not exist at all.",biome:"drowned",source:"fishing",rarity:1},{id:"drowned_04",title:"Sunken Temple Relic",codexCategory:"shadow_world",text:`Carved from coral that grows only in waters tainted by the Shadow World's bleed-through. The inscription warns: "The boundary is thinnest where salt water meets corruption. Do not swim at night."`,biome:"drowned",source:"dungeon",rarity:2},{id:"drowned_05",title:"Lighthouse Keeper's Vigil",codexCategory:"haven",text:"The lighthouse still burns. I refuel it each week, though no ships come. Perhaps it is not for the living. Perhaps the dead at sea need a light to know they are not forgotten.",biome:"drowned",source:"ground",rarity:1},{id:"bone_01",title:"Archaeologist's Discovery",codexCategory:"history",text:"The bones are not from any species I recognize. They predate human settlement by millennia. Something vast lived here, died here, and its skeleton became the foundation of an empire that is itself now dead.",biome:"bone",source:"ground",rarity:0},{id:"bone_02",title:"Imperial Decree (Crumbling)",codexCategory:"history",text:'"By order of the Emperor: all citizens are to evacuate beyond the third wall. The corruption has breached the second. Those who remain will be considered already dead." The decree is dated 200 years ago.',biome:"bone",source:"enemy_drop",rarity:0},{id:"bone_03",title:"Gravedigger's Philosophy",codexCategory:"history",text:"I have buried kings and beggars. The corruption treats them the same  both rise again on the third night. There is a terrible equality in this apocalypse that the living never achieved.",biome:"bone",source:"ground",rarity:1},{id:"bone_04",title:"Soul Gem Fragment",codexCategory:"shadow_world",text:"This gem pulses with trapped memories. Touching it floods your mind with images: a thriving city, a great library, children playing in sunlit streets. Then darkness. Then nothing. Then you are back in the wastes.",biome:"bone",source:"dungeon",rarity:2},{id:"bone_05",title:"The Emperor's Last Letter",codexCategory:"history",text:"My dearest  I write this from the throne room as the walls fall. I was wrong to fight. I was wrong to stay. I was wrong about everything except loving you. Forgive me. The darkness is kind, in its way.",biome:"bone",source:"chest",rarity:2},{id:"void_01",title:"Scholar's Madness",codexCategory:"shadow_world",text:"I have seen the truth. The corruption is not an invasion  it is a correction. Our world is the anomaly, a bubble of matter floating in an infinite sea of void. The corruption is the void reclaiming what was always its own.",biome:"void",source:"ground",rarity:1},{id:"void_02",title:"Void-Touched Stone",codexCategory:"shadow_world",text:"This stone exists in two places simultaneously. In our world, it is cold and dark. In the Shadow World, it burns with white fire. Between the two, in the space that should not exist, it whispers.",biome:"void",source:"enemy_drop",rarity:1},{id:"void_03",title:"Time-Lost Message",codexCategory:"shadow_world",text:'This note is written in your handwriting, in ink that has not yet been made, on paper from a tree that has not yet grown. It says: "Do not trust the light at the center. It remembers what you will forget."',biome:"void",source:"ground",rarity:2},{id:"void_04",title:"The Void Anchor's Memory",codexCategory:"titans",text:"Before the Titans woke, they dreamed. Their dreams became the corruption. Their nightmares became the Shadow World. And the Void? The Void is what happens when even nightmares stop caring.",biome:"void",source:"dungeon",rarity:2},{id:"void_05",title:"A Letter to No One",codexCategory:"shadow_world",text:"I am the last researcher. My colleagues walked into the Void and did not return. They did not die  I can still hear them speaking. But their voices come from everywhere at once, and they are speaking in futures that haven't happened.",biome:"void",source:"chest",rarity:3},{id:"edilas_01",title:"The World's Name",codexCategory:"history",text:'Edilas was not always the name of a place. It was a promise  in the old tongue, it means "that which endures." The first settlers chose it deliberately, defiantly, as if naming it could make it true.',biome:"edilas",source:"ground",rarity:1},{id:"edilas_02",title:"The Corruption's Origin",codexCategory:"corruption",text:"It did not come from outside. The corruption rose from within  from the deepest mines, from the oldest wells, from the foundation stones of the first cities. We built our civilization on top of its sleeping body.",biome:"edilas",source:"enemy_drop",rarity:2},{id:"edilas_03",title:"The Titan's Bargain",codexCategory:"titans",text:"The five Titans were not born of corruption  they were created to fight it. Ancient god-weapons forged by hands now forgotten. But something went wrong. They absorbed what they were meant to destroy, and now they serve both sides of the war.",biome:"edilas",source:"dungeon",rarity:2},{id:"edilas_04",title:"The Shadow World's Truth",codexCategory:"shadow_world",text:'The Shadow World is not a reflection. It is the original. Our world is the shadow  a fading echo of what existed before the corruption rewrote reality. Everything we call "real" is a memory the Shadow World is slowly forgetting.',biome:"edilas",source:"chest",rarity:3},{id:"edilas_05",title:"Edilas Endures",codexCategory:"history",text:"I have seen empires crumble, titans fall, and corruption consume everything. Yet people still plant seeds, still light fires, still tell stories to their children. Edilas endures not because it is strong, but because its people refuse to stop trying.",biome:"edilas",source:"ground",rarity:3}],Ki=new Map;for(const r of Jt)Ki.set(r.id,r);const dc=["haven","corruption","titans","history","shadow_world","factions"];class hc{discovered=new Map;onDiscoverCbs=[];onDiscover(e){this.onDiscoverCbs.push(e)}discover(e){if(this.discovered.has(e))return!1;const t=Ki.get(e);if(!t)return!1;this.discovered.set(e,{fragment:t,discoveredAt:Date.now()});for(const i of this.onDiscoverCbs)i(t);return!0}isDiscovered(e){return this.discovered.has(e)}getAllDiscovered(){return Array.from(this.discovered.values())}getByCategory(e){return this.getAllDiscovered().filter(t=>t.fragment.codexCategory===e)}getCategoryCounts(){const e={};for(const t of dc){const i=Jt.filter(a=>a.codexCategory===t).length,s=this.getByCategory(t).length;e[t]={found:s,total:i}}return e}getProgress(){return{found:this.discovered.size,total:Jt.length}}rollFragmentDrop(e,t){const i=Jt.filter(a=>a.biome===e&&a.source===t&&!this.discovered.has(a.id));if(i.length===0)return null;const s=[.05,.02,.005,.001];for(const a of i){const o=s[a.rarity]??.001;if(Math.random()<o)return a.id}return null}serialize(){return Array.from(this.discovered.keys())}deserialize(e){this.discovered.clear();for(const t of e){const i=Ki.get(t);i&&this.discovered.set(t,{fragment:i,discoveredAt:0})}}}const st=[{id:"sm_slime_alive",type:"enemy",sourceId:"forest_slime",biome:"haven",state:"alive",text:"Warm... light... food nearby... consume...",codexCategory:"haven"},{id:"sm_slime_dead",type:"enemy",sourceId:"forest_slime",biome:"haven",state:"dead",text:"Once I was rain. I fell through corrupted soil and forgot how to evaporate.",codexCategory:"haven"},{id:"sm_corpse_alive",type:"enemy",sourceId:"shambling_corpse",biome:"haven",state:"alive",text:"Must... walk... home... where is home... the walls... the walls are gone...",codexCategory:"haven"},{id:"sm_corpse_dead",type:"enemy",sourceId:"shambling_corpse",biome:"haven",state:"dead",text:"I remember a daughter. I remember a door. I do not remember which I was walking toward.",codexCategory:"haven"},{id:"sm_boar_alive",type:"enemy",sourceId:"wild_boar",biome:"haven",state:"alive",text:"Intruder in the grass. Charge. Protect the young. CHARGE.",codexCategory:"haven"},{id:"sm_wolf_dead",type:"enemy",sourceId:"wild_wolf",biome:"haven",state:"dead",text:"The pack howls at dusk. One fewer voice tonight. The others will remember for exactly three moons.",codexCategory:"haven"},{id:"sm_soul_alive",type:"enemy",sourceId:"lost_soul",biome:"haven",state:"alive",text:"I can see the living. They are so bright it hurts. Why won't they look at me?",codexCategory:"shadow_world"},{id:"sm_spider_alive",type:"enemy",sourceId:"corpse_spider",biome:"rotwood",state:"alive",text:"Silk. Silk. Everything in silk. The prey stops screaming when wrapped tight enough.",codexCategory:"corruption"},{id:"sm_treant_dead",type:"enemy",sourceId:"rotting_treant",biome:"rotwood",state:"dead",text:"Three hundred years I grew toward the sun. Then the sun turned black. I grew toward that instead.",codexCategory:"corruption"},{id:"sm_wisp_alive",type:"enemy",sourceId:"will_o_wisp",biome:"rotwood",state:"alive",text:"Follow me. Follow me into the dark. I am the last lantern and I burn for no one.",codexCategory:"corruption"},{id:"sm_spore_dead",type:"enemy",sourceId:"spore_cloud",biome:"rotwood",state:"dead",text:"We are not many. We are one mind, scattered into spores. Each death is a forgetting.",codexCategory:"corruption"},{id:"sm_moth_alive",type:"enemy",sourceId:"poison_moth",biome:"rotwood",state:"alive",text:"The pollen tastes of copper and grief. I carry it between the dead flowers because there are no living ones left.",codexCategory:"corruption"},{id:"sm_imp_alive",type:"enemy",sourceId:"fire_imp",biome:"ashlands",state:"alive",text:"Burn bright! Burn fast! Better to be flame than fuel!",codexCategory:"titans"},{id:"sm_imp_dead",type:"enemy",sourceId:"fire_imp",biome:"ashlands",state:"dead",text:"The Titan breathed, and we were born from the ash. We did not ask to burn.",codexCategory:"titans"},{id:"sm_golem_alive",type:"enemy",sourceId:"magma_golem",biome:"ashlands",state:"alive",text:"DEFEND. THE. CALDERA. The master sleeps beneath. No one passes.",codexCategory:"titans"},{id:"sm_golem_dead",type:"enemy",sourceId:"magma_golem",biome:"ashlands",state:"dead",text:"I was a wall before I was a soldier. The mountain shaped me to guard what it could not protect itself.",codexCategory:"titans"},{id:"sm_knight_alive",type:"enemy",sourceId:"obsidian_knight",biome:"ashlands",state:"alive",text:"My oath did not end when the kingdom burned. If anything, it burns brighter now.",codexCategory:"history"},{id:"sm_knight_dead",type:"enemy",sourceId:"obsidian_knight",biome:"ashlands",state:"dead",text:"Under the obsidian, a human face. Under the oath, a human fear. I was afraid every single day.",codexCategory:"history"},{id:"sm_lurker_alive",type:"enemy",sourceId:"marsh_lurker",biome:"drowned",state:"alive",text:"Still. Be still. The water hides us. The water feeds us. Wait for feet.",codexCategory:"corruption"},{id:"sm_lurker_dead",type:"enemy",sourceId:"marsh_lurker",biome:"drowned",state:"dead",text:"We were fishermen once. The tide came in and we forgot to walk on land.",codexCategory:"history"},{id:"sm_wraith_alive",type:"enemy",sourceId:"drowned_wraith",biome:"drowned",state:"alive",text:"The water is so cold. I have been drowning for years. Why does no one hear me screaming?",codexCategory:"shadow_world"},{id:"sm_toad_dead",type:"enemy",sourceId:"poison_toad",biome:"drowned",state:"dead",text:"The pond where I was born is a mile inland now. Somewhere beneath these waves, tadpoles swim through a church.",codexCategory:"history"},{id:"sm_jelly_alive",type:"enemy",sourceId:"acid_jellyfish",biome:"drowned",state:"alive",text:"Current... drift... sting what touches... no mind to think but still... still afraid of the deep.",codexCategory:"corruption"},{id:"sm_skeleton_alive",type:"enemy",sourceId:"skeletal_warrior",biome:"bone",state:"alive",text:"The Emperor said we would be remembered. He was right. We cannot stop remembering.",codexCategory:"history"},{id:"sm_skeleton_dead",type:"enemy",sourceId:"skeletal_warrior",biome:"bone",state:"dead",text:"At last. Silence. The marching orders finally stopped echoing through my skull.",codexCategory:"history"},{id:"sm_lich_alive",type:"enemy",sourceId:"bone_lich",biome:"bone",state:"alive",text:"I chose undeath because I was afraid of what came after. Now I know  this is what comes after.",codexCategory:"shadow_world"},{id:"sm_revenant_dead",type:"enemy",sourceId:"bone_revenant",biome:"bone",state:"dead",text:"I was buried with honors. Medals on my chest. A flag over my coffin. The corruption did not care about any of it.",codexCategory:"history"},{id:"sm_void_walker_alive",type:"enemy",sourceId:"void_walker",biome:"void",state:"alive",text:"We walk between the cracks in reality. Your world looks so fragile from out here.",codexCategory:"shadow_world"},{id:"sm_void_walker_dead",type:"enemy",sourceId:"void_walker",biome:"void",state:"dead",text:"I was a scholar who looked too long into the space between atoms. I found something looking back.",codexCategory:"shadow_world"},{id:"sm_null_alive",type:"enemy",sourceId:"null_entity",biome:"void",state:"alive",text:"...",codexCategory:"shadow_world"},{id:"sm_null_dead",type:"enemy",sourceId:"null_entity",biome:"void",state:"dead",text:"Even nothingness has a memory. It remembers when there was something. It wants that back.",codexCategory:"shadow_world"},{id:"sm_titan_guard_alive",type:"enemy",sourceId:"titan_guard",biome:"edilas",state:"alive",text:"The heart of the world beats below. We are its immune system. You are the infection.",codexCategory:"titans"},{id:"sm_titan_guard_dead",type:"enemy",sourceId:"titan_guard",biome:"edilas",state:"dead",text:"We were made to protect Edilas. We were never told that Edilas would need protection from us.",codexCategory:"titans"},{id:"sm_haven_campfire",type:"world",sourceId:"campfire_remains",biome:"haven",state:"any",text:"Someone sat here for a very long time. The ash has shaped itself around the absence of a body.",codexCategory:"haven"},{id:"sm_haven_shrine",type:"world",sourceId:"old_shrine",biome:"haven",state:"any",text:"Offerings of dried flowers and copper coins. The god this shrine honors has been dead for decades, but the faithful keep coming.",codexCategory:"haven"},{id:"sm_haven_well",type:"world",sourceId:"abandoned_well",biome:"haven",state:"any",text:"The water tastes of iron and old prayers. Someone dropped a wedding ring down this well and never came back for it.",codexCategory:"haven"},{id:"sm_haven_grave",type:"world",sourceId:"unmarked_grave",biome:"haven",state:"any",text:"No name. No date. Just a stone over disturbed earth and a child's wooden toy placed carefully on top.",codexCategory:"haven"},{id:"sm_rotwood_altar",type:"world",sourceId:"druid_altar",biome:"rotwood",state:"any",text:"The druids carved these runes to keep the forest healthy. Now the runes are growing bark. The spell worked too well.",codexCategory:"corruption"},{id:"sm_rotwood_nest",type:"world",sourceId:"massive_web",biome:"rotwood",state:"any",text:"This web is large enough to catch a horse. The spider that built it is nowhere to be found. Perhaps it outgrew even this.",codexCategory:"corruption"},{id:"sm_rotwood_stump",type:"world",sourceId:"ancient_stump",biome:"rotwood",state:"any",text:'Someone counted the rings before giving up. There is a note stuck in the bark: "Older than the kingdom. Older than language."',codexCategory:"history"},{id:"sm_ash_forge",type:"world",sourceId:"ruined_forge",biome:"ashlands",state:"any",text:"The anvil still radiates heat. A sword was being forged when the eruption came. It remains, half-finished, perfect in its incompleteness.",codexCategory:"titans"},{id:"sm_ash_statue",type:"world",sourceId:"melted_statue",biome:"ashlands",state:"any",text:"This was a monument to victory. The heat has softened the soldier's face into an expression that looks more like grief.",codexCategory:"history"},{id:"sm_ash_bones",type:"world",sourceId:"charred_remains",biome:"ashlands",state:"any",text:"Two sets of bones, arms wrapped around each other. They chose to face the fire together. That is its own kind of victory.",codexCategory:"haven"},{id:"sm_drowned_boat",type:"world",sourceId:"sunken_boat",biome:"drowned",state:"any",text:"The barnacles have made this boat their kingdom. In a hundred years, no one will know this was once a vessel. They will think it was always a reef.",codexCategory:"history"},{id:"sm_drowned_bell",type:"world",sourceId:"submerged_bell",biome:"drowned",state:"any",text:"This church bell still rings when the current shifts. The fish have learned to avoid the sound. The ghosts have not.",codexCategory:"shadow_world"},{id:"sm_drowned_chain",type:"world",sourceId:"harbor_chains",biome:"drowned",state:"any",text:"The Tide Guard chained these gates shut from the inside. They knew they would drown. They did it anyway.",codexCategory:"factions"},{id:"sm_bone_throne",type:"world",sourceId:"broken_throne",biome:"bone",state:"any",text:`The Emperor's throne, split in two. On one half, the word "JUSTICE." On the other, "MERCY." Someone wanted to remind him he could not have both.`,codexCategory:"history"},{id:"sm_bone_library",type:"world",sourceId:"ruined_library",biome:"bone",state:"any",text:"Pages scattered like autumn leaves. An entire civilization's knowledge, reduced to mulch. One page is still legible: a recipe for bread.",codexCategory:"history"},{id:"sm_bone_wall",type:"world",sourceId:"crumbled_wall",biome:"bone",state:"any",text:"The third wall. The last defense. You can still see where the soldiers stood by the wear in the stone. They held this wall for eleven days.",codexCategory:"factions"},{id:"sm_void_mirror",type:"world",sourceId:"void_mirror",biome:"void",state:"any",text:"Your reflection looks back at you, but it is smiling when you are not. It mouths words you cannot hear. It looks relieved.",codexCategory:"shadow_world"},{id:"sm_void_anchor",type:"world",sourceId:"reality_anchor",biome:"void",state:"any",text:'This anchor holds the boundary between worlds in place. It is cracked. The crack is growing. Someone has written "SOON" on the stone.',codexCategory:"shadow_world"},{id:"sm_edilas_heart",type:"world",sourceId:"world_heart",biome:"edilas",state:"any",text:"The heart of Edilas. It beats once per century. You can feel it in your teeth. It is not beating for you. It is beating despite you.",codexCategory:"titans"},{id:"sm_edilas_inscription",type:"world",sourceId:"ancient_inscription",biome:"edilas",state:"any",text:'"That which endures." The words are carved in a language older than the stone itself. Below them, in fresh ink: "Still?"',codexCategory:"history"}],tr=new Map;for(const r of st)tr.set(r.id,r);function uc(r,e){return st.filter(t=>(t.type==="enemy"||t.type==="boss")&&t.sourceId===r&&(e===void 0||t.state===e||t.state==="any"))}class mc{readMemories=new Set;onReadCallbacks=[];onRead(e){this.onReadCallbacks.push(e)}readEnemyMemory(e,t){const i=uc(e,t);if(i.length===0)return null;for(const s of i)if(!this.readMemories.has(s.id)){this.readMemories.add(s.id);for(const a of this.onReadCallbacks)a(s);return s}return null}readWorldMemory(e,t){const i=st.find(s=>s.type==="world"&&s.sourceId===e&&s.biome===t);if(!i||this.readMemories.has(i.id))return null;this.readMemories.add(i.id);for(const s of this.onReadCallbacks)s(i);return i}isRead(e){return this.readMemories.has(e)}getAllRead(){const e=[];for(const t of this.readMemories){const i=tr.get(t);i&&e.push(i)}return e}getProgress(){return{read:this.readMemories.size,total:st.length}}getBiomeProgress(e){const t=st.filter(s=>s.biome===e);return{read:t.filter(s=>this.readMemories.has(s.id)).length,total:t.length}}isHiddenChapterComplete(){return this.readMemories.size>=st.length}serialize(){return{readMemories:Array.from(this.readMemories)}}deserialize(e){if(this.readMemories.clear(),e.readMemories)for(const t of e.readMemories)this.readMemories.add(t)}}var Ji=(r=>(r.NoSecondChance="no_second_chance",r.StarvingWorld="starving_world",r.AncientHostility="ancient_hostility",r.SeveredLight="severed_light",r.BlindExpedition="blind_expedition",r.SpreadingDarkness="spreading_darkness",r.CursedGround="cursed_ground",r.FragileResolve="fragile_resolve",r.IronPrices="iron_prices",r.RelentlessFoes="relentless_foes",r))(Ji||{});const pc=[{id:"no_second_chance",name:"No Second Chance",description:"Death Defiance is disabled for this expedition.",burdenCost:3,maxStacks:1},{id:"starving_world",name:"Starving World",description:"Food buff duration is halved.",burdenCost:2,maxStacks:1},{id:"ancient_hostility",name:"Ancient Hostility",description:"All enemies gain a random elite affix.",burdenCost:2,maxStacks:1},{id:"severed_light",name:"Severed Light",description:"Torch and lantern reveal radius reduced by 40%.",burdenCost:1,maxStacks:1},{id:"blind_expedition",name:"Blind Expedition",description:"The minimap is hidden.",burdenCost:2,maxStacks:1},{id:"spreading_darkness",name:"Spreading Darkness",description:"Corruption spreads at 3x the normal rate.",burdenCost:2,maxStacks:1},{id:"cursed_ground",name:"Cursed Ground",description:"The entire expedition area is treated as a corruption curse zone.",burdenCost:3,maxStacks:1},{id:"fragile_resolve",name:"Fragile Resolve",description:"Resolve starts at 50% instead of 100%.",burdenCost:1,maxStacks:1},{id:"iron_prices",name:"Iron Prices",description:"Shop prices are doubled.",burdenCost:1,maxStacks:1},{id:"relentless_foes",name:"Relentless Foes",description:"Enemy attack speed is increased by 30%.",burdenCost:2,maxStacks:1}],Zt=new Map;for(const r of pc)Zt.set(r.id,r);const ua=[{burdenRequired:4,name:"Ember Vow",description:"Ember materials drop.",lootRarityBonus:1,exclusiveMaterial:"pact_ember"},{burdenRequired:8,name:"Ash Covenant",description:"Ash materials drop.",lootRarityBonus:2,exclusiveMaterial:"pact_ash"},{burdenRequired:12,name:"Shadow Pledge",description:"Shadow materials drop.",lootRarityBonus:3,exclusiveMaterial:"pact_shadow"},{burdenRequired:16,name:"Void Offering",description:"Void materials drop.",lootRarityBonus:4,exclusiveMaterial:"pact_void"},{burdenRequired:20,name:"Edilas Endures",description:"Legendary materials drop.",lootRarityBonus:5,exclusiveMaterial:"pact_edilas"}];class gc{activeConditions=new Map;pactActive=!1;highestBurdenPerBiome=new Map;toggle(e){return Zt.get(e)?(this.activeConditions.get(e)??0)>0?(this.activeConditions.delete(e),!1):(this.activeConditions.set(e,1),!0):!1}setStacks(e,t){const i=Zt.get(e);if(!i)return;const s=Math.min(Math.max(0,t),i.maxStacks);s===0?this.activeConditions.delete(e):this.activeConditions.set(e,s)}clearAll(){this.activeConditions.clear(),this.pactActive=!1}activate(){this.pactActive=this.getTotalBurden()>0}isActive(e){return(this.activeConditions.get(e)??0)>0}getStacks(e){return this.activeConditions.get(e)??0}getTotalBurden(){let e=0;for(const[t,i]of this.activeConditions){const s=Zt.get(t);s&&(e+=s.burdenCost*i)}return e}getActiveConditions(){return Array.from(this.activeConditions.keys())}isPactActive(){return this.pactActive}getCurrentRewardTier(){const e=this.getTotalBurden();let t=null;for(const i of ua)e>=i.burdenRequired&&(t=i);return t}getUnlockedTiers(){const e=this.getTotalBurden();return ua.filter(t=>e>=t.burdenRequired)}getLootRarityBonus(){const e=this.getCurrentRewardTier();return e?e.lootRarityBonus:0}getExclusiveMaterial(){const e=this.getCurrentRewardTier();return e?e.exclusiveMaterial:null}getFoodDurationMult(){return this.isActive("starving_world")?.5:1}getCorruptionSpreadMult(){return this.isActive("spreading_darkness")?3:1}getLightRevealMult(){return this.isActive("severed_light")?.6:1}getEnemyAttackSpeedMult(){return this.isActive("relentless_foes")?1.3:1}getShopPriceMult(){return this.isActive("iron_prices")?2:1}recordExpeditionComplete(e){const t=this.getTotalBurden(),i=this.highestBurdenPerBiome.get(e)??0;t>i&&this.highestBurdenPerBiome.set(e,t)}getHighestBurden(e){return this.highestBurdenPerBiome.get(e)??0}serialize(){const e={};for(const[t,i]of this.highestBurdenPerBiome)e[t]=i;return{highestBurden:e}}deserialize(e){if(this.highestBurdenPerBiome.clear(),this.activeConditions.clear(),this.pactActive=!1,e.highestBurden)for(const[t,i]of Object.entries(e.highestBurden))this.highestBurdenPerBiome.set(t,i)}}const fc=[{type:"affliction",name:"Reckless",description:"Overwhelmed by fear, you strike wildly at anything that moves.",damageMult:1.25,defenseAdd:0,disableDeathDefiance:!1,disableConsumables:!1,autoAttack:!0,resolvePerKill:0},{type:"affliction",name:"Paranoid",description:"Trust is gone. You cannot interact with anyone or anything.",damageMult:1,defenseAdd:0,disableDeathDefiance:!1,disableConsumables:!0,autoAttack:!1,resolvePerKill:0},{type:"affliction",name:"Despairing",description:"Hope has left you. There will be no second chances.",damageMult:.8,defenseAdd:0,disableDeathDefiance:!0,disableConsumables:!1,autoAttack:!1,resolvePerKill:0},{type:"affliction",name:"Feral",description:"Instinct takes over. You fight harder but forget how to use tools.",damageMult:1.4,defenseAdd:-5,disableDeathDefiance:!1,disableConsumables:!0,autoAttack:!1,resolvePerKill:0}],yc=[{type:"virtue",name:"Defiant",description:"Against all odds, your will hardens. Death shall not have you today.",damageMult:1.15,defenseAdd:5,disableDeathDefiance:!1,disableConsumables:!1,autoAttack:!1,resolvePerKill:2},{type:"virtue",name:"Focused",description:"Clarity cuts through the madness. Every strike lands true.",damageMult:1.3,defenseAdd:0,disableDeathDefiance:!1,disableConsumables:!1,autoAttack:!1,resolvePerKill:1},{type:"virtue",name:"Survivor",description:"Each enemy felled restores a fragment of your shattered mind.",damageMult:1.1,defenseAdd:3,disableDeathDefiance:!1,disableConsumables:!1,autoAttack:!1,resolvePerKill:5}],Be=100,ma=90,Te={corruptionDrain:1.5,darknessDrain:.8,shadowWorldDrain:2,combatLossDrain:5,campfireRecovery:8,foodRecovery:3,cityRecovery:2,npcRecovery:10};class bc{resolve=Be;trauma=null;foodRecoveryTimer=0;onTraumaCbs=[];onShatteredCbs=[];onTrauma(e){this.onTraumaCbs.push(e)}onShattered(e){this.onShatteredCbs.push(e)}update(e,t,i,s,a,o){this.trauma&&(this.trauma.remaining-=e,this.trauma.remaining<=0&&(this.trauma=null)),this.foodRecoveryTimer>0&&(this.foodRecoveryTimer-=e,this.addResolve(Te.foodRecovery*e)),t&&this.drain(Te.corruptionDrain*e),i&&this.drain(Te.darknessDrain*e),s&&this.drain(Te.shadowWorldDrain*e),o&&this.addResolve(Te.campfireRecovery*e),a&&this.addResolve(Te.cityRecovery*e)}drain(e){const t=this.resolve;this.resolve=Math.max(0,this.resolve-e),t>0&&this.resolve<=0&&!this.trauma&&this.triggerTrauma()}addResolve(e){this.resolve=Math.min(Be,this.resolve+e)}onPlayerHit(){this.drain(Te.combatLossDrain)}onGoodFood(){this.foodRecoveryTimer=10}onNPCInteraction(){this.addResolve(Te.npcRecovery)}onEnemyKill(){this.trauma&&this.trauma.resolvePerKill>0&&this.addResolve(this.trauma.resolvePerKill)}setResolve(e){this.resolve=Math.max(0,Math.min(Be,e))}triggerTrauma(){const t=Math.random()<.3?yc:fc,i=t[Math.floor(Math.random()*t.length)];this.trauma={...i,remaining:ma,duration:ma},this.resolve=15;for(const s of this.onTraumaCbs)s(this.trauma);for(const s of this.onShatteredCbs)s()}getResolve(){return this.resolve}getMaxResolve(){return Be}getResolvePct(){return this.resolve/Be}getTrauma(){return this.trauma}getEffects(){const e=this.resolve/Be;return this.trauma?.type==="affliction"?{grainIntensity:.6,spawnPhantoms:!0,combatMult:this.trauma.damageMult,shattered:!0}:this.trauma?.type==="virtue"?{grainIntensity:0,spawnPhantoms:!1,combatMult:this.trauma.damageMult,shattered:!1}:e<=.1?{grainIntensity:.5,spawnPhantoms:!0,combatMult:.7,shattered:!1}:e<=.3?{grainIntensity:.3,spawnPhantoms:!0,combatMult:.85,shattered:!1}:e<=.6?{grainIntensity:.1,spawnPhantoms:!1,combatMult:.95,shattered:!1}:{grainIntensity:0,spawnPhantoms:!1,combatMult:1,shattered:!1}}serialize(){return{resolve:this.resolve,trauma:this.trauma}}deserialize(e){this.resolve=e.resolve??Be,this.trauma=e.trauma??null}}const ir=[{id:"flawless_hunter",name:"Flawless Hunter",description:"Kill 10 enemies without taking any damage.",condition:"kill_no_damage",targetCount:10,timeLimit:0,tier:3,goldMult:3},{id:"endurance_trial",name:"Endurance Trial",description:"Survive for 120 seconds in hostile territory.",condition:"survive_timer",targetCount:120,timeLimit:0,tier:1,goldMult:2},{id:"purist_blade",name:"Purist's Blade",description:"Kill 8 enemies without using any consumable items.",condition:"no_items",targetCount:8,timeLimit:0,tier:2,goldMult:2.5},{id:"bloodrush",name:"Bloodrush",description:"Kill 5 enemies within 30 seconds.",condition:"kill_streak",targetCount:5,timeLimit:30,tier:2,goldMult:2.5},{id:"deaths_edge",name:"Death's Edge",description:"Kill 6 enemies while below 30% HP.",condition:"low_hp",targetCount:6,timeLimit:0,tier:3,goldMult:3},{id:"iron_stance",name:"Iron Stance",description:"Kill 8 enemies without using dodge/roll.",condition:"no_dodge",targetCount:8,timeLimit:0,tier:2,goldMult:2.5},{id:"void_walker",name:"Void Walker",description:"Survive 60 seconds standing on corrupted tiles.",condition:"corruption_walk",targetCount:60,timeLimit:0,tier:2,goldMult:2.5},{id:"blade_dancer",name:"Blade Dancer",description:"Parry 5 enemy attacks.",condition:"parry_master",targetCount:5,timeLimit:0,tier:3,goldMult:3}],sr=new Map;for(const r of ir)sr.set(r.id,r);class _c{active=null;contractsCompleted=0;contractsFailed=0;streak=0;onCompleteCbs=[];onFailCbs=[];onComplete(e){this.onCompleteCbs.push(e)}onFail(e){this.onFailCbs.push(e)}getAvailableContracts(e=3){const t=[...ir].sort(()=>Math.random()-.5);return t.slice(0,Math.min(e,t.length))}accept(e){if(this.active)return!1;const t=sr.get(e);return t?(this.active={def:t,progress:0,timeElapsed:0,failed:!1,completed:!1,streakTimer:0,itemsUsed:0,dodgesUsed:0},!0):!1}abandon(){this.active&&this.failContract()}hasActive(){return this.active!==null&&!this.active.failed&&!this.active.completed}getActive(){return this.active}update(e,t){if(!(!this.active||this.active.failed||this.active.completed)){if(this.active.timeElapsed+=e,this.active.def.condition==="survive_timer"&&(this.active.progress=this.active.timeElapsed,this.active.progress>=this.active.def.targetCount)){this.completeContract();return}if(this.active.def.condition==="corruption_walk"&&t&&(this.active.progress+=e,this.active.progress>=this.active.def.targetCount)){this.completeContract();return}this.active.def.condition==="kill_streak"&&this.active.streakTimer>0&&(this.active.streakTimer-=e,this.active.streakTimer<=0&&this.active.progress>0&&(this.active.progress=0,this.active.streakTimer=0)),this.active.def.timeLimit>0&&this.active.timeElapsed>=this.active.def.timeLimit&&this.active.progress<this.active.def.targetCount&&this.failContract()}}onEnemyKill(e){if(!this.active||this.active.failed||this.active.completed)return;const t=this.active.def.condition;(t==="kill_no_damage"||t==="no_items"||t==="no_dodge")&&this.active.progress++,t==="kill_streak"&&(this.active.progress++,this.active.streakTimer=this.active.def.timeLimit),t==="low_hp"&&e<=.3&&this.active.progress++,this.active.progress>=this.active.def.targetCount&&this.completeContract()}onPlayerHit(){!this.active||this.active.failed||this.active.completed||this.active.def.condition==="kill_no_damage"&&this.failContract()}onItemUsed(){!this.active||this.active.failed||this.active.completed||this.active.def.condition==="no_items"&&(this.active.itemsUsed++,this.failContract())}onDodge(){!this.active||this.active.failed||this.active.completed||this.active.def.condition==="no_dodge"&&(this.active.dodgesUsed++,this.failContract())}onParry(){!this.active||this.active.failed||this.active.completed||this.active.def.condition==="parry_master"&&(this.active.progress++,this.active.progress>=this.active.def.targetCount&&this.completeContract())}completeContract(){if(this.active){this.active.completed=!0,this.contractsCompleted++,this.streak++;for(const e of this.onCompleteCbs)e(this.active.def)}}failContract(){if(this.active){this.active.failed=!0,this.contractsFailed++,this.streak=0;for(const e of this.onFailCbs)e(this.active.def)}}clearActive(){this.active=null}getCompletedCount(){return this.contractsCompleted}getFailedCount(){return this.contractsFailed}getStreak(){return this.streak}getProgressPct(){return this.active?Math.min(1,this.active.progress/this.active.def.targetCount):0}getGoldMultiplier(){return!this.active||!this.active.completed?1:this.active.def.goldMult}serialize(){return{completed:this.contractsCompleted,failed:this.contractsFailed,streak:this.streak}}deserialize(e){this.contractsCompleted=e.completed??0,this.contractsFailed=e.failed??0,this.streak=e.streak??0,this.active=null}}const wc=3,vc=7,xc=15,kc=25,dt={forest_slime:{weakTo:p.Hammer,resistTo:p.Sword,statusImmunity:"bleed",exploitTip:"Slimes split when hit  finish them quickly before they multiply.",masteryBonus:"+10% damage to all slimes",masteryDamageMult:1.1},shambling_corpse:{weakTo:p.Axe,resistTo:p.Dagger,statusImmunity:"poison",exploitTip:"Corpses lunge in straight lines. Sidestep and counter.",masteryBonus:"+10% damage to undead",masteryDamageMult:1.1},crawler:{weakTo:p.Spear,resistTo:p.Hammer,statusImmunity:"stun",exploitTip:"Crawlers hesitate after a charge. Strike then.",masteryBonus:"+10% damage to insects",masteryDamageMult:1.1},plague_rat:{weakTo:p.Bow,resistTo:p.Staff,statusImmunity:"poison",exploitTip:"Rats panic when their pack leader falls. Kill the biggest first.",masteryBonus:"+10% damage to beasts",masteryDamageMult:1.1},lost_soul:{weakTo:p.Staff,resistTo:p.Spear,statusImmunity:"bleed",exploitTip:"Souls phase through attacks  time your hits when they solidify.",masteryBonus:"+10% damage to spectral enemies",masteryDamageMult:1.1},wild_boar:{weakTo:p.Spear,resistTo:p.Staff,statusImmunity:"stun",exploitTip:"Boars always charge forward. Step aside and strike the flank.",masteryBonus:"+10% damage to beasts",masteryDamageMult:1.1},angry_bee:{weakTo:p.Bow,resistTo:p.Axe,statusImmunity:"burn",exploitTip:"Bees swoop in arcs. Attack at the apex of their dive.",masteryBonus:"+10% damage to flyers",masteryDamageMult:1.1},field_rat:{weakTo:p.Dagger,resistTo:p.Hammer,statusImmunity:"slow",exploitTip:"Rats flee when injured. Corner them against obstacles.",masteryBonus:"+10% damage to beasts",masteryDamageMult:1.1},garden_spider:{weakTo:p.Hammer,resistTo:p.Bow,statusImmunity:"poison",exploitTip:"Spiders ambush from hiding. Watch for silk threads on the ground.",masteryBonus:"+10% damage to insects",masteryDamageMult:1.1},scarecrow_mimic:{weakTo:p.Axe,resistTo:p.Sword,statusImmunity:"bleed",exploitTip:"Mimics freeze when you look away. Attack when they drop their guard.",masteryBonus:"+10% damage to constructs",masteryDamageMult:1.1},wild_wolf:{weakTo:p.Sword,resistTo:p.Dagger,statusImmunity:"slow",exploitTip:"Wolves circle before pouncing. The leader signals the attack.",masteryBonus:"+10% damage to beasts",masteryDamageMult:1.1},corpse_spider:{weakTo:p.Hammer,resistTo:p.Bow,statusImmunity:"poison",exploitTip:"Corpse spiders spray webs. Stay mobile to avoid entanglement.",masteryBonus:"+10% damage to insects",masteryDamageMult:1.1},rotting_treant:{weakTo:p.Axe,resistTo:p.Spear,statusImmunity:"stun",exploitTip:"Treants root themselves before swinging. Hit the base during wind-up.",masteryBonus:"+10% damage to plants",masteryDamageMult:1.1},will_o_wisp:{weakTo:p.Staff,resistTo:p.Hammer,statusImmunity:"burn",exploitTip:"Wisps blink rapidly. Their pattern repeats every 3 blinks.",masteryBonus:"+10% damage to spectral",masteryDamageMult:1.1},spore_cloud:{weakTo:p.Bow,resistTo:p.Sword,statusImmunity:"poison",exploitTip:"Spore clouds grow when damaged. Kill them in one burst.",masteryBonus:"+10% damage to fungi",masteryDamageMult:1.1},rot_spider:{weakTo:p.Hammer,resistTo:p.Dagger,statusImmunity:"poison",exploitTip:"Rot spiders leave acid trails. Lure them across their own pools.",masteryBonus:"+10% damage to insects",masteryDamageMult:1.1},fungal_crawler:{weakTo:p.Axe,resistTo:p.Staff,statusImmunity:"slow",exploitTip:"Fungal crawlers release spores on death. Step back after the killing blow.",masteryBonus:"+10% damage to fungi",masteryDamageMult:1.1},poison_moth:{weakTo:p.Bow,resistTo:p.Axe,statusImmunity:"poison",exploitTip:"Moths dive when their dust runs out. Wait for the lull.",masteryBonus:"+10% damage to flyers",masteryDamageMult:1.1},spore_bat:{weakTo:p.Spear,resistTo:p.Staff,statusImmunity:"poison",exploitTip:"Spore bats screech before diving. The screech is the telegraph.",masteryBonus:"+10% damage to flyers",masteryDamageMult:1.1},vine_strangler:{weakTo:p.Axe,resistTo:p.Spear,statusImmunity:"slow",exploitTip:"Vines retract after grabbing. Strike during the retraction.",masteryBonus:"+10% damage to plants",masteryDamageMult:1.1},mushroom_golem:{weakTo:p.Hammer,resistTo:p.Dagger,statusImmunity:"poison",exploitTip:"Mushroom golems stagger after three hits. Use the opening.",masteryBonus:"+10% damage to fungi",masteryDamageMult:1.1},corrupted_treant:{weakTo:p.Axe,resistTo:p.Staff,statusImmunity:"burn",exploitTip:"Corrupted treants regenerate in corruption zones. Pull them out.",masteryBonus:"+10% damage to plants",masteryDamageMult:1.1},fire_imp:{weakTo:p.Bow,resistTo:p.Staff,statusImmunity:"burn",exploitTip:"Imps always teleport behind you. Turn immediately after they vanish.",masteryBonus:"+10% damage to demons",masteryDamageMult:1.1},magma_golem:{weakTo:p.Hammer,resistTo:p.Sword,statusImmunity:"burn",exploitTip:"Magma golems cool down after their slam. Hit the darkened rock.",masteryBonus:"+10% damage to elementals",masteryDamageMult:1.1},flame_sprite:{weakTo:p.Spear,resistTo:p.Axe,statusImmunity:"burn",exploitTip:"Sprites flicker before casting. That flicker is your parry window.",masteryBonus:"+10% damage to elementals",masteryDamageMult:1.1},ember_bat:{weakTo:p.Bow,resistTo:p.Hammer,statusImmunity:"burn",exploitTip:"Ember bats ignite on death. Do not stand in the fire.",masteryBonus:"+10% damage to flyers",masteryDamageMult:1.1},lava_golem:{weakTo:p.Hammer,resistTo:p.Dagger,statusImmunity:"burn",exploitTip:"Identical to magma golems but with a wider slam radius.",masteryBonus:"+10% damage to elementals",masteryDamageMult:1.1},ash_wraith:{weakTo:p.Staff,resistTo:p.Bow,statusImmunity:"bleed",exploitTip:"Ash wraiths reform from dust. Hit the dust cloud before it solidifies.",masteryBonus:"+10% damage to spectral",masteryDamageMult:1.1},magma_beetle:{weakTo:p.Spear,resistTo:p.Bow,statusImmunity:"burn",exploitTip:"Beetles flip over when hit hard. Attack the exposed underbelly.",masteryBonus:"+10% damage to insects",masteryDamageMult:1.1},flame_serpent:{weakTo:p.Axe,resistTo:p.Staff,statusImmunity:"burn",exploitTip:"Serpents coil before striking. The tighter the coil, the longer the range.",masteryBonus:"+10% damage to beasts",masteryDamageMult:1.1},ember_elemental:{weakTo:p.Hammer,resistTo:p.Staff,statusImmunity:"burn",exploitTip:"Elementals grow stronger near lava. Fight them on cool ground.",masteryBonus:"+10% damage to elementals",masteryDamageMult:1.1},obsidian_knight:{weakTo:p.Hammer,resistTo:p.Bow,statusImmunity:"stun",exploitTip:"Knights lower their guard during two-handed swings. Parry then.",masteryBonus:"+10% damage to armored",masteryDamageMult:1.1},marsh_lurker:{weakTo:p.Axe,resistTo:p.Bow,statusImmunity:"slow",exploitTip:"Lurkers retreat into water when damaged. Block their escape route.",masteryBonus:"+10% damage to amphibians",masteryDamageMult:1.1},poison_toad:{weakTo:p.Spear,resistTo:p.Dagger,statusImmunity:"poison",exploitTip:"Toads swell before spitting. That is the dodge window.",masteryBonus:"+10% damage to amphibians",masteryDamageMult:1.1},swamp_zombie:{weakTo:p.Axe,resistTo:p.Spear,statusImmunity:"poison",exploitTip:"Swamp zombies grab. Mash attack to break free faster.",masteryBonus:"+10% damage to undead",masteryDamageMult:1.1},drowned_wraith:{weakTo:p.Staff,resistTo:p.Sword,statusImmunity:"bleed",exploitTip:"Drowned wraiths vanish into puddles. Watch ripples for their reappearance.",masteryBonus:"+10% damage to spectral",masteryDamageMult:1.1},drowned_ghoul:{weakTo:p.Hammer,resistTo:p.Dagger,statusImmunity:"poison",exploitTip:"Ghouls attack in bursts of three. Counter after the third swing.",masteryBonus:"+10% damage to undead",masteryDamageMult:1.1},acid_jellyfish:{weakTo:p.Bow,resistTo:p.Hammer,statusImmunity:"poison",exploitTip:"Jellyfish pulse before stinging. Attack between pulses.",masteryBonus:"+10% damage to aquatic",masteryDamageMult:1.1},coral_golem:{weakTo:p.Hammer,resistTo:p.Sword,statusImmunity:"stun",exploitTip:"Coral golems regenerate in water. Lure them onto dry ground.",masteryBonus:"+10% damage to constructs",masteryDamageMult:1.1},deep_lurker:{weakTo:p.Spear,resistTo:p.Staff,statusImmunity:"slow",exploitTip:"Deep lurkers ambush from below. Watch for bubbles on the surface.",masteryBonus:"+10% damage to aquatic",masteryDamageMult:1.1},shadow_wraith:{weakTo:p.Staff,resistTo:p.Bow,statusImmunity:"bleed",exploitTip:"Shadow wraiths are fragments of lost resolve. Steel your mind.",masteryBonus:"+10% damage to shadows",masteryDamageMult:1.1},shadow_phantom:{weakTo:p.Staff,resistTo:p.Bow,statusImmunity:"bleed",exploitTip:"Phantoms are echoes of your doubt. They weaken as your resolve rises.",masteryBonus:"+10% damage to shadows",masteryDamageMult:1.1}};class Sc{discoveries=new Map;onRevealCbs=[];onReveal(e){this.onRevealCbs.push(e)}recordKill(e){let t=this.discoveries.get(e);if(t||(t={kills:0,weaknessRevealed:!1,resistanceRevealed:!1,exploitRevealed:!1,masteryUnlocked:!1},this.discoveries.set(e,t)),t.kills++,t.kills>=wc&&!t.weaknessRevealed){t.weaknessRevealed=!0;for(const i of this.onRevealCbs)i(e,"weakness")}if(t.kills>=vc&&!t.resistanceRevealed){t.resistanceRevealed=!0;for(const i of this.onRevealCbs)i(e,"resistance")}if(t.kills>=xc&&!t.exploitRevealed){t.exploitRevealed=!0;for(const i of this.onRevealCbs)i(e,"exploit")}if(t.kills>=kc&&!t.masteryUnlocked){t.masteryUnlocked=!0;for(const i of this.onRevealCbs)i(e,"mastery")}}getDamageMultiplier(e,t){const i=dt[e];if(!i)return 1;const s=this.discoveries.get(e);if(!s)return 1;let a=1;return s.weaknessRevealed&&t===i.weakTo&&(a+=.3),s.resistanceRevealed&&t===i.resistTo&&(a-=.3),s.masteryUnlocked&&(a*=i.masteryDamageMult),a}isStatusImmune(e,t){const i=dt[e];return i?i.statusImmunity===t:!1}getKnowledge(e){const t=this.discoveries.get(e),i=dt[e];return!t||!i?{kills:t?.kills??0,weakness:null,resistance:null,statusImmunity:null,exploitTip:null,masteryBonus:null,masteryUnlocked:!1}:{kills:t.kills,weakness:t.weaknessRevealed?i.weakTo:null,resistance:t.resistanceRevealed?i.resistTo:null,statusImmunity:t.resistanceRevealed?i.statusImmunity:null,exploitTip:t.exploitRevealed?i.exploitTip:null,masteryBonus:t.masteryUnlocked?i.masteryBonus:null,masteryUnlocked:t.masteryUnlocked}}getDiscoveryState(e){return this.discoveries.get(e)??null}getDiscoveredEnemies(){return Array.from(this.discoveries.keys())}getBestiaryProgress(){return{discovered:this.discoveries.size,total:Object.keys(dt).length}}hasProfile(e){return dt[e]!==void 0}serialize(){const e={};for(const[t,i]of this.discoveries)e[t]={...i};return{discoveries:e}}deserialize(e){if(this.discoveries.clear(),e.discoveries)for(const[t,i]of Object.entries(e.discoveries))this.discoveries.set(t,i)}}const Mc=[{id:"omen_quick_step",name:"Quick Step",description:"+10% movement speed.",notchCost:1,effects:{speedMult:1.1},source:"loot",lore:"A fragment of wind, captured in crystal."},{id:"omen_keen_edge",name:"Keen Edge",description:"+5% crit chance.",notchCost:1,effects:{critChanceAdd:.05},source:"loot",lore:"The blade remembers every kill."},{id:"omen_iron_skin",name:"Iron Skin",description:"+10% defense.",notchCost:1,effects:{defenseMult:1.1},source:"shop",lore:"Forged in the Ashlands, tempered in blood."},{id:"omen_scavenger",name:"Scavenger",description:"+15% gold from kills.",notchCost:1,effects:{goldMult:1.15},source:"loot",lore:"Every corpse has something worth taking."},{id:"omen_scholars_mark",name:"Scholar's Mark",description:"+15% XP gain.",notchCost:1,effects:{xpMult:1.15},source:"quest",lore:"Knowledge is the truest weapon."},{id:"omen_blood_drinker",name:"Blood Drinker",description:"Heal 5% of damage dealt.",notchCost:2,effects:{lifeSteal:.05},source:"boss",lore:"The Blight Mother's gift: hunger that sustains."},{id:"omen_thorned_shell",name:"Thorned Shell",description:"Reflect 3 damage when hit.",notchCost:2,effects:{thorns:3},source:"loot",lore:"Pain given is pain returned."},{id:"omen_steadfast_heart",name:"Steadfast Heart",description:"+20 max HP.",notchCost:2,effects:{maxHpAdd:20},source:"shop",lore:"The heart that refuses to stop beating."},{id:"omen_endurance",name:"Endurance",description:"+15 max stamina.",notchCost:2,effects:{maxStaminaAdd:15},source:"loot",lore:"Second wind. Third. Fourth."},{id:"omen_shadow_step",name:"Shadow Step",description:"+25% backstab damage.",notchCost:2,effects:{backstabMult:1.25},source:"secret",lore:"Move like the darkness between worlds."},{id:"omen_resolve_ward",name:"Resolve Ward",description:"Reduce resolve drain by 20%.",notchCost:2,effects:{resolveResist:.2},source:"quest",lore:"Your mind is a fortress. Walls do not crumble easily."},{id:"omen_regeneration",name:"Regeneration",description:"Heal 1 HP per second.",notchCost:2,effects:{hpRegen:1},source:"loot",lore:"The wound closes, as if it never was."},{id:"omen_berserker",name:"Berserker's Fury",description:"+25% damage, -15% defense.",notchCost:3,effects:{damageMult:1.25,defenseMult:.85},source:"boss",lore:"Rage is the purest form of strength."},{id:"omen_executioner",name:"Executioner",description:"+40% crit multiplier.",notchCost:3,effects:{critMultAdd:.4},source:"boss",lore:"One clean strike. That is all it takes."},{id:"omen_void_embrace",name:"Void Embrace",description:"+20% damage, +30% XP, but resolve drains 30% faster.",notchCost:3,effects:{damageMult:1.2,xpMult:1.3,resolveResist:-.3},source:"secret",lore:"The Void offers power freely. The cost is your mind."},{id:"omen_titan_guard",name:"Titan Guard",description:"+40 max HP, +20% defense, -10% speed.",notchCost:3,effects:{maxHpAdd:40,defenseMult:1.2,speedMult:.9},source:"boss",lore:"Stand like stone. Move like stone."}],ei=new Map;for(const r of Mc)ei.set(r.id,r);class Tc{maxCapacity=5;equipped=[];collected=new Set;onEquipChangeCbs=[];onEquipChange(e){this.onEquipChangeCbs.push(e)}fireEquipChange(){for(const e of this.onEquipChangeCbs)e()}collect(e){return!ei.has(e)||this.collected.has(e)?!1:(this.collected.add(e),!0)}hasCollected(e){return this.collected.has(e)}getCollected(){return Array.from(this.collected)}equip(e){return!this.collected.has(e)||this.equipped.includes(e)?!1:(this.equipped.push(e),this.fireEquipChange(),!0)}unequip(e){const t=this.equipped.indexOf(e);return t===-1?!1:(this.equipped.splice(t,1),this.fireEquipChange(),!0)}getEquipped(){return[...this.equipped]}isEquipped(e){return this.equipped.includes(e)}getUsedCapacity(){let e=0;for(const t of this.equipped){const i=ei.get(t);i&&(e+=i.notchCost)}return e}getMaxCapacity(){return this.maxCapacity}addCapacity(e){this.maxCapacity+=e}isOvercharged(){return this.getUsedCapacity()>this.maxCapacity}getCombinedEffects(){const e={};for(const t of this.equipped){const i=ei.get(t);if(!i)continue;const s=i.effects;s.damageMult&&(e.damageMult=(e.damageMult??1)*s.damageMult),s.defenseMult&&(e.defenseMult=(e.defenseMult??1)*s.defenseMult),s.speedMult&&(e.speedMult=(e.speedMult??1)*s.speedMult),s.critChanceAdd&&(e.critChanceAdd=(e.critChanceAdd??0)+s.critChanceAdd),s.critMultAdd&&(e.critMultAdd=(e.critMultAdd??0)+s.critMultAdd),s.maxHpAdd&&(e.maxHpAdd=(e.maxHpAdd??0)+s.maxHpAdd),s.maxStaminaAdd&&(e.maxStaminaAdd=(e.maxStaminaAdd??0)+s.maxStaminaAdd),s.hpRegen&&(e.hpRegen=(e.hpRegen??0)+s.hpRegen),s.staminaRegen&&(e.staminaRegen=(e.staminaRegen??0)+s.staminaRegen),s.thorns&&(e.thorns=(e.thorns??0)+s.thorns),s.lifeSteal&&(e.lifeSteal=(e.lifeSteal??0)+s.lifeSteal),s.resolveResist&&(e.resolveResist=(e.resolveResist??0)+s.resolveResist),s.xpMult&&(e.xpMult=(e.xpMult??1)*s.xpMult),s.goldMult&&(e.goldMult=(e.goldMult??1)*s.goldMult),s.backstabMult&&(e.backstabMult=(e.backstabMult??1)*s.backstabMult)}return e}serialize(){return{maxCapacity:this.maxCapacity,equipped:[...this.equipped],collected:Array.from(this.collected)}}deserialize(e){this.maxCapacity=e.maxCapacity??5,this.equipped=e.equipped??[],this.collected=new Set(e.collected??[])}}const Cc=[{npcId:"elder_mira",name:"Elder Mira",hp:60,damage:8,defense:5,speed:40,style:"support",loyaltyBonus:{type:"resolve",value:3,description:"+3 resolve recovery/sec"},recruitLine:"I may be old, but I still have fight left in me.",lowMoraleLine:"Perhaps we should rest... my bones ache."},{npcId:"kai",name:"Kai",hp:100,damage:15,defense:8,speed:65,style:"melee",loyaltyBonus:{type:"damage",value:.1,description:"+10% player damage"},recruitLine:"Finally, some action! Lead the way.",lowMoraleLine:"I... I need a moment. This place is getting to me."},{npcId:"sera",name:"Sera",hp:70,damage:12,defense:3,speed:55,style:"ranged",loyaltyBonus:{type:"xp",value:.15,description:"+15% XP gain"},recruitLine:"My bow is yours. Let us see what lies beyond.",lowMoraleLine:"The shadows... they whisper things I don't want to hear."},{npcId:"varn",name:"Varn",hp:140,damage:10,defense:15,speed:35,style:"melee",loyaltyBonus:{type:"defense",value:5,description:"+5 player defense"},recruitLine:"I am your shield. Nothing gets past me.",lowMoraleLine:"Even stone can crack under enough pressure..."},{npcId:"luna",name:"Luna",hp:50,damage:6,defense:2,speed:60,style:"support",loyaltyBonus:{type:"gold",value:.2,description:"+20% gold from kills"},recruitLine:"I know every hidden cache in these lands. Follow me!",lowMoraleLine:"I... I can't think clearly anymore. The corruption..."}],bt=new Map;for(const r of Cc)bt.set(r.npcId,r);const Ii=100,pa=100,Ic=30,Fe={corruptionDrain:1,darknessDrain:.5,combatDrain:2,campfireRecovery:5,cityRecovery:3,foodRecovery:15,giftRecovery:10};class Pc{active=null;onRecruitCbs=[];onDismissCbs=[];onKnockoutCbs=[];onMoraleLowCbs=[];onRecruit(e){this.onRecruitCbs.push(e)}onDismiss(e){this.onDismissCbs.push(e)}onKnockout(e){this.onKnockoutCbs.push(e)}onMoraleLow(e){this.onMoraleLowCbs.push(e)}recruit(e){const t=bt.get(e);if(!t||this.active)return!1;this.active={npcId:e,currentHp:t.hp,maxHp:t.hp,morale:Ii,loyalty:0,isKnockedOut:!1,knockoutTimer:0};for(const i of this.onRecruitCbs)i(e);return!0}dismiss(){if(!this.active)return;const e=this.active.npcId;this.active=null;for(const t of this.onDismissCbs)t(e)}hasCompanion(){return this.active!==null}getActive(){return this.active}getActiveDef(){return this.active?bt.get(this.active.npcId)??null:null}update(e,t,i,s,a){if(this.active){if(this.active.isKnockedOut){this.active.knockoutTimer-=e,this.active.knockoutTimer<=0&&(this.active.isKnockedOut=!1,this.active.currentHp=Math.round(this.active.maxHp*.3),this.active.morale=Math.max(10,this.active.morale));return}t&&this.drainMorale(Fe.corruptionDrain*e),i&&this.drainMorale(Fe.darknessDrain*e),a&&this.addMorale(Fe.campfireRecovery*e),s&&this.addMorale(Fe.cityRecovery*e),this.active.loyalty=Math.min(pa,this.active.loyalty+.02*e),(s||a)&&(this.active.currentHp=Math.min(this.active.maxHp,this.active.currentHp+2*e))}}onCompanionHit(e){if(!(!this.active||this.active.isKnockedOut)&&(this.active.currentHp-=e,this.drainMorale(Fe.combatDrain),this.active.currentHp<=0)){this.active.currentHp=0,this.active.isKnockedOut=!0,this.active.knockoutTimer=Ic;for(const t of this.onKnockoutCbs)t(this.active.npcId)}}onPlayerFood(){!this.active||this.active.isKnockedOut||this.addMorale(Fe.foodRecovery)}onGift(){!this.active||this.active.isKnockedOut||(this.addMorale(Fe.giftRecovery),this.active.loyalty=Math.min(pa,this.active.loyalty+2))}healAtCampfire(){this.active&&(this.active.isKnockedOut&&(this.active.isKnockedOut=!1,this.active.knockoutTimer=0),this.active.currentHp=this.active.maxHp,this.active.morale=Math.min(Ii,this.active.morale+30))}drainMorale(e){if(!this.active)return;const t=this.active.morale;if(this.active.morale=Math.max(0,this.active.morale-e),t>20&&this.active.morale<=20)for(const i of this.onMoraleLowCbs)i(this.active.npcId)}addMorale(e){this.active&&(this.active.morale=Math.min(Ii,this.active.morale+e))}getCombatStats(){if(!this.active||this.active.isKnockedOut)return null;const e=bt.get(this.active.npcId);if(!e)return null;const t=this.active.morale<30?.5+this.active.morale/30*.5:1;return{damage:Math.round(e.damage*t),defense:Math.round(e.defense*t),speed:Math.round(e.speed*t)}}getLoyaltyBonus(){return!this.active||this.active.loyalty<50?null:bt.get(this.active.npcId)?.loyaltyBonus??null}getMoraleState(){return this.active?this.active.morale>=70?"high":this.active.morale>=40?"normal":this.active.morale>=20?"low":"critical":null}serialize(){return{active:this.active?{...this.active}:null}}deserialize(e){this.active=e.active??null}}const ar=[{id:"boon_swift_blade",name:"Swift Blade",description:"+15% attack speed.",rarity:"common",source:"Wind Spirit",effects:{attackSpeedMult:1.15},color:"#88ccff"},{id:"boon_iron_will",name:"Iron Will",description:"+15 max HP.",rarity:"common",source:"Stone Spirit",effects:{maxHpAdd:15},color:"#aaaaaa"},{id:"boon_keen_senses",name:"Keen Senses",description:"+5% crit chance.",rarity:"common",source:"Shadow Spirit",effects:{critChanceAdd:.05},color:"#cc88ff"},{id:"boon_thick_skin",name:"Thick Skin",description:"+3 defense.",rarity:"common",source:"Stone Spirit",effects:{defenseAdd:3},color:"#aaaaaa"},{id:"boon_fleet_foot",name:"Fleet Foot",description:"+10% movement speed.",rarity:"common",source:"Wind Spirit",effects:{speedMult:1.1},color:"#88ccff"},{id:"boon_heavy_strike",name:"Heavy Strike",description:"+3 flat damage per hit.",rarity:"common",source:"Fire Spirit",effects:{flatDamage:3},color:"#ff8844"},{id:"boon_prospector",name:"Prospector",description:"+20% gold from kills.",rarity:"common",source:"Earth Spirit",effects:{goldMult:1.2},color:"#ffdd44"},{id:"boon_student",name:"Student",description:"+20% XP gain.",rarity:"common",source:"Wisdom Spirit",effects:{xpMult:1.2},color:"#44ddff"},{id:"boon_venomous_strikes",name:"Venomous Strikes",description:"Attacks apply poison (3s, 2 DPS).",rarity:"rare",source:"Shadow Spirit",effects:{statusOnHit:"poison",statusDuration:3,statusDamage:2},color:"#44ff44"},{id:"boon_flame_touch",name:"Flame Touch",description:"Attacks apply burn (2s, 3 DPS).",rarity:"rare",source:"Fire Spirit",effects:{statusOnHit:"burn",statusDuration:2,statusDamage:3},color:"#ff4400"},{id:"boon_frost_edge",name:"Frost Edge",description:"Attacks apply freeze (1.5s slow).",rarity:"rare",source:"Ice Spirit",effects:{statusOnHit:"freeze",statusDuration:1.5},color:"#88ddff"},{id:"boon_blood_frenzy",name:"Blood Frenzy",description:"+25% damage, +20% attack speed.",rarity:"rare",source:"War Spirit",effects:{damageMult:1.25,attackSpeedMult:1.2},color:"#ff2222"},{id:"boon_vampiric_touch",name:"Vampiric Touch",description:"Heal 8% of damage dealt.",rarity:"rare",source:"Shadow Spirit",effects:{lifeSteal:.08},color:"#cc0044"},{id:"boon_mirror_shield",name:"Mirror Shield",description:"Reflect 5 damage when hit.",rarity:"rare",source:"Stone Spirit",effects:{thornsDamage:5},color:"#aaccff"},{id:"boon_critical_edge",name:"Critical Edge",description:"+50% crit multiplier.",rarity:"rare",source:"War Spirit",effects:{critMultAdd:.5},color:"#ffaa00"},{id:"boon_phantom_step",name:"Phantom Step",description:"10% chance to dodge attacks entirely.",rarity:"rare",source:"Wind Spirit",effects:{dodgeChance:.1},color:"#ccccff"},{id:"boon_death_nova",name:"Death Nova",description:"Enemies explode on death (30 dmg, 40px radius).",rarity:"epic",source:"Void Spirit",effects:{aoeRadius:40,aoeDamage:30},color:"#aa00ff"},{id:"boon_berserker_rage",name:"Berserker Rage",description:"+50% damage, +30% attack speed, -20 max HP.",rarity:"epic",source:"War Spirit",effects:{damageMult:1.5,attackSpeedMult:1.3,maxHpAdd:-20},color:"#ff0000"},{id:"boon_hemorrhage",name:"Hemorrhage",description:"Attacks apply bleed (4s, 4 DPS).",rarity:"epic",source:"Shadow Spirit",effects:{statusOnHit:"bleed",statusDuration:4,statusDamage:4},color:"#ff2244"},{id:"boon_fortress",name:"Fortress",description:"+50 max HP, +8 defense, -10% speed.",rarity:"epic",source:"Stone Spirit",effects:{maxHpAdd:50,defenseAdd:8,speedMult:.9},color:"#886644"},{id:"boon_spectral_blade",name:"Spectral Blade",description:"+8 flat damage, +10% crit, attacks apply stun (0.3s).",rarity:"epic",source:"Void Spirit",effects:{flatDamage:8,critChanceAdd:.1,statusOnHit:"stun",statusDuration:.3},color:"#dd44ff"}],Zi=new Map;for(const r of ar)Zi.set(r.id,r);const Rc={common:60,rare:30,epic:10};class Ac{activeBoons=[];totalCollected=0;onBoonChoiceCbs=[];onBoonSelectedCbs=[];onBoonChoice(e){this.onBoonChoiceCbs.push(e)}onBoonSelected(e){this.onBoonSelectedCbs.push(e)}offerBoonChoice(e=0){const t=ar.filter(o=>!this.activeBoons.some(n=>n.id===o.id));if(t.length===0)return[];const i={...Rc};i.rare+=e*5,i.epic+=e*3;const s=[],a=new Set;for(let o=0;o<3&&s.length<3;o++){const n=this.rollRarity(i),l=t.filter(c=>c.rarity===n&&!a.has(c.id));if(l.length>0){const c=l[Math.floor(Math.random()*l.length)];s.push(c),a.add(c.id)}else{const c=t.filter(d=>!a.has(d.id));if(c.length>0){const d=c[Math.floor(Math.random()*c.length)];s.push(d),a.add(d.id)}}}for(const o of this.onBoonChoiceCbs)o(s);return s}rollRarity(e){const t=e.common+e.rare+e.epic,i=Math.random()*t;return i<e.common?"common":i<e.common+e.rare?"rare":"epic"}selectBoon(e){const t=Zi.get(e);if(!t||this.activeBoons.some(i=>i.id===e))return!1;this.activeBoons.push(t),this.totalCollected++;for(const i of this.onBoonSelectedCbs)i(t);return!0}clearRun(){this.activeBoons=[]}getActiveBoons(){return[...this.activeBoons]}getActiveCount(){return this.activeBoons.length}getCombinedEffects(){const e={};for(const t of this.activeBoons){const i=t.effects;i.flatDamage&&(e.flatDamage=(e.flatDamage??0)+i.flatDamage),i.maxHpAdd&&(e.maxHpAdd=(e.maxHpAdd??0)+i.maxHpAdd),i.defenseAdd&&(e.defenseAdd=(e.defenseAdd??0)+i.defenseAdd),i.critChanceAdd&&(e.critChanceAdd=(e.critChanceAdd??0)+i.critChanceAdd),i.critMultAdd&&(e.critMultAdd=(e.critMultAdd??0)+i.critMultAdd),i.lifeSteal&&(e.lifeSteal=(e.lifeSteal??0)+i.lifeSteal),i.thornsDamage&&(e.thornsDamage=(e.thornsDamage??0)+i.thornsDamage),i.dodgeChance&&(e.dodgeChance=(e.dodgeChance??0)+i.dodgeChance),i.aoeDamage&&(e.aoeDamage=(e.aoeDamage??0)+i.aoeDamage),i.aoeRadius&&(e.aoeRadius=Math.max(e.aoeRadius??0,i.aoeRadius)),i.damageMult&&(e.damageMult=(e.damageMult??1)*i.damageMult),i.attackSpeedMult&&(e.attackSpeedMult=(e.attackSpeedMult??1)*i.attackSpeedMult),i.speedMult&&(e.speedMult=(e.speedMult??1)*i.speedMult),i.xpMult&&(e.xpMult=(e.xpMult??1)*i.xpMult),i.goldMult&&(e.goldMult=(e.goldMult??1)*i.goldMult),i.statusOnHit&&(!e.statusOnHit||(i.statusDamage??0)>(e.statusDamage??0))&&(e.statusOnHit=i.statusOnHit,e.statusDuration=i.statusDuration,e.statusDamage=i.statusDamage)}return e}serialize(){return{totalCollected:this.totalCollected,activeBoonIds:this.activeBoons.map(e=>e.id)}}deserialize(e){if(this.totalCollected=e.totalCollected??0,this.activeBoons=[],e.activeBoonIds)for(const t of e.activeBoonIds){const i=Zi.get(t);i&&this.activeBoons.push(i)}}}const ga=4,Dc=20,Ec=.8,qc=3,Bc=.33;class Fc{regions=new Map;onDepletedCbs=[];onRegrowthCbs=[];onDepleted(e){this.onDepletedCbs.push(e)}onRegrowth(e){this.onRegrowthCbs.push(e)}getRegionKey(e,t){const i=Math.floor(e/(ga*16)),s=Math.floor(t/(ga*16));return`${i},${s}`}recordHarvest(e,t){const i=this.getRegionKey(e,t);let s=this.regions.get(i);if(s||(s={harvested:0,maxResources:Dc,regrowthDays:0,depleted:!1},this.regions.set(i,s)),s.depleted)return!1;if(s.harvested++,s.regrowthDays=qc,s.harvested/s.maxResources>=Ec){s.depleted=!0;for(const a of this.onDepletedCbs)a(i)}return!0}canHarvest(e,t){const i=this.getRegionKey(e,t),s=this.regions.get(i);return s?!s.depleted:!0}getDepletionPct(e,t){const i=this.getRegionKey(e,t),s=this.regions.get(i);return s?s.harvested/s.maxResources:0}advanceDay(){for(const[e,t]of this.regions){if(t.harvested<=0)continue;t.regrowthDays--;const i=Math.ceil(t.maxResources*Bc);if(t.harvested=Math.max(0,t.harvested-i),(t.harvested<=0||t.regrowthDays<=0)&&(t.harvested=0,t.regrowthDays=0,t.depleted)){t.depleted=!1;for(const s of this.onRegrowthCbs)s(e)}}}getDepletedRegions(){const e=[];for(const[t,i]of this.regions)i.depleted&&e.push(t);return e}getRegionState(e,t){const i=this.getRegionKey(e,t);return this.regions.get(i)??null}serialize(){const e={};for(const[t,i]of this.regions)e[t]={...i};return{regions:e}}deserialize(e){if(this.regions.clear(),e.regions)for(const[t,i]of Object.entries(e.regions))this.regions.set(t,i)}}const _t=[{id:"haven_rotwood_bridge",name:"Collapsed Bridge",description:"An old stone bridge connecting Haven to Rotwood. Repair it to cross freely.",fromBiome:"haven",toBiome:"rotwood",fromX:800,fromY:200,toX:1200,toY:200,cost:{gold:200},bidirectional:!0},{id:"haven_rotwood_tunnel",name:"Root Tunnel",description:"A hidden tunnel beneath ancient tree roots.",fromBiome:"haven",toBiome:"rotwood",fromX:400,fromY:600,toX:1e3,toY:500,cost:{itemId:"dark_wood",itemQty:10},bidirectional:!0},{id:"rotwood_ashlands_gate",name:"Scorched Gate",description:"A massive iron gate sealed by volcanic heat.",fromBiome:"rotwood",toBiome:"ashlands",fromX:1600,fromY:300,toX:2e3,toY:300,cost:{gold:500},bidirectional:!0},{id:"rotwood_ashlands_cavern",name:"Lava Cavern",description:"A treacherous cave passage through volcanic rock.",fromBiome:"rotwood",toBiome:"ashlands",fromX:1400,fromY:700,toX:1900,toY:600,cost:{itemId:"fire_essence",itemQty:5},bidirectional:!0},{id:"ashlands_drowned_aqueduct",name:"Ruined Aqueduct",description:"An ancient water channel connecting fire and flood.",fromBiome:"ashlands",toBiome:"drowned",fromX:2400,fromY:400,toX:2800,toY:400,cost:{gold:800},bidirectional:!0},{id:"drowned_bone_passage",name:"Sunken Passage",description:"A flooded corridor leading to the desert.",fromBiome:"drowned",toBiome:"bone",fromX:3200,fromY:300,toX:3600,toY:300,cost:{gold:1200},bidirectional:!0},{id:"bone_void_rift",name:"Void Rift",description:"A tear in reality leading to the space between worlds.",fromBiome:"bone",toBiome:"void",fromX:4e3,fromY:400,toX:4400,toY:400,cost:{itemId:"void_shard",itemQty:3},bidirectional:!0},{id:"haven_ashlands_portal",name:"Ancient Portal",description:"A forgotten teleportation circle from before the corruption.",fromBiome:"haven",toBiome:"ashlands",fromX:600,fromY:100,toX:2200,toY:100,cost:{gold:1500,itemId:"crystal_shard",itemQty:10},bidirectional:!0},{id:"rotwood_drowned_canal",name:"Flooded Canal",description:"A water-filled canal connecting the forest to the depths.",fromBiome:"rotwood",toBiome:"drowned",fromX:1500,fromY:500,toX:2900,toY:500,cost:{gold:1e3},bidirectional:!0}],at=new Map;for(const r of _t)at.set(r.id,r);class zc{unlocked=new Set;onUnlockCbs=[];onUnlock(e){this.onUnlockCbs.push(e)}unlock(e){if(!at.has(e)||this.unlocked.has(e))return!1;this.unlocked.add(e);for(const t of this.onUnlockCbs)t(e);return!0}isUnlocked(e){return this.unlocked.has(e)}getUnlockedShortcuts(){return _t.filter(e=>this.unlocked.has(e.id))}getShortcutsFrom(e){return _t.filter(t=>this.unlocked.has(t.id)&&(t.fromBiome===e||t.bidirectional&&t.toBiome===e))}getAllShortcuts(){return _t.map(e=>({def:e,unlocked:this.unlocked.has(e.id)}))}getDestination(e,t,i){const s=at.get(e);if(!s||!this.unlocked.has(e))return null;const a=Math.sqrt((t-s.fromX)**2+(i-s.fromY)**2),o=Math.sqrt((t-s.toX)**2+(i-s.toY)**2);return a<o?{x:s.toX,y:s.toY}:s.bidirectional?{x:s.fromX,y:s.fromY}:null}getUnlockedCount(){return this.unlocked.size}getTotalCount(){return _t.length}serialize(){return{unlocked:Array.from(this.unlocked)}}deserialize(e){if(this.unlocked.clear(),e.unlocked)for(const t of e.unlocked)this.unlocked.add(t)}}const rr=[{id:"imprint_harvest_horror",bossId:"harvest_horror",name:"Nature's Wrath",description:"+15% damage, +1 HP/s regen. Haven enemies become aggressive.",effects:{damageMult:1.15,hpRegen:1},aggroBiome:"haven",aggroMult:1.5,color:"#44ff44",lore:"The Horror's primal fury courses through you. The forest knows."},{id:"imprint_blight_mother",bossId:"blight_mother",name:"Spore Veil",description:"+20% defense, -15% resolve drain. Rotwood enemies become aggressive.",effects:{defenseMult:1.2,resolveResist:.15},aggroBiome:"rotwood",aggroMult:1.6,color:"#88aa44",lore:"Decay is patient. You have absorbed the Mother's endurance."},{id:"imprint_stone_titan",bossId:"stone_titan",name:"Titan's Fortitude",description:"+40 max HP, +10 max stamina, -5% speed. Ashlands enemies become aggressive.",effects:{maxHpAdd:40,maxStaminaAdd:10,speedMult:.95},aggroBiome:"ashlands",aggroMult:1.5,color:"#ff6600",lore:"Stone remembers. You carry the weight of the mountain itself."},{id:"imprint_kraken",bossId:"kraken",name:"Depth's Embrace",description:"+20% speed, +5% crit. Drowned enemies become aggressive.",effects:{speedMult:1.2,critChanceAdd:.05},aggroBiome:"drowned",aggroMult:1.7,color:"#4488ff",lore:"The deep currents flow through you. Tides obey your movement."},{id:"imprint_sand_wyrm",bossId:"sand_wyrm",name:"Burrower's Instinct",description:"+2 stamina/s regen, +15% XP. Bone Wastes enemies become aggressive.",effects:{staminaRegen:2,xpMult:1.15},aggroBiome:"bone",aggroMult:1.6,color:"#ccaa44",lore:"The sands whisper. You sense what lies beneath."},{id:"imprint_void_weaver",bossId:"void_weaver",name:"Void Sight",description:"+25% damage, +20% gold. Void enemies become aggressive.",effects:{damageMult:1.25,goldMult:1.2},aggroBiome:"void",aggroMult:1.8,color:"#aa44ff",lore:"You have glimpsed the space between spaces. Nothing is hidden."},{id:"imprint_storm_lord",bossId:"storm_lord",name:"Tempest Crown",description:"+10% all stats. Edilas enemies become aggressive.",effects:{damageMult:1.1,defenseMult:1.1,speedMult:1.1,xpMult:1.1},aggroBiome:"edilas",aggroMult:2,color:"#ffdd44",lore:"Lightning answers to you now. The storm is yours to command."},{id:"imprint_world_serpent",bossId:"world_serpent",name:"Serpent's Cycle",description:"+30% damage, +20% defense, +3 HP/s regen. All enemies more aggressive.",effects:{damageMult:1.3,defenseMult:1.2,hpRegen:3},aggroBiome:"all",aggroMult:1.5,color:"#ff4488",lore:"The cycle of the world flows through you. Creation and destruction are one."}],Tt=new Map;for(const r of rr)Tt.set(r.id,r);const or=new Map;for(const r of rr)or.set(r.bossId,r.id);const fa=3;class Hc{unlocked=new Set;active=[];onUnlockCbs=[];onEquipChangeCbs=[];onUnlock(e){this.onUnlockCbs.push(e)}onEquipChange(e){this.onEquipChangeCbs.push(e)}unlockFromBoss(e){const t=or.get(e);if(!t||this.unlocked.has(t))return!1;this.unlocked.add(t);for(const i of this.onUnlockCbs)i(t);return!0}isUnlocked(e){return this.unlocked.has(e)}getUnlocked(){return Array.from(this.unlocked)}equip(e){if(!this.unlocked.has(e)||this.active.includes(e)||this.active.length>=fa)return!1;this.active.push(e);for(const t of this.onEquipChangeCbs)t();return!0}unequip(e){const t=this.active.indexOf(e);if(t===-1)return!1;this.active.splice(t,1);for(const i of this.onEquipChangeCbs)i();return!0}getActive(){return[...this.active]}isActive(e){return this.active.includes(e)}getRemainingSlots(){return fa-this.active.length}getCombinedEffects(){const e={};for(const t of this.active){const i=Tt.get(t);if(!i)continue;const s=i.effects;s.damageMult&&(e.damageMult=(e.damageMult??1)*s.damageMult),s.defenseMult&&(e.defenseMult=(e.defenseMult??1)*s.defenseMult),s.speedMult&&(e.speedMult=(e.speedMult??1)*s.speedMult),s.xpMult&&(e.xpMult=(e.xpMult??1)*s.xpMult),s.goldMult&&(e.goldMult=(e.goldMult??1)*s.goldMult),s.elementalDamageMult&&(e.elementalDamageMult=(e.elementalDamageMult??1)*s.elementalDamageMult),s.maxHpAdd&&(e.maxHpAdd=(e.maxHpAdd??0)+s.maxHpAdd),s.maxStaminaAdd&&(e.maxStaminaAdd=(e.maxStaminaAdd??0)+s.maxStaminaAdd),s.critChanceAdd&&(e.critChanceAdd=(e.critChanceAdd??0)+s.critChanceAdd),s.hpRegen&&(e.hpRegen=(e.hpRegen??0)+s.hpRegen),s.staminaRegen&&(e.staminaRegen=(e.staminaRegen??0)+s.staminaRegen),s.resolveResist&&(e.resolveResist=(e.resolveResist??0)+s.resolveResist)}return e}getAggroMultForBiome(e){let t=1;for(const i of this.active){const s=Tt.get(i);s&&(s.aggroBiome===e||s.aggroBiome==="all")&&(t*=s.aggroMult)}return t}getActiveDefs(){return this.active.map(e=>Tt.get(e)).filter(e=>e!==void 0)}serialize(){return{unlocked:Array.from(this.unlocked),active:[...this.active]}}deserialize(e){this.unlocked=new Set(e.unlocked??[]),this.active=e.active??[]}}const nr=[{id:"quirk_night_hunter",name:"Night Hunter",description:"+10% damage in darkness.",polarity:"positive",trigger:"fight_in_dark",triggerThreshold:15,effects:{damageMult:1.1},crystallizedBonus:{nightVision:!0,critChanceAdd:.05},crystallizedDescription:"Night vision + 5% crit in darkness."},{id:"quirk_ironclad",name:"Ironclad",description:"+10% defense.",polarity:"positive",trigger:"take_many_hits",triggerThreshold:50,effects:{defenseMult:1.1},crystallizedBonus:{maxHpAdd:15},crystallizedDescription:"+15 max HP."},{id:"quirk_blade_dancer",name:"Blade Dancer",description:"+3% dodge chance.",polarity:"positive",trigger:"dodge_often",triggerThreshold:30,effects:{dodgeChance:.03},crystallizedBonus:{speedMult:1.1},crystallizedDescription:"+10% movement speed."},{id:"quirk_shadow_striker",name:"Shadow Striker",description:"+5% crit chance.",polarity:"positive",trigger:"backstab_often",triggerThreshold:20,effects:{critChanceAdd:.05},crystallizedBonus:{critMultAdd:.2},crystallizedDescription:"+20% crit multiplier."},{id:"quirk_deflector",name:"Deflector",description:"+5% defense, +2% dodge.",polarity:"positive",trigger:"parry_often",triggerThreshold:25,effects:{defenseMult:1.05,dodgeChance:.02},crystallizedBonus:{damageMult:1.05},crystallizedDescription:"+5% damage (parry mastery)."},{id:"quirk_gourmet",name:"Gourmet",description:"+10% XP gain.",polarity:"positive",trigger:"eat_cooked_food",triggerThreshold:20,effects:{xpMult:1.1},crystallizedBonus:{maxHpAdd:10},crystallizedDescription:"+10 max HP from well-nourished body."},{id:"quirk_explorer",name:"Explorer",description:"+10% speed, +10% gold.",polarity:"positive",trigger:"explore_new_biome",triggerThreshold:4,effects:{speedMult:1.1,goldMult:1.1},crystallizedBonus:{xpMult:1.1},crystallizedDescription:"+10% XP from worldly experience."},{id:"quirk_last_stand",name:"Last Stand",description:"+15% damage when below 30% HP.",polarity:"positive",trigger:"survive_low_hp",triggerThreshold:10,effects:{damageMult:1.15},crystallizedBonus:{resolveResist:.1},crystallizedDescription:"+10% resolve resistance from tempered will."},{id:"quirk_corruption_touched",name:"Corruption Touched",description:"-5% max HP.",polarity:"negative",trigger:"fight_in_corruption",triggerThreshold:20,effects:{maxHpAdd:-10},crystallizedBonus:{corruptionResist:!0,damageMult:1.1},crystallizedDescription:"Corruption resistance + 10% damage on corrupted tiles."},{id:"quirk_savage_appetite",name:"Savage Appetite",description:"-5% defense.",polarity:"negative",trigger:"eat_raw_food",triggerThreshold:10,effects:{defenseMult:.95},crystallizedBonus:{noFoodDecay:!0},crystallizedDescription:"Food never spoils (iron stomach)."},{id:"quirk_gold_fever",name:"Gold Fever",description:"-5% speed.",polarity:"negative",trigger:"hoard_gold",triggerThreshold:3,effects:{speedMult:.95},crystallizedBonus:{goldMult:1.25},crystallizedDescription:"+25% gold from kills."},{id:"quirk_reckless",name:"Reckless",description:"-5% defense, +5% damage.",polarity:"negative",trigger:"overkill",triggerThreshold:20,effects:{defenseMult:.95,damageMult:1.05},crystallizedBonus:{critMultAdd:.3},crystallizedDescription:"+30% crit multiplier from unhinged fury."},{id:"quirk_cowardly",name:"Cowardly",description:"-10% damage.",polarity:"negative",trigger:"run_from_combat",triggerThreshold:10,effects:{damageMult:.9},crystallizedBonus:{speedMult:1.15,dodgeChance:.05},crystallizedDescription:"+15% speed, +5% dodge (tactical retreat mastery)."}],$e=new Map;for(const r of nr)$e.set(r.id,r);const Oc=5,Lc=5,Wc=15,Nc="memstone";class Qc{quirks=[];behaviorCounters=new Map;onQuirkGainedCbs=[];onQuirkLostCbs=[];onQuirkCrystallizedCbs=[];onQuirkGained(e){this.onQuirkGainedCbs.push(e)}onQuirkLost(e){this.onQuirkLostCbs.push(e)}onQuirkCrystallized(e){this.onQuirkCrystallizedCbs.push(e)}recordBehavior(e){const t=(this.behaviorCounters.get(e)??0)+1;this.behaviorCounters.set(e,t);for(const i of nr){if(i.trigger!==e||t<i.triggerThreshold||this.quirks.some(o=>o.defId===i.id))continue;const s=this.quirks.filter(o=>{const n=$e.get(o.defId);return n&&n.polarity===i.polarity}).length,a=i.polarity==="positive"?Oc:Lc;if(!(s>=a)){this.quirks.push({defId:i.id,instability:100,crystallized:!1}),this.behaviorCounters.set(e,0);for(const o of this.onQuirkGainedCbs)o(i.id)}}}advanceDay(){for(let e=this.quirks.length-1;e>=0;e--){const t=this.quirks[e];if(!t.crystallized&&(t.instability-=Wc,t.instability<=0)){const i=t.defId;this.quirks.splice(e,1);for(const s of this.onQuirkLostCbs)s(i)}}}crystallize(e){const t=this.quirks.find(i=>i.defId===e);if(!t||t.crystallized)return!1;t.crystallized=!0,t.instability=100;for(const i of this.onQuirkCrystallizedCbs)i(e);return!0}getQuirks(){return[...this.quirks]}getQuirksByPolarity(e){return this.quirks.filter(t=>{const i=$e.get(t.defId);return i&&i.polarity===e})}hasQuirk(e){return this.quirks.some(t=>t.defId===e)}isCrystallized(e){return this.quirks.some(t=>t.defId===e&&t.crystallized)}getCombinedEffects(){const e={};for(const t of this.quirks){const i=$e.get(t.defId);i&&(this.mergeEffects(e,i.effects),t.crystallized&&this.mergeEffects(e,i.crystallizedBonus))}return e}mergeEffects(e,t){t.damageMult&&(e.damageMult=(e.damageMult??1)*t.damageMult),t.defenseMult&&(e.defenseMult=(e.defenseMult??1)*t.defenseMult),t.speedMult&&(e.speedMult=(e.speedMult??1)*t.speedMult),t.xpMult&&(e.xpMult=(e.xpMult??1)*t.xpMult),t.goldMult&&(e.goldMult=(e.goldMult??1)*t.goldMult),t.maxHpAdd&&(e.maxHpAdd=(e.maxHpAdd??0)+t.maxHpAdd),t.critChanceAdd&&(e.critChanceAdd=(e.critChanceAdd??0)+t.critChanceAdd),t.critMultAdd&&(e.critMultAdd=(e.critMultAdd??0)+t.critMultAdd),t.resolveResist&&(e.resolveResist=(e.resolveResist??0)+t.resolveResist),t.dodgeChance&&(e.dodgeChance=(e.dodgeChance??0)+t.dodgeChance),t.noFoodDecay&&(e.noFoodDecay=!0),t.nightVision&&(e.nightVision=!0),t.corruptionResist&&(e.corruptionResist=!0)}getBehaviorCount(e){return this.behaviorCounters.get(e)??0}getMemstoneItemId(){return Nc}serialize(){return{quirks:this.quirks.map(e=>({...e})),counters:Array.from(this.behaviorCounters.entries())}}deserialize(e){if(this.quirks=(e.quirks??[]).map(t=>({...t})),this.behaviorCounters.clear(),e.counters)for(const[t,i]of e.counters)this.behaviorCounters.set(t,i)}}const ws=[{id:"echo_assassin",name:"Assassin's Echo",sequence:["backstab","backstab"],damageMult:2.5,description:"Two backstab kills: phantom backstab strike.",color:"#ff88ff"},{id:"echo_executioner",name:"Executioner's Echo",sequence:["crit","crit","crit"],damageMult:3,description:"Three critical kills: devastating phantom strike.",color:"#ffaa00"},{id:"echo_riposte",name:"Riposte Echo",sequence:["parry_kill","normal"],damageMult:2,description:"Parry kill then normal kill: retaliatory phantom strike.",color:"#44aaff"},{id:"echo_elemental_surge",name:"Elemental Surge",sequence:["elemental","elemental"],damageMult:2.2,description:"Two elemental kills: phantom elemental burst.",color:"#44ffaa"},{id:"echo_berserker",name:"Berserker's Echo",sequence:["overkill","overkill"],damageMult:3.5,description:"Two overkills: massive phantom strike.",color:"#ff2222"},{id:"echo_shadow_dance",name:"Shadow Dance",sequence:["backstab","crit"],damageMult:2.8,description:"Backstab then crit kill: shadowy phantom slash.",color:"#cc44ff"},{id:"echo_perfect_chain",name:"Perfect Chain",sequence:["parry_kill","backstab","crit"],damageMult:4,description:"Parry  backstab  crit: ultimate phantom chain.",color:"#ffffff"}],es=new Map;for(const r of ws)es.set(r.id,r);const Gc=5,ya=3,Pi=15,Uc=1;class $c{killLog=[];echoCharges=0;lastPatternId=null;decayTimer=0;storedDamage=0;totalEchosReleased=0;onEchoChargedCbs=[];onEchoReleasedCbs=[];onEchoCharged(e){this.onEchoChargedCbs.push(e)}onEchoReleased(e){this.onEchoReleasedCbs.push(e)}recordKill(e,t){this.killLog.push({killType:e,damage:t,timestamp:Date.now()}),this.killLog.length>Gc&&this.killLog.shift(),this.decayTimer=Pi,this.checkPatterns()}checkPatterns(){for(const e of ws){const t=e.sequence;if(this.killLog.length<t.length)continue;const i=this.killLog.slice(-t.length);let s=!0;for(let a=0;a<t.length;a++)if(i[a].killType!==t[a]){s=!1;break}if(s&&this.echoCharges<ya){this.echoCharges++,this.lastPatternId=e.id;const a=i.reduce((o,n)=>o+n.damage,0);this.storedDamage=Math.round(a/i.length);for(const o of this.onEchoChargedCbs)o(e.id,this.echoCharges);this.killLog.splice(-t.length);break}}}releaseEcho(){if(this.echoCharges<=0)return 0;const t=(this.lastPatternId?es.get(this.lastPatternId):null)?.damageMult??2,i=Math.round(this.storedDamage*t);this.echoCharges--,this.totalEchosReleased++;for(const s of this.onEchoReleasedCbs)s(i,this.lastPatternId);return this.echoCharges<=0&&(this.lastPatternId=null,this.storedDamage=0),i}update(e){this.echoCharges<=0||(this.decayTimer-=e,this.decayTimer<=0&&(this.echoCharges=Math.max(0,this.echoCharges-Uc),this.echoCharges<=0&&(this.lastPatternId=null,this.storedDamage=0),this.decayTimer=Pi))}getCharges(){return this.echoCharges}getMaxCharges(){return ya}getLastPattern(){return this.lastPatternId?es.get(this.lastPatternId)??null:null}getDecayTimer(){return this.decayTimer}getStoredDamage(){return this.storedDamage}getKillLog(){return[...this.killLog]}getTotalReleased(){return this.totalEchosReleased}serialize(){return{killLog:[...this.killLog],echoCharges:this.echoCharges,lastPatternId:this.lastPatternId,storedDamage:this.storedDamage,totalReleased:this.totalEchosReleased}}deserialize(e){this.killLog=e.killLog??[],this.echoCharges=e.echoCharges??0,this.lastPatternId=e.lastPatternId??null,this.storedDamage=e.storedDamage??0,this.totalEchosReleased=e.totalReleased??0,this.decayTimer=this.echoCharges>0?Pi:0}}class jc{eid;scene;sprite;nameText;def;currentTarget=null;moveSpeed=40;interactable=!1;interactIcon=null;constructor(e,t,i,s){this.scene=e,this.def=t,this.eid=No(i,s,t.texture),this.sprite=e.add.image(i,s,t.texture),this.sprite.setDepth(5e3),this.nameText=e.add.text(i,s-24,t.name,{fontFamily:"monospace",fontSize:"9px",color:"#aaffaa",stroke:"#000000",strokeThickness:1}),this.nameText.setOrigin(.5),this.nameText.setDepth(5001)}update(e,t,i,s){const a=this.eid;if(this.currentTarget){const l=f.x[a],c=f.y[a],d=this.currentTarget.x-l,h=this.currentTarget.y-c,u=Math.sqrt(d*d+h*h);if(u>4){const m=d/u,g=h/u;b.vx[a]=m*this.moveSpeed,b.vy[a]=g*this.moveSpeed,this.sprite.setFlipX(m<0)}else b.vx[a]=0,b.vy[a]=0,this.currentTarget=null,v.state[a]=M.Idle}else b.vx[a]=0,b.vy[a]=0;this.sprite.setPosition(f.x[a],f.y[a]),this.nameText.setPosition(f.x[a],f.y[a]-24);const o=x.Math.Distance.Between(f.x[a],f.y[a],t,i),n=this.interactable;this.interactable=o<=s,this.interactable&&!n?this.showInteractIcon():!this.interactable&&n&&this.hideInteractIcon(),this.interactIcon&&this.interactIcon.setPosition(f.x[a],f.y[a]-36)}updateSchedule(e,t){const i=this.def.schedule[t.toLowerCase()]??this.def.schedule.spring??[];let s=null;for(const a of i)a.hour<=e&&(!s||a.hour>s.hour)&&(s=a);s&&(this.currentTarget={x:s.x,y:s.y},v.state[this.eid]=M.Patrol)}isInteractable(){return this.interactable}getDef(){return this.def}getId(){return this.def.id}getEid(){return this.eid}getPosition(){return{x:f.x[this.eid],y:f.y[this.eid]}}hasShop(){return!!this.def.shop}getShop(){return this.def.shop??null}showInteractIcon(){this.interactIcon||(this.interactIcon=this.scene.add.text(0,0,"[E]",{fontFamily:"monospace",fontSize:"10px",color:"#ffff00",stroke:"#000000",strokeThickness:2}),this.interactIcon.setOrigin(.5),this.interactIcon.setDepth(5002))}hideInteractIcon(){this.interactIcon&&(this.interactIcon.destroy(),this.interactIcon=null)}destroy(){this.sprite.destroy(),this.nameText.destroy(),this.hideInteractIcon()}}class Vc{npcs=new Map;scene;lastHour=-1;constructor(e){this.scene=e}spawnNPC(e,t,i){const s=new jc(this.scene,e,t,i);return this.npcs.set(e.id,s),s}update(e,t,i,s){for(const a of this.npcs.values())a.update(e,t,i,s)}updateSchedules(e,t){if(e!==this.lastHour){this.lastHour=e;for(const i of this.npcs.values())i.updateSchedule(e,t)}}getInteractableNPC(){for(const e of this.npcs.values())if(e.isInteractable())return e;return null}getNPC(e){return this.npcs.get(e)??null}getAllIds(){return Array.from(this.npcs.keys())}destroy(){for(const e of this.npcs.values())e.destroy();this.npcs.clear()}}const Pt=[{id:"haven",name:"Haven",description:"The last safe refuge in a world overrun by darkness.",biome:"plains",population:25,x:0,y:0,buildings:[{id:"house",name:"Player House",type:"house",services:["bed","storage"]},{id:"guild_hall",name:"Adventurer's Guild",type:"guild",services:["quests","bounties","training"]},{id:"blacksmith",name:"Garrett's Forge",type:"blacksmith",services:["repair","upgrade","smelt"]},{id:"tavern",name:"The Rusty Tankard",type:"tavern",services:["bed","food","drink","socialize"]},{id:"general_store",name:"Martha's General Store",type:"shop",services:["buy","sell"]},{id:"farm_stand",name:"Farm Stand",type:"farm",services:["buy_seeds","sell_crops"]},{id:"clinic",name:"Dr. Elena's Clinic",type:"other",services:["heal","cure_status"]},{id:"pet_shop",name:"Penny's Pet Paradise",type:"shop",services:["buy_pets","pet_care"]},{id:"wizard_tower",name:"Eldric's Tower",type:"library",services:["enchant","research"]}],shops:[{shopId:"general_store",items:["parsnip_seeds","potato_seeds","cauliflower_seeds","tomato_seeds","melon_seeds","corn_seeds","wheat_seeds","hot_pepper_seeds","hops_starter","pumpkin_seeds","grape_starter","carrot_seeds","bread","apple","fishing_rod","hay"]},{shopId:"blacksmith",items:["pickaxe","axe","hoe","watering_can","sword","iron_sword","steel_sword","battle_axe","iron_battle_axe","leather_armor","leather_cap","chainmail","iron_helm","iron_ring"]},{shopId:"tavern",items:["bread","ale","mead","wine","cider","cooked_fish","vegetable_soup"]},{shopId:"adventurer_guild",items:["sword","dagger","iron_spear","hunting_bow","oak_staff","health_potion","stamina_potion","bomb","leather_armor","leather_cap"]},{shopId:"pet_shop",items:["dog","cat","parrot","owl","fox"]},{shopId:"ranch",items:["hay","chicken","duck","rabbit","cow","goat","sheep","pig","horse"]}],npcs:["mayor","shopkeeper","blacksmith","farmer_girl","innkeeper","wizard","adventurer","doctor","pet_seller"],hasDungeon:!1,hasRiftPortal:!1},{id:"ironhold",name:"Ironhold",description:"A mining fortress carved into the mountain.",biome:"mountain",population:15,x:2500,y:-2e3,buildings:[{id:"forge",name:"Ironhold Forge",type:"blacksmith",services:["smelt","repair","upgrade"]},{id:"mine_entrance",name:"Mine Entrance",type:"other",services:["mining","exploration"]},{id:"ore_depot",name:"Ore Depot",type:"market",services:["buy_ore","sell_ore","storage"]}],shops:[{shopId:"blacksmith",items:["pickaxe","iron_pickaxe","copper_bar","iron_bar","gold_bar","coal"]},{shopId:"ore_trader",items:["copper_ore","iron_ore","gold_ore","iridium_ore","coal","stone"]}],npcs:["ironhold_forgemaster","ironhold_miner","ironhold_trader"],unlockCondition:"explore_distance_2000",hasDungeon:!0,dungeonId:"ironhold_mines",hasRiftPortal:!1},{id:"verdant_rest",name:"Verdant Rest",description:"A hidden sanctuary in the deep forest.",biome:"forest",population:10,x:-2200,y:-1500,buildings:[{id:"greenhouse",name:"Enchanted Greenhouse",type:"farm",services:["grow_herbs","rare_seeds"]},{id:"apothecary",name:"Apothecary",type:"shop",services:["buy_potions","sell_herbs","brew"]},{id:"druid_grove",name:"Druid Grove",type:"temple",services:["nature_blessing","heal","purify"]}],shops:[{shopId:"herbalist",items:["fiber","mixed_seeds","health_potion","stamina_potion","rare_herb","antidote"]},{shopId:"potion_shop",items:["health_potion","stamina_potion","speed_potion","defense_potion","luck_potion"]}],npcs:["verdant_herbalist","verdant_druid","verdant_alchemist"],unlockCondition:"quest_find_verdant",hasDungeon:!1,hasRiftPortal:!1},{id:"grimwatch",name:"Grimwatch",description:"A military outpost on the edge of corrupted lands.",biome:"wasteland",population:20,x:1800,y:2200,buildings:[{id:"barracks",name:"Barracks",type:"guild",services:["rest","recruit","training"]},{id:"armory",name:"Armory",type:"blacksmith",services:["buy_weapons","buy_armor","repair"]},{id:"training_grounds",name:"Training Grounds",type:"other",services:["combat_training","sparring"]},{id:"bounty_board",name:"Bounty Board",type:"guild",services:["bounties","monster_hunts"]}],shops:[{shopId:"weapon_master",items:["iron_sword","steel_sword","iron_battle_axe","iron_spear","hunting_bow","war_hammer"]},{shopId:"armor_smith",items:["chainmail","iron_helm","iron_shield","steel_armor","steel_helm","iron_ring"]},{shopId:"bounty_office",items:["health_potion","stamina_potion","bomb","trap","antidote"]}],npcs:["grimwatch_commander","grimwatch_weaponmaster","grimwatch_armorsmith","grimwatch_bounty_hunter"],unlockCondition:"combat_level_5",hasDungeon:!0,dungeonId:"corrupted_wastes",hasRiftPortal:!1},{id:"port_duskfall",name:"Port Duskfall",description:"A coastal trading hub shrouded in eternal twilight.",biome:"coastal",population:30,x:-1500,y:2500,buildings:[{id:"dock",name:"Main Dock",type:"dock",services:["ferry","fishing","ship_repair"]},{id:"warehouse",name:"Warehouse",type:"market",services:["storage","bulk_trade"]},{id:"traders_guild",name:"Trader's Guild",type:"guild",services:["trade_routes","price_info","contracts"]},{id:"lighthouse",name:"Lighthouse",type:"other",services:["navigation","weather_forecast"]}],shops:[{shopId:"fish_market",items:["sardine","anchovy","carp","salmon","rainbow_trout","walleye","sturgeon","bait","bobber"]},{shopId:"exotic_goods",items:["coconut","cactus_fruit","exotic_spice","pearl","coral","ancient_artifact"]},{shopId:"ship_supplies",items:["rope","fishing_rod","bait","lantern","compass","health_potion"]}],npcs:["duskfall_harbormaster","duskfall_fish_merchant","duskfall_exotic_trader","duskfall_ferryman"],unlockCondition:"explore_biome_coastal",hasDungeon:!1,hasRiftPortal:!1},{id:"sanctuary",name:"Sanctuary",description:"A hidden temple where the light still shines.",biome:"sacred",population:12,x:0,y:-3500,buildings:[{id:"temple",name:"Temple of Light",type:"temple",services:["blessing","purification","resurrection","prayer"]},{id:"meditation_garden",name:"Meditation Garden",type:"other",services:["meditate","restore_mana","inner_peace"]},{id:"relic_vault",name:"Relic Vault",type:"library",services:["store_relics","identify_artifacts","lore"]}],shops:[{shopId:"blessed_items",items:["light_fragment","holy_water","blessed_shield","sacred_amulet","purification_scroll"]},{shopId:"artifact_keeper",items:["ancient_artifact","relic_fragment","enchanted_tome","crystal_orb"]}],npcs:["sanctuary_high_priest","sanctuary_relic_keeper","sanctuary_monk"],unlockCondition:"artifact_light_fragment",hasDungeon:!1,hasRiftPortal:!1},{id:"void_dimension_access",name:"The Void Dimension",description:"A rift between worlds where shadow and light intertwine. Only the Voidwalker may enter.",biome:"void",population:3,x:4e3,y:-4e3,buildings:[{id:"void_portal",name:"Void Portal",type:"other",services:["dimensional_travel","void_rift"]},{id:"shadow_forge",name:"Shadow Forge",type:"blacksmith",services:["void_enhancement","shadow_binding","dark_smithing"]},{id:"void_merchant_building",name:"Void Merchant Enclave",type:"shop",services:["buy","sell","void_trade"]}],shops:[{shopId:"void_trader",items:["void_essence","shadow_blade","void_shard","dark_crystal","dimensional_key","void_armor"]}],npcs:["void_merchant","void_guardian","shadow_smith"],unlockCondition:"quest_legend_of_the_void",hasDungeon:!0,dungeonId:"void_dimension",hasRiftPortal:!0},{id:"ancient_greenhouse",name:"Ancient Greenhouse",description:"A mystical greenhouse where ancient crops grow year-round, untouched by the seasons.",biome:"enchanted",population:5,x:500,y:-1e3,buildings:[{id:"ancient_greenhouse_building",name:"Ancient Greenhouse",type:"farm",services:["year_round_growing","crop_enhancement","rare_planting"]},{id:"seed_vault",name:"Seed Vault",type:"shop",services:["buy_rare_seeds","seed_exchange"]},{id:"alchemist_garden",name:"Alchemist Garden",type:"other",services:["herb_growing","potion_brewing","crop_mutation"]}],shops:[{shopId:"rare_seeds",items:["ancient_fruit_seeds","starfruit_seeds","sweet_gem_berry_seeds","rare_herb_seeds","crystal_flower_seeds","void_root_seeds"]}],npcs:["greenhouse_keeper","seed_archivist","crop_alchemist"],unlockCondition:"quest_the_ancient_fruit",hasDungeon:!1,hasRiftPortal:!1},{id:"ocean_temple",name:"Ocean Temple",description:"An ancient underwater temple risen from the depths, home to treasures of the deep.",biome:"ocean",population:8,x:-3e3,y:4e3,buildings:[{id:"coral_hall",name:"Coral Hall",type:"guild",services:["deep_sea_quests","fishing_mastery","ocean_lore"]},{id:"treasure_vault",name:"Treasure Vault",type:"market",services:["store_treasure","appraise","trade_pearls"]},{id:"neptune_shrine",name:"Neptune Shrine",type:"temple",services:["enchanted_fishing","deep_dive","ocean_blessing"]}],shops:[{shopId:"deep_sea_trader",items:["pearl","coral","trident","diving_helm","ocean_amulet","deep_sea_bait"]},{shopId:"pearl_merchant",items:["pearl","black_pearl","golden_pearl","pearl_necklace","pearl_ring"]}],npcs:["ocean_temple_guardian","deep_sea_trader_npc","pearl_merchant_npc","neptune_priest"],unlockCondition:"quest_king_of_the_sea",hasDungeon:!0,dungeonId:"ocean_depths",hasRiftPortal:!1},{id:"dragon_lair_home",name:"Dragon's Lair",description:"The conquered lair of the ancient dragon, now a fortress for the Dragon Slayer.",biome:"volcanic",population:6,x:5e3,y:3e3,buildings:[{id:"dragon_throne",name:"Dragon Throne",type:"house",services:["rest","trophy_display","command"]},{id:"hoard_vault",name:"Hoard Vault",type:"market",services:["storage","treasure_sorting","appraise"]},{id:"drake_stables",name:"Drake Stables",type:"other",services:["dragon_mount","drake_breeding","fire_training"]}],shops:[{shopId:"dragon_forge",items:["dragon_scale_armor","dragon_bone_sword","fire_enchant_scroll","dragon_helm","inferno_ring"]},{shopId:"scale_merchant",items:["dragon_scale","dragon_bone","dragon_fang","fire_ruby","volcanic_ore"]}],npcs:["dragon_lair_smith","dragon_lair_scale_merchant","dragon_lair_stablemaster"],unlockCondition:"quest_dragon_slayer",hasDungeon:!0,dungeonId:"dragon_lair_dungeon",hasRiftPortal:!1},{id:"movie_theater",name:"Movie Theater",description:"A restored entertainment venue where villagers gather to watch shows and socialize.",biome:"plains",population:10,x:800,y:400,buildings:[{id:"theater_hall",name:"Theater Hall",type:"other",services:["movie_showing","date_spot","performances"]},{id:"concession_stand",name:"Concession Stand",type:"shop",services:["buy_snacks","buy_drinks"]},{id:"arcade",name:"Arcade",type:"other",services:["mini_games","prizes","high_scores"]}],shops:[{shopId:"snack_bar",items:["popcorn","candy","soda","nachos","ice_cream","cotton_candy"]}],npcs:["theater_owner","concession_worker","arcade_attendant"],unlockCondition:"quest_community_restoration",hasDungeon:!1,hasRiftPortal:!1},{id:"bus_repair",name:"Desert Bus Stop",description:"The repaired bus line connecting the valley to the Calico Desert.",biome:"desert",population:8,x:3e3,y:0,buildings:[{id:"bus_stop",name:"Bus Stop",type:"other",services:["bus_transport","schedule_info"]},{id:"desert_outpost",name:"Desert Outpost",type:"shop",services:["buy","sell","desert_guide"]},{id:"oasis_well",name:"Oasis Well",type:"other",services:["water_refill","rest","cool_down"]}],shops:[{shopId:"desert_trader",items:["cactus_fruit","coconut","desert_totem","sandstone","sun_amulet","heat_potion"]},{shopId:"cactus_merchant",items:["cactus_fruit","cactus_seeds","aloe_vera","desert_flower","sand_dollar"]}],npcs:["desert_bus_driver","desert_trader_npc","cactus_merchant_npc"],unlockCondition:"quest_community_restoration",hasDungeon:!1,hasRiftPortal:!1}];new Map(Pt.map(r=>[r.id,r]));const ba={[Z.Haven]:"haven",[Z.Rotwood]:"rotwood",[Z.Ashlands]:"ashlands",[Z.Drowned]:"drowned",[Z.BoneWastes]:"bone",[Z.TheVoid]:"void",[Z.Edilas]:"edilas"},Yc=ne([f,S,oe]),Xc={intro_awakening:[{type:"narration",text:"You awaken on soft grass, the world blurring into focus..."},{type:"narration",text:"A village stretches out before you  Haven, they call it."},{type:"dialogue",speaker:"Elder Mira",text:"Ah, you're awake. We found you at the edge of the meadow."},{type:"dialogue",speaker:"Elder Mira",text:"You don't remember anything? That's... troubling. Come, let me show you around."}],corruption_revealed:[{type:"narration",text:"A dark energy pulses from the defeated creature..."},{type:"dialogue",speaker:"Elder Mira",text:"This corruption... it's spreading faster than I feared."},{type:"narration",text:"The path to Rotwood opens before you. The rot must be stopped."}],rotwood_entry:[{type:"narration",text:"The air thickens with spores as you enter the Rotwood."},{type:"narration",text:"Twisted fungi cover every surface. Something is very wrong here."}],blight_mother_reveal:[{type:"narration",text:"The ground shakes. A massive fungal form rises from the depths."},{type:"dialogue",speaker:"???",text:"You dare disturb the mother of rot?"}],ashlands_entry:[{type:"narration",text:"Heat washes over you. The Ashlands stretch out  a sea of ember and stone."},{type:"narration",text:"Here, the forges of old await those brave enough to wield fire."}],stone_titan_awakens:[{type:"narration",text:"The mountain splits apart. A colossal figure of molten rock rises."},{type:"dialogue",speaker:"Stone Titan",text:"WHO DISTURBS MY SLUMBER?"}],drowned_entry:[{type:"narration",text:"Flooded ruins stretch into darkness. Ancient structures rise from the depths."}],rift_discovery:[{type:"narration",text:"A shimmering tear in reality pulses before you  a Rift Portal."},{type:"narration",text:"Step through, if you dare, to face infinite challenges."}],bone_wastes_entry:[{type:"narration",text:"Sun-bleached bones crunch underfoot. The desert hides warring factions."}],void_entry:[{type:"narration",text:"Reality fractures. Colors invert. You have entered The Void."},{type:"narration",text:"Here, the Shadow World awaits those who can channel between dimensions."}],shadow_world_reveal:[{type:"narration",text:"The world shimmers and splits. A dark mirror of reality overlaps."},{type:"dialogue",speaker:"???",text:"You see it now. The truth between worlds."}],edilas_revelation:[{type:"narration",text:"EDILAS  the name echoes through your mind. The land itself is alive."},{type:"dialogue",speaker:"EDILAS",text:"You have come far, pilgrim. The corruption... it is my wound."}],world_serpent_awakens:[{type:"narration",text:"The ground splits across the horizon. A serpent of impossible scale rises."},{type:"dialogue",speaker:"World Serpent",text:"The cycle must continue. You cannot break it."}],ending_pilgrimage_complete:[{type:"narration",text:"The World Serpent falls. The corruption recedes."},{type:"narration",text:"EDILAS breathes free for the first time in eons."},{type:"dialogue",speaker:"EDILAS",text:"Thank you, pilgrim. The cycle is broken... or perhaps, it begins anew."},{type:"narration",text:"A new portal shimmers at Haven. New Game+ awaits."}]},Kc={shop:"general_store",blacksmith:"blacksmith",tavern:"tavern",inn:"inn",library:"library",temple:"temple",house:"player_home",guild:"guard_barracks",market:"general_store",farm:"farmer_house",dock:"fisher_house"};class Jc extends x.Scene{loadSlot;chunkManager;playerController;timeManager;saveManager;inventoryManager;equipmentManager;questManager;skillManager;relationshipManager;craftingManager;farmingManager;fishingManager;cookingManager;weaponMasteryManager;npcManager;storyManager;corruptionManager;riftManager;settlementManager;factionManager;titanManager;weatherManager;audioManager;lightingManager;particleManager;corruptionOverlay;festivalManager;romanceManager;careerManager;achievementManager;mailManager;storageManager;temperatureManager;shadowWorldManager;cityLevelManager;newGamePlusManager;endgameManager;tutorialManager;interiorManager;legendaryQuestManager;abilityManager;cutsceneManager;codexManager;scarReadingManager;pactManager;resolveManager;bountyContractManager;enemyWeaknessManager;omenSlotManager;companionManager;boonManager;resourceCycleManager;shortcutManager;imprintManager;quirkManager;weaponEchoManager;shortcutEntrances=[];scarReadingOverlay=null;scarReadingTimer=0;recentDeadEnemies=[];weatherText;biomeText;coordText;timeText;keyE;inputBlocked=!1;enemySprites=new Map;enemyHPBars=new Map;enemyAnimsCreated=!1;lootDrops=[];lootIdCounter=0;dungeonEntrances=[];settlementEntrances=[];riftEntrances=[];buildingEntrances=[];notifications=[];damageTexts=[];lastBiomeId="";activeBuffs=[];objectHP=new Map;hotbarSlot=0;hotbarKeys=[];playerDead=!1;deathTimer=0;fishingActive=!1;fishingUI=null;cachedDamage=10;cachedDefense=5;cachedEquipHp=0;cachedEquipStamina=0;comboText=null;ngPlusPortalActive=!1;paused=!1;pauseOverlay=null;keyEsc;keyQ;keyR;shadowTintActive=!1;cutsceneOverlay=null;hitstopTimer=0;screenFlash=null;corruptionExposure=0;lastCorruptionMessage=0;corruptionSpawnCooldown=0;resolvePhantomCooldown=10;festivalXpMult=1;festivalLuckMult=1;festivalGoldMult=1;festivalStaminaRegen=0;deathDefianceCharges=1;maxDeathDefianceCharges=1;activeDietSlots=[null,null,null];campfires=[];lastCampfirePos={x:0,y:0};xpForLevel(e){return e*e*50}recalcImprintStats(){const e=this.playerController.getEid(),t=this.imprintManager.getCombinedEffects(),i=this.quirkManager.getCombinedEffects(),s=T.weaponType[e],a=this.weaponMasteryManager.getDamageBonus(s);this.weaponMasteryManager.getSpeedBonus(s),T.damage[e]=this.cachedDamage*(1+a)*(t.damageMult??1)*(i.damageMult??1),T.defense[e]=this.cachedDefense*(t.defenseMult??1)*(i.defenseMult??1),T.attackSpeed[e]=T.attackSpeed[e]*(t.speedMult??1)*(i.speedMult??1),S.max[e]=wt+this.cachedEquipHp+(t.maxHpAdd??0)+(i.maxHpAdd??0),W.max[e]=vt+this.cachedEquipStamina+(t.maxStaminaAdd??0),T.critChance[e]+=(t.critChanceAdd??0)+(i.critChanceAdd??0),T.critMult[e]+=i.critMultAdd??0}constructor(){super({key:"OverworldScene"})}returnX;returnY;init(e){this.loadSlot=e.loadSlot,this.returnX=e.returnX,this.returnY=e.returnY}create(){this.cameras.main.setBackgroundColor("#1a2a1a"),this.cameras.main.fadeIn(600,0,0,0),this.enemySprites.clear(),this.lootDrops=[],this.dungeonEntrances=[],this.settlementEntrances=[],this.riftEntrances=[],this.buildingEntrances=[],this.shortcutEntrances=[],this.notifications=[],this.damageTexts=[],this.inputBlocked=!1,this.activeBuffs=[],this.objectHP.clear(),this.hotbarSlot=0,this.playerDead=!1,this.deathTimer=0,this.fishingActive=!1,this.fishingUI=null,this.chunkManager=new Fo(this,42069),this.enemyAnimsCreated=!1,Ne.getInstance().loadPacks(this,["enemies_common"]).then(()=>{this.createEnemyAnimations()}),this.timeManager=new On(1),this.saveManager=new Wn,this.inventoryManager=new Nn,this.equipmentManager=new Qn,this.questManager=new Gn,this.skillManager=new Un,this.relationshipManager=new Yn,this.craftingManager=new Kn,this.craftingManager.init(),this.farmingManager=new Jn,this.fishingManager=new Zn,this.cookingManager=new el,this.weaponMasteryManager=new al,this.npcManager=new Vc(this),this.storyManager=new rl,this.corruptionManager=new me,this.riftManager=new ll,this.settlementManager=new ul,this.factionManager=new Re,this.titanManager=new yl,this.weatherManager=new wl,this.audioManager=new bs(this),this.lightingManager=new Ja(this),this.lightingManager.init(!1),this.particleManager=new _s(this),this.corruptionOverlay=new Dl(this,this.corruptionManager,this.particleManager),this.festivalManager=new El,this.romanceManager=new Hl,this.careerManager=new Ol,this.achievementManager=new Ll,this.mailManager=new Wl,this.storageManager=new Nl,this.temperatureManager=new $l,this.shadowWorldManager=new Xl,this.cityLevelManager=new Zl,this.newGamePlusManager=new ic,this.endgameManager=new sc,this.tutorialManager=new ac,this.interiorManager=new rc,this.legendaryQuestManager=new oc,this.abilityManager=new nc,this.cutsceneManager=new cc,this.codexManager=new hc,this.scarReadingManager=new mc,this.pactManager=new gc,this.resolveManager=new bc,this.pactManager.isActive(Ji.FragileResolve)&&this.resolveManager.setResolve(50),this.bountyContractManager=new _c,this.enemyWeaknessManager=new Sc,this.omenSlotManager=new Tc,this.companionManager=new Pc,this.boonManager=new Ac,this.resourceCycleManager=new Fc,this.shortcutManager=new zc,this.resourceCycleManager.onDepleted(n=>{this.showNotification(`Region ${n} is depleted. Resources will regrow in a few days.`)}),this.resourceCycleManager.onRegrowth(n=>{this.showNotification(`Region ${n} has regrown! Resources are available again.`)}),this.imprintManager=new Hc,this.quirkManager=new Qc,this.weaponEchoManager=new $c,this.imprintManager.onUnlock(n=>{const l=Tt.get(n);l&&(this.showNotification(`Imprint absorbed: ${l.name}  ${l.description}`),this.triggerScreenFlash(parseInt(l.color.replace("#","0x")),.3),this.audioManager.playSFX(q.LEVEL_UP))}),this.imprintManager.onEquipChange(()=>{this.recalcImprintStats()}),this.quirkManager.onQuirkGained(n=>{const l=$e.get(n);this.showNotification(`Quirk acquired: ${l?.name??n}  ${l?.description??""}`)}),this.quirkManager.onQuirkLost(n=>{const l=$e.get(n);this.showNotification(`Quirk faded: ${l?.name??n}`)}),this.quirkManager.onQuirkCrystallized(n=>{const l=$e.get(n);this.showNotification(`Quirk crystallized: ${l?.name??n}  ${l?.crystallizedDescription??""}`),this.triggerScreenFlash(11206638,.25),this.audioManager.playSFX(q.LEVEL_UP)}),this.weaponEchoManager.onEchoCharged((n,l)=>{const c=ws.find(d=>d.id===n);this.showNotification(`Echo charged [${l}/3]: ${c?.name??"Unknown"}`),this.audioManager.playSFX(q.CRIT_HIT)}),this.weaponEchoManager.onEchoReleased((n,l)=>{this.showNotification(`Echo Strike! ${n} phantom damage!`),this.cameras.main.shake(150,.01)}),this.shortcutManager.onUnlock(n=>{const l=at.get(n);l&&(this.showNotification(`Shortcut unlocked: ${l.name}  ${l.description}`),this.audioManager.playSFX(q.DOOR_OPEN),this.triggerScreenFlash(4521898,.25))}),this.boonManager.onBoonSelected(n=>{const l={common:11184810,rare:4491519,epic:11141375};this.showNotification(`Boon: ${n.name}  ${n.description}`),this.triggerScreenFlash(l[n.rarity]??16777215,.2),this.audioManager.playSFX(q.LEVEL_UP)}),this.companionManager.onKnockout(n=>{this.showNotification(`${n} has been knocked out! They'll recover in 30 seconds.`),this.audioManager.playSFX(q.PLAYER_HIT),this.cameras.main.shake(200,.01)}),this.companionManager.onMoraleLow(n=>{const l=this.companionManager.getActiveDef();l&&this.showNotification(`${l.name}: "${l.lowMoraleLine}"`)}),this.omenSlotManager.onEquipChange(()=>{this.recalcOmenStats()}),this.bountyContractManager.onComplete(n=>{this.showNotification(`CONTRACT COMPLETE: ${n.name}! Bonus rewards earned.`),this.triggerScreenFlash(4521796,.3),this.audioManager.playSFX(q.LEVEL_UP);const l=Math.round(50*n.goldMult*n.tier);this.inventoryManager.addGold(l),this.showNotification(`+${l} bonus gold`),this.particleManager.emit("goldPickup",f.x[this.playerController.getEid()],f.y[this.playerController.getEid()]),this.bountyContractManager.clearActive()}),this.bountyContractManager.onFail(n=>{this.showNotification(`CONTRACT FAILED: ${n.name}. An item has been lost.`),this.triggerScreenFlash(16720418,.3),this.cameras.main.shake(200,.01),this.inventoryManager.removeRandomItem(),this.bountyContractManager.clearActive()}),this.enemyWeaknessManager.onReveal((n,l)=>{const c={weakness:"Weakness",resistance:"Resistance",exploit:"Exploit",mastery:"Mastery"};this.showNotification(`Bestiary: ${n}  ${c[l]} discovered!`),l==="mastery"?(this.audioManager.playSFX(q.LEVEL_UP),this.triggerScreenFlash(16768324,.2)):this.audioManager.playSFX(q.ITEM_PICKUP)});const e=new Map;for(const n of ys)e.set(n.texture,n.id);ln((n,l)=>{if(!U(E,ot,n)||!U(E,oe,l))return 1;const c=jt(V.textureId[l]),d=e.get(c);if(!d)return 1;const h=T.weaponType[n];return this.enemyWeaknessManager.getDamageMultiplier(d,h)}),this.resolveManager.onTrauma(n=>{n.type;const l=n.type==="virtue"?"VIRTUE":"AFFLICTION";this.showNotification(`${l}: ${n.name}  ${n.description}`),n.type==="virtue"?(this.triggerScreenFlash(16768324,.3),this.audioManager.playSFX(q.LEVEL_UP)):(this.triggerScreenFlash(8912896,.4),this.cameras.main.shake(300,.015))}),this.codexManager.onDiscover(n=>{this.showNotification(`Lore discovered: "${n.title}"`),this.audioManager.playSFX(q.ITEM_PICKUP)}),this.scarReadingManager.onRead(n=>{this.codexManager.discover(n.id)});let t=0;for(const n of At)n.homeCity==="haven"&&(this.npcManager.spawnNPC(n,100+t*60,100),t++);this.registerSaveHandlers(),this.wireEvents();const i=ms(0,0);this.playerController=new Tn(this,i),this.cameras.main.startFollow(this.playerController.getSprite(),!0,.1,.1),this.input.on("wheel",(n,l,c,d)=>{const h=this.cameras.main;h.setZoom(x.Math.Clamp(h.zoom-d*.001,.5,3))}),this.keyE=this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.E),this.keyEsc=this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.ESC),this.keyQ=this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.Q),this.keyR=this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.R);const s=[this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.F1),this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.F2),this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.F3),this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.F4)];for(let n=0;n<4;n++)s[n].on("down",()=>{if(this.inputBlocked)return;const c=this.abilityManager.getHotbar()[n];if(!c)return;const d=this.playerController.getEid(),h=W.current[d],u=this.abilityManager.useAbility(c,h);if(u){W.current[d]=Math.max(0,h-u.staminaCost);const m=f.x[d],g=f.y[d],y=u.aoeRadius>0?u.aoeRadius:64,_=ne([oe])(E);for(const w of _)if(x.Math.Distance.Between(m,g,f.x[w],f.y[w])<=y){const F=Math.floor(T.damage[d]*u.damageMult);S.current[w]=Math.max(0,S.current[w]-F),this.particleManager.emit("blood",f.x[w],f.y[w])}this.showNotification(`${u.name}!`),this.audioManager.playSFX(q.SWORD_SWING)}});const a=[x.Input.Keyboard.KeyCodes.ONE,x.Input.Keyboard.KeyCodes.TWO,x.Input.Keyboard.KeyCodes.THREE,x.Input.Keyboard.KeyCodes.FOUR,x.Input.Keyboard.KeyCodes.FIVE,x.Input.Keyboard.KeyCodes.SIX,x.Input.Keyboard.KeyCodes.SEVEN,x.Input.Keyboard.KeyCodes.EIGHT,x.Input.Keyboard.KeyCodes.NINE,x.Input.Keyboard.KeyCodes.ZERO];this.hotbarKeys=a.map(n=>this.input.keyboard.addKey(n)),this.equipmentManager.onEquipChange(n=>{const l=this.playerController.getEid();this.cachedDamage=10+n.damage,this.cachedDefense=5+n.defense,this.cachedEquipHp=n.hp,this.cachedEquipStamina=n.stamina;const c=T.weaponType[l],d=this.weaponMasteryManager.getDamageBonus(c),h=this.weaponMasteryManager.getSpeedBonus(c);T.damage[l]=this.cachedDamage*(1+d),T.defense[l]=this.cachedDefense,T.critChance[l]=.05+n.critChance,T.critMult[l]=1.5+n.critMult,T.attackSpeed[l]=(1+n.attackSpeed)*(1+h),S.max[l]=wt+n.hp,W.max[l]=vt+n.stamina;const u=this.equipmentManager.getEquipped("weapon");if(u){const m=j.get(u.itemId);if(m){T.weaponType[l]=m.weaponType;const g={poison:ae.Poison,burn:ae.Burn,freeze:ae.Freeze,bleed:ae.Bleed,stun:ae.Stun};T.synergyStatus[l]=m.bonusVsStatus?g[m.bonusVsStatus]??ae.None:ae.None,T.synergyMult[l]=m.synergyMult??1;const y=this.abilityManager.getAbilitiesForWeapon(m.weaponType);for(let _=0;_<Math.min(y.length,4);_++)this.abilityManager.unlock(y[_].id),this.abilityManager.setHotbar(_,y[_].id)}}else T.weaponType[l]=p.Unarmed,T.synergyStatus[l]=ae.None,T.synergyMult[l]=1;Hs(this.weaponMasteryManager.getLevel(p.Sword))}),this.scene.isActive("DialogueScene")||this.scene.launch("DialogueScene"),this.createDungeonEntrances(),this.createSettlementEntrances(),this.createBuildingEntrances(),this.createShortcutEntrances();const o={fontFamily:"monospace",fontSize:"12px",color:"#aaaaaa",backgroundColor:"#000000aa",padding:{x:4,y:2}};if(this.coordText=this.add.text(10,660,"",o).setScrollFactor(0).setDepth(9999),this.biomeText=this.add.text(10,680,"",{...o,color:"#7dd3fc"}).setScrollFactor(0).setDepth(9999),this.timeText=this.add.text(10,640,"",{...o,color:"#ffb347"}).setScrollFactor(0).setDepth(9999),this.weatherText=this.add.text(10,620,"",{...o,color:"#88ccff"}).setScrollFactor(0).setDepth(9999),this.registry.set("hotbarSlot",this.hotbarSlot),this.registry.set("activeBuffs",this.activeBuffs),this.registry.set("chunkManager",this.chunkManager),this.registry.set("timeManager",this.timeManager),this.registry.set("inventoryManager",this.inventoryManager),this.registry.set("equipmentManager",this.equipmentManager),this.registry.set("saveManager",this.saveManager),this.registry.set("playerController",this.playerController),this.registry.set("questManager",this.questManager),this.registry.set("skillManager",this.skillManager),this.registry.set("relationshipManager",this.relationshipManager),this.registry.set("craftingManager",this.craftingManager),this.registry.set("farmingManager",this.farmingManager),this.registry.set("fishingManager",this.fishingManager),this.registry.set("cookingManager",this.cookingManager),this.registry.set("weaponMasteryManager",this.weaponMasteryManager),this.registry.set("npcManager",this.npcManager),this.registry.set("storyManager",this.storyManager),this.registry.set("corruptionManager",this.corruptionManager),this.registry.set("riftManager",this.riftManager),this.registry.set("settlementManager",this.settlementManager),this.registry.set("factionManager",this.factionManager),this.registry.set("titanManager",this.titanManager),this.registry.set("weatherManager",this.weatherManager),this.registry.set("audioManager",this.audioManager),this.registry.set("lightingManager",this.lightingManager),this.registry.set("particleManager",this.particleManager),this.registry.set("festivalManager",this.festivalManager),this.registry.set("romanceManager",this.romanceManager),this.registry.set("careerManager",this.careerManager),this.registry.set("achievementManager",this.achievementManager),this.registry.set("mailManager",this.mailManager),this.registry.set("storageManager",this.storageManager),this.registry.set("temperatureManager",this.temperatureManager),this.registry.set("shadowWorldManager",this.shadowWorldManager),this.registry.set("cityLevelManager",this.cityLevelManager),this.registry.set("newGamePlusManager",this.newGamePlusManager),this.registry.set("endgameManager",this.endgameManager),this.registry.set("tutorialManager",this.tutorialManager),this.registry.set("interiorManager",this.interiorManager),this.registry.set("legendaryQuestManager",this.legendaryQuestManager),this.registry.set("abilityManager",this.abilityManager),this.registry.set("cutsceneManager",this.cutsceneManager),this.registry.set("pactManager",this.pactManager),this.registry.set("scarReadingManager",this.scarReadingManager),this.registry.set("resolveManager",this.resolveManager),this.registry.set("bountyContractManager",this.bountyContractManager),this.registry.set("enemyWeaknessManager",this.enemyWeaknessManager),this.registry.set("omenSlotManager",this.omenSlotManager),this.registry.set("companionManager",this.companionManager),this.registry.set("boonManager",this.boonManager),this.registry.set("resourceCycleManager",this.resourceCycleManager),this.registry.set("shortcutManager",this.shortcutManager),this.registry.set("imprintManager",this.imprintManager),this.registry.set("quirkManager",this.quirkManager),this.registry.set("weaponEchoManager",this.weaponEchoManager),this.loadSlot!==void 0?this.saveManager.load(this.loadSlot):(this.inventoryManager.addItem("axe",1,1),this.inventoryManager.addItem("pickaxe",1,1),this.inventoryManager.addItem("hoe",1,1),this.inventoryManager.addItem("watering_can",1,1),this.inventoryManager.addItem("fishing_rod",1,1),this.inventoryManager.addItem("parsnip_seeds",15),this.inventoryManager.addItem("bread",5),this.inventoryManager.addGold(500)),this.returnX!==void 0&&this.returnY!==void 0){const n=this.playerController.getEid();f.x[n]=this.returnX,f.y[n]=this.returnY}this.particleManager.setWeatherParticles(this.weatherManager.getWeatherType()),this.chunkManager.update(0,0)}update(e,t){const i=t/1e3;if(this.inputBlocked=!!this.registry.get("uiPanelOpen"),x.Input.Keyboard.JustDown(this.keyEsc)){if(this.paused)this.closePauseMenu();else if(!this.fishingActive&&!this.inputBlocked){this.openPauseMenu();return}}if(this.paused)return;if(this.timeManager.update(t),this.playerDead){this.deathTimer-=i,this.deathTimer<=0&&this.respawnPlayer();return}if(this.fishingActive){this.updateFishingUI(i);return}if(!this.inputBlocked){this.playerController.update(i),this.playerController.isAttackJustPressed()&&this.playerController.attack()&&(hn(),this.audioManager.playSFX(q.SWORD_SWING)),this.playerController.isDodgeJustPressed()&&this.playerController.dodge()&&(this.cameras.main.shake(60,.003),this.bountyContractManager.onDodge()),this.playerController.isToolUseJustPressed()&&this.handleToolUse();for(let P=0;P<this.hotbarKeys.length;P++)if(x.Input.Keyboard.JustDown(this.hotbarKeys[P])){const Q=this.inventoryManager.getSlot(P);if(Q&&Q.itemId){const $=j.get(Q.itemId);$&&($.category==="food"||$.category==="potion")?this.consumeItem(P):$&&($.category==="tool"||$.category==="seed")&&(this.hotbarSlot=P,this.registry.set("hotbarSlot",P))}else this.hotbarSlot=P,this.registry.set("hotbarSlot",P);break}}for(let P=this.activeBuffs.length-1;P>=0;P--){const Q=this.activeBuffs[P];Q.remaining-=i,this.applyBuffTick(Q,i),Q.remaining<=0&&this.activeBuffs.splice(P,1)}let s=0,a=0;const o=1/this.pactManager.getFoodDurationMult();for(let P=0;P<this.activeDietSlots.length;P++){const Q=this.activeDietSlots[P];if(Q)if(Q.remaining-=i*o,Q.remaining<=0)this.showNotification(`Diet expired: ${Q.name}`),this.activeDietSlots[P]=null,this.registry.set("dietSlots",this.activeDietSlots);else{const $=Q.remaining/Q.duration,ye=$>.5?1:$*2;s+=Math.round(Q.hpBonus*ye),a+=Math.round(Q.staminaBonus*ye)}}{const P=this.playerController.getEid();T.damage[P]=this.cachedDamage+this.getBuffMagnitude("strength"),T.defense[P]=this.cachedDefense+this.getBuffMagnitude("defense"),this.playerController.speedBonus=this.getBuffMagnitude("speed"),S.max[P]=wt+this.cachedEquipHp+s,W.max[P]=vt+this.cachedEquipStamina+a}this.registry.set("pactEnemyAtkSpeedMult",this.pactManager.getEnemyAttackSpeedMult()),this.registry.set("pactCorruptionMult",this.pactManager.getCorruptionSpreadMult()),this.registry.set("pactLightMult",this.pactManager.getLightRevealMult()),this.registry.set("pactBurden",this.pactManager.getTotalBurden()),ps(E,i),Wa(E,i);const n=this.registry.get("weatherAggroMult")??1,l=this.imprintManager.getAggroMultForBiome(this.lastBiomeId);Na(E,i,n*l),fs(E,i),Qa(E,i);const c=this.playerController.getPosition();if(kn(E,c.x,c.y,(P,Q)=>this.chunkManager.getBiomeAt(P,Q),this.timeManager.getDate().season),$a(E,(this.festivalLuckMult>1?this.festivalLuckMult:0)+this.pactManager.getLootRarityBonus()),this.syncEnemySprites(),this.processLootEvents(),this.processDamageEvents(),this.processParryEvents(),this.updateDamageTexts(i),this.updateScarReading(i),this.updateComboDisplay(),this.checkLootPickup(),this.updateLootDrops(i),!this.inputBlocked&&x.Input.Keyboard.JustDown(this.keyE)&&this.handleInteraction(),!this.inputBlocked&&x.Input.Keyboard.JustDown(this.keyQ))if(this.shadowWorldManager.isInShadowWorld())this.shadowWorldManager.exitShadowWorld();else if(this.shadowWorldManager.isChanneling())this.shadowWorldManager.cancelChannel(),this.showNotification("Channeling cancelled.");else if(this.shadowWorldManager.enterShadowWorld())this.showNotification("Channeling into Shadow World...");else{const Q=this.shadowWorldManager.getCooldownRemaining();Q>0&&this.showNotification(`Shadow World on cooldown (${Math.ceil(Q/1e3)}s)`)}if(!this.inputBlocked&&x.Input.Keyboard.JustDown(this.keyR)){const P=this.weaponEchoManager.releaseEcho();if(P>0){const Q=ne([oe])(E);for(const $ of Q)x.Math.Distance.Between(c.x,c.y,f.x[$],f.y[$])<=80&&(S.current[$]=Math.max(0,S.current[$]-P),this.particleManager.emit("critFlash",f.x[$],f.y[$]))}}this.shadowWorldManager.isInShadowWorld()&&!this.shadowTintActive?(this.cameras.main.setPostPipeline([]),this.cameras.main.setBackgroundColor("#110022"),this.shadowTintActive=!0):!this.shadowWorldManager.isInShadowWorld()&&this.shadowTintActive&&(this.cameras.main.setBackgroundColor("#000000"),this.shadowTintActive=!1),this.npcManager.update(i,c.x,c.y,ge);const d=this.timeManager.getDate();this.npcManager.updateSchedules(d.hour,d.season),this.craftingManager.update(i,this.inventoryManager),this.fishingManager.update(i),this.cookingManager.update(i);const h=se.pixelToTile(c.x,c.y),u=this.chunkManager.getBiomeAt(h.tileX,h.tileY),m=ba[u]??"haven";m!==this.lastBiomeId&&(this.lastBiomeId=m,this.audioManager.setBiomeAudio(m)),this.weatherManager.update(i,m),this.titanManager.update(i),this.corruptionManager.spreadCorruption(this.chunkManager.getActiveChunkKeys()),this.temperatureManager.update(m,d.season.toLowerCase(),this.weatherManager.getWeatherType(),d.hour,i);const g=this.temperatureManager.getTemperatureEffects();this.playerController.staminaRegenMult=g.staminaRegenMultiplier,this.playerController.staminaDrainMult=g.staminaDrainMultiplier;const y=this.temperatureManager.getColdExposureTime(),_=this.temperatureManager.getHeatExposureTime();if(y>10||_>10){const P=this.playerController.getEid();S.current[P]=Math.max(0,S.current[P]-1*i)}if(this.festivalStaminaRegen>0){const P=this.playerController.getEid();W.current[P]=Math.min(W.max[P],W.current[P]+this.festivalStaminaRegen*i)}const w=this.weatherManager.getWeatherType(),k=this.weatherManager.getVisibility();(w==="rain"||w==="storm"||w==="acid_rain")&&(this.playerController.speedBonus-=18),(w==="snow"||w==="blizzard")&&(this.playerController.speedBonus-=30),this.registry.set("weatherAggroMult",k),this.registry.set("weatherEnemyDmgMult",w==="void_storm"?1.1:1);const F=this.corruptionManager.getPlayerEffects(h.tileX,h.tileY),H=this.corruptionManager.getCorruption(h.tileX,h.tileY);H>.1?this.corruptionExposure=Math.min(100,this.corruptionExposure+H*5*i):this.corruptionExposure=Math.max(0,this.corruptionExposure-2*i);const A=Date.now();if(A-this.lastCorruptionMessage>15e3){if(this.corruptionExposure>75){const P=["The void whispers your name...","Reality fractures around you.","Your vision darkens at the edges.","Something moves in the shadows..."];this.showNotification(P[Math.floor(Math.random()*P.length)]),this.lastCorruptionMessage=A}else if(this.corruptionExposure>40){const P=["A chill crawls up your spine.","The air feels thick with dread.","You sense eyes watching."];this.showNotification(P[Math.floor(Math.random()*P.length)]),this.lastCorruptionMessage=A}}if(this.corruptionExposure>50){const P=(this.corruptionExposure-50)/200,Q=Math.sin(A/300)*P*3,$=Math.cos(A/250)*P*2;this.cameras.main.setFollowOffset(Q,$)}else this.cameras.main.setFollowOffset(0,0);if(F.slowStamina&&(this.playerController.staminaRegenMult*=.5),this.corruptionExposure>60){const P=1-(this.corruptionExposure-60)/400*.6,Q=this.playerController.getEid();T.damage[Q]*=P}if(F.takeDamage){const P=this.playerController.getEid();S.current[P]=Math.max(0,S.current[P]-2*i)}if(F.spawnShadow&&(this.corruptionSpawnCooldown-=i,this.corruptionSpawnCooldown<=0)){this.corruptionSpawnCooldown=8+Math.random()*7;const P=Math.random()*Math.PI*2,Q=80+Math.random()*60,$=c.x+Math.cos(P)*Q,ye=c.y+Math.sin(P)*Q;Ve($,ye,60,12,4,150,"shadow_wraith",C.Chase),this.showNotification("A shadow materializes from the corruption!"),this.audioManager.playSFX(q.ENEMY_HIT)}const G=this.campfires.some(P=>x.Math.Distance.Between(c.x,c.y,P.x,P.y)<80);this.resolveManager.update(i,H>.1,this.lightingManager.isNight(),this.shadowWorldManager.isInShadowWorld(),m==="haven",G);const Y=this.resolveManager.getEffects();if(Y.combatMult!==1){const P=this.playerController.getEid();T.damage[P]*=Y.combatMult}this.registry.set("resolve",this.resolveManager.getResolve()),this.registry.set("resolveMax",this.resolveManager.getMaxResolve()),this.registry.set("resolveTrauma",this.resolveManager.getTrauma()),this.registry.set("resolveEffects",Y),this.bountyContractManager.update(i,H>.1);const te=this.bountyContractManager.getActive();this.registry.set("bountyContract",te),this.registry.set("bountyContractProgress",this.bountyContractManager.getProgressPct()),this.registry.set("enemyWeaknessManager",this.enemyWeaknessManager),this.companionManager.update(i,H>.1,this.lightingManager.isNight(),m==="haven",G),this.registry.set("companion",this.companionManager.getActive()),this.registry.set("companionDef",this.companionManager.getActiveDef()),this.registry.set("omens",this.omenSlotManager.getEquipped()),this.registry.set("omenOvercharged",this.omenSlotManager.isOvercharged()),this.registry.set("boons",this.boonManager.getActiveBoons()),this.registry.set("boonEffects",this.boonManager.getCombinedEffects());const de=this.omenSlotManager.getCombinedEffects();if(de.hpRegen){const P=this.playerController.getEid();S.current[P]=Math.min(S.max[P],S.current[P]+de.hpRegen*i)}if(de.staminaRegen){const P=this.playerController.getEid();W.current[P]=Math.min(W.max[P],W.current[P]+de.staminaRegen*i)}if(Y.grainIntensity>0){const P=Y.grainIntensity,Q=Math.sin(Date.now()/400)*P*2,$=Math.cos(Date.now()/350)*P*1.5;this.corruptionExposure<=50&&this.cameras.main.setFollowOffset(Q,$)}if(Y.spawnPhantoms){if(this.resolvePhantomCooldown=(this.resolvePhantomCooldown??10)-i,this.resolvePhantomCooldown<=0){this.resolvePhantomCooldown=12+Math.random()*8;const P=Math.random()*Math.PI*2,Q=100+Math.random()*60,$=c.x+Math.cos(P)*Q,ye=c.y+Math.sin(P)*Q;Ve($,ye,40,8,2,120,"shadow_phantom",C.Ambush),this.showNotification("Something stirs in the darkness of your mind...")}}else this.resolvePhantomCooldown=10;this.abilityManager.update(i),this.shadowWorldManager.update(Date.now());const ie=d.hour+d.minute/60;this.lightingManager.update(ie,m,c.x,c.y);const X=this.cameras.main;this.corruptionOverlay.update(i,X.scrollX,X.scrollY,X.width/X.zoom,X.height/X.zoom),this.particleManager.update(i,X.scrollX,X.scrollY,X.width/X.zoom,X.height/X.zoom),this.weaponEchoManager.update(i);const qe=se.worldToScreen(c.x/32,c.y/32);this.chunkManager.update(qe.x,qe.y),this.updateEntranceLabels(c.x,c.y),this.updateNotifications(i);const re=this.playerController.getEid();if(S.current[re]<=0&&!this.playerDead){const P=this.resolveManager.getTrauma()?.disableDeathDefiance??!1;this.deathDefianceCharges>0&&!this.pactManager.isActive(Ji.NoSecondChance)&&!P?(this.deathDefianceCharges--,S.current[re]=Math.round(S.max[re]*.5),this.triggerScreenFlash(16777215,.4),this.cameras.main.shake(200,.015),this.audioManager.playSFX(q.LEVEL_UP),this.showNotification(`Death Defiance! (${this.deathDefianceCharges}/${this.maxDeathDefianceCharges} remaining)`),this.particleManager.emit("levelUp",f.x[re],f.y[re]),nn(re,2e3)):this.handlePlayerDeath()}this.saveManager.updateAutoSave(t,{x:f.x[re],y:f.y[re],hp:this.playerController.getHealth().current,maxHp:this.playerController.getHealth().max,stamina:this.playerController.getStamina().current,maxStamina:this.playerController.getStamina().max,level:T.level[re],xp:T.xp[re]});const Ye=us[u];this.coordText.setText(`Tile: ${h.tileX}, ${h.tileY}`),this.biomeText.setText(`Biome: ${Ye.name} (x${Ye.difficultyMult})`),this.timeText.setText(`${this.timeManager.getDateString()} ${this.timeManager.getTimeString()}`),this.weatherText.setText(`Weather: ${this.weatherManager.getWeatherType()} (${Math.round(this.weatherManager.getVisibility()*100)}% vis)`)}handleInteraction(){const e=this.playerController.getPosition(),t=this.npcManager.getInteractableNPC();if(t){this.resolveManager.onNPCInteraction(),this.openNPCDialogue(t.getDef());return}for(const o of this.dungeonEntrances)if(x.Math.Distance.Between(e.x,e.y,o.x,o.y)<=ge){this.enterDungeon(o.dungeonId);return}for(const o of this.settlementEntrances)if(x.Math.Distance.Between(e.x,e.y,o.x,o.y)<=ge){this.enterSettlement(o.settlementId);return}const i=this.playerController.getFacing(),s=se.pixelToTile(e.x+i.x*48,e.y+i.y*48);if(this.chunkManager.getObjectAt(s.tileX,s.tileY)===z.Chest){this.openStorageChest(s.tileX,s.tileY);return}for(const o of this.riftEntrances)if(x.Math.Distance.Between(e.x,e.y,o.x,o.y)<=ge){this.enterRift();return}for(const o of this.buildingEntrances)if(x.Math.Distance.Between(e.x,e.y,o.x,o.y)<=ge){this.enterBuilding(o.interiorId,o.name);return}if(this.ngPlusPortalActive&&x.Math.Distance.Between(e.x,e.y,0,0)<=ge*2){this.openNGPlusDialog();return}for(const o of this.campfires)if(x.Math.Distance.Between(e.x,e.y,o.x,o.y)<=ge){(this.input.keyboard?.addKey("SHIFT")?.isDown??!1)&&o.kindleLevel<3?this.kindleCampfire(o):this.restAtCampfire(o);return}for(const o of this.shortcutEntrances)if(x.Math.Distance.Between(e.x,e.y,o.x,o.y)<=ge){this.interactWithShortcut(o.shortcutId,o.x,o.y);return}for(let o=this.recentDeadEnemies.length-1;o>=0;o--){const n=this.recentDeadEnemies[o];if(x.Math.Distance.Between(e.x,e.y,n.x,n.y)<=ge){const c=this.scarReadingManager.readEnemyMemory(n.enemyId,"dead");if(c){this.showScarReadingOverlay(c.text),this.recentDeadEnemies.splice(o,1);return}}}}enterRift(){this.riftManager.startRift();const e=this.riftManager.getCurrentFloor();this.showNotification(`Entering Rift  Floor ${e?.floor??1}`),this.audioManager.playSFX(q.DOOR_OPEN);const t=this.playerController.getPosition();this.cameras.main.fadeOut(400,0,0,0),this.time.delayedCall(450,()=>{this.cleanUp(),this.scene.start("DungeonScene",{dungeonId:"rift",returnX:t.x,returnY:t.y})})}enterBuilding(e,t){if(!this.interiorManager.enterInterior(e)){this.showNotification(`Cannot enter ${t}.`);return}if(this.audioManager.playSFX(q.DOOR_OPEN),this.showNotification(`Entered ${t}`),e==="inn"||e==="player_home"){const s=this.playerController.getEid();S.current[s]=S.max[s],W.current[s]=W.max[s],this.showNotification("Fully rested  HP & Stamina restored!")}if(e==="temple"){const s=this.playerController.getEid();S.current[s]=S.max[s],this.showNotification("Blessed  HP fully restored!")}this.time.delayedCall(1500,()=>{this.interiorManager.exitInterior()})}interactWithShortcut(e,t,i){if(this.shortcutManager.isUnlocked(e)){const s=this.playerController.getPosition(),a=this.shortcutManager.getDestination(e,s.x,s.y);a&&(this.audioManager.playSFX(q.DOOR_OPEN),this.cameras.main.fadeOut(300,0,0,0),this.time.delayedCall(350,()=>{const o=this.playerController.getEid();f.x[o]=a.x,f.y[o]=a.y,this.cameras.main.fadeIn(300,0,0,0);const n=at.get(e);this.showNotification(`Traveled via ${n?.name??"shortcut"}`)}))}else{const s=at.get(e);if(!s)return;const a=s.cost;let o=!0;if(a.gold&&this.inventoryManager.getGold()<a.gold&&(o=!1),a.itemId&&a.itemQty&&this.inventoryManager.countItem(a.itemId)<a.itemQty&&(o=!1),!o){let n="";a.gold&&(n+=`${a.gold} gold`),a.itemId&&a.itemQty&&(n&&(n+=" + "),n+=`${a.itemQty}x ${a.itemId}`),this.showNotification(`Cannot unlock ${s.name}. Need: ${n}`);return}a.gold&&this.inventoryManager.addGold(-a.gold),a.itemId&&a.itemQty&&this.inventoryManager.removeItem(a.itemId,a.itemQty),this.shortcutManager.unlock(e)}}placeCampfire(){const e=this.playerController.getPosition();for(const s of this.campfires)if(x.Math.Distance.Between(e.x,e.y,s.x,s.y)<100){this.showNotification("Too close to an existing campfire.");return}const t=this.add.image(e.x,e.y-8,"placeholder").setTint(16746496).setScale(.5).setDepth(200),i=this.add.text(e.x,e.y-24,"Campfire",{fontFamily:"monospace",fontSize:"8px",color:"#ff8800",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(201).setVisible(!1);this.campfires.push({x:e.x,y:e.y,marker:t,label:i,kindleLevel:0}),this.showNotification("Campfire placed. Press E near it to rest."),this.audioManager.playSFX(q.ITEM_PICKUP)}restAtCampfire(e){const t=this.playerController.getEid();this.lastCampfirePos={x:e.x,y:e.y},S.current[t]=S.max[t],W.current[t]=W.max[t],this.corruptionExposure=Math.max(0,this.corruptionExposure-30),this.deathDefianceCharges=this.maxDeathDefianceCharges,Ls(),e.kindleLevel>=1&&(this.activeBuffs.push({type:"regen",magnitude:3,remaining:300*e.kindleLevel}),this.showNotification(`Kindle ${e.kindleLevel}: Regeneration buff active.`)),e.kindleLevel>=2&&(this.activeBuffs.push({type:"strength",magnitude:8,remaining:300}),this.showNotification("Kindle 2: Strength buff active.")),e.kindleLevel>=3&&(this.activeBuffs.push({type:"defense",magnitude:5,remaining:300}),this.showNotification("Kindle 3: Defense buff active. Fast travel unlocked.")),this.cameras.main.fadeOut(400,0,0,0),this.inputBlocked=!0,this.time.delayedCall(600,()=>{this.cameras.main.fadeIn(400,0,0,0),this.inputBlocked=!1}),this.showNotification("Rested at campfire. HP & Stamina restored. Enemies respawned."),this.audioManager.playSFX(q.LEVEL_UP)}kindleCampfire(e){if(e.kindleLevel>=3){this.showNotification("This campfire is fully kindled.");return}if(this.inventoryManager.removeItem("spirit_ember",1)<1){this.showNotification("Need a Spirit Ember to kindle this campfire.");return}e.kindleLevel++;const i=[16746496,16755251,16764006,16772761];e.marker.setTint(i[e.kindleLevel]??16772761),e.label.setText(`Campfire +${e.kindleLevel}`),this.triggerScreenFlash(16746496,.2),this.audioManager.playSFX(q.LEVEL_UP),this.particleManager.emit("sparks",e.x,e.y),this.showNotification(`Campfire kindled to level ${e.kindleLevel}!`),e.kindleLevel===3&&this.showNotification("Max kindle! This campfire is now a fast travel point.")}openStorageChest(e,t){const i=`chest_${e}_${t}`;let a=this.storageManager.getAllStorages("overworld").find(l=>l.label===i);if(!a){const l=this.storageManager.createStorage(e,t,"overworld",i);a=this.storageManager.getStorage(l)}const o=this.scene.get("UIScene");if(!o||!a)return;o.getStorageUI().openWithStorage(a.id,a.slots,(l,c)=>{this.storageManager.updateSlots(l,c)}),this.audioManager.playSFX(q.DOOR_OPEN),this.showNotification("Chest opened")}openNPCDialogue(e){const t=this.scene.get("DialogueScene");t&&(this.scene.pause(),t.openDialogue(e))}enterDungeon(e){this.showNotification("Entering dungeon..."),this.audioManager.playSFX(q.DOOR_OPEN);const t=this.playerController.getPosition();this.cameras.main.fadeOut(400,0,0,0),this.time.delayedCall(500,()=>{this.cleanUp(),this.scene.start("DungeonScene",{dungeonId:e,floorLevel:1,returnX:t.x,returnY:t.y})})}enterSettlement(e){this.showNotification("Entering settlement..."),this.cameras.main.fadeOut(400,0,0,0),this.time.delayedCall(500,()=>{this.cleanUp(),this.scene.start("SettlementScene",{settlementId:e})})}createEnemyAnimations(){if(this.enemyAnimsCreated)return;this.enemyAnimsCreated=!0;const e=["enemy_mushroom","enemy_goblin","enemy_skeleton","enemy_flyingeye"],t=[{suffix:"idle",repeat:-1},{suffix:"run",repeat:-1},{suffix:"attack",repeat:0},{suffix:"hit",repeat:0},{suffix:"death",repeat:0}];for(const i of e)for(const s of t){let a;i==="enemy_flyingeye"?s.suffix==="idle"||s.suffix==="run"?a="enemy_flyingeye_flight":a=`${i}_${s.suffix}`:i==="enemy_skeleton"&&s.suffix==="run"?a="enemy_skeleton_walk":a=`${i}_${s.suffix}`;const o=`${i}_${s.suffix}`;if(this.anims.exists(o)||!this.textures.exists(a))continue;const n=this.anims.generateFrameNumbers(a,{});n.length!==0&&this.anims.create({key:o,frames:n,frameRate:8,repeat:s.repeat})}}syncEnemySprites(){const e=Yc(E),t=new Set;for(const i of e){if(t.add(i),S.current[i]<=0){const c=this.enemySprites.get(i);c&&(c.destroy(),this.enemySprites.delete(i));const d=this.enemyHPBars.get(i);d&&(d.destroy(),this.enemyHPBars.delete(i));continue}let s=this.enemySprites.get(i);if(!s){const c=jt(V.textureId[i]),d=this.textures.exists(c)?c:"enemy";s=this.add.sprite(f.x[i],f.y[i],d).setDepth(4e3).setScale(.4),this.enemySprites.set(i,s);const h=K.affix1[i],u=K.affix2[i];if(h!==0){const m=ai[h];m&&s.setTint(m.tint),s.setScale(u!==0?.55:.48)}if(this.enemyAnimsCreated){const g=`${c.replace(/_idle$|_flight$/,"")}_idle`;this.anims.exists(g)&&s.play(g)}}if(s.setPosition(f.x[i],f.y[i]),this.enemyAnimsCreated){const d=jt(V.textureId[i]).replace(/_idle$|_flight$/,""),h=v.state[i];let u;switch(h){case M.Chase:u=`${d}_run`;break;case M.Attack:u=`${d}_attack`;break;default:u=`${d}_idle`}this.anims.exists(u)&&s.anims.currentAnim?.key!==u&&s.play(u,!0)}const a=v.telegraphTimer[i];if(a>0){const c=a/(v.telegraphDuration[i]||1),d=Math.sin(Date.now()*(.01+(1-c)*.03))>0;s.setTint(d?16724787:16746632)}else if(s.getData("wasTelegraphing")){const c=K.affix1[i];if(c!==0){const d=ai[c];d?s.setTint(d.tint):s.clearTint()}else s.clearTint()}s.setData("wasTelegraphing",a>0);const o=f.x[i]-(s.getData("lastX")??f.x[i]);s.setData("lastX",f.x[i]),o<-.1?s.setFlipX(!0):o>.1&&s.setFlipX(!1);const n=S.current[i],l=S.max[i];if(n<l&&l>0){let c=this.enemyHPBars.get(i);c||(c=this.add.graphics().setDepth(4100),this.enemyHPBars.set(i,c)),c.clear();const d=24,h=3,u=f.x[i]-d/2,m=f.y[i]-14,g=Math.max(0,n/l);c.fillStyle(3355443,.8),c.fillRect(u,m,d,h),c.fillStyle(g>.3?13382451:16711680,.9),c.fillRect(u,m,d*g,h)}else{const c=this.enemyHPBars.get(i);c&&c.clear()}}for(const[i,s]of this.enemySprites)t.has(i)||(s.destroy(),this.enemySprites.delete(i));for(const[i,s]of this.enemyHPBars)t.has(i)||(s.destroy(),this.enemyHPBars.delete(i))}processLootEvents(){const e=Ga(),t=this.playerController.getEid();for(const i of e){if(this.createLootDrop(i),i.enemyType&&this.imprintManager.unlockFromBoss(i.enemyType),i.xpReward>0){const s=this.imprintManager.getCombinedEffects(),a=this.quirkManager.getCombinedEffects(),o=this.festivalXpMult*(s.xpMult??1)*(a.xpMult??1),n=Math.round(i.xpReward*o);this.skillManager.addXP("combat",n),T.xp[t]+=n;const l=T.level[t],c=this.xpForLevel(l);T.xp[t]>=c&&(T.level[t]++,T.xp[t]-=c,this.particleManager.emit("levelUp",f.x[t],f.y[t]),this.audioManager.playSFX(q.LEVEL_UP),this.showNotification(`Level Up!  ${T.level[t]}`))}if(i.goldReward>0){const s=this.imprintManager.getCombinedEffects(),a=this.quirkManager.getCombinedEffects(),o=this.careerManager.getEffectiveIncomeMultiplier()*this.festivalGoldMult*(s.goldMult??1)*(a.goldMult??1),n=Math.round(i.goldReward*o);this.inventoryManager.addGold(n),this.particleManager.emit("goldPickup",i.x,i.y),this.showNotification(`+${n} gold`)}if(i.xpReward>0){const s=T.weaponType[t];this.weaponMasteryManager.addXP(s,Math.round(i.xpReward*.5))}if(i.xpReward>0&&i.enemyType){const s=this.registry.get("bestiaryUI");s&&s.recordKill(i.enemyType)}if(i.xpReward>0&&this.achievementManager.trackProgress("enemies_defeated",1),i.xpReward>0){const s=this.codexManager.rollFragmentDrop(this.lastBiomeId,"enemy_drop");s&&this.codexManager.discover(s)}if(i.xpReward>0&&this.resolveManager.onEnemyKill(),i.xpReward>0){const s=S.current[t]/S.max[t];this.bountyContractManager.onEnemyKill(s)}i.enemyType&&this.enemyWeaknessManager.recordKill(i.enemyType),i.enemyType&&this.recentDeadEnemies.push({x:i.x,y:i.y,enemyId:i.enemyType,timer:30})}}createLootDrop(e){const t=(Math.random()-.5)*20,i=(Math.random()-.5)*20,s=e.x+t,a=e.y+i,o=["#ffffff","#00ff00","#0088ff","#aa00ff","#ff8800","#ff0000"],n=["","","","Epic ","Legendary ","Mythic "],l=o[e.rarity]??"#ffffff",c=n[e.rarity]??"",d=e.rarity>=3,h=this.add.image(s,a,"item_drop").setDepth(3500);if(e.rarity>=1){const y=[16777215,8978312,8961023,13404415,16759620,16737894];h.setTint(y[e.rarity]??16777215)}const u=j.get(e.itemId)?.name??e.itemId,m=d?"9px":"8px",g=this.add.text(s,a-10,`${c}${u}`,{fontFamily:"monospace",fontSize:m,color:l,stroke:"#000000",strokeThickness:d?2:1,fontStyle:d?"bold":"normal"}).setOrigin(.5).setDepth(3501);h.setScale(0),this.tweens.add({targets:h,scaleX:d?1.2:1,scaleY:d?1.2:1,duration:d?300:200,ease:"Back.easeOut"}),e.rarity>=2&&this.particleManager.emit("sparks",s,a),e.rarity>=4&&this.particleManager.emit("critFlash",s,a),this.lootDrops.push({sprite:h,label:g,itemId:e.itemId,quantity:e.quantity,x:s,y:a,despawnTimer:60})}checkLootPickup(){const e=this.playerController.getPosition(),t=24;for(let i=this.lootDrops.length-1;i>=0;i--){const s=this.lootDrops[i];if(x.Math.Distance.Between(e.x,e.y,s.x,s.y)<=t){const o=this.inventoryManager.addItem(s.itemId,s.quantity),n=s.quantity-o;n>0&&(this.showNotification(`+${n} ${j.get(s.itemId)?.name??s.itemId}`),this.questManager.updateObjective("collect",s.itemId,n),this.particleManager.emit("goldPickup",s.x,s.y),this.audioManager.playSFX(s.itemId==="gold_coin"?q.GOLD_PICKUP:q.ITEM_PICKUP)),o>0?s.quantity=o:(s.sprite.destroy(),s.label.destroy(),this.lootDrops.splice(i,1))}}}updateLootDrops(e){for(let t=this.lootDrops.length-1;t>=0;t--){const i=this.lootDrops[t];i.despawnTimer-=e,i.despawnTimer<5&&(i.sprite.setAlpha(Math.sin(i.despawnTimer*8)*.5+.5),i.label.setAlpha(i.sprite.alpha)),i.despawnTimer<=0&&(i.sprite.destroy(),i.label.destroy(),this.lootDrops.splice(t,1))}}processDamageEvents(){const e=gs(),t=this.playerController.getEid();let i=0;const s=this.registry.get("weatherEnemyDmgMult")??1;for(const a of e){a.targetEid===t&&s!==1&&(a.damage=Math.round(a.damage*s)),a.targetEid===t&&this.omenSlotManager.isOvercharged()&&(a.damage=Math.round(a.damage*2));const o=S.current[a.targetEid]<=0,n=a.targetEid===t,l=a.isCrit?16:11,c=Math.min(a.damage/15,2),d=Math.round(l+c*2),h=o?"#ff2222":a.isBackstab?"#ff88ff":a.isCrit?"#ffaa00":"#ff4444",u=o?" KILL":a.isBackstab?" BACKSTAB":a.isCrit?"!":"",m=a.comboCount>=3?` x${a.comboCount}`:"",g=this.add.text(a.x,a.y-12,`${Math.round(a.damage)}${u}${m}`,{fontFamily:"monospace",fontSize:`${d}px`,color:h,fontStyle:a.isCrit||o?"bold":"normal",stroke:"#000000",strokeThickness:a.isCrit?3:1}).setOrigin(.5).setDepth(9500);if(g.setScale(a.isCrit?1.6:1.2),this.tweens.add({targets:g,scale:1,duration:a.isCrit?150:100,ease:"Back.easeOut"}),this.damageTexts.push({text:g,life:0}),o?i=Math.max(i,Tr):a.isCrit?i=Math.max(i,Mr):n||(i=Math.max(i,Sr)),n?(this.audioManager.playSFX(q.PLAYER_HIT),this.cameras.main.shake(150,.012),this.resolveManager.onPlayerHit(),this.bountyContractManager.onPlayerHit()):o?(this.audioManager.playSFX(a.isCrit?q.CRIT_HIT:q.ENEMY_HIT),this.cameras.main.shake(180,.01)):a.isCrit?(this.audioManager.playSFX(q.CRIT_HIT),this.cameras.main.shake(140,.008)):(this.audioManager.playSFX(q.ENEMY_HIT),this.cameras.main.shake(60,.003)),(a.isCrit||o)&&this.triggerScreenFlash(o?16720418:16777215,o?.25:.15),this.particleManager.emit("blood",a.x,a.y),o?(this.particleManager.emit("blood",a.x,a.y),this.particleManager.emit("critFlash",a.x,a.y),this.particleManager.emit("sparks",a.x,a.y)):a.isCrit?(this.particleManager.emit("critFlash",a.x,a.y),this.particleManager.emit("sparks",a.x,a.y)):this.particleManager.emit("sparks",a.x,a.y),n||(this.achievementManager.trackProgress("damage_dealt_total",Math.round(a.damage)),a.isCrit&&this.achievementManager.trackProgress("critical_hits",1)),o&&!n){const y=a.isBackstab?"backstab":a.isCrit?"crit":"normal";this.weaponEchoManager.recordKill(y,Math.round(a.damage))}if(!n&&(a.isBackstab&&o&&this.quirkManager.recordBehavior("backstab_often"),o)){const y=this.timeManager.getDate().hour;(y>=20||y<6)&&this.quirkManager.recordBehavior("fight_in_dark")}n&&this.quirkManager.recordBehavior("take_many_hits")}i>0&&this.hitstopTimer<=0&&(this.hitstopTimer=i,this.time.timeScale=.05,this.time.delayedCall(i,()=>{this.time.timeScale=1,this.hitstopTimer=0}))}processParryEvents(){const e=un();for(const t of e){const i=t.isRiposte?"RIPOSTE!":"PARRY!",s=t.isRiposte?"#ffdd00":"#44ccff",a=t.isRiposte?18:14,o=this.add.text(t.x,t.y-20,i,{fontFamily:"monospace",fontSize:`${a}px`,color:s,fontStyle:"bold",stroke:"#000000",strokeThickness:3}).setOrigin(.5).setDepth(9500);o.setScale(1.8),this.tweens.add({targets:o,scale:1,y:t.y-40,alpha:0,duration:800,ease:"Back.easeOut",onComplete:()=>o.destroy()}),this.cameras.main.shake(t.isRiposte?200:120,t.isRiposte?.012:.006),this.triggerScreenFlash(t.isRiposte?16768256:4508927,t.isRiposte?.2:.12),this.particleManager.emit("sparks",t.x,t.y),t.isRiposte&&this.particleManager.emit("critFlash",t.x,t.y),this.audioManager.playSFX(t.isRiposte?q.CRIT_HIT:q.SWORD_SWING),this.bountyContractManager.onParry(),this.quirkManager.recordBehavior("parry_often")}}showScarReadingOverlay(e){this.scarReadingOverlay&&(this.scarReadingOverlay.destroy(),this.scarReadingOverlay=null);const t=this.cameras.main,i=this.add.container(t.centerX,t.height-80).setScrollFactor(0).setDepth(9800),s=this.add.rectangle(0,0,Math.min(t.width-60,500),60,0,.7).setOrigin(.5);s.setStrokeStyle(1,14527044,.6);const a=this.add.rectangle(0,0,Math.min(t.width-56,504),64,14527044,.15).setOrigin(.5),o=this.add.text(0,0,`"${e}"`,{fontFamily:"serif",fontSize:"13px",color:"#eedd88",fontStyle:"italic",wordWrap:{width:Math.min(t.width-100,460)},align:"center"}).setOrigin(.5);i.add([a,s,o]),i.setAlpha(0),this.tweens.add({targets:i,alpha:1,duration:400,ease:"Power2"}),this.scarReadingOverlay=i,this.scarReadingTimer=4,this.triggerScreenFlash(14527044,.12),this.audioManager.playSFX(q.ITEM_PICKUP);const n=this.scarReadingManager.getProgress();this.showNotification(`Memory read (${n.read}/${n.total})`)}updateScarReading(e){for(let t=this.recentDeadEnemies.length-1;t>=0;t--)this.recentDeadEnemies[t].timer-=e,this.recentDeadEnemies[t].timer<=0&&this.recentDeadEnemies.splice(t,1);this.scarReadingTimer>0&&this.scarReadingOverlay&&(this.scarReadingTimer-=e,this.scarReadingTimer<=0&&this.tweens.add({targets:this.scarReadingOverlay,alpha:0,duration:600,ease:"Power2",onComplete:()=>{this.scarReadingOverlay&&(this.scarReadingOverlay.destroy(),this.scarReadingOverlay=null)}}))}triggerScreenFlash(e,t){this.screenFlash||(this.screenFlash=this.add.rectangle(this.cameras.main.centerX,this.cameras.main.centerY,this.cameras.main.width,this.cameras.main.height,e,0).setScrollFactor(0).setDepth(9900)),this.screenFlash.setFillStyle(e,t),this.tweens.add({targets:this.screenFlash,alpha:0,duration:120,ease:"Power2",onComplete:()=>{this.screenFlash&&this.screenFlash.setAlpha(0)}})}updateComboDisplay(){const e=this.playerController.getEid(),t=It.get(e);if(t&&t.count>=2){const i=this.playerController.getPosition();this.comboText||(this.comboText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"14px",color:"#ffaa00",fontStyle:"bold",stroke:"#000000",strokeThickness:3}).setOrigin(.5).setDepth(9600)),this.comboText.setText(`${t.count}x COMBO!`),this.comboText.setPosition(i.x,i.y-32),this.comboText.setAlpha(1),this.comboText.setVisible(!0);const s=1+Math.min(t.count*.05,.5);this.comboText.setScale(s)}else this.comboText&&this.comboText.setVisible(!1)}updateDamageTexts(e){for(let t=this.damageTexts.length-1;t>=0;t--){const i=this.damageTexts[t];i.life+=e,i.text.y-=30*e,i.text.setAlpha(Math.max(0,1-i.life/.8)),i.life>=.8&&(i.text.destroy(),this.damageTexts.splice(t,1))}}createDungeonEntrances(){for(const e of Pt){if(e.hasDungeon&&e.dungeonId){const t=e.x*32+80,i=e.y*32+80,s=this.add.image(t,i,"item_drop").setTint(16729156).setScale(1.5).setDepth(4500),a=this.add.text(t,i-16,`[E] ${e.name} Dungeon`,{fontFamily:"monospace",fontSize:"9px",color:"#ff8888",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(4501).setVisible(!1);this.dungeonEntrances.push({x:t,y:i,dungeonId:e.dungeonId,marker:s,label:a})}if(e.hasRiftPortal){const t=e.x*32-80,i=e.y*32+80,s=this.add.image(t,i,"item_drop").setTint(10027263).setScale(2).setDepth(4500),a=this.add.text(t,i-16,"[E] Rift Portal",{fontFamily:"monospace",fontSize:"9px",color:"#cc88ff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(4501).setVisible(!1);this.riftEntrances.push({x:t,y:i,marker:s,label:a})}}}createSettlementEntrances(){const e=[{x:150,y:150,id:"haven_settlement"},{x:11200,y:0,id:"rotwood_settlement"},{x:20800,y:0,id:"ashlands_settlement"}];for(const t of e){const i=this.add.image(t.x,t.y,"item_drop").setTint(4521796).setScale(1.5).setDepth(4500),s=this.add.text(t.x,t.y-16,"[E] Settlement",{fontFamily:"monospace",fontSize:"9px",color:"#88ff88",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(4501).setVisible(!1);this.settlementEntrances.push({x:t.x,y:t.y,settlementId:t.id,marker:i,label:s})}}createBuildingEntrances(){let e=0;for(const t of Pt)for(const i of t.buildings){const s=Kc[i.type];if(!s)continue;const a=e*1.2%(Math.PI*2),o=60+e%3*40,n=t.x*32+Math.cos(a)*o,l=t.y*32+Math.sin(a)*o,c=this.add.image(n,l,"item_drop").setTint(4500223).setScale(1.2).setDepth(4500),d=this.add.text(n,l-16,`[E] ${i.name}`,{fontFamily:"monospace",fontSize:"9px",color:"#88ccff",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(4501).setVisible(!1);this.buildingEntrances.push({x:n,y:l,interiorId:s,name:i.name,marker:c,label:d}),e++}}createShortcutEntrances(){const e=this.shortcutManager.getAllShortcuts();for(const{def:t,unlocked:i}of e){const s=i?4521898:8939076,a=i?"[OPEN]":"[LOCKED]",o=i?"#44ffaa":"#886644",n=this.add.image(t.fromX,t.fromY-8,"placeholder").setTint(s).setScale(.4).setDepth(200),l=this.add.text(t.fromX,t.fromY-24,`${t.name} ${a}`,{fontFamily:"monospace",fontSize:"8px",color:o,stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(4501).setVisible(!1);this.shortcutEntrances.push({x:t.fromX,y:t.fromY,shortcutId:t.id,marker:n,label:l});const c=this.add.image(t.toX,t.toY-8,"placeholder").setTint(s).setScale(.4).setDepth(200),d=this.add.text(t.toX,t.toY-24,`${t.name} ${a}`,{fontFamily:"monospace",fontSize:"8px",color:o,stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(4501).setVisible(!1);this.shortcutEntrances.push({x:t.toX,y:t.toY,shortcutId:t.id,marker:c,label:d})}}updateEntranceLabels(e,t){const i=ge*2;for(const s of this.dungeonEntrances){const a=x.Math.Distance.Between(e,t,s.x,s.y);s.label.setVisible(a<=i)}for(const s of this.settlementEntrances){const a=x.Math.Distance.Between(e,t,s.x,s.y);s.label.setVisible(a<=i)}for(const s of this.riftEntrances){const a=x.Math.Distance.Between(e,t,s.x,s.y);s.label.setVisible(a<=i)}for(const s of this.buildingEntrances){const a=x.Math.Distance.Between(e,t,s.x,s.y);s.label.setVisible(a<=i)}for(const s of this.campfires){const a=x.Math.Distance.Between(e,t,s.x,s.y);s.label.setVisible(a<=i)}for(const s of this.shortcutEntrances){const a=x.Math.Distance.Between(e,t,s.x,s.y);s.label.setVisible(a<=i);const o=this.shortcutManager.isUnlocked(s.shortcutId);s.marker.setTint(o?4521898:8939076)}}handleToolUse(){const e=this.inventoryManager.getSlot(this.hotbarSlot);if(!e||!e.itemId)return;const t=j.get(e.itemId);if(!t)return;const{tileX:i,tileY:s}=this.playerController.useTool();if(t.category==="seed"){this.handleSeedPlant(e.itemId,t,i,s);return}if(t.category!=="tool")return;const a=t;switch(a.toolType){case"axe":{if(!this.resourceCycleManager.canHarvest(i,s)){this.showNotification("This area is depleted. Come back in a few days.");break}const o=this.chunkManager.getObjectAt(i,s);$t[o].destructible&&(o===z.Tree||o===z.DeadTree||o===z.Bush)&&(this.hitObject(i,s,o,a.efficiency*5),this.audioManager.playSFX(q.AXE_SWING),this.skillManager.addXP("foraging",3));break}case"pickaxe":{if(!this.resourceCycleManager.canHarvest(i,s)){this.showNotification("This area is depleted. Come back in a few days.");break}const o=this.chunkManager.getObjectAt(i,s);$t[o].destructible&&(o===z.Rock||o===z.CopperNode||o===z.IronNode||o===z.GoldNode||o===z.Crystal||o===z.VoidCrystal)&&(this.hitObject(i,s,o,a.efficiency*5),this.audioManager.playSFX(q.HAMMER_SMASH),this.skillManager.addXP("mining",5));break}case"hoe":{if(this.farmingManager.harvest(i,s))break;this.chunkManager.getObjectAt(i,s)===z.None&&this.farmingManager.tillSoil(i,s)&&(this.chunkManager.setTileAt(i,s,L.Tilled),this.chunkManager.rerenderChunkAt(i,s),this.audioManager.playSFX(q.HAMMER_SMASH),this.skillManager.addXP("farming",3));break}case"watering_can":{this.farmingManager.waterPlot(i,s)&&(this.chunkManager.setTileAt(i,s,L.Watered),this.chunkManager.rerenderChunkAt(i,s),this.skillManager.addXP("farming",2));break}case"fishing_rod":{this.startFishing();break}}}handleSeedPlant(e,t,i,s){const a=this.timeManager.getDate().season.toLowerCase();if(!this.farmingManager.plantSeed(i,s,e,a)){this.showNotification("Cannot plant here");return}this.inventoryManager.removeItem(e,1),this.chunkManager.setObjectAt(i,s,z.Flower),this.chunkManager.rerenderChunkAt(i,s),this.skillManager.addXP("farming",5),this.showNotification(`Planted ${t.name}`)}hitObject(e,t,i,s){const a=`${e},${t}`;let o=this.objectHP.get(a);o===void 0&&(o=$t[i].hp),o-=s,this.objectHP.set(a,o);const n=se.worldToScreen(e,t);if(this.particleManager.emit("sparks",n.x,n.y),o<=0){this.chunkManager.setObjectAt(e,t,z.None),this.chunkManager.rerenderChunkAt(e,t),this.objectHP.delete(a),this.resourceCycleManager.recordHarvest(e,t);const l=Eo[i];if(l)for(const c of l){const d=c.qty[0]+Math.floor(Math.random()*(c.qty[1]-c.qty[0]+1));this.inventoryManager.addItem(c.itemId,d),this.showNotification(`+${d} ${c.itemId}`)}this.particleManager.emit("harvest",n.x,n.y),i===z.Tree||i===z.DeadTree||i===z.Bush?this.questManager.updateObjective("collect","wood",1):(i===z.Rock||i===z.CopperNode||i===z.IronNode||i===z.GoldNode)&&this.questManager.updateObjective("mine","ore",1)}}consumeItem(e){if(this.resolveManager.getTrauma()?.disableConsumables){this.showNotification("Your shattered mind refuses to use items.");return}const t=this.inventoryManager.useItem(e);if(!t)return;const i=this.playerController.getEid();if(t.category==="food"){const s=t;if(S.current[i]=Math.min(S.max[i],S.current[i]+s.healAmount),W.current[i]=Math.min(W.max[i],W.current[i]+s.staminaRestore),this.showNotification(`Ate ${s.name} (+${s.healAmount} HP)`),s.healAmount>=10&&this.resolveManager.onGoodFood(),this.companionManager.onPlayerFood(),s.buffType&&s.buffDuration&&s.buffMagnitude&&(this.activeBuffs.push({type:s.buffType,magnitude:s.buffMagnitude,remaining:s.buffDuration}),this.showNotification(`Buff: ${s.buffType} +${s.buffMagnitude} (${s.buffDuration}s)`)),s.foodCategory&&s.dietDuration){const a=s.foodCategory;let o=this.activeDietSlots.findIndex(n=>n?.category===a);o===-1&&(o=this.activeDietSlots.findIndex(n=>n===null)),o!==-1?(this.activeDietSlots[o]={itemId:s.id,category:a,name:s.name,hpBonus:s.dietHpBonus??0,staminaBonus:s.dietStaminaBonus??0,remaining:s.dietDuration,duration:s.dietDuration},this.showNotification(`Diet [${a}]: +${s.dietHpBonus??0} HP, +${s.dietStaminaBonus??0} Stamina (${Math.floor(s.dietDuration/60)}min)`),this.registry.set("dietSlots",this.activeDietSlots)):this.showNotification("All 3 diet slots full! Wait for one to expire.")}}else if(t.category==="potion"){const s=t;this.activeBuffs.push({type:s.effectType,magnitude:s.effectMagnitude,remaining:s.effectDuration}),this.showNotification(`Used ${s.name} (${s.effectType} +${s.effectMagnitude} for ${s.effectDuration}s)`)}else if(t.id==="campfire"){this.placeCampfire();return}this.bountyContractManager.onItemUsed(),this.audioManager.playSFX(q.ITEM_PICKUP)}applyBuffTick(e,t){const i=this.playerController.getEid();switch(e.type){case"regen":S.current[i]=Math.min(S.max[i],S.current[i]+e.magnitude*t);break}}recalcOmenStats(){const e=this.omenSlotManager.getCombinedEffects(),t=this.playerController.getEid(),i=e.maxHpAdd??0,s=e.maxStaminaAdd??0;this.registry.set("omenHpBonus",i),this.registry.set("omenStaminaBonus",s),this.registry.set("omenEffects",e),e.critChanceAdd&&(T.critChance[t]+=e.critChanceAdd),e.critMultAdd&&(T.critMult[t]+=e.critMultAdd)}getBuffMagnitude(e){let t=0;for(const i of this.activeBuffs)i.type===e&&(t+=i.magnitude);return t}handlePlayerDeath(){this.playerDead=!0,this.deathTimer=3;const e=Math.floor(this.inventoryManager.getGold()*.2);if(e>0){this.inventoryManager.removeGold(e);const i=this.playerController.getPosition();this.createLootDrop({x:i.x,y:i.y,itemId:"gold_coin",quantity:e,rarity:0,xpReward:0,goldReward:0,enemyType:""})}this.cameras.main.fadeOut(800,0,0,0);const t=this.add.text(this.cameras.main.width/2,this.cameras.main.height/2,"You Died",{fontFamily:"monospace",fontSize:"32px",color:"#ff4444",fontStyle:"bold",backgroundColor:"#000000dd",padding:{x:20,y:12}}).setOrigin(.5).setScrollFactor(0).setDepth(1e4);this.time.delayedCall(2800,()=>{t.destroy()})}respawnPlayer(){this.playerDead=!1;const e=this.playerController.getEid();f.x[e]=this.lastCampfirePos.x,f.y[e]=this.lastCampfirePos.y,b.vx[e]=0,b.vy[e]=0,S.current[e]=S.max[e]*.5,W.current[e]=W.max[e],this.playerController.setInvincible(2),this.deathDefianceCharges=this.maxDeathDefianceCharges,this.cameras.main.fadeIn(600,0,0,0),this.audioManager.playSFX(q.DOOR_OPEN),this.showNotification("Respawned at Haven")}startFishing(){const e=this.timeManager.getDate(),t=e.hour<6?"night":e.hour<12?"morning":e.hour<18?"afternoon":"evening",i=se.pixelToTile(this.playerController.getPosition().x,this.playerController.getPosition().y),s=ba[this.chunkManager.getBiomeAt(i.tileX,i.tileY)]??"haven";if(!this.fishingManager.startFishing(e.season.toLowerCase(),t,s))return;this.fishingActive=!0,this.inputBlocked=!0;const a=this.cameras.main,o=a.width/2,n=a.height/2;this.fishingUI=this.add.container(0,0).setScrollFactor(0).setDepth(9950);const l=this.add.rectangle(o,n,300,200,0,.7);this.fishingUI.add(l);const c=this.add.rectangle(o,n,30,160,13158);this.fishingUI.add(c);const d=this.add.rectangle(o,n-20,26,40,43520,.6);d.setData("name","catchZone"),this.fishingUI.add(d);const h=this.add.rectangle(o,n,22,8,16776960);h.setData("name","fish"),this.fishingUI.add(h);const u=this.add.rectangle(o,n+100,200,12,3355443);this.fishingUI.add(u);const m=this.add.rectangle(o-100,n+100,0,10,65280).setOrigin(0,.5);m.setData("name","progressFill"),this.fishingUI.add(m);const g=this.add.text(o,n-110,"W/S to move bar | Overlap fish to fill",{fontFamily:"monospace",fontSize:"10px",color:"#aaaaaa"}).setOrigin(.5);this.fishingUI.add(g);const y=this.add.text(o,n+115,"ESC to cancel",{fontFamily:"monospace",fontSize:"9px",color:"#666666"}).setOrigin(.5);this.fishingUI.add(y)}updateFishingUI(e){if(!this.fishingUI)return;const t=this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.W),i=this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.S);t.isDown&&this.fishingManager.moveBar(-2),i.isDown&&this.fishingManager.moveBar(2),this.fishingManager.update(e);const s=this.fishingManager.getSession();if(!s||!s.active){this.endFishing(!1);return}const a=this.cameras.main,o=a.width/2,n=a.height/2;for(const l of this.fishingUI.list){const c=l;c.getData?.("name")==="fish"&&c.setPosition(o,n-80+s.fishPosition/100*160),c.getData?.("name")==="catchZone"&&c.setPosition(o,n-80+s.barPosition/100*160),c.getData?.("name")==="progressFill"&&(c.width=s.progress/100*200)}s.progress>=100&&this.endFishing(!0),this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.ESC).isDown&&this.endFishing(!1)}endFishing(e){const i=this.fishingManager.getSession()?.fishId;if(this.fishingActive=!1,this.inputBlocked=!1,this.fishingUI&&(this.fishingUI.destroy(!0),this.fishingUI=null),e&&i){this.audioManager.playSFX(q.ITEM_PICKUP);const s=j.get(i)?.name??i;this.showNotification(`Caught: ${s}!`)}else e||this.showNotification("The fish got away...")}showNotification(e){const{width:t}=this.cameras.main,i=100+this.notifications.length*24,s=this.add.text(t/2,i,e,{fontFamily:"monospace",fontSize:"12px",color:"#ffcc00",backgroundColor:"#000000aa",padding:{x:8,y:4}}).setOrigin(.5).setScrollFactor(0).setDepth(9900);this.notifications.push({text:s,life:0})}updateNotifications(e){for(let t=this.notifications.length-1;t>=0;t--){const i=this.notifications[t];i.life+=e,i.text.y-=10*e,i.text.setAlpha(Math.max(0,1-i.life/2)),i.life>=2&&(i.text.destroy(),this.notifications.splice(t,1))}}openPauseMenu(){this.paused=!0,this.inputBlocked=!0;const e=this.cameras.main,t=e.width/2,i=e.height/2;this.pauseOverlay=this.add.container(0,0).setScrollFactor(0).setDepth(9990);const s=this.add.rectangle(t,i,e.width,e.height,0,.6);this.pauseOverlay.add(s);const a=this.add.text(t,i-80,"PAUSED",{fontFamily:"monospace",fontSize:"24px",color:"#ffffff"}).setOrigin(.5);this.pauseOverlay.add(a);const o={fontFamily:"monospace",fontSize:"14px",color:"#cccccc",backgroundColor:"#333333",padding:{x:20,y:8}},n=this.add.text(t,i-20,"Resume",o).setOrigin(.5).setInteractive({useHandCursor:!0});n.on("pointerover",()=>n.setColor("#ffffff")),n.on("pointerout",()=>n.setColor("#cccccc")),n.on("pointerdown",()=>this.closePauseMenu()),this.pauseOverlay.add(n);const l=this.add.text(t,i+20,"Save Game",o).setOrigin(.5).setInteractive({useHandCursor:!0});l.on("pointerover",()=>l.setColor("#ffffff")),l.on("pointerout",()=>l.setColor("#cccccc")),l.on("pointerdown",()=>{const d=this.playerController.getEid();this.saveManager.save(0,{x:f.x[d],y:f.y[d],hp:S.current[d],maxHp:S.max[d],stamina:W.current[d],maxStamina:W.max[d],level:T.level[d],xp:T.xp[d]}),l.setText("Saved!"),this.time.delayedCall(1e3,()=>{l.active&&l.setText("Save Game")})}),this.pauseOverlay.add(l);const c=this.add.text(t,i+60,"Main Menu",o).setOrigin(.5).setInteractive({useHandCursor:!0});c.on("pointerover",()=>c.setColor("#ff6666")),c.on("pointerout",()=>c.setColor("#cccccc")),c.on("pointerdown",()=>{this.closePauseMenu(),this.cleanUp(),this.scene.start("MainMenuScene")}),this.pauseOverlay.add(c)}closePauseMenu(){this.paused=!1,this.inputBlocked=!1,this.pauseOverlay&&(this.pauseOverlay.destroy(!0),this.pauseOverlay=null)}openNGPlusDialog(){this.paused=!0,this.inputBlocked=!0;const e=this.cameras.main,t=e.width/2,i=e.height/2,s=this.add.container(0,0).setScrollFactor(0).setDepth(9990);s.add(this.add.rectangle(t,i,e.width,e.height,0,.7)),s.add(this.add.text(t,i-100,"EDILAS PORTAL",{fontFamily:"monospace",fontSize:"20px",color:"#bb88ff"}).setOrigin(.5)),s.add(this.add.text(t,i-70,`Begin New Game Plus (Cycle ${this.newGamePlusManager.getCycle()+1})?`,{fontFamily:"monospace",fontSize:"12px",color:"#cccccc"}).setOrigin(.5));const a=this.newGamePlusManager.getValidCarryoverOptions(),o=new Set;a.forEach((h,u)=>{const m=i-30+u*22,g=this.add.text(t-80,m,`[ ] ${h}`,{fontFamily:"monospace",fontSize:"11px",color:"#aaaaaa"}).setInteractive({useHandCursor:!0});g.on("pointerdown",()=>{o.has(h)?(o.delete(h),g.setText(`[ ] ${h}`).setColor("#aaaaaa")):(o.add(h),g.setText(`[x] ${h}`).setColor("#88ff88"))}),s.add(g)});const n=i-30+a.length*22+20,l={fontFamily:"monospace",fontSize:"13px",color:"#ffffff",backgroundColor:"#442266",padding:{x:16,y:6}},c=this.add.text(t-60,n,"Start NG+",l).setOrigin(.5).setInteractive({useHandCursor:!0});c.on("pointerdown",()=>{this.newGamePlusManager.startNewGamePlus(o),s.destroy(!0),this.paused=!1,this.cleanUp(),this.scene.start("OverworldScene")}),s.add(c);const d=this.add.text(t+60,n,"Cancel",{fontFamily:"monospace",fontSize:"13px",color:"#cccccc",backgroundColor:"#333333",padding:{x:16,y:6}}).setOrigin(.5).setInteractive({useHandCursor:!0});d.on("pointerdown",()=>{s.destroy(!0),this.paused=!1,this.inputBlocked=!1}),s.add(d)}registerSaveHandlers(){const e=[["inventory",()=>this.inventoryManager.serialize(),t=>this.inventoryManager.deserialize(t)],["equipment",()=>this.equipmentManager.serialize(),t=>this.equipmentManager.deserialize(t)],["time",()=>this.timeManager.serialize(),t=>this.timeManager.deserialize(t)],["quests",()=>this.questManager.serialize(),t=>this.questManager.deserialize(t)],["skills",()=>this.skillManager.serialize(),t=>this.skillManager.deserialize(t)],["relationships",()=>this.relationshipManager.serialize(),t=>this.relationshipManager.deserialize(t)],["crafting",()=>this.craftingManager.serialize(),t=>this.craftingManager.deserialize(t)],["farming",()=>this.farmingManager.serialize(),t=>this.farmingManager.deserialize(t)],["fishing",()=>this.fishingManager.serialize(),t=>this.fishingManager.deserialize(t)],["cooking",()=>this.cookingManager.serialize(),t=>this.cookingManager.deserialize(t)],["weaponMastery",()=>this.weaponMasteryManager.serialize(),t=>this.weaponMasteryManager.deserialize(t)],["story",()=>this.storyManager.serialize(),t=>this.storyManager.deserialize(t)],["corruption",()=>this.corruptionManager.serialize(),t=>this.corruptionManager.deserialize(t)],["rift",()=>this.riftManager.serialize(),t=>this.riftManager.deserialize(t)],["settlements",()=>this.settlementManager.serialize(),t=>this.settlementManager.deserialize(t)],["factions",()=>this.factionManager.serialize(),t=>this.factionManager.deserialize(t)],["titans",()=>this.titanManager.serialize(),t=>this.titanManager.deserialize(t)],["weather",()=>this.weatherManager.serialize(),t=>this.weatherManager.deserialize(t)],["audio",()=>this.audioManager.serialize(),t=>this.audioManager.deserialize(t)],["festivals",()=>this.festivalManager.serialize(),t=>this.festivalManager.deserialize(t)],["romance",()=>this.romanceManager.serialize(),t=>this.romanceManager.deserialize(t)],["career",()=>this.careerManager.serialize(),t=>this.careerManager.deserialize(t)],["achievements",()=>this.achievementManager.serialize(),t=>this.achievementManager.deserialize(t)],["mail",()=>this.mailManager.serialize(),t=>this.mailManager.deserialize(t)],["storage",()=>this.storageManager.serialize(),t=>this.storageManager.deserialize(t)],["temperature",()=>this.temperatureManager.serialize(),t=>this.temperatureManager.deserialize(t)],["shadowWorld",()=>this.shadowWorldManager.serialize(),t=>this.shadowWorldManager.deserialize(t)],["cityLevels",()=>this.cityLevelManager.serialize(),t=>this.cityLevelManager.deserialize(t)],["newGamePlus",()=>this.newGamePlusManager.serialize(),t=>this.newGamePlusManager.deserialize(t)],["endgame",()=>this.endgameManager.serialize(),t=>this.endgameManager.deserialize(t)],["tutorial",()=>this.tutorialManager.serialize(),t=>this.tutorialManager.deserialize(t)],["interior",()=>this.interiorManager.serialize(),t=>this.interiorManager.deserialize(t)],["legendaryQuests",()=>this.legendaryQuestManager.serialize(),t=>this.legendaryQuestManager.deserialize(t)],["abilities",()=>this.abilityManager.serialize(),t=>this.abilityManager.deserialize(t)],["scarReading",()=>this.scarReadingManager.serialize(),t=>this.scarReadingManager.deserialize(t)],["pact",()=>this.pactManager.serialize(),t=>this.pactManager.deserialize(t)],["resolve",()=>this.resolveManager.serialize(),t=>this.resolveManager.deserialize(t)],["bountyContracts",()=>this.bountyContractManager.serialize(),t=>this.bountyContractManager.deserialize(t)],["enemyWeakness",()=>this.enemyWeaknessManager.serialize(),t=>this.enemyWeaknessManager.deserialize(t)],["omenSlots",()=>this.omenSlotManager.serialize(),t=>this.omenSlotManager.deserialize(t)],["companion",()=>this.companionManager.serialize(),t=>this.companionManager.deserialize(t)],["boons",()=>this.boonManager.serialize(),t=>this.boonManager.deserialize(t)],["resourceCycles",()=>this.resourceCycleManager.serialize(),t=>this.resourceCycleManager.deserialize(t)],["shortcuts",()=>this.shortcutManager.serialize(),t=>this.shortcutManager.deserialize(t)],["imprints",()=>this.imprintManager.serialize(),t=>this.imprintManager.deserialize(t)],["quirks",()=>this.quirkManager.serialize(),t=>this.quirkManager.deserialize(t)],["weaponEcho",()=>this.weaponEchoManager.serialize(),t=>this.weaponEchoManager.deserialize(t)]];for(const[t,i,s]of e)this.saveManager.register(t,i,s)}wireEvents(){this.timeManager.onDay(()=>{this.farmingManager.advanceDay(this.timeManager.getDate().season.toLowerCase()),this.relationshipManager.resetDailyGifts();for(const i of this.settlementManager.getAllSettlements()){this.settlementManager.advanceDay(i.id);const s=this.settlementManager.getProductionOutput(i.id);for(const a of s)this.inventoryManager.addItem(a.itemId,a.quantity)}this.titanManager.advanceDay(),this.resourceCycleManager.advanceDay(),this.quirkManager.advanceDay(),this.timeManager.getDate().day%7===0&&this.factionManager.advanceWeek()}),this.timeManager.onSeason(t=>{Ls();const i={Spring:"Spring arrives. Creatures stir from dormancy.",Summer:"Summer heat draws out more enemies. Stay alert.",Autumn:"Autumn winds blow. The world settles into balance.",Winter:"Winter descends. Fewer enemies, but those that remain are hardened."};this.showNotification(i[t]??`Season changed to ${t}`)}),this.farmingManager.onHarvest((t,i,s,a)=>{this.questManager.updateObjective("farm",t,1),this.skillManager.addXP("farming",15),this.chunkManager.setTileAt(s,a,L.Dirt),this.chunkManager.setObjectAt(s,a,z.None),this.chunkManager.rerenderChunkAt(s,a);const o=se.worldToScreen(s,a);this.particleManager.emit("harvest",o.x,o.y),this.inventoryManager.addItem(t,1),this.showNotification(`Harvested ${t}`);const n=this.codexManager.rollFragmentDrop(this.lastBiomeId,"farming");n&&this.codexManager.discover(n)}),this.fishingManager.onCatch(t=>{this.inventoryManager.addItem(t,1),this.questManager.updateObjective("fish",t,1),this.skillManager.addXP("fishing",20);const i=this.codexManager.rollFragmentDrop(this.lastBiomeId,"fishing");i&&this.codexManager.discover(i)}),this.craftingManager.onCraftComplete((t,i,s)=>{this.questManager.updateObjective("craft",t,1),this.skillManager.addXP("crafting",10)}),this.cookingManager.onCook(t=>{this.questManager.updateObjective("cook",t,1),this.skillManager.addXP("cooking",10)}),this.storyManager.onChapterComplete(t=>{this.questManager.updateObjective("reach",`chapter_${t}`,1)}),this.titanManager.onTitanDefeated((t,i)=>{this.storyManager.updateObjective("kill",t,1),this.questManager.updateObjective("kill",t,1)}),this.riftManager.onFloorComplete((t,i)=>{this.questManager.updateObjective("reach",`rift_floor_${t}`,1)}),this.weatherManager.onWeatherChange((t,i)=>{(i==="rain"||i==="storm")&&this.farmingManager.waterAllCrops(),this.particleManager.setWeatherParticles(i)}),this.timeManager.onDay(()=>{const t=this.timeManager.getDate(),i=this.festivalManager.checkFestival(t.season,t.day);i&&this.festivalManager.startFestival(i.id)});const e={egg_festival:{xp:1.25,luck:1.2,gold:1,stamina:0},flower_dance:{xp:1,luck:1,gold:1,stamina:2},luau:{xp:1,luck:1,gold:1.5,stamina:1},moonlight_jellies:{xp:1.5,luck:1.5,gold:1,stamina:0},harvest_fair:{xp:1,luck:1.3,gold:1.3,stamina:0},spirits_eve:{xp:1.5,luck:2,gold:1,stamina:0},ice_festival:{xp:1.3,luck:1,gold:1,stamina:3},feast_of_winter_star:{xp:1,luck:1,gold:2,stamina:1}};this.festivalManager.onFestivalStart(t=>{this.showNotification(`Festival: ${t.name} has begun!`),this.showNotification(t.description),this.audioManager.playSFX(q.LEVEL_UP);const i=e[t.id];i&&(this.festivalXpMult=i.xp,this.festivalLuckMult=i.luck,this.festivalGoldMult=i.gold,this.festivalStaminaRegen=i.stamina,i.xp>1&&this.showNotification(`+${Math.round((i.xp-1)*100)}% XP bonus active!`),i.luck>1&&this.showNotification(`+${Math.round((i.luck-1)*100)}% loot luck bonus!`),i.gold>1&&this.showNotification(`+${Math.round((i.gold-1)*100)}% gold bonus!`));const s=this.playerController.getEid();this.particleManager.emit("levelUp",f.x[s],f.y[s]),this.time.delayedCall(3e3,()=>{this.festivalManager.completeFestival(t.id)})}),this.festivalManager.onFestivalComplete((t,i)=>{this.showNotification(`${t.name} complete! Rewards received.`);for(const s of i)s.gold&&this.inventoryManager.addGold(s.gold),s.itemId&&this.inventoryManager.addItem(s.itemId,s.quantity??1);this.audioManager.playSFX(q.LEVEL_UP),this.festivalXpMult=1,this.festivalLuckMult=1,this.festivalGoldMult=1,this.festivalStaminaRegen=0}),this.achievementManager.onAchievementUnlock((t,i)=>{this.showNotification(`Achievement Unlocked: ${t} (${i})`);const s=this.playerController.getEid();this.particleManager.emit("levelUp",f.x[s],f.y[s]),this.audioManager.playSFX(q.LEVEL_UP),this.mailManager.addMail({senderId:"system",subject:`Achievement Unlocked: ${t} (${i})`,body:`Congratulations! You reached ${i} tier for ${t}.`,attachments:[],sentDay:this.timeManager.getDate().day})}),this.cityLevelManager.onCityLevelUp((t,i)=>{this.mailManager.addMail({senderId:"system",subject:`${t} reached level ${i}!`,body:`The city of ${t} has grown to level ${i}. New shops and services are now available.`,attachments:[],sentDay:this.timeManager.getDate().day})}),this.careerManager.onLevelUp(t=>{this.achievementManager.trackProgress("helpful_hand",1),t>=10&&this.achievementManager.trackProgress("master_artisan",1)}),this.endgameManager.onPortalUnlock(()=>{this.mailManager.addMail({senderId:"system",subject:"The EDILAS Portal Has Opened!",body:"All requirements met. The path to EDILAS awaits in Haven center.",attachments:[],sentDay:this.timeManager.getDate().day})}),this.legendaryQuestManager.onQuestComplete(t=>{this.achievementManager.trackProgress("secret_keeper",1),this.mailManager.addMail({senderId:"system",subject:`Legendary Quest Complete: ${t}`,body:"You have achieved the impossible. Your legend grows.",attachments:[],sentDay:this.timeManager.getDate().day})}),this.farmingManager.onHarvest(()=>{this.tutorialManager.showTip("first_crop")}),this.fishingManager.onCatch(()=>{this.tutorialManager.showTip("first_fishing")}),this.craftingManager.onCraftComplete(()=>{this.tutorialManager.showTip("first_crafting")}),this.tutorialManager.onTipShow(t=>{this.showNotification(`Tip: ${t.title}`),this.showNotification(t.body)}),this.skillManager.onLevelUp((t,i)=>{const s=this.playerController.getEid();switch(this.showNotification(`${t} skill reached level ${i}!`),this.particleManager.emit("levelUp",f.x[s],f.y[s]),t){case"combat":T.damage[s]+=1,this.cachedDamage+=1;break;case"mining":case"foraging":T.defense[s]+=.5,this.cachedDefense+=.5;break}}),this.fishingManager.onCatch(t=>{this.legendaryQuestManager.advanceStage("king_of_the_sea",`catch_${t}`,1)}),this.craftingManager.onCraftComplete((t,i)=>{i==="dragonbane"&&this.legendaryQuestManager.advanceStage("dragon_slayer","forge_dragonbane",1),i==="ancient_wine_gold"&&this.legendaryQuestManager.advanceStage("the_ancient_fruit","craft_ancient_wine_gold",1)}),this.legendaryQuestManager.onQuestComplete((t,i)=>{for(const s of i.items)this.inventoryManager.addItem(s,1);i.title&&this.showNotification(`Title earned: ${i.title}`)}),this.farmingManager.onHarvest(()=>{this.careerManager.getCareerId()==="farmer"&&this.careerManager.addCareerXP(15)}),this.fishingManager.onCatch(()=>{this.careerManager.getCareerId()==="fisher"&&this.careerManager.addCareerXP(20)}),this.cookingManager.onCook(()=>{this.careerManager.getCareerId()==="chef"&&this.careerManager.addCareerXP(15)}),this.craftingManager.onCraftComplete(()=>{this.careerManager.getCareerId()==="adventurer"&&this.careerManager.addCareerXP(10)}),this.careerManager.onSpecialization(t=>{this.showNotification(`Specialization: ${t} selected!`),this.audioManager.playSFX(q.LEVEL_UP)}),this.romanceManager.onStageChange((t,i)=>{const a=Ue.get(t)?.name??t;this.showNotification(`${a}: Relationship  ${i}`),this.audioManager.playSFX(q.LEVEL_UP),i==="Married"&&this.achievementManager.trackProgress("secret_keeper",1)}),this.romanceManager.onHeartEvent((t,i)=>{const a=Ue.get(t)?.name??t;this.showNotification(`Heart Event with ${a} (${i} hearts)!`),this.audioManager.playSFX(q.ITEM_PICKUP)}),this.temperatureManager.onComfortChange(t=>{t.tooCold?this.showNotification("You are freezing! Find warmth!"):t.tooHot&&this.showNotification("Extreme heat! Seek shade!")}),this.weaponMasteryManager.onMasteryUp((t,i)=>{const a={1:"Sword",2:"Axe",3:"Spear",4:"Bow",5:"Staff",6:"Dagger",7:"Hammer"}[t]??"Weapon";this.showNotification(`${a} Mastery  Level ${i}`),this.audioManager.playSFX(q.LEVEL_UP);const o=this.weaponMasteryManager.getMilestoneUnlocks(t);if(o.length>0){const n=o[o.length-1];this.showNotification(`Milestone: ${n} unlocked!`)}t===p.Sword&&Hs(i)}),this.storyManager.onCutscene(t=>{const i=Xc[t];i&&this.cutsceneManager.playCutscene(i)}),this.cutsceneManager.onCutsceneStart(()=>{this.inputBlocked=!0,this.showCutsceneOverlay()}),this.cutsceneManager.onStepChange(t=>{this.updateCutsceneOverlay(t)}),this.cutsceneManager.onCutsceneEnd(()=>{this.inputBlocked=!1,this.hideCutsceneOverlay()}),this.interiorManager.onEnterInterior((t,i)=>{this.tutorialManager.showTip("first_building"),this.questManager.updateObjective("explore",t,1)}),this.interiorManager.onExitInterior(t=>{this.showNotification("Returned outside.")}),this.shadowWorldManager.onEnter(()=>{this.showNotification("Entered the Shadow World. Enemies are stronger here."),this.audioManager.playSFX(q.DOOR_OPEN)}),this.shadowWorldManager.onExit(()=>{this.showNotification("Returned from the Shadow World."),this.audioManager.playSFX(q.DOOR_OPEN)}),this.endgameManager.onPortalUnlock(()=>{this.showNotification("The EDILAS Portal has opened at Haven!"),this.ngPlusPortalActive=!0}),this.time.delayedCall(100,()=>{const t=this.scene.get("UIScene");t&&t.getMapUI().onTravel((s,a,o)=>{const n=this.playerController.getEid();f.x[n]=a,f.y[n]=o,this.playerController.getSprite().setPosition(a,o),this.cameras.main.centerOn(a,o),this.showNotification(`Traveled to ${s}`),this.audioManager.playSFX(q.DOOR_OPEN)})})}cleanUp(){for(const e of this.enemySprites.values())e.destroy();this.enemySprites.clear();for(const e of this.enemyHPBars.values())e.destroy();this.enemyHPBars.clear();for(const e of this.lootDrops)e.sprite.destroy(),e.label.destroy();this.lootDrops=[];for(const e of this.notifications)e.text.destroy();this.notifications=[];for(const e of this.damageTexts)e.text.destroy();this.damageTexts=[];for(const e of this.dungeonEntrances)e.marker.destroy(),e.label.destroy();this.dungeonEntrances=[];for(const e of this.settlementEntrances)e.marker.destroy(),e.label.destroy();this.settlementEntrances=[];for(const e of this.riftEntrances)e.marker.destroy(),e.label.destroy();this.riftEntrances=[];for(const e of this.buildingEntrances)e.marker.destroy(),e.label.destroy();this.buildingEntrances=[];for(const e of this.shortcutEntrances)e.marker.destroy(),e.label.destroy();this.shortcutEntrances=[];for(const e of this.campfires)e.marker.destroy(),e.label.destroy();this.campfires=[],this.comboText&&(this.comboText.destroy(),this.comboText=null),this.cutsceneOverlay&&(this.cutsceneOverlay.destroy(),this.cutsceneOverlay=null),this.lightingManager?.destroy(),this.particleManager?.destroy(),this.corruptionOverlay?.destroy()}showCutsceneOverlay(){this.cutsceneOverlay&&this.cutsceneOverlay.destroy();const e=this.cameras.main.width,t=this.cameras.main.height;this.cutsceneOverlay=this.add.container(0,0).setScrollFactor(0).setDepth(1e4);const i=this.add.rectangle(e/2,t/2,e,t,0,.7);this.cutsceneOverlay.add(i);const s=120,a=this.add.rectangle(e/2,t-s/2-20,e-80,s,1118498,.9);a.setStrokeStyle(1,8246268,.5),this.cutsceneOverlay.add(a);const o=this.add.text(60,t-s-10,"",{fontFamily:"monospace",fontSize:"13px",color:"#7dd3fc",fontStyle:"bold"});o.setName("cutscene_speaker"),this.cutsceneOverlay.add(o);const n=this.add.text(60,t-s+10,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffffff",wordWrap:{width:e-160},lineSpacing:4});n.setName("cutscene_body"),this.cutsceneOverlay.add(n);const l=this.add.text(e-80,t-30,"[SPACE] Continue",{fontFamily:"monospace",fontSize:"9px",color:"#888888"}).setOrigin(1,1);this.cutsceneOverlay.add(l),this.input.keyboard.on("keydown-SPACE",this.advanceCutscene,this),this.input.on("pointerdown",this.advanceCutscene,this);const c=this.cutsceneManager.getCurrentStep();c&&this.updateCutsceneOverlay(c)}updateCutsceneOverlay(e){if(!this.cutsceneOverlay)return;const t=this.cutsceneOverlay.getByName("cutscene_speaker"),i=this.cutsceneOverlay.getByName("cutscene_body");e.type==="narration"?(t?.setText(""),i?.setText(e.text??"")):e.type==="dialogue"?(t?.setText(e.speaker??""),i?.setText(e.text??"")):e.type==="wait"&&(t?.setText(""),i?.setText("..."),this.time.delayedCall(e.duration??2e3,()=>{this.cutsceneManager.isPlaying()&&this.cutsceneManager.advance()}))}advanceCutscene=()=>{this.cutsceneManager.isPlaying()&&this.cutsceneManager.getCurrentStep()?.type!=="wait"&&this.cutsceneManager.advance()};hideCutsceneOverlay(){this.input.keyboard.off("keydown-SPACE",this.advanceCutscene,this),this.input.off("pointerdown",this.advanceCutscene,this),this.cutsceneOverlay&&(this.cutsceneOverlay.destroy(),this.cutsceneOverlay=null)}shutdown(){this.cleanUp(),this.chunkManager.destroy(),this.playerController.destroy(),this.npcManager.destroy()}}function he(r,e,t,i,s={base:4,perFloor:.3,max:12}){const a=[];for(let o=1;o<=r;o++){const n=Math.min(Math.floor((o-1)/(r/t.length)),t.length-1),l=Math.min(s.base+Math.floor(o*s.perFloor),s.max),c=l+2;a.push({level:o,enemyPool:e,trapTypes:t[n],roomCount:{min:l,max:c},hasBoss:i[o]!==void 0,...i[o]?{bossId:i[o]}:{}})}return a}const Zc=[{id:"mines",name:"The Mines",description:"An ancient mine system beneath the mountains, rich with ore and crawling with creatures.",biome:"cave",difficulty:1,requiredLevel:1,music:"dungeon",ambience:"cave_drip",tileSet:"dungeon_stone",floors:he(120,["slime","bat","skeleton"],[["spike"],["spike","arrow"],["spike","arrow","poison_gas"],["spike","arrow","poison_gas","pitfall"],["spike","arrow","poison_gas","pitfall","boulder"]],{20:"slime_king",40:"shadow_lord",60:"frost_wyrm",80:"ancient_golem",100:"void_empress",120:"slime_king"}),rewardPool:[{itemId:"copper_ore",chance:.3},{itemId:"iron_ore",chance:.25},{itemId:"gold_ore",chance:.15},{itemId:"amethyst",chance:.08},{itemId:"topaz",chance:.07},{itemId:"emerald",chance:.06},{itemId:"ruby",chance:.05},{itemId:"diamond",chance:.04}]},{id:"skull_cavern",name:"Skull Cavern",description:"A bottomless cavern in the desert where the bravest adventurers seek iridium and glory.",biome:"desert",difficulty:5,requiredLevel:15,requiredItems:["skull_key"],music:"dungeon",ambience:"wind_howl",tileSet:"desert_stone",floors:he(100,["skeleton","goblin","mummy","serpent"],[["spike","arrow"],["spike","arrow","poison_gas"],["spike","arrow","poison_gas","pitfall"],["spike","arrow","poison_gas","pitfall","boulder"]],{25:"shadow_lord",50:"ancient_golem",75:"frost_wyrm",100:"void_empress"}),rewardPool:[{itemId:"iridium_ore",chance:.25},{itemId:"gold_ore",chance:.2},{itemId:"prismatic_shard",chance:.03},{itemId:"diamond",chance:.08},{itemId:"void_essence",chance:.15},{itemId:"serpent_fang",chance:.1}]},{id:"corrupted_grove",name:"Corrupted Grove",description:"A once-beautiful forest twisted by dark magic.",biome:"forest",difficulty:2,requiredLevel:5,music:"dungeon_forest",ambience:"forest_ambient",tileSet:"forest_floor",floors:he(30,["treant","sprite","wolf","spider"],[["spike"],["spike","poison_gas"],["spike","poison_gas","pitfall"]],{10:"grove_guardian",20:"forest_spider_queen",30:"ancient_treant"}),rewardPool:[{itemId:"wood",chance:.25},{itemId:"vine",chance:.2},{itemId:"mushroom",chance:.15},{itemId:"ancient_bark",chance:.1},{itemId:"living_sap",chance:.08},{itemId:"forest_heart",chance:.05},{itemId:"treant_heart",chance:.03},{itemId:"natures_blessing",chance:.02}]},{id:"blighted_marsh",name:"Blighted Marsh",description:"Fetid swamplands filled with toxic creatures.",biome:"swamp",difficulty:3,requiredLevel:8,music:"dungeon_swamp",ambience:"swamp_bubbles",tileSet:"swamp_mud",floors:he(25,["frog","leech","bog_zombie","will_o_wisp"],[["poison_gas"],["poison_gas","pitfall"],["poison_gas","pitfall","spike"]],{12:"marsh_lurker",25:"swamp_horror"}),rewardPool:[{itemId:"swamp_moss",chance:.2},{itemId:"toxin_gland",chance:.18},{itemId:"murky_water",chance:.15},{itemId:"venom_sac",chance:.1},{itemId:"bog_essence",chance:.08},{itemId:"marsh_eye",chance:.06},{itemId:"horror_tentacle",chance:.04},{itemId:"blighted_heart",chance:.03}]},{id:"scorched_wastes",name:"Scorched Wastes",description:"Volcanic caverns beneath a scorched wasteland.",biome:"volcano",difficulty:4,requiredLevel:12,music:"dungeon_volcano",ambience:"lava_rumble",tileSet:"volcanic_rock",floors:he(35,["fire_imp","magma_slime","fire_elemental","lava_serpent"],[["spike","arrow"],["spike","arrow","boulder"],["spike","arrow","boulder","pitfall"]],{15:"fire_imp_king",25:"lava_golem",35:"molten_guardian"}),rewardPool:[{itemId:"fire_ore",chance:.22},{itemId:"obsidian",chance:.18},{itemId:"ash",chance:.15},{itemId:"magma_core",chance:.1},{itemId:"fire_crystal",chance:.08},{itemId:"flame_core",chance:.06},{itemId:"molten_heart",chance:.04},{itemId:"infernal_essence",chance:.03}]},{id:"frozen_depths",name:"Frozen Depths",description:"Ancient ice caverns where the cold never fades.",biome:"snow",difficulty:4,requiredLevel:12,music:"dungeon_ice",ambience:"wind_howl",tileSet:"ice_floor",floors:he(40,["ice_elemental","frost_sprite","yeti","ice_wraith"],[["spike"],["spike","arrow"],["spike","arrow","pitfall"],["spike","arrow","pitfall","boulder"]],{15:"frost_guardian",30:"ice_demon",40:"frost_wyrm"}),rewardPool:[{itemId:"ice_crystal",chance:.22},{itemId:"frozen_tear",chance:.18},{itemId:"snow_essence",chance:.15},{itemId:"permafrost",chance:.1},{itemId:"glacial_shard",chance:.08},{itemId:"frost_shard",chance:.06},{itemId:"wyrm_scale",chance:.04},{itemId:"heart_of_winter",chance:.03}]},{id:"haunted_ruins",name:"Haunted Ruins",description:"Ancient ruins infested with restless spirits.",biome:"wasteland",difficulty:5,requiredLevel:15,music:"dungeon_undead",ambience:"ghost_whisper",tileSet:"crypt_stone",floors:he(50,["skeleton","ghost","zombie","wraith","bone_knight"],[["spike","arrow"],["spike","arrow","poison_gas"],["spike","arrow","poison_gas","pitfall"],["spike","arrow","poison_gas","pitfall","boulder"]],{20:"bone_lord",35:"spectral_warden",50:"lich_king"}),rewardPool:[{itemId:"bone",chance:.2},{itemId:"ectoplasm",chance:.18},{itemId:"grave_dust",chance:.15},{itemId:"soul_fragment",chance:.1},{itemId:"spirit_essence",chance:.08},{itemId:"cursed_relic",chance:.06},{itemId:"lich_phylactery",chance:.03},{itemId:"death_crown",chance:.02}]},{id:"sunken_temple",name:"Sunken Temple",description:"A drowned temple beneath the coastal cliffs, swallowed by the rising tide centuries ago.",biome:"beach",difficulty:3,requiredLevel:10,music:"dungeon",ambience:"underwater_current",tileSet:"coral_stone",floors:he(30,["crab_warrior","drowned_zombie","jellyfish","sea_serpent"],[["spike"],["spike","poison_gas"],["spike","poison_gas","pitfall"]],{10:"tide_warden",20:"kraken_spawn",30:"deep_leviathan"}),rewardPool:[{itemId:"coral_shard",chance:.22},{itemId:"sea_glass",chance:.18},{itemId:"pearl",chance:.12},{itemId:"trident_fragment",chance:.08},{itemId:"ocean_heart",chance:.05},{itemId:"neptune_scale",chance:.04},{itemId:"abyssal_pearl",chance:.03},{itemId:"leviathan_tooth",chance:.02}]},{id:"crystal_caverns",name:"Crystal Caverns",description:"Shimmering underground grottos where living crystals pulse with arcane energy.",biome:"cave",difficulty:3,requiredLevel:10,music:"dungeon",ambience:"crystal_hum",tileSet:"crystal_floor",floors:he(35,["crystal_golem","gem_beetle","prism_bat","shard_elemental"],[["spike"],["spike","arrow"],["spike","arrow","boulder"]],{12:"crystal_sentinel",24:"prism_colossus",35:"geode_monarch"}),rewardPool:[{itemId:"amethyst",chance:.18},{itemId:"topaz",chance:.15},{itemId:"emerald",chance:.12},{itemId:"ruby",chance:.1},{itemId:"diamond",chance:.08},{itemId:"prismatic_shard",chance:.04},{itemId:"crystal_heart",chance:.03},{itemId:"geode_crown",chance:.02}]},{id:"shadow_rift",name:"Shadow Rift",description:"A tear in reality where the void bleeds into the world. Dark energy warps everything within.",biome:"void",difficulty:6,requiredLevel:20,requiredItems:["void_talisman"],music:"dungeon_undead",ambience:"void_hum",tileSet:"void_stone",floors:he(45,["shadow_brute","wraith","void_slime","phantom","dark_mage"],[["spike","arrow"],["spike","arrow","poison_gas"],["spike","arrow","poison_gas","pitfall"],["spike","arrow","poison_gas","pitfall","boulder"]],{15:"shadow_lord",30:"void_warden",45:"void_empress"}),rewardPool:[{itemId:"void_essence",chance:.25},{itemId:"shadow_orb",chance:.18},{itemId:"dark_shard",chance:.12},{itemId:"void_heart",chance:.06},{itemId:"shadow_blade",chance:.04},{itemId:"galaxy_soul",chance:.03},{itemId:"void_crown",chance:.02},{itemId:"galaxy_sword",chance:.01}]},{id:"desert_tomb",name:"Desert Tomb",description:"A sealed pharaoh's tomb hidden beneath shifting sands, guarded by undying sentinels.",biome:"desert",difficulty:4,requiredLevel:12,music:"dungeon",ambience:"sand_wind",tileSet:"sandstone",floors:he(30,["mummy","scarab_swarm","sand_golem","desert_wraith"],[["spike","arrow"],["spike","arrow","pitfall"],["spike","arrow","pitfall","boulder"]],{10:"tomb_guardian",20:"anubis_knight",30:"pharaoh_lord"}),rewardPool:[{itemId:"ancient_relic",chance:.2},{itemId:"gold_ore",chance:.18},{itemId:"scarab_gem",chance:.12},{itemId:"pharaoh_mask",chance:.05},{itemId:"desert_rose",chance:.1},{itemId:"sun_stone",chance:.06},{itemId:"ankh_charm",chance:.04},{itemId:"sands_of_time",chance:.03}]},{id:"windswept_spire",name:"Windswept Spire",description:"A crumbling tower that pierces the clouds atop the highest peak, home to aerial predators and ancient magic.",biome:"mountain",difficulty:5,requiredLevel:15,music:"dungeon",ambience:"high_wind",tileSet:"marble_stone",floors:he(40,["harpy","wind_elemental","stone_gargoyle","storm_drake"],[["arrow"],["arrow","pitfall"],["arrow","pitfall","boulder"],["arrow","pitfall","boulder","spike"]],{10:"gale_sentinel",20:"thunder_roc",30:"storm_titan",40:"sky_sovereign"}),rewardPool:[{itemId:"wind_essence",chance:.22},{itemId:"feather_steel",chance:.15},{itemId:"storm_crystal",chance:.1},{itemId:"cloud_marble",chance:.12},{itemId:"sky_shard",chance:.08},{itemId:"roc_talon",chance:.05},{itemId:"thunder_heart",chance:.04},{itemId:"sovereign_plume",chance:.02}]}],ti=new Map(Zc.map(r=>[r.id,r])),ht=60,ut=60,be=8,_a=15,wa=5,va=10,pe={Wall:0,Floor:1,Corridor:2};function ts(r,e,t=0){if(r.w<=_a&&r.h<=_a||r.w<be*2&&r.h<be*2)return;let i;if(r.w<be*2?i=!0:r.h<be*2?i=!1:i=t%2===0?e.next()>.4:e.next()>.6,i){const s=r.h-be;if(s<be)return;const a=e.nextInt(be,s);r.left={x:r.x,y:r.y,w:r.w,h:a,left:null,right:null,room:null},r.right={x:r.x,y:r.y+a,w:r.w,h:r.h-a,left:null,right:null,room:null}}else{const s=r.w-be;if(s<be)return;const a=e.nextInt(be,s);r.left={x:r.x,y:r.y,w:a,h:r.h,left:null,right:null,room:null},r.right={x:r.x+a,y:r.y,w:r.w-a,h:r.h,left:null,right:null,room:null}}ts(r.left,e,t+1),ts(r.right,e,t+1)}function is(r,e){if(r.left!==null&&r.right!==null){is(r.left,e),is(r.right,e);return}const t=e.nextInt(wa,Math.min(va,r.w-2)),i=e.nextInt(wa,Math.min(va,r.h-2)),s=e.nextInt(r.x+1,r.x+r.w-t-1),a=e.nextInt(r.y+1,r.y+r.h-i-1);r.room={x:s,y:a,w:t,h:i}}function ss(r){const e=[];return r.room!==null&&e.push(r.room),r.left!==null&&e.push(...ss(r.left)),r.right!==null&&e.push(...ss(r.right)),e}function ni(r){if(r.room!==null)return{x:Math.floor(r.room.x+r.room.w/2),y:Math.floor(r.room.y+r.room.h/2)};if(r.left!==null){const e=ni(r.left);if(e!==null)return e}return r.right!==null?ni(r.right):null}function ed(r,e,t,i,s){let a=e,o=t;const n=i>a?1:-1;for(;a!==i;)o>=0&&o<r.length&&a>=0&&a<r[0].length&&r[o][a]===pe.Wall&&(r[o][a]=pe.Corridor),a+=n;const l=s>o?1:-1;for(;o!==s;)o>=0&&o<r.length&&a>=0&&a<r[0].length&&r[o][a]===pe.Wall&&(r[o][a]=pe.Corridor),o+=l;o>=0&&o<r.length&&a>=0&&a<r[0].length&&r[o][a]===pe.Wall&&(r[o][a]=pe.Corridor)}function as(r,e){if(r.left===null||r.right===null)return;as(r.left,e),as(r.right,e);const t=ni(r.left),i=ni(r.right);t!==null&&i!==null&&ed(e,t.x,t.y,i.x,i.y)}function td(r,e,t){if(r.length===0)return;r[0].type="entrance",e.hasBoss&&r.length>1&&(r[r.length-1].type="boss");const i=[{type:"monster",weight:50},{type:"treasure",weight:15},{type:"trap",weight:10},{type:"puzzle",weight:10},{type:"shop",weight:5},{type:"corridor",weight:10}],s=i.map(o=>o.type),a=i.map(o=>o.weight);for(let o=0;o<r.length;o++)r[o].type==="monster"&&o!==0&&(e.hasBoss&&o===r.length-1||(r[o].type=t.weightedPick(s,a)))}function id(r,e,t,i){const s=r.width*r.height;switch(r.type){case"monster":{const a=Math.max(1,Math.floor(s/25));for(let o=0;o<a&&e.enemyPool.length!==0;o++){const n=t.pick(e.enemyPool),l=t.nextInt(r.x+1,r.x+r.width-2),c=t.nextInt(r.y+1,r.y+r.height-2);r.enemies.push({typeId:n,x:l,y:c})}break}case"trap":{const a=Math.max(1,Math.floor(s/20));for(let n=0;n<a&&e.trapTypes.length!==0;n++){const l=t.pick(e.trapTypes),c=t.nextInt(r.x+1,r.x+r.width-2),d=t.nextInt(r.y+1,r.y+r.height-2);r.traps.push({type:l,x:c,y:d,triggered:!1})}const o=Math.max(1,Math.floor(s/40));for(let n=0;n<o&&e.enemyPool.length!==0;n++){const l=t.pick(e.enemyPool),c=t.nextInt(r.x+1,r.x+r.width-2),d=t.nextInt(r.y+1,r.y+r.height-2);r.enemies.push({typeId:l,x:c,y:d})}break}case"treasure":{const a=t.nextInt(1,3);for(let o=0;o<a&&i.length!==0;o++){const n=i.map(u=>u.itemId),l=i.map(u=>u.chance),c=t.weightedPick(n,l),d=t.nextInt(r.x+1,r.x+r.width-2),h=t.nextInt(r.y+1,r.y+r.height-2);r.loot.push({itemId:c,x:d,y:h,collected:!1})}if(t.next()<.6&&e.enemyPool.length>0){const o=t.pick(e.enemyPool),n=t.nextInt(r.x+1,r.x+r.width-2),l=t.nextInt(r.y+1,r.y+r.height-2);r.enemies.push({typeId:o,x:n,y:l})}break}case"boss":break;case"puzzle":{if(i.length>0){const a=i.map(d=>d.itemId),o=i.map(d=>d.chance),n=t.weightedPick(a,o),l=Math.floor(r.x+r.width/2),c=Math.floor(r.y+r.height/2);r.loot.push({itemId:n,x:l,y:c,collected:!1})}break}}}function sd(r,e,t){const i=new Rt(t),s=ti.get(r);if(!s)throw new Error(`Unknown dungeon ID: "${r}"`);const a=s.floors.find(w=>w.level===e)??s.floors[s.floors.length-1],o=i.nextInt(a.roomCount.min,a.roomCount.max),n={x:0,y:0,w:ht,h:ut,left:null,right:null,room:null};ts(n,i),is(n,i);const l=[];for(let w=0;w<ut;w++)l.push(new Array(ht).fill(pe.Wall));const c=ss(n);for(const w of c)for(let k=w.y;k<w.y+w.h&&k<ut;k++)for(let F=w.x;F<w.x+w.w&&F<ht;F++)l[k][F]=pe.Floor;as(n,l);const h=c.slice(0,Math.min(o,c.length)).map(w=>({x:w.x,y:w.y,width:w.w,height:w.h,type:"monster",connected:[],cleared:!1,enemies:[],traps:[],loot:[]}));for(let w=0;w<h.length;w++)for(let k=w+1;k<h.length;k++)k===w+1&&(h[w].connected.push(k),h[k].connected.push(w));const u=Math.max(1,Math.floor(h.length/4));for(let w=0;w<u;w++){const k=i.nextInt(0,h.length-1),F=i.nextInt(0,h.length-1);k!==F&&!h[k].connected.includes(F)&&(h[k].connected.push(F),h[F].connected.push(k))}td(h,a,i);const m=s.rewardPool;for(const w of h)id(w,a,i,m);const g=[];for(let w=0;w<ut;w++)g.push(new Array(ht).fill(!1));const y=h.findIndex(w=>w.type==="entrance"),_={dungeonId:r,floorLevel:e,rooms:h,grid:l,explored:g,playerRoom:y>=0?y:0,width:ht,height:ut};return y>=0&&lr(_,y),_}function lr(r,e){if(e<0||e>=r.rooms.length)return;const t=r.rooms[e],i=1,s=Math.max(0,t.y-i),a=Math.min(r.height-1,t.y+t.height+i),o=Math.max(0,t.x-i),n=Math.min(r.width-1,t.x+t.width+i);for(let l=s;l<=a;l++)for(let c=o;c<=n;c++)r.explored[l][c]=!0}function ad(r,e){e<0||e>=r.rooms.length||(r.rooms[e].cleared=!0)}function rd(r,e,t){return e<0||e>=r.width||t<0||t>=r.height?pe.Wall:r.grid[t][e]}function od(r,e,t){return e<0||e>=r.width||t<0||t>=r.height?!1:r.explored[t][e]}function Ri(r,e,t,i){return Math.abs(r-t)+Math.abs(e-i)}function nd(r,e,t,i,s){if(e=Math.max(0,Math.min(r.width-1,Math.floor(e))),t=Math.max(0,Math.min(r.height-1,Math.floor(t))),i=Math.max(0,Math.min(r.width-1,Math.floor(i))),s=Math.max(0,Math.min(r.height-1,Math.floor(s))),r.grid[t][e]===pe.Wall||r.grid[s][i]===pe.Wall)return[];if(e===i&&t===s)return[{x:e,y:t}];const a=[],o=new Set,n={x:e,y:t,g:0,h:Ri(e,t,i,s),f:Ri(e,t,i,s),parent:null};a.push(n);const l=(u,m)=>m*r.width+u,c=[{dx:0,dy:-1},{dx:0,dy:1},{dx:-1,dy:0},{dx:1,dy:0}],d=r.width*r.height;let h=0;for(;a.length>0&&h<d;){h++;let u=0;for(let g=1;g<a.length;g++)a[g].f<a[u].f&&(u=g);const m=a[u];if(m.x===i&&m.y===s){const g=[];let y=m;for(;y!==null;)g.push({x:y.x,y:y.y}),y=y.parent;return g.reverse(),g}a.splice(u,1),o.add(l(m.x,m.y));for(const g of c){const y=m.x+g.dx,_=m.y+g.dy;if(y<0||y>=r.width||_<0||_>=r.height||r.grid[_][y]===pe.Wall||o.has(l(y,_)))continue;const w=m.g+1,k=a.findIndex(F=>F.x===y&&F.y===_);if(k>=0)w<a[k].g&&(a[k].g=w,a[k].f=w+a[k].h,a[k].parent=m);else{const F=Ri(y,_,i,s);a.push({x:y,y:_,g:w,h:F,f:w+F,parent:m})}}}return[]}class ld{generateFloor(e,t,i){return sd(e,t,i)}revealRoom(e,t){lr(e,t)}clearRoom(e,t){ad(e,t)}getTile(e,t,i){return rd(e,t,i)}isExplored(e,t,i){return od(e,t,i)}findPath(e,t,i,s,a){return nd(e,t,i,s,a)}}const cd=0,dd=1,hd=2,ud=3355460,md=5592422,pd=4473941,gd=0,fd=24,yd=32;class bd extends x.Scene{dungeonManager;floorState;dungeonId="";floorLevel=1;returnX;returnY;riftHpMult=1;riftDmgMult=1;playerEid=-1;playerSprite;currentPlayerRoom=-1;wasd;keyQ;keyE;tileGraphics;fogRects=[];fogMap=[];spawnedRooms=new Set;roomEnemyEids=new Map;enemySpriteMap=new Map;lootDropSprites=[];treasureChests=[];hudText;roomTypeText;minimapCam;damageTexts=[];lightingManager;particleManager;audioManager;constructor(){super({key:"DungeonScene"})}init(e){this.dungeonId=e.dungeonId??"mines",this.floorLevel=e.floorLevel??1,this.returnX=e.returnX,this.returnY=e.returnY,this.riftHpMult=1,this.riftDmgMult=1}create(e){e?.dungeonId&&(this.dungeonId=e.dungeonId),e?.floorLevel&&(this.floorLevel=e.floorLevel),this.cameras.main.setBackgroundColor("#111122"),this.cameras.main.fadeIn(500,0,0,0),this.spawnedRooms.clear(),this.roomEnemyEids.clear(),this.enemySpriteMap.clear(),this.lootDropSprites=[],this.treasureChests=[],this.fogRects=[],this.damageTexts=[],this.currentPlayerRoom=-1,this.dungeonManager=new ld;const t=x.Math.Between(1,999999),i=this.dungeonId==="rift"?"mines":this.dungeonId;if(this.floorState=this.dungeonManager.generateFloor(i,this.floorLevel,t),this.dungeonId==="rift"){const g=this.registry.get("riftManager");if(g){const y=g.getCurrentFloor();y&&(this.riftHpMult=y.enemyHpMult,this.riftDmgMult=y.enemyDmgMult)}}this.tileGraphics=this.add.graphics().setDepth(0),this.renderTiles(),this.createFogOfWar();const s=this.findRoomByType("entrance")??this.floorState.rooms[0],a=(s.x+Math.floor(s.width/2))*D+D/2,o=(s.y+Math.floor(s.height/2))*D+D/2;this.playerEid=ms(a,o),this.playerSprite=this.add.image(a,o,"player").setDepth(5e3);const n=this.floorState.rooms.indexOf(s);this.revealRoom(n),this.currentPlayerRoom=n,this.cameras.main.startFollow(this.playerSprite,!0,.12,.12),this.cameras.main.setZoom(1),this.wasd={W:this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.W),A:this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.A),S:this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.S),D:this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.D)},this.keyQ=this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.Q),this.keyE=this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.E);const l=160,c=this.floorState.width*D,d=this.floorState.height*D;this.minimapCam=this.cameras.add(this.scale.width-l-10,10,l,l),this.minimapCam.setBackgroundColor(0),this.minimapCam.setZoom(l/Math.max(c,d)),this.minimapCam.scrollX=c/2-l/(2*this.minimapCam.zoom),this.minimapCam.scrollY=d/2-l/(2*this.minimapCam.zoom),this.minimapCam.setAlpha(.75),this.lightingManager=new Ja(this),this.lightingManager.init(!0),this.particleManager=new _s(this),this.audioManager=new bs(this);const u=ti.get(this.dungeonId)?.name??this.dungeonId,m={fontFamily:"monospace",fontSize:"14px",color:"#dddddd",backgroundColor:"#000000aa",padding:{x:6,y:3}};this.hudText=this.add.text(10,10,`${u}  -  Floor ${this.floorLevel}`,m).setScrollFactor(0).setDepth(9999),this.roomTypeText=this.add.text(10,32,"",{...m,color:"#aaddff"}).setScrollFactor(0).setDepth(9999)}update(e,t){const i=t/1e3;this.processPlayerInput(i),ps(E,i),Na(E,i,1/this.lightingManager.getLightTier().revealMult),fs(E,i),Qa(E,i),$a(E,this.lightingManager.getLightTier().lootRarityBonus),Wa(E,i),this.playerSprite.setPosition(f.x[this.playerEid],f.y[this.playerEid]),this.syncEnemySprites(),this.clampToFloor();const s=this.getRoomAt(f.x[this.playerEid],f.y[this.playerEid]);if(s!==-1&&s!==this.currentPlayerRoom&&(this.onEnterRoom(s),this.currentPlayerRoom=s),this.checkRoomCleared(),s!==-1){const d=this.floorState.rooms[s];d.type==="boss"&&d.cleared&&this.transitionToBoss(s)}this.processLootEvents(),this.checkLootPickup(),x.Input.Keyboard.JustDown(this.keyE)&&this.handleInteraction(),this.processDamageEvents(),this.updateDamageTexts(i),this.lightingManager.updateFuel(i);const a=this.registry.get("corruptionManager");a&&(a.tickCurse(i),this.registry.set("cursed",a.isCursed()),this.registry.set("curseRemaining",a.getCurseRemaining()),a.isCursed()&&(W.current[this.playerEid]=Math.max(0,W.current[this.playerEid]-3*i),S.current[this.playerEid]-=2*i));const o=f.x[this.playerEid],n=f.y[this.playerEid];this.lightingManager.update(0,"haven",o,n);const l=this.lightingManager.getLightTier();this.registry.set("lightTierName",l.name),this.registry.set("lightFuel",this.lightingManager.getFuel()),this.registry.set("dungeonEnemyDmgMult",l.enemyDmgMult);const c=this.cameras.main;if(this.particleManager.update(i,c.scrollX,c.scrollY,c.width/c.zoom,c.height/c.zoom),this.updateFog(),s!==-1){const d=this.floorState.rooms[s];this.roomTypeText.setText(`Room: ${this.formatRoomType(d.type)}${d.cleared?"  [Cleared]":""}`)}else this.roomTypeText.setText("Corridor");x.Input.Keyboard.JustDown(this.keyQ)&&this.exitDungeon()}processPlayerInput(e){let t=0,i=0;if(this.wasd.A.isDown&&(t-=1),this.wasd.D.isDown&&(t+=1),this.wasd.W.isDown&&(i-=1),this.wasd.S.isDown&&(i+=1),t!==0&&i!==0){const s=1/Math.SQRT2;t*=s,i*=s}b.vx[this.playerEid]=t*Ct,b.vy[this.playerEid]=i*Ct,t<0?this.playerSprite.setFlipX(!0):t>0&&this.playerSprite.setFlipX(!1)}clampToFloor(){const e=f.x[this.playerEid],t=f.y[this.playerEid],i=6,s=[{x:e-i,y:t-i},{x:e+i,y:t-i},{x:e-i,y:t+i},{x:e+i,y:t+i}];for(const a of s){const o=Math.floor(a.x/D),n=Math.floor(a.y/D);if(this.dungeonManager.getTile(this.floorState,o,n)===cd){const c=o*D+D/2,d=n*D+D/2,h=D/2+i-Math.abs(e-c),u=D/2+i-Math.abs(t-d);h>0&&u>0&&(h<u?f.x[this.playerEid]+=e<c?-h:h:f.y[this.playerEid]+=t<d?-u:u)}}this.playerSprite.setPosition(f.x[this.playerEid],f.y[this.playerEid])}renderTiles(){const{width:e,height:t}=this.floorState;for(let i=0;i<t;i++)for(let s=0;s<e;s++){const a=this.dungeonManager.getTile(this.floorState,s,i);let o;switch(a){case dd:o=md;break;case hd:o=pd;break;default:o=ud;break}this.tileGraphics.fillStyle(o,1),this.tileGraphics.fillRect(s*D,i*D,D,D)}}createFogOfWar(){const{width:e,height:t}=this.floorState;this.fogMap=[];for(let i=0;i<t;i++){const s=[];for(let a=0;a<e;a++)if(this.dungeonManager.isExplored(this.floorState,a,i))s.push(null);else{const o=this.add.rectangle(a*D+D/2,i*D+D/2,D,D,gd,1).setDepth(8e3);s.push(o),this.fogRects.push(o)}this.fogMap.push(s)}}updateFog(){const{width:e,height:t}=this.floorState;for(let i=0;i<t;i++)for(let s=0;s<e;s++){const a=this.fogMap[i]?.[s];a&&this.dungeonManager.isExplored(this.floorState,s,i)&&(a.destroy(),this.fogMap[i][s]=null)}}findRoomByType(e){return this.floorState.rooms.find(t=>t.type===e)}getRoomAt(e,t){const i=Math.floor(e/D),s=Math.floor(t/D);for(let a=0;a<this.floorState.rooms.length;a++){const o=this.floorState.rooms[a];if(i>=o.x&&i<o.x+o.width&&s>=o.y&&s<o.y+o.height)return a}return-1}onEnterRoom(e){const t=this.floorState.rooms[e];this.revealRoom(e),this.floorState.playerRoom=e,!this.spawnedRooms.has(e)&&t.type==="monster"&&this.spawnRoomEnemies(e),!this.spawnedRooms.has(e)&&t.type==="boss"&&(this.spawnedRooms.add(e),this.dungeonManager.clearRoom(this.floorState,e)),!this.spawnedRooms.has(e)&&t.type==="treasure"&&(this.spawnTreasureChest(e),this.spawnedRooms.add(e))}revealRoom(e){this.dungeonManager.revealRoom(this.floorState,e)}spawnRoomEnemies(e){this.spawnedRooms.add(e);const t=this.floorState.rooms[e],i=[];for(const s of t.enemies){const a=s.x*D+D/2,o=s.y*D+D/2,n=1+this.floorLevel*.1,l=1+this.floorLevel*.08,c=Math.round(40*n*this.riftHpMult),d=Math.round(8*l*this.riftDmgMult),h=Math.round(3+this.floorLevel*.5),u=Ve(a,o,c,d,h,120,"enemy"),m=this.add.image(a,o,"enemy").setDepth(4e3);this.enemySpriteMap.set(u,m),i.push(u)}this.roomEnemyEids.set(e,i)}syncEnemySprites(){for(const[e,t]of this.enemySpriteMap){if(S.current[e]<=0){t.destroy(),this.enemySpriteMap.delete(e);continue}t.setPosition(f.x[e],f.y[e])}}processLootEvents(){const e=Ga();for(const t of e){const i=x.Math.Between(-8,8),s=x.Math.Between(-8,8),a=t.x+i,o=t.y+s,n=this.add.image(0,0,"item_drop").setDepth(3500),l=this.add.text(0,-12,t.itemId,{fontFamily:"monospace",fontSize:"8px",color:"#ffffff",backgroundColor:"#000000aa",padding:{x:2,y:1}}).setOrigin(.5).setDepth(3501),c=this.add.container(a,o,[n,l]).setDepth(3500);this.lootDropSprites.push({container:c,itemId:t.itemId,quantity:t.quantity,x:a,y:o})}}checkLootPickup(){const e=f.x[this.playerEid],t=f.y[this.playerEid];for(let i=this.lootDropSprites.length-1;i>=0;i--){const s=this.lootDropSprites[i];if(x.Math.Distance.Between(e,t,s.x,s.y)<fd){const o=this.registry.get("inventoryManager");o&&o.addItem(s.itemId,s.quantity),this.audioManager.playSFX(q.ITEM_PICKUP);const n=this.add.text(e,t-20,`+${s.quantity} ${s.itemId}`,{fontFamily:"monospace",fontSize:"11px",color:"#44ff88",fontStyle:"bold"}).setOrigin(.5).setDepth(9500);this.tweens.add({targets:n,alpha:0,y:t-50,duration:1200,onComplete:()=>n.destroy()}),s.container.destroy(),this.lootDropSprites.splice(i,1)}}}spawnTreasureChest(e){const t=this.floorState.rooms[e],i=(t.x+Math.floor(t.width/2))*D+D/2,s=(t.y+Math.floor(t.height/2))*D+D/2,a=Math.random()<.15,o=this.add.image(i,s,"item_drop").setTint(a?10027212:16763904).setScale(a?1.8:1.5).setDepth(3800);this.tweens.add({targets:o,scaleX:a?2:1.7,scaleY:a?2:1.7,duration:a?600:800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.treasureChests.push({sprite:o,roomIndex:e,x:i,y:s,opened:!1,cursed:a})}handleInteraction(){const e=f.x[this.playerEid],t=f.y[this.playerEid];for(const i of this.treasureChests){if(i.opened)continue;if(x.Math.Distance.Between(e,t,i.x,i.y)<yd){this.openTreasureChest(i);return}}}openTreasureChest(e){e.opened=!0,this.audioManager.playSFX(q.CHEST_OPEN),this.tweens.killTweensOf(e.sprite),e.sprite.setTint(6710886).setScale(1.5);const t=ti.get(this.dungeonId);if(!t)return;const i=t.rewardPool;if(!i||i.length===0)return;const s=this.registry.get("inventoryManager"),a=e.cursed?x.Math.Between(3,5):x.Math.Between(2,4),o=i.reduce((u,m)=>u+m.chance,0),n=[];for(let u=0;u<a;u++){let m=Math.random()*o;for(const g of i)if(m-=g.chance,m<=0){const y=e.cursed?x.Math.Between(2,5):x.Math.Between(1,3);n.push({itemId:g.itemId,quantity:y}),s&&s.addItem(g.itemId,y);break}}if(e.cursed){const u=this.registry.get("corruptionManager");u&&u.applyCurse(60);const m=this.add.rectangle(this.cameras.main.width/2,this.cameras.main.height/2,this.cameras.main.width,this.cameras.main.height,10027212,.4).setScrollFactor(0).setDepth(9999);this.tweens.add({targets:m,alpha:0,duration:800,onComplete:()=>m.destroy()}),this.cameras.main.shake(300,.01)}const l=e.cursed?"#cc44ff":"#ffcc00",c=e.cursed?"CURSED! ":"",d=n.map(u=>`+${u.quantity} ${u.itemId}`).join(`
`),h=this.add.text(e.x,e.y-20,`${c}${d}`,{fontFamily:"monospace",fontSize:e.cursed?"11px":"10px",color:l,backgroundColor:"#000000cc",padding:{x:4,y:3},align:"center"}).setOrigin(.5).setDepth(9500);this.tweens.add({targets:h,alpha:0,y:e.y-60,duration:e.cursed?3500:2500,onComplete:()=>h.destroy()}),this.dungeonManager.clearRoom(this.floorState,e.roomIndex)}checkRoomCleared(){for(const[e,t]of this.roomEnemyEids){const i=this.floorState.rooms[e];if(i.cleared)continue;if(t.every(a=>S.current[a]<=0)){this.dungeonManager.clearRoom(this.floorState,e);const a=(i.x+i.width/2)*D,o=(i.y+i.height/2)*D-20,n=this.add.text(a,o,"ROOM CLEARED",{fontFamily:"monospace",fontSize:"16px",color:"#44ff44",backgroundColor:"#000000aa",padding:{x:6,y:3}}).setOrigin(.5).setDepth(9e3);this.tweens.add({targets:n,alpha:0,y:o-30,duration:1500,onComplete:()=>n.destroy()})}}}transitionToBoss(e){const t=ti.get(this.dungeonId);if(!t)return;const i=t.floors.find(s=>s.level===this.floorLevel);i?.bossId&&(this.__bossTransitionStarted||(this.__bossTransitionStarted=!0,this.cameras.main.flash(400,255,255,255),this.time.delayedCall(500,()=>{this.cleanUp(),this.scene.start("BossArenaScene",{bossId:i.bossId,returnScene:"DungeonScene",returnData:{dungeonId:this.dungeonId,floorLevel:this.floorLevel+1,returnX:this.returnX,returnY:this.returnY}})})))}processDamageEvents(){const e=gs(),t=this.registry.get("dungeonEnemyDmgMult")??1;for(const i of e){if(i.targetEid===this.playerEid&&t>1){const n=Math.round(i.damage*(t-1));S.current[this.playerEid]-=n}const s=i.isCrit?"#ffaa00":"#ff4444",a=this.add.text(i.x,i.y-12,`${Math.round(i.damage)}${i.isCrit?"!":""}`,{fontFamily:"monospace",fontSize:i.isCrit?"14px":"11px",color:s,fontStyle:i.isCrit?"bold":"normal"}).setOrigin(.5).setDepth(9500);a.__life=0,this.damageTexts.push(a),i.targetEid===this.playerEid?(this.audioManager.playSFX(q.PLAYER_HIT),this.cameras.main.shake(120,.008)):(this.audioManager.playSFX(i.isCrit?q.CRIT_HIT:q.ENEMY_HIT),i.isCrit&&this.cameras.main.shake(80,.005)),this.particleManager.emit("blood",i.x,i.y),i.isCrit?this.particleManager.emit("critFlash",i.x,i.y):this.particleManager.emit("sparks",i.x,i.y)}}updateDamageTexts(e){for(let t=this.damageTexts.length-1;t>=0;t--){const i=this.damageTexts[t],s=i;s.__life+=e,i.y-=30*e,i.setAlpha(Math.max(0,1-s.__life/.8)),s.__life>=.8&&(i.destroy(),this.damageTexts.splice(t,1))}}exitDungeon(){if(this.dungeonId==="rift"){const e=this.registry.get("riftManager");e&&e.advanceFloor()}this.cleanUp(),this.scene.start("OverworldScene",{returnX:this.returnX,returnY:this.returnY})}cleanUp(){this.playerSprite?.destroy(),this.tileGraphics?.destroy();for(const e of this.fogRects)e?.destroy();for(const e of this.damageTexts)e?.destroy();for(const[,e]of this.enemySpriteMap)e?.destroy();this.enemySpriteMap.clear();for(const e of this.lootDropSprites)e.container?.destroy();this.lootDropSprites=[];for(const e of this.treasureChests)e.sprite?.destroy();this.treasureChests=[],this.fogRects=[],this.damageTexts=[],this.spawnedRooms.clear(),this.roomEnemyEids.clear(),this.minimapCam&&this.cameras.remove(this.minimapCam),this.lightingManager?.destroy(),this.particleManager?.destroy()}formatRoomType(e){switch(e){case"monster":return"Monster Room";case"treasure":return"Treasure Room";case"boss":return"Boss Room";case"shop":return"Shop";case"puzzle":return"Puzzle Room";case"trap":return"Trap Room";case"seal":return"Sealed Room";case"entrance":return"Entrance";case"corridor":return"Corridor";default:return String(e)}}}const cr=[{id:"slime_king",name:"Slime King",title:"Lord of the Slimes",biome:"cave",hp:1500,damage:35,defense:12,phases:[{hpThreshold:1,abilities:["bounce","summon_slimes"],speed:1.5,damageMult:1,defenseMult:1,description:"Bounces and summons slime minions."},{hpThreshold:.5,abilities:["bounce","summon_slimes","ground_pound"],speed:1.8,damageMult:1.2,defenseMult:1,description:"Adds devastating ground pound attacks."},{hpThreshold:.25,abilities:["bounce","summon_slimes","ground_pound","split"],speed:2,damageMult:1.5,defenseMult:.8,description:"Splits into smaller copies of itself."}],drops:[{itemId:"slime_crown",chance:1,minQty:1,maxQty:1},{itemId:"royal_jelly",chance:.8,minQty:1,maxQty:3},{itemId:"prismatic_shard",chance:.05,minQty:1,maxQty:1}],arenaWidth:800,arenaHeight:600,music:"boss_slime",xpReward:500,isGateBoss:!1},{id:"shadow_lord",name:"Shadow Lord",title:"Master of Darkness",biome:"cave",hp:3e3,damage:55,defense:20,phases:[{hpThreshold:1,abilities:["shadow_bolt","teleport"],speed:2.5,damageMult:1,defenseMult:1,description:"Fires shadow bolts and teleports around the arena."},{hpThreshold:.6,abilities:["shadow_bolt","teleport","clone"],speed:2.8,damageMult:1.3,defenseMult:1,description:"Creates shadow clones to confuse the player."},{hpThreshold:.3,abilities:["shadow_bolt","teleport","clone","void_zone"],speed:3,damageMult:1.5,defenseMult:.9,description:"Summons void zones that damage anything inside."}],drops:[{itemId:"void_heart",chance:1,minQty:1,maxQty:1},{itemId:"shadow_blade",chance:.3,minQty:1,maxQty:1},{itemId:"galaxy_soul",chance:.1,minQty:1,maxQty:1}],arenaWidth:1e3,arenaHeight:800,music:"boss_shadow",xpReward:1500,isGateBoss:!1},{id:"frost_wyrm",name:"Frost Wyrm",title:"Ancient Ice Dragon",biome:"snow",hp:4e3,damage:70,defense:25,phases:[{hpThreshold:1,abilities:["ice_breath","tail_sweep"],speed:2,damageMult:1,defenseMult:1,description:"Breathes ice and sweeps with its tail."},{hpThreshold:.5,abilities:["ice_breath","tail_sweep","blizzard","fly"],speed:2.5,damageMult:1.3,defenseMult:1,description:"Takes flight and unleashes blizzards."},{hpThreshold:.2,abilities:["ice_breath","tail_sweep","blizzard","fly","ice_prison"],speed:3,damageMult:1.6,defenseMult:.8,description:"Encases the player in ice prisons."}],drops:[{itemId:"frost_scale",chance:1,minQty:3,maxQty:5},{itemId:"frozen_heart",chance:.5,minQty:1,maxQty:1},{itemId:"wyrm_fang",chance:.8,minQty:1,maxQty:2}],arenaWidth:1200,arenaHeight:800,music:"boss_frost",xpReward:2e3,isGateBoss:!1},{id:"ancient_golem",name:"Ancient Golem",title:"Stone Sentinel",biome:"cave",hp:5e3,damage:90,defense:40,phases:[{hpThreshold:1,abilities:["smash","rock_throw"],speed:.8,damageMult:1,defenseMult:1,description:"Smashes and hurls boulders."},{hpThreshold:.5,abilities:["smash","rock_throw","earthquake"],speed:1,damageMult:1.3,defenseMult:1.2,description:"Causes earthquakes that shake the arena."},{hpThreshold:.2,abilities:["smash","rock_throw","earthquake","laser_beam"],speed:1.2,damageMult:1.6,defenseMult:.8,description:"Fires a devastating laser beam from its core."}],drops:[{itemId:"ancient_core",chance:1,minQty:1,maxQty:1},{itemId:"golem_heart",chance:.4,minQty:1,maxQty:1},{itemId:"prismatic_shard",chance:.15,minQty:1,maxQty:2}],arenaWidth:1e3,arenaHeight:1e3,music:"boss_golem",xpReward:2500,isGateBoss:!1},{id:"void_empress",name:"Void Empress",title:"Sovereign of the Abyss",biome:"void",hp:8e3,damage:100,defense:30,phases:[{hpThreshold:1,abilities:["void_bolt","summon_shadows"],speed:3,damageMult:1,defenseMult:1,description:"Fires void bolts and summons shadow minions."},{hpThreshold:.75,abilities:["void_bolt","summon_shadows","dimension_rift"],speed:3.2,damageMult:1.2,defenseMult:1,description:"Opens dimension rifts that distort space."},{hpThreshold:.5,abilities:["void_bolt","summon_shadows","dimension_rift","time_stop"],speed:3.5,damageMult:1.4,defenseMult:.9,description:"Stops time briefly, repositioning for devastating attacks."},{hpThreshold:.25,abilities:["void_bolt","summon_shadows","dimension_rift","time_stop","reality_shatter"],speed:4,damageMult:1.8,defenseMult:.7,description:"Shatters reality itself, warping the arena."}],drops:[{itemId:"void_crown",chance:1,minQty:1,maxQty:1},{itemId:"empress_staff",chance:.5,minQty:1,maxQty:1},{itemId:"galaxy_soul",chance:.3,minQty:1,maxQty:3},{itemId:"prismatic_shard",chance:.2,minQty:1,maxQty:5}],arenaWidth:1400,arenaHeight:1e3,music:"boss_void",xpReward:5e3,isGateBoss:!1},{id:"ice_demon",name:"Ice Demon Lord",title:"Lord of Frozen Torment",biome:"snow",hp:6e3,damage:80,defense:35,phases:[{hpThreshold:1,abilities:["ice_breath","frost_spike"],speed:1.8,damageMult:1,defenseMult:1,description:"Breathes frost and launches ice spikes."},{hpThreshold:.6,abilities:["ice_breath","frost_spike","blizzard"],speed:2,damageMult:1.3,defenseMult:1,description:"Summons devastating blizzards."},{hpThreshold:.3,abilities:["ice_breath","frost_spike","blizzard","ice_prison","absolute_zero"],speed:2.5,damageMult:1.6,defenseMult:.8,description:"Unleashes absolute zero, freezing everything."}],drops:[{itemId:"frozen_heart",chance:1,minQty:1,maxQty:1},{itemId:"ice_crystal",chance:.9,minQty:3,maxQty:5},{itemId:"frost_scale",chance:.7,minQty:1,maxQty:3},{itemId:"prismatic_shard",chance:.1,minQty:1,maxQty:1}],arenaWidth:1200,arenaHeight:900,music:"boss_ice",xpReward:3e3,isGateBoss:!1},{id:"fire_demon",name:"Fire Demon Lord",title:"Lord of Infernal Flame",biome:"volcano",hp:6500,damage:95,defense:28,phases:[{hpThreshold:1,abilities:["fire_breath","meteor"],speed:2.2,damageMult:1,defenseMult:1,description:"Breathes fire and calls down meteors."},{hpThreshold:.6,abilities:["fire_breath","meteor","lava_pool"],speed:2.5,damageMult:1.3,defenseMult:1,description:"Creates pools of lava across the arena."},{hpThreshold:.3,abilities:["fire_breath","meteor","lava_pool","inferno"],speed:3,damageMult:1.6,defenseMult:.8,description:"Engulfs the entire arena in inferno."}],drops:[{itemId:"fire_crystal",chance:1,minQty:3,maxQty:5},{itemId:"demon_heart",chance:.5,minQty:1,maxQty:1},{itemId:"magma_core",chance:.6,minQty:1,maxQty:2},{itemId:"prismatic_shard",chance:.1,minQty:1,maxQty:1}],arenaWidth:1200,arenaHeight:900,music:"boss_fire",xpReward:3200,isGateBoss:!1},{id:"monster_bird",name:"Corrupted Phoenix",title:"Bird of Ruin",biome:"mountain",hp:4500,damage:65,defense:20,phases:[{hpThreshold:1,abilities:["dive_bomb","feather_storm"],speed:3.5,damageMult:1,defenseMult:1,description:"Dive bombs and launches feather storms."},{hpThreshold:.5,abilities:["dive_bomb","feather_storm","wind_gust","fly"],speed:4,damageMult:1.3,defenseMult:1,description:"Takes flight and uses wind gusts."},{hpThreshold:.2,abilities:["dive_bomb","feather_storm","wind_gust","fly","sonic_screech"],speed:4.5,damageMult:1.5,defenseMult:.7,description:"Unleashes a devastating sonic screech."}],drops:[{itemId:"phoenix_feather",chance:1,minQty:1,maxQty:3},{itemId:"wind_essence",chance:.8,minQty:1,maxQty:2},{itemId:"talon",chance:.9,minQty:2,maxQty:4}],arenaWidth:1400,arenaHeight:800,music:"boss_bird",xpReward:2200,isGateBoss:!1},{id:"grove_guardian",name:"Grove Guardian",title:"Protector of the Grove",biome:"forest",hp:800,damage:25,defense:15,phases:[{hpThreshold:1,abilities:["vine_whip","root_burst"],speed:1.2,damageMult:1,defenseMult:1,description:"Whips with vines and bursts roots from the ground."},{hpThreshold:.5,abilities:["vine_whip","root_burst","thorn_shield"],speed:1.5,damageMult:1.3,defenseMult:1.5,description:"Summons a thorn shield for protection."}],drops:[{itemId:"living_sap",chance:1,minQty:1,maxQty:2},{itemId:"ancient_bark",chance:.5,minQty:1,maxQty:1}],arenaWidth:800,arenaHeight:600,music:"boss_forest",xpReward:300,isGateBoss:!1},{id:"forest_spider_queen",name:"Forest Spider Queen",title:"Queen of Webs",biome:"forest",hp:1200,damage:35,defense:10,phases:[{hpThreshold:1,abilities:["web_shot","poison_bite"],speed:2.5,damageMult:1,defenseMult:1,description:"Shoots webs and delivers venomous bites."},{hpThreshold:.6,abilities:["web_shot","poison_bite","spawn_spiderlings"],speed:2.8,damageMult:1.2,defenseMult:1,description:"Spawns waves of spiderlings."},{hpThreshold:.3,abilities:["web_shot","poison_bite","spawn_spiderlings","web_cocoon"],speed:3,damageMult:1.5,defenseMult:.8,description:"Wraps the player in web cocoons."}],drops:[{itemId:"spider_silk",chance:1,minQty:3,maxQty:5},{itemId:"venom_gland",chance:.7,minQty:1,maxQty:2},{itemId:"queen_fang",chance:.3,minQty:1,maxQty:1}],arenaWidth:900,arenaHeight:700,music:"boss_forest",xpReward:500,isGateBoss:!1},{id:"ancient_treant",name:"Ancient Treant",title:"Heart of the Forest",biome:"forest",hp:3e3,damage:60,defense:35,phases:[{hpThreshold:1,abilities:["slam","seed_barrage"],speed:.6,damageMult:1,defenseMult:1,description:"Slams and launches seed barrages."},{hpThreshold:.6,abilities:["slam","seed_barrage","forest_awakening"],speed:.8,damageMult:1.3,defenseMult:1.2,description:"Awakens the forest, spawning hostile plants."},{hpThreshold:.3,abilities:["slam","seed_barrage","forest_awakening","natures_wrath"],speed:1,damageMult:1.6,defenseMult:1,description:"Unleashes nature's wrath  thorns erupt everywhere."}],drops:[{itemId:"treant_heart",chance:1,minQty:1,maxQty:1},{itemId:"forest_heart",chance:.5,minQty:1,maxQty:1},{itemId:"natures_blessing",chance:.25,minQty:1,maxQty:1}],arenaWidth:1200,arenaHeight:900,music:"boss_forest",xpReward:1200,isGateBoss:!1},{id:"marsh_lurker",name:"Marsh Lurker",title:"Terror of the Mire",biome:"swamp",hp:1e3,damage:40,defense:20,phases:[{hpThreshold:1,abilities:["lunge","tail_sweep"],speed:1.8,damageMult:1,defenseMult:1,description:"Lunges and sweeps with its tail."},{hpThreshold:.5,abilities:["lunge","tail_sweep","mud_splash"],speed:2,damageMult:1.3,defenseMult:1.2,description:"Splashes blinding mud across the arena."}],drops:[{itemId:"lurker_scale",chance:1,minQty:1,maxQty:3},{itemId:"swamp_fang",chance:.6,minQty:1,maxQty:1}],arenaWidth:900,arenaHeight:700,music:"boss_swamp",xpReward:400,isGateBoss:!1},{id:"swamp_horror",name:"Swamp Horror",title:"Abomination of the Marsh",biome:"swamp",hp:2500,damage:55,defense:18,phases:[{hpThreshold:1,abilities:["tentacle_slam","toxic_spray"],speed:1,damageMult:1,defenseMult:1,description:"Slams tentacles and sprays toxic sludge."},{hpThreshold:.6,abilities:["tentacle_slam","toxic_spray","dragging_depths"],speed:1.2,damageMult:1.3,defenseMult:1,description:"Drags the player into the swamp depths."},{hpThreshold:.3,abilities:["tentacle_slam","toxic_spray","dragging_depths","miasma"],speed:1.5,damageMult:1.5,defenseMult:.8,description:"Emits a poisonous miasma across the arena."}],drops:[{itemId:"horror_tentacle",chance:1,minQty:1,maxQty:2},{itemId:"blighted_heart",chance:.6,minQty:1,maxQty:1},{itemId:"marsh_eye",chance:.3,minQty:1,maxQty:1}],arenaWidth:1100,arenaHeight:900,music:"boss_swamp",xpReward:1e3,isGateBoss:!1},{id:"fire_imp_king",name:"Fire Imp King",title:"Ruler of the Embers",biome:"volcano",hp:1100,damage:45,defense:12,phases:[{hpThreshold:1,abilities:["fireball","flame_dash"],speed:2.5,damageMult:1,defenseMult:1,description:"Throws fireballs and dashes in flame."},{hpThreshold:.5,abilities:["fireball","flame_dash","summon_imps"],speed:3,damageMult:1.3,defenseMult:1,description:"Summons fire imp reinforcements."}],drops:[{itemId:"imp_crown",chance:1,minQty:1,maxQty:1},{itemId:"fire_ore",chance:.8,minQty:1,maxQty:3}],arenaWidth:800,arenaHeight:600,music:"boss_fire",xpReward:450,isGateBoss:!1},{id:"lava_golem",name:"Lava Golem",title:"Molten Monolith",biome:"volcano",hp:2e3,damage:70,defense:45,phases:[{hpThreshold:1,abilities:["magma_fist","lava_spit"],speed:.7,damageMult:1,defenseMult:1,description:"Punches with magma fists and spits lava."},{hpThreshold:.5,abilities:["magma_fist","lava_spit","eruption"],speed:.9,damageMult:1.4,defenseMult:1.2,description:"Erupts, sending lava everywhere."}],drops:[{itemId:"magma_core",chance:1,minQty:1,maxQty:1},{itemId:"obsidian",chance:.9,minQty:3,maxQty:5},{itemId:"fire_crystal",chance:.5,minQty:1,maxQty:2}],arenaWidth:1e3,arenaHeight:800,music:"boss_fire",xpReward:800,isGateBoss:!1},{id:"molten_guardian",name:"Molten Guardian",title:"Keeper of the Flame",biome:"volcano",hp:4e3,damage:85,defense:30,phases:[{hpThreshold:1,abilities:["fire_breath","meteor"],speed:1.5,damageMult:1,defenseMult:1,description:"Breathes fire and calls meteors."},{hpThreshold:.6,abilities:["fire_breath","meteor","lava_pool"],speed:1.8,damageMult:1.3,defenseMult:1,description:"Creates pools of lava on the arena floor."},{hpThreshold:.3,abilities:["fire_breath","meteor","lava_pool","inferno"],speed:2,damageMult:1.6,defenseMult:.8,description:"Engulfs the arena in a fiery inferno."}],drops:[{itemId:"molten_heart",chance:1,minQty:1,maxQty:1},{itemId:"infernal_essence",chance:.5,minQty:1,maxQty:1},{itemId:"flame_core",chance:.3,minQty:1,maxQty:1},{itemId:"prismatic_shard",chance:.1,minQty:1,maxQty:1}],arenaWidth:1200,arenaHeight:900,music:"boss_fire",xpReward:1800,isGateBoss:!1},{id:"frost_guardian",name:"Frost Guardian",title:"Warden of Ice",biome:"snow",hp:1500,damage:45,defense:30,phases:[{hpThreshold:1,abilities:["ice_spike","frost_armor"],speed:1,damageMult:1,defenseMult:1,description:"Launches ice spikes and reinforces its armor."},{hpThreshold:.5,abilities:["ice_spike","frost_armor","frozen_ground"],speed:1.3,damageMult:1.3,defenseMult:1.5,description:"Freezes the ground, slowing movement."}],drops:[{itemId:"ice_crystal",chance:1,minQty:3,maxQty:5},{itemId:"frost_shard",chance:.6,minQty:1,maxQty:2}],arenaWidth:900,arenaHeight:700,music:"boss_ice",xpReward:600,isGateBoss:!1},{id:"bone_lord",name:"Bone Lord",title:"Commander of the Dead",biome:"wasteland",hp:1800,damage:50,defense:25,phases:[{hpThreshold:1,abilities:["bone_throw","summon_skeletons"],speed:1.5,damageMult:1,defenseMult:1,description:"Throws bones and summons skeleton warriors."},{hpThreshold:.5,abilities:["bone_throw","summon_skeletons","bone_shield"],speed:1.8,damageMult:1.3,defenseMult:1.5,description:"Encases itself in a bone shield."}],drops:[{itemId:"bone",chance:1,minQty:5,maxQty:10},{itemId:"cursed_bone",chance:.6,minQty:1,maxQty:2},{itemId:"bone_crown",chance:.3,minQty:1,maxQty:1}],arenaWidth:900,arenaHeight:700,music:"boss_undead",xpReward:700,isGateBoss:!1},{id:"spectral_warden",name:"Spectral Warden",title:"Keeper of Lost Souls",biome:"wasteland",hp:2200,damage:60,defense:10,phases:[{hpThreshold:1,abilities:["soul_bolt","phase_through"],speed:2.8,damageMult:1,defenseMult:1,description:"Fires soul bolts and phases through walls."},{hpThreshold:.6,abilities:["soul_bolt","phase_through","spectral_chains"],speed:3,damageMult:1.3,defenseMult:1,description:"Binds the player with spectral chains."},{hpThreshold:.3,abilities:["soul_bolt","phase_through","spectral_chains","soul_drain"],speed:3.5,damageMult:1.5,defenseMult:.8,description:"Drains the player's soul for healing."}],drops:[{itemId:"ectoplasm",chance:1,minQty:3,maxQty:5},{itemId:"spirit_essence",chance:.7,minQty:1,maxQty:2},{itemId:"spectral_binding",chance:.3,minQty:1,maxQty:1}],arenaWidth:1e3,arenaHeight:800,music:"boss_undead",xpReward:900,isGateBoss:!1},{id:"lich_king",name:"The Lich King",title:"Master of Death",biome:"wasteland",hp:5e3,damage:80,defense:25,phases:[{hpThreshold:1,abilities:["death_bolt","raise_dead"],speed:1.8,damageMult:1,defenseMult:1,description:"Fires death bolts and raises undead minions."},{hpThreshold:.7,abilities:["death_bolt","raise_dead","death_grip"],speed:2,damageMult:1.2,defenseMult:1,description:"Grips the player with necrotic energy."},{hpThreshold:.4,abilities:["death_bolt","raise_dead","death_grip","frost_nova"],speed:2.2,damageMult:1.4,defenseMult:.9,description:"Freezes everything with a frost nova."},{hpThreshold:.2,abilities:["death_bolt","raise_dead","death_grip","frost_nova","army_of_dead"],speed:2.5,damageMult:1.8,defenseMult:.7,description:"Raises an army of the dead for a final assault."}],drops:[{itemId:"lich_phylactery",chance:1,minQty:1,maxQty:1},{itemId:"death_crown",chance:.5,minQty:1,maxQty:1},{itemId:"soul_fragment",chance:.8,minQty:3,maxQty:5},{itemId:"prismatic_shard",chance:.15,minQty:1,maxQty:1}],arenaWidth:1300,arenaHeight:1e3,music:"boss_undead",xpReward:2500,isGateBoss:!1},{id:"dragon",name:"Ancient Dragon",title:"Scourge of the Mountains",biome:"volcano",hp:1e4,damage:80,defense:35,phases:[{hpThreshold:1,abilities:["fire_breath","tail_sweep","fly"],speed:3,damageMult:1,defenseMult:1,description:"Breathes fire, sweeps tail, takes flight."},{hpThreshold:.6,abilities:["fire_breath","tail_sweep","fly","summon_drakes"],speed:3.5,damageMult:1.3,defenseMult:1,description:"Summons drake minions to aid in battle."},{hpThreshold:.3,abilities:["fire_breath","tail_sweep","fly","summon_drakes","meteor_rain"],speed:4,damageMult:1.6,defenseMult:.8,description:"Rains meteors from the sky in a final fury."}],drops:[{itemId:"dragon_scale",chance:1,minQty:5,maxQty:10},{itemId:"dragon_fang",chance:.8,minQty:1,maxQty:3},{itemId:"fire_crystal",chance:1,minQty:3,maxQty:5},{itemId:"prismatic_shard",chance:.25,minQty:1,maxQty:3}],arenaWidth:1600,arenaHeight:1200,music:"boss_dragon",xpReward:1e4,isGateBoss:!1},{id:"harvest_horror",name:"Harvest Horror",title:"Guardian of Haven's Border",biome:"haven",hp:2e3,damage:40,defense:15,phases:[{hpThreshold:1,abilities:["vine_whip","seed_bomb"],speed:1.5,damageMult:1,defenseMult:1,description:"Whips vines and launches exploding seed bombs."},{hpThreshold:.6,abilities:["vine_whip","seed_bomb","thorn_wall"],speed:1.8,damageMult:1.3,defenseMult:1.2,description:"Creates walls of thorns to restrict movement."},{hpThreshold:.3,abilities:["vine_whip","seed_bomb","thorn_wall","pollen_cloud"],speed:2,damageMult:1.5,defenseMult:1,description:"Releases toxic pollen that poisons the arena."}],drops:[{itemId:"forest_heart",chance:1,minQty:1,maxQty:1},{itemId:"living_sap",chance:.8,minQty:2,maxQty:4},{itemId:"ancient_bark",chance:.5,minQty:1,maxQty:2}],arenaWidth:1e3,arenaHeight:800,music:"boss_haven",weakness:"fire",xpReward:1e3,isGateBoss:!0},{id:"blight_mother",name:"Blight Mother",title:"Matriarch of Decay",biome:"rotwood",hp:3500,damage:55,defense:20,phases:[{hpThreshold:1,abilities:["spore_burst","fungal_slam"],speed:1.2,damageMult:1,defenseMult:1,description:"Releases spore bursts and slams with fungal limbs."},{hpThreshold:.6,abilities:["spore_burst","fungal_slam","spawn_minions"],speed:1.5,damageMult:1.2,defenseMult:1,description:"Spawns fungal minions from its body."},{hpThreshold:.3,abilities:["spore_burst","fungal_slam","spawn_minions","rot_cloud"],speed:1.8,damageMult:1.5,defenseMult:.8,description:"Emits a cloud of rot that decays everything."}],drops:[{itemId:"blighted_heart",chance:1,minQty:1,maxQty:1},{itemId:"spore",chance:.9,minQty:3,maxQty:6},{itemId:"corrupted_heart",chance:.3,minQty:1,maxQty:1}],arenaWidth:1100,arenaHeight:800,music:"boss_rotwood",weakness:"fire",xpReward:1500,isGateBoss:!0},{id:"stone_titan",name:"Stone Titan",title:"Sentinel of the Ashlands",biome:"ashlands",hp:5e3,damage:75,defense:45,phases:[{hpThreshold:1,abilities:["ground_pound","rock_throw"],speed:.8,damageMult:1,defenseMult:1,description:"Pounds the ground and hurls boulders."},{hpThreshold:.6,abilities:["ground_pound","rock_throw","lava_trail"],speed:1,damageMult:1.3,defenseMult:1.2,description:"Leaves trails of lava as it walks."},{hpThreshold:.3,abilities:["ground_pound","rock_throw","lava_trail","volcanic_eruption"],speed:1.2,damageMult:1.6,defenseMult:1,description:"Triggers volcanic eruptions across the arena."}],drops:[{itemId:"flame_core",chance:1,minQty:1,maxQty:1},{itemId:"obsidian",chance:.9,minQty:3,maxQty:6},{itemId:"magma_core",chance:.5,minQty:1,maxQty:2}],arenaWidth:1200,arenaHeight:900,music:"boss_ashlands",weakness:"ice",xpReward:2e3,isGateBoss:!0},{id:"kraken",name:"Kraken",title:"Terror of the Depths",biome:"drowned",hp:6e3,damage:70,defense:25,phases:[{hpThreshold:1,abilities:["tentacle_slam","ink_spray"],speed:1.5,damageMult:1,defenseMult:1,description:"Slams tentacles and sprays blinding ink."},{hpThreshold:.6,abilities:["tentacle_slam","ink_spray","water_surge"],speed:1.8,damageMult:1.3,defenseMult:1,description:"Summons water surges that sweep the arena."},{hpThreshold:.3,abilities:["tentacle_slam","ink_spray","water_surge","whirlpool"],speed:2,damageMult:1.5,defenseMult:.8,description:"Creates a massive whirlpool in the arena center."}],drops:[{itemId:"ocean_heart",chance:1,minQty:1,maxQty:1},{itemId:"pearl",chance:.7,minQty:1,maxQty:3},{itemId:"horror_tentacle",chance:.9,minQty:2,maxQty:4}],arenaWidth:1400,arenaHeight:1e3,music:"boss_drowned",weakness:"lightning",xpReward:2500,isGateBoss:!0},{id:"sand_wyrm",name:"Sand Wyrm",title:"Burrower of the Bone Wastes",biome:"bone",hp:7e3,damage:85,defense:30,phases:[{hpThreshold:1,abilities:["burrow_strike","sand_blast"],speed:2,damageMult:1,defenseMult:1,description:"Burrows underground and strikes from below."},{hpThreshold:.6,abilities:["burrow_strike","sand_blast","tremor_sense"],speed:2.5,damageMult:1.3,defenseMult:1,description:"Uses tremor sense to track and ambush."},{hpThreshold:.3,abilities:["burrow_strike","sand_blast","tremor_sense","sandstorm"],speed:3,damageMult:1.6,defenseMult:.8,description:"Summons a blinding sandstorm."}],drops:[{itemId:"wyrm_scale",chance:1,minQty:3,maxQty:6},{itemId:"wyrm_fang",chance:.7,minQty:1,maxQty:2},{itemId:"soul_fragment",chance:.4,minQty:1,maxQty:3}],arenaWidth:1400,arenaHeight:1e3,music:"boss_bone",weakness:"water",xpReward:3e3,isGateBoss:!0},{id:"void_weaver",name:"Void Weaver",title:"Architect of Nothingness",biome:"void",hp:8e3,damage:95,defense:28,phases:[{hpThreshold:1,abilities:["reality_tear","void_bolt"],speed:2.5,damageMult:1,defenseMult:1,description:"Tears reality and fires void bolts."},{hpThreshold:.6,abilities:["reality_tear","void_bolt","clone_phase"],speed:3,damageMult:1.3,defenseMult:1,description:"Creates clones of itself from the void."},{hpThreshold:.3,abilities:["reality_tear","void_bolt","clone_phase","dimension_swap"],speed:3.5,damageMult:1.6,defenseMult:.7,description:"Swaps dimensions, changing the entire arena."}],drops:[{itemId:"void_essence",chance:1,minQty:5,maxQty:10},{itemId:"galaxy_soul",chance:.4,minQty:1,maxQty:2},{itemId:"void_crown",chance:.15,minQty:1,maxQty:1}],arenaWidth:1400,arenaHeight:1e3,music:"boss_void",weakness:"light",xpReward:4e3,isGateBoss:!0},{id:"storm_lord",name:"Storm Lord",title:"Tempest Sovereign",biome:"edilas",hp:9e3,damage:100,defense:32,phases:[{hpThreshold:1,abilities:["lightning_bolt","wind_push"],speed:3,damageMult:1,defenseMult:1,description:"Hurls lightning and pushes with gale-force wind."},{hpThreshold:.6,abilities:["lightning_bolt","wind_push","tornado"],speed:3.5,damageMult:1.3,defenseMult:1,description:"Summons tornadoes that sweep the arena."},{hpThreshold:.3,abilities:["lightning_bolt","wind_push","tornado","supercell"],speed:4,damageMult:1.6,defenseMult:.8,description:"Creates a supercell storm that reshapes the arena."}],drops:[{itemId:"wind_essence",chance:1,minQty:5,maxQty:8},{itemId:"storm_crystal",chance:.6,minQty:1,maxQty:3},{itemId:"prismatic_shard",chance:.2,minQty:1,maxQty:2}],arenaWidth:1400,arenaHeight:1e3,music:"boss_storm",weakness:"earth",xpReward:5e3,isGateBoss:!0},{id:"world_serpent",name:"World Serpent",title:"The Corruption Source",biome:"edilas",hp:15e3,damage:120,defense:35,phases:[{hpThreshold:1,abilities:["constrict","corruption_breath"],speed:2,damageMult:1,defenseMult:1,description:"Constricts and breathes corruption."},{hpThreshold:.8,abilities:["constrict","corruption_breath","terrain_devour"],speed:2.5,damageMult:1.2,defenseMult:1,description:"Devours sections of the arena terrain."},{hpThreshold:.6,abilities:["constrict","corruption_breath","terrain_devour","spawn_corruption"],speed:3,damageMult:1.4,defenseMult:.9,description:"Spawns corruption nodes that must be destroyed."},{hpThreshold:.4,abilities:["constrict","corruption_breath","terrain_devour","spawn_corruption","void_scream"],speed:3.5,damageMult:1.6,defenseMult:.8,description:"Screams into the void, stunning and damaging everything."},{hpThreshold:.2,abilities:["constrict","corruption_breath","terrain_devour","spawn_corruption","void_scream","world_end"],speed:4,damageMult:2,defenseMult:.6,description:"Attempts to end the world  devastating ultimate attack."}],drops:[{itemId:"edilas_key",chance:1,minQty:1,maxQty:1},{itemId:"prismatic_shard",chance:1,minQty:3,maxQty:5},{itemId:"galaxy_soul",chance:.5,minQty:1,maxQty:3},{itemId:"void_crown",chance:.3,minQty:1,maxQty:1}],arenaWidth:1600,arenaHeight:1200,music:"boss_final",xpReward:15e3,isGateBoss:!0}],rt=new Map;cr.forEach(r=>rt.set(r.id,r));cr.filter(r=>r.isGateBoss);const _d=300,xa=1e3,wd=2e3,vd=80,xd=.6,kd=2500,Sd=1.3,Md=16724787;class Td{eid;def;scene;sprite;phaseIndex=0;phaseTransitionTimer=0;inPhaseTransition=!1;elapsedTime=0;enraged=!1;defeated=!1;abilityIndex=0;abilityCooldown=0;telegraphTimer=0;pendingAbility=null;pendingTargetX=0;pendingTargetY=0;strafeAngle=0;phaseChangeCbs=[];defeatCbs=[];telegraphCbs=[];abilityExecuteCbs=[];constructor(e,t,i,s){this.scene=e;const a=rt.get(t);if(!a)throw new Error(`Unknown boss ID: "${t}"`);this.def=a,this.eid=Ve(i,s,a.hp,a.damage,a.defense,0,t),N(E,Ho,this.eid),v.state[this.eid]=M.Special,this.applyPhaseStats(0),this.sprite=e.add.image(i,s,t),this.sprite.setOrigin(.5,.5)}update(e,t,i){if(this.defeated)return;const s=f.x[this.eid],a=f.y[this.eid];if(this.inPhaseTransition){this.phaseTransitionTimer-=e,this.phaseTransitionTimer<=0&&(this.inPhaseTransition=!1),this.syncSprite();return}if(S.current[this.eid]<=0){this.handleDefeat();return}if(this.checkPhaseTransition(),this.elapsedTime+=e,!this.enraged&&this.elapsedTime>=xr&&this.activateEnrage(),this.pendingAbility!==null){this.telegraphTimer-=e,this.telegraphTimer<=0&&(this.executeAbility(this.pendingAbility,this.pendingTargetX,this.pendingTargetY),this.pendingAbility=null),this.syncSprite();return}this.abilityCooldown-=e;const o=t-s,n=i-a,l=Math.sqrt(o*o+n*n),c=this.getCurrentPhase();let d=c.speed*60;this.enraged&&(d*=Sd);const h=e/1e3;if(l>vd){const _=o/l,w=n/l;f.x[this.eid]=s+_*d*h,f.y[this.eid]=a+w*d*h,b.vx[this.eid]=_*d,b.vy[this.eid]=w*d}else{this.strafeAngle+=h*1.5;const _=d*xd,w=Math.cos(this.strafeAngle)*_*h,k=Math.sin(this.strafeAngle)*_*h;f.x[this.eid]=s+w,f.y[this.eid]=a+k,b.vx[this.eid]=w/h,b.vy[this.eid]=k/h,this.abilityCooldown<=0&&c.abilities.length>0&&this.startTelegraph(t,i)}const u=this.def.arenaWidth/2,m=this.def.arenaHeight/2,g=v.homeX[this.eid],y=v.homeY[this.eid];f.x[this.eid]=Math.max(g-u,Math.min(g+u,f.x[this.eid])),f.y[this.eid]=Math.max(y-m,Math.min(y+m,f.y[this.eid])),this.syncSprite()}getEid(){return this.eid}getDef(){return this.def}getCurrentPhase(){return this.def.phases[this.phaseIndex]}getPhaseIndex(){return this.phaseIndex}getHealthPercent(){const e=S.max[this.eid];return e<=0?0:S.current[this.eid]/e}isEnraged(){return this.enraged}isDefeated(){return this.defeated}getSprite(){return this.sprite}onPhaseChange(e){this.phaseChangeCbs.push(e)}onDefeat(e){this.defeatCbs.push(e)}onTelegraph(e){this.telegraphCbs.push(e)}onAbilityExecute(e){this.abilityExecuteCbs.push(e)}executeAbility(e,t,i){const s=f.x[this.eid],a=f.y[this.eid],o=T.damage[this.eid],n=e.toLowerCase().replace(/[^a-z_]/g,"");let l;if(n.includes("slam")||n.includes("ground"))l={abilityId:e,targetX:s,targetY:a,damage:o*1.5,radius:80,type:"aoe"};else if(n.includes("charge")||n.includes("rush")||n.includes("dash")){const c=t-s,d=i-a,h=Math.sqrt(c*c+d*d);h>0&&(f.x[this.eid]=s+c/h*Math.min(h,400*.3),f.y[this.eid]=a+d/h*Math.min(h,400*.3)),l={abilityId:e,targetX:f.x[this.eid],targetY:f.y[this.eid],damage:o*1.2,radius:40,type:"charge"},this.syncSprite()}else if(n.includes("projectile")||n.includes("fireball")||n.includes("bolt")||n.includes("spit"))l={abilityId:e,targetX:t,targetY:i,damage:o*.8,radius:16,type:"projectile"};else if(n.includes("summon")||n.includes("spawn")||n.includes("minion")){const c=2+Math.floor(Math.random()*2);for(let d=0;d<c;d++){const h=(Math.random()-.5)*120,u=(Math.random()-.5)*120;Ve(s+h,a+u,Math.round(S.max[this.eid]*.1),Math.round(o*.4),Math.round(T.defense[this.eid]*.3),80)}l={abilityId:e,targetX:s,targetY:a,damage:0,radius:0,type:"summon"}}else l={abilityId:e,targetX:s,targetY:a,damage:o*1.3,radius:100,type:"aoe"};for(const c of this.abilityExecuteCbs)c(l)}destroy(){this.sprite.destroy(),this.phaseChangeCbs.length=0,this.defeatCbs.length=0,this.telegraphCbs.length=0,this.abilityExecuteCbs.length=0}checkPhaseTransition(){const e=this.getHealthPercent(),t=this.def.phases;for(let s=t.length-1;s>this.phaseIndex;s--)if(e<=t[s].hpThreshold){this.transitionToPhase(s);return}const i=this.phaseIndex+1;i<t.length&&e<=t[i].hpThreshold&&this.transitionToPhase(i)}transitionToPhase(e){if(e!==this.phaseIndex){this.phaseIndex=e,this.inPhaseTransition=!0,this.phaseTransitionTimer=_d,this.abilityIndex=0,this.abilityCooldown=0,this.applyPhaseStats(e);for(const t of this.phaseChangeCbs)t(e)}}applyPhaseStats(e){const t=this.def.phases[e],i=this.def.damage,s=this.def.defense;let a=t.damageMult,o=t.defenseMult;this.enraged&&(a*=kr),T.damage[this.eid]=i*a,T.defense[this.eid]=s*o}activateEnrage(){this.enraged=!0,this.applyPhaseStats(this.phaseIndex),this.sprite.setTint(Md)}handleDefeat(){this.defeated=!0,S.current[this.eid]=0,v.state[this.eid]=M.Dead,b.vx[this.eid]=0,b.vy[this.eid]=0,this.sprite.setAlpha(.5);for(const e of this.defeatCbs)e()}startTelegraph(e,t){const i=this.getCurrentPhase();if(i.abilities.length===0)return;const s=i.abilities[this.abilityIndex%i.abilities.length];this.abilityIndex++;const a=xa+Math.random()*(wd-xa);this.pendingAbility=s,this.pendingTargetX=e,this.pendingTargetY=t,this.telegraphTimer=a,this.abilityCooldown=kd;for(const o of this.telegraphCbs)o(s,e,t)}syncSprite(){this.sprite.setPosition(f.x[this.eid],f.y[this.eid])}}const Cd=600,Id=-400,ka=80,Qt=16,Ai=1500,Sa=3e3;class Pd extends x.Scene{bossId="";returnScene="OverworldScene";returnData={};bossController;bossDef;playerEid=-1;playerSprite;isGrounded=!1;arenaWidth=1e3;arenaHeight=800;groundY=0;platforms=[];platformBounds=[];wasd;keySpace;bossHPBar;bossNameText;bossPhaseText;playerHPBar;playerHPText;playerStaminaBar;telegraphs=[];damageTexts=[];particleManager;audioManager;fightActive=!1;victoryShown=!1;constructor(){super({key:"BossArenaScene"})}init(e){this.bossId=e.bossId??"slime_king",this.returnScene=e.returnScene??"OverworldScene",this.returnData=e.returnData??{}}create(e){if(e?.bossId&&(this.bossId=e.bossId),e?.returnScene&&(this.returnScene=e.returnScene),e?.returnData&&(this.returnData=e.returnData),this.cameras.main.setBackgroundColor("#1a0a0a"),this.cameras.main.fadeIn(500,0,0,0),this.telegraphs=[],this.damageTexts=[],this.platforms=[],this.platformBounds=[],this.fightActive=!0,this.victoryShown=!1,this.bossDef=rt.get(this.bossId),!this.bossDef){this.scene.start(this.returnScene,this.returnData);return}this.arenaWidth=this.bossDef.arenaWidth,this.arenaHeight=this.bossDef.arenaHeight,this.groundY=this.arenaHeight-ka,this.particleManager=new _s(this),this.audioManager=new bs(this),this.audioManager.playSFX(q.BOSS_INTRO),this.buildArena();const t=120,i=this.groundY-20;this.playerEid=ms(t,i),this.playerSprite=this.add.image(t,i,"player").setDepth(5e3);const s=this.arenaWidth-180,a=this.groundY-30;this.bossController=new Td(this,this.bossId,s,a),this.bossController.onPhaseChange(n=>{this.onBossPhaseChange(n)}),this.bossController.onDefeat(()=>{this.onBossDefeated()}),this.bossController.onTelegraph((n,l,c)=>{this.showTelegraph(l,c,n)}),this.bossController.onAbilityExecute(n=>{this.handleBossAbility(n)}),this.wasd={A:this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.A),D:this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.D)},this.keySpace=this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.SPACE),this.input.on("pointerdown",n=>{n.leftButtonDown()&&this.fightActive&&this.performAttack()}),this.cameras.main.setBounds(0,0,this.arenaWidth,this.arenaHeight),this.cameras.main.startFollow(this.playerSprite,!0,.15,.15);const o=this.scale.width/this.arenaWidth;this.cameras.main.setZoom(Math.max(o,.6)),this.createHUD()}update(e,t){const i=t/1e3;if(!this.fightActive){this.updateDamageTexts(i);return}this.processPlayerInput(i),this.applyGravity(i),ps(E,i),fs(E,i),this.bossController.update(t,f.x[this.playerEid],f.y[this.playerEid]),this.playerSprite.setPosition(f.x[this.playerEid],f.y[this.playerEid]),this.clampToArena(),this.updateTelegraphs(i),this.processDamageEvents(),this.updateDamageTexts(i);const s=this.cameras.main;this.particleManager.update(i,s.scrollX,s.scrollY,s.width/s.zoom,s.height/s.zoom),this.updateHUD()}buildArena(){const e=this.add.graphics().setDepth(0);e.fillStyle(1706506,1),e.fillRect(0,0,this.arenaWidth,this.arenaHeight),e.fillStyle(4473924,1),e.fillRect(0,this.groundY,this.arenaWidth,ka),e.lineStyle(2,6710886,1),e.lineBetween(0,this.groundY,this.arenaWidth,this.groundY);const t=[{x:this.arenaWidth*.2,y:this.groundY-140,w:160},{x:this.arenaWidth*.5,y:this.groundY-200,w:140},{x:this.arenaWidth*.75,y:this.groundY-120,w:150}];for(const i of t){e.fillStyle(5592405,1),e.fillRect(i.x-i.w/2,i.y,i.w,Qt),e.lineStyle(1,7829367,1),e.lineBetween(i.x-i.w/2,i.y,i.x+i.w/2,i.y);const s=this.add.rectangle(i.x,i.y+Qt/2,i.w,Qt).setVisible(!1);this.platforms.push(s),this.platformBounds.push({x:i.x-i.w/2,y:i.y,w:i.w,h:Qt})}e.lineStyle(3,3355443,.5),e.lineBetween(0,0,0,this.arenaHeight),e.lineBetween(this.arenaWidth,0,this.arenaWidth,this.arenaHeight)}processPlayerInput(e){let t=0;this.wasd.A.isDown&&(t-=1),this.wasd.D.isDown&&(t+=1),b.vx[this.playerEid]=t*Ct,x.Input.Keyboard.JustDown(this.keySpace)&&this.isGrounded&&(b.vy[this.playerEid]=Id,this.isGrounded=!1),t<0?this.playerSprite.setFlipX(!0):t>0&&this.playerSprite.setFlipX(!1)}applyGravity(e){const t=this.playerEid;b.vy[t]+=Cd*e;const i=f.y[t]+b.vy[t]*e;if(i>=this.groundY&&b.vy[t]>0){f.y[t]=this.groundY,b.vy[t]=0,this.isGrounded=!0;return}if(b.vy[t]>0){const s=f.x[t],a=f.y[t];for(const o of this.platformBounds)if(s>=o.x&&s<=o.x+o.w&&a<=o.y&&i>=o.y){f.y[t]=o.y,b.vy[t]=0,this.isGrounded=!0;return}}if(f.y[this.playerEid]<this.groundY){let s=!1;const a=f.x[t],o=f.y[t];for(const n of this.platformBounds)if(a>=n.x&&a<=n.x+n.w&&Math.abs(o-n.y)<2){s=!0;break}s||(this.isGrounded=!1)}}clampToArena(){const e=this.playerEid,t=8;f.x[e]<t&&(f.x[e]=t,b.vx[e]=0),f.x[e]>this.arenaWidth-t&&(f.x[e]=this.arenaWidth-t,b.vx[e]=0),f.y[e]<t&&(f.y[e]=t,b.vy[e]=0),f.y[e]>this.groundY&&(f.y[e]=this.groundY,b.vy[e]=0,this.isGrounded=!0),this.playerSprite.setPosition(f.x[e],f.y[e])}performAttack(){const e=this.playerEid;if(T.attackCooldown[e]>0)return;T.attackCooldown[e]=1/T.attackSpeed[e];const t=this.bossController.getEid(),i=f.x[t]-f.x[e],s=f.y[t]-f.y[e];if(Math.sqrt(i*i+s*s)<=48){const c=Math.random()<T.critChance[e],d=c?T.critMult[e]:1,h=T.damage[e]*d,u=Math.max(1,h-T.defense[t]);S.current[t]-=u;const m=c?"#ffaa00":"#ffffff",g=this.add.text(f.x[t],f.y[t]-20,`${Math.round(u)}${c?"!":""}`,{fontFamily:"monospace",fontSize:c?"16px":"12px",color:m,fontStyle:c?"bold":"normal"}).setOrigin(.5).setDepth(9500);g.__life=0,this.damageTexts.push(g)}const n=f.x[e]+(this.playerSprite.flipX?-24:24),l=this.add.rectangle(n,f.y[e],20,4,16777215,.8).setDepth(5500);this.tweens.add({targets:l,alpha:0,scaleX:2,duration:150,onComplete:()=>l.destroy()})}showTelegraph(e,t,i){const a=this.arenaHeight,o=this.add.rectangle(e,this.arenaHeight/2,80,a,16711680,.15).setDepth(3e3);this.tweens.add({targets:o,alpha:{from:.1,to:.35},duration:300,yoyo:!0,repeat:Math.floor(Ai/600)});const n=this.add.rectangle(e,this.arenaHeight/2,80,a).setStrokeStyle(2,16711680,.6).setFillStyle(0,0).setDepth(3001);this.telegraphs.push({rect:o,timer:Ai/1e3}),this.telegraphs.push({rect:n,timer:Ai/1e3})}handleBossAbility(e){const t=f.x[this.playerEid],i=f.y[this.playerEid];if(e.type==="projectile"){const l=this.bossController.getEid(),c=f.x[l],d=f.y[l],h=e.targetX-c,u=e.targetY-d,m=Math.sqrt(h*h+u*u)||1,g=300;La(c,d,h/m*g,u/m*g,e.damage),this.audioManager.playSFX(q.BOW_SHOOT);return}if(e.type==="summon"){this.cameras.main.shake(100,.005),this.particleManager.emit("sparks",e.targetX,e.targetY);return}const s=t-e.targetX,a=i-e.targetY;Math.sqrt(s*s+a*a)<=e.radius&&(S.current[this.playerEid]-=e.damage,this.cameras.main.shake(200,.015),this.particleManager.emit("blood",t,i),this.audioManager.playSFX(q.PLAYER_HIT));const n=this.add.circle(e.targetX,e.targetY,e.radius,16729088,.3).setDepth(5e3);this.tweens.add({targets:n,alpha:0,scaleX:1.5,scaleY:1.5,duration:300,onComplete:()=>n.destroy()}),e.type==="aoe"?this.cameras.main.shake(250,.02):e.type==="charge"&&this.cameras.main.shake(150,.01)}updateTelegraphs(e){for(let t=this.telegraphs.length-1;t>=0;t--)this.telegraphs[t].timer-=e,this.telegraphs[t].timer<=0&&(this.telegraphs[t].rect.destroy(),this.telegraphs.splice(t,1))}onBossPhaseChange(e){const t=this.bossDef.phases[e];if(!t)return;this.cameras.main.flash(300,200,50,50);const i=this.add.text(this.scale.width/2,this.scale.height/2-40,`Phase ${e+1}`,{fontFamily:"monospace",fontSize:"28px",color:"#ff4444",fontStyle:"bold",backgroundColor:"#000000cc",padding:{x:12,y:6}}).setOrigin(.5).setScrollFactor(0).setDepth(9999),s=this.add.text(this.scale.width/2,this.scale.height/2,t.description,{fontFamily:"monospace",fontSize:"14px",color:"#ffaaaa",backgroundColor:"#000000cc",padding:{x:8,y:4},wordWrap:{width:500},align:"center"}).setOrigin(.5).setScrollFactor(0).setDepth(9999);this.tweens.add({targets:[i,s],alpha:0,delay:1500,duration:500,onComplete:()=>{i.destroy(),s.destroy()}})}onBossDefeated(){if(this.victoryShown)return;this.victoryShown=!0,this.fightActive=!1,b.vx[this.playerEid]=0,b.vy[this.playerEid]=0,this.cameras.main.flash(500,255,255,200);const e=f.x[this.playerEid],t=f.y[this.playerEid];this.particleManager.emit("levelUp",e,t),this.add.text(this.scale.width/2,this.scale.height/2-60,"BOSS DEFEATED",{fontFamily:"monospace",fontSize:"36px",color:"#ffdd44",fontStyle:"bold",backgroundColor:"#000000dd",padding:{x:16,y:10}}).setOrigin(.5).setScrollFactor(0).setDepth(1e4),this.add.text(this.scale.width/2,this.scale.height/2-15,`${this.bossDef.name} - ${this.bossDef.title}`,{fontFamily:"monospace",fontSize:"16px",color:"#ffffff",backgroundColor:"#000000cc",padding:{x:10,y:4}}).setOrigin(.5).setScrollFactor(0).setDepth(1e4);const i=this.registry.get("inventoryManager"),s=[];for(const d of this.bossDef.drops)if(Math.random()<=d.chance){const h=x.Math.Between(d.minQty,d.maxQty);s.push(`  ${d.itemId} x${h}`),i&&i.addItem(d.itemId,h)}s.length>0&&this.add.text(this.scale.width/2,this.scale.height/2+20,`Loot:
${s.join(`
`)}`,{fontFamily:"monospace",fontSize:"13px",color:"#aaffaa",backgroundColor:"#000000cc",padding:{x:10,y:6},align:"center"}).setOrigin(.5,0).setScrollFactor(0).setDepth(1e4),this.add.text(this.scale.width/2,this.scale.height/2+20+s.length*16+20,`+${this.bossDef.xpReward} XP`,{fontFamily:"monospace",fontSize:"18px",color:"#44ddff",fontStyle:"bold",backgroundColor:"#000000cc",padding:{x:8,y:4}}).setOrigin(.5,0).setScrollFactor(0).setDepth(1e4);const a=this.registry.get("skillManager");a&&a.addXP("combat",this.bossDef.xpReward);const o=this.registry.get("weaponMasteryManager");o&&o.addXP("sword",Math.floor(this.bossDef.xpReward/2));const n=this.registry.get("storyManager");n&&n.defeatBoss(this.bossId);const l=this.registry.get("imprintManager");l&&l.unlockFromBoss(this.bossId);const c=this.registry.get("questManager");c&&c.updateObjective("kill",this.bossId,1),this.time.delayedCall(Sa,()=>{this.cleanUp(),this.scene.start(this.returnScene,this.returnData)})}createHUD(){const i=(this.scale.width-400)/2,s=20;this.bossNameText=this.add.text(this.scale.width/2,6,`${this.bossDef.name}`,{fontFamily:"monospace",fontSize:"14px",color:"#ff6666",fontStyle:"bold"}).setOrigin(.5,0).setScrollFactor(0).setDepth(9800),this.bossHPBar=this.add.graphics().setScrollFactor(0).setDepth(9800),this.bossPhaseText=this.add.text(i+400+8,s,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffaaaa"}).setScrollFactor(0).setDepth(9800),this.playerHPBar=this.add.graphics().setScrollFactor(0).setDepth(9800),this.playerHPText=this.add.text(12,this.scale.height-50,"",{fontFamily:"monospace",fontSize:"11px",color:"#ff8888"}).setScrollFactor(0).setDepth(9800),this.playerStaminaBar=this.add.graphics().setScrollFactor(0).setDepth(9800)}updateHUD(){const i=(this.scale.width-400)/2,s=24;this.bossHPBar.clear(),this.bossHPBar.fillStyle(3342336,1),this.bossHPBar.fillRect(i,s,400,16);const a=Math.max(0,this.bossController.getHealthPercent()),o=this.bossController.isEnraged()?16720418:13382451;this.bossHPBar.fillStyle(o,1),this.bossHPBar.fillRect(i,s,400*a,16);for(const H of this.bossDef.phases)if(H.hpThreshold<1){const A=i+400*H.hpThreshold;this.bossHPBar.lineStyle(2,16776960,.7),this.bossHPBar.lineBetween(A,s,A,s+16)}this.bossHPBar.lineStyle(1,6710886,1),this.bossHPBar.strokeRect(i,s,400,16);const n=this.bossController.getPhaseIndex();this.bossPhaseText.setText(`P${n+1}`);const l=160,c=12,d=12,h=this.scale.height-36;this.playerHPBar.clear(),this.playerHPBar.fillStyle(3342336,1),this.playerHPBar.fillRect(d,h,l,c);const u=S.current[this.playerEid],m=S.max[this.playerEid],g=Math.max(0,u/m),y=g>.5?4508740:g>.25?13421636:13386820;this.playerHPBar.fillStyle(y,1),this.playerHPBar.fillRect(d,h,l*g,c),this.playerHPBar.lineStyle(1,6710886,1),this.playerHPBar.strokeRect(d,h,l,c),this.playerHPText.setText(`HP: ${Math.ceil(u)}/${m}`);const _=h+c+4;this.playerStaminaBar.clear(),this.playerStaminaBar.fillStyle(8755,1),this.playerStaminaBar.fillRect(d,_,l,c);const w=W.current[this.playerEid],k=W.max[this.playerEid],F=Math.max(0,w/k);this.playerStaminaBar.fillStyle(3381708,1),this.playerStaminaBar.fillRect(d,_,l*F,c),this.playerStaminaBar.lineStyle(1,6710886,1),this.playerStaminaBar.strokeRect(d,_,l,c),u<=0&&this.fightActive&&this.onPlayerDefeated()}processDamageEvents(){const e=gs();for(const t of e){const i=t.isCrit?"#ffaa00":"#ff4444",s=this.add.text(t.x,t.y-12,`${Math.round(t.damage)}${t.isCrit?"!":""}`,{fontFamily:"monospace",fontSize:t.isCrit?"14px":"11px",color:i,fontStyle:t.isCrit?"bold":"normal"}).setOrigin(.5).setDepth(9500);s.__life=0,this.damageTexts.push(s),t.targetEid===this.playerEid?(this.audioManager.playSFX(q.PLAYER_HIT),this.cameras.main.shake(150,.01)):(this.audioManager.playSFX(t.isCrit?q.CRIT_HIT:q.ENEMY_HIT),t.isCrit&&this.cameras.main.shake(100,.006)),this.particleManager.emit("blood",t.x,t.y),t.isCrit?this.particleManager.emit("critFlash",t.x,t.y):this.particleManager.emit("sparks",t.x,t.y)}}updateDamageTexts(e){for(let t=this.damageTexts.length-1;t>=0;t--){const i=this.damageTexts[t],s=i;s.__life+=e,i.y-=30*e,i.setAlpha(Math.max(0,1-s.__life/.8)),s.__life>=.8&&(i.destroy(),this.damageTexts.splice(t,1))}}onPlayerDefeated(){this.fightActive=!1,b.vx[this.playerEid]=0,b.vy[this.playerEid]=0,this.cameras.main.flash(300,200,0,0),this.add.text(this.scale.width/2,this.scale.height/2,"DEFEATED",{fontFamily:"monospace",fontSize:"32px",color:"#ff4444",fontStyle:"bold",backgroundColor:"#000000dd",padding:{x:16,y:10}}).setOrigin(.5).setScrollFactor(0).setDepth(1e4),this.time.delayedCall(Sa,()=>{this.cleanUp(),this.scene.start("OverworldScene")})}cleanUp(){this.playerSprite?.destroy(),this.bossController?.destroy();for(const e of this.telegraphs)e.rect?.destroy();for(const e of this.damageTexts)e?.destroy();this.telegraphs=[],this.damageTexts=[],this.bossHPBar?.destroy(),this.bossNameText?.destroy(),this.bossPhaseText?.destroy(),this.playerHPBar?.destroy(),this.playerHPText?.destroy(),this.playerStaminaBar?.destroy(),this.particleManager?.destroy()}}const Rd={farm:4500036,mine:8947814,lumber_mill:8939076,workshop:11184708,forge:13395490,alchemy_lab:8930508,kitchen:13404228,fishing_dock:4491468,wall:6710886,guard_tower:8947848,ballista:11158596,barracks:6702148,town_hall:13412932,market:11193412,inn:13404262,library:4482764,temple:13421704,warehouse:6710852},Ad={town_hall:"building_castle",barracks:"building_barracks",inn:"building",market:"building",library:"building",temple:"building",warehouse:"building",farm:"building",mine:"building",lumber_mill:"building",workshop:"building",forge:"building",alchemy_lab:"building",kitchen:"building",fishing_dock:"building",wall:"building",guard_tower:"building",ballista:"building",stable:"building_stable",archery_range:"building_archery"};class Dd extends x.Scene{settlementId="";settlementManager;settlement=null;gridGraphics;gridStartX=0;gridStartY=0;gridCols=5;gridRows=3;plotW=96;plotH=96;buildingSprites=[];settlementNPCs=[];keyE;pannable=!1;worldContainer;titleText;infoText;moraleText;tierText;productionText;buildMenuTexts=[];buildingLabels=[];statusText;buildMode=!1;buildMenuVisible=!1;selectedBuildType=null;contextMenuTexts=[];contextMenuBg=null;constructor(){super({key:"SettlementScene"})}init(e){this.settlementId=e.settlementId??""}create(){this.cameras.main.setBackgroundColor("#1a1a0a");const{width:e,height:t}=this.cameras.main;this.buildMode=!1,this.buildMenuVisible=!1,this.selectedBuildType=null,this.buildMenuTexts=[],this.buildingLabels=[],this.buildingSprites=[],this.settlementNPCs=[],this.settlementManager=this.registry.get("settlementManager"),this.worldContainer=this.add.container(0,0),this.titleText=this.add.text(e/2,16,"Settlement",{fontFamily:"monospace",fontSize:"18px",color:"#ffcc00",fontStyle:"bold"}).setOrigin(.5,0).setScrollFactor(0).setDepth(100),this.tierText=this.add.text(16,16,"",{fontFamily:"monospace",fontSize:"11px",color:"#88ccff"}).setScrollFactor(0).setDepth(100),this.moraleText=this.add.text(16,32,"",{fontFamily:"monospace",fontSize:"11px",color:"#88ff88"}).setScrollFactor(0).setDepth(100);const i=this.gridCols*this.plotW;this.gridRows*this.plotH,this.gridStartX=(e-i)/2,this.gridStartY=70,this.gridGraphics=this.add.graphics(),this.worldContainer.add(this.gridGraphics),this.productionText=this.add.text(e-200,60,"",{fontFamily:"monospace",fontSize:"10px",color:"#ccccaa",wordWrap:{width:180}}).setScrollFactor(0).setDepth(100),this.infoText=this.add.text(20,t-100,"",{fontFamily:"monospace",fontSize:"11px",color:"#aaaaaa",wordWrap:{width:e-40}}).setScrollFactor(0).setDepth(100),this.statusText=this.add.text(e/2,t-50,"",{fontFamily:"monospace",fontSize:"10px",color:"#ffcc00"}).setOrigin(.5).setScrollFactor(0).setDepth(101);const s=this.add.text(e/2,t-20,"[ Leave Settlement ]",{fontFamily:"monospace",fontSize:"14px",color:"#ff8888",backgroundColor:"#221111ee",padding:{x:16,y:6}}).setOrigin(.5).setScrollFactor(0).setDepth(100).setInteractive({useHandCursor:!0});s.on("pointerover",()=>s.setColor("#ffffff")),s.on("pointerout",()=>s.setColor("#ff8888")),s.on("pointerdown",()=>this.leaveSettlement()),this.add.text(e/2,t-60,"[E] Talk | [B] Build | [ESC] Leave",{fontFamily:"monospace",fontSize:"9px",color:"#555555"}).setOrigin(.5,1).setScrollFactor(0).setDepth(100),this.keyE=this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.E),this.input.keyboard.on("keydown-ESC",()=>{this.buildMenuVisible?this.closeBuildMenu():this.leaveSettlement()}),this.input.keyboard.on("keydown-B",()=>{this.buildMenuVisible?this.closeBuildMenu():this.openBuildMenu()}),this.input.on("pointerdown",a=>{this.buildMenuVisible||(this.selectedBuildType&&this.settlement?this.placeBuildingAt(a.x,a.y):this.contextMenuTexts.length>0&&this.closeBuildingContextMenu())}),this.input.keyboard.createCursorKeys(),this.pannable=!0,this.scene.isActive("DialogueScene")||this.scene.launch("DialogueScene"),this.loadSettlement(),this.renderSettlement(),this.placeNPCs()}leaveSettlement(){this.cameras.main.fadeOut(300,0,0,0),this.time.delayedCall(350,()=>{this.cleanUp(),this.scene.start("OverworldScene")})}loadSettlement(){if(!this.settlementManager||!this.settlementId){this.titleText.setText("No Settlement"),this.infoText.setText("Find a settlement site in the overworld to begin.");return}this.settlement=this.settlementManager.getSettlement(this.settlementId),this.settlement||(this.settlementManager.foundSettlement(this.settlementId,this.settlementId),this.settlement=this.settlementManager.getSettlement(this.settlementId)),this.settlement&&this.titleText.setText(this.settlement.name)}renderSettlement(){this.drawGrid(),this.drawBuildings(),this.updateInfoPanel()}drawGrid(){this.gridGraphics.clear();for(let e=0;e<this.gridRows;e++)for(let t=0;t<this.gridCols;t++){const i=this.gridStartX+t*this.plotW,s=this.gridStartY+e*this.plotH;this.gridGraphics.fillStyle(2236945,.6),this.gridGraphics.fillRect(i,s,this.plotW-2,this.plotH-2),this.gridGraphics.lineStyle(1,4473890,.4),this.gridGraphics.strokeRect(i,s,this.plotW-2,this.plotH-2)}}drawBuildings(){for(const e of this.buildingLabels)e.destroy();this.buildingLabels=[];for(const e of this.buildingSprites)e.destroy();if(this.buildingSprites=[],!!this.settlement)for(const e of this.settlement.buildings){const t=Math.min(e.position.x,this.gridCols-1),i=Math.min(e.position.y,this.gridRows-1),s=this.gridStartX+t*this.plotW+this.plotW/2,a=this.gridStartY+i*this.plotH+this.plotH/2;if(e.buildTimeRemaining>0){this.gridGraphics.fillStyle(5583616,.5),this.gridGraphics.fillRect(this.gridStartX+t*this.plotW+4,this.gridStartY+i*this.plotH+4,this.plotW-10,this.plotH-10);const d=this.add.text(s,a,"Building...",{fontFamily:"monospace",fontSize:"9px",color:"#ffaa44"}).setOrigin(.5).setDepth(50);this.buildingLabels.push(d),this.worldContainer.add(d);continue}const o=Ad[e.typeId]??"building",n=this.settlement.buildings.indexOf(e),l=this.add.image(s,a-10,o).setScale(.5).setDepth(40).setInteractive({useHandCursor:!0});l.on("pointerdown",()=>this.openBuildingContextMenu(n,s,a)),this.buildingSprites.push(l),this.worldContainer.add(l);const c=this.add.text(s,a+30,`${e.typeId.replace(/_/g," ")} (T${e.tier})  W:${e.workersAssigned}`,{fontFamily:"monospace",fontSize:"8px",color:"#999999"}).setOrigin(.5,0).setDepth(50);if(this.buildingLabels.push(c),this.worldContainer.add(c),e.tier>1){const d=this.add.text(s+30,a-30,`T${e.tier}`,{fontFamily:"monospace",fontSize:"8px",color:"#ffcc00"}).setDepth(50);this.buildingLabels.push(d),this.worldContainer.add(d)}if(e.assignedNpcId){const d=this.add.text(s-30,a+20,"NPC",{fontFamily:"monospace",fontSize:"7px",color:"#44ff44"}).setDepth(50);this.buildingLabels.push(d),this.worldContainer.add(d)}}}placeNPCs(){for(const a of this.settlementNPCs)a.sprite.destroy(),a.nameLabel.destroy();this.settlementNPCs=[];const e=this.settlementId.replace("_settlement",""),t=At.filter(a=>a.homeCity===e),i=this.gridStartX+48,s=this.gridStartY+this.gridRows*this.plotH+50;for(let a=0;a<t.length;a++){const o=t[a],n=i+a*80,l=s,c=this.add.image(n,l,"npc").setScale(1.5).setDepth(60);this.worldContainer.add(c);const d=this.add.text(n,l-20,o.name,{fontFamily:"monospace",fontSize:"9px",color:"#7dd3fc",stroke:"#000000",strokeThickness:2}).setOrigin(.5).setDepth(61);this.worldContainer.add(d),this.settlementNPCs.push({def:o,sprite:c,nameLabel:d,x:n,y:l})}}updateInfoPanel(){if(!this.settlement)return;const e=this.settlementManager.getSettlementTier(this.settlementId);this.tierText.setText(`Tier: ${e} (${this.settlement.buildings.length} buildings)`);const t=this.settlementManager.getMorale(this.settlementId),i=t>=70?"#88ff88":t>=40?"#ffcc00":"#ff4444";this.moraleText.setText(`Morale: ${Math.round(t)}`),this.moraleText.setColor(i);const s=this.settlementManager.getProduction(this.settlementId),a=Object.entries(s);if(a.length>0){const o=["-- Production/day --",...a.map(([n,l])=>`${n}: ${l}`)];this.productionText.setText(o.join(`
`))}else this.productionText.setText(`-- No Production --
Build production
buildings to start.`);this.infoText.setText(`Workers: ${this.settlement.availableWorkers} available | NPCs: ${this.settlement.recruitedNpcs.length} recruited | Trade routes: ${this.settlement.tradeRoutes.length}`)}checkNPCInteraction(){const e=this.input.activePointer,t=e.worldX,i=e.worldY;for(const s of this.settlementNPCs)if(x.Math.Distance.Between(t,i,s.x,s.y)<=ge*2){const o=this.scene.get("DialogueScene");o&&(this.scene.pause(),o.openDialogue(s.def));return}}openBuildMenu(){this.buildMenuVisible=!0,this.selectedBuildType=null;const{height:e}=this.cameras.main,t=[...vi.production,...vi.defense,...vi.civic];let i=60;const s=16,a=this.add.text(s,i,"-- BUILD MENU --",{fontFamily:"monospace",fontSize:"11px",color:"#ffcc00",fontStyle:"bold"}).setScrollFactor(0).setDepth(200);this.buildMenuTexts.push(a),i+=18;for(const o of t){if(i>e-60)break;const n=oi[o],l=n?.[0]?`${n[0].gold}g`:"???",d="#"+(Rd[o]??13421772).toString(16).padStart(6,"0"),h=this.add.text(s,i,`${o.replace(/_/g," ")}  (${l})`,{fontFamily:"monospace",fontSize:"10px",color:d}).setScrollFactor(0).setDepth(200);h.setInteractive({useHandCursor:!0}),h.on("pointerover",()=>h.setColor("#ffffff")),h.on("pointerout",()=>h.setColor(d)),h.on("pointerdown",()=>{this.selectedBuildType=o,this.closeBuildMenu(),this.statusText.setText(`Click grid to place: ${o.replace(/_/g," ")}`)}),this.buildMenuTexts.push(h),i+=16}}closeBuildMenu(){this.buildMenuVisible=!1;for(const e of this.buildMenuTexts)e.destroy();this.buildMenuTexts=[]}placeBuildingAt(e,t){if(!this.selectedBuildType||!this.settlement)return;const i=Math.floor((e-this.gridStartX)/this.plotW),s=Math.floor((t-this.gridStartY)/this.plotH);if(i<0||i>=this.gridCols||s<0||s>=this.gridRows){this.statusText.setText("Click inside the grid!");return}if(this.settlement.buildings.some(n=>n.position.x===i&&n.position.y===s)){this.statusText.setText("Cell already occupied!");return}if(this.settlementManager.buildBuilding(this.settlementId,this.selectedBuildType)){const n=this.settlement.buildings[this.settlement.buildings.length-1];n&&(n.position={x:i,y:s}),this.statusText.setText(`Built ${this.selectedBuildType.replace(/_/g," ")}!`),this.selectedBuildType=null,this.renderSettlement()}else this.statusText.setText("Cannot build! Check resources/space.")}openBuildingContextMenu(e,t,i){if(this.buildMenuVisible||this.selectedBuildType||(this.closeBuildingContextMenu(),!this.settlement))return;const s=this.settlement.buildings[e];if(!s||s.buildTimeRemaining>0)return;const a=t+40,o=i-40,n=160,l=[],c=s.tier<3,d=oi[s.typeId],h=c&&d?d[s.tier]:null,u=h?`${h.gold}g`:"";c&&l.push({label:`Upgrade to T${s.tier+1} (${u})`,color:"#ffcc00",action:()=>{const w=this.settlementManager.upgradeBuildingExpanded(this.settlementId,e);this.statusText.setText(w?`Upgraded ${s.typeId.replace(/_/g," ")} to T${s.tier}!`:"Cannot upgrade  check resources."),this.closeBuildingContextMenu(),this.renderSettlement()}});const m=s.tier;if(s.workersAssigned<m&&this.settlement.availableWorkers>0&&l.push({label:`Assign Worker (${s.workersAssigned}/${m})`,color:"#88ff88",action:()=>{const w=this.settlementManager.assignWorker(this.settlementId,e);this.statusText.setText(w?"Worker assigned!":"No workers available."),this.closeBuildingContextMenu(),this.renderSettlement(),this.updateInfoPanel()}}),s.workersAssigned>0&&l.push({label:`Remove Worker (${s.workersAssigned}/${m})`,color:"#ff8888",action:()=>{const w=this.settlementManager.removeWorker(this.settlementId,e);this.statusText.setText(w?"Worker removed.":"No workers to remove."),this.closeBuildingContextMenu(),this.renderSettlement(),this.updateInfoPanel()}}),l.push({label:"Close",color:"#888888",action:()=>this.closeBuildingContextMenu()}),l.length===0)return;const g=24+l.length*20;this.contextMenuBg=this.add.graphics(),this.contextMenuBg.fillStyle(1118481,.9),this.contextMenuBg.fillRoundedRect(a-4,o-4,n+8,g+8,4),this.contextMenuBg.lineStyle(1,8246268,.4),this.contextMenuBg.strokeRoundedRect(a-4,o-4,n+8,g+8,4),this.contextMenuBg.setDepth(150),this.worldContainer.add(this.contextMenuBg);const y=this.add.text(a,o,s.typeId.replace(/_/g," ").toUpperCase(),{fontFamily:"monospace",fontSize:"9px",color:"#7dd3fc",fontStyle:"bold"}).setDepth(151);this.contextMenuTexts.push(y),this.worldContainer.add(y);let _=o+18;for(const w of l){const k=this.add.text(a+4,_,w.label,{fontFamily:"monospace",fontSize:"10px",color:w.color}).setInteractive({useHandCursor:!0}).setDepth(151);k.on("pointerover",()=>k.setColor("#ffffff")),k.on("pointerout",()=>k.setColor(w.color)),k.on("pointerdown",w.action),this.contextMenuTexts.push(k),this.worldContainer.add(k),_+=20}}closeBuildingContextMenu(){for(const e of this.contextMenuTexts)e.destroy();this.contextMenuTexts=[],this.contextMenuBg&&(this.contextMenuBg.destroy(),this.contextMenuBg=null)}cleanUp(){this.closeBuildingContextMenu();for(const e of this.settlementNPCs)e.sprite.destroy(),e.nameLabel.destroy();this.settlementNPCs=[];for(const e of this.buildingSprites)e.destroy();this.buildingSprites=[];for(const e of this.buildingLabels)e.destroy();this.buildingLabels=[]}update(){this.settlementManager&&this.settlementId&&(this.settlement=this.settlementManager.getSettlement(this.settlementId)),x.Input.Keyboard.JustDown(this.keyE)&&this.checkNPCInteraction();const e=3;this.input.keyboard.addKey("LEFT").isDown&&(this.worldContainer.x+=e),this.input.keyboard.addKey("RIGHT").isDown&&(this.worldContainer.x-=e),this.input.keyboard.addKey("UP").isDown&&(this.worldContainer.y+=e),this.input.keyboard.addKey("DOWN").isDown&&(this.worldContainer.y-=e)}}class fe{scene;container;background;titleText;closeBtn;isOpen=!1;contentBuilt=!1;panelX;panelY;panelW;panelH;constructor(e,t,i,s,a,o){this.scene=e,this.panelX=t,this.panelY=i,this.panelW=s,this.panelH=a,this.container=e.add.container(t,i),this.container.setDepth(8e3),this.container.setScrollFactor(0),this.container.setVisible(!1),this.background=e.add.graphics(),this.background.fillStyle(1118488,.92),this.background.fillRoundedRect(0,0,s,a,8),this.background.lineStyle(2,8246268,.7),this.background.strokeRoundedRect(0,0,s,a,8),this.background.lineStyle(1,8246268,.35),this.background.lineBetween(8,32,s-8,32),this.container.add(this.background),this.titleText=e.add.text(12,6,o,{fontFamily:"monospace",fontSize:"14px",color:"#7dd3fc",fontStyle:"bold"}),this.container.add(this.titleText),this.closeBtn=e.add.text(s-24,6,"X",{fontFamily:"monospace",fontSize:"14px",color:"#ff6666",fontStyle:"bold"}),this.closeBtn.setInteractive({useHandCursor:!0}),this.closeBtn.on("pointerover",()=>this.closeBtn.setColor("#ff9999")),this.closeBtn.on("pointerout",()=>this.closeBtn.setColor("#ff6666")),this.closeBtn.on("pointerdown",()=>this.close()),this.container.add(this.closeBtn)}open(){this.isOpen||(this.contentBuilt||(this.buildContent(),this.contentBuilt=!0),this.isOpen=!0,this.refresh(),this.container.setVisible(!0),this.container.setAlpha(0),this.scene.tweens.add({targets:this.container,alpha:1,duration:120,ease:"Cubic.easeOut"}))}close(){this.isOpen&&(this.isOpen=!1,this.scene.tweens.add({targets:this.container,alpha:0,duration:80,ease:"Cubic.easeIn",onComplete:()=>this.container.setVisible(!1)}))}toggle(){this.isOpen?this.close():this.open()}getIsOpen(){return this.isOpen}destroy(){this.container.destroy(!0)}}const O=40,ue=4,Le=6,rs=6,Ed=Le*rs,ze=[{slot:"weapon",label:"Weapon"},{slot:"shield",label:"Shield"},{slot:"head",label:"Head"},{slot:"chest",label:"Chest"},{slot:"legs",label:"Legs"},{slot:"feet",label:"Feet"},{slot:"hands",label:"Hands"},{slot:"ring1",label:"Ring 1"},{slot:"ring2",label:"Ring 2"},{slot:"necklace",label:"Necklace"}],qd=["Common","Uncommon","Rare","Epic","Legendary","Mythic"],Ma=[16777215,65280,35071,11141375,16746496,16711680],Bd=["#ffffff","#00ff00","#0088ff","#aa00ff","#ff8800","#ff0000"],Ta={weapon:13382451,armor:3368652,tool:10066278,seed:3394611,crop:6736947,food:13408563,resource:8939059,material:7829367,fish:3381708,potion:13382604,quest:16763904,relic:16737792,bait:6728294,furniture:10053171,misc:8947848};class Fd extends fe{invSlotGraphics=[];invSlotIcons=[];invSlotCountTexts=[];invSlotHitAreas=[];equipSlotGraphics=[];equipSlotIcons=[];equipSlotLabels=[];equipSlotHitAreas=[];tooltip;tooltipBg;tooltipTexts=[];contextMenu;contextBg;contextButtons=[];contextTarget=null;sortBtn;statsText;constructor(e){const s=Math.floor((e.cameras.main.width-580)/2),a=Math.floor((e.cameras.main.height-420)/2);super(e,s,a,580,420,"Inventory & Equipment"),this.tooltipBg=e.add.graphics(),this.tooltip=e.add.container(0,0),this.tooltip.setDepth(8500),this.tooltip.setScrollFactor(0),this.tooltip.setVisible(!1),this.tooltip.add(this.tooltipBg),this.contextBg=e.add.graphics(),this.contextMenu=e.add.container(0,0),this.contextMenu.setDepth(8600),this.contextMenu.setScrollFactor(0),this.contextMenu.setVisible(!1),this.contextMenu.add(this.contextBg)}buildContent(){const i=this.scene.add.text(14,40,"Backpack",{fontFamily:"monospace",fontSize:"11px",color:"#aaaaaa"});this.container.add(i);for(let n=0;n<rs;n++)for(let l=0;l<Le;l++){const c=n*Le+l,d=14+l*(O+ue),h=58+n*(O+ue),u=this.scene.add.graphics();u.fillStyle(1710628,.9),u.fillRoundedRect(d,h,O,O,4),u.lineStyle(1,4473958,.6),u.strokeRoundedRect(d,h,O,O,4),this.container.add(u),this.invSlotGraphics.push(u);const m=this.scene.add.graphics();this.container.add(m),this.invSlotIcons.push(m);const g=this.scene.add.text(d+O-4,h+O-4,"",{fontFamily:"monospace",fontSize:"9px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(1,1);this.container.add(g),this.invSlotCountTexts.push(g);const y=this.scene.add.rectangle(d+O/2,h+O/2,O,O).setAlpha(.001).setInteractive({useHandCursor:!0});this.container.add(y),this.invSlotHitAreas.push(y),y.on("pointerover",_=>this.showInvTooltip(c)),y.on("pointermove",_=>this.moveTooltip(_)),y.on("pointerout",()=>this.hideTooltip()),y.on("pointerdown",_=>{_.rightButtonDown()&&this.openContext("inv",c,_)})}const s=14+Le*(O+ue)+30,a=42,o=this.scene.add.text(s,a-2,"Equipment",{fontFamily:"monospace",fontSize:"11px",color:"#aaaaaa"});this.container.add(o);for(let n=0;n<ze.length;n++){const l=n<5?0:1,c=n<5?n:n-5,d=s+l*(O+ue+60),h=a+16+c*(O+ue),u=this.scene.add.text(d+O+4,h+12,ze[n].label,{fontFamily:"monospace",fontSize:"9px",color:"#666688"});this.container.add(u),this.equipSlotLabels.push(u);const m=this.scene.add.graphics();m.fillStyle(1710628,.9),m.fillRoundedRect(d,h,O,O,4),m.lineStyle(1,5592439,.6),m.strokeRoundedRect(d,h,O,O,4),this.container.add(m),this.equipSlotGraphics.push(m);const g=this.scene.add.graphics();this.container.add(g),this.equipSlotIcons.push(g);const y=this.scene.add.rectangle(d+O/2,h+O/2,O,O).setAlpha(.001).setInteractive({useHandCursor:!0});this.container.add(y),this.equipSlotHitAreas.push(y),y.on("pointerover",()=>this.showEquipTooltip(n)),y.on("pointermove",_=>this.moveTooltip(_)),y.on("pointerout",()=>this.hideTooltip()),y.on("pointerdown",_=>{_.rightButtonDown()&&this.openContext("equip",n,_)})}this.sortBtn=this.scene.add.text(14,58+rs*(O+ue)+4,"[ Sort ]",{fontFamily:"monospace",fontSize:"11px",color:"#7dd3fc"}).setInteractive({useHandCursor:!0}),this.sortBtn.on("pointerover",()=>this.sortBtn.setColor("#aaddff")),this.sortBtn.on("pointerout",()=>this.sortBtn.setColor("#7dd3fc")),this.sortBtn.on("pointerdown",()=>{const n=this.getInventory();n&&(n.autoSort(),this.refresh())}),this.container.add(this.sortBtn),this.statsText=this.scene.add.text(s,58+5*(O+ue)+8,"",{fontFamily:"monospace",fontSize:"10px",color:"#aaaacc",lineSpacing:3}),this.container.add(this.statsText),this.scene.input.mouse?.disableContextMenu()}refresh(){const e=this.getInventory(),t=this.getEquipment();for(let i=0;i<Ed;i++){const s=e?.getSlot(i)??null;this.refreshInvSlot(i,s)}for(let i=0;i<ze.length;i++){const s=t?.getEquipped(ze[i].slot)??null;this.refreshEquipSlot(i,s)}if(t){const i=t.getTotalStats();this.statsText.setText(`ATK  ${i.damage}
DEF  ${i.defense}
HP   +${i.hp}
STA  +${i.stamina}
CRIT ${(i.critChance*100).toFixed(0)}%
ASPD ${i.attackSpeed.toFixed(1)}`)}}refreshInvSlot(e,t){const i=e%Le,s=Math.floor(e/Le),a=14+i*(O+ue),o=58+s*(O+ue),n=this.invSlotIcons[e],l=this.invSlotCountTexts[e],c=this.invSlotGraphics[e];if(n.clear(),c.clear(),t&&t.itemId!==""&&t.quantity>0){const d=j.get(t.itemId),h=d?Ma[d.rarity]??16777215:16777215,u=d?Ta[d.category]??8947848:8947848;c.fillStyle(1710628,.9),c.fillRoundedRect(a,o,O,O,4),c.lineStyle(1.5,h,.7),c.strokeRoundedRect(a,o,O,O,4),n.fillStyle(u,.85),n.fillRoundedRect(a+6,o+6,O-12,O-12,3),l.setText(t.quantity>1?String(t.quantity):"")}else c.fillStyle(1710628,.9),c.fillRoundedRect(a,o,O,O,4),c.lineStyle(1,4473958,.6),c.strokeRoundedRect(a,o,O,O,4),l.setText("")}refreshEquipSlot(e,t){const i=e<5?0:1,s=e<5?e:e-5,o=14+Le*(O+ue)+30+i*(O+ue+60),n=58+s*(O+ue),l=this.equipSlotIcons[e],c=this.equipSlotGraphics[e];if(l.clear(),c.clear(),t){const d=j.get(t.itemId),h=Ma[t.rarity]??16777215,u=d?Ta[d.category]??8947848:8947848;c.fillStyle(1710628,.9),c.fillRoundedRect(o,n,O,O,4),c.lineStyle(1.5,h,.7),c.strokeRoundedRect(o,n,O,O,4),l.fillStyle(u,.85),l.fillRoundedRect(o+6,n+6,O-12,O-12,3)}else c.fillStyle(1710628,.9),c.fillRoundedRect(o,n,O,O,4),c.lineStyle(1,5592439,.6),c.strokeRoundedRect(o,n,O,O,4)}showInvTooltip(e){const t=this.getInventory();if(!t)return;const i=t.getSlot(e);if(!i||i.itemId==="")return;const s=j.get(i.itemId);s&&this.buildTooltip(s,i.quantity)}showEquipTooltip(e){const t=this.getEquipment();if(!t)return;const i=t.getEquipped(ze[e].slot);if(!i)return;const s=j.get(i.itemId);s&&this.buildTooltip(s,1)}buildTooltip(e,t){for(const l of this.tooltipTexts)l.destroy();this.tooltipTexts=[];const i=[],s=Bd[e.rarity]??"#ffffff";i.push({text:e.name,color:s,size:"12px"});const a=qd[e.rarity]??"Common";if(i.push({text:`${a} ${e.category}`,color:"#888888",size:"10px"}),e.description&&i.push({text:e.description,color:"#aaaaaa",size:"10px"}),e.category==="weapon"){const l=e;i.push({text:`Damage: ${l.damage}`,color:"#cc4444",size:"10px"}),i.push({text:`Speed: ${l.attackSpeed.toFixed(1)}`,color:"#cccc44",size:"10px"}),i.push({text:`Crit: ${(l.critChance*100).toFixed(0)}% x${l.critMult.toFixed(1)}`,color:"#cccc44",size:"10px"}),i.push({text:`Type: ${l.weaponType}`,color:"#888888",size:"10px"})}else if(e.category==="armor"){const l=e;i.push({text:`Defense: ${l.defense}`,color:"#4444cc",size:"10px"}),l.hp>0&&i.push({text:`HP: +${l.hp}`,color:"#44cc44",size:"10px"}),l.stamina>0&&i.push({text:`Stamina: +${l.stamina}`,color:"#44cc44",size:"10px"}),i.push({text:`Slot: ${l.slot}`,color:"#888888",size:"10px"})}else if(e.category==="food"){const l=e;l.healAmount>0&&i.push({text:`Heal: ${l.healAmount}`,color:"#44cc44",size:"10px"}),l.staminaRestore>0&&i.push({text:`Stamina: +${l.staminaRestore}`,color:"#44cccc",size:"10px"}),l.buffType&&i.push({text:`Buff: ${l.buffType} (${l.buffDuration}s)`,color:"#cccc44",size:"10px"})}else if(e.category==="potion"){const l=e;i.push({text:`Effect: ${l.effectType} +${l.effectMagnitude}`,color:"#cc44cc",size:"10px"}),i.push({text:`Duration: ${l.effectDuration}s`,color:"#cccc44",size:"10px"})}t>1&&i.push({text:`Qty: ${t}`,color:"#cccccc",size:"10px"}),e.sellPrice>0&&i.push({text:`Sell: ${e.sellPrice}g`,color:"#ffcc44",size:"10px"});let o=0,n=8;for(const l of i){const c=this.scene.add.text(8,n,l.text,{fontFamily:"monospace",fontSize:l.size??"10px",color:l.color,wordWrap:{width:220}});this.tooltip.add(c),this.tooltipTexts.push(c),n+=c.height+2,o=Math.max(o,c.width)}this.tooltipBg.clear(),this.tooltipBg.fillStyle(657938,.95),this.tooltipBg.fillRoundedRect(0,0,o+16,n+8,6),this.tooltipBg.lineStyle(1,8246268,.5),this.tooltipBg.strokeRoundedRect(0,0,o+16,n+8,6),this.tooltip.setVisible(!0)}moveTooltip(e){this.tooltip.visible&&this.tooltip.setPosition(e.x+16,e.y+16)}hideTooltip(){this.tooltip.setVisible(!1);for(const e of this.tooltipTexts)e.destroy();this.tooltipTexts=[],this.tooltipBg.clear()}openContext(e,t,i){this.closeContext(),this.contextTarget={type:e,index:t};const s=[];if(e==="inv"){const n=this.getInventory();if(!n)return;const l=n.getSlot(t);if(!l||l.itemId==="")return;const c=j.get(l.itemId);c&&(c.category==="food"||c.category==="potion")&&s.push({label:"Use",action:()=>{n.removeItem(l.itemId,1),this.refresh(),this.closeContext()}}),c&&(c.category==="weapon"||c.category==="armor")&&s.push({label:"Equip",action:()=>{this.equipFromInventory(t),this.closeContext()}}),s.push({label:"Drop",action:()=>{n.removeItem(l.itemId,l.quantity),this.refresh(),this.closeContext()}})}else{const n=this.getEquipment();if(!n||!n.getEquipped(ze[t].slot))return;s.push({label:"Unequip",action:()=>{this.unequipToInventory(t),this.closeContext()}})}if(s.length===0)return;const a=80,o=s.length*22+8;this.contextBg.clear(),this.contextBg.fillStyle(1118488,.95),this.contextBg.fillRoundedRect(0,0,a,o,4),this.contextBg.lineStyle(1,8246268,.5),this.contextBg.strokeRoundedRect(0,0,a,o,4);for(const n of this.contextButtons)n.destroy();this.contextButtons=[];for(let n=0;n<s.length;n++){const l=this.scene.add.text(8,4+n*22,s[n].label,{fontFamily:"monospace",fontSize:"11px",color:"#cccccc"}).setInteractive({useHandCursor:!0});l.on("pointerover",()=>l.setColor("#7dd3fc")),l.on("pointerout",()=>l.setColor("#cccccc")),l.on("pointerdown",s[n].action),this.contextMenu.add(l),this.contextButtons.push(l)}this.contextMenu.setPosition(i.x,i.y),this.contextMenu.setVisible(!0),this.scene.input.once("pointerdown",()=>{this.scene.time.delayedCall(50,()=>this.closeContext())})}closeContext(){this.contextMenu.setVisible(!1);for(const e of this.contextButtons)e.destroy();this.contextButtons=[],this.contextBg.clear(),this.contextTarget=null}equipFromInventory(e){const t=this.getInventory(),i=this.getEquipment();if(!t||!i)return;const s=t.getSlot(e);if(!s||s.itemId==="")return;const a=j.get(s.itemId);if(!a)return;let o=null;if(a.category==="weapon")o="weapon";else if(a.category==="armor"){const h=a;h.slot==="ring"?o=i.getEquipped("ring1")===null?"ring1":"ring2":h.slot==="shield"?o="shield":o=h.slot}if(!o)return;const n={itemId:s.itemId,slot:o,stats:{damage:a.damage??0,defense:a.defense??0,hp:a.hp??0,stamina:a.stamina??0,critChance:a.critChance??0,critMult:a.critMult??0,attackSpeed:a.attackSpeed??0},rarity:a.rarity,setId:a.setId},l=a.notchCost??0,c=a.tradeoffStat&&a.tradeoffAmount?{stat:a.tradeoffStat,amount:a.tradeoffAmount}:void 0;if(l>0&&!i.canEquipAccessory(l,o))return;t.removeItem(s.itemId,1);const d=i.equip(n,l,c);if(d){const h=j.get(d.itemId);t.addItem(d.itemId,1,h?.maxStack??1)}this.refresh()}unequipToInventory(e){const t=this.getInventory(),i=this.getEquipment();if(!t||!i||t.isFull())return;const s=ze[e].slot,a=i.unequip(s);if(a){const o=j.get(a.itemId);t.addItem(a.itemId,1,o?.maxStack??1)}this.refresh()}getInventory(){return this.scene.registry.get("inventoryManager")??null}getEquipment(){return this.scene.registry.get("equipmentManager")??null}close(){this.hideTooltip(),this.closeContext(),super.close()}destroy(){this.hideTooltip(),this.closeContext(),this.tooltip.destroy(!0),this.contextMenu.destroy(!0),super.destroy()}}const Di=["all","crafting","cooking","alchemy","smithing","sewing"];class zd extends fe{tabTexts=[];activeCategory="all";recipeContainer;recipeEntries=[];detailContainer;detailName;detailStation;detailIngredients;detailOutput;craftBtn;selectedRecipe=null;scrollOffset=0;maxVisible=8;progressBar;progressText;constructor(e){const s=Math.floor((e.cameras.main.width-560)/2),a=Math.floor((e.cameras.main.height-400)/2);super(e,s,a,560,400,"Crafting")}buildContent(){let i=12;for(const a of Di){const o=a.charAt(0).toUpperCase()+a.slice(1),n=this.scene.add.text(i,38,o,{fontFamily:"monospace",fontSize:"10px",color:a===this.activeCategory?"#7dd3fc":"#666688",backgroundColor:a===this.activeCategory?"#1a2a3a":void 0,padding:{x:4,y:2}}).setInteractive({useHandCursor:!0});n.on("pointerdown",()=>{this.activeCategory=a,this.scrollOffset=0,this.refresh()}),this.container.add(n),this.tabTexts.push(n),i+=n.width+6}this.recipeContainer=this.scene.add.container(12,62),this.container.add(this.recipeContainer);const s=290;this.detailContainer=this.scene.add.container(s,62),this.container.add(this.detailContainer),this.detailName=this.scene.add.text(0,0,"",{fontFamily:"monospace",fontSize:"13px",color:"#7dd3fc",fontStyle:"bold"}),this.detailContainer.add(this.detailName),this.detailStation=this.scene.add.text(0,20,"",{fontFamily:"monospace",fontSize:"10px",color:"#888888"}),this.detailContainer.add(this.detailStation),this.detailIngredients=this.scene.add.text(0,42,"",{fontFamily:"monospace",fontSize:"10px",color:"#cccccc",lineSpacing:4,wordWrap:{width:240}}),this.detailContainer.add(this.detailIngredients),this.detailOutput=this.scene.add.text(0,150,"",{fontFamily:"monospace",fontSize:"11px",color:"#44cc44"}),this.detailContainer.add(this.detailOutput),this.craftBtn=this.scene.add.text(0,200,"[ CRAFT ]",{fontFamily:"monospace",fontSize:"13px",color:"#44cc44",backgroundColor:"#1a3a1a",padding:{x:10,y:4}}).setInteractive({useHandCursor:!0}),this.craftBtn.on("pointerover",()=>this.craftBtn.setColor("#66ff66")),this.craftBtn.on("pointerout",()=>this.craftBtn.setColor("#44cc44")),this.craftBtn.on("pointerdown",()=>this.doCraft()),this.detailContainer.add(this.craftBtn),this.progressBar=this.scene.add.graphics(),this.detailContainer.add(this.progressBar),this.progressText=this.scene.add.text(0,240,"",{fontFamily:"monospace",fontSize:"10px",color:"#cccc44"}),this.detailContainer.add(this.progressText),this.scene.input.on("wheel",(a,o,n,l)=>{this.isOpen&&(this.scrollOffset=Math.max(0,this.scrollOffset+(l>0?1:-1)),this.refreshRecipeList())})}refresh(){for(let e=0;e<Di.length;e++){const t=Di[e]===this.activeCategory;this.tabTexts[e].setColor(t?"#7dd3fc":"#666688"),this.tabTexts[e].setBackgroundColor(t?"#1a2a3a":"")}this.refreshRecipeList(),this.refreshDetail(),this.refreshProgress()}refreshRecipeList(){for(const l of this.recipeEntries)l.bg.destroy(),l.nameText.destroy(),l.ingredientText.destroy(),l.hit.destroy();this.recipeEntries=[];const e=this.getCrafting(),t=this.getInventory();if(!e||!t)return;let i=e.getDiscoveredRecipes();this.activeCategory!=="all"&&(i=i.filter(l=>l.category===this.activeCategory)),i.sort((l,c)=>{const d=e.canCraft(l.id,t)?0:1,h=e.canCraft(c.id,t)?0:1;return d!==h?d-h:l.name.localeCompare(c.name)});const s=Math.max(0,i.length-this.maxVisible);this.scrollOffset=Math.min(this.scrollOffset,s);const a=i.slice(this.scrollOffset,this.scrollOffset+this.maxVisible),o=38,n=260;for(let l=0;l<a.length;l++){const c=a[l],d=e.canCraft(c.id,t),h=l*(o+2),u=this.scene.add.graphics();u.fillStyle(d?1714714:1710628,.85),u.fillRoundedRect(0,h,n,o,4),u.lineStyle(1,d?4508740:3355460,.4),u.strokeRoundedRect(0,h,n,o,4),this.recipeContainer.add(u);const m=j.get(c.output.itemId),g=m?m.name:c.name,y=this.scene.add.text(6,h+4,g,{fontFamily:"monospace",fontSize:"11px",color:d?"#cccccc":"#666666"});this.recipeContainer.add(y);const _=c.ingredients.map(F=>{const H=j.get(F.itemId),A=t.countItem(F.itemId),G=H?H.name:F.itemId,Y=A>=F.quantity?"":"!";return`${G} ${A}/${F.quantity}${Y}`}).join(", "),w=this.scene.add.text(6,h+20,_,{fontFamily:"monospace",fontSize:"8px",color:d?"#888888":"#554444",wordWrap:{width:n-12}});this.recipeContainer.add(w);const k=this.scene.add.rectangle(n/2,h+o/2,n,o).setAlpha(.001).setInteractive({useHandCursor:!0});this.recipeContainer.add(k),k.on("pointerdown",()=>{this.selectedRecipe=c,this.refreshDetail()}),this.recipeEntries.push({bg:u,nameText:y,ingredientText:w,hit:k,recipe:c})}}refreshDetail(){if(!this.selectedRecipe){this.detailName.setText("Select a recipe"),this.detailStation.setText(""),this.detailIngredients.setText(""),this.detailOutput.setText(""),this.craftBtn.setVisible(!1);return}const e=this.selectedRecipe,t=this.getInventory(),i=this.getCrafting(),s=i&&t?i.canCraft(e.id,t):!1,a=j.get(e.output.itemId);this.detailName.setText(a?a.name:e.name),this.detailStation.setText(e.station==="none"?"No station required":`Station: ${e.station}`);const o=e.ingredients.map(l=>{const c=j.get(l.itemId),d=t?t.countItem(l.itemId):0,h=c?c.name:l.itemId;return`${d>=l.quantity?"+":"-"} ${h}: ${d}/${l.quantity}`});this.detailIngredients.setText(`Ingredients:
`+o.join(`
`));const n=a?a.name:e.output.itemId;this.detailOutput.setText(`Output: ${n} x${e.output.quantity}`),this.craftBtn.setVisible(!0),this.craftBtn.setColor(s?"#44cc44":"#664444"),this.craftBtn.setBackgroundColor(s?"#1a3a1a":"#2a1a1a")}refreshProgress(){this.progressBar.clear();const e=this.getCrafting();if(!e)return;const t=e.getCraftProgress();t?(this.progressBar.fillStyle(2236979,.8),this.progressBar.fillRoundedRect(0,230,200,12,3),this.progressBar.fillStyle(4508740,.8),this.progressBar.fillRoundedRect(0,230,200*t.progress,12,3),this.progressText.setText(`Crafting... ${Math.floor(t.progress*100)}%  (Queue: ${e.getQueueLength()})`)):this.progressText.setText("")}doCraft(){if(!this.selectedRecipe)return;const e=this.getCrafting(),t=this.getInventory();!e||!t||e.canCraft(this.selectedRecipe.id,t)&&(e.craft(this.selectedRecipe.id,t,1),this.refresh())}getCrafting(){return this.scene.registry.get("craftingManager")??null}getInventory(){return this.scene.registry.get("inventoryManager")??null}}const Ca={main:"#ffcc44",side:"#aaaacc",daily:"#44cccc",weekly:"#4488cc",bounty:"#cc4444",legendary:"#ff8800"};class Hd extends fe{tabTexts=[];activeTab="active";listContainer;listEntries=[];detailContainer;detailName;detailType;detailDesc;detailObjectives;detailRewards;trackBtn;selectedQuestId=null;scrollOffset=0;maxVisible=9;constructor(e){const s=Math.floor((e.cameras.main.width-600)/2),a=Math.floor((e.cameras.main.height-420)/2);super(e,s,a,600,420,"Quest Journal")}buildContent(){const i=[{label:"Active",tab:"active"},{label:"Completed",tab:"completed"},{label:"Failed",tab:"failed"}];let s=12;for(const{label:o,tab:n}of i){const l=this.scene.add.text(s,38,o,{fontFamily:"monospace",fontSize:"11px",color:n===this.activeTab?"#7dd3fc":"#666688",backgroundColor:n===this.activeTab?"#1a2a3a":void 0,padding:{x:6,y:2}}).setInteractive({useHandCursor:!0});l.on("pointerdown",()=>{this.activeTab=n,this.scrollOffset=0,this.selectedQuestId=null,this.refresh()}),this.container.add(l),this.tabTexts.push(l),s+=l.width+8}this.listContainer=this.scene.add.container(12,62),this.container.add(this.listContainer);const a=260;this.detailContainer=this.scene.add.container(a,62),this.container.add(this.detailContainer),this.detailName=this.scene.add.text(0,0,"",{fontFamily:"monospace",fontSize:"13px",color:"#7dd3fc",fontStyle:"bold",wordWrap:{width:310}}),this.detailContainer.add(this.detailName),this.detailType=this.scene.add.text(0,20,"",{fontFamily:"monospace",fontSize:"10px",color:"#888888"}),this.detailContainer.add(this.detailType),this.detailDesc=this.scene.add.text(0,38,"",{fontFamily:"monospace",fontSize:"10px",color:"#aaaaaa",wordWrap:{width:310},lineSpacing:3}),this.detailContainer.add(this.detailDesc),this.detailObjectives=this.scene.add.text(0,100,"",{fontFamily:"monospace",fontSize:"10px",color:"#cccccc",wordWrap:{width:310},lineSpacing:4}),this.detailContainer.add(this.detailObjectives),this.detailRewards=this.scene.add.text(0,240,"",{fontFamily:"monospace",fontSize:"10px",color:"#ffcc44",wordWrap:{width:310},lineSpacing:3}),this.detailContainer.add(this.detailRewards),this.trackBtn=this.scene.add.text(0,310,"[ TRACK ]",{fontFamily:"monospace",fontSize:"12px",color:"#44cc44",backgroundColor:"#1a3a1a",padding:{x:8,y:3}}).setInteractive({useHandCursor:!0}),this.trackBtn.on("pointerover",()=>this.trackBtn.setColor("#66ff66")),this.trackBtn.on("pointerout",()=>this.trackBtn.setColor("#44cc44")),this.trackBtn.on("pointerdown",()=>this.trackQuest()),this.trackBtn.setVisible(!1),this.detailContainer.add(this.trackBtn),this.scene.input.on("wheel",(o,n,l,c)=>{this.isOpen&&(this.scrollOffset=Math.max(0,this.scrollOffset+(c>0?1:-1)),this.refreshList())})}refresh(){const e=["active","completed","failed"];for(let t=0;t<this.tabTexts.length;t++){const i=e[t]===this.activeTab;this.tabTexts[t].setColor(i?"#7dd3fc":"#666688"),this.tabTexts[t].setBackgroundColor(i?"#1a2a3a":"")}this.refreshList(),this.refreshDetail()}refreshList(){for(const n of this.listEntries)n.bg.destroy(),n.nameText.destroy(),n.typeText.destroy(),n.hit.destroy();this.listEntries=[];const e=this.getQuestManager();if(!e)return;const t=[];if(this.activeTab==="active"){const n=e.getActiveQuests();for(const{quest:l,progress:c}of n)t.push({def:l,status:"active",progress:c})}else for(const n of Mt){const l=e.getQuestStatus(n.id);this.activeTab==="completed"&&(l==="complete"||l==="turned_in")?t.push({def:n,status:l,progress:null}):this.activeTab==="failed"&&l==="failed"&&t.push({def:n,status:l,progress:null})}const i=Math.max(0,t.length-this.maxVisible);this.scrollOffset=Math.min(this.scrollOffset,i);const s=t.slice(this.scrollOffset,this.scrollOffset+this.maxVisible),a=34,o=230;for(let n=0;n<s.length;n++){const{def:l}=s[n],c=n*(a+2),d=this.selectedQuestId===l.id,h=this.scene.add.graphics();h.fillStyle(d?1714746:1710628,.85),h.fillRoundedRect(0,c,o,a,4),h.lineStyle(1,d?8246268:3355460,.5),h.strokeRoundedRect(0,c,o,a,4),this.listContainer.add(h);const u=Ca[l.type]??"#aaaaaa",m=this.scene.add.text(6,c+4,l.name,{fontFamily:"monospace",fontSize:"11px",color:"#cccccc",wordWrap:{width:o-12}});this.listContainer.add(m);const g=this.scene.add.text(6,c+20,l.type.toUpperCase(),{fontFamily:"monospace",fontSize:"8px",color:u});this.listContainer.add(g);const y=this.scene.add.rectangle(o/2,c+a/2,o,a).setAlpha(.001).setInteractive({useHandCursor:!0});this.listContainer.add(y),y.on("pointerdown",()=>{this.selectedQuestId=l.id,this.refresh()}),this.listEntries.push({bg:h,nameText:m,typeText:g,hit:y,questId:l.id})}}refreshDetail(){if(!this.selectedQuestId){this.detailName.setText("Select a quest"),this.detailType.setText(""),this.detailDesc.setText(""),this.detailObjectives.setText(""),this.detailRewards.setText(""),this.trackBtn.setVisible(!1);return}const e=this.getQuestManager();if(!e)return;const t=e.getQuestDef(this.selectedQuestId);if(!t)return;const i=e.getQuestStatus(t.id),s=e.getObjectiveProgress(t.id),a=Ca[t.type]??"#aaaaaa";this.detailName.setText(t.name),this.detailType.setText(`${t.type.toUpperCase()}  |  Level ${t.level}  |  ${i.toUpperCase()}`),this.detailType.setColor(a),this.detailDesc.setText(t.description);const o=t.objectives.map((l,c)=>{const d=s?s[c]:0;return`${d>=l.count?"[x]":"[ ]"} ${l.description} (${d}/${l.count})`});this.detailObjectives.setText(`Objectives:
`+o.join(`
`));const n=[];t.rewards.xp>0&&n.push(`XP: ${t.rewards.xp}`),t.rewards.gold>0&&n.push(`Gold: ${t.rewards.gold}`);for(const l of t.rewards.items){const c=j.get(l.itemId),d=c?c.name:l.itemId;n.push(`${d} x${l.quantity}`)}this.detailRewards.setText(`Rewards:
`+n.join(`
`)),this.trackBtn.setVisible(i==="active")}trackQuest(){this.selectedQuestId&&this.scene.registry.set("trackedQuestId",this.selectedQuestId)}getQuestManager(){return this.scene.registry.get("questManager")??null}}const Ia={haven:4881471,rotwood:2968109,ashlands:5913130,drowned:2771546,bone_wastes:14401660,the_void:2228275,edilas:1703970},Od=20,Ei=44,Ld={[L.Grass]:4881471,[L.Dirt]:9136404,[L.Sand]:14401660,[L.Stone]:8947848,[L.Water]:2254506,[L.Snow]:14540270,[L.Path]:11176021,[L.Tilled]:8018448,[L.Watered]:5929488,[L.Lava]:16729088,[L.VoidTile]:2228275,[L.WoodFloor]:10053171,[L.Ice]:11197951,[L.Mud]:6706483,[L.Bone]:13417369,[L.Corruption]:4456550};class Wd extends fe{mapGraphics;playerDot;minimapGfx;cityMarkers=[];biomeLabels=[];legendTexts=[];playerBlinkTimer=0;mapW;mapH;travelCallback=null;constructor(e){const i=Pa-80,s=Ra-80;super(e,40,40,i,s,"World Map"),this.mapW=i-40,this.mapH=s-80}onTravel(e){this.travelCallback=e}buildContent(){this.mapGraphics=this.scene.add.graphics(),this.container.add(this.mapGraphics),this.minimapGfx=this.scene.add.graphics(),this.container.add(this.minimapGfx),this.playerDot=this.scene.add.graphics(),this.container.add(this.playerDot);const e=this.mapW-100;let t=Ei;const i=this.scene.add.text(e,t,"Legend",{fontFamily:"monospace",fontSize:"10px",color:"#7dd3fc",fontStyle:"bold"});this.container.add(i),this.legendTexts.push(i),t+=16;for(const s of Xi){const o="#"+(Ia[s.id]??4473924).toString(16).padStart(6,"0"),n=this.scene.add.text(e,t,` ${s.name}`,{fontFamily:"monospace",fontSize:"9px",color:o});this.container.add(n),this.legendTexts.push(n),t+=14}}refresh(){this.mapGraphics.clear(),this.playerDot.clear();for(const n of this.cityMarkers)n.destroy();this.cityMarkers=[];for(const n of this.biomeLabels)n.destroy();this.biomeLabels=[];const e=Od+(this.mapW-120)/2,t=Ei+this.mapH/2,i=2e3,s=Math.min(this.mapW-140,this.mapH-20)/2/i,a=[...Xi].reverse();for(const n of a){const l=n.distanceRange[0],c=Math.min(n.distanceRange[1],i),d=Ia[n.id]??4473924,h=c*s,u=e-h,m=t-h,g=h*2;this.mapGraphics.fillStyle(d,.6),this.mapGraphics.fillRoundedRect(u,m,g,g,8),this.mapGraphics.lineStyle(1,16777215,.15),this.mapGraphics.strokeRoundedRect(u,m,g,g,8);const y=(l+c)/2*s,_=t-y,w=this.scene.add.text(e,_,n.name,{fontFamily:"monospace",fontSize:"9px",color:"#ffffff",stroke:"#000000",strokeThickness:2}).setOrigin(.5,.5);this.container.add(w),this.biomeLabels.push(w)}for(const n of Pt){const l=e+n.x*s,c=t+n.y*s;this.mapGraphics.fillStyle(16763972,.9),this.mapGraphics.fillCircle(l,c,4),this.mapGraphics.lineStyle(1,16777215,.5),this.mapGraphics.strokeCircle(l,c,4);const d=this.scene.add.text(l+6,c-6,n.name,{fontFamily:"monospace",fontSize:"8px",color:"#ffcc44",stroke:"#000000",strokeThickness:2}).setInteractive({useHandCursor:!0});d.on("pointerover",()=>d.setColor("#ffffff")),d.on("pointerout",()=>d.setColor("#ffcc44")),d.on("pointerdown",()=>{this.travelCallback&&(this.travelCallback(n.id,n.x,n.y),this.close())}),this.container.add(d),this.cityMarkers.push(d)}const o=this.scene.registry.get("playerController");if(o){const n=o.getSprite(),l=e+n.x*s,c=t+n.y*s;this.playerDot.fillStyle(65280,1),this.playerDot.fillCircle(l,c,5),this.playerDot.lineStyle(2,16777215,.8),this.playerDot.strokeCircle(l,c,5)}this.renderMinimap(o)}renderMinimap(e){this.minimapGfx.clear();const t=200,i=this.mapW-t-10,s=this.mapH-t+Ei+10,a=2,o=t/a;if(this.minimapGfx.fillStyle(1118481,.8),this.minimapGfx.fillRect(i,s,t,t),this.minimapGfx.lineStyle(1,8246268,.5),this.minimapGfx.strokeRect(i,s,t,t),!e)return;const n=e.getPosition(),l=se.pixelToTile(n.x,n.y),c=l.tileX,d=l.tileY,h=Math.floor(o/2),u=this.scene.chunkManager??this.scene.registry.get("chunkManager");if(u)for(let _=-h;_<h;_++)for(let w=-h;w<h;w++){const k=c+w,F=d+_,H=u.getTileAt(k,F),A=Ld[H]??3355443,G=i+(w+h)*a,Y=s+(_+h)*a;this.minimapGfx.fillStyle(A,1),this.minimapGfx.fillRect(G,Y,a,a)}const m=(Math.sin(Date.now()/200)+1)/2*.5+.5,g=i+t/2,y=s+t/2;this.minimapGfx.fillStyle(16777215,m),this.minimapGfx.fillCircle(g,y,3)}destroy(){for(const e of this.cityMarkers)e.destroy();for(const e of this.biomeLabels)e.destroy();super.destroy()}}const Nd={farming:4508740,mining:8947848,combat:13386820,foraging:3385907,fishing:4491468,cooking:13408563,crafting:10053324,social:13395626,exploration:6737100};class Qd extends fe{skillBars=[];skillNameTexts=[];skillLevelTexts=[];skillXPTexts=[];constructor(e){const s=Math.floor((e.cameras.main.width-380)/2),a=Math.floor((e.cameras.main.height-420)/2);super(e,s,a,380,420,"Skills")}buildContent(){for(let s=0;s<9;s++){const a=44+s*38,o=this.scene.add.text(16,a,"",{fontFamily:"monospace",fontSize:"11px",color:"#cccccc"});this.container.add(o),this.skillNameTexts.push(o);const n=this.scene.add.text(126,a,"",{fontFamily:"monospace",fontSize:"11px",color:"#7dd3fc"});this.container.add(n),this.skillLevelTexts.push(n);const l=this.scene.add.graphics();this.container.add(l),this.skillBars.push(l);const c=this.scene.add.text(16,a+18,"",{fontFamily:"monospace",fontSize:"8px",color:"#888888"});this.container.add(c),this.skillXPTexts.push(c)}}refresh(){const e=this.getSkillManager();if(!e)return;const t=e.getAllSkills(),i=16,s=44,a=200,o=14,n=38;for(let l=0;l<9&&l<t.length;l++){const c=t[l],d=s+l*n,h=e.getXP(c.id),u=Nd[c.id]??8246268;this.skillNameTexts[l].setText(c.name),this.skillLevelTexts[l].setText(`Lv ${c.level}`);const m=this.skillBars[l];m.clear();const g=i+160,y=d+2;m.fillStyle(2236979,.8),m.fillRoundedRect(g,y,a,o,3);const _=h.required>0?Math.min(h.current/h.required,1):1;m.fillStyle(u,.8),m.fillRoundedRect(g,y,a*_,o,3),m.lineStyle(1,16777215,.15),m.strokeRoundedRect(g,y,a,o,3),h.required>0?this.skillXPTexts[l].setText(`${h.current} / ${h.required} XP`):this.skillXPTexts[l].setText("MAX LEVEL"),this.skillXPTexts[l].setPosition(g,y+o+2)}}getSkillManager(){return this.scene.registry.get("skillManager")??null}}class Gd extends fe{sliderGraphics=[];sliderLabels=[];sliderValueTexts=[];sliderHandles=[];sliderDefs=[];fullscreenBtn;draggingSlider=null;constructor(e){const s=Math.floor((e.cameras.main.width-360)/2),a=Math.floor((e.cameras.main.height-340)/2);super(e,s,a,360,340,"Settings")}buildContent(){this.sliderDefs=[{label:"Master Volume",getValue:()=>this.getAudio()?.getMasterVolume()??1,setValue:d=>this.getAudio()?.setMasterVolume(d)},{label:"Music Volume",getValue:()=>this.getAudio()?.getMusicVolume()??.5,setValue:d=>this.getAudio()?.setMusicVolume(d)},{label:"SFX Volume",getValue:()=>this.getAudio()?.getSFXVolume()??.7,setValue:d=>this.getAudio()?.setSFXVolume(d)},{label:"Ambient Volume",getValue:()=>this.getAudio()?.getAmbientVolume()??.3,setValue:d=>this.getAudio()?.setAmbientVolume(d)}];const i=this.scene.add.text(20,34,"Audio",{fontFamily:"monospace",fontSize:"12px",color:"#7dd3fc",fontStyle:"bold"});this.container.add(i);const s=200,a=8,o=14,n=48;for(let d=0;d<this.sliderDefs.length;d++){const h=this.sliderDefs[d],u=50+d*n,m=this.scene.add.text(20,u,h.label,{fontFamily:"monospace",fontSize:"10px",color:"#aaaaaa"});this.container.add(m),this.sliderLabels.push(m);const g=this.scene.add.text(20+s+40,u+16,"100%",{fontFamily:"monospace",fontSize:"10px",color:"#cccccc"});this.container.add(g),this.sliderValueTexts.push(g);const y=this.scene.add.graphics();this.container.add(y),this.sliderGraphics.push(y);const _=this.scene.add.rectangle(20+s*h.getValue(),u+16+a/2,o,o,8246268,.9).setInteractive({useHandCursor:!0,draggable:!1});_.setStrokeStyle(1,16777215,.5),this.container.add(_),this.sliderHandles.push(_),_.on("pointerdown",()=>{this.draggingSlider=d})}this.scene.input.on("pointermove",d=>{this.draggingSlider===null||!this.isOpen||this.handleSliderDrag(this.draggingSlider,d)}),this.scene.input.on("pointerup",()=>{this.draggingSlider=null});for(let d=0;d<this.sliderDefs.length;d++){this.sliderGraphics[d];const h=50+d*n+16,u=this.scene.add.rectangle(20+s/2,h+a/2,s,a+10).setAlpha(.001).setInteractive({useHandCursor:!0});this.container.add(u),u.on("pointerdown",m=>{this.draggingSlider=d,this.handleSliderDrag(d,m)})}const l=50+this.sliderDefs.length*n+16,c=this.scene.add.text(20,l,"Display",{fontFamily:"monospace",fontSize:"12px",color:"#7dd3fc",fontStyle:"bold"});this.container.add(c),this.fullscreenBtn=this.scene.add.text(20,l+20,"[ Toggle Fullscreen ]",{fontFamily:"monospace",fontSize:"11px",color:"#cccccc",backgroundColor:"#1a1a24",padding:{x:8,y:3}}).setInteractive({useHandCursor:!0}),this.fullscreenBtn.on("pointerover",()=>this.fullscreenBtn.setColor("#7dd3fc")),this.fullscreenBtn.on("pointerout",()=>this.fullscreenBtn.setColor("#cccccc")),this.fullscreenBtn.on("pointerdown",()=>{this.scene.scale.isFullscreen?this.scene.scale.stopFullscreen():this.scene.scale.startFullscreen()}),this.container.add(this.fullscreenBtn)}refresh(){for(let o=0;o<this.sliderDefs.length;o++){const n=this.sliderDefs[o],l=50+o*48+16,c=n.getValue(),d=this.sliderGraphics[o];d.clear(),d.fillStyle(2236979,.8),d.fillRoundedRect(20,l,200,8,3),d.fillStyle(8246268,.6),d.fillRoundedRect(20,l,200*c,8,3),this.sliderHandles[o].setPosition(20+200*c,l+8/2),this.sliderValueTexts[o].setText(`${Math.round(c*100)}%`)}}handleSliderDrag(e,t){let o=(t.x-this.panelX-20)/200;o=Math.max(0,Math.min(1,o)),this.sliderDefs[e].setValue(o),this.refresh()}open(){super.open();const e=this.scene.scene.get("OverworldScene");e&&e.scene.isActive()&&e.scene.pause()}close(){super.close();const e=this.scene.scene.get("OverworldScene");e&&e.scene.isPaused()&&e.scene.resume()}getAudio(){return this.scene.registry.get("audioManager")??null}}class Ud extends fe{merchantItems=[];playerGold=0;sellMultiplier=.4;scrollY=0;goldText;merchantListTexts=[];playerListTexts=[];statusText;constructor(e){super(e,40,40,720,480,"Shop")}openWithItems(e,t=.4){this.merchantItems=e,this.sellMultiplier=t,this.scrollY=0,this.open()}buildContent(){this.goldText=this.scene.add.text(12,38,"Gold: 0",{fontFamily:"monospace",fontSize:"12px",color:"#ffcc00"}),this.container.add(this.goldText);const e=this.scene.add.text(12,56,"BUY",{fontFamily:"monospace",fontSize:"11px",color:"#88ccff",fontStyle:"bold"}),t=this.scene.add.text(370,56,"SELL",{fontFamily:"monospace",fontSize:"11px",color:"#88ff88",fontStyle:"bold"});this.container.add(e),this.container.add(t);const i=this.scene.add.graphics();i.lineStyle(1,8246268,.3),i.lineBetween(358,40,358,470),this.container.add(i),this.statusText=this.scene.add.text(12,458,"",{fontFamily:"monospace",fontSize:"10px",color:"#aaaaaa"}),this.container.add(this.statusText)}refresh(){for(const i of this.merchantListTexts)i.destroy();for(const i of this.playerListTexts)i.destroy();this.merchantListTexts=[],this.playerListTexts=[];const e=this.scene.registry.get("inventoryManager");this.playerGold=e?.getGold?.()??0,this.goldText.setText(`Gold: ${this.playerGold}`);let t=72;for(let i=0;i<this.merchantItems.length&&t<450;i++){const s=this.merchantItems[i],a=this.playerGold>=s.price,o=this.scene.add.text(16,t,`${s.name}  ${s.price}g`,{fontFamily:"monospace",fontSize:"10px",color:a?"#cccccc":"#666666"});o.setInteractive({useHandCursor:a}),a&&(o.on("pointerover",()=>{o.setColor("#ffffff"),this.statusText.setText(`Buy: ${s.name}  ${s.description}`)}),o.on("pointerout",()=>o.setColor("#cccccc")),o.on("pointerdown",()=>this.buyItem(s))),this.container.add(o),this.merchantListTexts.push(o),t+=18}if(e){t=72;const i=e.getSlots();for(const s of i){if(!s||t>=450)continue;const a=j.get(s.itemId);if(!a)continue;const o=Math.floor((a.sellPrice??10)*this.sellMultiplier),n=this.scene.add.text(374,t,`${a.name} x${s.quantity}  ${o}g`,{fontFamily:"monospace",fontSize:"10px",color:"#aaccaa"});n.setInteractive({useHandCursor:!0}),n.on("pointerover",()=>{n.setColor("#88ff88"),this.statusText.setText(`Sell: ${a.name} for ${o}g`)}),n.on("pointerout",()=>n.setColor("#aaccaa")),n.on("pointerdown",()=>this.sellItem(s.itemId,o)),this.container.add(n),this.playerListTexts.push(n),t+=18}}}buyItem(e){const t=this.scene.registry.get("inventoryManager");if(t){if((t.getGold?.()??0)<e.price){this.statusText.setText("Not enough gold!");return}t.removeGold?.(e.price),t.addItem(e.itemId,1),this.statusText.setText(`Bought ${e.name}`),this.refresh()}}sellItem(e,t){const i=this.scene.registry.get("inventoryManager");if(!i)return;i.removeItem(e,1)>0&&(i.addGold?.(t),this.statusText.setText(`Sold for ${t}g`),this.refresh())}}class $d extends fe{discovered=new Set;killCounts=new Map;entryTexts=[];detailTexts=[];selectedId=null;countText;constructor(e){super(e,60,30,680,500,"Bestiary")}discover(e){this.discovered.add(e)}recordKill(e){this.discovered.add(e),this.killCounts.set(e,(this.killCounts.get(e)??0)+1)}getDiscoveredCount(){return this.discovered.size}serialize(){return{discovered:Array.from(this.discovered),kills:Object.fromEntries(this.killCounts)}}deserialize(e){this.discovered=new Set(e.discovered??[]),this.killCounts=new Map(Object.entries(e.kills??{}))}buildContent(){const e=this.scene.add.text(12,38,"Enemies & Bosses",{fontFamily:"monospace",fontSize:"11px",color:"#88ccff",fontStyle:"bold"});this.container.add(e),this.countText=this.scene.add.text(12,478,"",{fontFamily:"monospace",fontSize:"9px",color:"#666666"}),this.container.add(this.countText);const t=this.scene.add.graphics();t.lineStyle(1,8246268,.3),t.lineBetween(300,38,300,490),this.container.add(t);const i=this.scene.add.text(310,38,"Details",{fontFamily:"monospace",fontSize:"11px",color:"#88ccff",fontStyle:"bold"});this.container.add(i)}refresh(){for(const s of this.entryTexts)s.destroy();for(const s of this.detailTexts)s.destroy();this.entryTexts=[],this.detailTexts=[];const e=yi.size+rt.size;this.countText.setText(`Discovered: ${this.discovered.size}/${e}`);let t=56;const i=[];for(const[s,a]of yi)i.push({id:s,name:a.name,isBoss:!1});for(const[s,a]of rt)i.push({id:s,name:a.name,isBoss:!0});for(const s of i){if(t>470)break;const a=this.discovered.has(s.id),o=a?s.name:"???",n=s.isBoss?a?"#ffaa44":"#444444":a?"#cccccc":"#444444",l=s.isBoss?"[B] ":"    ",c=this.scene.add.text(12,t,`${l}${o}`,{fontFamily:"monospace",fontSize:"10px",color:n});a&&(c.setInteractive({useHandCursor:!0}),c.on("pointerover",()=>c.setColor("#ffffff")),c.on("pointerout",()=>c.setColor(n)),c.on("pointerdown",()=>this.selectEntry(s.id,s.isBoss))),this.container.add(c),this.entryTexts.push(c),t+=16}this.selectedId&&this.showDetails(this.selectedId)}selectEntry(e,t){this.selectedId=e,this.showDetails(e)}showDetails(e){for(const c of this.detailTexts)c.destroy();this.detailTexts=[];const t=yi.get(e),i=rt.get(e),s=t??i;if(!s)return;let a=56;const o=(c,d="#cccccc")=>{const h=this.scene.add.text(310,a,c,{fontFamily:"monospace",fontSize:"10px",color:d,wordWrap:{width:360}});this.container.add(h),this.detailTexts.push(h),a+=h.height+4};o(s.name,"#ffffff"),a+=4,t&&(o(`HP: ${t.hp}  DMG: ${t.damage}  DEF: ${t.defense}`),o(`Speed: ${t.speed}  AI: ${t.aiType}`),o(`Biome: ${t.biome}`),o(`XP: ${t.xpReward}`,"#88ccff")),i&&(o(`HP: ${i.hp}  DMG: ${i.damage}  DEF: ${i.defense}`,"#ffaa44"),o(`Phases: ${i.phases?.length??1}`),o(`Biome: ${i.biome}`),o(`XP: ${i.xpReward??0}`,"#88ccff"),i.title&&o(`"${i.title}"`,"#aaaaaa"));const n=this.killCounts.get(e)??0;a+=8,o(`Kills: ${n}`,"#88ff88");const l=t?.lootTable??i?.drops??[];if(l.length>0){a+=4,o("Drops:","#ffcc00");for(const c of l.slice(0,6))o(`  ${c.itemId} (${Math.round(c.chance*100)}%)`)}}}class jd extends fe{storageSlots=[];storageId="";chestTexts=[];playerTexts=[];statusText;onChangeCallback=null;constructor(e){super(e,50,50,700,460,"Storage")}openWithStorage(e,t,i){this.storageId=e,this.storageSlots=t.map(s=>({...s})),this.onChangeCallback=i??null,this.open()}buildContent(){const e=this.scene.add.text(12,38,"CHEST",{fontFamily:"monospace",fontSize:"11px",color:"#ffcc00",fontStyle:"bold"}),t=this.scene.add.text(360,38,"INVENTORY",{fontFamily:"monospace",fontSize:"11px",color:"#88ccff",fontStyle:"bold"});this.container.add(e),this.container.add(t);const i=this.scene.add.graphics();i.lineStyle(1,8246268,.3),i.lineBetween(348,36,348,450),this.container.add(i),this.statusText=this.scene.add.text(12,440,"",{fontFamily:"monospace",fontSize:"10px",color:"#aaaaaa"}),this.container.add(this.statusText)}refresh(){for(const i of this.chestTexts)i.destroy();for(const i of this.playerTexts)i.destroy();this.chestTexts=[],this.playerTexts=[];const e=this.scene.registry.get("inventoryManager");let t=56;for(let i=0;i<this.storageSlots.length&&t<430;i++){const s=this.storageSlots[i];if(!s.itemId)continue;const o=j.get(s.itemId)?.name??s.itemId,n=this.scene.add.text(16,t,`${o} x${s.quantity}`,{fontFamily:"monospace",fontSize:"10px",color:"#ddddaa"});n.setInteractive({useHandCursor:!0}),n.on("pointerover",()=>n.setColor("#ffffff")),n.on("pointerout",()=>n.setColor("#ddddaa")),n.on("pointerdown",()=>this.transferToInventory(i)),this.container.add(n),this.chestTexts.push(n),t+=16}if(e){t=56;const i=e.getSlots();for(let s=0;s<i.length&&t<430;s++){const a=i[s];if(!a.itemId)continue;const n=j.get(a.itemId)?.name??a.itemId,l=this.scene.add.text(360,t,`${n} x${a.quantity}`,{fontFamily:"monospace",fontSize:"10px",color:"#aaccff"});l.setInteractive({useHandCursor:!0}),l.on("pointerover",()=>l.setColor("#ffffff")),l.on("pointerout",()=>l.setColor("#aaccff")),l.on("pointerdown",()=>this.transferToStorage(a.itemId)),this.container.add(l),this.playerTexts.push(l),t+=16}}}transferToInventory(e){const t=this.storageSlots[e];if(!t||!t.itemId)return;const i=this.scene.registry.get("inventoryManager");if(!i)return;const s=i.addItem(t.itemId,t.quantity),a=t.quantity-s;a>0?(t.quantity-=a,t.quantity<=0&&(t.itemId="",t.quantity=0),this.statusText.setText(`Took ${a} items`),this.notifyChange(),this.refresh()):this.statusText.setText("Inventory full!")}transferToStorage(e){const t=this.scene.registry.get("inventoryManager");if(!t||t.removeItem(e,1)<=0)return;let s=!1;for(const a of this.storageSlots)if(a.itemId===e&&a.quantity<99){a.quantity+=1,s=!0;break}if(!s){for(const a of this.storageSlots)if(!a.itemId){a.itemId=e,a.quantity=1,s=!0;break}}s?(this.statusText.setText("Stored 1 item"),this.notifyChange()):(t.addItem(e,1),this.statusText.setText("Chest full!")),this.refresh()}notifyChange(){this.onChangeCallback&&this.onChangeCallback(this.storageId,this.storageSlots)}}class Vd extends fe{mailTexts=[];bodyText;claimBtn;selectedMail=null;constructor(e){super(e,40,40,720,440,"Mail")}buildContent(){this.bodyText=this.scene.add.text(340,42,"Select a letter to read.",{fontFamily:"monospace",fontSize:"10px",color:"#cccccc",wordWrap:{width:360,useAdvancedWrap:!0}}),this.container.add(this.bodyText),this.claimBtn=this.scene.add.text(340,400,"",{fontFamily:"monospace",fontSize:"11px",color:"#ffcc00",backgroundColor:"#333333",padding:{x:8,y:4}}),this.claimBtn.setInteractive({useHandCursor:!0}),this.claimBtn.on("pointerdown",()=>this.claimAttachments()),this.claimBtn.setVisible(!1),this.container.add(this.claimBtn);const e=this.scene.add.graphics();e.lineStyle(1,8246268,.3),e.lineBetween(330,36,330,430),this.container.add(e)}refresh(){for(const s of this.mailTexts)s.destroy();this.mailTexts=[],this.selectedMail=null,this.bodyText.setText("Select a letter to read."),this.claimBtn.setVisible(!1);const e=this.scene.registry.get("mailManager");if(!e)return;const t=e.getAllMail();let i=42;for(let s=0;s<t.length&&i<420;s++){const a=t[s],o=a.readAt===null,n=o?"* ":"  ",l=o?"#ffcc00":"#888888",c=!a.attachmentsClaimed&&a.attachments.length>0?" [!]":"",d=this.scene.add.text(12,i,`${n}${a.subject}${c}`,{fontFamily:"monospace",fontSize:"10px",color:l});d.setInteractive({useHandCursor:!0}),d.on("pointerover",()=>d.setColor("#ffffff")),d.on("pointerout",()=>d.setColor(l)),d.on("pointerdown",()=>this.selectLetter(a)),this.container.add(d),this.mailTexts.push(d),i+=16}if(t.length===0){const s=this.scene.add.text(12,50,"No mail.",{fontFamily:"monospace",fontSize:"10px",color:"#666666"});this.container.add(s),this.mailTexts.push(s)}}selectLetter(e){this.selectedMail=e;const t=this.scene.registry.get("mailManager");if(t){const i=this.scene.registry.get("timeManager");t.markRead(e.id,i?.getDate().day??0)}if(this.bodyText.setText(`From: ${e.senderId}

${e.body}`),!e.attachmentsClaimed&&e.attachments.length>0){const i=e.attachments.map(s=>s.gold?`${s.gold}g`:`${s.itemId} x${s.quantity??1}`).join(", ");this.claimBtn.setText(`Claim: ${i}`),this.claimBtn.setVisible(!0)}else this.claimBtn.setVisible(!1)}claimAttachments(){if(!this.selectedMail)return;const e=this.scene.registry.get("mailManager"),t=this.scene.registry.get("inventoryManager");if(!e||!t)return;const i=e.claimAttachments(this.selectedMail.id);if(i){for(const s of i)s.gold&&t.addGold(s.gold),s.itemId&&s.quantity&&t.addItem(s.itemId,s.quantity);this.claimBtn.setText("Claimed!"),this.claimBtn.setVisible(!1),this.refresh()}}}class Yd extends fe{dynamicTexts=[];constructor(e){super(e,60,60,680,420,"Career")}buildContent(){}refresh(){for(const i of this.dynamicTexts)i.destroy();this.dynamicTexts=[];const e=this.scene.registry.get("careerManager");if(!e)return;const t={fontFamily:"monospace",fontSize:"10px",color:"#cccccc"};if(e.hasCareer()){const i=e.getCareer(),s=e.getCareerLevel(),a=e.getCareerXP(),o=this.scene.add.text(12,42,`${i.name}  Level ${s}`,{fontFamily:"monospace",fontSize:"14px",color:"#ffcc00"});this.container.add(o),this.dynamicTexts.push(o);const n=this.scene.add.text(12,62,i.description,{...t,color:"#999999",wordWrap:{width:640,useAdvancedWrap:!0}});this.container.add(n),this.dynamicTexts.push(n);const l=this.scene.add.text(12,90,`XP: ${a.current}/${a.required}   |   Income: x${i.bonuses.incomeMultiplier}   |   XP Bonus: x${i.bonuses.xpMultiplier}`,t);this.container.add(l),this.dynamicTexts.push(l);const c=this.scene.add.text(12,120,"Specializations:",{fontFamily:"monospace",fontSize:"11px",color:"#88ccff"});this.container.add(c),this.dynamicTexts.push(c);let d=142;for(const h of i.specializations){const u=e.hasSpecialization(h.id),m=!u&&h.level<=s,g=u?"#88ff88":m?"#ffcc00":"#555555",y=u?"[x]":m?"[ ]":"---",_=this.scene.add.text(16,d,`${y} Lv${h.level}: ${h.name}  ${h.description}`,{...t,color:g});m&&(_.setInteractive({useHandCursor:!0}),_.on("pointerover",()=>_.setColor("#ffffff")),_.on("pointerout",()=>_.setColor(g)),_.on("pointerdown",()=>{e.selectSpecialization(h.id),this.refresh()})),this.container.add(_),this.dynamicTexts.push(_),d+=22}}else{const i=this.scene.add.text(12,42,"Choose a career (permanent choice):",{fontFamily:"monospace",fontSize:"12px",color:"#ffcc00"});this.container.add(i),this.dynamicTexts.push(i);let s=68;for(const a of Za){const o=this.scene.add.text(16,s,`[${a.name}]`,{fontFamily:"monospace",fontSize:"11px",color:"#88ccff"}).setInteractive({useHandCursor:!0});o.on("pointerover",()=>o.setColor("#ffffff")),o.on("pointerout",()=>o.setColor("#88ccff")),o.on("pointerdown",()=>{e.selectCareer(a.id),this.refresh()}),this.container.add(o),this.dynamicTexts.push(o);const n=this.scene.add.text(180,s,a.description,{...t,wordWrap:{width:480,useAdvancedWrap:!0}});this.container.add(n),this.dynamicTexts.push(n),s+=40}}}}class Xd extends x.Scene{healthBar;staminaBar;healthText;staminaText;clockText;goldText;xpBar;xpText;questTrackerText;weatherIcon;mailIndicator;hotbarSlots=[];hotbarItemTexts=[];hotbarQtyTexts=[];lastActiveHotbarSlot=-1;buffText;abilitySlots=[];abilityNameTexts=[];abilityCooldownBars=[];shadowWorldText;riftFloorText;inventoryUI;craftingUI;questJournal;mapUI;skillsUI;settingsUI;shopUI;bestiaryUI;storageUI;mailUI;careerUI;allPanels=[];constructor(){super({key:"UIScene"})}create(){this.add.text(8,8,"EDILAS v1.0.0-dev",{fontFamily:"monospace",fontSize:"12px",color:"#555555"}).setScrollFactor(0).setDepth(1e3);const e={fontFamily:"monospace",fontSize:"11px",color:"#ffffff"};this.healthBar=this.add.graphics().setScrollFactor(0).setDepth(1e3),this.healthText=this.add.text(18,30,"HP",e).setScrollFactor(0).setDepth(1001),this.staminaBar=this.add.graphics().setScrollFactor(0).setDepth(1e3),this.staminaText=this.add.text(18,50,"SP",e).setScrollFactor(0).setDepth(1001),this.clockText=this.add.text(0,30,"",{fontFamily:"monospace",fontSize:"12px",color:"#ffb347",backgroundColor:"#000000aa",padding:{x:4,y:2}}).setScrollFactor(0).setDepth(1001),this.xpBar=this.add.graphics().setScrollFactor(0).setDepth(1e3),this.xpText=this.add.text(18,70,"XP",e).setScrollFactor(0).setDepth(1001),this.goldText=this.add.text(18,90,"Gold: 0",{fontFamily:"monospace",fontSize:"11px",color:"#ffcc00"}).setScrollFactor(0).setDepth(1001),this.weatherIcon=this.add.text(0,50,"",{fontFamily:"monospace",fontSize:"10px",color:"#88ccff",backgroundColor:"#000000aa",padding:{x:4,y:2}}).setScrollFactor(0).setDepth(1001),this.questTrackerText=this.add.text(0,74,"",{fontFamily:"monospace",fontSize:"10px",color:"#aaccff",backgroundColor:"#00000088",padding:{x:6,y:4},wordWrap:{width:220}}).setScrollFactor(0).setDepth(1001),this.mailIndicator=this.add.text(18,108,"",{fontFamily:"monospace",fontSize:"10px",color:"#ffaa44"}).setScrollFactor(0).setDepth(1001),this.buffText=this.add.text(0,0,"",{fontFamily:"monospace",fontSize:"10px",color:"#88ffaa",backgroundColor:"#00000088",padding:{x:4,y:2}}).setScrollFactor(0).setDepth(1001).setVisible(!1),this.createHotbar(),this.createAbilityHotbar(),this.shadowWorldText=this.add.text(18,126,"",{fontFamily:"monospace",fontSize:"10px",color:"#cc88ff",backgroundColor:"#220033aa",padding:{x:4,y:2}}).setScrollFactor(0).setDepth(1001).setVisible(!1),this.riftFloorText=this.add.text(18,146,"",{fontFamily:"monospace",fontSize:"10px",color:"#ff88cc",backgroundColor:"#330022aa",padding:{x:4,y:2}}).setScrollFactor(0).setDepth(1001).setVisible(!1),this.inventoryUI=new Fd(this),this.craftingUI=new zd(this),this.questJournal=new Hd(this),this.mapUI=new Wd(this),this.skillsUI=new Qd(this),this.settingsUI=new Gd(this),this.shopUI=new Ud(this),this.bestiaryUI=new $d(this),this.storageUI=new jd(this),this.mailUI=new Vd(this),this.careerUI=new Yd(this),this.allPanels=[this.inventoryUI,this.craftingUI,this.questJournal,this.mapUI,this.skillsUI,this.settingsUI,this.shopUI,this.bestiaryUI,this.storageUI,this.mailUI,this.careerUI],this.registry.set("bestiaryUI",this.bestiaryUI),this.registerKeybinds()}createHotbar(){const s=(this.cameras.main.width-436)/2,a=this.cameras.main.height-40-10;for(let o=0;o<10;o++){const n=s+o*44,l=this.add.rectangle(n+40/2,a+40/2,40,40,2236962,.7);l.setStrokeStyle(1,8246268,.5),l.setScrollFactor(0).setDepth(1e3),this.hotbarSlots.push(l);const c=String(o===9?0:o+1);this.add.text(n+2,a+2,c,{fontFamily:"monospace",fontSize:"9px",color:"#666666"}).setScrollFactor(0).setDepth(1001);const d=this.add.text(n+40/2,a+40/2-2,"",{fontFamily:"monospace",fontSize:"8px",color:"#dddddd",align:"center"}).setOrigin(.5).setScrollFactor(0).setDepth(1002);this.hotbarItemTexts.push(d);const h=this.add.text(n+40-3,a+40-3,"",{fontFamily:"monospace",fontSize:"8px",color:"#aaffaa"}).setOrigin(1,1).setScrollFactor(0).setDepth(1002);this.hotbarQtyTexts.push(h)}}createAbilityHotbar(){const a=this.cameras.main.height-40-10-36-8,o=(this.cameras.main.width-156)/2;for(let n=0;n<4;n++){const l=o+n*40,c=this.add.rectangle(l+36/2,a+36/2,36,36,1710638,.7);c.setStrokeStyle(1,10053324,.5),c.setScrollFactor(0).setDepth(1e3),this.abilitySlots.push(c),this.add.text(l+2,a+2,`F${n+1}`,{fontFamily:"monospace",fontSize:"8px",color:"#666666"}).setScrollFactor(0).setDepth(1001);const d=this.add.text(l+36/2,a+36/2+2,"",{fontFamily:"monospace",fontSize:"7px",color:"#cc88ff",align:"center"}).setOrigin(.5).setScrollFactor(0).setDepth(1002);this.abilityNameTexts.push(d);const h=this.add.graphics().setScrollFactor(0).setDepth(1003);this.abilityCooldownBars.push(h)}}registerKeybinds(){this.input.keyboard&&(this.input.keyboard.on("keydown-I",()=>this.togglePanel(this.inventoryUI)),this.input.keyboard.on("keydown-TAB",e=>{e.preventDefault(),this.togglePanel(this.inventoryUI)}),this.input.keyboard.on("keydown-C",()=>this.togglePanel(this.craftingUI)),this.input.keyboard.on("keydown-J",()=>this.togglePanel(this.questJournal)),this.input.keyboard.on("keydown-M",()=>this.togglePanel(this.mapUI)),this.input.keyboard.on("keydown-K",()=>this.togglePanel(this.skillsUI)),this.input.keyboard.on("keydown-B",()=>this.togglePanel(this.bestiaryUI)),this.input.keyboard.on("keydown-N",()=>this.togglePanel(this.mailUI)),this.input.keyboard.on("keydown-R",()=>this.togglePanel(this.careerUI)),this.input.keyboard.on("keydown-ESC",()=>{const e=this.allPanels.find(t=>t.getIsOpen());e&&e!==this.settingsUI?(e.close(),this.updateUIBlockingState()):this.togglePanel(this.settingsUI)}))}togglePanel(e){if(e.getIsOpen())e.close();else{for(const t of this.allPanels)t!==e&&t.getIsOpen()&&t.close();e.open()}this.updateUIBlockingState()}updateUIBlockingState(){const e=this.allPanels.some(t=>t.getIsOpen());this.registry.set("uiPanelOpen",e)}getShopUI(){return this.shopUI}getBestiaryUI(){return this.bestiaryUI}getStorageUI(){return this.storageUI}getMapUI(){return this.mapUI}openShop(e,t=.4){for(const i of this.allPanels)i.getIsOpen()&&i.close();this.shopUI.openWithItems(e,t),this.updateUIBlockingState()}openStorage(e,t,i){for(const s of this.allPanels)s.getIsOpen()&&s.close();this.storageUI.openWithStorage(e,t,i),this.updateUIBlockingState()}update(){const e=this.registry.get("playerController"),t=this.registry.get("timeManager"),i=this.registry.get("inventoryManager"),s=this.registry.get("questManager"),a=this.registry.get("skillManager"),o=this.registry.get("weatherManager"),n=this.registry.get("mailManager"),l=this.cameras.main.width;if(e){const m=e.getHealth(),g=e.getStamina();this.drawBar(this.healthBar,16,28,160,14,m.current/m.max,13382451,4460817),this.drawBar(this.staminaBar,16,48,160,14,g.current/g.max,3394611,1131537),this.healthText.setText(`HP ${Math.ceil(m.current)}/${m.max}`),this.staminaText.setText(`SP ${Math.ceil(g.current)}/${g.max}`)}if(a){const m=a.getXP("combat"),g=a.getLevel("combat"),y=m.required>0?m.current/m.required:0;this.drawBar(this.xpBar,16,68,160,10,y,4491519,1122884),this.xpText.setText(`Lv.${g} XP ${m.current}/${m.required}`)}if(i&&this.goldText.setText(`Gold: ${i.getGold()}`),t){const m=t.getDate();this.clockText.setText(`${t.getTimeString()} ${m.season} Day ${m.day}`),this.clockText.setPosition(l-this.clockText.width-16,30)}if(o){const m=o.getWeatherType(),g={clear:"Clear",rain:"Rain",storm:"Storm",snow:"Snow",fog:"Fog",sandstorm:"Sand",ember_rain:"Ember",acid_rain:"Acid",spore_cloud:"Spore",void_storm:"Void"};this.weatherIcon.setText(g[m]??m),this.weatherIcon.setPosition(l-this.weatherIcon.width-16,50)}if(s){const m=s.getActiveQuests();if(m.length>0){const g=m[0];let y=`[Quest] ${g.quest.name}
`;for(let _=0;_<g.quest.objectives.length;_++){const w=g.quest.objectives[_],k=g.progress[_]??0,F=k>=w.count;y+=`${F?"[x]":"[ ]"} ${w.description} (${k}/${w.count})
`}this.questTrackerText.setText(y.trimEnd()),this.questTrackerText.setPosition(l-230,74),this.questTrackerText.setVisible(!0)}else this.questTrackerText.setVisible(!1)}if(n){const m=n.getUnreadCount();m>0?(this.mailIndicator.setText(`Mail (${m})`),this.mailIndicator.setVisible(!0)):this.mailIndicator.setVisible(!1)}const c=this.registry.get("activeBuffs");if(c&&c.length>0){const m=c.map(y=>`${y.type} +${y.magnitude} (${Math.ceil(y.remaining)}s)`);this.buffText.setText(m.join("  |  "));const g=this.cameras.main.height-40-10;this.buffText.setPosition(this.cameras.main.width/2,g-18).setOrigin(.5),this.buffText.setVisible(!0)}else this.buffText.setVisible(!1);if(i){const m=this.registry.get("hotbarSlot")??0;for(let g=0;g<10;g++){const y=i.getSlot(g),_=this.hotbarItemTexts[g],w=this.hotbarQtyTexts[g],k=this.hotbarSlots[g];if(y&&y.itemId){const F=j.get(y.itemId),H=F?.name??y.itemId;_.setText(H.length>6?H.slice(0,5)+".":H),w.setText(y.quantity>1?`${y.quantity}`:"");const A=F?.category;A==="food"||A==="potion"?_.setColor("#88ff88"):A==="tool"?_.setColor("#ffcc44"):_.setColor("#dddddd")}else _.setText(""),w.setText("");g===m?k.setStrokeStyle(2,16763904,1):k.setStrokeStyle(1,8246268,.5)}}const d=this.registry.get("abilityManager");if(d){const m=d.getHotbar(),g=36,y=4,_=4*g+3*y,k=this.cameras.main.height-40-10-g-8,F=(this.cameras.main.width-_)/2;for(let H=0;H<4;H++){const A=m[H],G=this.abilityNameTexts[H],Y=this.abilityCooldownBars[H];if(Y.clear(),A){const te=d.getAbility(A);if(te){G.setText(te.name.length>6?te.name.slice(0,5)+".":te.name);const de=te.cooldown>0?d.getCooldown(A)/te.cooldown:0;if(de>0){const ie=F+H*(g+y),X=g*de;Y.fillStyle(0,.6),Y.fillRect(ie,k+(g-X),g,X)}}else G.setText("")}else G.setText("")}}const h=this.registry.get("shadowWorldManager");if(h)if(h.isInShadowWorld())this.shadowWorldText.setText("SHADOW WORLD"),this.shadowWorldText.setVisible(!0);else if(h.isChanneling())this.shadowWorldText.setText("Channeling..."),this.shadowWorldText.setVisible(!0);else{const m=h.getCooldownRemaining();m>0?(this.shadowWorldText.setText(`Shadow CD: ${Math.ceil(m/1e3)}s`),this.shadowWorldText.setVisible(!0)):this.shadowWorldText.setVisible(!1)}const u=this.registry.get("riftManager");if(u){const m=u.getCurrentFloor();m?(this.riftFloorText.setText(`Rift Floor ${m.floor}`),this.riftFloorText.setVisible(!0)):this.riftFloorText.setVisible(!1)}this.updateUIBlockingState()}drawBar(e,t,i,s,a,o,n,l){e.clear(),e.fillStyle(l,.8),e.fillRoundedRect(t,i,s,a,3),e.fillStyle(n,.9),e.fillRoundedRect(t,i,s*Math.max(0,Math.min(1,o)),a,3),e.lineStyle(1,16777215,.2),e.strokeRoundedRect(t,i,s,a,3)}}class Kd extends x.Scene{dialogueBox;nameText;dialogueText;promptText;choiceTexts=[];state=null;backdrop;shopItems=[];shopTitle=null;shopGold=null;giftItems=[];typewriterTimer;fullText="";displayedChars=0;typewriterComplete=!0;constructor(){super({key:"DialogueScene"})}create(){const{width:e,height:t}=this.cameras.main;this.backdrop=this.add.rectangle(e/2,t/2,e,t,0,.3),this.backdrop.setScrollFactor(0).setDepth(9e3),this.backdrop.setInteractive(),this.dialogueBox=this.add.graphics(),this.dialogueBox.setScrollFactor(0).setDepth(9001),this.drawDialogueBox(e,t);const i=e*.8,s=150,a=(e-i)/2,o=t-s-20;this.nameText=this.add.text(a+16,o+10,"",{fontFamily:"monospace",fontSize:"14px",color:"#7dd3fc",fontStyle:"bold"}).setScrollFactor(0).setDepth(9002),this.dialogueText=this.add.text(a+16,o+32,"",{fontFamily:"monospace",fontSize:"12px",color:"#ffffff",wordWrap:{width:i-32},lineSpacing:4}).setScrollFactor(0).setDepth(9002),this.promptText=this.add.text(a+i-12,o+s-8,"[Space] Continue",{fontFamily:"monospace",fontSize:"10px",color:"#888888"}).setOrigin(1,1).setScrollFactor(0).setDepth(9002),this.input.keyboard.on("keydown-SPACE",()=>this.advance()),this.input.keyboard.on("keydown-ENTER",()=>this.advance()),this.input.keyboard.on("keydown-ESC",()=>this.closeDialogue()),this.setVisible(!1)}openDialogue(e){const t=this.registry.get("relationshipManager"),i=this.registry.get("questManager"),s=[e.dialogue.greeting];if(t){const n=t.getHearts(e.id),l=t.getUnlockedDialogue(e.id);l.length>0&&s.push(l[l.length-1]),n>=3&&s.push("We've become good friends, haven't we?")}let a=null;const o=[];if(i){for(const n of e.questIds)if(i.getQuestStatus(n)==="complete"&&o.push(n),!a&&i.canAccept(n)){const l=i.getQuestDef(n);l&&(a=l)}}this.state={npcId:e.id,npcName:e.name,npcDef:e,lines:s,lineIndex:0,choices:null,mode:"talk",questDef:a,completableQuestIds:o},this.showCurrentLine(),this.setVisible(!0)}showDialogue(e,t,i){const s=[t],a=i?i.map(o=>({text:o.text,action:()=>{o.next?(this.dialogueText.setText(o.next),this.state.choices=null,this.clearChoices(),this.promptText.setText("[Space] Close")):this.closeDialogue()}})):null;if(this.state={npcId:"__generic",npcName:e,npcDef:null,lines:s,lineIndex:0,choices:null,mode:"talk",questDef:null,completableQuestIds:[]},this.showCurrentLine(),this.setVisible(!0),a&&a.length>0){const o=this.time.addEvent({delay:50,loop:!0,callback:()=>{this.typewriterComplete&&(o.destroy(),this.state.choices=a,this.displayChoices(a),this.promptText.setText(""))}})}}advance(){if(this.state){if(this.state.mode==="shop"||this.state.mode==="gift_select"){this.exitShopOrGift();return}if(!this.state.choices){if(!this.typewriterComplete){this.completeTypewriter();return}this.state.lineIndex++,this.state.lineIndex>=this.state.lines.length?this.showEndChoices():this.showCurrentLine()}}}showCurrentLine(){this.state&&(this.nameText.setText(this.state.npcName),this.clearChoices(),this.startTypewriter(this.state.lines[this.state.lineIndex]),this.promptText.setText("[Space] Continue"))}startTypewriter(e){this.stopTypewriter(),this.fullText=e,this.displayedChars=0,this.typewriterComplete=!1,this.dialogueText.setText(""),this.typewriterTimer=this.time.addEvent({delay:30,repeat:e.length-1,callback:()=>{this.displayedChars++,this.dialogueText.setText(this.fullText.substring(0,this.displayedChars)),this.displayedChars>=this.fullText.length&&(this.typewriterComplete=!0)}})}completeTypewriter(){this.stopTypewriter(),this.dialogueText.setText(this.fullText),this.typewriterComplete=!0}stopTypewriter(){this.typewriterTimer&&(this.typewriterTimer.destroy(),this.typewriterTimer=void 0)}showEndChoices(){if(!this.state)return;const e=[];for(const a of this.state.completableQuestIds){const n=this.registry.get("questManager")?.getQuestDef(a);n&&e.push({text:`Turn in: ${n.name}`,action:()=>this.turnInQuest(a,n)})}if(this.state.questDef){const a=this.state.questDef;e.push({text:`Quest: ${a.name}`,action:()=>{const o=this.registry.get("questManager");o&&o.acceptQuest(a.id),this.state.choices=null,this.clearChoices(),this.promptText.setText("[Space] Close"),this.state.lines=[`${a.dialogue.offer}

Quest "${a.name}" accepted!`],this.state.lineIndex=0,this.state.questDef=null,this.showCurrentLine()}})}this.state.npcDef.shop&&e.push({text:"Shop",action:()=>this.openShop()}),e.push({text:"Give Gift",action:()=>this.openGiftSelection()});const t=this.registry.get("romanceManager"),i=this.registry.get("relationshipManager"),s=this.registry.get("inventoryManager");if(t&&i&&s){const a=i.getFriendshipPoints(this.state.npcId);t.canDateNPC(this.state.npcId,a)&&s.countItem("bouquet")>0&&e.push({text:"Give Bouquet",action:()=>this.useBouquet()}),t.canProposeNPC(this.state.npcId,a)&&s.countItem("pendant")>0&&e.push({text:"Give Pendant",action:()=>this.usePendant()})}e.push({text:"Goodbye",action:()=>this.closeDialogue()}),this.state.choices=e,this.displayChoices(e),this.promptText.setText("")}turnInQuest(e,t){const i=this.registry.get("questManager"),s=this.registry.get("inventoryManager"),a=this.registry.get("skillManager");i&&i.turnInQuest(e);const o=t.rewards;if(o.gold>0&&s&&s.addGold(o.gold),o.items.length>0&&s)for(const c of o.items)s.addItem(c.itemId,c.quantity);o.xp>0&&a&&a.addXP("combat",o.xp);const n=t.dialogue?.complete??`Quest "${t.name}" complete!`;this.state.choices=null,this.clearChoices(),this.dialogueText.setText(`${n}

Rewards received!`),this.promptText.setText("[Space] Close");const l=this.state.completableQuestIds.indexOf(e);l>=0&&this.state.completableQuestIds.splice(l,1)}openShop(){if(!this.state?.npcDef.shop)return;this.state.mode="shop",this.clearChoices();const{width:e,height:t}=this.cameras.main,i=this.state.npcDef.shop,s=this.registry.get("inventoryManager"),a=this.state.npcDef.homeCity,l=Pt.find(u=>u.id===a)?.shops.find(u=>u.shopId===this.state?.npcDef.id||u.items.length>0)?.items??i.items;this.shopTitle=this.add.text(e/2,60,`${this.state.npcName}'s Shop`,{fontFamily:"monospace",fontSize:"16px",color:"#ffcc00",fontStyle:"bold",backgroundColor:"#111122ee",padding:{x:12,y:6}}).setOrigin(.5).setScrollFactor(0).setDepth(9100);const c=s?.getGold()??0;this.shopGold=this.add.text(e-40,60,`Gold: ${c}`,{fontFamily:"monospace",fontSize:"12px",color:"#ffdd44",backgroundColor:"#111122ee",padding:{x:8,y:4}}).setOrigin(1,.5).setScrollFactor(0).setDepth(9100);const d=100,h=i.priceMultiplier;for(let u=0;u<l.length&&u<12;u++){const m=l[u],g=j.get(m),y=g?.name??m,_=g?.buyPrice??10,w=Math.ceil(_*h),k=this.add.text(60,d+u*22,`${u+1}. ${y}  -  ${w}g`,{fontFamily:"monospace",fontSize:"11px",color:"#aaffaa"}).setScrollFactor(0).setDepth(9100).setInteractive({useHandCursor:!0});k.on("pointerover",()=>k.setColor("#ffffff")),k.on("pointerout",()=>k.setColor("#aaffaa")),k.on("pointerdown",()=>this.buyItem(m,w)),this.shopItems.push(k)}this.dialogueText.setText("Click an item to buy. [Space/ESC] to exit shop."),this.promptText.setText("[Space] Exit Shop")}buyItem(e,t){const i=this.registry.get("inventoryManager");if(!i)return;const s=i.getGold();if(s<t){this.dialogueText.setText(`Not enough gold! Need ${t}g, have ${s}g.`);return}if(i.isFull()){this.dialogueText.setText("Inventory is full!");return}i.removeGold(t),i.addItem(e,1);const a=i.getGold(),n=j.get(e)?.name??e;this.dialogueText.setText(`Bought ${n}! Gold remaining: ${a}g`),this.shopGold&&this.shopGold.setText(`Gold: ${a}`)}openGiftSelection(){if(!this.state)return;this.state.mode="gift_select",this.clearChoices();const e=this.registry.get("inventoryManager");if(!e){this.dialogueText.setText("No inventory available."),this.promptText.setText("[Space] Back");return}const t=e.getAllSlots(),i=[];for(let n=0;n<t.length;n++){const l=t[n];l.itemId&&l.itemId!=="gold_coin"&&l.quantity>0&&i.push({index:n,itemId:l.itemId,quantity:l.quantity})}if(i.length===0){this.dialogueText.setText("You have nothing to give..."),this.promptText.setText("[Space] Back");return}this.dialogueText.setText("Select an item to give:"),this.promptText.setText("[Space] Cancel");const{height:s}=this.cameras.main,a=s-140,o=Math.min(i.length,6);for(let n=0;n<o;n++){const l=i[n],c=this.add.text(60,a+n*20,`${n+1}. ${l.itemId} x${l.quantity}`,{fontFamily:"monospace",fontSize:"11px",color:"#ffaaff"}).setScrollFactor(0).setDepth(9002).setInteractive({useHandCursor:!0});c.on("pointerover",()=>c.setColor("#ffffff")),c.on("pointerout",()=>c.setColor("#ffaaff")),c.on("pointerdown",()=>this.giveGift(l.itemId)),this.giftItems.push(c)}}giveGift(e){if(!this.state)return;const t=this.registry.get("inventoryManager"),i=this.registry.get("relationshipManager");if(!t||!i)return;t.removeItem(e,1);const s=i.giveGift(this.state.npcId,e);for(const n of this.giftItems)n.destroy();this.giftItems=[];const a=s?.reaction??"neutral";let o;switch(a){case"loved":o=`${this.state.npcName}: "I love this! Thank you so much!" (+${s?.points??80} hearts)`;break;case"liked":o=`${this.state.npcName}: "Oh, how nice! Thank you!" (+${s?.points??45} hearts)`;break;case"disliked":o=`${this.state.npcName}: "Um... thanks, I guess." (${s?.points??-20} hearts)`;break;case"hated":o=`${this.state.npcName}: "Why would you give me this?!" (${s?.points??-40} hearts)`;break;default:o=s===null?`${this.state.npcName}: "I've already received a gift today."`:`${this.state.npcName}: "Thank you for the gift."`}this.state.mode="talk",this.dialogueText.setText(o),this.promptText.setText("[Space] Close")}useBouquet(){if(!this.state)return;const e=this.registry.get("romanceManager"),t=this.registry.get("relationshipManager"),i=this.registry.get("inventoryManager");if(!e||!t||!i)return;const s=t.getFriendshipPoints(this.state.npcId);e.useBouquet(this.state.npcId,s)&&(i.removeItem("bouquet",1),this.state.mode="talk",this.state.choices=null,this.clearChoices(),this.dialogueText.setText(`${this.state.npcName}: "A bouquet... for me? I'd love to go out with you!"`),this.promptText.setText("[Space] Close"))}usePendant(){if(!this.state)return;const e=this.registry.get("romanceManager"),t=this.registry.get("relationshipManager"),i=this.registry.get("inventoryManager");if(!e||!t||!i)return;const s=t.getFriendshipPoints(this.state.npcId);e.usePendant(this.state.npcId,s)&&(i.removeItem("pendant",1),this.state.mode="talk",this.state.choices=null,this.clearChoices(),this.dialogueText.setText(`${this.state.npcName}: "Yes! A thousand times yes! I can't wait to spend my life with you!"`),this.promptText.setText("[Space] Close"))}exitShopOrGift(){for(const e of this.shopItems)e.destroy();this.shopItems=[],this.shopTitle&&(this.shopTitle.destroy(),this.shopTitle=null),this.shopGold&&(this.shopGold.destroy(),this.shopGold=null);for(const e of this.giftItems)e.destroy();this.giftItems=[],this.state&&(this.state.mode="talk",this.state.choices=null),this.showEndChoices()}displayChoices(e){this.clearChoices();const{height:t}=this.cameras.main,i=t-140;this.dialogueText.setText("");for(let s=0;s<e.length;s++){const a=this.add.text(60,i+s*24,`${s+1}. ${e[s].text}`,{fontFamily:"monospace",fontSize:"12px",color:"#aaffaa"}).setScrollFactor(0).setDepth(9002).setInteractive({useHandCursor:!0});a.on("pointerover",()=>a.setColor("#ffffff")),a.on("pointerout",()=>a.setColor("#aaffaa")),a.on("pointerdown",()=>e[s].action()),this.choiceTexts.push(a),this.input.keyboard.addKey(x.Input.Keyboard.KeyCodes.ONE+s).once("down",()=>e[s].action())}}clearChoices(){for(const e of this.choiceTexts)e.destroy();this.choiceTexts=[]}closeDialogue(){this.stopTypewriter(),this.state=null,this.setVisible(!1),this.clearChoices();for(const e of this.shopItems)e.destroy();this.shopItems=[],this.shopTitle&&(this.shopTitle.destroy(),this.shopTitle=null),this.shopGold&&(this.shopGold.destroy(),this.shopGold=null);for(const e of this.giftItems)e.destroy();this.giftItems=[],this.scene.resume("OverworldScene")}setVisible(e){this.backdrop.setVisible(e),this.dialogueBox.setVisible(e),this.nameText.setVisible(e),this.dialogueText.setVisible(e),this.promptText.setVisible(e)}drawDialogueBox(e,t){this.dialogueBox.clear();const i=e*.8,s=150,a=(e-i)/2,o=t-s-20;this.dialogueBox.fillStyle(1118498,.92),this.dialogueBox.fillRoundedRect(a,o,i,s,8),this.dialogueBox.lineStyle(2,4482730,.8),this.dialogueBox.strokeRoundedRect(a,o,i,s,8)}update(){}}const Jd={type:x.AUTO,width:Pa,height:Ra,parent:"game-container",backgroundColor:"#0c0f1a",pixelArt:!0,physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scale:{mode:x.Scale.RESIZE,autoCenter:x.Scale.CENTER_BOTH},scene:[Nr,io,Jc,bd,Pd,Dd,Xd,Kd]};new x.Game(Jd);
//# sourceMappingURL=index-DXoIe7Kg.js.map
